
USE [Nishwik]
GO
/****** Object:  StoredProcedure [ann].[AlertsSchedular_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 CREATE   PROCEDURE [ann].[AlertsSchedular_Delete]
(
		@SchedularId INT,
		@ActionUser Varchar(50)
)
AS
 BEGIN 
  SET NOCOUNT ON;
     UPDATE  [ann].[AlertsSchedular]
 SET 
		[IsActive] = 0,
		[IsDeleted] =1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [SchedularId] = @SchedularId
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsSchedular_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ann].[AlertsSchedular_ReadById]
(
     @SchedularId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;

     SELECT 
			 [SchedularId]
			,[IName]
			,[ICode]
			,[IDesc]
			,[FrequencyInMinutes]
			,[SchedularType]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	FROM [ann].[AlertsSchedular]
	WHERE [SchedularId] = @SchedularId
	  AND  [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsSchedular_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsSchedular_Update]
(
		@SchedularId int,
		@IName  varchar(200) ,
		@ICode varchar(10) ,
		@IDesc varchar(1000) ,
		@FrequencyInMinutes int ,
		@SchedularType varchar(100) ,
		@IsActive INT,
		@ActionUser Varchar(50)
)
AS
 BEGIN 
  SET NOCOUNT ON;

 UPDATE [ann].[AlertsSchedular]
 SET 
			[IName] = @IName,
			[ICode] = @ICode,
			[IDesc] = @IDesc,
			[FrequencyInMinutes] =  @FrequencyInMinutes,
			[SchedularType] =  @SchedularType ,
			[IsActive] = @IsActive,
			[ModifiedBy] = @ActionUser,
			[ModifiedOn] = GETDATE()
	WHERE [SchedularId]=  @SchedularId AND [IsActive] =1;
			 
     SELECT 
			 [SchedularId]
			,[IName]
			,[ICode]
			,[IDesc]
			,[FrequencyInMinutes]
			,[SchedularType]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	FROM [ann].[AlertsSchedular]
	WHERE [SchedularId]=  @SchedularId
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceMaster_Create]
(
      @Title varchar(100) null,
      @SDesc varchar(1000) null,
      @AlertType varchar(20) null,
      @HasAttachment int null,
      @AttachmentType varchar(100) null,
      @AttachmentPath varchar(500) null,
      @AttachmentFileType varchar(50) null,
      @OutputFileName varchar(100) null,
      @DataSourceType varchar(30) null,
      @DataSourceDef nvarchar(4000) null,
      @PostSendDataSourceType varchar(30) null,
      @PostSendDataSourceDef nvarchar(4000) null,
      @EmailTo  varchar(200) null,
      @CCTo varchar(1000) null,
      @BccTo varchar(1000) null,
      @ASubject varchar(1000) null,
      @ABody nvarchar(max),
      @WATemplateName varchar(50) null,
      @WATemplate nvarchar(max) null,
      @WALanguageCode nvarchar(30) null,
      @DBConnid int null,
      @AlertConfigId int null,
      @SchedularId int null,
      @LastExecutedOn datetime null,
      @NextExecutionTime datetime null,
	  @ActionUser varchar(50)
)
AS
 BEGIN
  SET NOCOUNT ON;

   DECLARE   @ServiceId int ;

   INSERT INTO [ann].[AlertsServiceMaster]
   (
			 [Title]
			,[SDesc]
			,[AlertType]
			,[HasAttachment]
			,[AttachmentType]
			,[AttachmentPath]
			,[AttachmentFileType]
			,[OutputFileName]
			,[DataSourceType]
			,[DataSourceDef]
			,[PostSendDataSourceType]
			,[PostSendDataSourceDef]
			,[EmailTo]
			,[CCTo]
			,[BccTo]
			,[ASubject]
			,[ABody]
			,[WATemplateName]
			,[WATemplate]
			,[WALanguageCode]
			,[DBConnid]
			,[AlertConfigId]
			,[SchedularId]
			,[LastExecutedOn]
			,[NextExecutionTime]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
   )
	VALUES 
	(
			@Title ,
			@SDesc ,
			@AlertType ,
			@HasAttachment ,
			@AttachmentType ,
			@AttachmentPath ,
			@AttachmentFileType ,
			@OutputFileName ,
			@DataSourceType ,
			@DataSourceDef ,
			@PostSendDataSourceType,
			@PostSendDataSourceDef ,
			@EmailTo ,
			@CCTo ,
			@BccTo,
			@ASubject,
			@ABody ,
			@WATemplateName ,
			@WATemplate ,
			@WALanguageCode ,
			@DBConnid ,
			@AlertConfigId ,
			@SchedularId ,
			@LastExecutedOn ,
			@NextExecutionTime ,
			1,
			0,
			@ActionUser,
			getdate()
	)

	SET  @ServiceId= SCOPE_IDENTITY();
    SELECT 
         [ServiceId],
         [Title],
         [SDesc],
         [AlertType],
         [HasAttachment],
         [AttachmentType],
         [AttachmentPath],
         [AttachmentFileType],
         [OutputFileName],
         [DataSourceType],
         [DataSourceDef],
         [PostSendDataSourceType],
         [PostSendDataSourceDef],
         [EmailTo],
         [CCTo],
         [BccTo],
         [ASubject],
         [ABody],
         [WATemplateName],
         [WATemplate],
         [WALanguageCode],
         [DBConnid],
         [AlertConfigId],
         [SchedularId],
         [LastExecutedOn],
         [NextExecutionTime],
         [IsActive],
         [IsDeleted],
         CASE 
             WHEN IsDeleted = 1 THEN 'Inactive'
             WHEN IsActive = 1 THEN 'Active'
             ELSE 'Inactive'
         END AS [Status],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
	  FROM   [ann].[AlertsServiceMaster]
	  WHERE  [ServiceId] = @ServiceId ;
END;

GO
/****** Object:  StoredProcedure [ann].[AlertsServiceMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ann].[AlertsServiceMaster_Delete]
(
		@ServiceId INT,
		@ActionUser varchar(50)
)
AS
 BEGIN
  SET NOCOUNT ON;
  UPDATE   [ann].[AlertsServiceMaster]  
  SET 
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ServiceId] = @ServiceId ;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [ann].[AlertsServiceMaster_ReadAll];

*/
CREATE   PROCEDURE [ann].[AlertsServiceMaster_ReadAll]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT        
         [ServiceId],
         [Title],
         [SDesc],
         [AlertType],
         [HasAttachment],
         [AttachmentType],
         [AttachmentPath],
         [AttachmentFileType],
         [OutputFileName],
         [DataSourceType],
         [DataSourceDef],
         [PostSendDataSourceType],
         [PostSendDataSourceDef],
         [EmailTo],
         [CCTo],
         [BccTo],
         [ASubject],
         [ABody],
         [WATemplateName],
         [WATemplate],
         [WALanguageCode],
         [DBConnid],
         [AlertConfigId],
         [SchedularId],
         [LastExecutedOn],
         [NextExecutionTime],
         [IsActive],
         [IsDeleted],
         CASE 
             WHEN IsDeleted = 1 THEN 'Inactive'
             WHEN IsActive = 1 THEN 'Active'
             ELSE 'Inactive'
         END AS [Status],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [ann].[AlertsServiceMaster]
    WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceMaster_ReadAllPaginated] 
(
		@PageSize INT,
		@PageNo INT,
		@OrderByClause VARCHAR(250) = NULL,
		@WhereClause VARCHAR(250) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

     DECLARE @Result INT = 0, @TotalCount INT = 0;

    SET @Result = (@PageNo - 1) * @PageSize;

    SELECT
	     ROW_NUMBER() OVER (ORDER BY A.CreatedOn DESC) AS RowNum,
		A.[ServiceId],
		A.[Title],
		A.[SDesc],
		A.[AlertType],
		A.[HasAttachment],
		A.[AttachmentType],
		A.[AttachmentPath],
		A.[AttachmentFileType],
		A.[OutputFileName],
		A.[DataSourceType],
		A.[DataSourceDef],
		A.[PostSendDataSourceType],
		A.[PostSendDataSourceDef],
		A.[EmailTo],
		A.[CCTo],
		A.[BccTo],
		A.[ASubject],
		A.[ABody],
		A.[WATemplateName],
		A.[WATemplate],
		A.[WALanguageCode],
		A.[DBConnid],
		A.[AlertConfigId],
		A.[SchedularId],
		B.LastExecutionTime AS LastExecutedOn,
		B.NextExecutionTime AS NextExecutionTime,
		A.[IsActive],
		A.[IsDeleted],
		A.[CreatedBy],
		A.[CreatedOn],
		A.[ModifiedBy],
		A.[ModifiedOn],
        COUNT(*) OVER () AS TotalCount,
        @PageSize AS PageSize,
        @PageNo AS PageNo
    FROM [ann].[AlertsServiceMaster] A
	LEFT OUTER JOIN [ann].[AlertsServiceSchedular] B
	ON A.ServiceId = B.ServiceId
    WHERE 
        A.[IsActive] = 1 
    ORDER BY A.[ServiceId] DESC
    OFFSET @Result ROWS FETCH NEXT @PageSize ROWS ONLY;
END;

GO
/****** Object:  StoredProcedure [ann].[AlertsServiceMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceMaster_ReadById]
(
    @ServiceId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT        
         [ServiceId],
         [Title],
         [SDesc],
         [AlertType],
         [HasAttachment],
         [AttachmentType],
         [AttachmentPath],
         [AttachmentFileType],
         [OutputFileName],
         [DataSourceType],
         [DataSourceDef],
         [PostSendDataSourceType],
         [PostSendDataSourceDef],
         [EmailTo],
         [CCTo],
         [BccTo],
         [ASubject],
         [ABody],
         [WATemplateName],
         [WATemplate],
         [WALanguageCode],
         [DBConnid],
         [AlertConfigId],
         [SchedularId],
         [LastExecutedOn],
         [NextExecutionTime],
         [IsActive],
         [IsDeleted],
         CASE 
             WHEN IsDeleted = 0 AND IsActive = 0 THEN 'Inactive'
             WHEN IsDeleted = 0 AND IsActive = 1 THEN 'Active'
         END AS [Status],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
	  FROM [ann].[AlertsServiceMaster]
	  WHERE [ServiceId] = @ServiceId AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceMaster_Update]
(
			@ServiceId int,
			@Title varchar(100) null,
			@SDesc varchar(1000) null,
			@AlertType varchar(20) null,
			@HasAttachment int null,
			@AttachmentType varchar(100) null,
			@AttachmentPath varchar(500) null,
			@AttachmentFileType varchar(50) null,
			@OutputFileName varchar(100) null,
			@DataSourceType varchar(30) null,
			@DataSourceDef nvarchar(4000) null,
			@PostSendDataSourceType varchar(30) null,
			@PostSendDataSourceDef nvarchar(4000) null,
			@EmailTo  varchar(200) null,
			@CCTo varchar(1000) null,
			@BccTo varchar(1000) null,
			@ASubject varchar(1000) null,
			@ABody nvarchar(max),
			@WATemplateName varchar(50) null,
			@WATemplate nvarchar(max) null,
			@WALanguageCode nvarchar(30) null,
			@DBConnid int null,
			@AlertConfigId int null,
			@SchedularId int null,
			@LastExecutedOn datetime null,
			@NextExecutionTime datetime null,
			@IsActive INT,
			@ActionUser varchar(50)
)
AS
 BEGIN
  SET NOCOUNT ON;

   UPDATE  [ann].[AlertsServiceMaster]
  SET
			[Title] = @Title,
			[SDesc] = @SDesc,
			[AlertType] = @AlertType,
			[HasAttachment] = @HasAttachment,
			[AttachmentType] = @AttachmentType,
			[AttachmentPath] = @AttachmentPath,
			[AttachmentFileType] = @AttachmentFileType,
			[OutputFileName] = @OutputFileName,
			[DataSourceType] = @DataSourceType,
			[DataSourceDef] = @DataSourceDef,
			[PostSendDataSourceType] = @PostSendDataSourceType,
			[PostSendDataSourceDef] = @PostSendDataSourceDef,
			[EmailTo] = @EmailTo,
			[CCTo] = @CCTo,
			[BccTo] = @BccTo,
			[ASubject] = @ASubject,
			[ABody] = @ABody,
			[WATemplateName] = @WATemplateName,
			[WATemplate] = @WATemplate,
			[WALanguageCode] = @WALanguageCode,
			[DBConnid] = @DBConnid,
			[AlertConfigId] = @AlertConfigId,
			[SchedularId] = @SchedularId,
			[LastExecutedOn] = @LastExecutedOn,
			[NextExecutionTime] = @NextExecutionTime,
			[IsActive] = @IsActive,
			[ModifiedBy] = @ActionUser,
			[ModifiedOn] = GETDATE()
    WHERE [ServiceId] = @ServiceId
     AND [IsActive]= 1;

  SELECT 
			[ServiceId],
			[Title],
			[SDesc],
			[AlertType],
			[HasAttachment],
			[AttachmentType],
			[AttachmentPath],
			[AttachmentFileType],
			[OutputFileName],
			[DataSourceType],
			[DataSourceDef],
			[PostSendDataSourceType],
			[PostSendDataSourceDef],
			[EmailTo],
			[CCTo],
			[BccTo],
			[ASubject],
			[ABody],
			[WATemplateName],
			[WATemplate],
			[WALanguageCode],
			[DBConnid],
			[AlertConfigId],
			[SchedularId],
			[LastExecutedOn],
			[NextExecutionTime],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[ModifiedBy],
			[ModifiedOn]
  FROM [ann].[AlertsServiceMaster]
  WHERE [ServiceId] = @ServiceId;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceMaster_UpdateStatus]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceMaster_UpdateStatus]
(
    @ServiceId INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN 
    SET NOCOUNT ON;

    UPDATE [ann].[AlertsServiceMaster]
    SET 
        IsActive = CASE 
                      WHEN IsActive = 1 AND IsDeleted = 0 THEN 0
                      WHEN IsActive = 0 AND IsDeleted = 0 THEN 1
                  END,
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()
    WHERE [ServiceId] = @ServiceId;

    SELECT
       [ServiceId],
       [Title],
       [SDesc],
       [AlertType],
       [HasAttachment],
       [AttachmentType],
       [AttachmentPath],
       [AttachmentFileType],
       [OutputFileName],
       [DataSourceType],
       [DataSourceDef],
       [PostSendDataSourceType],
       [PostSendDataSourceDef],
       [EmailTo],
       [CCTo],
       [BccTo],
       [ASubject],
       [ABody],
       [WATemplateName],
       [WATemplate],
       [WALanguageCode],
       [DBConnid],
       [AlertConfigId],
       [SchedularId],
       [LastExecutedOn],
       [NextExecutionTime],
       [IsActive],
       [IsDeleted],
	   CASE 
             WHEN IsDeleted = 1 THEN 'Inactive'
             WHEN IsActive = 1 THEN 'Active'
           ELSE 'Inactive'
       END AS [Status],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
    FROM [ann].[AlertsServiceMaster]
    WHERE [ServiceId] = @ServiceId;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceSchedular_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ann].[AlertsServiceSchedular_Create]
(
    @ServiceId INT,
    @SchedularId INT,
    @LastExecutionTime DATETIME,
    @NextExecutionTime DATETIME,
    @StartsFrom DATETIME,
    @EndsOn DATETIME,
    @DailyStartOn TIME(3),
    @DailyEndsOn TIME(3),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MappperId INT;

    INSERT INTO [ann].[AlertsServiceSchedular]
    (
        [ServiceId],
        [SchedularId],
        [LastExecutionTime],
        [NextExecutionTime],
        [StartsFrom],
        [EndsOn],
        [DailyStartOn],
        [DailyEndsOn],
        [IsActive],
        [IsDeleted],
        [CreatebBy],         
        [CreatedOn]
    )
    VALUES
    (
        @ServiceId,
        @SchedularId,
        @LastExecutionTime,
        @NextExecutionTime,
        @StartsFrom,
        @EndsOn,
        @DailyStartOn,
        @DailyEndsOn,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @MappperId = SCOPE_IDENTITY();

    SELECT
        [MappperId],        
        [ServiceId],
        [SchedularId],
        [LastExecutionTime],
        [NextExecutionTime],
        [StartsFrom],
        [EndsOn],
        [DailyStartOn],
        [DailyEndsOn],
        [IsActive],
        [IsDeleted],
        [CreatebBy],         
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ann].[AlertsServiceSchedular]
    WHERE [MappperId] = @MappperId;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceSchedular_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ann].[AlertsServiceSchedular_Delete]
(
    @MappperId int,
	@ActionUser varchar(50)
)
AS
 BEGIN
  SET NOCOUNT ON;
        UPDATE[ann].[AlertsServiceSchedular]
	  SET 
			[IsActive]  = 0,
			[IsDeleted]  = 1,
			[ModifiedBy] = @ActionUser,
			[ModifiedOn] = GETDATE()
	   WHERE [MappperId] =@MappperId
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceSchedular_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceSchedular_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
      SELECT 
			 [MappperId]
			,[ServiceId]
			,[SchedularId]
			,[LastExecutionTime]
			,[NextExecutionTime]
			,[StartsFrom]
			,[EndsOn]
			,[DailyStartOn]
			,[DailyEndsOn]
			,[IsActive]
			,[IsDeleted]
			,[CreatebBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	    FROM [ann].[AlertsServiceSchedular]
	    WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceSchedular_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceSchedular_ReadById]
(
    @MappperId int
)
AS
 BEGIN
  SET NOCOUNT ON;
      SELECT 
		 	 [MappperId]
			,[ServiceId]
			,[SchedularId]
			,[LastExecutionTime]
			,[NextExecutionTime]
			,[StartsFrom]
			,[EndsOn]
			,[DailyStartOn]
			,[DailyEndsOn]
			,[IsActive]
			,[IsDeleted]
			,[CreatebBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	    FROM [ann].[AlertsServiceSchedular]
	    WHERE [MappperId] =@MappperId
		AND   [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceSchedular_ReadByServiceId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
[ann].[AlertsServiceSchedular_ReadByServiceId] 1007
*/
CREATE   PROCEDURE [ann].[AlertsServiceSchedular_ReadByServiceId]
(
    @ServiceId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT 
		 [MappperId]
		,[ServiceId]
		,[SchedularId]
		,[LastExecutionTime]
		,[NextExecutionTime]
		,CAST(StartsFrom AS date) as StartsFrom
		,CAST(EndsOn AS date) as EndsOn
		,[DailyStartOn]
		,[DailyEndsOn]
		,[IsActive]
		,[IsDeleted]
		,[CreatebBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	  FROM[ann].[AlertsServiceSchedular]
	  WHERE [ServiceId]= @ServiceId AND IsActive=1;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceSchedular_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceSchedular_Update]
(    
    @MappperId INT,
    @ServiceId INT,
    @SchedularId INT,
    @LastExecutionTime DATETIME,
    @NextExecutionTime DATETIME,
    @StartsFrom DATETIME,
    @EndsOn DATETIME,
    @DailyStartOn TIME(3),
    @DailyEndsOn TIME(3),
	@IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

  UPDATE [ann].[AlertsServiceSchedular]
   SET
			[ServiceId] =  @ServiceId,
			[SchedularId] =  @SchedularId,
			[LastExecutionTime] = @LastExecutionTime, 
			[NextExecutionTime] = @NextExecutionTime,
			[StartsFrom] = @StartsFrom,
			[EndsOn] =  @EndsOn,
			[DailyStartOn] = @DailyStartOn,
			[DailyEndsOn] =  @DailyEndsOn,
			[IsActive] = @IsActive,
			[ModifiedBy] = @ActionUser ,
			[ModifiedOn] = GETDATE()
       WHERE [MappperId] = @MappperId AND [IsActive] = 1;


    SELECT
			[MappperId],        
			[ServiceId],
			[SchedularId],
			[LastExecutionTime],
			[NextExecutionTime],
			[StartsFrom],
			[EndsOn],
			[DailyStartOn],
			[DailyEndsOn],
			[IsActive],
			[IsDeleted],
			[CreatebBy],         
			[CreatedOn],
			[ModifiedBy],
			[ModifiedOn]
    FROM [ann].[AlertsServiceSchedular]
    WHERE [MappperId] = @MappperId;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceVariables_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceVariables_Create]
(
	@ServiceId int,
	@VarInstance varchar(100),
	@VarValue varchar(100) ,
	@VarType varchar(50) ,
    @ActionUser VARCHAR(50)
)
AS
BEGIN 
   SET NOCOUNT ON;
    DECLARE @VariableId int;
	INSERT INTO [ann].[AlertsServiceVariables]
	(
			 [ServiceId]
			,[VarInstance]
			,[VarValue]
			,[VarType]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
	)
	VALUES 
	(
			@ServiceId,
			@VarInstance,
			@VarValue,
			@VarType ,
			1,
			0,
			@ActionUser,
			GETDATE()
	)

	SET @VariableId= SCOPE_IDENTITY()
	SELECT
			 [VariableId]
			,[ServiceId]
			,[VarInstance]
			,[VarValue]
			,[VarType]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	  FROM[ann].[AlertsServiceVariables]
	  WHERE [VariableId] =@VariableId;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceVariables_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceVariables_Delete]
(
   @VariableId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN 
   SET NOCOUNT ON;

   UPDATE [ann].[AlertsServiceVariables]
   SET 
       [IsActive] = 0,
       [IsDeleted] = 1,
       [ModifiedBy] = @ActionUser,
       [ModifiedOn] = GETDATE()
   WHERE 
       [VariableId] = @VariableId;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceVariables_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceVariables_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON;
    SELECT 
			 [VariableId]
			,[ServiceId]
			,[VarInstance]
			,[VarValue]
			,[VarType]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	FROM [ann].[AlertsServiceVariables]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceVariables_ReadAllByServiceId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceVariables_ReadAllByServiceId]
(
   @ServiceId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
   SELECT
			 [VariableId]
			,[ServiceId]
			,[VarInstance]
			,[VarValue]
			,[VarType]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	  FROM [ann].[AlertsServiceVariables]
	  WHERE  [ServiceId]= @ServiceId AND IsActive=1;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceVariables_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceVariables_ReadById]
(
   @VariableId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
    SELECT 
			 [VariableId]
			,[ServiceId]
			,[VarInstance]
			,[VarValue]
			,[VarType]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	FROM    [ann].[AlertsServiceVariables]
	WHERE   [VariableId] = @VariableId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ann].[AlertsServiceVariables_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[AlertsServiceVariables_Update]
(   @VariableId int,
	@ServiceId int,
	@VarInstance varchar(100),
	@VarValue varchar(100) ,
	@VarType varchar(50) ,
	@IsActive int,
    @ActionUser VARCHAR(50)
)
AS
BEGIN 
   SET NOCOUNT ON;
	UPDATE  [ann].[AlertsServiceVariables]
	SET
			[ServiceId] = @ServiceId,
			[VarInstance] =@VarInstance,
			[VarValue] =@VarValue,
			[VarType] = @VarType ,
			[IsActive] =@IsActive,
			[ModifiedBy] =@ActionUser,
			[ModifiedOn] = GETDATE()
	WHERE [VariableId] =@VariableId AND IsActive= 1;
	SELECT
			 [VariableId]
			,[ServiceId]
			,[VarInstance]
			,[VarValue]
			,[VarType]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	  FROM[ann].[AlertsServiceVariables]
	  WHERE [VariableId] =@VariableId;
END;
GO
/****** Object:  StoredProcedure [ann].[DBConnectionMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[DBConnectionMaster_Create]
(
	@ConnName VARCHAR(100) ,
	@ServerName VARCHAR(200) ,
	@UserName VARCHAR(100) ,
	@Passwrd VARCHAR(200) ,
	@DBName  VARCHAR (100) ,
    @ActionUser VARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
   DECLARE  @DBConnId INT ;
   INSERT INTO [ann].[DBConnectionMaster]
   (
		 [ConnName]
		,[ServerName]
		,[UserName]
		,[Passwrd]
		,[DBName]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
   )
   VALUES
   (
		@ConnName  ,
		@ServerName ,
		@UserName ,
		@Passwrd ,
		@DBName ,
		1,
		0,
		@ActionUser,
		GETDATE()
   )
   SET  @DBConnId   = SCOPE_IDENTITY();
   SELECT 
		 [DBConnId]
		,[ConnName]
		,[ServerName]
		,[UserName]
		,[Passwrd]
		,[DBName]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ann].[DBConnectionMaster]
	WHERE [DBConnId] =@DBConnId;
END;
GO
/****** Object:  StoredProcedure [ann].[DBConnectionMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[DBConnectionMaster_Delete]
(
   @DBConnId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
UPDATE [ann].[DBConnectionMaster]
      SET
			[IsActive] = 0,
			[IsDeleted] = 1,
		    [ModifiedBy] = @ActionUser,
		    [ModifiedOn] = GETDATE()
	  WHERE [DBConnId] = @DBConnId
END;
GO
/****** Object:  StoredProcedure [ann].[DBConnectionMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [ann].[DBConnectionMaster_ReadById]
(
   @DBConnId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
    SELECT 
			 [DBConnId]
			,[ConnName]
			,[ServerName]
			,[UserName]
			,[Passwrd]
			,[DBName]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	  FROM [ann].[DBConnectionMaster]
	  WHERE [DBConnId] = @DBConnId
	    AND [IsActive]=1;
END;
GO
/****** Object:  StoredProcedure [ann].[DBConnectionMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ann].[DBConnectionMaster_Update]
(
		@DBConnId INT,
		@ConnName VARCHAR(100) ,
		@ServerName VARCHAR(200) ,
		@UserName VARCHAR(100) ,
		@Passwrd VARCHAR(200) ,
		@DBName  VARCHAR (100) ,
		@IsActive INT,
		@ActionUser VARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;

 UPDATE [ann].[DBConnectionMaster]
   SET 
		[ConnName] = @ConnName ,
		[ServerName] = @ServerName ,
		[UserName] = @UserName ,
		[Passwrd] = @Passwrd ,
		[DBName] = @DBName ,
		[IsActive] =@IsActive,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] =GETDATE()
	WHERE [DBConnId] =@DBConnId AND [IsActive] = 1;
   SELECT 
		 [DBConnId]
		,[ConnName]
		,[ServerName]
		,[UserName]
		,[Passwrd]
		,[DBName]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ann].[DBConnectionMaster]
	WHERE [DBConnId] =@DBConnId;
END;
GO
/****** Object:  StoredProcedure [ann].[DBConnectionMaster_UpdatePassword]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[DBConnectionMaster_UpdatePassword]
(
    @DBConnId INT,
    @NewPassword NVARCHAR(100),
	@ActionUser VARCHAR(50)
 
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [AdvinMaster].[ann].[DBConnectionMaster]
    SET 
        [Passwrd] = @NewPassword,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE 
        [DBConnId] = @DBConnId;
    
    SELECT 'Password updated successfully' AS Message;
END;
GO
/****** Object:  StoredProcedure [ann].[EmailConfig_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ann].[EmailConfig_Create]
(
		@IName varchar(100),
		@IDesc varchar(1000),
		@IHost varchar(500) ,
		@IPort varchar(10) ,
		@IFrom varchar(100) ,
		@IPassword varchar(100) ,
		@IEnableSsl bit,
		@IsBodyHtml bit ,
		@OtherDetail1 VARCHAR(200),
        @OtherDetail2 VARCHAR(200),
        @OtherDetail3 VARCHAR(200),
        @OtherDetail4 VARCHAR(200),
        @OtherDetail5 VARCHAR(200),
		@ActionUser VARCHAR(50)
)
AS
 BEGIN
  SET NOCOUNT ON;
      DECLARE   @EmailConfigId int ;
	  INSERT INTO [ann].[EmailConfig]
       (
			 [IName]
			,[IDesc]
			,[IHost]
			,[IPort]
			,[IFrom]
			,[IPassword]
			,[IEnableSsl]
			,[IsBodyHtml]
		    ,[OtherDetail1]
            ,[OtherDetail2]
            ,[OtherDetail3]
            ,[OtherDetail4]
            ,[OtherDetail5]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
	   )
	  VALUES
	  (
			@IName ,
			@IDesc,
			@IHost  ,
			@IPort ,
			@IFrom  ,
			@IPassword  ,
			@IEnableSsl,
			@IsBodyHtml ,
			@OtherDetail1,
			@OtherDetail2,
			@OtherDetail3,
			@OtherDetail4,
			@OtherDetail5,
			1,
			0,
			@ActionUser,
			GETDATE()
	  )
	   
	  SET @EmailConfigId = SCOPE_IDENTITY();
	  SELECT 
		 	 [EmailConfigId]
			,[IName]
			,[IDesc]
			,[IHost]
			,[IPort]
			,[IFrom]
			,[IPassword]
			,[IEnableSsl]
			,[IsBodyHtml]
	        ,[OtherDetail1]
            ,[OtherDetail2]
            ,[OtherDetail3]
            ,[OtherDetail4]
            ,[OtherDetail5]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	  FROM  [ann].[EmailConfig]
	  WHERE [EmailConfigId]= @EmailConfigId 

END;
GO
/****** Object:  StoredProcedure [ann].[EmailConfig_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[EmailConfig_Delete]
(
    @EmailConfigId INT,
	@ActionUser VARCHAR(50)
)
AS
 BEGIN
  SET NOCOUNT ON;
  UPDATE  [ann].[EmailConfig]
  SET
			[IsActive] = 0,
			[IsDeleted] =1,
			[ModifiedBy] =@ActionUser,
			[ModifiedOn] = GETDATE()
	  FROM  [ann].[EmailConfig]
	  WHERE [EmailConfigId]= @EmailConfigId 

END;
GO
/****** Object:  StoredProcedure [ann].[EmailConfig_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[EmailConfig_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
			 [EmailConfigId]
			,[IName]
			,[IDesc]
			,[IHost]
			,[IPort]
			,[IFrom]
			,[IPassword]
			,[IEnableSsl]
			,[IsBodyHtml]
		    ,[OtherDetail1]
            ,[OtherDetail2]
            ,[OtherDetail3]
            ,[OtherDetail4]
            ,[OtherDetail5]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
		    ,[ModifiedOn]
	  FROM  [ann].[EmailConfig]
	  WHERE IsDeleted = 0
	     AND[IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [ann].[EmailConfig_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[EmailConfig_ReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause VARCHAR(250) = NULL, 
	@WhereClause VARCHAR(250) = NULL   
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    SELECT
	  ROW_NUMBER() OVER (ORDER BY CreatedOn DESC) AS RowNum,
        [EmailConfigId],
        [IName],
        [IDesc],
        [IHost],
        [IPort],
        [IFrom],
        [IPassword],
        [IEnableSsl],
        [IsBodyHtml],
	    [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn],
	    COUNT(*) OVER () AS TotalCount,
        @PageSize AS PageSize,
        @PageNo AS PageNo
    FROM [ann].[EmailConfig]
    WHERE 
        [IsActive] = 1 
    ORDER BY [EmailConfigId] DESC
    OFFSET @Result ROWS FETCH NEXT @PageSize ROWS ONLY;
END
GO
/****** Object:  StoredProcedure [ann].[EmailConfig_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[EmailConfig_ReadById]
(
    @EmailConfigId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
			 [EmailConfigId]
			,[IName]
			,[IDesc]
			,[IHost]
			,[IPort]
			,[IFrom]
			,[IPassword]
			,[IEnableSsl]
			,[IsBodyHtml]
		    ,[OtherDetail1]
            ,[OtherDetail2]
            ,[OtherDetail3]
            ,[OtherDetail4]
            ,[OtherDetail5]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
		    ,[ModifiedOn]
	  FROM  [ann].[EmailConfig]
	  WHERE [EmailConfigId]= @EmailConfigId 
	     AND[IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [ann].[EmailConfig_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[EmailConfig_Update]
(
    @EmailConfigId INT,
    @IName VARCHAR(100),
    @IDesc VARCHAR(1000),
    @IHost VARCHAR(500),
    @IPort VARCHAR(10),
    @IFrom VARCHAR(100),
    @IPassword VARCHAR(100),
    @IEnableSsl BIT,
    @IsBodyHtml BIT,
    @OtherDetail1 VARCHAR(200),
    @OtherDetail2 VARCHAR(200),
    @OtherDetail3 VARCHAR(200),
    @OtherDetail4 VARCHAR(200),
    @OtherDetail5 VARCHAR(200),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ann].[EmailConfig]
    SET
        [IName]         = @IName,
        [IDesc]         = @IDesc,
        [IHost]         = @IHost,
        [IPort]         = @IPort,
        [IFrom]         = @IFrom,
        [IPassword]     = @IPassword,
        [IEnableSsl]    = @IEnableSsl,
        [IsBodyHtml]    = @IsBodyHtml,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE EmailConfigId = @EmailConfigId AND  IsActive=1;

    SELECT 
        [EmailConfigId],
        [IName],
        [IDesc],
        [IHost],
        [IPort],
        [IFrom],
		[IPassword],
        [IEnableSsl],
        [IsBodyHtml],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [IsActive],
        [IsDeleted],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ann].[EmailConfig]
    WHERE EmailConfigId = @EmailConfigId;
END;
GO
/****** Object:  StoredProcedure [ann].[EmailConfig_UpdatePassword]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[EmailConfig_UpdatePassword]
(
    @EmailConfigId INT,
    @NewPassword NVARCHAR(100),
    @ActionUser varchar(50) = NULL 
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ann].[EmailConfig]
    SET 
        [IPassword] = @NewPassword,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE 
        [EmailConfigId] = @EmailConfigId;

    SELECT 'Email config password updated successfully' AS Message;
	

END;
GO
/****** Object:  StoredProcedure [ann].[EmailConfigData_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [ann].[EmailConfigData_ReadAllPaginated]
    @PageSize = 10,          
    @PageNo = 1,             
    @OrderByClause = NULL,   
    @WhereClause = "(iName LIKE ''%demo%'' OR iDesc LIKE ''%demo%'' OR iHost LIKE ''%demo%'' OR iPort LIKE ''%demo%'' OR iFrom LIKE ''%demo%'' )";     
	
*/

CREATE   PROCEDURE [ann].[EmailConfigData_ReadAllPaginated]
(

    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

   -- DECLARE @Result INT = 0, @TotalCount INT = 0;
       --SET @Result = (@PageNo - 1) * @PageSize;

       DECLARE @Result INT = (@PageNo - 1) * @PageSize;

	    DECLARE @SQLQuery NVARCHAR(MAX);
      SET @SQLQuery= N'
        SELECT 
             ROW_NUMBER() OVER (ORDER BY ' + 
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
        ') AS RowNum, 
        [EmailConfigId],
        [IName],
        [IDesc],
        [IHost],
        [IPort],
        [IFrom],
        CAST([IEnableSsl] AS INT) as IEnableSsl,
        CAST([IsBodyHtml] AS INT) as IsBodyHtml,
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
          COUNT(*) OVER () AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo 
    FROM [AdvinMaster].[ann].[EmailConfig]
    WHERE
     IsActive = 1';

       IF @WhereClause IS NOT NULL AND LTRIM(RTRIM(@WhereClause)) <> ''
    BEGIN
        SET @SQLQuery = @SQLQuery + ' AND ' + @WhereClause;
    END

    SET @SQLQuery = @SQLQuery + '
    ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + '
    OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS 
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQLQuery;

    EXEC sp_executesql @SQLQuery;
END;
GO
/****** Object:  StoredProcedure [ann].[FileExtension_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[FileExtension_Create]
(
	@FileType varchar(100) ,
	@FileUploadExtension varchar(50) ,
	@FileSaveExtension varchar(50) ,
    @ActionUser varchar(50)
)
AS
BEGIN 
 SET NOCOUNT ON;
  DECLARE  @FTId int ;
  INSERT INTO [ann].[FileExtension]
  (

       [FileType]
      ,[FileUploadExtension]
      ,[FileSaveExtension]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
  )
  VALUES
  (
		@FileType  ,
		@FileUploadExtension ,
		@FileSaveExtension ,
		1,
		0,
		@ActionUser,
		GETDATE()
  )

  SET @FTId = SCOPE_IDENTITY();
  SELECT
		 [FTId]
		,[FileType]
		,[FileUploadExtension]
		,[FileSaveExtension]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ann].[FileExtension]
	WHERE [FTId] =@FTId;
END;
GO
/****** Object:  StoredProcedure [ann].[FileExtension_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[FileExtension_Delete]
(
   @FTId int,
   @ActionUser varchar(50)
)
AS
BEGIN 
 SET NOCOUNT ON;
   UPDATE [ann].[FileExtension]
   SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [FTId] = @FTId 
END;
GO
/****** Object:  StoredProcedure [ann].[FileExtension_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[FileExtension_ReadAll]
AS
BEGIN 
 SET NOCOUNT ON;
   SELECT
		 [FTId]
		,[FileType]
		,[FileUploadExtension]
		,[FileSaveExtension]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
        ,[ModifiedOn]
	FROM [ann].[FileExtension]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ann].[FileExtension_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[FileExtension_ReadById]
(
   @FTId int
)
AS
BEGIN 
 SET NOCOUNT ON;
   SELECT
		  	 [FTId]
			,[FileType]
			,[FileUploadExtension]
			,[FileSaveExtension]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	FROM [ann].[FileExtension]
	WHERE [FTId] = @FTId 
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ann].[FileExtension_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[FileExtension_Update]
(
    @FTId int,
	@FileType varchar(100) ,
	@FileUploadExtension varchar(50) ,
	@FileSaveExtension varchar(50) ,
	@IsActive int,
    @ActionUser varchar(50)
)
AS
BEGIN 
 SET NOCOUNT ON;

  UPDATE [ann].[FileExtension]
     SET
			[FileType] = @FileType ,
			[FileUploadExtension] = @FileUploadExtension ,
			[FileSaveExtension] = @FileSaveExtension ,
			[IsActive] = @IsActive,
			[CreatedBy] = @ActionUser,
			[CreatedOn] = GETDATE()
 	 WHERE [FTId] =@FTId AND [IsActive]= 1;

    SELECT
			 [FTId]
			,[FileType]
			,[FileUploadExtension]
			,[FileSaveExtension]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [ann].[FileExtension]
		WHERE [FTId] =@FTId;
END;
GO
/****** Object:  StoredProcedure [ann].[GetExecutionServicemaster]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[GetExecutionServicemaster]
AS
BEGIN
	--Change Next Execution Time for exisiting services
	UPDATE A
	SET A.NextExecutionTime = DATEADD(minute, B.FrequencyInMinutes, A.LastExecutionTime)
	FROM ann.AlertsServiceSchedular A WITH (NOLOCK)
	LEFT OUTER JOIN ann.AlertsSchedular B WITH (NOLOCK)
	ON A.SchedularId = B.SchedularId
	WHERE A.IsDeleted <> 1 AND A.IsActive = 1
	AND A.LastExecutionTime IS NOT NULL;

	--Run instantly services scheduled for the first time
	UPDATE A
	SET A.LastExecutionTime = DATEADD(minute, -(B.FrequencyInMinutes), GETDATE()),
		A.NextExecutionTime = GETDATE()
	FROM ann.AlertsServiceSchedular A WITH (NOLOCK)
	LEFT OUTER JOIN ann.AlertsSchedular B WITH (NOLOCK)
	ON A.SchedularId = B.SchedularId
	WHERE A.IsDeleted <> 1 AND A.IsActive = 1
	AND A.LastExecutionTime IS NULL;

	--Get Services to be executed
	IF OBJECT_ID('tempdb..#AlertServiceMaster') IS NOT NULL DROP TABLE #AlertServiceMaster;

	SELECT A.ServiceId,
	A.Title, A.SDesc, A.AlertType,A.HasAttachment, A.AttachmentType, A.AttachmentPath, A.AttachmentFileType, A.OutputFileName,
			A.DataSourceType, A.DataSourceDef, A.PostSendDataSourceType, A.PostSendDataSourceDef, A.EmailTo, A.CCTo, A.BccTo,A.ASubject,A.ABody,
			B.StartsFrom, B.EndsOn, B.DailyStartOn, B.DailyEndsOn,B.MappperId,
			C.SchedularId, C.FrequencyInMinutes, C.SchedularType,
			D.DBConnId, D.ConnName,D.ServerName, D.UserName, D.Passwrd, D.DBName, E.ServiceVariables,A.AlertConfigId
	INTO #AlertServiceMaster
	FROM ann.AlertsServiceMaster A WITH (NOLOCK)
	LEFT OUTER JOIN ann.AlertsServiceSchedular B WITH (NOLOCK)
	ON A.ServiceId = B.ServiceId
	LEFT OUTER JOIN ann.AlertsSchedular C WITH (NOLOCK)
	ON B.SchedularId = C.SchedularId
	LEFT OUTER JOIN ann.DBConnectionMaster D WITH (NOLOCK)
	ON A.DBConnid = D.DBConnId
	LEFT OUTER JOIN (
		SELECT  ServiceId
			   ,STUFF((SELECT ', ' + CAST((VarInstance+ ':'+ VarValue+ ':'+ VarType) AS VARCHAR(100)) ServiceVariables
				 FROM ann.AlertsServiceVariables 
				 WHERE ServiceId = t.ServiceId
				 FOR XML PATH(''), TYPE)
				.value('.','NVARCHAR(MAX)'),1,2,' ') ServiceVariables
		FROM ann.AlertsServiceVariables t
		GROUP BY ServiceId

	) E
	ON A.ServiceId = E.ServiceId
	WHERE A.IsDeleted <> 1 AND A.IsActive = 1
	AND GETDATE() BETWEEN B.StartsFrom AND B.EndsOn
	AND CAST(GETDATE() AS TIME) BETWEEN B.DailyStartOn AND B.DailyEndsOn
	AND B.NextExecutionTime <= GETDATE();

	--Update lastExecutionTime of the Service
	UPDATE B
	SET B.LastExecutionTime = GETDATE()
	FROM #AlertServiceMaster A
	LEFT OUTER JOIN ann.AlertsServiceSchedular B WITH (NOLOCK)
	ON A.MappperId = B.MappperId;

	SELECT * FROM #AlertServiceMaster

END


GO
/****** Object:  StoredProcedure [ann].[GetPushNotifications]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [ann].[GetPushNotifications] 
AS
BEGIN
	IF OBJECT_ID('tempdb..#PushNotifications') IS NOT NULL DROP TABLE #PushNotifications

	SELECT NotificationId, NType, NSubject, NContent, NStatus, NTo, NCc, NBcc, RetryCount, A.IsDeleted, Remarks,AttachmentPath,
			A.PostSendDataSourceType, A.PostSendDataSourceDef, B.DBConnId, B.ConnName,B.ServerName, B.UserName, B.Passwrd, B.DBName,A.AlertConfigId
	INTO #PushNotifications
	FROM ann.NotificationMaster A
	LEFT OUTER JOIN ann.DBConnectionMaster B WITH (NOLOCK)
	ON A.DBConnId = B.DBConnId
	WHERE A.IsDeleted <> 1 AND ISNULL(A.RetryCount,0) < 3 AND A.NStatus = 'Pending' AND ISNULL(A.ScheduledDate, GETDATE()) <= GETDATE();

	UPDATE B
	SET B.RetryCount = (ISNULL(B.RetryCount,0) + 1), B.RetryDate = GETDATE()
	FROM #PushNotifications A
	LEFT OUTER JOIN ann.NotificationMaster B
	ON A.NotificationId = B.NotificationId;
	
	SELECT * FROM #PushNotifications;
END
GO
/****** Object:  StoredProcedure [ann].[NotificationMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[NotificationMaster_Create]
(
	
    @AlertConfigId INT NULL,
	@NType VARCHAR (100) NULL,
	@NSubject VARCHAR (500) NULL,
	@NContent NVARCHAR (max) NULL,
	@NTo VARCHAR (1000) NULL,
	@NCc VARCHAR (1000) NULL,
	@NBcc NVARCHAR (max) NULL,
	@NStatus VARCHAR (50) NULL,
	@Remarks VARCHAR (500) NULL,
	@ScheduledDate datetime NULL,
	@AttachmentPath VARCHAR (1000) NULL,
	@RetryCount INT NULL,
	@RetryDate datetime NULL,
	@PostSendDataSourceType VARCHAR (30) NULL,
	@PostSendDataSourceDef NVARCHAR (4000) NULL,
	@DBConnId INT NULL,
	@ActionUser VARCHAR(50)
	
)
AS
BEGIN

	DECLARE @NotificationId INT = 0;

	INSERT INTO [ann].[NotificationMaster]
    (
		[AlertConfigId],
		[NType],
		[NSubject],
		[NContent],
		[NTo],
		[NCc],
		[NBcc],
		[NStatus],
		[Remarks],
		[ScheduledDate],
		[RetryCount],
        [RetryDate],
		[PostSendDataSourceType],
		[PostSendDataSourceDef],
		[DBConnId],
		[AttachmentPath],
		[IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn]
	 )
	VALUES
	(
		@AlertConfigId,
		@NType,
		@NSubject,
		@NContent,
		@NTo,
		@NCc,
		@NBcc,
		@NStatus,
		@Remarks,
		@ScheduledDate,
		@RetryCount,
		@RetryDate,
		@PostSendDataSourceType,
		@PostSendDataSourceDef,
		@DBConnId,
		@AttachmentPath,
		1,
		0,
		@ActionUser,
		GETDATE()
	)

	SET @NotificationId = SCOPE_IDENTITY()

	SELECT
	   [NotificationId]
      ,[AlertConfigId]
      ,[NType]
      ,[NSubject]
      ,[NContent]
      ,[NTo]
      ,[NCc]
      ,[NBcc]
      ,[NStatus]
      ,[Remarks]
      ,[ScheduledDate]
      ,[AttachmentPath]
      ,[RetryCount]
      ,[RetryDate]
      ,[PostSendDataSourceType]
      ,[PostSendDataSourceDef]
      ,[DBConnId]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
  FROM [Nishwik].[ann].[NotificationMaster]
  WHERE NotificationId = @NotificationId
	
END
GO
/****** Object:  StoredProcedure [ann].[NotificationMaster_Insert]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[NotificationMaster_Insert]
(
	@typNotificationMaster typNotificationMaster ReadOnly
)
AS
BEGIN


	INSERT INTO [ann].[NotificationMaster]
    ([AlertConfigId],
	 [NType],[NSubject],[NContent],[NTo],[NCc],[NBcc],[NStatus],[Remarks],[ScheduledDate],
     [PostSendDataSourceType],[PostSendDataSourceDef],[DBConnId],[AttachmentPath],
	 [IsActive],[RetryCount],[RetryDate],[CreatedBy])
	 SELECT
	 [AlertConfigId],
	 [NType],[NSubject],[NContent],[NTo],[NCc],[NBcc],[NStatus],[Remarks],[ScheduledDate],
     [PostSendDataSourceType],[PostSendDataSourceDef],[DBConnId],[AttachmentPath],
	 1,[RetryCount],[RetryDate],[CreatedBy]
	 FROM @typNotificationMaster;

END
GO
/****** Object:  StoredProcedure [ann].[NotificationMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[NotificationMaster_ReadAll]
AS
BEGIN
  SET NOCOUNT ON;
  SELECT 
       [NotificationId]
      ,[AlertConfigId]
      ,[NType]
      ,[NSubject]
      ,[NContent]
      ,[NTo]
      ,[NCc]
      ,[NBcc]
      ,[NStatus]
      ,[Remarks]
      ,[ScheduledDate]
      ,[AttachmentPath]
      ,[RetryCount]
      ,[RetryDate]
      ,[PostSendDataSourceType]
      ,[PostSendDataSourceDef]
      ,[DBConnId]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [ann].[NotificationMaster]
	  WHERE [IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [ann].[NotificationMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
[ann].[NotificationMaster_ReadAllPaginated]  '2025-01-01','2025-05-07',10,1,'',''
*/
CREATE   PROCEDURE [ann].[NotificationMaster_ReadAllPaginated] 
(
    @Startdate DATETIME,
    @Enddate DATETIME,
    @PageSize INT,
    @PageNo INT,
    @WhereClause VARCHAR(250) = NULL,
    @OrderByClause NVARCHAR(250) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

  	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize ;
    DECLARE @SQLQuery NVARCHAR(MAX);

    -- Adjust the @Enddate if it's today's date
    IF CAST(@Enddate AS DATE) = CAST(GETDATE() AS DATE)
    BEGIN
        SET @Enddate = DATEADD(SECOND, -1, DATEADD(DAY, 1, @Enddate)); 
    END

    -- Calculate the starting row number for pagination
  --  SET @Result = (@PageNo - 1) * @PageSize;

    -- Begin constructing the dynamic SQL query
    SET @SQLQuery = N'SELECT 
        ROW_NUMBER() OVER (ORDER BY ' + 
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
        ') AS RowNum,
        [NotificationId],
        [AlertConfigId],
        [NType],
        [NSubject],
        [NContent],
        [NTo],
        [NCc],
        [NBcc],
        [NStatus],
        [Remarks],
        [ScheduledDate],
        [AttachmentPath],
        [RetryCount],
        [RetryDate],
        [PostSendDataSourceType],
        [PostSendDataSourceDef],
        [DBConnId],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn],
        COUNT(*) OVER () AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [ann].[NotificationMaster]
    WHERE [IsActive] = 1 
      AND [IsDeleted] = 0 
      AND [CreatedOn] BETWEEN ''' + CAST(CAST(@Startdate AS DATE) AS NVARCHAR) + ''' AND ''' + CAST(CAST(@Enddate AS DATE) AS NVARCHAR) + '''';

    -- Add the dynamic WHERE clause if provided
    IF @WhereClause IS NOT NULL AND @WhereClause <> ''
    BEGIN
        SET @SQLQuery = @SQLQuery + ' AND ' + @WhereClause;
    END

    -- Add the ORDER BY and pagination logic
    SET @SQLQuery = @SQLQuery + ' 
    ORDER BY RowNum ASC
    OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS 
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    -- Print the generated SQL query for debugging purposes
    PRINT @SQLQuery;

    -- Execute the dynamic SQL with parameters
    EXEC sp_executesql @SQLQuery;  

END;
GO
/****** Object:  StoredProcedure [ann].[NotificationMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [ann].[NotificationMaster_Update]
(
    @NotificationId             INT,
    @AlertConfigId              INT = NULL,
    @NType                      VARCHAR(100) = NULL,
    @NSubject                   VARCHAR(500) = NULL,
    @NContent                   NVARCHAR(MAX) = NULL,
    @NTo                        VARCHAR(1000) = NULL,
    @NCc                        VARCHAR(1000) = NULL,
    @NBcc                       NVARCHAR(MAX) = NULL,
    @NStatus                    VARCHAR(50) = NULL,
    @Remarks                     VARCHAR(500) = NULL,
    @ScheduledDate              DATETIME = NULL,
    @AttachmentPath             VARCHAR(1000) = NULL,
    @RetryCount                 INT = NULL,
    @RetryDate                  DATETIME = NULL,
    @PostSendDataSourceType     VARCHAR(30) = NULL,
    @PostSendDataSourceDef      NVARCHAR(4000) = NULL,
    @DBConnId                   INT = NULL,
    @IsActive                   INT = 1,
    @ActionUser                 VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ann].[NotificationMaster]
    SET
        [AlertConfigId]            = @AlertConfigId,
        [NType]                    = @NType,
        [NSubject]                 = @NSubject,
        [NContent]                 = @NContent,
        [NTo]                      = @NTo,
        [NCc]                      = @NCc,
        [NBcc]                     = @NBcc,
        [NStatus]                  = @NStatus,
        [Remarks]                  = @Remarks,
        [ScheduledDate]            = @ScheduledDate,
        [AttachmentPath]           = @AttachmentPath,
        [RetryCount]               = @RetryCount,
        [RetryDate]                = @RetryDate,
        [PostSendDataSourceType]   = @PostSendDataSourceType,
        [PostSendDataSourceDef]    = @PostSendDataSourceDef,
        [DBConnId]                 = @DBConnId,
        [IsActive]                 = @IsActive,
        [ModifiedBy]               = @ActionUser,
        [ModifiedOn]               = GETDATE()
    WHERE [NotificationId] = @NotificationId

    SELECT
        [NotificationId],
        [AlertConfigId],
        [NType],
        [NSubject],
        [NContent],
        [NTo],
        [NCc],
        [NBcc],
        [NStatus],
        [Remarks],
        [ScheduledDate],
        [AttachmentPath],
        [RetryCount],
        [RetryDate],
        [PostSendDataSourceType],
        [PostSendDataSourceDef],
        [DBConnId],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ann].[NotificationMaster]
    WHERE [NotificationId] = @NotificationId
      AND [IsDeleted] = 0
	  AND [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [ann].[NotificationMaster_UpdateStatus]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [ann].[NotificationMaster_UpdateStatus]
(
	@typNotificationMaster typNotificationMaster ReadOnly
)
AS
BEGIN
	
	UPDATE B
	SET B.NStatus = A.NStatus,
		B.Remarks = A.Remarks,
		B.ModifiedOn = GETDATE(),
		B.ModifiedBy = 'SYSTEM'
	FROM @typNotificationMaster A
	LEFT OUTER JOIN ann.NotificationMaster B
	ON A.NotificationId = B.NotificationId;
	
END
GO
/****** Object:  StoredProcedure [ann].[NotificationMaster_UpdateStatusById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
	[ann].[NotificationMaster_UpdateStatusById]1, 'Testing', 'Testing', '1'
*/

CREATE PROCEDURE [ann].[NotificationMaster_UpdateStatusById]

(
	@NotificationId INT,
	@NStatus VARCHAR(MAX),
	@Remarks VARCHAR(500),
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	
	UPDATE ann.NotificationMaster
	SET NStatus = @NStatus,
		Remarks = @Remarks,
		ModifiedOn = GETDATE(),
		ModifiedBy = @ActionUser
	FROM ann.NotificationMaster
	WHERE NotificationId = @NotificationId;

	SELECT
	   [NotificationId]
      ,[AlertConfigId]
      ,[NType]
      ,[NSubject]
      ,[NContent]
      ,[NTo]
      ,[NCc]
      ,[NBcc]
      ,[NStatus]
      ,[Remarks]
      ,[ScheduledDate]
      ,[AttachmentPath]
      ,[RetryCount]
      ,[RetryDate]
      ,[PostSendDataSourceType]
      ,[PostSendDataSourceDef]
      ,[DBConnId]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
  FROM [Nishwik].[ann].[NotificationMaster] WHERE NotificationId = @NotificationId
	
END

GO
/****** Object:  StoredProcedure [ann].[WhatsAppConfig_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[WhatsAppConfig_Create]
(
   @IName varchar(100),
   @IDesc varchar(1000),
   @WAUrl nvarchar(500),
   @AccessToken varchar(4000),
   @MProduct varchar(100),
   @IType varchar(100),
   @ActionUser varchar(50)
)
AS
BEGIN 
   SET NOCOUNT ON;
   
   DECLARE  @WAConfigId INT;

   INSERT INTO [ann].[WhatsAppConfig]
   (
      [IName],
      [IDesc],
      [WAUrl],
      [AccessToken],
      [MProduct],
      [IType],
      [IsActive],
      [IsDeleted],
      [CreatedBy],
      [CreatedOn]
   )
   VALUES 
   (
      @IName,
      @IDesc,
      @WAUrl,
      @AccessToken,
	  @MProduct,
      @IType,
      1, 
      0,
      @ActionUser,
      GETDATE() 
   )

   SET @WAConfigId = SCOPE_IDENTITY();

   SELECT 
      [WAConfigId],
      [IName],
      [IDesc],
      [WAUrl],
      [AccessToken],
      [MProduct],
      [IType],
      [IsActive],
      [IsDeleted],
      [CreatedBy],
      [CreatedOn],
      [ModifiedBy],
      [ModifiedOn]
   FROM [ann].[WhatsAppConfig]
   WHERE [WAConfigId] = @WAConfigId;
END;
GO
/****** Object:  StoredProcedure [ann].[WhatsAppConfig_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[WhatsAppConfig_Delete]
(
   @WAConfigId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
UPDATE [ann].[WhatsAppConfig]
   SET 
		[IsActive] = 0,
		[IsDeleted] =1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] =getdate()
  WHERE [WAConfigId] = @WAConfigId;
END;
GO
/****** Object:  StoredProcedure [ann].[WhatsAppConfig_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[WhatsAppConfig_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON;
    SELECT 
		 [WAConfigId]
		,[IName]
		,[IDesc]
		,[WAUrl]
		,[AccessToken]
		,[MProduct]
		,[IType]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
  FROM [ann].[WhatsAppConfig]
  WHERE [IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [ann].[WhatsAppConfig_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [ann].[WhatsAppConfig_ReadAllPaginated] 
(
    @PageSize INT,
    @PageNo INT,
    @WhereClause VARCHAR(250) = NULL,
    @OrderByClause NVARCHAR(250) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

     DECLARE @Result INT = 0, @TotalCount INT = 0;

    SET @Result = (@PageNo - 1) * @PageSize;

    SELECT
        ROW_NUMBER() OVER (ORDER BY CreatedOn DESC) AS RowNum,
        [WAConfigId],
        [IName],
        [IDesc],
        [WAUrl],
        [AccessToken],
        [MProduct],
        [IType],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn],
        COUNT(*) OVER () AS TotalCount,
        @PageSize AS PageSize,
        @PageNo AS PageNo
    FROM [ann].[WhatsAppConfig]
    WHERE 
        [IsActive] = 1 
    ORDER BY CreatedOn DESC
    OFFSET @Result ROWS 
	FETCH NEXT @PageSize ROWS ONLY;
END;
GO
/****** Object:  StoredProcedure [ann].[WhatsAppConfig_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ann].[WhatsAppConfig_ReadById]
(
   @WAConfigId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
    SELECT 
		 [WAConfigId]
		,[IName]
		,[IDesc]
		,[WAUrl]
		,[AccessToken]
		,[MProduct]
		,[IType]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
  FROM [ann].[WhatsAppConfig]
  WHERE [WAConfigId] = @WAConfigId AND IsActive=1;
END;
GO
/****** Object:  StoredProcedure [ann].[WhatsAppConfig_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ann].[WhatsAppConfig_Update]
(
   @WAConfigId INT, 
   @IName VARCHAR(100),
   @IDesc VARCHAR(1000),
   @WAUrl NVARCHAR(500),
   @AccessToken VARCHAR(4000),
   @MProduct VARCHAR(100),
   @IType VARCHAR(100),
   @IsActive INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN 
   SET NOCOUNT ON;

   UPDATE [ann].[WhatsAppConfig]
   SET
			[IName] = @IName,
			[IDesc] = @IDesc,
			[WAUrl] = @WAUrl,
			[AccessToken] = @AccessToken,
			[MProduct] = @MProduct,
			[IType] = @IType,
			[IsActive] = 1,
			[ModifiedBy] = @ActionUser,
			[ModifiedOn] = GETDATE() 
   WHERE [WAConfigId] = @WAConfigId AND IsActive= 1;

   SELECT 
			[WAConfigId],
			[IName],
			[IDesc],
			[WAUrl],
			[AccessToken],
			[MProduct],
			[IType],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[ModifiedBy],
			[ModifiedOn]
   FROM [ann].[WhatsAppConfig]
   WHERE [WAConfigId] = @WAConfigId;
END;
GO
/****** Object:  StoredProcedure [bbps].[Biller_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [bbps].[Biller_Create]
    @BillerName = 'Example Biller',
    @BillerLogo = NULL,
    @BillerDetailJson = N'',
    @CategoryId = 'UTIL001',
    @BillerCode = 'EXB001',
    @SupportBillFetch = 1,
    @SupportBillPayment = 1,
    @OtherDetail1 = 'Info1',
    @OtherDetail2 = 'Info2',
    @OtherDetail3 = 'Info3',
    @OtherDetail4 = 'Info4',
    @OtherDetail5 = 'Details here',
    @OtherDetail6 = 'More details',
    @ActionUser = '4';

*/

CREATE   PROCEDURE [bbps].[Biller_Create]
(
    @BillerName VARCHAR(150),
    @BillerLogo VARCHAR(500) ,
    @BillerDetailJson NVARCHAR(MAX) ,
    @CategoryId VARCHAR(500) ,
    @BillerCode VARCHAR(50),
    @SupportBillFetch INT ,
    @SupportBillPayment INT ,
    @OtherDetail1 VARCHAR(50) ,
    @OtherDetail2 VARCHAR(50) ,
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)

)
AS
BEGIN
    SET NOCOUNT ON;
	DECLARE   @BillerId INT;
    INSERT INTO [bbps].[Biller] (
        [BillerName],
        [BillerLogo],
        [BillerDetailJson],
        [CategoryId],
        [BillerCode],
        [SupportBillFetch],
        [SupportBillPayment],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES (
        @BillerName,
        @BillerLogo,
        @BillerDetailJson,
        @CategoryId,
        @BillerCode,
        @SupportBillFetch,
        @SupportBillPayment,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,  
        0,  
        @ActionUser,
        GETDATE()
    );

    SET @BillerId = SCOPE_IDENTITY();
	SELECT
	   [BillerId]
      ,[BillerName]
      ,[BillerLogo]
      ,[BillerDetailJson]
      ,[CategoryId]
      ,[BillerCode]
      ,[SupportBillFetch]
      ,[SupportBillPayment]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[bbps].[Biller]
	  WHERE [BillerId] = @BillerId
END;
GO
/****** Object:  StoredProcedure [bbps].[Biller_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [bbps].[Biller_Delete]
(
    @BillerId INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [bbps].[Biller]
    SET 
        [IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE 
        [BillerId] = @BillerId;
END;
GO
/****** Object:  StoredProcedure [bbps].[Biller_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [bbps].[Biller_ReadAll]
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [BillerId]
		,[BillerName]
		,[BillerLogo]
		,[BillerDetailJson]
		,[CategoryId]
		,[BillerCode]
		,[SupportBillFetch]
		,[SupportBillPayment]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[Biller]
	WHERE [IsActive]=1
END;
GO
/****** Object:  StoredProcedure [bbps].[Biller_ReadByBillerCode]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [bbps].[Biller_ReadByBillerCode]
(
    @BillerCode VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [BillerId]
		,[BillerName]
		,[BillerLogo]
		,[BillerDetailJson]
		,[CategoryId]
		,[BillerCode]
		,[SupportBillFetch]
		,[SupportBillPayment]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[bbps].[Biller]
	WHERE [BillerCode] = @BillerCode
	AND[IsActive]=1
END;
GO
/****** Object:  StoredProcedure [bbps].[Biller_ReadByCategoryId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [bbps].[Biller_ReadByCategoryId]    Script Date: 5/30/2025 4:34:22 PM ******/

CREATE   PROCEDURE [bbps].[Biller_ReadByCategoryId]
(
    @CategoryId VARCHAR(500)
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [BillerId]
		,[BillerName]
		,[BillerLogo]
		,[BillerDetailJson]
		,[CategoryId]
		,[BillerCode]
		,[SupportBillFetch]
		,[SupportBillPayment]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[bbps].[Biller]
	WHERE [CategoryId] = @CategoryId
	AND[IsActive]=1
END;
GO
/****** Object:  StoredProcedure [bbps].[Biller_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [bbps].[Biller_ReadById]
(
    @BillerId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [BillerId]
		,[BillerName]
		,[BillerLogo]
		,[BillerDetailJson]
		,[CategoryId]
		,[BillerCode]
		,[SupportBillFetch]
		,[SupportBillPayment]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[Biller]
	WHERE [BillerId] = @BillerId
	AND[IsActive]=1
END;
GO
/****** Object:  StoredProcedure [bbps].[Biller_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [bbps].[Biller_Update]
    @BillerId = 1,
    @BillerName = 'Updated Biller',
    @BillerLogo = NULL,
    @BillerDetailJson = N'{"type": "Updated"}',
    @CategoryId = 'UTIL001',
    @BillerCode = 'EXB001',
    @SupportBillFetch = 1,
    @SupportBillPayment = 1,
    @OtherDetail1 = 'Updated1',
    @OtherDetail2 = 'Updated2',
    @OtherDetail3 = 'Updated3',
    @OtherDetail4 = 'Updated4',
    @OtherDetail5 = 'Updated5',
    @OtherDetail6 = 'Updated6',
    @ActionUser = '4';
*/

CREATE   PROCEDURE [bbps].[Biller_Update]
(
    @BillerId INT,
    @BillerName VARCHAR(150),
    @BillerLogo VARCHAR(500),
    @BillerDetailJson NVARCHAR(MAX),
    @CategoryId VARCHAR(500),
    @BillerCode VARCHAR(50),
    @SupportBillFetch INT,
    @SupportBillPayment INT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
	@IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [bbps].[Biller]
    SET
        [BillerName] = @BillerName,
        [BillerLogo] = @BillerLogo,
        [BillerDetailJson] = @BillerDetailJson,
        [CategoryId] = @CategoryId,
        [BillerCode] = @BillerCode,
        [SupportBillFetch] = @SupportBillFetch,
        [SupportBillPayment] = @SupportBillPayment,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
		[IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [BillerId] = @BillerId;

    SELECT
        [BillerId],
        [BillerName],
        [BillerLogo],
        [BillerDetailJson],
        [CategoryId],
        [BillerCode],
        [SupportBillFetch],
        [SupportBillPayment],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [bbps].[Biller]
    WHERE [BillerId] = @BillerId 
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerCategory_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillerCategory_Create]
(
     @CategoryName VARCHAR(100),
     @Description VARCHAR(255),
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
	 @CategoryIconUrl VARCHAR(500),
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @CategoryId INT;

    INSERT INTO [bbps].[BillerCategory]
    (
        [CategoryName],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
		[CategoryIconUrl],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
         @CategoryName,
         @Description,
         @OtherDetail1,
         @OtherDetail2,
         @OtherDetail3,
         @OtherDetail4,
         @OtherDetail5,
         @OtherDetail6,
		 @CategoryIconUrl,
         1,
         0,
         @ActionUser,
         GETDATE()
    );

    SET @CategoryId = SCOPE_IDENTITY();

    SELECT 
         [CategoryId],
         [CategoryName],
         [Description],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
		 [CategoryIconUrl],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [bbps].[BillerCategory]
    WHERE [CategoryId] = @CategoryId;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerCategory_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [bbps].[BillerCategory_Delete]
(
      @CategoryId  int,
	  @ActionUser varchar(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [bbps].[BillerCategory]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE[CategoryId] = @CategoryId

END;
GO
/****** Object:  StoredProcedure [bbps].[BillerCategory_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [bbps].[BillerCategory_ReadAll]
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [CategoryId]
		,[CategoryName]
		,[Description]
		,ISNULL([OtherDetail1],'') OtherDetail1
		,ISNULL([OtherDetail2],'') OtherDetail2
		,ISNULL([OtherDetail3],'') OtherDetail3
		,ISNULL([OtherDetail4],'') OtherDetail4
		,ISNULL([OtherDetail5],'') OtherDetail5
		,ISNULL([OtherDetail6],'') OtherDetail6
		,TRIM([CategoryIconUrl]) CategoryIconUrl
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[BillerCategory]
	WHERE [IsActive]= 1
	END;
GO
/****** Object:  StoredProcedure [bbps].[BillerCategory_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [bbps].[BillerCategory_ReadById]
(
      @CategoryId  int
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [CategoryId]
		,[CategoryName]
		,[Description]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[CategoryIconUrl]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[BillerCategory]
	WHERE[CategoryId] = @CategoryId
	AND[IsActive]= 1
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerCategory_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillerCategory_Update]
(
     @CategoryId INT,
     @CategoryName VARCHAR(100),
     @Description VARCHAR(255),
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
	 @CategoryIconUrl VARCHAR(500),
     @IsActive INT,
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [bbps].[BillerCategory]
    SET 
        [CategoryName] = @CategoryName,
        [Description] = @Description,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
	    [CategoryIconUrl] = @CategoryIconUrl,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [CategoryId] = @CategoryId;

    SELECT 
         [CategoryId],
         [CategoryName],
         [Description],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
		 [CategoryIconUrl],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [bbps].[BillerCategory]
    WHERE [CategoryId] = @CategoryId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerParameter_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillerParameter_Create]
(
		@BillerId INT,
		@ParameterName VARCHAR(100),
		@DisplayName VARCHAR(100),
		@IsMandatory INT,
		@DataType VARCHAR(50),
		@OtherDetail1 VARCHAR(50),
		@OtherDetail2 VARCHAR(50),
		@OtherDetail3 VARCHAR(100),
		@OtherDetail4 VARCHAR(100),
		@OtherDetail5 VARCHAR(500),
		@OtherDetail6 VARCHAR(500),
		@ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ParameterId INT;

    INSERT INTO [bbps].[BillerParameter]
    (
			[BillerId],
			[ParameterName],
			[DisplayName],
			[IsMandatory],
			[DataType],
			[OtherDetail1],
			[OtherDetail2],
			[OtherDetail3],
			[OtherDetail4],
			[OtherDetail5],
			[OtherDetail6],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn]
    )
    VALUES
    (
			@BillerId,
			@ParameterName,
			@DisplayName,
			@IsMandatory,
			@DataType,
			@OtherDetail1,
			@OtherDetail2,
			@OtherDetail3,
			@OtherDetail4,
			@OtherDetail5,
			@OtherDetail6,
			1,      
			0,      
			@ActionUser,
			GETDATE()
    );

    SET @ParameterId = SCOPE_IDENTITY();

    SELECT 
		   [ParameterId]
		  ,[BillerId]
		  ,[ParameterName]
		  ,[DisplayName]
		  ,[IsMandatory]
		  ,[DataType]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
    FROM [bbps].[BillerParameter]
    WHERE [ParameterId] = @ParameterId;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerParameter_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillerParameter_Delete]
(
   @ParameterId INT,
   @ActionUser varchar(50)
)
AS
	BEGIN
	SET NOCOUNT ON;
    UPDATE [bbps].[BillerParameter]
	SET
		   [IsActive] = 0,
		   [IsDeleted] = 1,
		   [ModifiedBy] = @ActionUser, 
		   [ModifiedOn] = GETDATE()
	WHERE  [ParameterId] = @ParameterId
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerParameter_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillerParameter_ReadAll]
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [ParameterId]
		,[BillerId]
		,[ParameterName]
		,[DisplayName]
		,[IsMandatory]
		,[DataType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[BillerParameter]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerParameter_ReadByBillerId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillerParameter_ReadByBillerId]
(
   @BillerId INT
)
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [ParameterId]
		,[BillerId]
		,[ParameterName]
		,[DisplayName]
		,[IsMandatory]
		,[DataType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[BillerParameter]
	WHERE  [BillerId] = @BillerId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerParameter_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillerParameter_ReadById]
(
   @ParameterId INT
)
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [ParameterId]
		,[BillerId]
		,[ParameterName]
		,[DisplayName]
		,[IsMandatory]
		,[DataType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[BillerParameter]
	WHERE  [ParameterId] = @ParameterId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillerParameter_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillerParameter_Update]
(
    @ParameterId INT,
    @BillerId INT,
    @ParameterName VARCHAR(100),
    @DisplayName VARCHAR(100),
    @IsMandatory INT,
    @DataType VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [bbps].[BillerParameter]
    SET
        [BillerId] = @BillerId,
        [ParameterName] = @ParameterName,
        [DisplayName] = @DisplayName,
        [IsMandatory] = @IsMandatory,
        [DataType] = @DataType,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [ParameterId] = @ParameterId;

    SELECT 
       [ParameterId],
       [BillerId],
       [ParameterName],
       [DisplayName],
       [IsMandatory],
       [DataType],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
    FROM [bbps].[BillerParameter]
    WHERE [ParameterId] = @ParameterId
	 AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchRequest_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillFetchRequest_Create]
(
     @UserId INT,
     @BillerId INT,
     @RequestJSON NVARCHAR(MAX),
     @Status VARCHAR(50),
     @BBPSRefId VARCHAR(100),
     @OtherDetail1 VARCHAR(50) ,
     @OtherDetail2 VARCHAR(50) ,
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RequestId INT;

    INSERT INTO [bbps].[BillFetchRequest]
    (
        [UserId],
        [BillerId],
        [RequestJSON],
        [Status],
        [BBPSRefId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @BillerId,
        @RequestJSON,
        @Status,
        @BBPSRefId,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1, 
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @RequestId = SCOPE_IDENTITY();

    SELECT 
	   [RequestId]
      ,[UserId]
      ,[BillerId]
      ,[RequestJSON]
      ,[Status]
      ,[BBPSRefId]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [bbps].[BillFetchRequest]
    WHERE [RequestId] = @RequestId;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchRequest_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[bbps].[BillFetchRequest_Delete]
(
   @RequestId bigint,
   @ActionUser varchar(50)
)
AS
	BEGIN
	SET NOCOUNT ON;
	UPDATE[bbps].[BillFetchRequest]
	SET 
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = getdate()
	WHERE [RequestId] =@RequestId

END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchRequest_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[bbps].[BillFetchRequest_ReadAll]
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT
		 [RequestId]
		,[UserId]
		,[BillerId]
		,[RequestJSON]
		,[Status]
		,[BBPSRefId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[BillFetchRequest]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchRequest_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[bbps].[BillFetchRequest_ReadById]
(
   @RequestId BIGINT
)
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT
		 [RequestId]
		,[UserId]
		,[BillerId]
		,[RequestJSON]
		,[Status]
		,[BBPSRefId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[BillFetchRequest]
	WHERE [RequestId] =@RequestId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchRequest_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[bbps].[BillFetchRequest_ReadByUserId]
(
   @UserId INT
)
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT
		 [RequestId]
		,[UserId]
		,[BillerId]
		,[RequestJSON]
		,[Status]
		,[BBPSRefId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [bbps].[BillFetchRequest]
	WHERE [UserId] =@UserId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchRequest_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillFetchRequest_Update]
(
     @RequestId INT,
     @UserId INT,
     @BillerId INT,
     @RequestJSON NVARCHAR(MAX),
     @Status VARCHAR(50),
     @BBPSRefId VARCHAR(100),
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
     @IsActive INT,
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [bbps].[BillFetchRequest]
    SET
        [UserId] = @UserId,
        [BillerId] = @BillerId,
        [RequestJSON] = @RequestJSON,
        [Status] = @Status,
        [BBPSRefId] = @BBPSRefId,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [RequestId] = @RequestId;

    SELECT 
       [RequestId],
       [UserId],
       [BillerId],
       [RequestJSON],
       [Status],
       [BBPSRefId],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
    FROM [bbps].[BillFetchRequest]
    WHERE [RequestId] = @RequestId
	 AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchResponse_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillFetchResponse_Create]
(
     @RequestId INT,
     @ResponseJSON NVARCHAR(MAX),
     @Amount DECIMAL(18, 2),
     @BillDate DATETIME,
     @DueDate DATETIME,
     @Status VARCHAR(50),
     @ErrorCode VARCHAR(50),
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ResponseId INT;

    INSERT INTO [bbps].[BillFetchResponse]
    (
        [RequestId],
        [ResponseJSON],
        [Amount],
        [BillDate],
        [DueDate],
        [Status],
        [ErrorCode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @RequestId,
        @ResponseJSON,
        @Amount,
        @BillDate,
        @DueDate,
        @Status,
        @ErrorCode,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @ResponseId = SCOPE_IDENTITY();

    SELECT 
        [ResponseId],
        [RequestId],
        [ResponseJSON],
        [Amount],
        [BillDate],
        [DueDate],
        [Status],
        [ErrorCode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [bbps].[BillFetchResponse]
    WHERE [ResponseId] = @ResponseId;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchResponse_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillFetchResponse_Delete]
(
    @ResponseId BIGINT,
	@ActionUser varchar(50)
)
AS
BEGIN 
 SET NOCOUNT ON;
 UPDATE [bbps].[BillFetchResponse]
 SET

            [IsActive] = 0,
            [IsDeleted] = 1,
            [ModifiedBy] = @ActionUser,
            [ModifiedOn] = getdate()
	  WHERE [ResponseId] = @ResponseId

END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchResponse_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillFetchResponse_ReadAll]
AS
BEGIN 
 SET NOCOUNT ON;
 SELECT 
       [ResponseId]
      ,[RequestId]
      ,[ResponseJSON]
      ,[Amount]
      ,[BillDate]
      ,[DueDate]
      ,[Status]
      ,[ErrorCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [bbps].[BillFetchResponse]
	  WHERE [IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchResponse_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillFetchResponse_ReadById]
(
    @ResponseId BIGINT
)
AS
BEGIN 
 SET NOCOUNT ON;
 SELECT 
       [ResponseId]
      ,[RequestId]
      ,[ResponseJSON]
      ,[Amount]
      ,[BillDate]
      ,[DueDate]
      ,[Status]
      ,[ErrorCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [bbps].[BillFetchResponse]
	  WHERE [ResponseId] = @ResponseId
	  AND [IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchResponse_ReadByRequestId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillFetchResponse_ReadByRequestId]
(
    @RequestId BIGINT
)
AS
BEGIN 
 SET NOCOUNT ON;
 SELECT 
       [ResponseId]
      ,[RequestId]
      ,[ResponseJSON]
      ,[Amount]
      ,[BillDate]
      ,[DueDate]
      ,[Status]
      ,[ErrorCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [bbps].[BillFetchResponse]
	  WHERE [RequestId] = @RequestId
	  AND [IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [bbps].[BillFetchResponse_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillFetchResponse_Update]
(
     @ResponseId INT,
     @RequestId INT,
     @ResponseJSON NVARCHAR(MAX),
     @Amount DECIMAL(18, 2),
     @BillDate DATETIME,
     @DueDate DATETIME,
     @Status VARCHAR(50),
     @ErrorCode VARCHAR(50),
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
     @IsActive INT,
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [bbps].[BillFetchResponse]
    SET
        [RequestId] = @RequestId,
        [ResponseJSON] = @ResponseJSON,
        [Amount] = @Amount,
        [BillDate] = @BillDate,
        [DueDate] = @DueDate,
        [Status] = @Status,
        [ErrorCode] = @ErrorCode,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [ResponseId] = @ResponseId;

    SELECT 
        [ResponseId],
        [RequestId],
        [ResponseJSON],
        [Amount],
        [BillDate],
        [DueDate],
        [Status],
        [ErrorCode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [bbps].[BillFetchResponse]
    WHERE [ResponseId] = @ResponseId
	 AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillPayment_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillPayment_Create]
(
     @UserId INT,
     @BillerId INT,
     @Amount DECIMAL(18, 2),
     @BBPSRefId VARCHAR(100),
     @TransactionRefNo VARCHAR(100),
     @RequestJSON NVARCHAR(MAX),
     @ResponseJSON NVARCHAR(MAX),
     @Status VARCHAR(50),
     @PaymentDate DATETIME,
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PaymentId bigint;

    INSERT INTO [bbps].[BillPayment]
    (
        [UserId],
        [BillerId],
        [Amount],
        [BBPSRefId],
        [TransactionRefNo],
        [RequestJSON],
        [ResponseJSON],
        [Status],
        [PaymentDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @BillerId,
        @Amount,
        @BBPSRefId,
        @TransactionRefNo,
        @RequestJSON,
        @ResponseJSON,
        @Status,
        @PaymentDate,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @PaymentId = SCOPE_IDENTITY();

    SELECT 
        [PaymentId],
        [UserId],
        [BillerId],
        [Amount],
        [BBPSRefId],
        [TransactionRefNo],
        [RequestJSON],
        [ResponseJSON],
        [Status],
        [PaymentDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [bbps].[BillPayment]
    WHERE [PaymentId] = @PaymentId;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillPayment_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillPayment_Delete]
(
    @PaymentId bigint,
	@ActionUser varchar(50)
)
AS
BEGIN
  SET NOCOUNT ON
   UPDATE [bbps].[BillPayment]
   SET 

		   [IsActive] = 0,
		   [IsDeleted] =1,
		   [ModifiedBy] = @ActionUser,
		   [ModifiedOn] = getdate()
	  WHERE [PaymentId] =@PaymentId

END;
GO
/****** Object:  StoredProcedure [bbps].[BillPayment_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillPayment_ReadAll]
AS
BEGIN
  SET NOCOUNT ON
   SELECT 
		   [PaymentId]
		  ,[UserId]
		  ,[BillerId]
		  ,[Amount]
		  ,[BBPSRefId]
		  ,[TransactionRefNo]
		  ,[RequestJSON]
		  ,[ResponseJSON]
		  ,[Status]
		  ,[PaymentDate]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [bbps].[BillPayment]
	  WHERE [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillPayment_ReadByBBPSRefId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*


EXEC [bbps].[BillPayment_ReadByBBPSRefId] @BBPSRefId = '9876543210123456';



*/
CREATE   PROCEDURE [bbps].[BillPayment_ReadByBBPSRefId]
(
    @BBPSRefId VARCHAR(100)
)
AS
BEGIN
  SET NOCOUNT ON
   SELECT 
		   [PaymentId]
		  ,[UserId]
		  ,[BillerId]
		  ,[Amount]
		  ,[BBPSRefId]
		  ,[TransactionRefNo]
		  ,[RequestJSON]
		  ,[ResponseJSON]
		  ,[Status]
		  ,[PaymentDate]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [bbps].[BillPayment]
	  WHERE [BBPSRefId] =@BBPSRefId
	  AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillPayment_ReadByBillerId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillPayment_ReadByBillerId]
(
    @BillerId INT
)
AS
BEGIN
  SET NOCOUNT ON
   SELECT 
		   [PaymentId]
		  ,[UserId]
		  ,[BillerId]
		  ,[Amount]
		  ,[BBPSRefId]
		  ,[TransactionRefNo]
		  ,[RequestJSON]
		  ,[ResponseJSON]
		  ,[Status]
		  ,[PaymentDate]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [bbps].[BillPayment]
	  WHERE [BillerId] =@BillerId
	  AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillPayment_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillPayment_ReadById]
(
    @PaymentId BIGINT
)
AS
BEGIN
  SET NOCOUNT ON
   SELECT 
		   [PaymentId]
		  ,[UserId]
		  ,[BillerId]
		  ,[Amount]
		  ,[BBPSRefId]
		  ,[TransactionRefNo]
		  ,[RequestJSON]
		  ,[ResponseJSON]
		  ,[Status]
		  ,[PaymentDate]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [bbps].[BillPayment]
	  WHERE [PaymentId] =@PaymentId
	  AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillPayment_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillPayment_ReadByUserId]
(
    @UserId INT
)
AS
BEGIN
  SET NOCOUNT ON
   SELECT 
		   [PaymentId]
		  ,[UserId]
		  ,[BillerId]
		  ,[Amount]
		  ,[BBPSRefId]
		  ,[TransactionRefNo]
		  ,[RequestJSON]
		  ,[ResponseJSON]
		  ,[Status]
		  ,[PaymentDate]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [bbps].[BillPayment]
	  WHERE [UserId] =@UserId
	  AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[BillPayment_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[BillPayment_Update]
(
     @PaymentId INT,
     @UserId INT,
     @BillerId INT,
     @Amount DECIMAL(18, 2),
     @BBPSRefId VARCHAR(100),
     @TransactionRefNo VARCHAR(100),
     @RequestJSON NVARCHAR(MAX),
     @ResponseJSON NVARCHAR(MAX),
     @Status VARCHAR(50),
     @PaymentDate DATETIME,
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
     @IsActive INT,
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [bbps].[BillPayment]
    SET
        [UserId] = @UserId,
        [BillerId] = @BillerId,
        [Amount] = @Amount,
        [BBPSRefId] = @BBPSRefId,
        [TransactionRefNo] = @TransactionRefNo,
        [RequestJSON] = @RequestJSON,
        [ResponseJSON] = @ResponseJSON,
        [Status] = @Status,
        [PaymentDate] = @PaymentDate,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [PaymentId] = @PaymentId;

    SELECT 
        [PaymentId],
        [UserId],
        [BillerId],
        [Amount],
        [BBPSRefId],
        [TransactionRefNo],
        [RequestJSON],
        [ResponseJSON],
        [Status],
        [PaymentDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [bbps].[BillPayment]
    WHERE [PaymentId] = @PaymentId
	 AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [bbps].[ErrorLog_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[ErrorLog_Create]
(
     @Source VARCHAR(100),
     @ReferenceId VARCHAR(100),
     @ErrorCode VARCHAR(50),
     @ErrorMessage VARCHAR(1000),
     @RawResponse NVARCHAR(MAX),
     @LoggedAt DATETIME,
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @LogId INT;

    INSERT INTO [bbps].[ErrorLog]
    (
        [Source],
        [ReferenceId],
        [ErrorCode],
        [ErrorMessage],
        [RawResponse],
        [LoggedAt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @Source,
        @ReferenceId,
        @ErrorCode,
        @ErrorMessage,
        @RawResponse,
        @LoggedAt,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @LogId = SCOPE_IDENTITY();

    SELECT 
	   [LogId]
      ,[Source]
      ,[ReferenceId]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[RawResponse]
      ,[LoggedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [bbps].[ErrorLog]
    WHERE [LogId] = @LogId;
END;
GO
/****** Object:  StoredProcedure [bbps].[ErrorLog_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[ErrorLog_Delete]
(
   @LogId bigint,
   @ActionUser varchar(50)
)
AS
BEGIN
	SET NOCOUNT ON
	UPDATE [bbps].[ErrorLog]
	SET 
		[IsActive] = 0,
		[IsDeleted] =1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [LogId] =@LogId

END;
GO
/****** Object:  StoredProcedure [bbps].[ErrorLog_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[ErrorLog_ReadAll]
AS
BEGIN
   SET NOCOUNT ON
   SELECT 
       [LogId]
      ,[Source]
      ,[ReferenceId]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[RawResponse]
      ,[LoggedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [bbps].[ErrorLog]
	  WHERE [IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [bbps].[ErrorLog_ReadByErrorCode]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[ErrorLog_ReadByErrorCode]
(
   @ErrorCode VARCHAR(50)
)
AS
BEGIN
   SET NOCOUNT ON
   SELECT 
       [LogId]
      ,[Source]
      ,[ReferenceId]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[RawResponse]
      ,[LoggedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [bbps].[ErrorLog]
	  WHERE [ErrorCode] =@ErrorCode
	  AND [IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [bbps].[ErrorLog_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[ErrorLog_ReadById]
(
   @LogId BIGINT
)
AS
BEGIN
   SET NOCOUNT ON
   SELECT 
       [LogId]
      ,[Source]
      ,[ReferenceId]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[RawResponse]
      ,[LoggedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [bbps].[ErrorLog]
	  WHERE [LogId] =@LogId
	  AND [IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [bbps].[ErrorLog_ReadByReferenceId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[ErrorLog_ReadByReferenceId]
(
   @ReferenceId BIGINT
)
AS
BEGIN
   SET NOCOUNT ON
   SELECT 
       [LogId]
      ,[Source]
      ,[ReferenceId]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[RawResponse]
      ,[LoggedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [bbps].[ErrorLog]
	  WHERE [ReferenceId] =@ReferenceId
	  AND [IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [bbps].[ErrorLog_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [bbps].[ErrorLog_Update]
(
     @LogId INT,
     @Source VARCHAR(100),
     @ReferenceId VARCHAR(100),
     @ErrorCode VARCHAR(50),
     @ErrorMessage VARCHAR(1000),
     @RawResponse NVARCHAR(MAX),
     @LoggedAt DATETIME,
     @OtherDetail1 VARCHAR(50),
     @OtherDetail2 VARCHAR(50),
     @OtherDetail3 VARCHAR(100),
     @OtherDetail4 VARCHAR(100),
     @OtherDetail5 VARCHAR(500),
     @OtherDetail6 VARCHAR(500),
     @IsActive INT,
     @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [bbps].[ErrorLog]
    SET
        [Source] = @Source,
        [ReferenceId] = @ReferenceId,
        [ErrorCode] = @ErrorCode,
        [ErrorMessage] = @ErrorMessage,
        [RawResponse] = @RawResponse,
        [LoggedAt] = @LoggedAt,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [LogId] = @LogId;

    SELECT 
	   [LogId]
      ,[Source]
      ,[ReferenceId]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[RawResponse]
      ,[LoggedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [bbps].[ErrorLog]
    WHERE [LogId] = @LogId
	 AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCard_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCard_Create]
(
    @ApplicationId     BIGINT,
    @CardNumber        VARCHAR(16),
    @CVV               VARCHAR(4),
    @ExpiryDate        DATETIME,
    @ActivationDate    DATETIME,
    @Status            VARCHAR(50),
    @CurrentLimit      DECIMAL(18, 2),
    @AvailableLimit    DECIMAL(18, 2),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @CardId BIGINT;

    INSERT INTO [ccp].[CreditCard]
    (
        [ApplicationId],
        [CardNumber],
        [CVV],
        [ExpiryDate],
        [ActivationDate],
        [Status],
        [CurrentLimit],
        [AvailableLimit],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ApplicationId,
        @CardNumber,
        @CVV,
        @ExpiryDate,
        @ActivationDate,
        @Status,
        @CurrentLimit,
        @AvailableLimit,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @CardId = SCOPE_IDENTITY();

    SELECT 
        [CardId],
        [ApplicationId],
        [CardNumber],
        [CVV],
        [ExpiryDate],
        [ActivationDate],
        [Status],
        [CurrentLimit],
        [AvailableLimit],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ccp].[CreditCard]
    WHERE CardId = @CardId;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCard_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCard_Delete]
(
      @CardId bigint,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	Update[ccp].[CreditCard]
	SET
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE  [CardId] = @CardId
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCard_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCard_ReadAll]
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [CardId]
		,[ApplicationId]
		,[CardNumber]
		,[CVV]
		,[ExpiryDate]
		,[ActivationDate]
		,[Status]
		,[CurrentLimit]
		,[AvailableLimit]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ccp].[CreditCard]
	WHERE [IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCard_ReadByApplicationId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCard_ReadByApplicationId]
(
      @ApplicationId bigint
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [CardId]
		,[ApplicationId]
		,[CardNumber]
		,[CVV]
		,[ExpiryDate]
		,[ActivationDate]
		,[Status]
		,[CurrentLimit]
		,[AvailableLimit]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ccp].[CreditCard]
	WHERE  [ApplicationId] = @ApplicationId
	AND[IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCard_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCard_ReadById]
(
      @CardId bigint
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [CardId]
		,[ApplicationId]
		,[CardNumber]
		,[CVV]
		,[ExpiryDate]
		,[ActivationDate]
		,[Status]
		,[CurrentLimit]
		,[AvailableLimit]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ccp].[CreditCard]
	WHERE  [CardId] = @CardId
	AND[IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCard_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCard_Update]
(
    @CardId            BIGINT,
    @ApplicationId     BIGINT,
    @CardNumber        VARCHAR(16),
    @CVV               VARCHAR(4),
    @ExpiryDate        DATETIME,
    @ActivationDate    DATETIME,
    @Status            VARCHAR(50),
    @CurrentLimit      DECIMAL(18, 2),
    @AvailableLimit    DECIMAL(18, 2),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @IsDeleted         INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ccp].[CreditCard]
    SET
        ApplicationId   = @ApplicationId,
        CardNumber      = @CardNumber,
        CVV             = @CVV,
        ExpiryDate      = @ExpiryDate,
        ActivationDate  = @ActivationDate,
        Status          = @Status,
        CurrentLimit    = @CurrentLimit,
        AvailableLimit  = @AvailableLimit,
        OtherDetail1    = @OtherDetail1,
        OtherDetail2    = @OtherDetail2,
        OtherDetail3    = @OtherDetail3,
        OtherDetail4    = @OtherDetail4,
        OtherDetail5    = @OtherDetail5,
        OtherDetail6    = @OtherDetail6,
        IsActive        = @IsActive,
        IsDeleted       = @IsDeleted,
        ModifiedBy      = @ActionUser,
        ModifiedOn      = GETDATE()
    WHERE
        CardId = @CardId;

    SELECT 
        [CardId],
        [ApplicationId],
        [CardNumber],
        [CVV],
        [ExpiryDate],
        [ActivationDate],
        [Status],
        [CurrentLimit],
        [AvailableLimit],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ccp].[CreditCard]
    WHERE CardId = @CardId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardApplication_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*

EXEC [ccp].[CreditCardApplication_Create]
    @UserId = 101,
    @ProductId = 5,
    @ApplicationDate = GETDATE(),
    @Status = 'Pending',
    @CreditLimitRequested = 150000.00,
    @ApprovedLimit = 0.00,
    @RejectionReason = NULL,
    @KYCStatus = 'Pending',
    @OtherDetail1 = 'Online',
    @OtherDetail2 = 'PromoCode123',
    @OtherDetail3 = 'Ref123',
    @OtherDetail4 = 'CampaignABC',
    @OtherDetail5 = 'Notes about the application process.',
    @OtherDetail6 = 'Optional long text or JSON data.',
    @ActionUser = '4';


*/
CREATE   PROCEDURE [ccp].[CreditCardApplication_Create]
(
    @UserId                 INT,
    @ProductId              INT,
    @ApplicationDate        DATETIME,
    @Status                 VARCHAR(50),
    @CreditLimitRequested   DECIMAL(18, 2),
    @ApprovedLimit          DECIMAL(5, 2),
    @RejectionReason        VARCHAR(255),
    @KYCStatus              VARCHAR(50),
    @OtherDetail1           VARCHAR(50),
    @OtherDetail2           VARCHAR(50),
    @OtherDetail3           VARCHAR(100),
    @OtherDetail4           VARCHAR(100),
    @OtherDetail5           VARCHAR(500),
    @OtherDetail6           VARCHAR(500),
    @ActionUser             VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ApplicationId BIGINT;

    INSERT INTO [ccp].[CreditCardApplication]
    (
        UserId,
        ProductId,
        ApplicationDate,
        Status,
        CreditLimitRequested,
        ApprovedLimit,
        RejectionReason,
        KYCStatus,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    VALUES
    (
        @UserId,
        @ProductId,
        @ApplicationDate,
        @Status,
        @CreditLimitRequested,
        @ApprovedLimit,
        @RejectionReason,
        @KYCStatus,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1, 
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @ApplicationId = SCOPE_IDENTITY();

    SELECT 
       [ApplicationId]
      ,[UserId]
      ,[ProductId]
      ,[ApplicationDate]
      ,[Status]
      ,[CreditLimitRequested]
      ,[ApprovedLimit]
      ,[RejectionReason]
      ,[KYCStatus]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [ccp].[CreditCardApplication]
    WHERE ApplicationId = @ApplicationId;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardApplication_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardApplication_Delete]
(
     @ApplicationId BIGINT,
	 @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [ccp].[CreditCardApplication]
	SET
		  [IsActive]   = 0,
		  [IsDeleted]  = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [ApplicationId] = @ApplicationId
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardApplication_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardApplication_ReadAll]
AS
BEGIN 
	SET NOCOUNT ON;
	
	SELECT 
		CCA.ApplicationId,
		CCA.ApplicationDate,
		CCA.Status,
		CCA.KYCStatus,
		CCA.CreditLimitRequested,
		CCA.ApprovedLimit,
		ISNULL(CCA.RejectionReason,'') RejectionReason,
		CCA.UserId,
		CONCAT(ISNULL(U.FirstName,''), ' ', ISNULL(U.LastName,'')) AS FullName,
		CCA.ProductId,
		CCP.ProductName,
		CCP.Description,
		CCP.MaxCreditLimit,
		CCP.MinCreditLimit,
		CCP.InterestRate,
		CCP.TenureMonths
	FROM 
		[ccp].[CreditCardApplication] CCA WITH (NOLOCK)
	LEFT JOIN 
		[ccp].[CreditCardProduct] CCP ON CCP.ProductId = CCA.ProductId
	LEFT JOIN 
		[dbo].[Usermaster] U WITH (NOLOCK) ON U.UserId = CCA.UserId
	WHERE 
		CCP.IsDeleted = 0 AND CCA.IsDeleted = 0
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardApplication_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardApplication_ReadById]
(
   @ApplicationId BIGINT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [ApplicationId]
		,[UserId]
		,[ProductId]
		,[ApplicationDate]
		,[Status]
		,[CreditLimitRequested]
		,[ApprovedLimit]
		,[RejectionReason]
		,[KYCStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ccp].[CreditCardApplication]
	WHERE [ApplicationId] = @ApplicationId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardApplication_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardApplication_ReadByUserId]
(
   @UserId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [ApplicationId]
		,[UserId]
		,[ProductId]
		,[ApplicationDate]
		,[Status]
		,[CreditLimitRequested]
		,[ApprovedLimit]
		,[RejectionReason]
		,[KYCStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ccp].[CreditCardApplication]
	WHERE [UserId] = @UserId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardApplication_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardApplication_Update]
(
    @ApplicationId          BIGINT,
    @UserId                 INT,
    @ProductId              INT,
    @ApplicationDate        DATETIME,
    @Status                 VARCHAR(50),
    @CreditLimitRequested   DECIMAL(18, 2),
    @ApprovedLimit          DECIMAL(5, 2),
    @RejectionReason        VARCHAR(255),
    @KYCStatus              VARCHAR(50),
    @OtherDetail1           VARCHAR(50),
    @OtherDetail2           VARCHAR(50),
    @OtherDetail3           VARCHAR(100),
    @OtherDetail4           VARCHAR(100),
    @OtherDetail5           VARCHAR(500),
    @OtherDetail6           VARCHAR(500),
    @IsActive               INT,
    @ActionUser             VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ccp].[CreditCardApplication]
    SET
        UserId = @UserId,
        ProductId = @ProductId,
        ApplicationDate = @ApplicationDate,
        Status = @Status,
        CreditLimitRequested = @CreditLimitRequested,
        ApprovedLimit = @ApprovedLimit,
        RejectionReason = @RejectionReason,
        KYCStatus = @KYCStatus,
        OtherDetail1 = @OtherDetail1,
        OtherDetail2 = @OtherDetail2,
        OtherDetail3 = @OtherDetail3,
        OtherDetail4 = @OtherDetail4,
        OtherDetail5 = @OtherDetail5,
        OtherDetail6 = @OtherDetail6,
        IsActive = @IsActive,
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()
    WHERE ApplicationId = @ApplicationId;

    SELECT 
        [ApplicationId],
        [UserId],
        [ProductId],
        [ApplicationDate],
        [Status],
        [CreditLimitRequested],
        [ApprovedLimit],
        [RejectionReason],
        [KYCStatus],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ccp].[CreditCardApplication]
    WHERE ApplicationId = @ApplicationId
	 AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardKYC_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardKYC_Create]
(
    @ApplicationId      BIGINT,
    @DocumentType       VARCHAR(100),
    @DocumentNumber     VARCHAR(50),
    @FilePath           VARCHAR(255),
    @Verified           INT,
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @KYCId BIGINT;

    INSERT INTO [ccp].[CreditCardKYC]
    (
        ApplicationId,
        DocumentType,
        DocumentNumber,
        FilePath,
        Verified,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    VALUES
    (
        @ApplicationId,
        @DocumentType,
        @DocumentNumber,
        @FilePath,
        @Verified,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @KYCId = SCOPE_IDENTITY();

    SELECT 
	   [KYCId]
      ,[ApplicationId]
      ,[DocumentType]
      ,[DocumentNumber]
      ,[FilePath]
      ,[Verified]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [ccp].[CreditCardKYC]
    WHERE KYCId = @KYCId;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardKYC_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardKYC_Delete]
(
     @KYCId BIGINT,
	 @ActionUser varchar(50)
)
AS
BEGIN 
   SET NOCOUNT ON;

   UPDATE[ccp].[CreditCardKYC]
   SET
          [IsActive] = 1,
          [IsDeleted] = 0,
          [ModifiedBy] = @ActionUser,
          [ModifiedOn] = GETDATE()
	  WHERE [KYCId] = @KYCId
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardKYC_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardKYC_ReadAll]
AS
BEGIN 
   SET NOCOUNT ON;
   SELECT
       [KYCId]
      ,[ApplicationId]
      ,[DocumentType]
      ,[DocumentNumber]
      ,[FilePath]
      ,[Verified]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [ccp].[CreditCardKYC]
	  WHERE [IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardKYC_ReadByApplicationId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardKYC_ReadByApplicationId]
(
     @ApplicationId BIGINT
)
AS
BEGIN 
   SET NOCOUNT ON;
   SELECT
       [KYCId]
      ,[ApplicationId]
      ,[DocumentType]
      ,[DocumentNumber]
      ,[FilePath]
      ,[Verified]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [ccp].[CreditCardKYC]
	  WHERE [ApplicationId] =@ApplicationId
	  AND[IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardKYC_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardKYC_ReadById]
(
     @KYCId BIGINT
)
AS
BEGIN 
   SET NOCOUNT ON;
   SELECT
       [KYCId]
      ,[ApplicationId]
      ,[DocumentType]
      ,[DocumentNumber]
      ,[FilePath]
      ,[Verified]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [ccp].[CreditCardKYC]
	  WHERE [KYCId] =@KYCId
	  AND[IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardKYC_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardKYC_Update]
(
    @KYCId              BIGINT,
    @ApplicationId      BIGINT,
    @DocumentType       VARCHAR(100),
    @DocumentNumber     VARCHAR(50),
    @FilePath           VARCHAR(255),
    @Verified           INT,
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @IsActive           INT,
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ccp].[CreditCardKYC]
    SET
        ApplicationId    = @ApplicationId,
        DocumentType     = @DocumentType,
        DocumentNumber   = @DocumentNumber,
        FilePath         = @FilePath,
        Verified         = @Verified,
        OtherDetail1     = @OtherDetail1,
        OtherDetail2     = @OtherDetail2,
        OtherDetail3     = @OtherDetail3,
        OtherDetail4     = @OtherDetail4,
        OtherDetail5     = @OtherDetail5,
        OtherDetail6     = @OtherDetail6,
        IsActive         = @IsActive,
        ModifiedBy       = @ActionUser,
        ModifiedOn       = GETDATE()
    WHERE KYCId = @KYCId;

    SELECT 
        [KYCId],
        [ApplicationId],
        [DocumentType],
        [DocumentNumber],
        [FilePath],
        [Verified],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ccp].[CreditCardKYC]
    WHERE KYCId = @KYCId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardProduct_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ccp].[CreditCardProduct_Create]
(
    @ProductName VARCHAR(100),
    @Description VARCHAR(255),
    @MaxCreditLimit DECIMAL(18, 2),
    @MinCreditLimit DECIMAL(18, 2),
    @InterestRate DECIMAL(5, 2),
    @TenureMonths INT,
    @JoiningFee DECIMAL(18, 2),
    @AnnualFee DECIMAL(18, 2),
    @ContactPhone VARCHAR(15),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ProductId INT;

    INSERT INTO [ccp].[CreditCardProduct]
    (
        [ProductName],
        [Description],
        [MaxCreditLimit],
        [MinCreditLimit],
        [InterestRate],
        [TenureMonths],
        [JoiningFee],
        [AnnualFee],
        [ContactPhone],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ProductName,
        @Description,
        @MaxCreditLimit,
        @MinCreditLimit,
        @InterestRate,
        @TenureMonths,
        @JoiningFee,
        @AnnualFee,
        @ContactPhone,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1, 
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @ProductId = SCOPE_IDENTITY();

    SELECT
	   [ProductId]
      ,[ProductName]
      ,[Description]
      ,[MaxCreditLimit]
      ,[MinCreditLimit]
      ,[InterestRate]
      ,[TenureMonths]
      ,[JoiningFee]
      ,[AnnualFee]
      ,[ContactPhone]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [ccp].[CreditCardProduct] 
	WHERE [ProductId] = @ProductId;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardProduct_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardProduct_Delete]
(
   @ProductId INT,
   @ActionUser VARCHAR(50)
)
AS
	BEGIN 
	SET NOCOUNT ON;
	UPDATE[ccp].[CreditCardProduct]
	SET
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [ProductId] = @ProductId
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardProduct_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardProduct_ReadAll]
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT
		 ccp.[ProductId]
		,ccp.[ProductName]
		,ccp.[Description]
		,ccp.[MaxCreditLimit]
		,ccp.[MinCreditLimit]
		,ccp.[InterestRate]
		,ccp.[TenureMonths]
		,ccp.[JoiningFee]
		,ccp.[AnnualFee]
		,ISNULL(t.Active, 0) AS Active
		,ISNULL(t.Pending, 0) AS Pending
		,ISNULL(t.Rejected, 0) AS Rejected
		,ISNULL(t.UnderReview, 0) AS UnderReview
		,ISNULL(t.TotalProductApplications, 0) AS ProductCount
		,ccp.[ContactPhone]
		,ccp.[OtherDetail1]
		,ccp.[OtherDetail2]
		,ccp.[OtherDetail3]
		,ccp.[OtherDetail4]
		,ccp.[OtherDetail5]
		,ccp.[OtherDetail6]
		,ccp.[IsActive]
	FROM [ccp].[CreditCardProduct] ccp WITH (NOLOCK)
	LEFT JOIN [ccp].[CreditCardProduct_GetApplicationStatusCounts]() t
    ON t.ProductId = ccp.ProductId
	WHERE ccp.[IsActive] = 1

END;


	
GO
/****** Object:  StoredProcedure [ccp].[CreditCardProduct_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [ccp].[CreditCardProduct_ReadAllPaginated]
(
    @PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL
)
AS
	BEGIN 
		SET NOCOUNT ON; 
		DECLARE @Result INT = 0, @TotalCount INT = 0;
		SET @Result = (@PageNo - 1) * @PageSize;
		SET NOCOUNT ON;

		DECLARE @SQL NVARCHAR(MAX);
		SET @SQL ='
		SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'ccp.CreatedOn DESC') + 
		') AS RowNum,
			ccp. [ProductId]
			,ccp.[ProductName]
			,ccp.[Description]
			,ccp.[MaxCreditLimit]
			,ccp.[MinCreditLimit]
			,ccp.[InterestRate]
			,ccp.[TenureMonths]
			,ccp.[JoiningFee]
			,ccp.[AnnualFee]
			,ISNULL(t.Active, 0) AS Active
			,ISNULL(t.Pending, 0) AS Pending
			,ISNULL(t.Rejected, 0) AS Rejected
			,ISNULL(t.UnderReview, 0) AS UnderReview
			,ISNULL(t.TotalProductApplications, 0) AS ProductCount
			,ccp.[ContactPhone]
			,ccp.[OtherDetail1]
			,ccp.[OtherDetail2]
			,ccp.[OtherDetail3]
			,ccp.[OtherDetail4]
			,ccp.[OtherDetail5]
			,ccp.[OtherDetail6]
			,ccp.[IsActive]
		,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [ccp].[CreditCardProduct] ccp WITH (NOLOCK)
		LEFT JOIN [ccp].[CreditCardProduct_GetApplicationStatusCounts]() t
		ON t.ProductId = ccp.ProductId
		WHERE ccp.[IsActive] = 1';

		IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

		IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
		SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
		ELSE
		SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

		SET @SQL = @SQL + '
		OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
		FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';


		EXEC sp_executesql @SQL;
END;


	
GO
/****** Object:  StoredProcedure [ccp].[CreditCardProduct_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardProduct_ReadById]
(
   @ProductId INT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT
		 ccp.[ProductId]
		,ccp.[ProductName]
		,ccp.[Description]
		,ccp.[MaxCreditLimit]
		,ccp.[MinCreditLimit]
		,ccp.[InterestRate]
		,ccp.[TenureMonths]
		,ccp.[JoiningFee]
		,ccp.[AnnualFee]
		,ISNULL(t.Active, 0) AS Active
		,ISNULL(t.Pending, 0) AS Pending
		,ISNULL(t.Rejected, 0) AS Rejected
		,ISNULL(t.UnderReview, 0) AS UnderReview
		,ISNULL(t.TotalProductApplications, 0) AS ProductCount
		,ccp.[ContactPhone]
		,ccp.[OtherDetail1]
		,ccp.[OtherDetail2]
		,ccp.[OtherDetail3]
		,ccp.[OtherDetail4]
		,ccp.[OtherDetail5]
		,ccp.[OtherDetail6]
		,ccp.[IsActive]
		,ccp.[CreatedOn]
	FROM [ccp].[CreditCardProduct] ccp WITH (NOLOCK)
	LEFT JOIN [ccp].[CreditCardProduct_GetApplicationStatusCounts]() t
    ON t.ProductId = ccp.ProductId
	WHERE ccp.[ProductId] = @ProductId AND ccp.[IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardProduct_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [ccp].[CreditCardProduct_Update]
(
    @ProductId INT,
    @ProductName VARCHAR(100),
    @Description VARCHAR(255),
    @MaxCreditLimit DECIMAL(18, 2),
    @MinCreditLimit DECIMAL(18, 2),
    @InterestRate DECIMAL(5, 2),
    @TenureMonths INT,
    @JoiningFee DECIMAL(18, 2),
    @AnnualFee DECIMAL(18, 2),
    @ContactPhone VARCHAR(15),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ccp].[CreditCardProduct]
    SET
        [ProductName] = @ProductName,
        [Description] = @Description,
        [MaxCreditLimit] = @MaxCreditLimit,
        [MinCreditLimit] = @MinCreditLimit,
        [InterestRate] = @InterestRate,
        [TenureMonths] = @TenureMonths,
        [JoiningFee] = @JoiningFee,
        [AnnualFee] = @AnnualFee,
        [ContactPhone] = @ContactPhone,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [ProductId] = @ProductId;

    SELECT
        [ProductId],
        [ProductName],
        [Description],
        [MaxCreditLimit],
        [MinCreditLimit],
        [InterestRate],
        [TenureMonths],
        [JoiningFee],
        [AnnualFee],
        [ContactPhone],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ccp].[CreditCardProduct]
    WHERE [ProductId] = @ProductId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardRepayment_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardRepayment_Create]
(
    @CardId             BIGINT,
    @BillingMonth       VARCHAR(7),
    @DueDate            DATETIME,
    @TotalDue           DECIMAL(18, 2),
    @AmountPaid         DECIMAL(18, 2),
    @PaymentDate        DATETIME,
    @LateFee            DECIMAL(18, 2),
    @InterestCharged    DECIMAL(18, 2),
    @Status             VARCHAR(50),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RepaymentId BIGINT;

    INSERT INTO [ccp].[CreditCardRepayment]
    (
        [CardId],
        [BillingMonth],
        [DueDate],
        [TotalDue],
        [AmountPaid],
        [PaymentDate],
        [LateFee],
        [InterestCharged],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @CardId,
        @BillingMonth,
        @DueDate,
        @TotalDue,
        @AmountPaid,
        @PaymentDate,
        @LateFee,
        @InterestCharged,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,
        GETDATE()
    );

    SET @RepaymentId = SCOPE_IDENTITY();

    SELECT 
        [RepaymentId],
        [CardId],
        [BillingMonth],
        [DueDate],
        [TotalDue],
        [AmountPaid],
        [PaymentDate],
        [LateFee],
        [InterestCharged],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ccp].[CreditCardRepayment]
    WHERE RepaymentId = @RepaymentId;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardRepayment_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardRepayment_Delete]
(
    @RepaymentId BIGINT,
	@ActionUser varchar(50)
)
AS 
	BEGIN
	SET NOCOUNT ON;
	UPDATE [ccp].[CreditCardRepayment]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [RepaymentId] =@RepaymentId
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardRepayment_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardRepayment_ReadAll]
AS 
BEGIN
   SET NOCOUNT ON;
   SELECT 
       [RepaymentId]
      ,[CardId]
      ,[BillingMonth]
      ,[DueDate]
      ,[TotalDue]
      ,[AmountPaid]
      ,[PaymentDate]
      ,[LateFee]
      ,[InterestCharged]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [ccp].[CreditCardRepayment]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardRepayment_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardRepayment_ReadById]
(
    @RepaymentId BIGINT
)
AS 
BEGIN
   SET NOCOUNT ON;
   SELECT 
       [RepaymentId]
      ,[CardId]
      ,[BillingMonth]
      ,[DueDate]
      ,[TotalDue]
      ,[AmountPaid]
      ,[PaymentDate]
      ,[LateFee]
      ,[InterestCharged]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [ccp].[CreditCardRepayment]
	  WHERE [RepaymentId] =@RepaymentId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardRepayment_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardRepayment_Update]
(
    @RepaymentId        BIGINT,
    @CardId             BIGINT,
    @BillingMonth       VARCHAR(7),
    @DueDate            DATETIME,
    @TotalDue           DECIMAL(18, 2),
    @AmountPaid         DECIMAL(18, 2),
    @PaymentDate        DATETIME,
    @LateFee            DECIMAL(18, 2),
    @InterestCharged    DECIMAL(18, 2),
    @Status             VARCHAR(50),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @IsActive           INT,
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ccp].[CreditCardRepayment]
    SET
        [CardId]            = @CardId,
        [BillingMonth]      = @BillingMonth,
        [DueDate]           = @DueDate,
        [TotalDue]          = @TotalDue,
        [AmountPaid]        = @AmountPaid,
        [PaymentDate]       = @PaymentDate,
        [LateFee]           = @LateFee,
        [InterestCharged]   = @InterestCharged,
        [Status]            = @Status,
        [OtherDetail1]      = @OtherDetail1,
        [OtherDetail2]      = @OtherDetail2,
        [OtherDetail3]      = @OtherDetail3,
        [OtherDetail4]      = @OtherDetail4,
        [OtherDetail5]      = @OtherDetail5,
        [OtherDetail6]      = @OtherDetail6,
        [IsActive]          = @IsActive,
        [ModifiedBy]        = @ActionUser,
        [ModifiedOn]        = GETDATE()
    WHERE [RepaymentId] = @RepaymentId;

    SELECT 
        [RepaymentId],
        [CardId],
        [BillingMonth],
        [DueDate],
        [TotalDue],
        [AmountPaid],
        [PaymentDate],
        [LateFee],
        [InterestCharged],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ccp].[CreditCardRepayment]
    WHERE [RepaymentId] = @RepaymentId
	 AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardTransaction_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardTransaction_Create]
(
    @CardID             BIGINT,
    @MerchantName       VARCHAR(16),
    @Amount             DECIMAL(18, 2),
    @TransactionDate    DATETIME,
    @Description        VARCHAR(255),
    @Type               VARCHAR(50),
    @EMI_Tenure         INT,
    @MonthlyEMIAmount   DECIMAL(18, 2),
    @RemainingEMIs      INT,
    @Status             VARCHAR(50),
    @ReferenceNo        VARCHAR(100),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TransactionId BIGINT;

    INSERT INTO [ccp].[CreditCardTransaction]
    (
        [CardID],
        [MerchantName],
        [Amount],
        [TransactionDate],
        [Description],
        [Type],
        [EMI_Tenure],
        [MonthlyEMIAmount],
        [RemainingEMIs],
        [Status],
        [ReferenceNo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @CardID,
        @MerchantName,
        @Amount,
        @TransactionDate,
        @Description,
        @Type,
        @EMI_Tenure,
        @MonthlyEMIAmount,
        @RemainingEMIs,
        @Status,
        @ReferenceNo,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @TransactionId = SCOPE_IDENTITY();

    SELECT 
       [TransactionId]
      ,[CardID]
      ,[MerchantName]
      ,[Amount]
      ,[TransactionDate]
      ,[Description]
      ,[Type]
      ,[EMI_Tenure]
      ,[MonthlyEMIAmount]
      ,[RemainingEMIs]
      ,[Status]
      ,[ReferenceNo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [ccp].[CreditCardTransaction]
    WHERE [TransactionId] = @TransactionId;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardTransaction_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardTransaction_Delete]
(
     @TransactionId BIGINT,
	 @ActionUser varchar(50)
)
AS
	BEGIN 
	SET NOCOUNT ON;
	UPDATE [ccp].[CreditCardTransaction]
	SET 
		[IsActive]  = 0,
		[IsDeleted]  =1,
		[ModifiedBy]  = @ActionUser,
		[ModifiedOn]  = GETDATE()
	WHERE [TransactionId]  = @TransactionId
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardTransaction_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardTransaction_ReadAll]
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [TransactionId]
		,[CardID]
		,[MerchantName]
		,[Amount]
		,[TransactionDate]
		,[Description]
		,[Type]
		,[EMI_Tenure]
		,[MonthlyEMIAmount]
		,[RemainingEMIs]
		,[Status]
		,[ReferenceNo]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ccp].[CreditCardTransaction]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardTransaction_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardTransaction_ReadById]
(
     @TransactionId BIGINT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [TransactionId]
		,[CardID]
		,[MerchantName]
		,[Amount]
		,[TransactionDate]
		,[Description]
		,[Type]
		,[EMI_Tenure]
		,[MonthlyEMIAmount]
		,[RemainingEMIs]
		,[Status]
		,[ReferenceNo]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ccp].[CreditCardTransaction]
	WHERE [TransactionId]  = @TransactionId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardTransaction_ReadCardID]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardTransaction_ReadCardID]
(
     @CardID BIGINT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [TransactionId]
		,[CardID]
		,[MerchantName]
		,[Amount]
		,[TransactionDate]
		,[Description]
		,[Type]
		,[EMI_Tenure]
		,[MonthlyEMIAmount]
		,[RemainingEMIs]
		,[Status]
		,[ReferenceNo]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [ccp].[CreditCardTransaction]
	WHERE [CardID]  = @CardID
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [ccp].[CreditCardTransaction_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [ccp].[CreditCardTransaction_Update]
(
    @TransactionId      BIGINT,
    @CardID             BIGINT,
    @MerchantName       VARCHAR(16),
    @Amount             DECIMAL(18, 2),
    @TransactionDate    DATETIME,
    @Description        VARCHAR(255),
    @Type               VARCHAR(50),
    @EMI_Tenure         INT,
    @MonthlyEMIAmount   DECIMAL(18, 2),
    @RemainingEMIs      INT,
    @Status             VARCHAR(50),
    @ReferenceNo        VARCHAR(100),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @IsActive           INT,
    @IsDeleted          INT,
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [ccp].[CreditCardTransaction]
    SET
        [CardID] = @CardID,
        [MerchantName] = @MerchantName,
        [Amount] = @Amount,
        [TransactionDate] = @TransactionDate,
        [Description] = @Description,
        [Type] = @Type,
        [EMI_Tenure] = @EMI_Tenure,
        [MonthlyEMIAmount] = @MonthlyEMIAmount,
        [RemainingEMIs] = @RemainingEMIs,
        [Status] = @Status,
        [ReferenceNo] = @ReferenceNo,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [IsDeleted] = @IsDeleted,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [TransactionId] = @TransactionId;

    SELECT 
        [TransactionId],
        [CardID],
        [MerchantName],
        [Amount],
        [TransactionDate],
        [Description],
        [Type],
        [EMI_Tenure],
        [MonthlyEMIAmount],
        [RemainingEMIs],
        [Status],
        [ReferenceNo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [ccp].[CreditCardTransaction]
    WHERE [TransactionId] = @TransactionId AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [dbo].[CustomHtmlMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[CustomHtmlMaster_Update]
(
    @CustomId        INT,
    @CompanyId       INT = NULL,
    @BranchId        INT = NULL,
    @TemplateId      INT = NULL,
    @MasterId        INT = NULL,
    @MasterType      VARCHAR(200) = NULL,
    @CName           VARCHAR(150) = NULL,
    @CDesc           VARCHAR(500) = NULL,
    @CHTML           NVARCHAR(MAX) = NULL,
    @CType           VARCHAR(50) = NULL,
    @CSeqNo          INT = NULL,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(100) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @IsActive        INT = NULL,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [dbo].[CustomHtmlMaster]
    SET
          [CompanyId]    = @CompanyId
        , [BranchId]     = @BranchId
        , [TemplateId]   = @TemplateId
        , [MasterId]     = @MasterId
        , [MasterType]   = TRIM(@MasterType)
        , [CName]        = TRIM(@CName)
        , [CDesc]        = TRIM(@CDesc)
        , [CHTML]        = @CHTML
        , [CType]        = TRIM(@CType)
        , [CSeqNo]       = @CSeqNo
        , [OtherDetail1] = TRIM(@OtherDetail1)
        , [OtherDetail2] = TRIM(@OtherDetail2)
        , [OtherDetail3] = TRIM(@OtherDetail3)
        , [OtherDetail4] = TRIM(@OtherDetail4)
        , [OtherDetail5] = TRIM(@OtherDetail5)
        , [OtherDetail6] = TRIM(@OtherDetail6)
        , [IsActive]     = @IsActive
        , [ModifiedBy]   = TRIM(@ActionUser)
        , [ModifiedOn]   = GETDATE()
    WHERE [CustomId] = @CustomId

    SELECT 
          [CustomId]
        , [CompanyId]
        , [BranchId]
        , [TemplateId]
        , [MasterId]
        , [MasterType]
        , [CName]
        , [CDesc]
        , [CHTML]
        , [CType]
        , [CSeqNo]
        , [OtherDetail1]
        , [OtherDetail2]
        , [OtherDetail3]
        , [OtherDetail4]
        , [OtherDetail5]
        , [OtherDetail6]
        , [IsActive]
        , [IsDeleted]
        , [CreatedBy]
        , [CreatedOn]
        , [ModifiedBy]
        , [ModifiedOn]
    FROM [dbo].[CustomHtmlMaster]
    WHERE [CustomId] = @CustomId
	      AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplate_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplate_Create]
(
    @TName VARCHAR(100),
	@TDesc VARCHAR(500),
	@ModuleName VARCHAR(50),
	@SubModuleName VARCHAR(50),
	@TBody NVARCHAR(max),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TemplateId BIGINT;

    INSERT INTO [dbo].[DocumentTemplate]
    (
        [TName],
        [TDesc],
        [ModuleName],
        [SubModuleName],
        [TBody],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @TName,
        @TDesc,
        @ModuleName,
        @SubModuleName,
        @TBody,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
         1,
         0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @TemplateId = SCOPE_IDENTITY();

    SELECT 
	   [TemplateId]
      ,[TName]
      ,[TDesc]
      ,[ModuleName]
      ,[SubModuleName]
      ,[TBody]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [dbo].[DocumentTemplate]
    WHERE [TemplateId] = @TemplateId;
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplate_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplate_Delete]
(
   @TemplateId BIGINT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [dbo].[DocumentTemplate]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [TemplateId] = @TemplateId
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplate_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplate_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [TemplateId]
      ,[TName]
      ,[TDesc]
      ,[ModuleName]
      ,[SubModuleName]
      ,[TBody]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [dbo].[DocumentTemplate]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplate_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplate_ReadById]
(
   @TemplateId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [TemplateId]
      ,[TName]
      ,[TDesc]
      ,[ModuleName]
      ,[SubModuleName]
      ,[TBody]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [dbo].[DocumentTemplate]
	  WHERE [TemplateId] = @TemplateId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplate_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplate_Update]
(
    @TemplateId BIGINT, 
	@TName VARCHAR(100),
	@TDesc VARCHAR(500),
	@ModuleName VARCHAR(50),
	@SubModuleName VARCHAR(50),
	@TBody NVARCHAR(max),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [dbo].[DocumentTemplate]
    SET
        [TName] = @TName,
        [TDesc] = @TDesc,
        [ModuleName] = @ModuleName,
        [SubModuleName] = @SubModuleName,
        [TBody] = @TBody,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [TemplateId] = @TemplateId;

    SELECT 
        [TemplateId],
        [TName],
        [TDesc],
        [ModuleName],
        [SubModuleName],
        [TBody],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [dbo].[DocumentTemplate]
    WHERE [TemplateId] = @TemplateId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplateVariables_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplateVariables_Create]
(
    @TemplateId INT,
	@VarInstance VARCHAR(100),
	@VarValue VARCHAR(100),
	@VarType VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @VariableId BIGINT;

    INSERT INTO [dbo].[DocumentTemplateVariables]
    (
        [TemplateId],
        [VarInstance],
        [VarValue],
        [VarType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @TemplateId,
        @VarInstance,
        @VarValue,
        @VarType,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
         1,
         0,
        @ActionUser,
        GETDATE()
    );

    SET @VariableId = SCOPE_IDENTITY();

    SELECT 
	   [VariableId]
      ,[TemplateId]
      ,[VarInstance]
      ,[VarValue]
      ,[VarType]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [dbo].[DocumentTemplateVariables]
    WHERE [VariableId] = @VariableId;
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplateVariables_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplateVariables_Delete]
(
   @VariableId BIGINT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [dbo].[DocumentTemplateVariables]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [VariableId] = @VariableId
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplateVariables_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplateVariables_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [VariableId]
      ,[TemplateId]
      ,[VarInstance]
      ,[VarValue]
      ,[VarType]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [dbo].[DocumentTemplateVariables]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplateVariables_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplateVariables_ReadById]
(
   @VariableId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [VariableId]
      ,[TemplateId]
      ,[VarInstance]
      ,[VarValue]
      ,[VarType]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [dbo].[DocumentTemplateVariables]
	  WHERE [VariableId] = @VariableId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplateVariables_ReadByTemplateId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplateVariables_ReadByTemplateId]
(
    @TemplateId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [VariableId]
      ,[TemplateId]
      ,[VarInstance]
      ,[VarValue]
      ,[VarType]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [dbo].[DocumentTemplateVariables]
	  WHERE [TemplateId] = @TemplateId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [dbo].[DocumentTemplateVariables_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[DocumentTemplateVariables_Update]
(
    @VariableId BIGINT,
	@TemplateId INT,
	@VarInstance VARCHAR(100),
	@VarValue VARCHAR(100),
	@VarType VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [dbo].[DocumentTemplateVariables]
    SET
        [TemplateId] = @TemplateId,
        [VarInstance] = @VarInstance,
        [VarValue] = @VarValue,
        [VarType] = @VarType,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [VariableId] = @VariableId;

    SELECT 
        [VariableId],
        [TemplateId],
        [VarInstance],
        [VarValue],
        [VarType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [dbo].[DocumentTemplateVariables]
    WHERE [VariableId] = @VariableId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplates_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[EmailTemplates_Create]
(
    @TName                    VARCHAR(100),
    @TDesc                    VARCHAR(500),
    @ModuleName               VARCHAR(50),
    @SubModuleName            VARCHAR(50),
	@DBConnId                 INT,
    @DataSourceType           VARCHAR(30),
    @DataSourceDefination     VARCHAR(4000),
    @PostDataSourceType       VARCHAR(30),
    @PostDataSourceDefination NVARCHAR(4000),
    @EmailTO                  VARCHAR(1000),
    @CCTo                     VARCHAR(1000),
    @BccTo                    NVARCHAR(MAX),
    @ASubject                 VARCHAR(1000),
    @ABody                    NVARCHAR(MAX),
    @EmailConfigId            INT,
    @OtherDetail1             VARCHAR(50),
    @OtherDetail2             VARCHAR(50),
    @OtherDetail3             VARCHAR(100),
    @OtherDetail4             VARCHAR(100),
    @OtherDetail5             VARCHAR(500),
    @OtherDetail6             VARCHAR(500),
    @ActionUser               VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TemplateId INT;

    INSERT INTO [dbo].[EmailTemplates]
    (
        [TName],
        [TDesc],
        [ModuleName],
        [SubModuleName],
		[DBConnId],
        [DataSourceType],
        [DataSourceDefination],
        [PostDataSourceType],
        [PostDataSourceDefination],
        [EmailTO],
        [CCTo],
        [BccTo],
        [ASubject],
        [ABody],
        [EmailConfigId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
(
        @TName,
        @TDesc,
        @ModuleName,
        @SubModuleName,
		@DBConnId,
        @DataSourceType,
        @DataSourceDefination,
        @PostDataSourceType,
        @PostDataSourceDefination,
        @EmailTO,
        @CCTo,
        @BccTo,
        @ASubject,
        @ABody,
        @EmailConfigId,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,                 
        0,                 
        @ActionUser,
        GETDATE()
    );

    SET @TemplateId = SCOPE_IDENTITY();

    SELECT
        [TemplateId],
        [TName],
        [TDesc],
        [ModuleName],
        [SubModuleName],
		[DBConnId],
        [DataSourceType],
        [DataSourceDefination],
        [PostDataSourceType],
        [PostDataSourceDefination],
        [EmailTO],
        [CCTo],
        [BccTo],
        [ASubject],
        [ABody],
        [EmailConfigId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [dbo].[EmailTemplates]
    WHERE [TemplateId] = @TemplateId;
END
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplates_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EmailTemplates_Delete]
(
  @TemplateId INT,
  @ActionUser VARCHAR(50)
)
AS
 BEGIN 
  SET NOCOUNT ON;
   UPDATE[dbo].[EmailTemplates]
   SET
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [TemplateId] = @TemplateId
END;
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplates_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EmailTemplates_ReadAll]
AS
 BEGIN 
  SET NOCOUNT ON;
 	SELECT 
		 [TemplateId]
		,[TName]
		,[TDesc]
		,[ModuleName]
		,[SubModuleName]
		,[DataSourceType]
		,[DataSourceDefination]
		,[PostDataSourceType]
		,[PostDataSourceDefination]
		,[EmailTO]
		,[CCTo]
		,[BccTo]
		,[ASubject]
		,[ABody]
		,[EmailConfigId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[DBConnId]
	FROM [dbo].[EmailTemplates]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplates_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EmailTemplates_ReadById]
(
  @TemplateId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
 	SELECT 
		 [TemplateId]
		,[TName]
		,[TDesc]
		,[ModuleName]
		,[SubModuleName]
		,[DataSourceType]
		,[DataSourceDefination]
		,[PostDataSourceType]
		,[PostDataSourceDefination]
		,[EmailTO]
		,[CCTo]
		,[BccTo]
		,[ASubject]
		,[ABody]
		,[EmailConfigId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[DBConnId]
	FROM [dbo].[EmailTemplates]
	WHERE [TemplateId] =@TemplateId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplates_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[EmailTemplates_Update]
(
    @TemplateId              INT,
    @TName                   VARCHAR(100),
    @TDesc                   VARCHAR(500),
    @ModuleName              VARCHAR(50),
    @SubModuleName           VARCHAR(50),
    @DataSourceType          VARCHAR(30),
    @DataSourceDefination    VARCHAR(4000),
    @PostDataSourceType      VARCHAR(30),
    @PostDataSourceDefination NVARCHAR(4000),
    @EmailTO                 VARCHAR(1000),
    @CCTo                    VARCHAR(1000),
    @BccTo                   NVARCHAR(MAX),
    @ASubject                VARCHAR(1000),
    @ABody                   NVARCHAR(MAX),
    @EmailConfigId           INT,
    @OtherDetail1            VARCHAR(50),
    @OtherDetail2            VARCHAR(50),
    @OtherDetail3            VARCHAR(100),
    @OtherDetail4            VARCHAR(100),
    @OtherDetail5            VARCHAR(500),
    @OtherDetail6            VARCHAR(500),
	@IsActive				 INT,
    @ActionUser              VARCHAR(50),
	@DBConnId				 INT
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [dbo].[EmailTemplates]
    SET
        [TName]                    = @TName,
        [TDesc]                    = @TDesc,
        [ModuleName]               = @ModuleName,
        [SubModuleName]            = @SubModuleName,
        [DataSourceType]           = @DataSourceType,
        [DataSourceDefination]     = @DataSourceDefination,
        [PostDataSourceType]       = @PostDataSourceType,
        [PostDataSourceDefination] = @PostDataSourceDefination,
        [EmailTO]                  = @EmailTO,
        [CCTo]                     = @CCTo,
        [BccTo]                    = @BccTo,
        [ASubject]                 = @ASubject,
        [ABody]                    = @ABody,
        [EmailConfigId]            = @EmailConfigId,
        [OtherDetail1]             = @OtherDetail1,
        [OtherDetail2]             = @OtherDetail2,
        [OtherDetail3]             = @OtherDetail3,
        [OtherDetail4]             = @OtherDetail4,
        [OtherDetail5]             = @OtherDetail5,
        [OtherDetail6]             = @OtherDetail6,
		[IsActive]                 = @IsActive,
        [ModifiedBy]               = @ActionUser,
        [ModifiedOn]               = GETDATE(),
		[DBConnId]				   = @DBConnId
    WHERE [TemplateId] = @TemplateId
  

    SELECT
        [TemplateId],
        [TName],
        [TDesc],
        [ModuleName],
        [SubModuleName],
        [DataSourceType],
        [DataSourceDefination],
        [PostDataSourceType],
        [PostDataSourceDefination],
        [EmailTO],
        [CCTo],
        [BccTo],
        [ASubject],
        [ABody],
        [EmailConfigId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn],
		[DBConnId]
    FROM [dbo].[EmailTemplates]
    WHERE [TemplateId] = @TemplateId
	   AND [IsActive] = 1
      AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplateVariables_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[EmailTemplateVariables_Create]
(
    @TemplateId     INT,
    @VarInstance    VARCHAR(100),
    @VarValue       VARCHAR(100),
    @VarType        VARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @VariableId BIGINT;

    INSERT INTO [dbo].[EmailTemplateVariables]
    (
        [TemplateId],
        [VarInstance],
        [VarValue],
        [VarType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @TemplateId,
        @VarInstance,
        @VarValue,
        @VarType,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,               
        0,               
        @ActionUser,
        GETDATE()
    );

    SET @VariableId = SCOPE_IDENTITY();

    SELECT
        [VariableId],
        [TemplateId],
        [VarInstance],
        [VarValue],
        [VarType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [dbo].[EmailTemplateVariables]
    WHERE [VariableId] = @VariableId;
END
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplateVariables_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EmailTemplateVariables_Delete]
(
    @VariableId BIGINT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN 
	SET NOCOUNT ON;
	UPDATE [dbo].[EmailTemplateVariables]
	SET 
		 [IsActive] = 0,
		 [IsDeleted] = 1,
		 [ModifiedBy] = @ActionUser,
		 [ModifiedOn] = GETDATE()
	WHERE [VariableId] = @VariableId
END
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplateVariables_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EmailTemplateVariables_ReadAll]
AS
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [VariableId]
		,[TemplateId]
		,[VarInstance]
		,[VarValue]
		,[VarType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [dbo].[EmailTemplateVariables]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplateVariables_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EmailTemplateVariables_ReadById]
(
    @VariableId BIGINT
)
AS
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [VariableId]
		,[TemplateId]
		,[VarInstance]
		,[VarValue]
		,[VarType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [dbo].[EmailTemplateVariables]
	WHERE [VariableId] = @VariableId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplateVariables_ReadByTemplateId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EmailTemplateVariables_ReadByTemplateId]
(
    @TemplateId INT
)
AS
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [VariableId]
		,[TemplateId]
		,[VarInstance]
		,[VarValue]
		,[VarType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [dbo].[EmailTemplateVariables]
	WHERE [TemplateId] = @TemplateId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [dbo].[EmailTemplateVariables_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[EmailTemplateVariables_Update]
(
    @VariableId     BIGINT,
    @TemplateId     INT,
    @VarInstance    VARCHAR(100),
    @VarValue       VARCHAR(100),
    @VarType        VARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
	@IsActive		INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [dbo].[EmailTemplateVariables]
    SET
        [TemplateId]    = @TemplateId,
        [VarInstance]   = @VarInstance,
        [VarValue]      = @VarValue,
        [VarType]       = @VarType,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
		[IsActive]		=@IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [VariableId] = @VariableId

    SELECT
        [VariableId],
        [TemplateId],
        [VarInstance],
        [VarValue],
        [VarType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [dbo].[EmailTemplateVariables]
    WHERE [VariableId] = @VariableId
	        AND [IsActive] = 1
            AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [dbo].[GenerateTestAdmissionNo]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[GenerateTestAdmissionNo]
AS
BEGIN
    DECLARE @Prefix NVARCHAR(20) = 'ADM';
    DECLARE @AcademicYear VARCHAR(9) = '2025';
    DECLARE @Separator CHAR(1) = '/';
    DECLARE @SerialLength INT = 4;
    DECLARE @CurrentSerial INT = 10; -- For testing

    DECLARE @SerialPart NVARCHAR(20);

    -- Pad the serial number with leading zeros
    SET @SerialPart = RIGHT(REPLICATE('0', @SerialLength) + CAST(@CurrentSerial AS VARCHAR), @SerialLength);

    DECLARE @AdmissionNo NVARCHAR(50);

    SET @AdmissionNo = @Prefix + @Separator + @AcademicYear + @Separator + @SerialPart;

    SELECT @AdmissionNo AS AdmissionNo;
END
GO
/****** Object:  StoredProcedure [dbo].[MenuFeature_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[MenuFeature_Create]
(
    @SoftwareId INT,
    @MenuId INT,
    @FName VARCHAR(50),
    @FCode VARCHAR(20),
    @FDescription VARCHAR(500),                
    @ActionUser VARCHAR(50)
)
AS
BEGIN

	DECLARE @FeatureId INT  = 0;
	IF NOT EXISTS(SELECT 1 FROM dbo.MenuFeature WHERE FCode = @FCode)
	BEGIN
		INSERT INTO dbo.MenuFeature
		(
		 MenuId,  FName,  FCode,  FDescription,  IsActive,  IsDeleted,  CreatedBy,  CreatedOn
		)
		VALUES
		(
			 @MenuId, @FName, @FCode, @FDescription, 1, 0, @ActionUser, GETDATE() 
		);

		SELECT @FeatureId = SCOPE_IDENTITY();

		SELECT [FeatureId]
		,[MenuId]
		,[FName]
		,[FCode]
		,[FDescription]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		FROM [dbo].[MenuFeature]
		WHERE [FeatureId] = @FeatureId
	END
	ELSE
	BEGIN
		RAISERROR('FCode already exists, please use a unique FCode!',16,1);
	END
END;
GO
/****** Object:  StoredProcedure [dbo].[MenuFeature_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[MenuFeature_Delete]
(
    @FeatureId INT,
    @ActionUser VARCHAR(50)          
)
AS
BEGIN

    UPDATE dbo.MenuFeature
    SET IsActive = 0,
	    IsDeleted = 1,
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()        
    WHERE FeatureId = @FeatureId;       
END;
GO
/****** Object:  StoredProcedure [dbo].[MenuFeature_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[MenuFeature_ReadAll]
AS
BEGIN

    SELECT 
        FeatureId,
        MenuId,
        FName,
        FCode,
        FDescription,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM dbo.MenuFeature
    WHERE [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[MenuFeature_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[MenuFeature_ReadById]
(
    @FeatureId INT          
)
AS
BEGIN

    SELECT 
        FeatureId,
        MenuId,
        FName,
        FCode,
        FDescription,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM dbo.MenuFeature
    WHERE FeatureId = @FeatureId
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[MenuFeature_ReadByMenuId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[MenuFeature_ReadByMenuId]
(
    @MenuId INT          
)
AS
BEGIN

    SELECT 
        A.FeatureId,
        A.MenuId,
        A.FName,
        A.FCode,
        A.FDescription,
        A.IsActive,
        A.IsDeleted,
        CASE WHEN B.UserId IS NULL THEN A.CreatedBy 
	    ELSE (ISNULL(B.FirstName + ' ','') + ISNULL(B.LastName,''))		   
	    END AS CreatedBy,
        A.CreatedOn,
        A.ModifiedBy,
        A.ModifiedOn
    FROM dbo.MenuFeature A
	LEFT OUTER JOIN dbo.UserMaster B WITH (NOLOCK)
	ON A.CreatedBy = CONVERT(VARCHAR(50),B.UserId)
    WHERE A.MenuId = @MenuId
	AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[MenuFeature_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[MenuFeature_Update]
(
    @FeatureId INT,                 
    @MenuId INT,
    @FName VARCHAR(50),
    @FCode VARCHAR(20),
    @FDescription VARCHAR(500),
    @IsActive INT,
    @ActionUser VARCHAR(50)          
)
AS
BEGIN

    UPDATE dbo.MenuFeature
    SET
        MenuId = @MenuId,
        FName = @FName,
        FCode = @FCode,
        FDescription = @FDescription,
        IsActive = @IsActive,
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()        
    WHERE FeatureId = @FeatureId;       


    SELECT 
        FeatureId,
        MenuId,
        FName,
        FCode,
        FDescription,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM dbo.MenuFeature
    WHERE FeatureId = @FeatureId;
END;
GO
/****** Object:  StoredProcedure [dbo].[MenuMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*


EXEC [dbo].[MenuMaster_Create]
    @MenuName = 'Reports',
    @MenuCode = 'REP001',
    @MenuDesc = 'Reports and analytics section.',
    @DisplayOrder = 1,
    @ParentMenuId = 0, -- No parent
    @DefaultChildMenuId = 0,
    @MenuIconUrl = '/icons/reports.png',
    @TemplatePath = '/reports',
    @ActionUser = '4';

*/
CREATE   PROCEDURE [dbo].[MenuMaster_Create]
(

	@MenuName VARCHAR(50),
	@MenuCode VARCHAR(50),
	@MenuDesc VARCHAR(500),
	@DisplayOrder INT,
	@ParentMenuId INT,
	@DefaultChildMenuId INT,
	@MenuIconUrl VARCHAR(500),
	@TemplatePath VARCHAR(500),
	@ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON; 

	DECLARE @MenuId INT = 0;

	IF NOT EXISTS(SELECT 1 FROM MenuMaster WHERE MenuName = @MenuName  AND ParentMenuId = @ParentMenuId AND IsDeleted = 0) AND LTRIM(RTRIM(ISNULL(@MenuName, ''))) <> '' AND LTRIM(RTRIM(ISNULL(@MenuCode, ''))) <> '' 
	BEGIN

		INSERT INTO [dbo].[MenuMaster] 
			(
	
				MenuName,
				MenuCode, 
				MenuDesc,
				DisplayOrder,
				ParentMenuId,
				DefaultChildMenuId, 
				MenuIconUrl,
				TemplatePath, 
				IsActive,
				IsDeleted, 
			    CreatedBy,
				CreatedOn
			)
		VALUES 
			(
				@MenuName,
				@MenuCode,
				@MenuDesc,
				@DisplayOrder,
				@ParentMenuId,
				@DefaultChildMenuId,
				@MenuIconUrl,
				@TemplatePath,
				1,
				0,
				@ActionUser,
				GETDATE()
			);

		SELECT @MenuId = SCOPE_IDENTITY();

		SELECT 
			 [MenuId]
			,[MenuName]
			,[MenuCode]
			,[MenuDesc]
			,[DisplayOrder]
			,[ParentMenuId]
			,[DefaultChildMenuId]
			,[MenuIconUrl]
			,[TemplatePath]
			,[IsActive]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
			,[IsDeleted]
		FROM [dbo].[MenuMaster]
		WHERE MenuId = @MenuId

	END
	ELSE
	BEGIN
		RAISERROR ('Menu already exists.', 16, 1);
		RETURN;
	END
END;
  
GO
/****** Object:  StoredProcedure [dbo].[MenuMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[MenuMaster_Delete]
(
	@MenuId INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN

	UPDATE [dbo].[MenuMaster]
	SET IsActive = 0,
	    IsDeleted = 1,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE MenuId = @MenuId

END
GO
/****** Object:  StoredProcedure [dbo].[MenuMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[MenuMaster_ReadAll]
(
	@CompanyId INT = NULL,      
	@BranchId INT = NULL,       
	@SoftwareId INT = NULL
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [MenuId]
		,[MenuName]
		,[MenuCode]
		,[MenuDesc]
		,[DisplayOrder]
		,[ParentMenuId]
		,[DefaultChildMenuId]
		,[MenuIconUrl]
		,[TemplatePath]
		,[IsActive]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[IsDeleted]
	FROM [dbo].[MenuMaster]
	WHERE [IsActive] = 1 
END;
GO
/****** Object:  StoredProcedure [dbo].[MenuMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[MenuMaster_ReadById]
(
	@MenuId INT

)
AS
BEGIN

	SELECT 
	     [MenuId]
		,[MenuName]
		,[MenuCode]
		,[MenuDesc]
		,[DisplayOrder]
		,[ParentMenuId]
		,[DefaultChildMenuId]
		,[MenuIconUrl]
		,[TemplatePath]
		,[IsActive]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[IsDeleted]
	FROM [dbo].[MenuMaster]
	WHERE [IsDeleted] = 0 AND MenuId = @MenuId

END
GO
/****** Object:  StoredProcedure [dbo].[MenuMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[MenuMaster_Update]
(
	@MenuId INT,
	@MenuName VARCHAR(50),
	@MenuCode VARCHAR(50),
	@MenuDesc VARCHAR(500),
	@DisplayOrder INT,
	@ParentMenuId BIGINT,
	@DefaultChildMenuId BIGINT,
	@MenuIconUrl VARCHAR(500),
	@TemplatePath VARCHAR(500),
	@IsActive INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN

	UPDATE [dbo].[MenuMaster]
	SET 
	    MenuName = @MenuName,
		MenuCode = @MenuCode,
		MenuDesc = @MenuDesc,
		DisplayOrder = @DisplayOrder,
		ParentMenuId = @ParentMenuId,
		DefaultChildMenuId = @DefaultChildMenuId,
		MenuIconUrl = @MenuIconUrl,
		TemplatePath = @TemplatePath,
		IsActive = @IsActive,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE MenuId = @MenuId

	SELECT 
	     [MenuId]
		,[MenuName]
		,[MenuCode]
		,[MenuDesc]
		,[DisplayOrder]
		,[ParentMenuId]
		,[DefaultChildMenuId]
		,[MenuIconUrl]
		,[TemplatePath]
		,[IsActive]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[IsDeleted]
	FROM [dbo].[MenuMaster]
	WHERE MenuId = @MenuId

END
GO
/****** Object:  StoredProcedure [dbo].[OPCalendar_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [dbo].[OPCalendar_Create]
(
      @Date DATE,
      @Year INT,
      @Month INT,
      @Day INT,
      @DayName VARCHAR(50),
      @WorkingDayOfYear INT,
      @IsWorkingDay INT,
      @IsWeekend INT,
      @IsHoliday INT,
      @Description VARCHAR(50),
      @ActionUser varchar(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
       DECLARE  @CompanyId INT ;

       INSERT INTO [dbo].[OPCalendar]
			(
			Date ,
			Year ,
			Month ,
			Day ,
			DayName ,
			WorkingDayOfYear ,
			IsWorkingDay ,
			IsWeekend ,
			IsHoliday ,
			Description ,
			IsActive ,
			IsDeleted  ,
			CreatedBy ,
			CreatedOn 

			)
       VALUES 
			(
			@Date ,
			@Year ,
			@Month ,
			@Day ,
			@DayName ,
			@WorkingDayOfYear ,
			@IsWorkingDay ,
			@IsWeekend ,
			@IsHoliday ,
			@Description ,
			1, 
			0, 
			@ActionUser,
			GETDATE()
			)
     SET @CompanyId= SCOPE_IDENTITY();

        SELECT 
			 [CompanyId]
			,[Date]
			,[Year]
			,[Month]
			,[Day]
			,[DayName]
			,[WorkingDayOfYear]
			,[IsWorkingDay]
			,[IsWeekend]
			,[IsHoliday]
			,[Description]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
      FROM [dbo].[OPCalendar]
     WHERE CompanyId=@CompanyId;
END;
  
 
GO
/****** Object:  StoredProcedure [dbo].[OPCalendar_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[OPCalendar_Delete]
(
    @CompanyId INT, 
    @ActionUser VARCHAR(50)
)
AS
BEGIN 
    SET NOCOUNT ON;

    UPDATE [dbo].[OPCalendar]
    SET 
        [IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [CompanyId] = @CompanyId;  

END;
GO
/****** Object:  StoredProcedure [dbo].[OPCalendar_GetMonthlyCalendarByCompany]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[OPCalendar_GetMonthlyCalendarByCompany]
(
    @CompanyId INT,
    @Year INT,
    @Month INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        CompanyId,
        [Date],
        [Year],
        [Month],
        [Day],
        [DayName],
        [WorkingDayOfYear],
        [IsWorkingDay],
        [IsWeekend],
        [IsHoliday],
        [Description],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [AdvinMaster].[dbo].[OPCalendar]
    WHERE 
        CompanyId = @CompanyId 
        AND [Year] = @Year
        AND [Month] = @Month
    ORDER BY [Date];
END




GO
/****** Object:  StoredProcedure [dbo].[OPCalendar_GetYearlyWeekendAndHolidayListByCompany]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[OPCalendar_GetYearlyWeekendAndHolidayListByCompany]
(
    @CompanyId INT,
    @Year INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        CompanyId,
        [Date],
        [Year],
        [Month],
        [Day],
        [DayName],
        [WorkingDayOfYear],
        [IsWorkingDay],
        [IsWeekend],
        [IsHoliday],
        ISNULL(Description,'') Description,
        [IsActive],
        [IsDeleted]
    FROM [AdvinMaster].[dbo].[OPCalendar]
    WHERE 
        CompanyId = @CompanyId
        AND [Year] = @Year
		AND [IsDeleted] = 0
		AND ([IsWorkingDay] = 0 AND [IsWeekend] = 1)
		OR [IsHoliday] = 1
    ORDER BY [Date];
END
GO
/****** Object:  StoredProcedure [dbo].[OPCalendar_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[OPCalendar_ReadAll]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
       [CompanyId]
      ,[Date]
      ,[Year]
      ,[Month]
      ,[Day]
      ,[DayName]
      ,[WorkingDayOfYear]
      ,[IsWorkingDay]
      ,[IsWeekend]
      ,[IsHoliday]
      ,[Description]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [dbo].[OPCalendar]
    WHERE [IsDeleted] = 0;

END;
GO
/****** Object:  StoredProcedure [dbo].[OPCalendar_ReadByCompanyId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[OPCalendar_ReadByCompanyId]
(
    @CompanyId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
       [CompanyId]
      ,[Date]
      ,[Year]
      ,[Month]
      ,[Day]
      ,[DayName]
      ,[WorkingDayOfYear]
      ,[IsWorkingDay]
      ,[IsWeekend]
      ,[IsHoliday]
      ,[Description]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [dbo].[OPCalendar]
    WHERE [CompanyId] = @CompanyId
    AND [IsDeleted] = 0;

END;
GO
/****** Object:  StoredProcedure [dbo].[OPCalendar_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[OPCalendar_Update]
(
      @CompanyId INT,  
      @Date DATE,
      @Year INT,
      @Month INT,
      @Day INT,
      @DayName VARCHAR(50),
      @WorkingDayOfYear INT,
      @IsWorkingDay INT,
      @IsWeekend INT,
      @IsHoliday INT,
      @Description VARCHAR(50),
      @ActionUser VARCHAR(50)
)
AS
BEGIN  
    SET NOCOUNT ON;

    UPDATE [dbo].[OPCalendar]
    SET 
        [Date] = @Date,
        [Year] = @Year,
        [Month] = @Month,
        [Day] = @Day,
        [DayName] = @DayName,
        [WorkingDayOfYear] = @WorkingDayOfYear,
        [IsWorkingDay] = @IsWorkingDay,
        [IsWeekend] = @IsWeekend,
        [IsHoliday] = @IsHoliday,
        [Description] = @Description,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [CompanyId] = @CompanyId;

    SELECT 
        [CompanyId],
        [Date],
        [Year],
        [Month],
        [Day],
        [DayName],
        [WorkingDayOfYear],
        [IsWorkingDay],
        [IsWeekend],
        [IsHoliday],
        [Description],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [dbo].[OPCalendar]
    WHERE [CompanyId] = @CompanyId;
END;
GO
/****** Object:  StoredProcedure [dbo].[Roles_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*


EXEC [dbo].[Roles_Create]
    @RoleName = 'Administrator',
    @RoleCode = 'ADMIN001',
    @RoleDesc = 'Role for full administrative access',
    @GroupName = 'AdminGroup',
    @ActionUser = '4';


*/
CREATE   PROCEDURE [dbo].[Roles_Create]
(
	@RoleName VARCHAR(100),
	@RoleCode VARCHAR(50),
	@RoleDesc VARCHAR(500),
	@GroupName VARCHAR(200),
	@ActionUser VARCHAR(50)
)
AS
BEGIN
       SET NOCOUNT ON;

	DECLARE @RoleId INT = 0;

		INSERT INTO [dbo].[Roles] 
		( RoleName, RoleCode, RoleDesc, GroupName, IsActive, CreatedBy, CreatedOn,IsDeleted)
		VALUES 
		( @RoleName, @RoleCode, @RoleDesc, @GroupName, 1, @ActionUser, GETDATE(),0);

		SELECT @RoleId = SCOPE_IDENTITY(); 
		SELECT 
			   [RoleId]
			  ,[RoleName]
			  ,[RoleCode]
			  ,[RoleDesc]
			  ,[GroupName]
			  ,[IsActive]
			  ,[CreatedBy]
			  ,[CreatedOn]
			  ,[ModifiedBy]
			  ,[ModifiedOn]
			  ,[IsDeleted]
		FROM [dbo].[Roles]
		WHERE RoleId = @RoleId	
END
GO
/****** Object:  StoredProcedure [dbo].[Roles_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[Roles_Delete]
(
	@RoleId INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	UPDATE Roles
	SET IsActive = 0,
	    IsDeleted = 1,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE RoleId = @RoleId;
END
GO
/****** Object:  StoredProcedure [dbo].[Roles_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
	EXEC [dbo].[Roles_ReadAllPaginated] @PageSize = 10, @PageNo = 1, @whereClause = N'AND RoleName LIKE ''%Admin%''', @OrderByClause = N'RoleName DESC'
*/
CREATE   PROCEDURE [dbo].[Roles_ReadAllPaginated]
(
    @PageSize INT,
	@PageNo INT,
	@whereClause NVARCHAR(MAX) = NULL,
    @OrderByClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
	DECLARE @Sql NVARCHAR(MAX) = N'';
	DECLARE @Offset NVARCHAR(20) = CONVERT(NVARCHAR(20), ((@PageNo - 1) * @PageSize));

	-- Default order by clause if not provided
	IF @OrderByClause IS NULL OR LTRIM(RTRIM(@OrderByClause)) = ''
		SET @OrderByClause = N'A.RoleName ASC';

	-- Start building SQL
	SET @Sql = N'
	DECLARE @TotalCount INT = 0;
	SELECT @TotalCount = COUNT(*) 
	FROM dbo.Roles WITH (NOLOCK)
	WHERE IsDeleted = 0 AND IsActive = 1';

	-- Add dynamic where clause if provided
	IF @whereClause IS NOT NULL AND LTRIM(RTRIM(@whereClause)) <> ''
		SET @Sql = @Sql + N' ' + @whereClause;

	-- Main query
	SET @Sql = @Sql + N';

	SELECT 
		ROW_NUMBER() OVER (ORDER BY ' + @OrderByClause + N') AS RowNum,
		A.RoleId,
		A.RoleName,
		A.RoleCode,
		A.RoleDesc,
		A.GroupName,
		A.IsActive,
		A.IsDeleted,
		CASE 
			WHEN B.UserId IS NULL THEN A.CreatedBy
			ELSE ISNULL(B.FirstName + '' '','''') + ISNULL(B.LastName, '''') 
		END AS CreatedBy,
		A.CreatedOn,
		A.ModifiedBy,
		A.ModifiedOn,
		@TotalCount AS TotalCount,
		' + CONVERT(NVARCHAR(20), @PageSize) + ' AS PageSize,
		' + CONVERT(NVARCHAR(20), @PageNo) + ' AS PageNo
	FROM dbo.Roles A WITH (NOLOCK)
	LEFT JOIN [AdvinMaster].dbo.UserMaster B WITH (NOLOCK)
		ON A.CreatedBy = CONVERT(VARCHAR(50), B.UserId)
	WHERE A.IsDeleted = 0 AND A.IsActive = 1';

	-- Add dynamic where clause again for main query
	IF @whereClause IS NOT NULL AND LTRIM(RTRIM(@whereClause)) <> ''
		SET @Sql = @Sql + N' ' + @whereClause;

	-- Add pagination
	SET @Sql = @Sql + N'
	ORDER BY ' + @OrderByClause + N'
	OFFSET ' + @Offset + ' ROWS
	FETCH NEXT ' + CONVERT(NVARCHAR(20), @PageSize) + ' ROWS ONLY;';



	EXEC(@Sql);
END
GO
/****** Object:  StoredProcedure [dbo].[Roles_ReadByActionUser]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [dbo].[Roles_ReadByActionUser]
    @GroupName = 'School',  
    @ActionUser = '1';                

*/

CREATE   PROCEDURE [dbo].[Roles_ReadByActionUser]
(
    @GroupName   VARCHAR(200),
    @ActionUser  VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RoleId   INT;
    DECLARE @Priority INT;

    -- Step 1: Get RoleId for the given ActionUser
    SELECT TOP 1 @RoleId = A.RoleId
    FROM dbo.UserRoles AS A
    WHERE A.UserId = @ActionUser
      AND A.IsActive = 1
      AND A.IsDeleted = 0;

    -- Step 2: Get Priority of that RoleId
    SELECT TOP 1 @Priority = B.Priority
    FROM dbo.Roles AS B
    WHERE B.RoleId = @RoleId
      AND B.IsActive = 1
      AND B.IsDeleted = 0;

    -- Step 3: Return Roles with Priority >= current Role within the same group
    SELECT
        C.RoleId,
        C.RoleName,
        C.RoleCode,
        C.RoleDesc,
        C.IsActive,
        C.CreatedBy,
        C.CreatedOn,
        C.ModifiedBy,
        C.ModifiedOn,
        C.IsDeleted,
        C.GroupName,
        C.Priority
    FROM dbo.Roles AS C
    WHERE C.IsActive = 1
      AND C.IsDeleted = 0
      AND C.GroupName = @GroupName
      AND C.Priority >= @Priority
    ORDER BY C.Priority;
END;
GO
/****** Object:  StoredProcedure [dbo].[Roles_ReadByGroupName]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[Roles_ReadByGroupName]
(
	@GroupName VARCHAR(200)
)
AS
BEGIN

	SELECT 
		A.RoleId,
		A.RoleName,
		A.RoleCode,
		A.RoleDesc,
		A.GroupName,
		A.IsActive,
		A.IsDeleted,
		CASE WHEN B.UserId IS NULL THEN A.CreatedBy 
		ELSE (ISNULL(B.FirstName + ' ','') + ISNULL(B.LastName,''))		   
		END AS CreatedBy,
		A.CreatedOn,
		A.ModifiedBy,
		A.ModifiedOn
	FROM dbo.Roles A WITH (NOLOCK)
	LEFT OUTER JOIN [Nishwik].dbo.UserMaster B WITH (NOLOCK)
	ON A.CreatedBy = CONVERT(VARCHAR(50),B.UserId)
	WHERE A.[IsDeleted] = 0 AND A.GroupName = @GroupName

END
GO
/****** Object:  StoredProcedure [dbo].[Roles_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[Roles_Update]
(
	@RoleId INT,
	@RoleName VARCHAR(100),
	@RoleCode VARCHAR(50),
	@RoleDesc VARCHAR(500),
	@GroupName VARCHAR(200),
	@IsActive INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	UPDATE Roles
	SET
		RoleName = @RoleName,
		RoleCode = @RoleCode,
		RoleDesc = @RoleDesc,
		GroupName = @GroupName,
		IsActive = @IsActive,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE RoleId = @RoleId;

	SELECT 
	   [RoleId]
      ,[RoleName]
      ,[RoleCode]
      ,[RoleDesc]
	  ,[GroupName]
      ,[IsActive]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[IsDeleted]
	FROM [dbo].[Roles]
	WHERE RoleId = @RoleId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_BackupLog_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_BackupLog_Create]
    @BackupType NVARCHAR(50),
    @TotalRecords INT,
    @BackupFilePath NVARCHAR(500),
    @Status NVARCHAR(20),
    @ErrorMessage NVARCHAR(MAX) = NULL
AS
BEGIN
    INSERT INTO BackupLog (BackupType, BackupDate, TotalRecords, BackupFilePath, Status, ErrorMessage)
    VALUES (@BackupType, GETDATE(), @TotalRecords, @BackupFilePath, @Status, @ErrorMessage);
END;
GO
/****** Object:  StoredProcedure [dbo].[sp_FeeDuesLoader]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_FeeDuesLoader]
AS
BEGIN
    SET NOCOUNT ON;

    -- Example logic: find students whose fees are due today
    SELECT 
        s.StudentId,
        s.StudentName,
        f.DueDate,
        f.Amount
    FROM spe.FeeInstallmentMaster f
    INNER JOIN StudentMaster s ON f.StudentId = s.StudentId
    WHERE 
        f.DueDate = CAST(GETDATE() AS DATE)
        AND f.IsPaid = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[SubRoles_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*

[dbo].[SubRoles_Create] 1,4,1

*/
CREATE   PROCEDURE [dbo].[SubRoles_Create]
(
	@RoleId	INT,
	@MenuId	INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	
	DECLARE @SubRoleId INT = 0, @AvailableCount INT = 0;

	SELECT @AvailableCount = COUNT(1) FROM SubRoles WHERE RoleId = @RoleId AND MenuId = @MenuId;

	IF (ISNULL(@AvailableCount,0) = 0)
	BEGIN
		INSERT INTO [dbo].[SubRoles] 
		(RoleId, SubRoleName, SubRoleCode, SubRoleDesc, MenuId,DisplayOrder,IsActive, CreatedBy, CreatedOn,IsDeleted)
		SELECT 
			@RoleId, 
			B.[MenuName], 
			B.[MenuCode], 
			B.[MenuDesc], 
			B.[MenuId], 
			B.[DisplayOrder], 
			1, 
			@ActionUser, 
			GETDATE(),
			0
			FROM [dbo].[MenuMaster] B
			WHERE B.[MenuId] = @MenuId;

		SELECT @SubRoleId = SCOPE_IDENTITY(); 
	END
	ELSE IF (@AvailableCount = 1)
	BEGIN

		SELECT @SubRoleId = SubRoleId FROM dbo.SubRoles WHERE RoleId = @RoleId AND MenuId = @MenuId;

		UPDATE dbo.SubRoles
		SET IsDeleted = 0,
			IsActive = 1,
			ModifiedBy = @ActionUser,
			ModifiedOn = GETDATE()
		WHERE SubRoleId = @SubRoleId
	END
	ELSE IF  (@AvailableCount > 1) --Possibility of Garabage Value, Remove unnecessary records
	BEGIN
		--Fetch the latest SubRoleId to update
		SELECT @SubRoleId = MAX(SubRoleId) FROM dbo.SubRoles WHERE RoleId = @RoleId AND MenuId = @MenuId;

		--Delete all other than latest ones to clear garbage value
		DELETE dbo.SubRoles WHERE RoleId = @RoleId AND MenuId = @MenuId AND SubRoleId <> @SubRoleId;

		--Update the last available record
		UPDATE dbo.SubRoles
		SET IsDeleted = 0,
			ModifiedBy = @ActionUser,
			ModifiedOn = GETDATE()
		WHERE SubRoleId = @SubRoleId
	END


	SELECT [SubRoleId]
      ,[RoleId]
      ,[SubRoleName]
      ,[SubRoleCode]
      ,[SubRoleDesc]
      ,[MenuId]
      ,[DisplayOrder]
      ,[IsActive]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[IsDeleted]
	  ,[IsDefault]
	FROM [dbo].[SubRoles]
	WHERE SubRoleId  = @SubRoleId

END
GO
/****** Object:  StoredProcedure [dbo].[SubRoles_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[SubRoles_Delete]
(
	@SubRoleId	INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN

	UPDATE SubRoles
	SET 
		IsActive = 0,
		IsDeleted = 1,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE SubRoleId = @SubRoleId

END
GO
/****** Object:  StoredProcedure [dbo].[SubRoles_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[SubRoles_ReadById]
(
	@SubRoleId INT
)
AS
BEGIN

	SELECT 
	       [SubRoleId]
		  ,[RoleId]
		  ,[SubRoleName]
		  ,[SubRoleCode]
		  ,[SubRoleDesc]
		  ,[MenuId]
		  ,[DisplayOrder]
		  ,[IsActive]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		  ,[IsDeleted]
	 FROM [dbo].[SubRoles]
	 WHERE SubRoleId = @SubRoleId
	 AND [IsActive] = 1
END
GO
/****** Object:  StoredProcedure [dbo].[SubRoles_ReadByRoleId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*

[dbo].[SubRoles_ReadByRoleId] 2

*/

 CREATE   PROCEDURE [dbo].[SubRoles_ReadByRoleId]
(
	@RoleId INT
)
AS
BEGIN

	SELECT [SubRoleId]
		  ,[RoleId]
		  ,[MenuId]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	 FROM [dbo].[SubRoles]
	 WHERE RoleId = @RoleId
	 AND [IsDeleted] = 0 AND [IsActive] = 1
END
GO
/****** Object:  StoredProcedure [dbo].[SubRoles_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[SubRoles_ReadByUserId] 1, 1
*/
CREATE   PROCEDURE [dbo].[SubRoles_ReadByUserId]
(
	@UserId INT
)
AS 
BEGIN

	--Get the Role with maximum privileges
	DECLARE @UserMaxPrivelageRole INT = 0;
	SELECT TOP 1 @UserMaxPrivelageRole = A.RoleId
	FROM dbo.UserRoles A
	LEFT OUTER JOIN dbo.SubRoles B
	ON A.RoleId = B.RoleId
	WHERE A.UserId = @UserId  AND A.IsActive = 1 
	GROUP BY A.RoleId
	ORDER BY SUM(1) DESC;


	--Get Default SubRole for the User
	DECLARE @DefaultSubRoleForUser INT = 0;
	SELECT TOP 1 @DefaultSubRoleForUser = MenuId
	FROM dbo.SubRoles 
	WHERE RoleId = @UserMaxPrivelageRole AND IsActive = 1 
	ORDER BY ISNULL(IsDefault,0) DESC
	

	IF OBJECT_ID('tempdb..#MenuMaster') IS NOT NULL DROP TABLE #MenuMaster;

	SELECT MAX(SubRoleId) SubRoleId, MAX(B.RoleId) RoleId, B.SubRoleName as SubRoleName
		   , C.MenuCode SubRoleCode --Menu Code must be unique for each menu as it binds pageload function on top of it
		   , MAX(SubRoleDesc) SubRoleDesc, B.MenuId, C.DisplayOrder, ParentMenuId, DefaultChildMenuId, MenuIconUrl, TemplatePath 
		   , 0 IsDefault
	INTO #MenuMaster
	FROM UserRoles A WITH (NOLOCK)
	LEFT OUTER JOIN SubRoles B WITH (NOLOCK)
	ON A.RoleId = B.RoleId
	LEFT OUTER JOIN MenuMaster C WITH (NOLOCK)
	ON B.MenuId = C.MenuId
	WHERE A.UserId = @UserId 
	AND A.IsActive = 1	AND B.IsActive = 1	AND C.IsActive = 1
	AND A.IsActive = 1
	GROUP BY B.SubRoleName	, C.MenuCode , B.MenuId, C.DisplayOrder, ParentMenuId, DefaultChildMenuId, MenuIconUrl, TemplatePath  ;


	ALTER TABLE #MenuMaster ADD IsParent INT DEFAULT 0, ChildrenCount INT DEFAULT 0, ChildIsParent INT DEFAULT 0;

	--Marking the Parent Menu
	UPDATE #MenuMaster SET IsParent = (CASE WHEN ParentMenuId = 0 THEN 1 ELSE 0 END );

	--Marking the Children Count for Menu
	UPDATE M 
	SET M.ChildrenCount = ISNULL(B.ChildrenCount,0), M.ChildIsParent = 0
	FROM #MenuMaster M
	LEFT OUTER JOIN (
		SELECT A.MenuId, COUNT(1) ChildrenCount
		FROM #MenuMaster A
		LEFT OUTER JOIN #MenuMaster B
		ON A.MenuId = B.ParentMenuId
		WHERE A.IsParent = 1 GROUP BY A.MenuId
	) B
	ON M.MenuId = B.MenuId;

	--Marking the Children without Parent
	UPDATE A SET A.ChildIsParent = 1
	FROM #MenuMaster A
	WHERE A.ParentMenuId NOT IN
	(
		SELECT MenuId FROM  #MenuMaster B 
	) AND A.IsParent <> 1;

	UPDATE #MenuMaster
	SET IsDefault = 1
	WHERE MenuId = @DefaultSubRoleForUser;

	SELECT *
	FROM #MenuMaster
	ORDER BY DisplayOrder;


END



GO
/****** Object:  StoredProcedure [dbo].[SubRoles_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[SubRoles_Update]
(
	@SubRoleId	INT,
	@IsActive INT ,
	@IsDeleted INT ,
	@ActionUser VARCHAR(50)
)
AS
BEGIN

	UPDATE SubRoles
	SET 
		IsActive = @IsActive,
		IsDeleted = @IsDeleted,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE SubRoleId = @SubRoleId

	SELECT
	     [SubRoleId]
		,[RoleId]
		,[SubRoleName]
		,[SubRoleCode]
		,[SubRoleDesc]
		,[MenuId]
		,[DisplayOrder]
		,[IsActive]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[IsDeleted]
	FROM [dbo].[SubRoles]
	WHERE SubRoleId = @SubRoleId

END
GO
/****** Object:  StoredProcedure [dbo].[UserLogin_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [dbo].[UserLogin_Create]
    @UserId = 1,
    @UserName = 'testuser',
    @UserPassword = 'testpassword123',
    @ActionUser = '4';
*/

CREATE   PROCEDURE [dbo].[UserLogin_Create]
(
    @UserId INT,
    @UserName VARCHAR(50),
    @UserPassword VARCHAR(500),
	@Status VARCHAR(50) = 'Active',
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
	 

    DECLARE @LoginId INT = 0;


        INSERT INTO [dbo].[UserLogin]
        (
            [UserId], 
            [UserName], 
            [UserPassword],
			[Status],
            [IsActive], 
            [IsDeleted], 
            [CreatedBy], 
            [CreatedOn]
        )
        VALUES
        (
            @UserId, 
            @UserName, 
            @UserPassword, 
			@Status,
            1, 
            0, 
            @ActionUser, 
            GETDATE()
        )

        SELECT @LoginId = SCOPE_IDENTITY();

        SELECT 
            [LoginId],
            [UserId],
            [UserName],
            [UserPassword],
            [FailedLoginAttempt],
            [LastLoggedDate],
			[Status],
            [IsActive],
            [CreatedBy],
            [CreatedOn],
            [ModifiedBy],
            [ModifiedOn],
            [IsDeleted]
        FROM [Nishwik].[dbo].[UserLogin]
        WHERE [LoginId] = @LoginId

END




GO
/****** Object:  StoredProcedure [dbo].[UserLogin_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserLogin_Delete]
(
	@LoginId INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN

	UPDATE [dbo].[UserLogin]
	SET [IsDeleted] = 1
	   ,[IsActive]=0
      ,[ModifiedBy] = @ActionUser
      ,[ModifiedOn] = GETDATE()
	WHERE LoginId = @LoginId

END
GO
/****** Object:  StoredProcedure [dbo].[UserLogin_GenerateOtp]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
	[dbo].[UserLogin_GenerateOtp] 8544444444
*/


CREATE PROCEDURE [dbo].[UserLogin_GenerateOtp]
(
	@MobileNo VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @UserId INT;
	DECLARE @OTP VARCHAR(6);
	DECLARE @ExpiryTime DATETIME;

	DECLARE @EmailId VARCHAR(200);
	DECLARE @MaskedMobile VARCHAR(50);
	DECLARE @MaskedEmail VARCHAR(200);

	DECLARE @OTPCount INT;
	DECLARE @BlockMinutes INT = 10;
	DECLARE @TimeWindowMinutes INT = 20;

	DECLARE @LastOtpTime DATETIME;
	DECLARE @CooldownMinutes INT = 1;  --minimum gap allowed b/w OTP sends
	DECLARE @OTPValidityMinutes INT = 5;  -- OTP expiry duration



	-- Check if User Exists
	SELECT 
		@UserId = UserId,
		@EmailId = EmailId
	FROM UserMaster
	WHERE MobileNo = @MobileNo 
		AND IsDeleted = 0 
		AND IsActive = 1;

	-- If User Doesn't Exists
	IF @UserId IS NULL
	BEGIN
		SELECT 
			statusCode = 404,
			message = 'Mobile number does not exist.',
			expiryTime = NULL
		RETURN;
	END


	-- Mask Mobile & Email for Response
	SET @MaskedMobile = STUFF(@MobileNo, 3, LEN(@MobileNo)-4, REPLICATE('X', LEN(@MobileNo)-4));

	IF @EmailId IS NOT NULL
	BEGIN
		DECLARE @NamePart VARCHAR(200) = LEFT(@EmailId, CHARINDEX('@', @EmailId) - 1);
        DECLARE @Domain VARCHAR(200) = SUBSTRING(@EmailId, CHARINDEX('@', @EmailId), LEN(@EmailId));

        IF LEN(@NamePart) <= 2
            SET @MaskedEmail = LEFT(@NamePart, 1) + 'XXXX' + @Domain;
        ELSE
            SET @MaskedEmail = LEFT(@NamePart, 2) + REPLICATE('X', LEN(@NamePart) - 2) + @Domain;
	END
	ELSE
	BEGIN 
		SET @MaskedEmail = NULL;
	END

	-- Check For Multiple Request
	SELECT @OtpCount = COUNT(*)
	FROM UserOtpVerification
	WHERE MobileNo = @MobileNo
		AND LastOtpSentAt >= DATEADD(Minute, -@TimeWindowMinutes, GETDATE());

	IF @OtpCount >= 3
	BEGIN 
		SELECT 
			statusCode = 429,
			message = CONCAT(
				'Too many OTP request detected. Please wait ',
				@BlockMinutes,
				' minutes before trying again.'
				),
			expiryTime = NULL;
		RETURN;
	END

	-- Check if User Requested OTP Recently (Cooldown)
	SELECT TOP 1 @LastOtpTime = LastOtpSentAt
	FROM UserOtpVerification
	WHERE MobileNo = @MobileNo AND Purpose = 'Login' AND IsUsed = 0
	ORDER BY OtpId DESC;

	IF @LastOtpTime IS NOT NULL AND DATEDIFF(MINUTE, @LastOtpTime, GETDATE()) < @CooldownMinutes
	BEGIN
		SELECT 
			statusCode = 429,
			message = CONCAT (
				'An OTP was recently sent. Please wait ',
				@CooldownMinutes - DATEDIFF(MINUTE, @LastOtpTime, GETDATE()),
				'more minute(s) before requesting a new one.'
			),
			expiryDate = NULL;
		RETURN;
	END


	-- Close any Prior Pending OTPs
	UPDATE UserOtpVerification
	SET Status = 'Expired'
	WHERE MobileNo = @MobileNo
		AND Status = 'Pending' 
		AND IsUsed = 0;



	-- Generate New OTP
	SET @OTP = RIGHT('000000' + CAST((ABS(CHECKSUM(NEWID())) % 1000000) AS VARCHAR(6)), 6);

	SET @ExpiryTime = DATEADD(MINUTE, 5, GETDATE());

	INSERT INTO UserOtpVerification
	(
		MobileNo,
		OTP,
		ExpiryTime,
		IsUsed,
		Attempts,
		LastOtpSentAt,
		Purpose,
		Status
	)
	VALUES
	(
		@MobileNo,
		@OTP,
		@ExpiryTime,
		0,
		0,
		GETDATE(),
		'Login',
		'Pending'
	);

-----------------------------------------------
	-- INSERT INTO NotificationMaster (Email Queue)
-----------------------------------------------
	DECLARE @HtmlContent NVARCHAR(MAX),
			@Subject NVARCHAR(200);

	SET @Subject = 'Your One-Time Password (OTP) for Login Access';

	SET @HtmlContent =
	'<div style="font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4;">
		<div style="max-width: 600px; margin: auto; background: #ffffff; padding: 25px; border-radius: 8px;">
			<h2 style="color: #333333; text-align: center;">Your Nishwik Login Verification Code</h2>
			<p style="font-size: 15px; color: #555555;">
				Dear User,<br/><br/>
				Your One-Time Password (OTP) for accessing your Nishwik account is:
			</p>

			<div style="text-align: center; margin: 25px 0;">
				<span style="
					 display: inline-block;
					 font-size: 32px;
					 letter-spacing: 4px;
					 padding: 12px 25px;
					 background: #1E90FF;
					 color: white;
					 border-radius: 6px;
					 font-weight: bold;">
					' + @OTP + '
				</span>
			</div>

			<p style="font-size: 14px; color: #555555;">
				This OTP is valid for <strong>5 minutes</strong>. 
				Please do not share this code with anyone for security reasons.
			</p>

			<p style="font-size: 14px; color: #555555;">
				If you did not request this OTP, kindly ignore this email
				or contact our support team immediately.
			</p>

			<hr style="margin: 20px 0;"/>

			<p style="font-size: 12px; color: #777777; text-align:center;">
				 Nishwik Solutions Pvt. Ltd. All rights reserved.
			</p>
		</div>
	</div>';

	INSERT INTO ann.NotificationMaster
	(
		AlertConfigId,
		NType,
		NSubject,
		NContent,
		NTo,
		NCc,
		NBcc,
		NStatus,
		Remarks,
		ScheduledDate,
		AttachmentPath,
		RetryCount,
		RetryDate,
		PostSendDataSourceType,
		PostSendDataSourceDef,
		DBConnId,
		IsActive,
		IsDeleted,
		CreatedBy,
		CreatedOn
	)
	VALUES
	(
		3,                        -- AlertConfigId (default)
		'Email',                  -- Notification Type
		@Subject,                 -- Subject
		@HtmlContent,             -- HTML Content
		'globalnishwikdev@gmail.com',                 -- Recipient Email (Users Email)
		'',                       -- CC
		'',                       -- BCC
		'Pending',                -- Status
		'',                       -- Remarks
		GETDATE(),                -- Scheduled Time
		'',                       -- Attachment
		0,                        -- Retry Count
		NULL,                     -- Retry Date
		'',                       -- Post-Process Type
		'',                       -- Post-Process Def
		0,                        -- DBConnId
		1,                        -- IsActive
		0,                        -- IsDeleted
		'SYSTEM',                 -- CreatedBy
		GETDATE()                 -- CreatedOn
	);


	SELECT 
		statusCode = 200,
		message = CONCAT('Your OTP has been sent to ', @MaskedMobile,
					CASE
						WHEN @MaskedEmail IS NOT NULL
						THEN ' and ' + @MaskedEmail
						ELSE ''
					END,
					'.'),
		expiryTime = @ExpiryTime

END
GO
/****** Object:  StoredProcedure [dbo].[UserLogin_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserLogin_ReadByUserId]
(
	@UserId INT
)
AS
BEGIN

	SELECT
	   A.[LoginId]
      ,A.[UserId]
      ,A.[UserName]
      ,A.[FailedLoginAttempt]
      ,A.[LastLoggedDate]
	  ,A.[Status]
      ,A.[IsActive]
      ,CASE WHEN B.UserId IS NULL THEN A.CreatedBy 
	   ELSE (ISNULL(B.FirstName + ' ','') + ISNULL(B.LastName,''))		   
	   END AS CreatedBy
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
      ,A.[IsDeleted]
	FROM [dbo].[UserLogin] A
	LEFT OUTER JOIN dbo.UserMaster B WITH (NOLOCK)
	ON A.CreatedBy = CONVERT(VARCHAR(50),B.UserId)
	WHERE A.UserId = @UserId AND A.[IsDeleted] = 0

END
GO
/****** Object:  StoredProcedure [dbo].[UserLogin_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserLogin_Update]
(
	@LoginId INT,
	@UserId INT,
	@UserName VARCHAR(50),
	@UserPassword VARCHAR(500),
	@Status VARCHAR(50) = 'Active',
	@IsActive INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [dbo].[UserLogin]
	SET 
		 [UserId] = @UserId
		,[UserName] = @UserName
		,[UserPassword] = @UserPassword
		,[Status] = @Status
		,[IsActive] = @IsActive
		,[ModifiedBy] = @ActionUser
		,[ModifiedOn] = GETDATE()
	WHERE LoginId = @LoginId
		
	SELECT 
	     [LoginId]
		,[UserId]
		,[UserName]
		,[UserPassword]
	    ,[Status]
		,[IsActive]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[IsDeleted]
	FROM [dbo].[UserLogin]
	WHERE LoginId = @LoginId
END
GO
/****** Object:  StoredProcedure [dbo].[UserLogin_ValidateOtp]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[UserLogin_ValidateOtp]
(
    @MobileNo VARCHAR(50),
    @Otp VARCHAR(6)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE 
        @ResponseCode INT = 0,
        @ResponseDescription VARCHAR(500) = '',
        @UserId INT = -1,
        @LogStatus VARCHAR(20) = 'FAILED',
        @UserName VARCHAR(100) = NULL;

    DECLARE 
        @OtpId INT,
        @DbOtp VARCHAR(6),
        @ExpiryTime DATETIME,
        @Attempts INT,
        @MaxAttempts INT = 3;

    DECLARE @DefaultCompanyId VARCHAR(500) = 1;


    ---------------------------------------------------------
    -- 1. Check if user exists by Mobile
    ---------------------------------------------------------
    SELECT @UserId = UserId
    FROM dbo.UserMaster WITH (NOLOCK)
    WHERE MobileNo = @MobileNo
      AND IsActive = 1
      AND IsDeleted = 0;

    IF @UserId IS NULL
    BEGIN
        SET @LogStatus = 'FAILED';
        SET @ResponseDescription = 'No active user found with the provided mobile number.';
        SET @ResponseCode = 404;

        RAISERROR('No active user found with provided mobile number.',16,1);
        GOTO LOG_AND_FAIL;
    END


    ---------------------------------------------------------
    -- 2. Fetch Active OTP
    ---------------------------------------------------------
    SELECT TOP 1
        @OtpId = OtpId,
        @DbOtp = OTP,
        @ExpiryTime = ExpiryTime,
        @Attempts = Attempts
    FROM dbo.UserOtpVerification
    WHERE MobileNo = @MobileNo
      AND Status = 'Pending'
      AND IsUsed = 0
    ORDER BY LastOtpSentAt DESC, OtpId DESC;

    IF @OtpId IS NULL
    BEGIN
        SET @ResponseCode = 400;
        SET @ResponseDescription = 'No active OTP found. Please request a new OTP.';
        SET @LogStatus = 'FAILED';

        RAISERROR('No active OTP found. Please request a new OTP.',16,1);
        GOTO LOG_AND_FAIL;
    END


    ---------------------------------------------------------
    -- 3. Check Attempt Limit
    ---------------------------------------------------------
    IF @Attempts >= @MaxAttempts
    BEGIN
        UPDATE dbo.UserOtpVerification
        SET Status = 'Blocked'
        WHERE OtpId = @OtpId;

        SET @ResponseCode = 429;
        SET @ResponseDescription = 'Maximum OTP attempts exceeded. Please request a new OTP.';
        SET @LogStatus = 'BLOCKED';

        RAISERROR('Maximum OTP attempts exceeded. Please request a new OTP.',16,1);
        GOTO LOG_AND_FAIL;
    END


    ---------------------------------------------------------
    -- 4. OTP Expiry
    ---------------------------------------------------------
    IF GETDATE() > @ExpiryTime
    BEGIN
        UPDATE dbo.UserOtpVerification
        SET Status = 'Expired'
        WHERE OtpId = @OtpId;

        SET @ResponseCode = 410;
        SET @ResponseDescription = 'OTP has expired. Please request a new OTP.';
        SET @LogStatus = 'FAILED';

        RAISERROR('OTP has expired. Please request a new OTP.',16,1);
        GOTO LOG_AND_FAIL;
    END


    ---------------------------------------------------------
    -- 5. OTP Incorrect
    ---------------------------------------------------------
    IF @DbOtp <> @Otp
    BEGIN
        UPDATE dbo.UserOtpVerification
        SET Attempts = Attempts + 1
        WHERE OtpId = @OtpId;

        SELECT @Attempts = Attempts FROM dbo.UserOtpVerification WHERE OtpId = @OtpId;

        IF @Attempts >= @MaxAttempts
        BEGIN
            UPDATE dbo.UserOtpVerification
            SET Status = 'Blocked'
            WHERE OtpId = @OtpId;

            SET @ResponseCode = 429;
            SET @ResponseDescription = 'Maximum OTP attempts exceeded. Please request a new OTP.';
            SET @LogStatus = 'BLOCKED';

            RAISERROR('Maximum OTP attempts exceeded. Please request a new OTP.',16,1);
        END
        ELSE
        BEGIN
            SET @ResponseCode = 401;
            SET @ResponseDescription = 'Invalid OTP. Please try again.';
            SET @LogStatus = 'FAILED';

            RAISERROR('Invalid OTP. Please try again.',16,1);
        END

        GOTO LOG_AND_FAIL;
    END


    ---------------------------------------------------------
    -- 6. OTP Success
    ---------------------------------------------------------
    UPDATE dbo.UserOtpVerification
    SET IsUsed = 1,
        Status = 'Verified'
    WHERE OtpId = @OtpId;

    SET @ResponseCode = 200;
    SET @ResponseDescription = 'OTP verified successfully.';
    SET @LogStatus = 'SUCCESS';


LOG_AND_FAIL:
    ---------------------------------------------------------
    -- Insert Log Entry ALWAYS
    ---------------------------------------------------------
    IF @UserName IS NULL
        SELECT TOP 1 @UserName = UserName FROM dbo.UserLogin WHERE UserId = @UserId;

    INSERT INTO dbo.UserLoginLog
    (
        UserId, UserName, UserPassword, LoggedTime,
        LogDescription, LogStatus
    )
    VALUES
    (
        ISNULL(@UserId, -1),
        @UserName,
        @Otp,
        GETDATE(),
        @ResponseDescription,
        @LogStatus
    );


    ---------------------------------------------------------
    -- 7. RETURN RESULT
    ---------------------------------------------------------
    IF @ResponseCode <> 200
    BEGIN
        SELECT 
            statusCode = @ResponseCode,
            message = @ResponseDescription;
        RETURN;
    END


    ---------------------------------------------------------
    -- SUCCESS  RETURN FULL LOGIN PAYLOAD
    ---------------------------------------------------------
    SELECT 
        statusCode = @ResponseCode,
        message = @ResponseDescription,
        B.*,
        C.RoleIds AS RoleId,
        @DefaultCompanyId AS DefaultCompanyId
    FROM dbo.UserMaster B WITH (NOLOCK)
    LEFT JOIN (
        SELECT  
            t.UserId,
            STUFF(
                (SELECT ', ' + CAST(A.RoleId AS VARCHAR(10))
                 FROM UserRoles A
                 WHERE A.UserId = t.UserId AND A.IsActive = 1
                 FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)')
            ,1,2,'') AS RoleIds
        FROM UserRoles t
        GROUP BY t.UserId
    ) C ON B.UserId = C.UserId
    WHERE B.UserId = @UserId;

END
GO
/****** Object:  StoredProcedure [dbo].[UserLogin_ValidateOtp2]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[UserLogin_ValidateOtp2]
(
	@MobileNo VARCHAR(50),
	@Otp VARCHAR(6)
)
AS 
BEGIN
	SET NOCOUNT ON;

	-- Response / logging vars
    DECLARE 
        @ResponseCode INT = 0,
        @ResponseDescription VARCHAR(500) = '',
        @UserId INT = -1,
        @LogStatus VARCHAR(20) = 'FAILED',
        @UserName VARCHAR(100) = NULL;

    -- OTP validation vars
    DECLARE 
        @OtpId INT,
        @DbOtp VARCHAR(6),
        @ExpiryTime DATETIME,
        @Attempts INT,
        @MaxAttempts INT = 3;

    -- For final output
    DECLARE @DefaultCompanyId VARCHAR(500);

	 -------------------------------------------
    -- 1) Resolve user by mobile
    -------------------------------------------
    SELECT @UserId = UserId
    FROM dbo.UserMaster WITH (NOLOCK)
    WHERE MobileNo = @MobileNo
      AND IsActive = 1
      AND IsDeleted = 0;

    IF @UserId IS NULL
    BEGIN
        SET @ResponseCode = 404;
        SET @ResponseDescription = 'No active user found with the provided mobile number.';
        SET @LogStatus = 'FAILED';
        GOTO LOG_AND_RETURN;
    END


	-- Fetch Latest Valid OTP For this User
	SELECT TOP 1
		@OtpId = OtpId,
		@DbOtp = OTP,
		@ExpiryTime = ExpiryTime,
		@Attempts = Attempts
	FROM [dbo].[UserOtpVerification]
	WHERE MobileNo = @MobileNo
		AND Status = 'Pending'
		AND IsUsed = 0
	ORDER BY LastOtpSentAt DESC, OtpId DESC;

	-- Handle No OTP Found
	If @OtpId IS NULL
	BEGIN
		SET @ResponseCode = 400;
        SET @ResponseDescription = 'No active OTP found. Please request a new OTP.';
        SET @LogStatus = 'FAILED';
        GOTO LOG_AND_RETURN;
	END

	-- Check Attempt Limit
	If @Attempts >= @MaxAttempts
	BEGIN
		UPDATE [dbo].[UserOtpVerification]
		SET Status = 'Blocked'
		WHERE OtpId = @OtpId;

		SET @ResponseCode = 429;
        SET @ResponseDescription = 'Maximum OTP attempts exceeded. Please request a new OTP.';
        SET @LogStatus = 'BLOCKED';
        GOTO LOG_AND_RETURN;
	END

	-- Check For OTP Expiry
	IF GETDATE() > @ExpiryTime
	BEGIN
		UPDATE [dbo].[UserOtpVerification]
		SET Status = 'Expired'
		WHERE OtpId = @OtpId;

		SET @ResponseCode = 410;
        SET @ResponseDescription = 'OTP has expired. Please request a new OTP.';
        SET @LogStatus = 'FAILED';
        GOTO LOG_AND_RETURN;
	END

	-- Validate OTP match
	IF @DbOtp <> @Otp
	BEGIN
		UPDATE [dbo].[UserOtpVerification]
		SET Attempts = Attempts + 1
		WHERE OtpId = @OtpId;

		 -- if this update reached max attempts, block it now
        SELECT @Attempts = Attempts FROM dbo.UserOtpVerification WHERE OtpId = @OtpId;

		IF @Attempts >= @MaxAttempts
        BEGIN
            UPDATE dbo.UserOtpVerification
            SET Status = 'Blocked'
            WHERE OtpId = @OtpId;

            SET @ResponseCode = 429;
            SET @ResponseDescription = 'Maximum OTP attempts exceeded. Please request a new OTP.';
            SET @LogStatus = 'BLOCKED';
        END
        ELSE
        BEGIN
            SET @ResponseCode = 401;
            SET @ResponseDescription = 'Invalid OTP. Please try again.';
            SET @LogStatus = 'FAILED';
        END

        GOTO LOG_AND_RETURN;
    END

   -- Success: mark OTP verified and update login timestamp

	UPDATE UserOtpVerification
	SET
		IsUsed = 1,
		Status = 'Verified'
	WHERE OtpId = @OtpId;

	SET @ResponseCode = 200;
    SET @ResponseDescription = 'OTP verified successfully.';
    SET @LogStatus = 'SUCCESS';



	LOG_AND_RETURN:
    -------------------------
    -- Insert Login Log (always)
    -------------------------
    -- Ensure we attempt to get UserName if not already fetched
    IF @UserName IS NULL
        SELECT TOP 1 @UserName = UserName FROM dbo.UserLogin WITH (NOLOCK) WHERE UserId = @UserId;

    INSERT INTO dbo.UserLoginLog
    (
        UserId,
        UserName,
        UserPassword,
        LoggedTime,
        LogDescription,
        LogStatus
    )
    VALUES
    (
        CASE WHEN @UserId IS NULL THEN -1 ELSE @UserId END,
        @UserName,
        @Otp,
        GETDATE(),
        @ResponseDescription,
        @LogStatus
    );



	 -------------------------
    -- Final output: mimic ValidateUserLogin response

	IF @ResponseCode <> 200
	BEGIN
		SELECT 
			statusCode = @ResponseCode,
			message = @ResponseDescription;
		RETURN;
	END
    -------------------------
    SELECT @DefaultCompanyId = 1;

    SELECT 
        A.ResponseCode, 
        A.ResponseDescription,
        B.*,
        C.RoleIds RoleId,
        @DefaultCompanyId DefaultCompanyId
    FROM (
        SELECT @ResponseCode ResponseCode, @ResponseDescription ResponseDescription, @UserId UserId
    ) A
    LEFT OUTER JOIN dbo.UserMaster B WITH (NOLOCK) 
        ON A.UserId = B.UserId
    LEFT OUTER JOIN (
        SELECT  
            t.UserId,
            STUFF((
                SELECT ', ' + CAST(A.RoleId AS VARCHAR(10))
                FROM UserRoles A
                WHERE A.UserId = t.UserId AND A.IsActive = 1
                FOR XML PATH(''), TYPE
            ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS RoleIds
        FROM UserRoles t
        GROUP BY t.UserId
    ) C
        ON A.UserId = C.UserId;

END
GO
/****** Object:  StoredProcedure [dbo].[UserLogin_ValidateUserName]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserLogin_ValidateUserName]
(
	@UserName VARCHAR(50) = ''
)
AS
BEGIN
	IF(TRIM(ISNULL(@UserName,'')) = '')
	BEGIN
		SELECT 'Kindly provide valid UserName.' ResponseMsg , 401 ResponseCode
	END
	ELSE
	BEGIN
		IF EXISTS(
					SELECT 1
					FROM dbo.UserLogin A
					LEFT OUTER JOIN dbo.UserMaster B
					ON A.UserId = B.UserId
					WHERE TRIM(ISNULL(A.UserName,'')) = TRIM(ISNULL(@UserName,''))
					)
		BEGIN
			SELECT 'UserName already exists.' ResponseMsg , 409 ResponseCode
		END
		ELSE
		BEGIN
			SELECT 'UserName available.' ResponseMsg , 200 ResponseCode
		END
	END
END
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[UserMaster_Create]
(
    @FirstName           VARCHAR(50),
    @MiddleName          VARCHAR(50),
    @LastName            VARCHAR(50),
    @DOB                 DATETIME,
    @MobileNo            VARCHAR(50),
    @EmailId             VARCHAR(50),
    @Designation         VARCHAR(50),
    @ProfileImage        VARCHAR(255),
    @Address             VARCHAR(500),
    @Country             VARCHAR(100),
    @State               VARCHAR(100),
    @City                VARCHAR(100),
    @BloodGroup          VARCHAR(10),
    @Gender              VARCHAR(10),
    @AadharNumber        VARCHAR(20),
    @PanNumber           VARCHAR(50),
    @Nationality         VARCHAR(50),
    @Religion            VARCHAR(50),
    @Caste               VARCHAR(50),
    @EmergencyContactName VARCHAR(100),
    @EmergencyContactNo   VARCHAR(15),
    @MaritalStatus        VARCHAR(20),
    @PinCode              VARCHAR(10),
    @OtherDetail1        VARCHAR(50),
    @OtherDetail2        VARCHAR(50),
    @OtherDetail3        VARCHAR(100),
    @OtherDetail4        VARCHAR(100),
    @OtherDetail5        VARCHAR(500),
    @OtherDetail6        VARCHAR(500),
    @ActionUser          VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    IF (LTRIM(RTRIM(ISNULL(@EmailId, ''))) <> '')
    BEGIN
        IF EXISTS (
            SELECT 1 
            FROM [dbo].[UserMaster] 
            WHERE LTRIM(RTRIM(EmailId)) = LTRIM(RTRIM(@EmailId))
              AND IsDeleted = 0
              AND IsActive = 1
        )
        BEGIN
            RAISERROR('Email ID already exists, please use a different email ID!', 16, 1);
            RETURN;
        END
    END

    DECLARE @UserId INT;

    INSERT INTO [dbo].[UserMaster] (
        [FirstName],
        [MiddleName],
        [LastName],
        [DOB],
        [MobileNo],
        [EmailId],
        [Designation],
        [ProfileImage],
        [Address],
        [Country],
        [State],
        [City],
        [BloodGroup],
        [Gender],
        [AadharNumber],
        [PanNumber],
        [Nationality],
        [Religion],
        [Caste],
        [EmergencyContactName],
        [EmergencyContactNo],
        [MaritalStatus],
        [PinCode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES (
        @FirstName,
        @MiddleName,
        @LastName,
        @DOB,
        @MobileNo,
        @EmailId,
        @Designation,
        @ProfileImage,
        @Address,
        @Country,
        @State,
        @City,
        @BloodGroup,
        @Gender,
        @AadharNumber,
        @PanNumber,
        @Nationality,
        @Religion,
        @Caste,
        @EmergencyContactName,
        @EmergencyContactNo,
        @MaritalStatus,
        @PinCode,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,                -- IsActive
        0,                -- IsDeleted
        @ActionUser,      -- CreatedBy
        GETDATE()         -- CreatedOn
    );

    SET @UserId = SCOPE_IDENTITY();

    SELECT
        [UserId],
        [FirstName],
        [MiddleName],
        [LastName],
        [DOB],
        [MobileNo],
        [EmailId],
        [Designation],
        [ProfileImage],
        [Address],
        [Country],
        [State],
        [City],
        [BloodGroup],
        [Gender],
        [AadharNumber],
        [PanNumber],
        [Nationality],
        [Religion],
        [Caste],
        [EmergencyContactName],
        [EmergencyContactNo],
        [MaritalStatus],
        [PinCode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [dbo].[UserMaster]
    WHERE [UserId] = @UserId;
END
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserMaster_Delete]
(
	@UserId INT,
	@ActionUser VARCHAR(50)
)
AS 
BEGIN

	UPDATE [dbo].[UserMaster]
	SET IsActive = 0 ,
	IsDeleted = 1,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE UserId = @UserId;
  
END 
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_GetUserDetailsByDocNo]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[dbo].[UserMaster_GetUserDetailsByDocNo]NULL,ABCDE1223F
*/
CREATE   PROCEDURE [dbo].[UserMaster_GetUserDetailsByDocNo]
(
    @AadharNumber VARCHAR(20) = NULL,
    @PanNumber    VARCHAR(50) = NULL,
	@MobileNo VARCHAR(50) = NULL,
	@EmailId VARCHAR(50) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        [UserId],
        [FirstName],
        [MiddleName],
        [LastName],
        [DOB],
        [MobileNo],
        [EmailId],
        [Designation],
        [ProfileImage],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn],
        [Address],
        [Country],
        [State],
        [City],
        [BloodGroup],
        [Gender],
        [AadharNumber],
        [PanNumber],
        [Nationality],
        [Religion],
        [Caste],
		[EmergencyContactName],
        [EmergencyContactNo],
        [MaritalStatus],
        [PinCode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6]
    FROM [Nishwik].[dbo].[UserMaster]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND (
            ( @AadharNumber IS NOT NULL AND @AadharNumber <> '' AND AadharNumber = @AadharNumber )
         OR ( @PanNumber IS NOT NULL AND @PanNumber <> '' AND PanNumber = @PanNumber )
		 OR ( @MobileNo IS NOT NULL AND @MobileNo <> '' AND MobileNo = @MobileNo )
		 OR ( @EmailId IS NOT NULL AND @EmailId <> '' AND EmailId = @EmailId )
      );
END
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserMaster_ReadAll]
AS
BEGIN
	SELECT 
			A.[UserId],
			A.[FirstName],
			A.[MiddleName],
			A.[LastName],
			A.[DOB],
			A.[MobileNo],
			A.[EmailId],
			A.[Designation],
			A.[ProfileImage],
			A.[Address],
			A.[Country],
			A.[State],
			A.[City],
			A.[BloodGroup],
			A.[Gender],
			A.[AadharNumber],
			A.[PanNumber],
			A.[Nationality],
			A.[Religion],
			A.[Caste],
			A.[EmergencyContactName],
            A.[EmergencyContactNo],
            A.[MaritalStatus],
            A.[PinCode],
			A.[OtherDetail1],
			A.[OtherDetail2],
			A.[OtherDetail3],
			A.[OtherDetail4],
			A.[OtherDetail5],
			A.[OtherDetail6],
			A.[IsActive],
			A.[IsDeleted],
			CASE 
				WHEN A.UserId IS NULL THEN A.CreatedBy 
				ELSE (ISNULL(A.FirstName + ' ','') + ISNULL(A.LastName,''))
			END AS CreatedBy,
			A.[CreatedOn],
			A.[ModifiedBy],
			A.[ModifiedOn]
	FROM 
		[dbo].[UserMaster] A
	WHERE 
		A.IsDeleted = 0;
END
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ReadByBusinessId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [dbo].[UserMaster_ReadByBusinessId] 
    @BusinessId = 4



*/
CREATE   PROCEDURE [dbo].[UserMaster_ReadByBusinessId]
(
    @BusinessId INT
)
AS
BEGIN 
    SET NOCOUNT ON;
    SELECT
  
        A.[UserId],
        A.[FirstName],
        A.[MiddleName],
        A.[LastName],
        A.[DOB],
        A.[MobileNo],
        A.[EmailId],
        A.[Designation],
        A.[ProfileImage],
        A.[Address],
        A.[Country],
        A.[State],
        A.[City],
        A.[BloodGroup],
        A.[Gender],
        A.[AadharNumber],
        A.[PanNumber],
        A.[Nationality],
        A.[Religion],
        A.[Caste],
		A.[EmergencyContactName],
        A.[EmergencyContactNo],
        A.[MaritalStatus],
        A.[PinCode],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        B.[MappingId],
        B.[IsPrimary],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn]
    FROM [Nishwik].[dbo].[UserMaster] A
    LEFT JOIN [Nishwik].[re].[UserAffiliationMapping] B
	ON A.[UserId] = B.[UserId]
    WHERE B.[BusinessId] = @BusinessId
    AND A.[IsActive] = 1
 ORDER BY B.IsPrimary DESC;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserMaster_ReadByHospitalId]
(
     @HospitalId INT,
	 @AffiliationType  VARCHAR(50)= NULL,
	 @PageSize INT = 20,
	 @PageNo INT = 1,
	 @OrderByClause NVARCHAR(MAX) = NULL,
	 @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);

	SET @SQL = 
	'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.UserId DESC') + 
	') AS RowNum,
		A.[UserId],
		A.[FirstName],
		A.[MiddleName],
		A.[LastName],
		A.[DOB],
		A.[MobileNo],
		A.[EmailId],
		A.[Designation],
		A.[ProfileImage],
		A.[Address],
		A.[Country],
		A.[State],
		A.[City],
		A.[BloodGroup],
		A.[Gender],
		A.[AadharNumber],
		A.[PanNumber],
		A.[Nationality],
		A.[Religion],
		A.[Caste],
		A.[OtherDetail1],
		A.[OtherDetail2],
		A.[OtherDetail3],
		A.[OtherDetail4],
		A.[OtherDetail5],
		A.[OtherDetail6],
		B.[MappingId],
		B.[IsPrimary],
		A.[EmergencyContactName],
        A.[EmergencyContactNo],
        A.[MaritalStatus],
        A.[PinCode],
		C.[Specialization],
        C.[Education],
        C.[EmploymentType],
        C.[ConsultationFee],
        C.[YearsOfExperience],
		A.[IsActive],
		A.[IsDeleted],
		A.[CreatedBy],
		A.[CreatedOn],
		A.[ModifiedBy],
		A.[ModifiedOn],
		D.[Department],
		D.[Specialization],
		D.[Education],
		D.[EmploymentType],
		D.[ConsultationFee],
		D.[YearsOfExperience],
		D.[RegistrationNumber],
		D.[LicensingAuthority],
		D.[YearOfRegistration],
		D.[RegistrationDate],
		D.[JoiningDate],
		D.[ShiftType],
		D.[VisitType],
		D.[ReferredBy],
		D.[SocialLink],
		COUNT(*) OVER () AS TotalCount,
		' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
		' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [Nishwik].[dbo].[UserMaster] A
	LEFT JOIN [Nishwik].[hm].[UserAffiliationMapping] B
		ON A.[UserId] = B.[UserId]
		LEFT OUTER JOIN [Nishwik].[hm].[UserAffiliationMapping] C
		ON A.[UserId]= C.[UserId]
		LEFT OUTER JOIN [Nishwik].[hm].[UserAffiliationMapping] D
		ON
		A.UserId = D.UserId
	WHERE  
		B.[HospitalId] = ' + CAST(@HospitalId AS NVARCHAR) + '
		AND B.[IsActive] = 1';

	IF @AffiliationType IS NOT NULL AND LTRIM(RTRIM(@AffiliationType)) <> ''
		SET @SQL = @SQL + ' AND B.[AffiliationType] = ''' + @AffiliationType + '''';

	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

	SET @SQL = @SQL + '
	ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.UserId DESC') + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserMaster_ReadBySchoolId]
(
     @SchoolId INT,
	 @AffiliationType  VARCHAR(50)= NULL,
	 @PageSize INT = 20,
	 @PageNo INT = 1,
	 @OrderByClause NVARCHAR(MAX) = NULL,
	 @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);

	SET @SQL = 
	'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.UserId DESC') + 
	') AS RowNum,
		A.[UserId],
		A.[FirstName],
		A.[MiddleName],
		A.[LastName],
		A.[DOB],
		A.[MobileNo],
		A.[EmailId],
		A.[Designation],
		A.[ProfileImage],
		A.[Address],
		A.[Country],
		A.[State],
		A.[City],
		A.[BloodGroup],
		A.[Gender],
		A.[AadharNumber],
		A.[PanNumber],
		A.[Nationality],
		A.[Religion],
		A.[Caste],
		A.[EmergencyContactName],
        A.[EmergencyContactNo],
        A.[MaritalStatus],
        A.[PinCode],
		A.[OtherDetail1],
		A.[OtherDetail2],
		A.[OtherDetail3],
		A.[OtherDetail4],
		A.[OtherDetail5],
		A.[OtherDetail6],
		B.[MappingId],
		B.[IsPrimary],
		A.[IsActive],
		A.[IsDeleted],
		A.[CreatedBy],
		A.[CreatedOn],
		A.[ModifiedBy],
		A.[ModifiedOn],
		COUNT(*) OVER () AS TotalCount,
		' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
		' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [Nishwik].[dbo].[UserMaster] A
	LEFT JOIN [Nishwik].[spe].[UserAffiliationMapping] B
		ON A.[UserId] = B.[UserId]
	WHERE  
		B.[SchoolId] = ' + CAST(@SchoolId AS NVARCHAR) + '
		AND B.[IsActive] = 1';

	IF @AffiliationType IS NOT NULL AND LTRIM(RTRIM(@AffiliationType)) <> ''
		SET @SQL = @SQL + ' AND B.[AffiliationType] = ''' + @AffiliationType + '''';

	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

	SET @SQL = @SQL + '
	ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.UserId DESC') + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ReadBySocietyId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
  [dbo].[UserMaster_ReadBySocietyId]14,null,null,'Staff',10,1,'',''
*/

CREATE   PROCEDURE [dbo].[UserMaster_ReadBySocietyId]
(
     @SocietyId INT,
	 @BuildingId  INT,
	 @FlatId INT,
	 @AffiliationType  VARCHAR(50)= NULL,
	 @PageSize INT = 20,
	 @PageNo INT = 1,
	 @OrderByClause NVARCHAR(MAX) = NULL,
	 @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);

	SET @SQL = 
	'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.UserId DESC') + 
	') AS RowNum,
		A.[UserId],
		A.[FirstName],
		A.[MiddleName],
		A.[LastName],
		A.[DOB],
		A.[MobileNo],
		A.[EmailId],
		A.[Designation],
		A.[ProfileImage],
		A.[Address],
		A.[Country],
		A.[State],
		A.[City],
		A.[BloodGroup],
		A.[Gender],
		A.[AadharNumber],
		A.[PanNumber],
		A.[Nationality],
		A.[Religion],
		A.[Caste],
		A.[EmergencyContactName],
        A.[EmergencyContactNo],
        A.[MaritalStatus],
        A.[PinCode],
		A.[OtherDetail1],
		A.[OtherDetail2],
		A.[OtherDetail3],
		A.[OtherDetail4],
		A.[OtherDetail5],
		A.[OtherDetail6],
		B.[MappingId],
		B.[IsPrimary],
		A.[IsActive],
		A.[IsDeleted],
		A.[CreatedBy],
		A.[CreatedOn],
		A.[ModifiedBy],
		A.[ModifiedOn],
		COUNT(*) OVER () AS TotalCount,
		' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
		' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [Nishwik].[dbo].[UserMaster] A
	LEFT JOIN [Nishwik].[sm].[UserAffiliationMapping] B
		ON A.[UserId] = B.[UserId]
	WHERE  
		B.[SocietyId] = ' + CAST(@SocietyId AS NVARCHAR) + ' 
		AND B.[IsActive] = 1';

	--  Only add filters if parameters are not NULL
    IF @BuildingId IS NOT NULL AND @BuildingId <> 0
        SET @SQL = @SQL + ' AND B.[BuildingId] = ' + CAST(@BuildingId AS NVARCHAR);

    IF @FlatId IS NOT NULL AND @FlatId <> 0
        SET @SQL = @SQL + ' AND B.[FlatId] = ' + CAST(@FlatId AS NVARCHAR);

     IF @AffiliationType IS NOT NULL AND LTRIM(RTRIM(@AffiliationType)) <> ''
		SET @SQL = @SQL + ' AND B.[AffiliationType] = ''' + @AffiliationType + '''';

	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

	SET @SQL = @SQL + '
	ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.UserId DESC') + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserMaster_ReadByUserId]
(
	@UserId INT
)
AS
BEGIN
	SELECT 
       [UserId]
      ,[FirstName]
      ,[MiddleName]
      ,[LastName]
      ,[DOB]
      ,[MobileNo]
      ,[EmailId]
      ,[Designation]
      ,[ProfileImage]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[Address]
      ,[Country]
      ,[State]
      ,[City]
      ,[BloodGroup]
      ,[Gender]
      ,[AadharNumber]
      ,[PanNumber]
      ,[Nationality]
      ,[Religion]
      ,[Caste]
	  ,[EmergencyContactName]
      ,[EmergencyContactNo]
      ,[MaritalStatus]
      ,[PinCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
  FROM [dbo].[UserMaster]
  WHERE [UserId] = @UserId
  AND IsDeleted=0
  AND [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_SearchByName]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
EXEC [dbo].[UserMaster_SearchByName]
    @CompanyId = 1,
    @BranchId = 1,
    @SearchText = 'Priti';
*/
CREATE   PROCEDURE [dbo].[UserMaster_SearchByName]
(
  @SearchText VARCHAR(50)
)
AS
BEGIN
  SET NOCOUNT ON;

  SELECT 
		   [UserId],
		   (FirstName + ISNULL(' ' +MiddleName+ ' ',' ') + LastName) AS FullName
  FROM [dbo].[UserMaster]
  WHERE 
      [IsActive] = 1 AND
      (
          [FirstName] LIKE '%' + @SearchText + '%' OR
          [MiddleName] LIKE '%' + @SearchText + '%' OR
          [LastName] LIKE '%' + @SearchText + '%'
      );
END;
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_SuggestUserName]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
DECLARE @u VARCHAR(128);   --  declare the variable first

EXEC dbo.UserMaster_SuggestUserName 
    @FirstName = 'Priti', 
    @LastName = 'Yadav'

*/

CREATE   PROCEDURE [dbo].[UserMaster_SuggestUserName]
(
    @FirstName  VARCHAR(50),
    @LastName   VARCHAR(50)
)
AS
BEGIN

    SET NOCOUNT ON;
    DECLARE @base VARCHAR(128) = 
        LOWER(LEFT(LTRIM(RTRIM(@FirstName)), 1)) + '_' +
        LOWER(REPLACE(LTRIM(RTRIM(@LastName)), ' ', '')), 
		@SuggestedUserName VARCHAR(128);

    -- 2) If the base username does not exist, use it
    IF NOT EXISTS (SELECT 1 FROM dbo.UserLogin WITH (READCOMMITTED) WHERE UserName = @base)
    BEGIN
		PRINT 'NOT EXISTS'
        SET @SuggestedUserName = @base;
		SELECT @SuggestedUserName AS SuggestedUserName

        RETURN;
    END

    -- 3) If it exists, find the highest numeric suffix already used and suggest next
    ;WITH Matches AS
    (
        -- Pull usernames that start with the base and have ONLY digits after the base
        SELECT
            Suffix = TRY_CONVERT(INT, SUBSTRING(UserName, LEN(@base) + 1, 50))
        FROM dbo.UserLogin WITH (READCOMMITTED)
        WHERE UserName = @base
           OR (
                UserName LIKE @base + '%'
                AND TRY_CONVERT(INT, SUBSTRING(UserName, LEN(@base) + 1, 50)) IS NOT NULL
              )
    )
    SELECT
        @SuggestedUserName =
            @base +
            CAST(COALESCE((SELECT MAX(Suffix) FROM Matches WHERE Suffix IS NOT NULL), 0) + 1 AS VARCHAR(10));

	SELECT @SuggestedUserName AS SuggestedUserName
END
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[UserMaster_Update]
(
    @UserId              INT,
    @FirstName           VARCHAR(50),
    @MiddleName          VARCHAR(50),
    @LastName            VARCHAR(50),
    @DOB                 DATETIME,
    @MobileNo            VARCHAR(50),
    @EmailId             VARCHAR(50),
    @Designation         VARCHAR(50),
    @ProfileImage        VARCHAR(255),
    @Address             VARCHAR(500),
    @Country             VARCHAR(100),
    @State               VARCHAR(100),
    @City                VARCHAR(100),
    @BloodGroup          VARCHAR(10),
    @Gender              VARCHAR(10),
    @AadharNumber        VARCHAR(20),
    @PanNumber           VARCHAR(50),
    @Nationality         VARCHAR(50),
    @Religion            VARCHAR(50),
    @Caste               VARCHAR(50),
    @EmergencyContactName VARCHAR(100),
    @EmergencyContactNo   VARCHAR(15),
    @MaritalStatus        VARCHAR(20),
    @PinCode              VARCHAR(10),
    @OtherDetail1        VARCHAR(50),
    @OtherDetail2        VARCHAR(50),
    @OtherDetail3        VARCHAR(100),
    @OtherDetail4        VARCHAR(100),
    @OtherDetail5        VARCHAR(500),
    @OtherDetail6        VARCHAR(500),
    @IsActive            INT,
    @ActionUser          VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    -- Optional email uniqueness check (commented out)
    --IF EXISTS (
    --    SELECT 1 FROM [dbo].[UserMaster]
    --    WHERE EmailId = @EmailId AND UserId <> @UserId AND IsDeleted = 0
    --)
    --BEGIN
    --    RAISERROR('Email ID already exists, please use a different email ID!', 16, 1);
    --    RETURN;
    --END

    UPDATE [dbo].[UserMaster]
    SET 
        FirstName            = @FirstName,
        MiddleName           = @MiddleName,
        LastName             = @LastName,
        DOB                  = @DOB,
        MobileNo             = @MobileNo,
        EmailId              = @EmailId,
        Designation          = @Designation,
        ProfileImage         = @ProfileImage,
        Address              = @Address,
        Country              = @Country,
        State                = @State,
        City                 = @City,
        BloodGroup           = @BloodGroup,
        Gender               = @Gender,
        AadharNumber         = @AadharNumber,
        PanNumber            = @PanNumber,
        Nationality          = @Nationality,
        Religion             = @Religion,
        Caste                = @Caste,
        EmergencyContactName = @EmergencyContactName,
        EmergencyContactNo   = @EmergencyContactNo,
        MaritalStatus        = @MaritalStatus,
        PinCode              = @PinCode,
        OtherDetail1         = @OtherDetail1,
        OtherDetail2         = @OtherDetail2,
        OtherDetail3         = @OtherDetail3,
        OtherDetail4         = @OtherDetail4,
        OtherDetail5         = @OtherDetail5,
        OtherDetail6         = @OtherDetail6,
        IsActive             = @IsActive,
        ModifiedBy           = @ActionUser,
        ModifiedOn           = GETDATE()
    WHERE
        UserId = @UserId;

    SELECT  
        [UserId],
        [FirstName],
        [MiddleName],
        [LastName],
        [DOB],
        [MobileNo],
        [EmailId],
        [Designation],
        [ProfileImage],
        [Address],
        [Country],
        [State],
        [City],
        [BloodGroup],
        [Gender],
        [AadharNumber],
        [PanNumber],
        [Nationality],
        [Religion],
        [Caste],
        [EmergencyContactName],
        [EmergencyContactNo],
        [MaritalStatus],
        [PinCode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [dbo].[UserMaster]
    WHERE UserId = @UserId;
END
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ValidateUniqueIdentities]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
EXEC [dbo].[UserMaster_ValidateUniqueIdentities]
    @UserId        = NULL,                 -- NULL => Create
    @AadharNumber  = '342345675610',
    @PanNumber     = 'ABCDE0010F',
    @EmailId       = 'user10@test.com',
    @MobileNo      = '9876543299';
*/


CREATE PROCEDURE [dbo].[UserMaster_ValidateUniqueIdentities]
(
    @UserId        INT             = NULL,            -- NULL => create, not NULL => update
    @AadharNumber  NVARCHAR(20)    = NULL,
    @PanNumber     NVARCHAR(20)    = NULL,
    @EmailId       NVARCHAR(150)   = NULL,
    @MobileNo      NVARCHAR(15)    = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    ------------------------------------------------------------------------
    -- Normalize inputs
    ------------------------------------------------------------------------
    SET @PanNumber = NULLIF(LTRIM(RTRIM(@PanNumber)), '');
    IF @PanNumber IS NOT NULL SET @PanNumber = UPPER(@PanNumber);

    SET @EmailId = NULLIF(LTRIM(RTRIM(@EmailId)), '');
    DECLARE @EmailLower NVARCHAR(150) = NULL;
    IF @EmailId IS NOT NULL SET @EmailLower = LOWER(@EmailId);

    SET @AadharNumber = NULLIF(LTRIM(RTRIM(@AadharNumber)), '');
    SET @MobileNo     = NULLIF(LTRIM(RTRIM(@MobileNo)), '');

    ------------------------------------------------------------------------
    -- Guard: require at least one identifier
    ------------------------------------------------------------------------
    IF @AadharNumber IS NULL AND @PanNumber IS NULL AND @EmailId IS NULL AND @MobileNo IS NULL
    BEGIN
        SELECT 'INPUT_ERROR' AS StatusCode,
               'Provide at least one identifier (Aadhaar / PAN / Email / Mobile).' AS Message,
               NULL AS MatchedUserId;

        SELECT CAST(NULL AS NVARCHAR(50)) AS Field,
               CAST(NULL AS NVARCHAR(200)) AS Value,
               CAST(NULL AS INT) AS ExistingUserId,
               CAST(NULL AS NVARCHAR(400)) AS ErrorText
        WHERE 1 = 0;
        RETURN;
    END

    ------------------------------------------------------------------------
    -- Collect conflicts
    ------------------------------------------------------------------------
    DECLARE @Conflicts TABLE
    (
        Field          NVARCHAR(50),
        Value          NVARCHAR(200),
        ExistingUserId INT,
        ErrorText      NVARCHAR(400)
    );

    -- Aadhaar
    IF @AadharNumber IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId, ErrorText)
        SELECT 'AadharNumber', @AadharNumber, U.UserId,
               'Aadhaar number ' + @AadharNumber + ' is already associated with another user (UserId: ' + CAST(U.UserId AS NVARCHAR(20)) + ').'
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.AadharNumber = @AadharNumber
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    -- PAN
    IF @PanNumber IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId, ErrorText)
        SELECT 'PanNumber', @PanNumber, U.UserId,
               'PAN ' + @PanNumber + ' is already associated with another user (UserId: ' + CAST(U.UserId AS NVARCHAR(20)) + ').'
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.PanNumber = @PanNumber
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    -- Email (case-insensitive using LOWER)
    IF @EmailLower IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId, ErrorText)
        SELECT 'EmailId', @EmailId, U.UserId,
               'Email ' + @EmailId + ' is already associated with another user (UserId: ' + CAST(U.UserId AS NVARCHAR(20)) + ').'
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND LOWER(ISNULL(U.EmailId, '')) = @EmailLower
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    -- Mobile
    IF @MobileNo IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId, ErrorText)
        SELECT 'MobileNo', @MobileNo, U.UserId,
               'Mobile number ' + @MobileNo + ' is already associated with another user (UserId: ' + CAST(U.UserId AS NVARCHAR(20)) + ').'
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.MobileNo = @MobileNo
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    ------------------------------------------------------------------------
    -- CREATE vs UPDATE logic
    ------------------------------------------------------------------------
    IF @UserId IS NULL
    BEGIN
        -- CREATE flow
        IF NOT EXISTS (SELECT 1 FROM @Conflicts)
        BEGIN
            SELECT 'OK' AS StatusCode, 'Validation successful. No duplicates found.' AS Message, NULL AS MatchedUserId;
            SELECT CAST(NULL AS NVARCHAR(50)) AS Field, CAST(NULL AS NVARCHAR(200)) AS Value, CAST(NULL AS INT) AS ExistingUserId, CAST(NULL AS NVARCHAR(400)) AS ErrorText
            WHERE 1 = 0;
            RETURN;
        END

        -- Count distinct existing users referenced by conflicts
        DECLARE @DistinctUserCount INT;
        SELECT @DistinctUserCount = COUNT(DISTINCT ExistingUserId) FROM @Conflicts;

        IF @DistinctUserCount = 2
        BEGIN
            DECLARE @ExistingUserId INT;
            SELECT TOP 1 @ExistingUserId = ExistingUserId FROM @Conflicts;

            -- If all conflicts point to same user => that account already exists
            SELECT 'USER_ALREADY_EXISTS' AS StatusCode,
                   'An account already exists with one or more of the provided identifiers. Please login or link to existing account.' AS Message,
                   @ExistingUserId AS MatchedUserId;

            SELECT Field, Value, ExistingUserId, ErrorText FROM @Conflicts;
            RETURN;
        END
        ELSE
        BEGIN
            -- Collides with multiple users => data conflict
            SELECT 'DUPLICATE_ON_CREATE' AS StatusCode,
                   'One or more identifiers are already used by other user(s). Please correct the highlighted fields.' AS Message,
                   NULL AS MatchedUserId;

            SELECT Field, Value, ExistingUserId, ErrorText FROM @Conflicts;
            RETURN;
        END
    END
    ELSE
    BEGIN
        -- UPDATE flow
        IF EXISTS (SELECT 1 FROM @Conflicts)
        BEGIN
            SELECT 'DUPLICATE_ON_UPDATE' AS StatusCode,
                   'One or more identifiers are already used by another user. You cannot assign identifiers owned by others.' AS Message,
                   @UserId AS MatchedUserId;

            SELECT Field, Value, ExistingUserId, ErrorText FROM @Conflicts;
            RETURN;
        END

        -- No conflicts for update
        SELECT 'OK' AS StatusCode, 'Validation successful. No duplicates found.' AS Message, @UserId AS MatchedUserId;
        SELECT CAST(NULL AS NVARCHAR(50)) AS Field, CAST(NULL AS NVARCHAR(200)) AS Value, CAST(NULL AS INT) AS ExistingUserId, CAST(NULL AS NVARCHAR(400)) AS ErrorText
        WHERE 1 = 0;
        RETURN;
    END
END;
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ValidateUniqueIdentities2]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create   PROCEDURE [dbo].[UserMaster_ValidateUniqueIdentities2]
(
	@UserId INT = NULL,
	@AadharNumber NVARCHAR(20) = NULL,
	@PanNumber NVARCHAR(20) = NULL,
	@EmailId NVARCHAR(150) = NULL,
	@MobileNo NVARCHAR(15) = NULL
)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @ConflictMessage NVARCHAR(500);

	-- Check AdhaarNumber Duplication
	IF @AadharNumber IS NOT NULL
	BEGIN
		IF EXISTS (
			SELECT 1 FROM [dbo].[UserMaster]
			WHERE AadharNumber = @AadharNumber
				AND IsDeleted = 0
				AND (@UserId IS NULL OR UserId <> @UserId)
		)
		BEGIN
			SET @ConflictMessage = 'Duplicate Adhar Number Found.'
			GOTO ConflictFound;
		END
	END


	-- Check PanNumber Duplication
	IF @PanNumber IS NOT NULL
	BEGIN
		IF EXISTS (
			SELECT 1 FROM [dbo].[UserMaster]
			WHERE PanNumber = @PanNumber
				AND IsDeleted = 0
				AND (@UserId IS NULL OR UserId <> @UserId)
		)
		BEGIN
			SET @ConflictMessage = 'Duplicate Pan Number Found'
			GOTO ConflictFound;
		END
	END

	-- Check EmailId duplication
	IF @EmailId IS NOT NULL
	BEGIN 
		IF EXISTS (
			SELECT 1 FROM [DBO].[UserMaster]
			WHERE EmailId = @EmailId
				AND IsDeleted = 0
				AND (@UserId IS NULL OR @UserId <> UserId)
		)
		BEGIN 
			SET @ConflictMessage = 'Duplicate Email Id Found'
		END
	END

	-- Check Mobile Duplication
	IF @MobileNo is NOT NULL
	BEGIN
		IF EXISTS (
			SELECT 1 FROM [DBO].[UserMaster]
			WHERE MobileNo = @MobileNo
				AND IsDeleted = 0
				AND (@UserId <> NULL OR UserId <> @UserId)
		)
		BEGIN
			SET @ConflictMessage = 'Duplicate Mobile Number Found';
			GOTO ConflictFound;
		END
	END

	-- Check If All Provided Fields Belong to the Same User
	IF @UserId IS NULL
	BEGIN
		DECLARE @MatchedUserId INT;

		SELECT TOP 1 @MatchedUserId = UserId
		FROM [dbo].[UserMaster]
		WHERE
			(AadharNumber = @AadharNumber OR @AadharNumber IS NULL)
			OR (PanNumber = @PanNumber OR @PanNumber IS NULL)
			OR (EmailId = @EmailId OR @EmailId IS NULL)
			OR (MobileNo = @MobileNo OR @MobileNo IS NULL)

		IF @MatchedUserId IS NOT NULL
		BEGIN
			-- Check if all four belong to same user
			IF EXISTS (
				SELECT 1 FROM [DBO].[UserMaster]
				WHERE UserId = @MatchedUserId
					AND (AadharNumber <> @AadharNumber OR @AadharNumber IS NULL)
					AND (PanNumber <> @PanNumber OR @PanNumber IS NULL)
					AND (EmailId <> @EmailId OR @EmailId IS NULL)
					AND (MobileNo <> @MobileNo OR @MobileNo IS NULL)
			)
			BEGIN
				SET @ConflictMessage = 'Provided Identifiers do not belong to the same User.';
				GOTO ConflictFound;
			END
		END
	END

	SELECT 'Success' AS Status, 'Validation Successful' AS Message;
	RETURN;

	ConflictFound:
		SELECT 'ERROR' AS Status, @ConflictMessage AS Message;
		RETURN;

END
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ValidateUniqueIdentities3]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [dbo].[UserMaster_ValidateUniqueIdentities]
    @UserId        = NULL,                 -- NULL => Create
    @AadharNumber  = '342345675610',
    @PanNumber     = 'ABCDE0010F',
    @EmailId       = 'user10@test.com',
    @MobileNo      = '9876543299';
*/

CREATE PROCEDURE [dbo].[UserMaster_ValidateUniqueIdentities3]
(
    @UserId        INT            = NULL,     -- NULL for create; not null for update
    @AadharNumber  NVARCHAR(20)   = NULL,
    @PanNumber     NVARCHAR(20)   = NULL,
    @EmailId       NVARCHAR(150)  = NULL,
    @MobileNo      NVARCHAR(15)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    ------------------------------------------------------------------------
    -- Normalize inputs (trim; uppercase PAN, optional lowercase email, etc.)
    ------------------------------------------------------------------------
    SET @PanNumber = NULLIF(LTRIM(RTRIM(@PanNumber)), '');
    IF @PanNumber IS NOT NULL SET @PanNumber = UPPER(@PanNumber);

    SET @EmailId = NULLIF(LTRIM(RTRIM(@EmailId)), '');
    -- Uncomment if your DB stores email lowercase:
    -- IF @EmailId IS NOT NULL SET @EmailId = LOWER(@EmailId);

    SET @AadharNumber = NULLIF(LTRIM(RTRIM(@AadharNumber)), '');
    SET @MobileNo     = NULLIF(LTRIM(RTRIM(@MobileNo)), '');

    ------------------------------------------------------------------------
    -- Input guard: at least one identifier required
    ------------------------------------------------------------------------
    IF @AadharNumber IS NULL AND @PanNumber IS NULL AND @EmailId IS NULL AND @MobileNo IS NULL
    BEGIN
        SELECT 'INPUT_ERROR' AS StatusCode, 'Provide at least one identifier (Aadhaar/PAN/Email/Mobile).' AS Message, NULL AS MatchedUserId;
        SELECT CAST(NULL AS NVARCHAR(50)) AS Field, CAST(NULL AS NVARCHAR(200)) AS Value, CAST(NULL AS INT) AS ExistingUserId
        WHERE 1 = 0; -- empty details result set
        RETURN;
    END

    ------------------------------------------------------------------------
    -- Collect conflicts in a table variable
    ------------------------------------------------------------------------
    DECLARE @Conflicts TABLE
    (
        Field          NVARCHAR(50),
        Value          NVARCHAR(200),
        ExistingUserId INT
    );

    ------------------------------------------------------------------------
    -- Lookups (exclude soft-deleted; exclude same @UserId when updating)
    ------------------------------------------------------------------------
    IF @AadharNumber IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId)
        SELECT 'AadharNumber', @AadharNumber, U.UserId
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.AadharNumber = @AadharNumber
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    IF @PanNumber IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId)
        SELECT 'PanNumber', @PanNumber, U.UserId
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.PanNumber = @PanNumber
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    IF @EmailId IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId)
        SELECT 'EmailId', @EmailId, U.UserId
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.EmailId = @EmailId
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    IF @MobileNo IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId)
        SELECT 'MobileNo', @MobileNo, U.UserId
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.MobileNo = @MobileNo
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    ------------------------------------------------------------------------
    -- BRANCH: CREATE vs UPDATE
    ------------------------------------------------------------------------
    IF @UserId IS NULL
    BEGIN
        --------------------------------------------------------------------
        -- CREATE flow
        --------------------------------------------------------------------
        IF NOT EXISTS (SELECT 1 FROM @Conflicts)
        BEGIN
            SELECT 'OK' AS StatusCode, 'Validation successful. No duplicates found.' AS Message, NULL AS MatchedUserId;
            SELECT CAST(NULL AS NVARCHAR(50)) AS Field, CAST(NULL AS NVARCHAR(200)) AS Value, CAST(NULL AS INT) AS ExistingUserId
            WHERE 1 = 0;
            RETURN;
        END

        --------------------------------------------------------------------
        -- There are conflicts. Are they all pointing to the same existing user?
        --------------------------------------------------------------------
        DECLARE @DistinctUserCount INT;
        SELECT @DistinctUserCount = COUNT(*) FROM (SELECT DISTINCT ExistingUserId FROM @Conflicts) AS T;

        IF @DistinctUserCount = 1
        BEGIN
            DECLARE @ExistingUserId INT;
            SELECT TOP 1 @ExistingUserId = ExistingUserId FROM (SELECT DISTINCT ExistingUserId FROM @Conflicts) AS T;

            SELECT 'USER_ALREADY_EXISTS' AS StatusCode,
                   'Account already exists with the provided identifier(s). Please login.' AS Message,
                   @ExistingUserId AS MatchedUserId;

            SELECT Field, Value, ExistingUserId FROM @Conflicts;
            RETURN;
        END
        ELSE
        BEGIN
            -- Collides with multiple different users (serious conflict)
            SELECT 'DUPLICATE_ON_CREATE' AS StatusCode,
                   'One or more identifiers are already in use by other user(s).' AS Message,
                   NULL AS MatchedUserId;

            SELECT Field, Value, ExistingUserId FROM @Conflicts;
            RETURN;
        END
    END
    ELSE
    BEGIN
        --------------------------------------------------------------------
        -- UPDATE flow
        --------------------------------------------------------------------
        IF EXISTS (SELECT 1 FROM @Conflicts)
        BEGIN
            SELECT 'DUPLICATE_ON_UPDATE' AS StatusCode,
                   'One or more identifiers are already used by another user.' AS Message,
                   @UserId AS MatchedUserId;

            SELECT Field, Value, ExistingUserId FROM @Conflicts;
            RETURN;
        END

        -- No conflicts found for update
        SELECT 'OK' AS StatusCode, 'Validation successful. No duplicates found.' AS Message, @UserId AS MatchedUserId;
        SELECT CAST(NULL AS NVARCHAR(50)) AS Field, CAST(NULL AS NVARCHAR(200)) AS Value, CAST(NULL AS INT) AS ExistingUserId
        WHERE 1 = 0;
        RETURN;
    END
END;
GO
/****** Object:  StoredProcedure [dbo].[UserMaster_ValidateUniqueIdentities4]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
EXEC [dbo].[UserMaster_ValidateUniqueIdentities]
    @UserId        = NULL,                 -- NULL => Create
    @AadharNumber  = '342345675610',
    @PanNumber     = 'ABCDE0010F',
    @EmailId       = 'user10@test.com',
    @MobileNo      = '9876543299';
*/

/***************************************************************
 Purpose:
  - Validate uniqueness of Aadhar, PAN, Email and Mobile for create/update flows.
  - Return structured status + detailed conflicts with friendly messages.
 Notes:
  - Compares PAN case-insensitively (converted to upper).
  - Compares Email case-insensitively (converted to lower).
  - Ignores soft-deleted rows (IsDeleted = 1).
  - If @UserId IS NULL => CREATE flow.
    * If conflicts all belong to same existing user => USER_ALREADY_EXISTS + MatchedUserId.
    * Else => DUPLICATE_ON_CREATE + conflict rows.
  - If @UserId IS NOT NULL => UPDATE flow.
    * If any conflict present (belongs to other user) => DUPLICATE_ON_UPDATE + conflict rows.
    * Else OK.
****************************************************************/

CREATE   PROCEDURE [dbo].[UserMaster_ValidateUniqueIdentities4]
(
    @UserId        INT             = NULL,            -- NULL => create, not NULL => update
    @AadharNumber  NVARCHAR(20)    = NULL,
    @PanNumber     NVARCHAR(20)    = NULL,
    @EmailId       NVARCHAR(150)   = NULL,
    @MobileNo      NVARCHAR(15)    = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    ------------------------------------------------------------------------
    -- Normalize inputs
    ------------------------------------------------------------------------
    SET @PanNumber = NULLIF(LTRIM(RTRIM(@PanNumber)), '');
    IF @PanNumber IS NOT NULL SET @PanNumber = UPPER(@PanNumber);

    SET @EmailId = NULLIF(LTRIM(RTRIM(@EmailId)), '');
    DECLARE @EmailLower NVARCHAR(150) = NULL;
    IF @EmailId IS NOT NULL SET @EmailLower = LOWER(@EmailId);

    SET @AadharNumber = NULLIF(LTRIM(RTRIM(@AadharNumber)), '');
    SET @MobileNo     = NULLIF(LTRIM(RTRIM(@MobileNo)), '');

    ------------------------------------------------------------------------
    -- Guard: require at least one identifier
    ------------------------------------------------------------------------
    IF @AadharNumber IS NULL AND @PanNumber IS NULL AND @EmailId IS NULL AND @MobileNo IS NULL
    BEGIN
        SELECT 'INPUT_ERROR' AS StatusCode,
               'Provide at least one identifier (Aadhaar / PAN / Email / Mobile).' AS Message,
               NULL AS MatchedUserId;

        SELECT CAST(NULL AS NVARCHAR(50)) AS Field,
               CAST(NULL AS NVARCHAR(200)) AS Value,
               CAST(NULL AS INT) AS ExistingUserId,
               CAST(NULL AS NVARCHAR(400)) AS ErrorText
        WHERE 1 = 0;
        RETURN;
    END

    ------------------------------------------------------------------------
    -- Collect conflicts
    ------------------------------------------------------------------------
    DECLARE @Conflicts TABLE
    (
        Field          NVARCHAR(50),
        Value          NVARCHAR(200),
        ExistingUserId INT,
        ErrorText      NVARCHAR(400)
    );

    -- Aadhaar
    IF @AadharNumber IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId, ErrorText)
        SELECT 'AadharNumber', @AadharNumber, U.UserId,
               'Aadhaar number ' + @AadharNumber + ' is already associated with another user (UserId: ' + CAST(U.UserId AS NVARCHAR(20)) + ').'
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.AadharNumber = @AadharNumber
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    -- PAN
    IF @PanNumber IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId, ErrorText)
        SELECT 'PanNumber', @PanNumber, U.UserId,
               'PAN ' + @PanNumber + ' is already associated with another user (UserId: ' + CAST(U.UserId AS NVARCHAR(20)) + ').'
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.PanNumber = @PanNumber
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    -- Email (case-insensitive using LOWER)
    IF @EmailLower IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId, ErrorText)
        SELECT 'EmailId', @EmailId, U.UserId,
               'Email ' + @EmailId + ' is already associated with another user (UserId: ' + CAST(U.UserId AS NVARCHAR(20)) + ').'
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND LOWER(ISNULL(U.EmailId, '')) = @EmailLower
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    -- Mobile
    IF @MobileNo IS NOT NULL
    BEGIN
        INSERT INTO @Conflicts(Field, Value, ExistingUserId, ErrorText)
        SELECT 'MobileNo', @MobileNo, U.UserId,
               'Mobile number ' + @MobileNo + ' is already associated with another user (UserId: ' + CAST(U.UserId AS NVARCHAR(20)) + ').'
        FROM dbo.UserMaster AS U
        WHERE U.IsDeleted = 0
          AND U.MobileNo = @MobileNo
          AND (@UserId IS NULL OR U.UserId <> @UserId);
    END

    ------------------------------------------------------------------------
    -- CREATE vs UPDATE logic
    ------------------------------------------------------------------------
    IF @UserId IS NULL
    BEGIN
        -- CREATE flow
        IF NOT EXISTS (SELECT 1 FROM @Conflicts)
        BEGIN
            SELECT 'OK' AS StatusCode, 'Validation successful. No duplicates found.' AS Message, NULL AS MatchedUserId;
            SELECT CAST(NULL AS NVARCHAR(50)) AS Field, CAST(NULL AS NVARCHAR(200)) AS Value, CAST(NULL AS INT) AS ExistingUserId, CAST(NULL AS NVARCHAR(400)) AS ErrorText
            WHERE 1 = 0;
            RETURN;
        END

        -- Count distinct existing users referenced by conflicts
        DECLARE @DistinctUserCount INT;
        SELECT @DistinctUserCount = COUNT(DISTINCT ExistingUserId) FROM @Conflicts;

        IF @DistinctUserCount = 1
        BEGIN
            DECLARE @ExistingUserId INT;
            SELECT TOP 1 @ExistingUserId = ExistingUserId FROM @Conflicts;

            -- If all conflicts point to same user => that account already exists
            SELECT 'USER_ALREADY_EXISTS' AS StatusCode,
                   'An account already exists with one or more of the provided identifiers. Please login or link to existing account.' AS Message,
                   @ExistingUserId AS MatchedUserId;

            SELECT Field, Value, ExistingUserId, ErrorText FROM @Conflicts;
            RETURN;
        END
        ELSE
        BEGIN
            -- Collides with multiple users => data conflict
            SELECT 'DUPLICATE_ON_CREATE' AS StatusCode,
                   'One or more identifiers are already used by other user(s). Please correct the highlighted fields.' AS Message,
                   NULL AS MatchedUserId;

            SELECT Field, Value, ExistingUserId, ErrorText FROM @Conflicts;
            RETURN;
        END
    END
    ELSE
    BEGIN
        -- UPDATE flow
        IF EXISTS (SELECT 1 FROM @Conflicts)
        BEGIN
            SELECT 'DUPLICATE_ON_UPDATE' AS StatusCode,
                   'One or more identifiers are already used by another user. You cannot assign identifiers owned by others.' AS Message,
                   @UserId AS MatchedUserId;

            SELECT Field, Value, ExistingUserId, ErrorText FROM @Conflicts;
            RETURN;
        END

        -- No conflicts for update
        SELECT 'OK' AS StatusCode, 'Validation successful. No duplicates found.' AS Message, @UserId AS MatchedUserId;
        SELECT CAST(NULL AS NVARCHAR(50)) AS Field, CAST(NULL AS NVARCHAR(200)) AS Value, CAST(NULL AS INT) AS ExistingUserId, CAST(NULL AS NVARCHAR(400)) AS ErrorText
        WHERE 1 = 0;
        RETURN;
    END
END;
GO
/****** Object:  StoredProcedure [dbo].[UserPermission_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserPermission_Create]
(
    @FeatureId INT,
    @SoftwareId INT,
    @SubRoleId INT,
    @FAccess INT, 
    @ActionUser VARCHAR(50)
)
AS
BEGIN
  
	DECLARE @PermissionId INT = 0;

    INSERT INTO [dbo].[UserPermission]
    (
        FeatureId, SubRoleId, FAccess, IsActive, IsDeleted, CreatedBy, CreatedOn
    )
    VALUES
    (
        @FeatureId, @SubRoleId,  @FAccess,  1,  0,  @ActionUser,  GETDATE()
    );


	SELECT @PermissionId = SCOPE_IDENTITY();

    SELECT 
        PermissionId,
        FeatureId,
        SubRoleId,
        FAccess,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [dbo].[UserPermission]
    WHERE PermissionId = @PermissionId;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserPermission_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserPermission_Delete]
(
    @PermissionId INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN

    UPDATE [dbo].[UserPermission]
    SET IsDeleted = 1,
	   [IsActive]=0,
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()
    WHERE PermissionId = @PermissionId;

END;
GO
/****** Object:  StoredProcedure [dbo].[UserPermission_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserPermission_ReadAll]
AS
BEGIN

    SELECT 
        PermissionId,
        FeatureId,
        SubRoleId,
        FAccess,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [dbo].[UserPermission]
    WHERE [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserPermission_ReadByFeatureId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserPermission_ReadByFeatureId]
(
    @FeatureId INT
)
AS
BEGIN

    SELECT 
        A.PermissionId,
        A.FeatureId,
        A.SubRoleId,
        A.FAccess,
        A.IsActive,
        A.IsDeleted,
        CASE WHEN B.UserId IS NULL THEN A.CreatedBy 
	    ELSE (ISNULL(B.FirstName + ' ','') + ISNULL(B.LastName,''))		   
	    END AS CreatedBy,
        A.CreatedOn,
        A.ModifiedBy,
        A.ModifiedOn
    FROM [dbo].[UserPermission] A
	LEFT OUTER JOIN [AdvinMaster].dbo.UserMaster B WITH (NOLOCK)
	ON A.CreatedBy = CONVERT(VARCHAR(50),B.UserId)
    WHERE A.FeatureId = @FeatureId
	AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserPermission_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserPermission_ReadById]
(
    @PermissionId INT
)
AS
BEGIN

    SELECT 
        PermissionId,
        FeatureId,
        SubRoleId,
        FAccess,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [dbo].[UserPermission]
    WHERE PermissionId = @PermissionId
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserPermission_ReadBySubRoleId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--[dbo].[UserPermission_ReadBySubRoleId]448
CREATE   PROCEDURE [dbo].[UserPermission_ReadBySubRoleId]
(
    @SubRoleId INT
)
AS
BEGIN

    SELECT 
        A.PermissionId,
        A.FeatureId,
        A.SubRoleId,
        A.FAccess,
        A.IsActive,
        A.IsDeleted,
        CASE WHEN B.UserId IS NULL THEN A.CreatedBy 
	    ELSE (ISNULL(B.FirstName + ' ','') + ISNULL(B.LastName,''))		   
	    END AS CreatedBy,
        A.CreatedOn,
        A.ModifiedBy,
        A.ModifiedOn
    FROM [dbo].[UserPermission] A
	LEFT OUTER JOIN dbo.UserMaster B WITH (NOLOCK)
	ON A.CreatedBy = CONVERT(VARCHAR(50),B.UserId)
	LEFT OUTER JOIN [dbo].[SubRoles] D
	ON A.SubRoleId = D.SubRoleId
    WHERE D.SubRoleId = @SubRoleId
	AND A.[IsDeleted] = 0 AND D.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserPermission_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
	EXEC UserPermission_ReadByUserId 2,"MP"
*/
CREATE   PROCEDURE [dbo].[UserPermission_ReadByUserId]
(
	@UserId INT,
	@MenuCode VARCHAR(20)
)
AS
BEGIN

	SELECT Y.FName, Y.FCode, ISNULL(X.FAccess,0) FAccess
	FROM dbo.MenuFeature Y 
	LEFT OUTER JOIN (
					SELECT G.*
					FROM dbo.UserPermission G
					WHERE G.SubRoleId IN (
						SELECT C.SubRoleId
						FROM dbo.UserRoles A
						LEFT OUTER JOIN dbo.Roles B
						ON A.RoleId = B.RoleId
						LEFT OUTER JOIN dbo.SubRoles C
						ON A.RoleId = C.RoleId
						WHERE A.UserId = @UserId 
						AND C.SubRoleCode = @MenuCode
						AND A.IsDeleted = 0 AND B.IsDeleted = 0 AND C.IsDeleted = 0
						) AND IsDeleted = 0
	) X
	ON X.FeatureId = Y.FeatureId
	WHERE Y.MenuId IN (
						SELECT C.MenuId
						FROM dbo.UserRoles A
						LEFT OUTER JOIN dbo.Roles B
						ON A.RoleId = B.RoleId
						LEFT OUTER JOIN dbo.SubRoles C
						ON A.RoleId = C.RoleId
						WHERE A.UserId = @UserId
						AND C.SubRoleCode = @MenuCode
						AND A.IsDeleted = 0 AND B.IsDeleted = 0 AND C.IsDeleted = 0
						);
	
END
GO
/****** Object:  StoredProcedure [dbo].[UserPermission_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserPermission_Update]
(
    @PermissionId INT,
    @FeatureId INT,
    @SubRoleId INT,
    @FAccess VARCHAR(50),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN

    UPDATE [dbo].[UserPermission]
    SET FeatureId = @FeatureId,
        SubRoleId = @SubRoleId,
        FAccess = @FAccess,
        IsActive = @IsActive,
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()
    WHERE PermissionId = @PermissionId;

    SELECT 
        PermissionId,
        FeatureId,
        SubRoleId,
        FAccess,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [dbo].[UserPermission]
    WHERE PermissionId = @PermissionId;
END;
GO
/****** Object:  StoredProcedure [dbo].[UserRole_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [dbo].[UserRole_Create]
    @UserId = 1,      
    @RoleId = 1,     
    @ActionUser = '4';

*/
CREATE   PROCEDURE [dbo].[UserRole_Create]
(
	@UserId INT ,
	@RoleId INT ,
	@ActionUser VARCHAR(50) 
	
)
AS
BEGIN

	DECLARE @UserRoleId INT = 0;

	IF NOT EXISTS (
		SELECT 1 FROM dbo.UserRoles 
		WHERE UserId = @UserId 
			AND RoleId = @RoleId 
			AND IsActive = 1 
			AND IsDeleted = 0
	) 
	AND @UserId <> 0 
	AND @RoleId <> 0
	BEGIN
		INSERT INTO UserRoles
		( UserId, RoleId,IsActive,CreatedBy,CreatedOn,ModifiedBy,ModifiedOn,IsDeleted)
		VALUES
		( @UserId,@RoleId,1,@ActionUser,GETDATE(),NULL,NULL,0);

		SELECT @UserRoleId = SCOPE_IDENTITY();

		SELECT A.[UserRoleId]
		  ,A.[RoleId]
		  ,B.RoleName
		  ,A.[UserId]
		  ,A.[IsActive]
		  ,A.[CreatedBy]
		  ,A.[CreatedOn]
		  ,A.[ModifiedBy]
		  ,A.[ModifiedOn]
		  ,A.[IsDeleted]
		FROM [dbo].[UserRoles] A
		LEFT OUTER JOIN [dbo].[Roles] B
		ON A.RoleId = B.RoleId
		WHERE UserRoleId = @UserRoleId
	END
	ELSE
	BEGIN
		RAISERROR('User already has this Role assigned!',16,1);
	END

END
GO
/****** Object:  StoredProcedure [dbo].[UserRole_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserRole_Delete]
(
	@UserRoleId INT,
	@ActionUser VARCHAR(50) 
	
)
AS
BEGIN

	UPDATE UserRoles
	SET IsActive = 0,
	   IsDeleted = 1,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE UserRoleId = @UserRoleId
END
GO
/****** Object:  StoredProcedure [dbo].[UserRole_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserRole_ReadAll]
AS
BEGIN

	SELECT A.[UserRoleId]
		  ,A.[RoleId]
		  ,A.[UserId]
		  ,A.[IsActive]
		  ,CASE WHEN B.UserId IS NULL THEN A.CreatedBy 
		   ELSE (ISNULL(B.FirstName + ' ','') + ISNULL(B.LastName,''))		   
		   END AS CreatedBy
		  ,A.[CreatedOn]
		  ,A.[ModifiedBy]
		  ,A.[ModifiedOn]
		  ,A.[IsDeleted]
		  ,C.[RoleName]
	FROM [dbo].[UserRoles] A
	LEFT OUTER JOIN dbo.UserMaster B WITH (NOLOCK)
	ON A.CreatedBy = CONVERT(VARCHAR(50),B.UserId)
	LEFT OUTER JOIN [dbo].[Roles] C
	ON A.RoleId = C.RoleId
	WHERE A.[IsDeleted] = 0
END
GO
/****** Object:  StoredProcedure [dbo].[UserRole_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*

[dbo].[UserRole_ReadByUserId] 1, 1

*/
CREATE   PROCEDURE [dbo].[UserRole_ReadByUserId]
(
	@UserId INT
)
AS
BEGIN

	SELECT A.[UserRoleId]
		  ,A.[RoleId]
		  ,A.[UserId]
		  ,A.[IsActive]
		  ,CASE WHEN B.UserId IS NULL THEN A.CreatedBy 
		   ELSE (ISNULL(B.FirstName + ' ','') + ISNULL(B.LastName,''))		   
		   END AS CreatedBy
		  ,A.[CreatedOn]
		  ,A.[ModifiedBy]
		  ,A.[ModifiedOn]
		  ,A.[IsDeleted]
		  ,C.[RoleName]
	FROM [dbo].[UserRoles] A
	LEFT OUTER JOIN dbo.UserMaster B WITH (NOLOCK)
	ON A.CreatedBy = CONVERT(VARCHAR(50),B.UserId)
	LEFT OUTER JOIN [dbo].[Roles] C
	ON A.RoleId = C.RoleId
	WHERE A.UserId = @UserId AND A.[IsDeleted] = 0
END
GO
/****** Object:  StoredProcedure [dbo].[UserRole_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[UserRole_Update]
(
	@UserRoleId INT,
	@UserId INT ,
	@RoleId INT ,
	@IsActive INT,
	@ActionUser VARCHAR(50) 
	
)
AS
BEGIN

	UPDATE UserRoles
	SET IsActive = @IsActive,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE(),
		UserId = @UserId,
		RoleId = @RoleId
	WHERE UserRoleId = @UserRoleId

	SELECT [UserRoleId]
      ,[RoleId]
      ,[UserId]
      ,[IsActive]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[IsDeleted]
	FROM [dbo].[UserRoles]
	WHERE UserRoleId = @UserRoleId
END
GO
/****** Object:  StoredProcedure [dbo].[ValidateUserLogin]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
ValidateUserLogin 'full','ddec5c47fe188afdf061495dc431e21c','1'
*/
CREATE   PROCEDURE [dbo].[ValidateUserLogin]
(
	@UserName VARCHAR(50),
	@UserPassword VARCHAR(500)
)
AS
BEGIN
	DECLARE @ResponseCode INT, @ResponseDescription VARCHAR(500), @UserId INT = -1, @LogStatus VARCHAR(10) = 'FAILED';

	IF EXISTS (SELECT 1 FROM UserLogin A WITH (NOLOCK) 
						INNER JOIN dbo.UserMaster B WITH (NOLOCK) 
						ON A.UserId = B.UserId
						WHERE UserName = @UserName AND UserPassword <> @UserPassword)
	BEGIN
		RAISERROR('User entered wrong Password',16,1);
	END
	ELSE IF NOT EXISTS (SELECT 1 FROM UserLogin A WITH (NOLOCK) 
						INNER JOIN dbo.UserMaster B WITH (NOLOCK) 
						ON A.UserId = B.UserId
						WHERE UserName = @UserName AND UserPassword = @UserPassword)
	BEGIN
		RAISERROR('User Login not exists',16,1);
	END
	ELSE IF EXISTS (SELECT 1 FROM UserLogin A WITH (NOLOCK) 
						INNER JOIN dbo.UserMaster B WITH (NOLOCK) 
						ON A.UserId = B.UserId WHERE UserName = @UserName AND UserPassword = @UserPassword AND A.IsActive = 0)
	BEGIN
		RAISERROR('User Login is disabled',16,1);
	END
	ELSE IF EXISTS (SELECT 1 
					FROM UserLogin A WITH (NOLOCK) 
					LEFT OUTER JOIN UserMaster B WITH (NOLOCK)
					ON A.UserId = B.UserId 
					WHERE UserName = @UserName AND UserPassword = @UserPassword AND A.IsActive = 1 AND B.IsActive = 0 AND B.IsDeleted = 0 )
	BEGIN
		RAISERROR('User is disabled',16,1);
	END
	ELSE IF EXISTS (SELECT 1 
					FROM UserLogin A WITH (NOLOCK) 
					LEFT OUTER JOIN UserMaster B WITH (NOLOCK)
					ON A.UserId = B.UserId
					WHERE UserName = @UserName AND UserPassword = @UserPassword AND A.IsActive = 1 AND B.IsDeleted = 1 )
	BEGIN
		RAISERROR('User is deleted',16,1);
	END
	ELSE IF EXISTS (SELECT 1 
				FROM UserLogin A WITH (NOLOCK) 
				LEFT OUTER JOIN UserMaster B WITH (NOLOCK)
				ON A.UserId = B.UserId
				WHERE UserName = @UserName AND UserPassword = @UserPassword AND A.IsActive = 1 AND B.IsActive = 1 AND B.IsDeleted = 0 AND A.Status = 'Expired')
	BEGIN
	SELECT @ResponseCode = 403, @ResponseDescription = 'User Login Expired!!';
		
	SELECT @UserId = UserId, @LogStatus = 'Password Expired'
	FROM UserLogin WITH (NOLOCK)
	WHERE UserName = @UserName AND UserPassword = @UserPassword;

	UPDATE UserLogin SET LastLoggedDate = GETDATE() WHERE UserId = @UserId;

	END
	ELSE IF EXISTS (SELECT 1 
					FROM UserLogin A WITH (NOLOCK) 
					LEFT OUTER JOIN UserMaster B WITH (NOLOCK)
					ON A.UserId = B.UserId
					WHERE UserName = @UserName AND UserPassword = @UserPassword AND A.IsActive = 1 AND B.IsActive = 1 AND B.IsDeleted = 0 )
	BEGIN
		SELECT @ResponseCode = 200, @ResponseDescription = 'User Login Success!!';
		
		SELECT @UserId = UserId, @LogStatus = 'SUCCESS'
		FROM UserLogin WITH (NOLOCK)
		WHERE UserName = @UserName AND UserPassword = @UserPassword;

		UPDATE UserLogin SET LastLoggedDate = GETDATE() WHERE UserId = @UserId;

	END

	HANDLER:
	BEGIN
		INSERT INTO dbo.UserLoginLog (UserId, UserName, UserPassword, LoggedTime, LogStatus, LogDescription) 
		VALUES (@UserId, @UserName, @UserPassword, GETDATE(), @LogStatus, @ResponseDescription);

		DECLARE @DefaultCompanyId VARCHAR(500);
		SELECT @DefaultCompanyId = 1;

		SELECT A.ResponseCode, A.ResponseDescription,B.*,C.RoleIds RoleId,@DefaultCompanyId DefaultCompanyId 
		FROM (
			SELECT @ResponseCode ResponseCode, @ResponseDescription ResponseDescription, @UserId UserId
		) A
		LEFT OUTER JOIN dbo.UserMaster B WITH (NOLOCK) 
		ON A.UserId = B.UserId
		LEFT OUTER JOIN (
						SELECT  
						t.UserId,
						STUFF((
							SELECT ', ' + CAST(A.RoleId AS VARCHAR(10))
							FROM UserRoles A
							WHERE A.UserId = t.UserId AND A.IsActive = 1
							FOR XML PATH(''), TYPE
						).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS RoleIds
						
						FROM UserRoles t
						GROUP BY 
							t.UserId
		) C
		ON A.UserId = C.UserId
	END
END

GO
/****** Object:  StoredProcedure [dbo].[ValueList_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [dbo].[ValueList_Create]
    @VlCode = 'TEST001',
    @VlName = 'Test ValueList',
    @VlDesc = 'This is a test entry for ValueList.',
    @ActionUser = '4'

	*/

CREATE   PROCEDURE [dbo].[ValueList_Create]
(
	  @VlCode VARCHAR(50)
	 ,@VlName VARCHAR(200)
	 ,@VlDesc VARCHAR(500)
	 ,@ModuleName VARCHAR(50)
	 ,@ActionUser VARCHAR(50)
)
AS
BEGIN
	DECLARE @ValueListId INT = 0;

    IF NOT EXISTS (SELECT 1 FROM [dbo].[ValueList] WHERE VlCode = @VlCode)
	BEGIN


	INSERT INTO [dbo].[ValueList]
	([VlCode]      ,[VlName]      ,[VlDesc] 	,[ModuleName],     [IsActive]      ,[CreatedBy]      ,[CreatedOn]      ,[IsDeleted]
	)
	VALUES
	(
		@VlCode,	@VlName,	@VlDesc,	@ModuleName,	1,	@ActionUser,	GETDATE(),	0
	)

	SELECT @ValueListId = SCOPE_IDENTITY();

	SELECT 
			 [ValueListId]
			,[VlCode]
			,[VlName]
			,[VlDesc]
			,[ModuleName]
			,[IsActive]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
			,[IsDeleted]
	FROM [dbo].[ValueList]
	WHERE ValueListId = @ValueListId;
END
		ELSE
		BEGIN
			RAISERROR ('VlCode already exists.', 16, 1);
			RETURN;
		END
END;




GO
/****** Object:  StoredProcedure [dbo].[ValueList_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[ValueList_Delete]
(
	 @ValueListId INT
	,@ActionUser VARCHAR(50)
)
AS
BEGIN
	
	UPDATE [dbo].[ValueList]
	SET 
	     [IsActive] = 0,
		 [IsDeleted] = 1,
	     [ModifiedBy] = @ActionUser,
		 [ModifiedOn] = GETDATE()
	WHERE ValueListId = @ValueListId;	
END
GO
/****** Object:  StoredProcedure [dbo].[ValueList_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[ValueList_ReadAll]
AS
BEGIN
	SELECT
	       [ValueListId]
		,A.[VlCode]
		,A.[VlName]
		,A.[VlDesc]
		,A.[ModuleName]
		,A.[IsActive]
		,CASE WHEN B.UserId IS NULL THEN A.CreatedBy 
			   ELSE (ISNULL(B.FirstName + ' ','') + ISNULL(B.LastName,''))		   
			   END AS CreatedBy
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
		,A.[IsDeleted]
	FROM [dbo].[ValueList] A
	LEFT OUTER JOIN dbo.UserMaster B WITH (NOLOCK)
	ON A.CreatedBy = CONVERT(VARCHAR(50),B.UserId)
	WHERE A.[IsActive] =1
	ORDER BY ValueListId ASC;

END
GO
/****** Object:  StoredProcedure [dbo].[ValueList_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[ValueList_ReadById]
(
	@ValueListId INT
)
AS
BEGIN
	SELECT 
	     [ValueListId]
		,[VlCode]
		,[VlName]
		,[VlDesc]
		,[ModuleName]
		,[IsActive]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[IsDeleted]
	FROM [dbo].[ValueList]
	WHERE IsActive = 1
	AND ValueListId = @ValueListId;
END
GO
/****** Object:  StoredProcedure [dbo].[ValueList_ReadByModuleName]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[ValueList_ReadByModuleName]
(
    @ModuleName   VARCHAR(50)
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [ValueListId]
      ,[VlCode]
      ,[VlName]
      ,[VlDesc]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[ModuleName]
	  FROM[dbo].[ValueList]
	  WHERE [ModuleName] =@ModuleName
	  AND [IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [dbo].[ValueList_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[ValueList_Update]
(
	 @ValueListId INT
	,@VlCode VARCHAR(50)
	,@VlName VARCHAR(200)
	,@VlDesc VARCHAR(500)
	,@ModuleName VARCHAR(50)
	,@IsActive INT
	,@ActionUser VARCHAR(50)
)
AS
BEGIN
	UPDATE [dbo].[ValueList]
	SET 
	   [VlCode] = @VlCode
	  ,[VlName] = @VlName
	  ,[VlDesc] = @VlDesc
	  ,[ModuleName]  = @ModuleName
      ,[IsActive] = @IsActive
      ,[ModifiedBy] = @ActionUser
      ,[ModifiedOn] = GETDATE()
	WHERE [ValueListId] = @ValueListId;

	SELECT 
	     [ValueListId]
		,[VlCode]
		,[VlName]
		,[VlDesc]
		,[ModuleName]
		,[IsActive]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[IsDeleted]
  FROM [dbo].[ValueList]
  WHERE [ValueListId] = @ValueListId;
END
GO
/****** Object:  StoredProcedure [dbo].[ValueListItem_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [dbo].[ValueListItem_Create]
    @ValueListId = 1,               -- Replace with an actual ValueListId from your ValueList table
    @VliCode = 'ITEM001',
    @VliName = 'Test ValueList Item',
    @VliDesc = 'Description for test item',
    @DisplaySeq = 1,
    @AddField1 = 'ExtraField1',
    @AddField2 = 'ExtraField2',
    @AddField3 = 'ExtraField3',
    @ActionUser = '4'
	*/

CREATE   PROCEDURE [dbo].[ValueListItem_Create]
(
	@ValueListId INT,
	@VliCode VARCHAR(50),
	@VliName VARCHAR(200),
	@VliDesc VARCHAR(500),
	@DisplaySeq INT,
	@AddField1 VARCHAR(200),
	@AddField2 VARCHAR(200),
	@AddField3 VARCHAR(200),
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @ValueListItemId INT = 0;

	INSERT INTO [dbo].[ValueListItem]
	(
		[ValueListId],
		[VliCode],
		[VliName],
		[VliDesc],
		[DisplaySeq],
		[AddField1],
		[AddField2],
		[AddField3],
		[IsActive],
		[CreatedBy],
		[CreatedOn],
		[IsDeleted]
	)
	VALUES
	(
		@ValueListId,
		@VliCode,
		@VliName,
		@VliDesc,
		@DisplaySeq,
		@AddField1,
		@AddField2,
		@AddField3,
		1,               
		@ActionUser,     
		GETDATE(),        
		0                
	);

	SELECT @ValueListItemId = SCOPE_IDENTITY();

	SELECT 
		[ValueListItemId],
		[ValueListId],
		[VliCode],
		[VliName],
		[VliDesc],
		[DisplaySeq],
		[AddField1],
		[AddField2],
		[AddField3],
		[IsActive],
		[CreatedBy],
		[CreatedOn],
		[ModifiedBy],
		[ModifiedOn],
		[IsDeleted]
	FROM 
		[dbo].[ValueListItem]
	WHERE 
		[ValueListItemId] = @ValueListItemId;
END
GO
/****** Object:  StoredProcedure [dbo].[ValueListItem_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[ValueListItem_Delete]
(
		@ValueListItemId BIGINT,
		@ActionUser VARCHAR(50)
)
AS
BEGIN
	
	UPDATE [dbo].[ValueListItem]
	SET [ModifiedBy] = @ActionUser
      ,[ModifiedOn] = GETDATE()
	  ,[IsActive]=0
	  ,[IsDeleted] = 1

	WHERE [ValueListItemId] = @ValueListItemId;
	
END
GO
/****** Object:  StoredProcedure [dbo].[ValueListItem_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[ValueListItem_ReadById]
(
	@ValueListItemId BIGINT
)
AS
BEGIN
	SELECT 
	   [ValueListItemId]
	  ,[ValueListId]
	  ,[VliCode]
	  ,[VliName]
	  ,[VliDesc]
	  ,[DisplaySeq]
	  ,[AddField1]
	  ,[AddField2]
	  ,[AddField3]
      ,[IsActive]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[IsDeleted]
	FROM [dbo].[ValueListItem]
	WHERE IsActive = 1
	AND [ValueListItemId] = @ValueListItemId;

END
GO
/****** Object:  StoredProcedure [dbo].[ValueListItem_ReadByValueListId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[ValueListItem_ReadByValueListId]
(
	@ValueListId INT
)
AS
BEGIN
	SET NOCOUNT ON;

	SELECT 
	   [ValueListItemId]
	  ,[ValueListId]
	  ,[VliCode]
	  ,[VliName]
	  ,[VliDesc]
	  ,[DisplaySeq]
	  ,[AddField1]
	  ,[AddField2]
	  ,[AddField3]
      ,[IsActive]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[IsDeleted]
	FROM [dbo].[ValueListItem]
	WHERE IsDeleted = 0
	AND [ValueListId]  = @ValueListId;
END
GO
/****** Object:  StoredProcedure [dbo].[ValueListItem_ReadByVlCode]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[ValueListItem_ReadByVlCode]
(
	@VlCode VARCHAR(50)
)
AS
BEGIN
	DECLARE @ValueListId INT = 0;
	SELECT TOP 1 @ValueListId = ValueListId FROM dbo.ValueList WHERE VlCode = @VlCode;

	SELECT 
	   [ValueListItemId]
	  ,[ValueListId]
	  ,[VliCode]
	  ,[VliName]
	  ,[VliDesc]
	  ,[DisplaySeq]
	  ,[AddField1]
	  ,[AddField2]
	  ,[AddField3]
      ,[IsActive]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[IsDeleted]
	FROM [dbo].[ValueListItem]
	WHERE IsDeleted = 0
	AND [ValueListId]  = @ValueListId;
END
GO
/****** Object:  StoredProcedure [dbo].[ValueListItem_ReadByVlName]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[ValueListItem_ReadByVlName]
(
	@VlName VARCHAR(200)
)
AS
BEGIN

SET NOCOUNT ON;
	DECLARE @ValueListId INT = 0;
	SELECT TOP 1 @ValueListId = ValueListId FROM dbo.ValueList WHERE VlName = @VlName;

	SELECT
	   [ValueListItemId]
	  ,[ValueListId]
	  ,[VliCode]
	  ,[VliName]
	  ,[VliDesc]
	  ,[DisplaySeq]
	  ,[AddField1]
	  ,[AddField2]
	  ,[AddField3]
      ,[IsActive]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[IsDeleted]
	FROM [dbo].[ValueListItem]
	WHERE IsDeleted = 0
	AND [ValueListId]  = @ValueListId;
END
GO
/****** Object:  StoredProcedure [dbo].[ValueListItem_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[ValueListItem_Update]
(
	@ValueListId INT,
	@ValueListItemId INT, 
	@VliCode VARCHAR(50),
	@VliName VARCHAR(200),
	@VliDesc VARCHAR(500),
	@DisplaySeq INT,
	@AddField1 VARCHAR(200),
	@AddField2 VARCHAR(200),
	@AddField3 VARCHAR(200),
	@IsActive INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	UPDATE [dbo].[ValueListItem]
	SET 
		[ValueListId] = @ValueListId,     
		[VliCode] = @VliCode,
		[VliName] = @VliName,
		[VliDesc] = @VliDesc,
		[DisplaySeq] = @DisplaySeq,
		[AddField1] = @AddField1,
		[AddField2] = @AddField2,
		[AddField3] = @AddField3,
		[IsActive] = @IsActive,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE 
		[ValueListItemId] = @ValueListItemId;

	SELECT 
		[ValueListItemId],
		[ValueListId],                   
		[VliCode],
		[VliName],
		[VliDesc],
		[DisplaySeq],
		[AddField1],
		[AddField2],
		[AddField3],
		[IsActive],
		[CreatedBy],
		[CreatedOn],
		[ModifiedBy],
		[ModifiedOn],
		[IsDeleted]
	FROM 
		[dbo].[ValueListItem]
	WHERE 
		[ValueListItemId] = @ValueListItemId;
END
GO
/****** Object:  StoredProcedure [hm].[AppoinmentMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[AppoinmentMaster_Create]
(
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @Description    NVARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AppointmentId BIGINT;

    INSERT INTO [hm].[AppoinmentMaster]
    (
        [MasterType],
        [MasterId],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        TRIM(@MasterType),
        @MasterId,
        TRIM(@Description),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
         1,
         0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @AppointmentId = SCOPE_IDENTITY();

    SELECT 
	   [AppointmentId]
      ,[MasterType]
      ,[MasterId]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[AppoinmentMaster]
    WHERE [AppointmentId] = @AppointmentId;
END;
GO
/****** Object:  StoredProcedure [hm].[AppoinmentMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[AppoinmentMaster_Delete]
(
   @AppointmentId BIGINT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[AppoinmentMaster]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [AppointmentId] = @AppointmentId
END;
GO
/****** Object:  StoredProcedure [hm].[AppoinmentMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[AppoinmentMaster_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AppointmentId]
      ,[MasterType]
      ,[masterId]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[AppoinmentMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[AppoinmentMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[AppoinmentMaster_ReadById]
(
   @AppointmentId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AppointmentId]
      ,[MasterType]
      ,[masterId]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[AppoinmentMaster]
	  WHERE [AppointmentId] = @AppointmentId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[AppoinmentMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[AppoinmentMaster_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AppointmentId]
      ,[MasterType]
      ,[MasterId]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[AppoinmentMaster]
	  WHERE [MasterId] = @MasterId
	  AND[MasterType] = @MasterType
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[AppoinmentMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[AppoinmentMaster_Update]
(
    @AppointmentId  BIGINT,
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @Description    NVARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[AppoinmentMaster]
    SET
        [MasterType]    = TRIM(@MasterType),
        [MasterId]      = @MasterId,
        [Description]   = TRIM(@Description),
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [AppointmentId] = @AppointmentId;

    SELECT 
        [AppointmentId],
        [MasterType],
        [MasterId],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[AppoinmentMaster]
    WHERE [AppointmentId] = @AppointmentId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[AppoinmentScheduleMaster_GetAppointmentsByDate]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[AppoinmentScheduleMaster_GetAppointmentsByDate]
(
      @DoctorId INT,
      @Date DATE
)
AS
BEGIN
    SET NOCOUNT ON;


    DECLARE @DoctorName VARCHAR(200);

    SELECT TOP 1
        @DoctorName =
            CASE 
                WHEN Description IS NULL THEN 'Unknown Doctor'
                WHEN CHARINDEX(',', Description) > 0 
                    THEN LTRIM(RTRIM(LEFT(Description, CHARINDEX(',', Description) - 1)))
                ELSE LTRIM(RTRIM(Description))
            END
    FROM hm.AppoinmentMaster
    WHERE MasterType = 'Doctor'
      AND MasterId = @DoctorId;

    IF @DoctorName IS NULL
        SET @DoctorName = 'Unknown Doctor';


  
    SELECT
        asm.AppointmentId,
        asm.PatientId,

        LTRIM(RTRIM(
            CONCAT(
                um.FirstName, 
                CASE WHEN um.MiddleName IS NOT NULL AND um.MiddleName <> '' 
                     THEN ' ' + um.MiddleName ELSE '' END,
                CASE WHEN um.LastName IS NOT NULL AND um.LastName <> '' 
                     THEN ' ' + um.LastName ELSE '' END
            )
        )) AS PatientName,

        asm.ServiceId,
        asm.DoctorId,
        @DoctorName AS DoctorFullName,
        asm.AppointmentType,
        asm.AppointmentDate,
        asm.AppointmentTime,
        asm.ConsultationMode,
        asm.AppointmentDuration,
        asm.Status,
        asm.IsFirstVisit,
        asm.TokenNo,
        asm.Description
    FROM hm.AppointmentScheduleMaster asm
    LEFT JOIN dbo.UserMaster um 
        ON asm.PatientId = um.UserId
    WHERE asm.DoctorId = @DoctorId
      AND asm.IsActive = 1
      AND asm.IsDeleted = 0
      AND CAST(asm.AppointmentDate AS DATE) = @Date
    ORDER BY asm.AppointmentTime;

END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentDetail_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[AppointmentDetail_Create]
(
    @AppointmentId        BIGINT,
    @AppointmentDay       VARCHAR(15),
    @StartTime            TIME,
    @EndTime              TIME,
    @AppointmentDuration  INT,
    @OtherDetail1         VARCHAR(50),
    @OtherDetail2         VARCHAR(50),
    @OtherDetail3         VARCHAR(100),
    @OtherDetail4         VARCHAR(100),
    @OtherDetail5         VARCHAR(500),
    @OtherDetail6         VARCHAR(500),
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId BIGINT;

    INSERT INTO [hm].[AppointmentDetail]
    (
        [AppointmentId],
        [AppointmentDay],
        [StartTime],
        [EndTime],
        [AppointmentDuration],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @AppointmentId,
        TRIM(@AppointmentDay),
        @StartTime,
        @EndTime,
        @AppointmentDuration,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT 
        [DetailId],
        [AppointmentId],
        [AppointmentDay],
        [StartTime],
        [EndTime],
        [AppointmentDuration],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[AppointmentDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentDetail_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[AppointmentDetail_Delete]
(
    @DetailId BIGINT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [hm].[AppointmentDetail]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentDetail_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[AppointmentDetail_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[AppointmentId]
      ,[AppointmentDay]
      ,[StartTime]
      ,[EndTime]
      ,[AppointmentDuration]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[AppointmentDetail]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentDetail_ReadByAppointmentId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[AppointmentDetail_ReadByAppointmentId]
(
    @AppointmentId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[AppointmentId]
      ,[AppointmentDay]
      ,[StartTime]
      ,[EndTime]
      ,[AppointmentDuration]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[AppointmentDetail]
	  WHERE [AppointmentId] = @AppointmentId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentDetail_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[AppointmentDetail_ReadById]
(
    @DetailId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[AppointmentId]
      ,[AppointmentDay]
      ,[StartTime]
      ,[EndTime]
      ,[AppointmentDuration]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[AppointmentDetail]
	  WHERE [DetailId] = @DetailId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentDetail_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[AppointmentDetail_Update]
(
    @DetailId           BIGINT,
    @AppointmentId        BIGINT,
    @AppointmentDay       VARCHAR(15),
    @StartTime            TIME,
    @EndTime              TIME,
    @AppointmentDuration  INT,
    @OtherDetail1         VARCHAR(50),
    @OtherDetail2         VARCHAR(50),
    @OtherDetail3         VARCHAR(100),
    @OtherDetail4         VARCHAR(100),
    @OtherDetail5         VARCHAR(500),
    @OtherDetail6         VARCHAR(500),
    @IsActive             INT,
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[AppointmentDetail]
    SET
        [AppointmentId]        = @AppointmentId,
        [AppointmentDay]       = TRIM(@AppointmentDay),
        [StartTime]            = @StartTime,
        [EndTime]              = @EndTime,
        [AppointmentDuration]  = @AppointmentDuration,
        [OtherDetail1]         = TRIM(@OtherDetail1),
        [OtherDetail2]         = TRIM(@OtherDetail2),
        [OtherDetail3]         = TRIM(@OtherDetail3),
        [OtherDetail4]         = TRIM(@OtherDetail4),
        [OtherDetail5]         = TRIM(@OtherDetail5),
        [OtherDetail6]         = TRIM(@OtherDetail6),
        [IsActive]             = @IsActive,
        [ModifiedBy]           = TRIM(@ActionUser),
        [ModifiedOn]           = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT 
        [DetailId],
        [AppointmentId],
        [AppointmentDay],
        [StartTime],
        [EndTime],
        [AppointmentDuration],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[AppointmentDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentMaster_GetDoctorTimeTable]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[AppointmentMaster_GetDoctorTimeTable] 
(
      @MasterId INT,
      @MonthName VARCHAR(20),
      @Year INT
)
AS
BEGIN
    SET NOCOUNT ON;


    DECLARE @Month INT;

    SELECT @Month = 
        CASE LOWER(@MonthName)
            WHEN 'january' THEN 1
            WHEN 'february' THEN 2
            WHEN 'march' THEN 3
            WHEN 'april' THEN 4
            WHEN 'may' THEN 5
            WHEN 'june' THEN 6
            WHEN 'july' THEN 7
            WHEN 'august' THEN 8
            WHEN 'september' THEN 9
            WHEN 'october' THEN 10
            WHEN 'november' THEN 11
            WHEN 'december' THEN 12
        END;

    IF @Month IS NULL
    BEGIN
        RAISERROR('Invalid month name.', 16, 1);
        RETURN;
    END;


    ;WITH CalendarDays AS (
        SELECT DATEFROMPARTS(@Year, @Month, 1) AS WorkDate
        UNION ALL
        SELECT DATEADD(DAY, 1, WorkDate)
        FROM CalendarDays
        WHERE DATEADD(DAY, 1, WorkDate) <= EOMONTH(DATEFROMPARTS(@Year, @Month, 1))
    ),


    DoctorSchedule AS (
        SELECT 
            ad.AppointmentId,
            ad.AppointmentDay,
            CASE WHEN ISDATE(ad.AppointmentDay) = 1 
                 THEN CAST(ad.AppointmentDay AS DATE)
                 ELSE NULL 
            END AS ExactDate,
            ad.IsActive
        FROM hm.AppointmentDetail ad
        INNER JOIN hm.AppoinmentMaster am 
            ON ad.AppointmentId = am.AppointmentId
        WHERE am.MasterId = @MasterId
          AND ad.IsActive = 1
    )

   
    SELECT 
        DAY(c.WorkDate) AS DayNumber,
        DATENAME(WEEKDAY, c.WorkDate) AS DayName,

        CASE
            WHEN ds.ExactDate = c.WorkDate THEN 1
            WHEN 
            (
                CASE LOWER(ds.AppointmentDay)
                    WHEN 'sunday' THEN 1
                    WHEN 'monday' THEN 2
                    WHEN 'tuesday' THEN 3
                    WHEN 'wednesday' THEN 4
                    WHEN 'thursday' THEN 5
                    WHEN 'friday' THEN 6
                    WHEN 'saturday' THEN 7
                END
            ) = DATEPART(WEEKDAY, c.WorkDate)
            THEN 1
            ELSE 0
        END AS IsPresent

    FROM CalendarDays c
    LEFT JOIN DoctorSchedule ds
        ON 
        (
            ds.ExactDate = c.WorkDate
            OR
            (
                CASE LOWER(ds.AppointmentDay)
                    WHEN 'sunday' THEN 1
                    WHEN 'monday' THEN 2
                    WHEN 'tuesday' THEN 3
                    WHEN 'wednesday' THEN 4
                    WHEN 'thursday' THEN 5
                    WHEN 'friday' THEN 6
                    WHEN 'saturday' THEN 7
                END
            ) = DATEPART(WEEKDAY, c.WorkDate)
        )
    ORDER BY DayNumber
    OPTION (MAXRECURSION 0);

END
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_CancelAndGenerateToken]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_CancelAndGenerateToken]
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Now DATETIME = GETDATE();
    DECLARE @Today DATE = CAST(@Now AS DATE);

    -- 1. CANCEL APPOINTMENTS IN THE PAST
    UPDATE A
    SET 
        A.Status = 'Cancelled',
        A.ModifiedOn = @Now
    FROM [Nishwik].[hm].[AppointmentScheduleMaster] A
    WHERE 
        A.IsActive = 1 AND
        A.IsDeleted = 0 AND
        A.Status NOT IN ('Cancelled', 'Completed') AND
        DATEADD(MINUTE, DATEDIFF(MINUTE, 0, A.AppointmentTime), CAST(A.AppointmentDate AS DATETIME)) < @Now;

    -- 2. GENERATE TOKENS FOR TODAY'S PENDING/SCHEDULED APPOINTMENTS

    ;WITH CTE AS (
        SELECT 
            A.AppointmentId,
            A.AppointmentDate,
            ROW_NUMBER() OVER (
                PARTITION BY A.AppointmentDate
                ORDER BY A.AppointmentTime, A.AppointmentId
            ) AS RowNum
        FROM [Nishwik].[hm].[AppointmentScheduleMaster] A
        WHERE 
            A.IsActive = 1 AND
            A.IsDeleted = 0 AND
            A.Status IN ('Scheduled', 'Pending') AND
            A.TokenNo IS NULL AND
            A.AppointmentDate = @Today
    )
    UPDATE A
    SET 
        A.TokenNo = FORMAT(B.AppointmentDate, 'yyyyMMdd') + '-' + RIGHT('000' + CAST(B.RowNum AS VARCHAR), 3),
        A.ModifiedOn = @Now
    FROM [Nishwik].[hm].[AppointmentScheduleMaster] A
    INNER JOIN CTE B ON A.AppointmentId = B.AppointmentId;

END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [hm].[AppointmentScheduleMaster_Create]
    @HospitalId = 1,
    @PatientId = 101,
    @ServiceId = 3,
    @DoctorId = 5,
    @AppointmentType = 'General Checkup',
    @AppointmentDate = '2025-07-24',
    @AppointmentTime = '10:30 AM',
    @ConsultationMode = 'In-Person',
    @AppointmentDuration = 30,
    @Status = 'Scheduled',
    @IsFirstVisit = 1,
    @OtherDetail1 = 'N/A',
    @OtherDetail2 = 'Walk-in',
    @OtherDetail3 = 'Insurance',
    @OtherDetail4 = 'Ward A',
    @OtherDetail5 = 'No allergies',
    @OtherDetail6 = 'N/A',
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_Create]
(
    @HospitalId            INT,
    @PatientId             INT,
    @ServiceId             INT,
    @DoctorId              INT,
    @AppointmentType       VARCHAR(200),
    @AppointmentDate       DATETIME,
    @AppointmentTime       VARCHAR(50),
    @ConsultationMode      VARCHAR(100),
    @AppointmentDuration   INT,
	@TokenNo              VARCHAR(100) = null,
    @Status                VARCHAR(20),
    @IsFirstVisit          INT,
	@Description           VARCHAR(500),
    @OtherDetail1          VARCHAR(50),
    @OtherDetail2          VARCHAR(50),
    @OtherDetail3          VARCHAR(100),
    @OtherDetail4          VARCHAR(100),
    @OtherDetail5          VARCHAR(500),
    @OtherDetail6          VARCHAR(500),
    @ActionUser            VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AppointmentId INT;

	SET @TokenNo = hm.GenerateTokenNumber();

    INSERT INTO [hm].[AppointmentScheduleMaster] (
        [HospitalId],
        [PatientId],
        [ServiceId],
        [DoctorId],
        [AppointmentType],
        [AppointmentDate],
        [AppointmentTime],
        [ConsultationMode],
        [AppointmentDuration],
		[TokenNo],
        [Status],
        [IsFirstVisit],
		[Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES (
        @HospitalId,
        @PatientId,
        @ServiceId,
        @DoctorId,
        @AppointmentType,
        @AppointmentDate,
        @AppointmentTime,
        @ConsultationMode,
        @AppointmentDuration,
		@TokenNo ,
        @Status,
        @IsFirstVisit,
		@Description,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @AppointmentId = SCOPE_IDENTITY();

    SELECT
        [AppointmentId],
        [HospitalId],
        [PatientId],
        [ServiceId],
        [DoctorId],
        [AppointmentType],
        [AppointmentDate],
        [AppointmentTime],
        [ConsultationMode],
        [AppointmentDuration],
		[TokenNo],
        [Status],
        [IsFirstVisit],
		[Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[AppointmentScheduleMaster]
    WHERE [AppointmentId] = @AppointmentId;

END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_Delete]
(
   @AppointmentId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE[hm].[AppointmentScheduleMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [AppointmentId] = @AppointmentId
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_DoctorDailyAppointment]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[AppointmentScheduleMaster_DoctorDailyAppointment] 
(
    @DoctorId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Today DATE = CAST(GETDATE() AS DATE);

    SELECT 
        asm.AppointmentId,
        asm.PatientId,
        -- Build patient full name safely
        LTRIM(RTRIM(
            ISNULL(um.FirstName,'')
            + CASE WHEN um.MiddleName IS NULL OR um.MiddleName='' THEN '' ELSE ' ' + um.MiddleName END
            + CASE WHEN um.LastName IS NULL OR um.LastName='' THEN '' ELSE ' ' + um.LastName END
        )) AS PatientName,
        um.MobileNo,
        asm.AppointmentType,
        asm.AppointmentDate,
        asm.AppointmentTime
    FROM hm.AppointmentScheduleMaster asm WITH (NOLOCK)
    INNER JOIN dbo.UserMaster um WITH (NOLOCK)
        ON asm.PatientId = um.UserId    -- ensure PatientId maps to UserMaster.UserId
    WHERE asm.DoctorId = @DoctorId
      AND CAST(asm.AppointmentDate AS DATE) = @Today
      AND asm.IsActive = 1
      AND asm.IsDeleted = 0
      AND um.IsActive = 1
      AND um.IsDeleted = 0
    ORDER BY asm.AppointmentTime;
END
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_DoctorPatientPerWeekOrYear]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[hm].[AppointmentScheduleMaster_DoctorPatientPerWeek]7609
*/

CREATE PROCEDURE [hm].[AppointmentScheduleMaster_DoctorPatientPerWeekOrYear] 
(
      @DoctorId INT,
      @Type NVARCHAR(10)   -- 'week' or 'year'
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Today DATE = CAST(GETDATE() AS DATE);
    DECLARE @CurrentYear INT = YEAR(GETDATE());

    IF LOWER(@Type) = 'week'
    BEGIN
        -- Find Monday of current week
        DECLARE @StartOfWeek DATE = DATEADD(WEEK, DATEDIFF(WEEK, 1, @Today), 1);
        DECLARE @EndOfWeek   DATE = DATEADD(DAY, 6, @StartOfWeek);

        ;WITH WeekDays AS
        (
            SELECT DATEADD(DAY, v.number, @StartOfWeek) AS TheDate
            FROM master..spt_values v
            WHERE v.type = 'P' AND v.number BETWEEN 0 AND 6
        )
        SELECT 
            DATENAME(WEEKDAY, wd.TheDate) AS Label,
            COUNT(asm.AppointmentId) AS PatientCount
        FROM WeekDays wd
        LEFT JOIN hm.AppointmentScheduleMaster asm
            ON CAST(asm.AppointmentDate AS DATE) = wd.TheDate
           AND asm.DoctorId = @DoctorId
           AND asm.IsActive = 1
           AND asm.IsDeleted = 0
        GROUP BY wd.TheDate
        ORDER BY wd.TheDate;

        RETURN;
    END


    IF LOWER(@Type) = 'year'
    BEGIN
        ;WITH Months AS
        (
            SELECT 1 AS MonthNo
            UNION ALL
            SELECT MonthNo + 1 FROM Months WHERE MonthNo < 12
        )
        SELECT 
            DATENAME(MONTH, DATEFROMPARTS(@CurrentYear, m.MonthNo, 1)) AS Label,
            COUNT(asm.AppointmentId) AS PatientCount
        FROM Months m
        LEFT JOIN hm.AppointmentScheduleMaster asm
            ON YEAR(asm.AppointmentDate) = @CurrentYear
           AND MONTH(asm.AppointmentDate) = m.MonthNo
           AND asm.DoctorId = @DoctorId
           AND asm.IsActive = 1
           AND asm.IsDeleted = 0
        GROUP BY m.MonthNo
        ORDER BY m.MonthNo;

        RETURN;
    END
END
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_GetByDoctor]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[AppointmentScheduleMaster_GetByDoctor]
(
    @DoctorId INT,
    @StartDate DATETIME = NULL,
    @EndDate DATETIME = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        D.FirstName + ' ' + ISNULL(D.MiddleName,'') + ' ' + ISNULL(D.LastName,'') AS DoctorName,
        A.AppointmentDate,
        DAY(A.AppointmentDate) AS DayOfMonth,
        A.AppointmentType,
        FORMAT(A.AppointmentTime, 'hh:mm tt') AS AppointmentTime,
        A.Status
    FROM [Nishwik].[hm].[AppointmentScheduleMaster] AS A
    LEFT JOIN [Nishwik].[dbo].[UserMaster] AS D 
        ON A.DoctorId = D.UserId
    WHERE 
        A.IsActive = 1 AND A.IsDeleted = 0
        AND A.DoctorId = @DoctorId
        AND (@StartDate IS NULL OR A.AppointmentDate >= @StartDate)
        AND (@EndDate IS NULL OR A.AppointmentDate <= @EndDate)
    ORDER BY A.AppointmentDate, A.AppointmentTime;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_GetDoctorAppointments]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [hm].[AppointmentScheduleMaster_GetDoctorAppointments]
(
    @DoctorId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        ROW_NUMBER() OVER (ORDER BY A.AppointmentDate, A.AppointmentTime) AS [SrNo],
        CONCAT(ISNULL(B.FirstName, ''), ' ', ISNULL(B.MiddleName, ''), ' ', ISNULL(B.LastName, '')) AS [PatientName],
        CONVERT(VARCHAR(10), A.AppointmentDate, 103) AS [Date],
        FORMAT(A.AppointmentTime, 'hh:mm tt') AS [Time],
        A.Status AS [Status]
    FROM [hm].[AppointmentScheduleMaster] AS A
    LEFT OUTER JOIN [dbo].[UserMaster] AS B ON A.PatientId = B.UserId
    WHERE 
        A.IsActive = 1 
        AND A.IsDeleted = 0
        AND B.IsActive = 1 
        AND B.IsDeleted = 0
        AND A.DoctorId = @DoctorId
    ORDER BY A.AppointmentDate, A.AppointmentTime;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_GetDoctorPatientCounts]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE[hm].[AppointmentScheduleMaster_GetDoctorPatientCounts]
(
      @DoctorId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    ---------------------------------------------------------
    -- Prepare Today, Week, Month Boundaries
    ---------------------------------------------------------
    DECLARE @Today DATE = CAST(GETDATE() AS DATE);

    DECLARE @WeekStart DATE = DATEADD(DAY, 1 - DATEPART(WEEKDAY, @Today), @Today);
    DECLARE @WeekEnd   DATE = DATEADD(DAY, 7 - DATEPART(WEEKDAY, @Today), @Today);

    DECLARE @MonthStart DATE = DATEFROMPARTS(YEAR(@Today), MONTH(@Today), 1);
    DECLARE @MonthEnd   DATE = EOMONTH(@Today);

    ---------------------------------------------------------
    -- Extract the doctor's name from AppoinmentMaster
    ---------------------------------------------------------
    DECLARE @DoctorName VARCHAR(200);

    SELECT TOP 1
        @DoctorName =
            CASE 
                WHEN Description IS NULL THEN 'Unknown Doctor'
                WHEN CHARINDEX(',', Description) > 0 
                    THEN LTRIM(RTRIM(LEFT(Description, CHARINDEX(',', Description) - 1)))
                ELSE LTRIM(RTRIM(Description))
            END
    FROM hm.AppoinmentMaster
    WHERE MasterType = 'Doctor'
      AND MasterId = @DoctorId;

    IF @DoctorName IS NULL
        SET @DoctorName = 'Unknown Doctor';

    ---------------------------------------------------------
    -- Return Counts + Doctor Name
    ---------------------------------------------------------
    SELECT
        -----------------------------------------------------
        -- Today Count
        -----------------------------------------------------
        (SELECT COUNT(*)
         FROM hm.AppointmentScheduleMaster
         WHERE DoctorId = @DoctorId
           AND IsActive = 1
           AND IsDeleted = 0
           AND CAST(AppointmentDate AS DATE) = @Today
        ) AS TodayPatientCount,

        -----------------------------------------------------
        -- Week Count
        -----------------------------------------------------
        (SELECT COUNT(*)
         FROM hm.AppointmentScheduleMaster
         WHERE DoctorId = @DoctorId
           AND IsActive = 1
           AND IsDeleted = 0
           AND CAST(AppointmentDate AS DATE) BETWEEN @WeekStart AND @WeekEnd
        ) AS PerWeekPatientCount,

        -----------------------------------------------------
        -- Month Count
        -----------------------------------------------------
        (SELECT COUNT(*)
         FROM hm.AppointmentScheduleMaster
         WHERE DoctorId = @DoctorId
           AND IsActive = 1
           AND IsDeleted = 0
           AND CAST(AppointmentDate AS DATE) BETWEEN @MonthStart AND @MonthEnd
        ) AS PerMonthPatientCount,

        -----------------------------------------------------
        -- EMI Count (always 0 for now)
        -----------------------------------------------------
        0 AS EMIPatientCount,

        -----------------------------------------------------
        -- Doctor Full Name
        -----------------------------------------------------
        @DoctorName AS DoctorFullName;

END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_HospitalAppointmentsList]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[AppointmentScheduleMaster_HospitalAppointmentsList]
(
    @HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        ROW_NUMBER() OVER (ORDER BY A.AppointmentDate DESC, A.AppointmentTime DESC) AS [SrNo],
        ISNULL(A.AppointmentType, 'General Consultation') AS [Appointment],
        ISNULL(U.FirstName + ' ' + U.LastName, 'N/A') AS [Doctor],
        ISNULL(A.Status, 'Pending') AS [Status]
    FROM [hm].[AppointmentScheduleMaster] AS A
    LEFT JOIN [dbo].[UserMaster] AS U 
        ON A.DoctorId = U.UserId
    WHERE 
        A.HospitalId = @HospitalId
        AND A.IsActive = 1
        AND A.IsDeleted = 0
    ORDER BY 
        A.AppointmentDate DESC, 
        A.AppointmentTime DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_HospitalPatientPerWeek]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROCEDURE [hm].[AppointmentScheduleMaster_HospitalPatientPerWeek] 

(
      @HospitalId INT,
      @StartDate DATE
)
AS
BEGIN
    SET NOCOUNT ON;

 
    ;WITH Days AS
    (
        SELECT DATEADD(DAY, v.number, @StartDate) AS Dt
        FROM master..spt_values v
        WHERE v.type = 'P' AND v.number BETWEEN 0 AND 6
    ),


    AppointmentCounts AS
    (
        SELECT 
            AppointmentDate,
            COUNT(*) AS Cnt
        FROM [Nishwik].[hm].[AppointmentScheduleMaster]
        WHERE HospitalId = @HospitalId
          AND IsActive = 1
          AND IsDeleted = 0
          AND Status = 'Completed'
          AND ConsultationMode = 'In-Person'
          AND AppointmentDate >= @StartDate
          AND AppointmentDate < DATEADD(DAY, 7, @StartDate)
        GROUP BY AppointmentDate
    ),


    RegistrationCounts AS
    (
        SELECT 
            CAST(JoinedOn AS DATE) AS RegDate,
            COUNT(*) AS Cnt
        FROM [Nishwik].[hm].[UserAffiliationMapping]
        WHERE HospitalId = @HospitalId
          AND IsActive = 1
          AND IsDeleted = 0
          AND AffiliationType = 'Patient'
          AND CAST(JoinedOn AS DATE) >= @StartDate
          AND CAST(JoinedOn AS DATE) < DATEADD(DAY, 7, @StartDate)
        GROUP BY CAST(JoinedOn AS DATE)
    )


    SELECT 
        DATENAME(WEEKDAY, d.Dt) AS DayName,
        d.Dt AS Date,
        ISNULL(a.Cnt, 0) + ISNULL(r.Cnt, 0) AS PatientCount
    FROM Days d
    LEFT JOIN AppointmentCounts a ON a.AppointmentDate = d.Dt
    LEFT JOIN RegistrationCounts r ON r.RegDate = d.Dt
    ORDER BY d.Dt;
END


/*SELECT * FROM hm.UserAffiliationMapping where IsActive=1 AND AffiliationType='Patient'
SELECT *FROM hm.AppointmentScheduleMaster where IsActive=1*/
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_HospitalWeeklyAppointments]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*

EXEC [hm].[AppointmentScheduleMaster_HospitalWeeklyAppointments] 
     @HospitalId = 34, 
     @Date = '2025-11-13';
*/
CREATE PROCEDURE [hm].[AppointmentScheduleMaster_HospitalWeeklyAppointments]
(
    @HospitalId INT,
    @Date DATE = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    IF @Date IS NULL 
        SET @Date = GETDATE();

    DECLARE @StartOfWeek DATE, @EndOfWeek DATE;

    SET DATEFIRST 1;

    SET @StartOfWeek = DATEADD(DAY, 1 - DATEPART(WEEKDAY, @Date), @Date);

    SET @EndOfWeek = DATEADD(DAY, 6, @StartOfWeek);

    SELECT  
        LEFT(DATENAME(WEEKDAY, A.AppointmentDate), 3) AS [DayName],  -- Mon, Tue, etc.
        CAST(A.AppointmentDate AS DATE) AS [Date],
        COUNT(A.AppointmentId) AS [AppointmentCount]
    FROM [hm].[AppointmentScheduleMaster] AS A
    WHERE 
        A.IsActive = 1 
        AND A.IsDeleted = 0
        AND A.HospitalId = @HospitalId
        AND CAST(A.AppointmentDate AS DATE) BETWEEN @StartOfWeek AND @EndOfWeek
    GROUP BY 
        CAST(A.AppointmentDate AS DATE),
        DATENAME(WEEKDAY, A.AppointmentDate)
    ORDER BY 
        CAST(A.AppointmentDate AS DATE);
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_HospitalWeeklyOrYearlyAppointment]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[AppointmentScheduleMaster_HospitalWeeklyOrYearlyAppointment] 
(
      @HospitalId INT,
      @DataType VARCHAR(10)   
)
AS
BEGIN
    SET NOCOUNT ON;


    IF @DataType = 'week'
    BEGIN
        DECLARE @Today DATE = CAST(GETDATE() AS DATE);

        ;WITH Days AS
        (
            SELECT DATEADD(DAY, v.number, @Today) AS Dt
            FROM master..spt_values v
            WHERE v.type = 'P' AND v.number BETWEEN 0 AND 6
        ),
        Counts AS
        (
            SELECT 
                AppointmentDate,
                COUNT(*) AS Cnt
            FROM [Nishwik].[hm].[AppointmentScheduleMaster]
            WHERE HospitalId = @HospitalId
              AND IsActive = 1 
              AND IsDeleted = 0
              AND AppointmentDate >= @Today
              AND AppointmentDate < DATEADD(DAY, 7, @Today)
            GROUP BY AppointmentDate
        )
        SELECT 
            DATENAME(WEEKDAY, d.Dt) AS Label,
            ISNULL(c.Cnt, 0) AS AppointmentCount
        FROM Days d
        LEFT JOIN Counts c 
            ON c.AppointmentDate = d.Dt
        ORDER BY d.Dt;

        RETURN;
    END


    IF @DataType = 'year'
    BEGIN
        DECLARE @Year INT = YEAR(GETDATE());

        ;WITH Months AS
        (
            SELECT 1 AS M UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL
            SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL
            SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL
            SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12
        ),
        Counts AS
        (
            SELECT 
                MONTH(AppointmentDate) AS M,
                COUNT(*) AS Cnt
            FROM [Nishwik].[hm].[AppointmentScheduleMaster]
            WHERE HospitalId = @HospitalId
              AND IsActive = 1 
              AND IsDeleted = 0
              AND YEAR(AppointmentDate) = @Year
            GROUP BY MONTH(AppointmentDate)
        )
        SELECT 
            DATENAME(MONTH, DATEFROMPARTS(@Year, m.M, 1)) AS Label,
            ISNULL(c.Cnt, 0) AS AppointmentCount
        FROM Months m
        LEFT JOIN Counts c 
            ON c.M = m.M
        ORDER BY m.M;

        RETURN;
    END

  
    RAISERROR('DataType must be either ''week'' or ''year''.', 16, 1);
END


SELECT *FROM [hm].[AppointmentScheduleMaster] where HospitalId = 34 and IsActive=1
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_ReadAll]
AS
BEGIN
	SET NOCOUNT ON;
	SELECT
		 A.[AppointmentId]
		,A.[HospitalId]
		,A.[TokenNo]
		,B.[HospitalName]
		,A.[PatientId]
		,C.[FirstName] + ' ' + E.[LastName] AS [PatientName]
		,A.[ServiceId]
		,D.[ServiceName]
		,A.[DoctorId]
		,E.[FirstName] + ' ' + E.[LastName] AS DoctorName
		,A.[AppointmentType]
		,A.[AppointmentDate]
		,A.[AppointmentTime]
		,A.[ConsultationMode]
		,A.[AppointmentDuration]
		,A.[status]
		,A.[IsFirstVisit]
		,A.[Description]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [hm].[AppointmentScheduleMaster]A
	LEFT OUTER JOIN  [hm].[HospitalMaster]B
	ON A.[AppointmentId] = B.[HospitalId]
	LEFT OUTER JOIN [dbo].[UserMaster]C
	ON A.[PatientId]= C.[UserId]
	LEFT OUTER JOIN [hm].[ServiceMaster]D
	ON A.[ServiceId] = D.[ServiceId]
	LEFT OUTER JOIN [hm].[DoctorMaster] E
	ON A.[HospitalId] = E.HospitalId
	WHERE A.[IsActive] = 1
	AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_ReadByDoctorId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[hm].[AppoinmentScheduleMaster_ReadByPatientId]1111
*/
CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_ReadByDoctorId]
(
   @DoctorId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT
		 A.[AppointmentId]
		,A.[HospitalId]
		,A.[TokenNo]
		,B.[HospitalName]
		,A.[PatientId]
        ,C.[FirstName] + ' ' + C.[LastName] AS [PatientName]
		,A.[ServiceId]
		,D.[ServiceName]
		,A.[DoctorId]
		,E.[FirstName] + ' ' + E.[LastName] AS DoctorName
		,A.[AppointmentType]
		,A.[AppointmentDate]
		,A.[AppointmentTime]
		,A.[ConsultationMode]
		,A.[AppointmentDuration]
		,A.[status]
		,A.[IsFirstVisit]
		,A.[Description]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [hm].[AppointmentScheduleMaster]A
	LEFT OUTER JOIN  [hm].[HospitalMaster]B
	ON A.[HospitalId] = B.[HospitalId]
	LEFT OUTER JOIN [dbo].UserMaster C
	ON A.[PatientId]= C.[UserId]
	LEFT OUTER JOIN [hm].[ServiceMaster]D
	ON A.[ServiceId] = D.[ServiceId]
	LEFT OUTER JOIN [dbo].[UserMaster] E
	ON A.[DoctorId] = E.[UserId] 
	--AND A.HospitalId = E.UserId
	WHERE A.[DoctorId] = @DoctorId
	AND A. [IsActive] = 1
	AND A. [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[hm].[AppointmentScheduleMaster_ReadByHospitalId] 34
*/
CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_ReadByHospitalId] 
(
   @HospitalId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT
		 A.[AppointmentId]
		,A.[HospitalId]
		,A.[TokenNo]
		,B.[HospitalName]
		,A.[PatientId]
	    ,C.[FirstName] + ' ' + C.[LastName] AS [PatientName]
		,A.[ServiceId]
		,D.[ServiceName]
		,A.[DoctorId]
		,E.[FirstName] + ' ' + E.[LastName] AS DoctorName
		,A.[AppointmentType]
		,A.[AppointmentDate]
		,A.[AppointmentTime]
		,A.[ConsultationMode]
		,A.[AppointmentDuration]
		,A.[status]
		,A.[IsFirstVisit]
		,A.[Description]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [hm].[AppointmentScheduleMaster] A
	LEFT OUTER JOIN  [hm].[HospitalMaster]B
	ON A.[HospitalId] = B.[HospitalId]
	LEFT OUTER JOIN [dbo].UserMaster C
	ON A.[PatientId]= C.[UserId]
	LEFT OUTER JOIN [hm].[ServiceMaster]D
	ON A.[ServiceId] = D.[ServiceId]
	LEFT OUTER JOIN [dbo].[UserMaster] E
	ON A.[DoctorId] = E.[UserId]
	--AND A.HospitalId = E.UserId
	WHERE A.[HospitalId] = @HospitalId  
	AND A. [IsActive] = 1
	AND A. [IsDeleted] = 0
	ORDER BY [AppointmentId] DESC; 
END;

GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_ReadById]
(
   @AppointmentId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT
	     A.[AppointmentId]
		,A.[HospitalId]
		,A.[TokenNo]
		,B.[HospitalName]
		,A.[PatientId]
		,C.[FirstName] + ' ' + E.[LastName] AS [PatientName]
		,A.[ServiceId]
		,D.[ServiceName]
		,A.[DoctorId]
		,E.[FirstName] + ' ' + E.[LastName] AS DoctorName
		,A.[AppointmentType]
		,A.[AppointmentDate]
		,A.[AppointmentTime]
		,A.[ConsultationMode]
		,A.[AppointmentDuration]
		,A.[status]
		,A.[IsFirstVisit]
		,A.[Description]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [hm].[AppointmentScheduleMaster]A
	LEFT OUTER JOIN  [hm].[HospitalMaster]B
	ON A.[AppointmentId] = B.[HospitalId]
	LEFT OUTER JOIN [dbo].UserMaster C
	ON A.[PatientId]= C.[UserId]
	LEFT OUTER JOIN [hm].[ServiceMaster]D
	ON A.[ServiceId] = D.[ServiceId]
	LEFT OUTER JOIN [dbo].[UserMaster] E
	ON A.[HospitalId] = E.UserId
	WHERE A.[AppointmentId] = @AppointmentId
	AND A.[IsActive] = 1
	AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_ReadByPatientId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [hm].[AppointmentScheduleMaster_ReadByPatientId] 1221
*/
CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_ReadByPatientId]
(
   @PatientId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT
		 A.[AppointmentId]
		,A.[HospitalId]
		,A.[TokenNo]
		,B.[HospitalName]
		,A.[PatientId]
       ,C.[FirstName] + ' ' + C.[LastName] AS [PatientName]
		,A.[ServiceId]
		,D.[ServiceName]
		,A.[DoctorId]
		,E.[FirstName] + ' ' + E.[LastName] AS DoctorName
		,A.[AppointmentType]
		,A.[AppointmentDate]
		,A.[AppointmentTime]
		,A.[ConsultationMode]
		,A.[AppointmentDuration]
		,A.[status]
		,A.[IsFirstVisit]
		,A.[Description]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [hm].[AppointmentScheduleMaster]A
	LEFT OUTER JOIN  [hm].[HospitalMaster]B
	ON A.[HospitalId] = B.[HospitalId]
	LEFT OUTER JOIN [dbo].UserMaster C
	ON A.[PatientId]= C.[UserId]
	LEFT OUTER JOIN [hm].[ServiceMaster]D
	ON A.[ServiceId] = D.[ServiceId]
	LEFT OUTER JOIN [dbo].[UserMaster] E
	ON A.[DoctorId] = E.[UserId]
	--AND A.HospitalId = E.UserId
	WHERE A.[PatientId] = @PatientId
	AND A. [IsActive] = 1
	AND A. [IsDeleted] = 0
	ORDER BY [AppointmentId] DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_ReadByServiceId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_ReadByServiceId]
(
   @ServiceId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT
		 A.[AppointmentId]
		,A.[HospitalId]
		,A.[TokenNo]
		,B.[HospitalName]
		,A.[PatientId]
		,C.[FirstName] + ' ' + E.[LastName] AS [PatientName]
		,A.[ServiceId]
		,D.[ServiceName]
		,A.[DoctorId]
		,E.[FirstName] + ' ' + E.[LastName] AS DoctorName
		,A.[AppointmentType]
		,A.[AppointmentDate]
		,A.[AppointmentTime]
		,A.[ConsultationMode]
		,A.[AppointmentDuration]
		,A.[status]
		,A.[IsFirstVisit]
		,A.[Description]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	 FROM [hm].[AppointmentScheduleMaster]A
	LEFT OUTER JOIN  [hm].[HospitalMaster]B
	ON A.[HospitalId] = B.[HospitalId]
	LEFT OUTER JOIN [dbo].UserMaster C
	ON A.[PatientId]= C.[UserId]
	LEFT OUTER JOIN [hm].[ServiceMaster]D
	ON A.[ServiceId] = D.[ServiceId]
	LEFT OUTER JOIN [dbo].[UserMaster] E
	ON A.[DoctorId] = E.[UserId] 
	AND A.HospitalId = E.UserId
	WHERE A.[ServiceId] = @ServiceId
	AND A. [IsActive] = 1
	AND A. [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_ReadPendingAppointmentByMaster]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*

hm.AppointmentScheduleMaster_ReadPendingAppointmentByMaster   7719, 'Doctor'
*/
CREATE PROCEDURE [hm].[AppointmentScheduleMaster_ReadPendingAppointmentByMaster] 
(
      @MasterId INT,
      @MasterType VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MT VARCHAR(50) = LOWER(LTRIM(RTRIM(@MasterType)));

    IF @MT NOT IN ('doctor','hospital')
    BEGIN
        RAISERROR('MasterType must be DOCTOR or HOSPITAL', 16, 1);
        RETURN;
    END


    ---------------------------------------------
    -- DOCTOR BLOCK (FORMAT PRESERVED)
    ---------------------------------------------
    IF @MT = 'doctor'
    BEGIN
        SELECT 
 A.[AppointmentId]
      ,A.[HospitalId]
	  ,B.[HospitalName]
      ,A.[PatientId]
	  ,C.[FirstName] + ' ' + C.LastName AS PatientName   -- FIXED
      ,A.[ServiceId]
      ,A.[DoctorId]
	  ,D.[FirstName] + ' ' + D.LastName AS DoctorName    -- FIXED
      ,A.[AppointmentType]
      ,A.[AppointmentDate]
      ,A.[AppointmentTime]
      ,A.[ConsultationMode]
      ,A.[AppointmentDuration]
      ,A.[status]
      ,A.[IsFirstVisit]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
      ,A.[Description]
      ,A.[TokenNo]
        FROM hm.AppointmentScheduleMaster A
		LEFT OUTER JOIN hm.HospitalMaster B
		     ON A.HospitalId = B.HospitalId
		LEFT OUTER JOIN dbo.UserMaster C
		     ON A.PatientId = C.UserId            -- FIXED
		LEFT OUTER JOIN dbo.UserMaster D
		     ON A.DoctorId = D.UserId            -- FIXED
        WHERE A.DoctorId = @MasterId             -- FIXED
          AND LOWER(Status) = 'no-show'
          AND A.IsDeleted = 0;
        RETURN;
    END


    ---------------------------------------------
    -- HOSPITAL BLOCK (FORMAT PRESERVED)
    ---------------------------------------------
    IF @MT = 'hospital'
    BEGIN
        SELECT 
	   A.[AppointmentId]
      ,A.[HospitalId]
	  ,B.[HospitalName]
      ,A.[PatientId]
	  ,C.[FirstName] + ' ' + C.LastName AS PatientName   -- FIXED
      ,A.[ServiceId]
      ,A.[DoctorId]
	  ,D.[FirstName] + ' ' + D.LastName AS DoctorName    -- FIXED
      ,A.[AppointmentType]
      ,A.[AppointmentDate]
      ,A.[AppointmentTime]
      ,A.[ConsultationMode]
      ,A.[AppointmentDuration]
      ,A.[status]
      ,A.[IsFirstVisit]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
      ,A.[Description]
      ,A.[TokenNo]
        FROM hm.AppointmentScheduleMaster A
		LEFT OUTER JOIN hm.HospitalMaster B
		     ON A.HospitalId = B.HospitalId
		LEFT OUTER JOIN dbo.UserMaster C
		     ON A.PatientId = C.UserId             -- FIXED
		LEFT OUTER JOIN dbo.UserMaster D
		     ON A.DoctorId = D.UserId             -- FIXED
        WHERE A.HospitalId = @MasterId
          AND LOWER(Status) = 'no-show'
          AND A.IsDeleted = 0;
        RETURN;
    END

END
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
EXEC [hm].[AppointmentScheduleMaster_Update]
    @AppointmentId = 1,
    @HospitalId = 1,
    @PatientId = 101,
    @ServiceId = 3,
    @DoctorId = 5,
    @AppointmentType = 'Follow-up',
    @AppointmentDate = '2025-07-25',
    @AppointmentTime = '11:00 AM',
    @ConsultationMode = 'Video',
    @AppointmentDuration = 20,
    @Status = 'Confirmed',
    @IsFirstVisit = 0,
    @OtherDetail1 = 'N/A',
    @OtherDetail2 = 'Online',
    @OtherDetail3 = 'Updated info',
    @OtherDetail4 = 'Ward B',
    @OtherDetail5 = 'Allergic to penicillin',
    @OtherDetail6 = 'Requires translator',
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [hm].[AppointmentScheduleMaster_Update]
(
    @AppointmentId         INT,
    @HospitalId            INT,
    @PatientId             INT,
    @ServiceId             INT,
    @DoctorId              INT,
    @AppointmentType       VARCHAR(200),
    @AppointmentDate       DATETIME,
    @AppointmentTime       VARCHAR(50),
    @ConsultationMode      VARCHAR(100),
    @AppointmentDuration   INT,
 	@TokenNo               VARCHAR(100),
    @Status                VARCHAR(20),
    @IsFirstVisit          INT,
	@Description           VARCHAR(500),
    @OtherDetail1          VARCHAR(50),
    @OtherDetail2          VARCHAR(50),
    @OtherDetail3          VARCHAR(100),
    @OtherDetail4          VARCHAR(100),
    @OtherDetail5          VARCHAR(500),
    @OtherDetail6          VARCHAR(500),
    @IsActive              INT,
    @ActionUser            VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[AppointmentScheduleMaster]
    SET
        [HospitalId]          = @HospitalId,
        [PatientId]           = @PatientId,
        [ServiceId]           = @ServiceId,
        [DoctorId]            = @DoctorId,
        [AppointmentType]     = @AppointmentType,
        [AppointmentDate]     = @AppointmentDate,
        [AppointmentTime]     = @AppointmentTime,
        [ConsultationMode]    = @ConsultationMode,
        [AppointmentDuration] = @AppointmentDuration,
		[TokenNo]             = ISNULL(@TokenNo, [TokenNo]),
        [Status]              = @Status,
        [IsFirstVisit]        = @IsFirstVisit,
		[Description]         = @Description,
        [OtherDetail1]        = @OtherDetail1,
        [OtherDetail2]        = @OtherDetail2,
        [OtherDetail3]        = @OtherDetail3,
        [OtherDetail4]        = @OtherDetail4,
        [OtherDetail5]        = @OtherDetail5,
        [OtherDetail6]        = @OtherDetail6,
        [IsActive]            = @IsActive,
        [ModifiedBy]          = @ActionUser,
        [ModifiedOn]          = GETDATE()
    WHERE [AppointmentId] = @AppointmentId;

    SELECT
        [AppointmentId],
        [HospitalId],
        [PatientId],
        [ServiceId],
        [DoctorId],
        [AppointmentType],
        [AppointmentDate],
        [AppointmentTime],
        [ConsultationMode],
        [AppointmentDuration],
		[TokenNo],
        [Status],
        [IsFirstVisit],
		[Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[AppointmentScheduleMaster]
    WHERE [AppointmentId] = @AppointmentId
	AND [IsActive] = 1
	AND[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[AppointmentScheduleMaster_WeeklyVisits]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*

[hm].[AppointmentScheduleMaster_WeeklyVisits] 
     @DoctorId = 1042,
     @Date = '2025-12-30';

SELECT * FROM [hm].[AppointmentScheduleMaster] where status LIKE 'completed'

*/

CREATE PROCEDURE [hm].[AppointmentScheduleMaster_WeeklyVisits]
(
      @DoctorId INT,
      @Date DATE
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @StartDate DATE = @Date;
    DECLARE @EndDate   DATE = DATEADD(DAY, 6, @StartDate);

    ;WITH DaysAhead AS
    (
        SELECT DATEADD(DAY, v.number, @StartDate) AS TheDate
        FROM master..spt_values v
        WHERE v.type = 'P' AND v.number BETWEEN 0 AND 6
    )
    SELECT 
        DATENAME(WEEKDAY, d.TheDate) AS DayName,
        d.TheDate AS DateValue,
        COUNT(asm.AppointmentId) AS TotalVisits
    FROM DaysAhead d
    LEFT JOIN hm.AppointmentScheduleMaster asm
        ON CAST(asm.AppointmentDate AS DATE) = d.TheDate
       AND asm.DoctorId = @DoctorId
       AND UPPER(LTRIM(RTRIM(status))) LIKE '%COMPLET%'
       AND REPLACE(REPLACE(UPPER(ConsultationMode), ' ', ''), '-', '') LIKE '%INPERSON%'
    GROUP BY d.TheDate
    ORDER BY d.TheDate;
END
GO
/****** Object:  StoredProcedure [hm].[AutoBillClosure_EOD]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[AutoBillClosure_EOD]
AS
BEGIN
    SET NOCOUNT ON;

    -- Step 1: Close all invoices that are still open (assuming PmtStatus is used for status)
    UPDATE hm.InvoiceMaster
    SET PmtStatus = 'Closed',
        ModifiedOn = GETDATE(),
        ModifiedBy = 0
    WHERE PmtStatus = 'Open'
      AND IsActive = 1
      AND IsDeleted = 0;

END;
GO
/****** Object:  StoredProcedure [hm].[BedAllocation_Refresh_BOD]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[BedAllocation_Refresh_BOD]
AS
BEGIN
    SET NOCOUNT ON;

    -- Free Beds for Patients already discharged
    UPDATE hm.PatientBedAllocationMapping
    SET 
        IsOccupied = 0,
        IsActive = 0,
        ModifiedOn = GETDATE(),
        ModifiedBy = 'SYSTEM'
    WHERE 
        IsOccupied = 1
        AND IsActive = 1
        AND IsDeleted = 0
        AND OccupiedTo IS NOT NULL
        AND CONVERT(date, OccupiedTo) < CONVERT(date, GETDATE());

END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackMaster_Create]
(
    @HospitalId INT,
	@MasterId INT,
	@MasterType VARCHAR(20),
	@Rating INT,
	@ExperienceLevel VARCHAR(20),
	@Description NVARCHAR(1000),
    @OtherDetail1 NVARCHAR(255),
    @OtherDetail2 NVARCHAR(255),
    @OtherDetail3 NVARCHAR(255),
    @OtherDetail4 NVARCHAR(255),
    @OtherDetail5 NVARCHAR(255),
    @OtherDetail6 NVARCHAR(255),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FeedbackId INT;

    INSERT INTO [hm].[FeedbackMaster]
    (
        [HospitalId],
        [MasterId],
        [MasterType],
        [Rating],
        [ExperienceLevel],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        @MasterId,
        @MasterType,
        @Rating,
        @ExperienceLevel,
        @Description,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
         1,
         0,
        @ActionUser,
        GETDATE()
    );

    SET @FeedbackId = SCOPE_IDENTITY();

    SELECT 
	   [FeedbackId]
      ,[HospitalId]
      ,[MasterId]
      ,[MasterType]
      ,[Rating]
      ,[ExperienceLevel]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[FeedbackMaster]
    WHERE [FeedbackId] = @FeedbackId;
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackMaster_Delete]
(
   @FeedbackId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[FeedbackMaster]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [FeedbackId] = @FeedbackId
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackMaster_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [FeedbackId]
      ,[HospitalId]
      ,[MasterId]
      ,[MasterType]
      ,[Rating]
      ,[ExperienceLevel]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackMaster_ReadByHospitalId]
(
   @HospitalId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[FeedbackId]
      ,A.[HospitalId]
      ,A.[MasterId]
	  ,B.[FirstName]+ ' '+ B.[LastName] AS MasterName
      ,A.[MasterType]
      ,A.[Rating]
      ,A.[ExperienceLevel]
      ,A.[Description]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[FeedbackMaster]A
	  LEFT OUTER JOIN [dbo].[UserMaster] B
	  ON A.[MasterId] = B.[UserId]
	  --LEFT OUTER JOIN [hm].[DoctorMaster]C
	  --ON A.[MasterId] = C.[HospitalId]
	  WHERE A.[HospitalId] = @HospitalId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackMaster_ReadById]
(
   @FeedbackId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [FeedbackId]
      ,[HospitalId]
      ,[MasterId]
      ,[MasterType]
      ,[Rating]
      ,[ExperienceLevel]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackMaster]
	  WHERE [FeedbackId] = @FeedbackId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackMaster_ReadByMasterId]
(
   @MasterId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [FeedbackId]
      ,[HospitalId]
      ,[MasterId]
      ,[MasterType]
      ,[Rating]
      ,[ExperienceLevel]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackMaster]
	  WHERE [MasterId] = @MasterId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackMaster_Update]
(
    @FeedbackId INT, 
	@HospitalId INT,
	@MasterId INT,
	@MasterType VARCHAR(20),
	@Rating INT,
	@ExperienceLevel VARCHAR(20),
	@Description NVARCHAR(1000),
    @OtherDetail1 NVARCHAR(255),
    @OtherDetail2 NVARCHAR(255),
    @OtherDetail3 NVARCHAR(255),
    @OtherDetail4 NVARCHAR(255),
    @OtherDetail5 NVARCHAR(255),
    @OtherDetail6 NVARCHAR(255),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[FeedbackMaster]
    SET
        [HospitalId] = @HospitalId,
        [MasterId] = @MasterId,
        [MasterType] = @MasterType,
        [Rating] = @Rating,
        [ExperienceLevel] = TRIM(@ExperienceLevel),
        [Description] = TRIM(@Description),
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [FeedbackId] = @FeedbackId;

    SELECT 
        [FeedbackId],
        [HospitalId],
        [MasterId],
        [MasterType],
        [Rating],
        [ExperienceLevel],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[FeedbackMaster]
    WHERE [FeedbackId] = @FeedbackId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_Create]
(
    @FeedbackId INT,
	@PatientId INT,
	@WardId INT,
	@RoomId INT,
	@BedId INT,
	@TreatmentId INT,
	@DischargeDate DATETIME,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PatientFeedbackId BIGINT;

    INSERT INTO [hm].[FeedbackPatientDischarge]
    (
        [FeedbackId],
        [PatientId],
        [WardId],
        [RoomId],
        [BedId],
        [TreatmentId],
        [DischargeDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @FeedbackId,
        @PatientId,
        @WardId,
        @RoomId,
        @BedId,
        @TreatmentId,
        @DischargeDate,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
         1,
         0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @PatientFeedbackId = SCOPE_IDENTITY();

    SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[FeedbackPatientDischarge]
    WHERE [PatientFeedbackId] = @PatientFeedbackId;
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[FeedbackPatientDischarge_Delete]
(
   @PatientFeedbackId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[FeedbackPatientDischarge]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [PatientFeedbackId] = @PatientFeedbackId
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackPatientDischarge]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_ReadByBedId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_ReadByBedId]
(
   @BedId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackPatientDischarge]
	  WHERE [BedId] = @BedId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_ReadByFeedbackId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_ReadByFeedbackId]
(
   @FeedbackId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackPatientDischarge]
	  WHERE [FeedbackId] = @FeedbackId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_ReadById]
(
   @PatientFeedbackId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackPatientDischarge]
	  WHERE [PatientFeedbackId] = @PatientFeedbackId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_ReadByPatientId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_ReadByPatientId]
(
   @PatientId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackPatientDischarge]
	  WHERE [PatientId] = @PatientId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_ReadByRoomId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_ReadByRoomId]
(
   @RoomId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackPatientDischarge]
	  WHERE [RoomId] = @RoomId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_ReadByTreatmentId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_ReadByTreatmentId]
(
   @TreatmentId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackPatientDischarge]
	  WHERE [TreatmentId] = @TreatmentId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_ReadByWardId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_ReadByWardId]
(
   @WardId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PatientFeedbackId]
      ,[FeedbackId]
      ,[PatientId]
      ,[WardId]
      ,[RoomId]
      ,[BedId]
      ,[TreatmentId]
      ,[DischargeDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[FeedbackPatientDischarge]
	  WHERE [WardId] = @WardId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[FeedbackPatientDischarge_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[FeedbackPatientDischarge_Update]
(
    @PatientFeedbackId INT,
	@FeedbackId INT,
	@PatientId INT,
	@WardId INT,
	@RoomId INT,
	@BedId INT,
	@TreatmentId INT,
	@DischargeDate DATETIME,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[FeedbackPatientDischarge]
    SET
        [FeedbackId] = @FeedbackId,
        [PatientId] = @PatientId,
        [WardId] = @WardId,
        [RoomId] = @RoomId,
        [BedId] = @BedId,
        [TreatmentId] = @TreatmentId,
        [DischargeDate] = @DischargeDate,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [PatientFeedbackId] = @PatientFeedbackId;

    SELECT 
        [PatientFeedbackId],
        [FeedbackId],
        [PatientId],
        [WardId],
        [RoomId],
        [BedId],
        [TreatmentId],
        [DischargeDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[FeedbackPatientDischarge]
    WHERE [PatientFeedbackId] = @PatientFeedbackId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[Hospital_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[Hospital_Update]
(
    @HospitalId       INT,
    @HospitalName     VARCHAR(200),
    @HospitalCode     VARCHAR(50),
    @HospitalDesc     VARCHAR(500),
    @Address          VARCHAR(255),
    @Email            VARCHAR(100),
    @ContactNumber    VARCHAR(20),
    @City             VARCHAR(100),
    @State            VARCHAR(100),
    @Country          VARCHAR(100),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[Hospital]
    SET
        [HospitalName]   = @HospitalName,
        [HospitalCode]   = @HospitalCode,
        [HospitalDesc]   = @HospitalDesc,
        [Address]        = @Address,
        [Email]          = @Email,
        [ContactNumber]  = @ContactNumber,
        [City]           = @City,
        [State]          = @State,
        [Country]        = @Country,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE
        [HospitalId] = @HospitalId;

    SELECT
        [HospitalId],
        [HospitalName],
        [HospitalCode],
        [HospitalDesc],
        [Address],
        [Email],
        [ContactNumber],
        [City],
        [State],
        [Country],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[Hospital]
    WHERE [HospitalId] = @HospitalId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalBedMaster_Create]
(
	@HospitalId INT,
	@WardId INT,
	@RoomId INT,
	@BedNumber VARCHAR(50),
	@BedType VARCHAR(50),
	@Isoccupied INT,
	@OccupiedBy INT,
	@OccupiedFrom DATETIME,
	@BaseCharge DECIMAL,
    @TaxPercentage INT,
    @TaxAmount DECIMAL,
    @TotalCharge DECIMAL,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BedId INT;

    INSERT INTO [hm].[HospitalBedMaster]
    (
       [HospitalId]
      ,[WardId]
      ,[RoomId]
      ,[BedNumber]
      ,[BedType]
      ,[Isoccupied]
      ,[OccupiedBy]
      ,[OccupiedFrom]
	  ,[BaseCharge]
      ,[TaxPercentage]
      ,[TaxAmount]
      ,[TotalCharge]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      
    )
    VALUES
    (
        @HospitalId,
        @WardId,
        @RoomId,
        @BedNumber,
        @BedType,
        @Isoccupied,
        @OccupiedBy,
        @OccupiedFrom,
		@BaseCharge,
	    @TaxPercentage, 
        @TaxAmount,
        @TotalCharge,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
         1,
         0,
        @ActionUser,
        GETDATE()
    );

    SET @BedId = SCOPE_IDENTITY();

    SELECT 
	   [BedId]
      ,[HospitalId]
      ,[WardId]
      ,[RoomId]
      ,[BedNumber]
      ,[BedType]
      ,[Isoccupied]
      ,[OccupiedBy]
      ,[OccupiedFrom]
	  ,[BaseCharge]
      ,[TaxPercentage]
      ,[TaxAmount]
      ,[TotalCharge]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[HospitalBedMaster]
    WHERE [BedId] = @BedId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_CreateBulk]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalBedMaster_CreateBulk]
(
    @BedList [hm].[udt_HospitalBedMaster] READONLY,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO [hm].[HospitalBedMaster]
    (
        HospitalId,
        WardId,
        RoomId,
        BedNumber,
        BedType,
        IsOccupied,
        OccupiedBy,
        OccupiedFrom,
        BaseCharge,
        TaxPercentage,
        TaxAmount,
        TotalCharge,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    SELECT
        HospitalId,
        WardId,
        RoomId,
        BedNumber,
        BedType,
        IsOccupied,
        OccupiedBy,
        OccupiedFrom,
        BaseCharge,
        TaxPercentage,
        TaxAmount,
        TotalCharge,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        1,
        0,               -- default IsDeleted
        @ActionUser,     -- CreatedBy
        GETDATE()        -- CreatedOn
    FROM @BedList;

    -- Return inserted rows
    SELECT 
        BedId,
        HospitalId,
        WardId,
        RoomId,
        BedNumber,
        BedType,
        IsOccupied,
        OccupiedBy,
        OccupiedFrom,
        BaseCharge,
        TaxPercentage,
        TaxAmount,
        TotalCharge,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [hm].[HospitalBedMaster]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalBedMaster_Delete]
(
   @BedId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[HospitalBedMaster]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [BedId] = @BedId
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalBedMaster_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[BedId]
      ,A.[HospitalId]
      ,A.[WardId]
	  ,B.[WardName]
      ,A.[RoomId]
	  ,C.[RoomNumber]
      ,A.[BedNumber]
      ,A.[BedType]
      ,A.[Isoccupied]
      ,A.[OccupiedBy]
      ,A.[OccupiedFrom]
	  ,A.[BaseCharge]
      ,A.[TaxPercentage]
      ,A.[TaxAmount]
      ,A.[TotalCharge]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[HospitalBedMaster]A
	  LEFT OUTER JOIN [hm].[HospitalWardMaster]B
	  ON A.[WardId] = B.[WardId]
	  LEFT OUTER JOIN  [hm].[HospitalRoomMaster]C
	  ON A.[RoomId] = C.[RoomId]
	  WHERE A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [hm].[HospitalBedMaster_ReadAllPaginated] 
     @PageSize = 10, 
     @PageNo = 1, 
     @OrderByClause = '', 
     @WhereClause = '';
*/

CREATE PROCEDURE [hm].[HospitalBedMaster_ReadAllPaginated]
(
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON; 

    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = 
        'SELECT
            ROW_NUMBER() OVER (ORDER BY ' + 
            ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'HospitalId DESC') + 
            ') AS RowNum,
          [BedId],
          [HospitalId],
          [WardId],
          [RoomId],
          [BedNumber],
          [BedType],
          [Isoccupied],
          [OccupiedBy],
          [OccupiedFrom],
          [OtherDetail1],
          [OtherDetail2],
          [OtherDetail3],
          [OtherDetail4],
          [OtherDetail5],
          [OtherDetail6],
          [IsActive],
          [IsDeleted],
          [CreatedBy],
          [CreatedOn],
          [ModifiedBy],
          [ModifiedOn],
          [BaseCharge],
          [TaxPercentage],
          [TaxAmount],
          [TotalCharge],
             COUNT(*) OVER () AS TotalCount,
             ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
             ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
        FROM [Nishwik].[hm].[HospitalBedMaster]
        WHERE [IsActive] = 1 ';


    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;


    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY HospitalId DESC';

    SET @SQL = @SQL + '
        OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
        FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL; 
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalBedMaster_ReadByHospitalId]
(
   @HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
         A.[BedId]
        ,A.[HospitalId]
        ,D.[HospitalName]
        ,A.[WardId]
        ,B.[WardName]
        ,A.[RoomId]
        ,C.[RoomNumber]
        ,A.[BedNumber]
        ,A.[BedType]
        ,A.[Isoccupied]
        ,A.[OccupiedBy]
        ,E.[FirstName] + ' ' + ISNULL(E.[LastName], '') AS [PatientName]  -- Full Name
        ,A.[OccupiedFrom]
		,A.[BaseCharge]
        ,A.[TaxPercentage]
        ,A.[TaxAmount]
        ,A.[TotalCharge]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
    FROM [hm].[HospitalBedMaster] A
    LEFT OUTER JOIN [hm].[HospitalWardMaster] B
        ON A.[WardId] = B.[WardId]
    LEFT OUTER JOIN [hm].[HospitalRoomMaster] C
        ON A.[RoomId] = C.[RoomId]
    LEFT OUTER JOIN [Nishwik].[hm].[HospitalMaster] D
        ON A.[HospitalId] = D.[HospitalId]
    LEFT OUTER JOIN [dbo].[UserMaster] E
        ON A.[OccupiedBy] = E.[UserId]  -- Match patient by ID
    WHERE A.[HospitalId] = @HospitalId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0
	  ORDER BY BedId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalBedMaster_ReadById]
(
   @BedId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[BedId]
      ,A.[HospitalId]
      ,A.[WardId]
	  ,B.[WardName]
      ,A.[RoomId]
	  ,C.[RoomType]
	  ,C.[RoomNumber]
      ,A.[BedNumber]
      ,A.[BedType]
      ,A.[Isoccupied]
      ,A.[OccupiedBy]
      ,A.[OccupiedFrom]
	  ,A.[BaseCharge]
      ,A.[TaxPercentage]
      ,A.[TaxAmount]
      ,A.[TotalCharge]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	 FROM [hm].[HospitalBedMaster]A
	  LEFT OUTER JOIN [hm].[HospitalWardMaster]B
	  ON A.[WardId] = B.[WardId]
	  LEFT OUTER JOIN  [hm].[HospitalRoomMaster]C
	  ON A.[RoomId] = C.[RoomId]
	  WHERE A.[BedId] = @BedId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0


END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_ReadByRoomId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalBedMaster_ReadByRoomId]
(
   @RoomId INT
)
AS
BEGIN
     SET NOCOUNT ON;
	  SELECT 
	   A.[BedId]
      ,A.[HospitalId]
	  ,D.[HospitalName]
      ,A.[WardId]
	  ,B.[WardName]
      ,A.[RoomId]
	  ,C.[RoomNumber]
      ,A.[BedNumber]
      ,A.[BedType]
      ,A.[Isoccupied]
      ,A.[OccupiedBy]
      ,A.[OccupiedFrom]
	  ,A.[BaseCharge]
      ,A.[TaxPercentage]
      ,A.[TaxAmount]
      ,A.[TotalCharge]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	 FROM [hm].[HospitalBedMaster]A
	  LEFT OUTER JOIN [hm].[HospitalWardMaster]B
	  ON A.[WardId] = B.[WardId]
	  LEFT OUTER JOIN  [hm].[HospitalRoomMaster]C
	  ON A.[RoomId] = C.[RoomId]
	  	  LEFT OUTER JOIN  [Nishwik].[hm].[HospitalMaster]D
	  ON A.HospitalId = D.HospitalId
	  WHERE A.[RoomId] = @RoomId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_ReadByWardId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalBedMaster_ReadByWardId]
(
   @WardId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[BedId]
      ,A.[HospitalId]
	  ,D.[HospitalName]
      ,A.[WardId]
	  ,B.[WardName]
      ,A.[RoomId]
	  ,C.[RoomNumber]
      ,A.[BedNumber]
      ,A.[BedType]
      ,A.[Isoccupied]
      ,A.[OccupiedBy]
      ,A.[OccupiedFrom]
	  ,A.[BaseCharge]
      ,A.[TaxPercentage]
      ,A.[TaxAmount]
      ,A.[TotalCharge]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	 FROM [hm].[HospitalBedMaster]A
	  LEFT OUTER JOIN [hm].[HospitalWardMaster]B
	  ON A.[WardId] = B.[WardId]
	  LEFT OUTER JOIN  [hm].[HospitalRoomMaster]C
	  ON A.[RoomId] = C.[RoomId]
	  LEFT OUTER JOIN  [Nishwik].[hm].[HospitalMaster]D
	  ON A.HospitalId = D.HospitalId
	  WHERE A.[WardId] = @WardId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
	   ORDER BY [CreatedOn] desc;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalBedMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalBedMaster_Update]
(
    @BedId INT,
	@HospitalId INT,
	@WardId INT,
	@RoomId INT,
	@BedNumber VARCHAR(50),
	@BedType VARCHAR(50),
	@Isoccupied INT,
	@OccupiedBy INT,
	@OccupiedFrom DATETIME,
	@BaseCharge DECIMAL,
	@TaxPercentage INT,
	@TaxAmount DECIMAL,
	@TotalCharge DECIMAL,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	IF(@OccupiedBy <> 0 AND @OccupiedBy IS NOT NULL) 
		BEGIN
			UPDATE [hm].[HospitalBedMaster]
			SET
				[Isoccupied] = 0,
				[OccupiedBy] = 0,
				[OccupiedFrom] = NULL,
				[ModifiedBy] = @ActionUser,
				[ModifiedOn] = GETDATE()
			WHERE
				[OccupiedBy] = @OccupiedBy
				AND [BedId] <> @BedId
				AND [IsOccupied] = 1;
		END

    UPDATE [hm].[HospitalBedMaster]
    SET
        [HospitalId] = @HospitalId,
        [WardId] = @WardId,
        [RoomId] = @RoomId,
        [BedNumber] = @BedNumber,
        [BedType] = @BedType,
        [Isoccupied] = @Isoccupied,
        [OccupiedBy] = @OccupiedBy,
        [OccupiedFrom] = @OccupiedFrom,
		[BaseCharge] = @BaseCharge,
		[TaxPercentage] = @TaxPercentage,
		[TaxAmount] = @TaxAmount,
		[TotalCharge] = @TotalCharge,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [BedId] = @BedId;

    SELECT 
       [BedId]
      ,[HospitalId]
      ,[WardId]
      ,[RoomId]
      ,[BedNumber]
      ,[BedType]
      ,[Isoccupied]
      ,[OccupiedBy]
      ,[OccupiedFrom]
	  ,[BaseCharge]
      ,[TaxPercentage]
      ,[TaxAmount]
      ,[TotalCharge]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[HospitalBedMaster]
    WHERE [BedId] = @BedId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalDocMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[HospitalDocMaster_Create]
(
    @MasterType      VARCHAR(50),
    @MasterId        INT,
    @DocType         VARCHAR(50),
    @DocNo           VARCHAR(50),
    @DocDescription  VARCHAR(200),
    @DocPath         VARCHAR(500),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @DocId INT;

	INSERT INTO [hm].[HospitalDocMaster]
	(
		[MasterType],
		[MasterId],
		[DocType],
		[DocNo],
		[DocDescription],
		[DocPath],
		[OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
		[OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
		[IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn]
	)
	VALUES
	(
		@MasterType,
		@MasterId,
		@DocType,
		@DocNo,
		@DocDescription,
		@DocPath,
		@OtherDetail1,
		@OtherDetail2,
		@OtherDetail3,
		@OtherDetail4,
		@OtherDetail5,
		@OtherDetail6,
		1,        
		0,        
		@ActionUser,
		GETDATE()
		);

	SET @DocId = SCOPE_IDENTITY();

	SELECT 
		 [DocId]
		,[MasterType]
		,[MasterId]
		,[DocType]
		,[DocNo]
		,[DocDescription]
		,[DocPath]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[HospitalDocMaster]
	WHERE [DocId] = @DocId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalDocMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalDocMaster_Delete]
(
      @DocId  INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [hm].[HospitalDocMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] =  @ActionUser,
		[ModifiedOn] = getdate()
	WHERE  [DocId] = @DocId
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalDocMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalDocMaster_ReadAll]
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [hm].[HospitalDocMaster]
		WHERE [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalDocMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalDocMaster_ReadById]
(
      @DocId  int
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [hm].[HospitalDocMaster]
		WHERE  [DocId] = @DocId
		AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalDocMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalDocMaster_ReadByMasterId]
(
      @MasterId  INT,
	  @MasterType VARCHAR(50)
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [hm].[HospitalDocMaster]
		WHERE  [MasterId] = @MasterId
		AND [MasterType] = @MasterType
		AND[IsActive]= 1
		AND[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalDocMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[HospitalDocMaster_Update]
(
    @DocId           INT,
    @MasterType      VARCHAR(50),
    @MasterId        INT,
    @DocType         VARCHAR(50),
    @DocNo           VARCHAR(50),
    @DocDescription  VARCHAR(200),
    @DocPath         VARCHAR(500),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
	@IsActive       int,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[HospitalDocMaster]
    SET 
        [MasterType]     = @MasterType,
        [MasterId]       = @MasterId,
        [DocType]        = @DocType,
        [DocNo]          = @DocNo,
        [DocDescription] = @DocDescription,
        [DocPath]        = @DocPath,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
		[IsActive]		 = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE 
        [DocId] = @DocId;

    SELECT 
         [DocId]
        ,[MasterType]
        ,[MasterId]
        ,[DocType]
        ,[DocNo]
        ,[DocDescription]
        ,[DocPath]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [hm].[HospitalDocMaster]
    WHERE [DocId] = @DocId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalImgMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalImgMaster_Create]
(
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ImgId INT;
		IF @IsDefault = 1
	BEGIN
	UPDATE[hm].[HospitalImgMaster]
		SET IsDefault = 0,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND IsActive = 1;
	END
    INSERT INTO [hm].[HospitalImgMaster]
    (
        [MasterType],
        [MasterId],
        [ImgPath],
        [ImgTitle],
        [IsDefault],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterType,
        @MasterId,
        @ImgPath,
        @ImgTitle,
        @IsDefault,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,       
        0,       
        @ActionUser,
        GETDATE()
    );

    SET @ImgId = SCOPE_IDENTITY();

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [hm].[HospitalImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalImgMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalImgMaster_Delete]
(
   @ImgId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [hm].[HospitalImgMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] =1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = getdate()
	WHERE [ImgId] = @ImgId
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalImgMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalImgMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[HospitalImgMaster]
	WHERE [IsActive] = 1
	ORDER BY imgId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalImgMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalImgMaster_ReadById]
(
   @ImgId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[HospitalImgMaster]
	WHERE [ImgId] = @ImgId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalImgMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalImgMaster_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[HospitalImgMaster]
	WHERE [MasterId] = @MasterId
	AND  [MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalImgMaster_ReadByMasterType]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[HospitalImgMaster_ReadByMasterType]
(
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[HospitalImgMaster]
	WHERE [MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalImgMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[HospitalImgMaster_Update]
(
    @ImgId          INT,
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
		IF @IsDefault = 1
		BEGIN
		UPDATE [hm].[HospitalImgMaster]
		SET 
			IsDefault = 0,
			ModifiedBy = @ActionUser,
			ModifiedOn = GETDATE()
		WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND ImgId <> @ImgId
		AND IsActive = 1;
		END
    UPDATE [hm].[HospitalImgMaster]
    SET
         [MasterType]    = @MasterType
        ,[MasterId]      = @MasterId
        ,[ImgPath]       = @ImgPath
        ,[ImgTitle]      = @ImgTitle
        ,[IsDefault]     = @IsDefault
        ,[OtherDetail1]  = @OtherDetail1
        ,[OtherDetail2]  = @OtherDetail2
        ,[OtherDetail3]  = @OtherDetail3
        ,[OtherDetail4]  = @OtherDetail4
        ,[OtherDetail5]  = @OtherDetail5
        ,[OtherDetail6]  = @OtherDetail6
        ,[IsActive]      = @IsActive
        ,[ModifiedBy]    = @ActionUser
        ,[ModifiedOn]    = GETDATE()
    WHERE [ImgId] = @ImgId;

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [hm].[HospitalImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_AdminDashboardKPI]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[HospitalMaster_AdminDashboardKPI]
(
    @HospitalId INT = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        H.HospitalId,
        H.HospitalName,

        COUNT(DISTINCT CASE 
                           WHEN U.Designation LIKE '%Doctor%' 
                           THEN U.UserId 
                       END) AS DoctorCount,

        COUNT(DISTINCT CASE 
                           WHEN U.Designation NOT LIKE '%Doctor%' 
                           THEN U.UserId 
                       END) AS StaffCount,

        ISNULL(SUM(I.TotalAmount), 0) AS TotalRevenue,

        COUNT(DISTINCT CASE 
                           WHEN PB.IsOccupied = 1 AND PB.IsDeleted = 0 
                           THEN PB.PatientId 
                       END) AS AdmittedPatients

    FROM [hm].[HospitalMaster] AS H
    LEFT JOIN [dbo].[UserMaster] AS U 
        ON U.IsActive = 1 
        AND U.IsDeleted = 0
        AND U.OtherDetail1 = CAST(H.HospitalId AS NVARCHAR(50))  -- assuming hospital linked here (adjust if mapped differently)
    LEFT JOIN [hm].[InvoiceMaster] AS I 
        ON I.HospitalId = H.HospitalId
        AND I.IsActive = 1
        AND I.IsDeleted = 0
    LEFT JOIN [hm].[PatientBedAllocationMapping] AS PB 
        ON PB.HospitalId = H.HospitalId
        AND PB.IsActive = 1
        AND PB.IsDeleted = 0
    WHERE 
        H.IsActive = 1 
        AND H.IsDeleted = 0
        AND (@HospitalId IS NULL OR H.HospitalId = @HospitalId)
    GROUP BY 
        H.HospitalId, H.HospitalName
    ORDER BY 
        H.HospitalName;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE   PROCEDURE [hm].[HospitalMaster_Create]
(
    @HospitalName     VARCHAR(200),
    @HospitalCode     VARCHAR(50),
    @HospitalDesc     VARCHAR(500),
    @Address          VARCHAR(255),
    @Email            VARCHAR(100),
    @ContactNumber    VARCHAR(20),
    @City             VARCHAR(100),
    @State            VARCHAR(100),
    @Country          VARCHAR(100),
	@OnBoardingStatus  VARCHAR(50) ,
	@RegistrationNumber  VARCHAR(50),
	@HospitalLogoURL   VARCHAR(1000),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1
        FROM [hm].[HospitalMaster]
        WHERE (RegistrationNumber = @RegistrationNumber  OR Email = @Email)
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('Duplicate entry found. A hospital with the same Code or Registration Number already exists.', 16, 1);
        RETURN;
    END;

    DECLARE @HospitalId INT;

    INSERT INTO [hm].[HospitalMaster]
    (
       [HospitalName]
      ,[HospitalCode]
      ,[HospitalDesc]
      ,[Address]
      ,[Email]
      ,[ContactNumber]
      ,[City]
      ,[State]
      ,[Country]
	  ,[OnBoardingStatus]
	  ,[RegistrationNumber]
	  ,[HospitalLogoURL]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
    )
    VALUES
    (
        @HospitalName,
        @HospitalCode,
        @HospitalDesc,
        @Address,
        @Email,
        @ContactNumber,
        @City,
        @State,
        @Country,
		@OnBoardingStatus,
		@RegistrationNumber,
		@HospitalLogoURL,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,
        GETDATE()
    );

    SET @HospitalId = SCOPE_IDENTITY();

    SELECT
       [HospitalId]
      ,[HospitalName]
      ,[HospitalCode]
      ,[HospitalDesc]
      ,[Address]
      ,[Email]
      ,[ContactNumber]
      ,[City]
      ,[State]
      ,[Country]
	  ,[OnBoardingStatus]
	  ,[RegistrationNumber]
	  ,[HospitalLogoURL]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[HospitalMaster]
    WHERE HospitalId = @HospitalId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalMaster_Delete]
(
      @HospitalId int,
	  @ActionUser varchar(50)
)
AS
 BEGIN
  SET NOCOUNT ON;
     UPDATE [hm].[HospitalMaster]
	 SET
		    [IsActive]  = 0,
		    [IsDeleted] =1,
		    [ModifiedBy] = @ActionUser,
		    [ModifiedOn] = GETDATE()
	  WHERE  [HospitalId] = @HospitalId
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_GetSummaryByHospital]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 
--SELECT * FROM hm.HospitalMaster

CREATE PROCEDURE [hm].[HospitalMaster_GetSummaryByHospital]
(
    @HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;
    SELECT 
        A.HospitalId,
        A.HospitalName,
        COUNT(DISTINCT B.PatientId) AS PatientCount,
        SUM(CASE WHEN B.OccupiedTo IS NULL THEN 1 ELSE 0 END) AS AdmittedPatientCount,
        SUM(CASE WHEN C.EndDate > GETDATE() THEN 1 ELSE 0 END) AS FollowUpPatientCount,
        ISNULL(SUM(C.TotalCost), 0) AS TotalBilling
    FROM [hm].[HospitalMaster] AS A
    LEFT JOIN [hm].[PatientBedAllocationMapping] AS B
        ON A.HospitalId = B.HospitalId
        AND B.IsActive = 1 AND B.IsDeleted = 0
    LEFT JOIN [hm].[TreatmentPlanMaster] AS C
        ON A.HospitalId = C.HospitalId
        AND C.IsActive = 1 AND C.IsDeleted = 0
    LEFT JOIN [hm].[InvoiceMaster] AS D
        ON A.HospitalId = D.HospitalId
        AND D.IsActive = 1 AND D.IsDeleted = 0
    WHERE A.IsActive = 1 AND A.IsDeleted = 0
      AND (@HospitalId = 0 OR A.HospitalId = @HospitalId)
	  AND B. IsOccupied = 1
    GROUP BY A.HospitalId, A.HospitalName;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_OnboardingComplete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalMaster_OnboardingComplete]
(
    @HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[HospitalMaster]
    SET 
	OnBoardingStatus = 'Completed'
    WHERE HospitalId = @HospitalId;
END
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_OnboardingReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [hm].[HospitalMaster_OnboardingReadAllPaginated] 
    @PageSize = 10,
    @PageNo = 1,
    @OrderByClause = '',
    @WhereClause = '';
*/
CREATE   PROCEDURE [hm].[HospitalMaster_OnboardingReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL

)
AS
 BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL =
		'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum
			,[HospitalId]
			,[HospitalName]
			,[HospitalCode]
			,[HospitalDesc]
			,[Address]
			,[Email]
			,[ContactNumber]
			,[City]
			,[State]
			,[Country]
			,[OnBoardingStatus]
			,[RegistrationNumber]
			,[HospitalLogoURL]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	     ,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [hm].[HospitalMaster]
		WHERE [IsActive] = 1 AND [OnBoardingStatus] = ''Pending''';


	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
	END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalMaster_ReadAll]
AS
BEGIN
    SET NOCOUNT ON;
    SELECT 
        A.HospitalId,
        A.HospitalName,
        A.HospitalCode,
        A.HospitalDesc,
        A.Address,
        A.Email,
        A.ContactNumber,
        A.City,
        A.State,
        A.Country,
		A.OnBoardingStatus,
	    A.OnBoardingStatus,
		A.RegistrationNumber,
        A.OtherDetail1,
        A.OtherDetail2,
        A.OtherDetail3,
        A.OtherDetail4,
        A.OtherDetail5,
        A.OtherDetail6,
		A.HospitalLogoURL,
        A.IsActive,
        A.IsDeleted,
        A.CreatedBy,
        A.CreatedOn,
        A.ModifiedBy,
        A.ModifiedOn,
        COUNT(DISTINCT U1.UserId) AS PatientCount,
        COUNT(DISTINCT U2.UserId) AS DoctorCount,
        COUNT(DISTINCT S.ServiceId) AS ServiceCount,
        COUNT(DISTINCT I.InvoiceId) AS InvoiceCount
    FROM [hm].[HospitalMaster] A
    LEFT JOIN [hm].[UserAffiliationMapping] U1 
        ON U1.HospitalId  = A.HospitalId
       AND U1.AffiliationType = 'Patient'

    LEFT JOIN [hm].[UserAffiliationMapping] U2 
        ON U2.HospitalId  = A.HospitalId
       AND U2.AffiliationType = 'Doctor'

    LEFT JOIN [hm].[ServiceMaster] S 
        ON S.HospitalId = A.HospitalId

    LEFT JOIN [hm].[InvoiceMaster] I 
        ON I.HospitalId = A.HospitalId

    WHERE A.IsActive = 1 AND A.IsDeleted = 0

    GROUP BY 
        A.HospitalId,
        A.HospitalName,
        A.HospitalCode,
        A.HospitalDesc,
        A.Address,
        A.Email,
        A.ContactNumber,
        A.City,
        A.State,
        A.Country,
		A.OnBoardingStatus,
		A.RegistrationNumber,
        A.OtherDetail1,
        A.OtherDetail2,
        A.OtherDetail3,
        A.OtherDetail4,
        A.OtherDetail5,
        A.OtherDetail6,
		A.HospitalLogoURL,
        A.IsActive,
        A.IsDeleted,
        A.CreatedBy,
        A.CreatedOn,
        A.ModifiedBy,
        A.ModifiedOn
    ORDER BY A.HospitalId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [hm].[HospitalMaster_ReadAllPaginated] 
     @PageSize = 10, 
     @PageNo = 1, 
     @OrderByClause = '', 
     @WhereClause = '';
*/

CREATE PROCEDURE [hm].[HospitalMaster_ReadAllPaginated]
(
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON; 

    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = 
        'SELECT
            ROW_NUMBER() OVER (ORDER BY ' + 
            ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'HospitalId DESC') + 
            ') AS RowNum,
             [HospitalId],
             [HospitalName],
             [HospitalCode],
             [HospitalDesc],
             [Address],
             [Email],
             [ContactNumber],
             [City],
             [State],
             [Country],
             [OnBoardingStatus],
             [RegistrationNumber],
             [HospitalLogoURL],
             [OtherDetail1],
             [OtherDetail2],
             [OtherDetail3],
             [OtherDetail4],
             [OtherDetail5],
             [OtherDetail6],
             [IsActive],
             [IsDeleted],
             [CreatedBy],
             [CreatedOn],
             [ModifiedBy],
             [ModifiedOn],
             COUNT(*) OVER () AS TotalCount,
             ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
             ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
        FROM [hm].[HospitalMaster]
        WHERE [IsActive] = 1 AND [OnBoardingStatus] = ''Completed''';


    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;


    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY HospitalId DESC';

    SET @SQL = @SQL + '
        OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
        FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL; 
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[HospitalMaster_ReadById]
(
    @HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        A.[HospitalId],
        A.[HospitalName],
        A.[HospitalCode],
        A.[HospitalDesc],
        A.[Address],
        A.[Email],
        A.[ContactNumber],
        A.[City],
        A.[State],
        A.[Country],
        A.[OnBoardingStatus],
        A.[RegistrationNumber],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
		A.[HospitalLogoURL],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn],
        ISNULL(WingCount.TotalWingCount, 0) AS TotalWingCount,
        ISNULL(WardCount.TotalWardCount, 0) AS TotalWardCount,
        ISNULL(RoomCount.TotalRoomCount, 0) AS TotalRoomCount,
        ISNULL(BedCount.TotalBedCount, 0) AS TotalBedCount

    FROM [hm].[HospitalMaster] A

    LEFT JOIN (
        SELECT HospitalId, COUNT(*) AS TotalWingCount
        FROM [hm].[HospitalWingMaster]
        WHERE IsActive = 1 AND IsDeleted = 0
        GROUP BY HospitalId
    ) WingCount ON A.HospitalId = WingCount.HospitalId

    LEFT JOIN (
        SELECT HospitalId, COUNT(*) AS TotalWardCount
        FROM [hm].[HospitalWardMaster]
        WHERE IsActive = 1 AND IsDeleted = 0
        GROUP BY HospitalId
    ) WardCount ON A.HospitalId = WardCount.HospitalId

    LEFT JOIN (
        SELECT HospitalId, COUNT(*) AS TotalRoomCount
        FROM [hm].[HospitalRoomMaster]
        WHERE IsActive = 1 AND IsDeleted = 0
        GROUP BY HospitalId
    ) RoomCount ON A.HospitalId = RoomCount.HospitalId

    LEFT JOIN (
        SELECT HospitalId, COUNT(*) AS TotalBedCount
        FROM [hm].[HospitalBedMaster]
        WHERE IsActive = 1 AND IsDeleted = 0
        GROUP BY HospitalId
    ) BedCount ON A.HospitalId = BedCount.HospitalId

    WHERE 
        A.[HospitalId] = @HospitalId
        AND A.[IsActive] = 1
        AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_SmallHospitalDashboardKPI]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[HospitalMaster_SmallHospitalDashboardKPI] 
(
    @HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;


    DECLARE @EndDate DATE = CAST(GETDATE() AS DATE);
    DECLARE @StartDate DATE = DATEADD(DAY, -7, @EndDate);


    DECLARE @TotalDoctors INT;

    SELECT @TotalDoctors = COUNT(*)
    FROM hm.UserAffiliationMapping m
    WHERE m.HospitalId = @HospitalId
      AND ISNULL(m.IsDeleted,0) = 0
      AND UPPER(LTRIM(RTRIM(ISNULL(m.AffiliationType,'')))) = 'DOCTOR';


    DECLARE @TotalStaff INT;

    SELECT @TotalStaff = COUNT(*)
    FROM hm.UserAffiliationMapping m
    WHERE m.HospitalId = @HospitalId
      AND ISNULL(m.IsDeleted,0) = 0
      AND UPPER(LTRIM(RTRIM(ISNULL(m.AffiliationType,'')))) = 'HOSPITAL STAFF';


    DECLARE @AdmittedPatients INT;

    SELECT @AdmittedPatients = COUNT(*)
    FROM hm.PatientBedAllocationMapping p
    WHERE p.HospitalId = @HospitalId
      AND ISNULL(p.IsDeleted,0) = 0
      AND (
            UPPER(LTRIM(RTRIM(ISNULL(p.PmtStatus,'')))) LIKE '%ADMIT%'
            OR ISNULL(p.IsOccupied,0) = 1
          );


    DECLARE @WeeklyRevenue DECIMAL(18,2);

    SELECT @WeeklyRevenue = ISNULL(SUM(ISNULL(TotalAmount,0)),0)
    FROM hm.InvoiceMaster inv
    WHERE inv.HospitalId = @HospitalId
	  AND PmtStatus='paid'
      AND ISNULL(inv.IsDeleted,0) = 0
      AND CAST(inv.InvoiceDate AS DATE) BETWEEN @StartDate AND @EndDate;


    DECLARE @HospitalName NVARCHAR(300);

    SELECT @HospitalName = HospitalName
    FROM hm.HospitalMaster
    WHERE HospitalId = @HospitalId;


    SELECT
        @HospitalName AS HospitalName,
        @TotalDoctors AS TotalDoctors,
        @TotalStaff AS TotalStaff,
        @AdmittedPatients AS AdmittedPatients,
        @WeeklyRevenue AS WeeklyRevenue
        ;
END;


GO
/****** Object:  StoredProcedure [hm].[HospitalMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[HospitalMaster_Update]
(
    @HospitalId       INT,
    @HospitalName     VARCHAR(200),
    @HospitalCode     VARCHAR(50),
    @HospitalDesc     VARCHAR(500),
    @Address          VARCHAR(255),
    @Email            VARCHAR(100),
    @ContactNumber    VARCHAR(20),
    @City             VARCHAR(100),
    @State            VARCHAR(100),
    @Country          VARCHAR(100),
	@OnBoardingStatus VARCHAR(50),
	@RegistrationNumber   VARCHAR(50),
	@HospitalLogoURL  VARCHAR(1000),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
	@IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
	    IF EXISTS (
        SELECT 1
        FROM [hm].[HospitalMaster]
        WHERE (RegistrationNumber = @RegistrationNumber  OR  Email = @Email )
          AND IsDeleted = 0 AND HospitalId <> @HospitalId
    )
    BEGIN
        RAISERROR('Duplicate entry found. A hospital with the same Code or Registration Number already exists.', 16, 1);
        RETURN;
    END;
    UPDATE [hm].[HospitalMaster]
    SET
        [HospitalName]   = @HospitalName,
        [HospitalCode]   = @HospitalCode,
        [HospitalDesc]   = @HospitalDesc,
        [Address]        = @Address,
        [Email]          = @Email,
        [ContactNumber]  = @ContactNumber,
        [City]           = @City,
        [State]          = @State,
        [Country]        = @Country,
		[OnBoardingStatus] = @OnBoardingStatus,
		[RegistrationNumber] = @RegistrationNumber,
		[HospitalLogoURL]  = @HospitalLogoURL,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
		[IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE
        [HospitalId] = @HospitalId;

    SELECT
        [HospitalId],
        [HospitalName],
        [HospitalCode],
        [HospitalDesc],
        [Address],
        [Email],
        [ContactNumber],
        [City],
        [State],
        [Country],
		[OnBoardingStatus],
		[RegistrationNumber],
		[HospitalLogoURL],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[HospitalMaster]
    WHERE [HospitalId] = @HospitalId
	 AND [IsActive] = 1
	 AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_Create]
(
    @HospitalId INT,
	@WingId INT,
	@WardId INT,
	@RoomNumber VARCHAR(50),
	@RoomType VARCHAR(50),
	@FloorNumber INT,
	@BedCapacity INT,
	@Description VARCHAR(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RoomId BIGINT;

    INSERT INTO [hm].[HospitalRoomMaster]
    (
       [HospitalId]
      ,[WingId]
      ,[WardId]
      ,[RoomNumber]
      ,[RoomType]
      ,[FloorNumber]
      ,[BedCapacity]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        @WingId,
        @WardId,
        @RoomNumber,
        @RoomType,
        @FloorNumber,
        @BedCapacity,
        @Description,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
         1,
         0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @RoomId = SCOPE_IDENTITY();

    SELECT 
	   [RoomId]
      ,[HospitalId]
      ,[WingId]
      ,[WardId]
      ,[RoomNumber]
      ,[RoomType]
      ,[FloorNumber]
      ,[BedCapacity]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[HospitalRoomMaster]
    WHERE [RoomId] = @RoomId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_CreateBulk]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_CreateBulk]
(
    @RoomList [hm].[udt_RoomMaster] READONLY,  -- Use the correct type name
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO [hm].[HospitalRoomMaster]
    (
        HospitalId,
        WingId,
        WardId,
        RoomNumber,
        RoomType,
        FloorNumber,
        BedCapacity,
        Description,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    SELECT
        HospitalId,
        WingId,
        WardId,
        RoomNumber,
        RoomType,
        FloorNumber,
        BedCapacity,
        Description,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        0,               -- default IsDeleted
        @ActionUser,     -- CreatedBy
        GETDATE()        -- CreatedOn
    FROM @RoomList;

    -- Return inserted rows
    SELECT *
    FROM [hm].[HospitalRoomMaster]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_Delete]
(
   @RoomId BIGINT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[HospitalRoomMaster]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [RoomId] = @RoomId

	Update [hm].[HospitalBedMaster]
	SET
		[IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [RoomId] IN (
        SELECT [RoomId]
        FROM [hm].[HospitalRoomMaster]
        WHERE [RoomId] = @RoomId
    );
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [RoomId]
      ,[HospitalId]
      ,[WingId]
      ,[WardId]
      ,[RoomNumber]
      ,[RoomType]
      ,[FloorNumber]
      ,[BedCapacity]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[HospitalRoomMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0 
	  ORDER BY RoomId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_ReadByHospitalId]
(
   @HospitalId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [RoomId]
      ,[HospitalId]
      ,[WingId]
      ,[WardId]
      ,[RoomNumber]
      ,[RoomType]
      ,[FloorNumber]
      ,[BedCapacity]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[HospitalRoomMaster]
	  WHERE [HospitalId] = @HospitalId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
	  ORDER BY RoomId DESC ;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_ReadById]
(
   @RoomId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[RoomId]
      ,A.[HospitalId]
      ,A.[WingId]
      ,A.[WardId]
	  ,B.[WardType]
      ,A.[RoomNumber]
      ,A.[RoomType]
      ,A.[FloorNumber]
      ,A.[BedCapacity]
      ,A.[Description]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[HospitalRoomMaster] A
	  LEFT OUTER JOIN [hm].[HospitalWardMaster] B
	  ON A.WardId = B.WardId
	  WHERE A.[RoomId] = @RoomId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
	  ORDER BY RoomId DESC 
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_ReadByWardId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_ReadByWardId]
(
   @WardId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [RoomId]
      ,[HospitalId]
      ,[WingId]
      ,[WardId]
      ,[RoomNumber]
      ,[RoomType]
      ,[FloorNumber]
      ,[BedCapacity]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[HospitalRoomMaster]
	  WHERE [WardId] = @WardId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
	  ORDER BY RoomId DESC;

END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_ReadByWingId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_ReadByWingId]
(
   @WingId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [RoomId]
      ,[HospitalId]
      ,[WingId]
      ,[WardId]
      ,[RoomNumber]
      ,[RoomType]
      ,[FloorNumber]
      ,[BedCapacity]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[HospitalRoomMaster]
	  WHERE [WingId] = @WingId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
	   ORDER BY RoomId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalRoomMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalRoomMaster_Update]
(
    @RoomId INT,
	@HospitalId INT,
	@WingId INT,
	@WardId INT,
	@RoomNumber VARCHAR(50),
	@RoomType VARCHAR(50),
	@FloorNumber INT,
	@BedCapacity INT,
	@Description VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[HospitalRoomMaster]
    SET
        [HospitalId] = @HospitalId,
        [WingId] = @WingId,
        [WardId] = @WardId,
        [RoomNumber] = @RoomNumber,
        [RoomType] = @RoomType,
        [FloorNumber] = @FloorNumber,
        [BedCapacity] = @BedCapacity,
        [Description]   = @Description,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [RoomId] = @RoomId;

    SELECT 
       [RoomId]
      ,[HospitalId]
      ,[WingId]
      ,[WardId]
      ,[RoomNumber]
      ,[RoomType]
      ,[FloorNumber]
      ,[BedCapacity]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[HospitalRoomMaster]
    WHERE [RoomId] = @RoomId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalWardMaster_Create]
(
    @HospitalId     INT,
    @WingId         INT,
    @WardName       VARCHAR(100),
    @WardCode       VARCHAR(50),
    @WardType       VARCHAR(50),
    @Capacity       INT,
    @GenderType     VARCHAR(20),
    @Description    VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @WardId INT;

    INSERT INTO [hm].[HospitalWardMaster]
    (
        [HospitalId],
        [WingId],
        [WardName],
        [WardCode],
        [WardType],
        [Capacity],
        [GenderType],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        @WingId,
        TRIM(@WardName),
        TRIM(@WardCode),
        TRIM(@WardType),
        @Capacity,
        TRIM(@GenderType),
        TRIM(@Description),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @WardId = SCOPE_IDENTITY();

    SELECT 
        [WardId],
        [HospitalId],
        [WingId],
        [WardName],
        [WardCode],
        [WardType],
        [Capacity],
        [GenderType],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[HospitalWardMaster]
    WHERE [WardId] = @WardId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_CreateBulk]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [hm].[HospitalWardMaster_CreateBulk]
(
    @WardList [hm].[udt_HospitalWardMaster] READONLY,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO [hm].[HospitalWardMaster]
    (
        HospitalId,
        WingId,
        WardName,
        WardCode,
        WardType,
        Capacity,
        GenderType,
        Description,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    SELECT
        HospitalId,
        WingId,
        WardName,
        WardCode,
        WardType,
        Capacity,
        GenderType,
        Description,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        0,               -- default IsDeleted
        @ActionUser,     -- CreatedBy
        GETDATE()        -- CreatedOn
    FROM @WardList;

    -- Return inserted rows
    SELECT 
        WardId,
        HospitalId,
        WingId,
        WardName,
        WardCode,
        WardType,
        Capacity,
        GenderType,
        Description,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [hm].[HospitalWardMaster]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalWardMaster_Delete]
(
   @WardId  INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE [hm].[HospitalWardMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [WardId] = @WardId

	Update [hm].[HospitalRoomMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [WardId] = @WardId

	Update [hm].[HospitalBedMaster]
	SET
		[IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [RoomId] IN (
        SELECT [RoomId]
        FROM [hm].[HospitalRoomMaster]
        WHERE [WardId] = @WardId
    );

END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalWardMaster_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[WardId]
	  ,C.[WardName]
      ,A.[HospitalId]
      ,A.[WingId]
	  ,B.[WingName]
      ,A.[WardName]
      ,A.[WardCode]
      ,A.[WardType]
      ,A.[Capacity]
      ,A.[GenderType]
      ,A.[Description]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[HospitalWardMaster]A
	  LEFT OUTER JOIN [hm].[HospitalWingMaster]B
	  ON  A.[WingId] = B.[WingId]
	  LEFT OUTER JOIN [hm].[HospitalWardMaster]C
	  ON  A.[WardId] =  C.[WardId]
	  WHERE A. [IsActive] = 1
	  AND A.[IsDeleted] = 0
	  ORDER BY [WardId] DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [hm].[HospitalBedMaster_ReadAllPaginated] 
     @PageSize = 10, 
     @PageNo = 1, 
     @OrderByClause = '', 
     @WhereClause = '';
*/

CREATE PROCEDURE [hm].[HospitalWardMaster_ReadAllPaginated]
(
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON; 

    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = 
        'SELECT
            ROW_NUMBER() OVER (ORDER BY ' + 
            ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'HospitalId DESC') + 
            ') AS RowNum,
              [WardId],
              [HospitalId],
              [WingId],
              [WardName],
              [WardCode],
              [WardType],
              [Capacity],
              [GenderType],
              [Description],
              [OtherDetail1],
              [OtherDetail2],
              [OtherDetail3],
              [OtherDetail4],
              [OtherDetail5],
              [OtherDetail6],
              [IsActive],
              [IsDeleted],
              [CreatedBy],
              [CreatedOn],
              [ModifiedBy],
              [ModifiedOn],
             COUNT(*) OVER () AS TotalCount,
             ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
             ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
        FROM [Nishwik].[hm].[HospitalWardMaster]
        WHERE [IsActive] = 1 ';


    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;


    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY HospitalId DESC';

    SET @SQL = @SQL + '
        OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
        FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL; 
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalWardMaster_ReadByHospitalId]
(
   @HospitalId  INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
       A.[WardId]
	  ,C.[WardName]
      ,A.[HospitalId]
      ,A.[WingId]
	  ,B.[WingName]
      ,A.[WardName]
      ,A.[WardCode]
      ,A.[WardType]
      ,A.[Capacity]
      ,A.[GenderType]
      ,A.[Description]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[HospitalWardMaster]A
	  LEFT OUTER JOIN [hm].[HospitalWingMaster]B
	  ON  A.[WingId] = B.[WingId]
	  LEFT OUTER JOIN [hm].[HospitalWardMaster]C
	  ON  A.[WardId] =  C.[WardId]
	  WHERE A. [HospitalId] = @HospitalId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
	  ORDER BY WardId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalWardMaster_ReadById]
(
   @WardId  INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[WardId]
	  ,C.[WardName]
      ,A.[HospitalId]
      ,A.[WingId]
	  ,B.[WingName]
      ,A.[WardName]
      ,A.[WardCode]
      ,A.[WardType]
      ,A.[Capacity]
      ,A.[GenderType]
      ,A.[Description]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[HospitalWardMaster]A
	  LEFT OUTER JOIN [hm].[HospitalWingMaster]B
	  ON  A.[WingId] = B.[WingId]
	  LEFT OUTER JOIN [hm].[HospitalWardMaster]C
	  ON  A.[WardId] =  C.[WardId]
	  WHERE A. [WardId] = @WardId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_ReadByWingId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalWardMaster_ReadByWingId]
(
   @WingId  INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[WardId]
	  ,C.[WardName]
      ,A.[HospitalId]
      ,A.[WingId]
	  ,B.[WingName]
      ,A.[WardName]
      ,A.[WardCode]
      ,A.[WardType]
      ,A.[Capacity]
      ,A.[GenderType]
      ,A.[Description]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[HospitalWardMaster]A
	  LEFT OUTER JOIN [hm].[HospitalWingMaster]B
	  ON  A.[WingId] = B.[WingId]
	  LEFT OUTER JOIN [hm].[HospitalWardMaster]C
	  ON  A.[WardId] =  C.[WardId]
	  WHERE A. [WingId] = @WingId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWardMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[HospitalWardMaster_Update]
(
    @WardId         INT,
    @HospitalId     INT,
    @WingId         INT,
    @WardName       VARCHAR(100),
    @WardCode       VARCHAR(50),
    @WardType       VARCHAR(50),
    @Capacity       INT,
    @GenderType     VARCHAR(20),
    @Description    VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[HospitalWardMaster]
    SET
        [HospitalId]    = @HospitalId,
        [WingId]        = @WingId,
        [WardName]      = TRIM(@WardName),
        [WardCode]      = TRIM(@WardCode),
        [WardType]      = TRIM(@WardType),
        [Capacity]      = @Capacity,
        [GenderType]    = TRIM(@GenderType),
        [Description]   = TRIM(@Description),
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [WardId] = @WardId;

    SELECT 
        [WardId],
        [HospitalId],
        [WingId],
        [WardName],
        [WardCode],
        [WardType],
        [Capacity],
        [GenderType],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[HospitalWardMaster]
    WHERE [WardId] = @WardId
	 AND [IsActive] = 1
	 AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWingMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[HospitalWingMaster_Create]
(
    @HospitalId     INT,
    @WingName       VARCHAR(100),
    @WingCode       VARCHAR(50),
    @FloorCount     INT,
    @Description    VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @WingId BIGINT;

    INSERT INTO [hm].[HospitalWingMaster]
    (
        [HospitalId],
        [WingName],
        [WingCode],
        [FloorCount],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        TRIM(@WingName),
        TRIM(@WingCode),
        @FloorCount,
        TRIM(@Description),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @WingId = SCOPE_IDENTITY();

    SELECT 
        [WingId],
        [HospitalId],
        [WingName],
        [WingCode],
        [FloorCount],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[HospitalWingMaster]
    WHERE [WingId] = @WingId;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWingMaster_CreateBulk]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[HospitalWingMaster_CreateBulk]
(
    @WingList [hm].[udt_HospitalWingMaster] READONLY,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO [hm].[HospitalWingMaster]
    (
        HospitalId,
        WingName,
        WingCode,
        FloorCount,
        Description,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    SELECT
        HospitalId,
        WingName,
        WingCode,
        FloorCount,
        Description,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        1,
        0,               -- default IsDeleted = 0
        @ActionUser,     -- CreatedBy
        GETDATE()        -- CreatedOn
    FROM @WingList;

    -- return inserted records
    SELECT 
        [WingId],
        [HospitalId],
        [WingName],
        [WingCode],
        [FloorCount],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[HospitalWingMaster]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE()); 
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWingMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalWingMaster_Delete]
(
    @WingId INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN  
	SET NOCOUNT ON;
	UPDATE [hm].[HospitalWingMaster]
	SET
		[IsActive] = 0 ,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE ()
	WHERE [WingId] = @WingId

	Update [hm].[HospitalWardMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [WingId] = @WingId

	Update [hm].[HospitalRoomMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [WingId] = @WingId

	Update [hm].[HospitalBedMaster]
	SET
		[IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [RoomId] IN (
        SELECT [RoomId]
        FROM [hm].[HospitalRoomMaster]
        WHERE [WingId] = @WingId
    );

END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWingMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalWingMaster_ReadAll]
AS
BEGIN  
     SET NOCOUNT ON;
	 SELECT 
	   [WingId]
      ,[HospitalId]
      ,[WingName]
      ,[WingCode]
      ,[FloorCount]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[hm].[HospitalWingMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWingMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalWingMaster_ReadByHospitalId]
(
    @HospitalId INT
)
AS
BEGIN  
     SET NOCOUNT ON;
	 SELECT 
	   [WingId]
      ,[HospitalId]
      ,[WingName]
      ,[WingCode]
      ,[FloorCount]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[hm].[HospitalWingMaster]
	  WHERE [HospitalId] = @HospitalId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
	  ORDER BY HospitalId DESC ;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWingMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[HospitalWingMaster_ReadById]
(
    @WingId INT
)
AS
BEGIN  
     SET NOCOUNT ON;
	 SELECT 
	   [WingId]
      ,[HospitalId]
      ,[WingName]
      ,[WingCode]
      ,[FloorCount]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[hm].[HospitalWingMaster]
	  WHERE [WingId] = @WingId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
	  ORDER BY WingId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[HospitalWingMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[HospitalWingMaster_Update]
(
    @WingId         BIGINT,
    @HospitalId     INT,
    @WingName       VARCHAR(100),
    @WingCode       VARCHAR(50),
    @FloorCount     INT,
    @Description    VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[HospitalWingMaster]
    SET
        [HospitalId]    = @HospitalId,
        [WingName]      = TRIM(@WingName),
        [WingCode]      = TRIM(@WingCode),
        [FloorCount]    = @FloorCount,
        [Description]   = TRIM(@Description),
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [WingId] = @WingId;

    SELECT 
        [WingId],
        [HospitalId],
        [WingName],
        [WingCode],
        [FloorCount],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[HospitalWingMaster]
    WHERE [WingId] = @WingId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceDetail_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[InvoiceDetail_Create]
(
    @InvoiceId        BIGINT,
    @UserId           INT,
    @DoctorId         INT,
    @Remarks          VARCHAR(500),
    @Charges          DECIMAL(18, 2),
    @TaxName          VARCHAR(50),
    @TaxAmount        DECIMAL(18, 2),
    @DiscountName     VARCHAR(50), 
    @DiscountAmount   DECIMAL(18, 2),
    @BaseAmount   DECIMAL(18, 2),
    @PmtStatus    VARCHAR(50),
	@MasterId INT,
	@MasterType VARCHAR(100),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId BIGINT;

    INSERT INTO [hm].[InvoiceDetail]
    (
         [InvoiceId],
         [UserId],
         [DoctorId],
         [Remarks],
         [Charges],
         [TaxName],
         [TaxAmount],
         [DiscountName],
         [DiscountAmount],
		 [BaseAmount],
		 [PmtStatus],
		 [MasterId],
		 [MasterType],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn]
    )
    VALUES
    (
         @InvoiceId,
         @UserId,
         @DoctorId,
         @Remarks,
         @Charges,
         @TaxName,
         @TaxAmount,
         @DiscountName,
         @DiscountAmount,
		 @BaseAmount,
		 @PmtStatus,
		 @MasterId,
		 @MasterType,
         @OtherDetail1,
         @OtherDetail2,
         @OtherDetail3,
         @OtherDetail4,
         @OtherDetail5,
         @OtherDetail6,
         1,                 
         0,                 
         @ActionUser,       
         GETDATE()          
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
         [DetailId],
         [UserId],
         [InvoiceId],
         [DoctorId],
         [Remarks],
         [Charges],
         [TaxName],
         [TaxAmount],
         [DiscountName],
         [DiscountAmount],
		 [BaseAmount],
		 [PmtStatus],
		 [MasterId],
         [MasterType],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [hm].[InvoiceDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceDetail_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[InvoiceDetail_Delete]
(
     @DetailId BIGINT,
	 @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [hm].[InvoiceDetail]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceDetail_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[InvoiceDetail_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
       [DetailId]
      ,[InvoiceId]
      ,[Remarks]
      ,[Charges]
      ,[TaxName]
      ,[TaxAmount]
      ,[DiscountName]
      ,[DiscountAmount]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[DoctorId]
      ,[UserId]
      ,[BaseAmount]
      ,[PmtStatus]
      ,[MasterId]
      ,[MasterType]
	FROM [hm].[InvoiceDetail]
	WHERE [IsActive] = 1
	ORDER BY DetailId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceDetail_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[InvoiceDetail_ReadById]
(
     @DetailId BIGINT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [DetailId]
      ,[InvoiceId]
      ,[ServiceId]
      ,[Remarks]
      ,[Charges]
      ,[TaxName]
      ,[TaxAmount]
      ,[DiscountName]
      ,[DiscountAmount]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[DoctorId]
      ,[UserId]
      ,[BaseAmount]
      ,[PmtStatus]
      ,[serviceName]
      ,[PlanId]
	FROM [hm].[InvoiceDetail]
	WHERE [DetailId] = @DetailId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceDetail_ReadByInvoiceId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[InvoiceDetail_ReadByInvoiceId]
(
     @InvoiceId BIGINT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [DetailId]
		,[UserId]
		,[InvoiceId]
		,[DoctorId]
		,[Remarks]
		,[Charges]
		,[TaxName]
		,[TaxAmount]
		,[DiscountName]
		,[DiscountAmount]
		,[BaseAmount]
	    ,[PmtStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	    ,[MasterId]
		,[MasterType]
	FROM [hm].[InvoiceDetail]
	WHERE [InvoiceId] = @InvoiceId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceDetail_ReadByMasterId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[InvoiceDetail_ReadByMasterId]
(
 @MasterId INT,
 @MasterType VARCHAR(100)
)
AS
BEGIN
    SET NOCOUNT ON;
	SELECT
         [DetailId],
		 [UserId],
         [InvoiceId],
		 [DoctorId],
         [Remarks],
         [Charges],
         [TaxName],
         [TaxAmount],
         [DiscountName],
         [DiscountAmount],
		 [BaseAmount],
		 [PmtStatus],
		 [MasterId],
         [MasterType],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [hm].[InvoiceDetail]
	WHERE [MasterId] = @MasterId 
	AND [MasterType] = @MasterType
	AND [IsActive] = 1 AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceDetail_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[InvoiceDetail_ReadByUserId]
(
     @UserId BIGINT
)
AS
BEGIN 
    SET NOCOUNT ON;

    SELECT 
         A.[DetailId]
        ,A.[UserId]
        ,A.[InvoiceId]
        ,A.[DoctorId]
        ,B.[FirstName] + ' ' + B.[LastName] AS [DoctorName]
        ,A.[Remarks]
        ,A.[Charges]
        ,A.[TaxName]
        ,A.[TaxAmount]
        ,A.[DiscountName]
        ,A.[DiscountAmount]
		,A.[BaseAmount]
	    ,A.[PmtStatus]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
	    ,A.[MasterId]
		,A.[MasterType]
    FROM [hm].[InvoiceDetail] A
    LEFT JOIN [Nishwik].[dbo].[UserMaster] B
        ON A.[DoctorId] = B.[UserId]
    WHERE A.[UserId] = @UserId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [hm].[InvoiceDetail_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[InvoiceDetail_Update]
(
    @DetailId         BIGINT,
    @InvoiceId        BIGINT,
	@UserId         INT,
	@DoctorId         INT,
    @Remarks          VARCHAR(500),
    @Charges          DECIMAL(18, 2),
    @TaxName          VARCHAR(50),
    @TaxAmount        DECIMAL(18, 2),
    @DiscountName     Varchar(50),
    @DiscountAmount   DECIMAL(18, 2),
	@BaseAmount       DECIMAL(18, 2),
    @PmtStatus        VARCHAR(50),
	@MasterId    INT,
    @MasterType varchar (100) ,
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
	@IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[InvoiceDetail]
    SET
         [InvoiceId]        = @InvoiceId,
		 [UserId]        = @UserId,
		 [DoctorId]         = @DoctorId,
         [Remarks]          = @Remarks,
         [Charges]          = @Charges,
         [TaxName]          = @TaxName,
         [TaxAmount]        = @TaxAmount,
         [DiscountName]     = @DiscountName,
         [DiscountAmount]   = @DiscountAmount,
		 [BaseAmount]		= @BaseAmount,
		 [PmtStatus]		= @PmtStatus,
		 [MasterId] = @MasterId,
		 [MasterType] = @MasterType,
         [OtherDetail1]     = @OtherDetail1,
         [OtherDetail2]     = @OtherDetail2,
         [OtherDetail3]     = @OtherDetail3,
         [OtherDetail4]     = @OtherDetail4,
         [OtherDetail5]     = @OtherDetail5,
         [OtherDetail6]     = @OtherDetail6,
		 [IsActive]         = @IsActive,
         [ModifiedBy]       = @ActionUser,
         [ModifiedOn]       = GETDATE()
    WHERE
         [DetailId] = @DetailId ;

    SELECT
         [DetailId],
		 [UserId],
         [InvoiceId],
		 [DoctorId],
         [Remarks],
         [Charges],
         [TaxName],
         [TaxAmount],
         [DiscountName],
         [DiscountAmount],
		 [BaseAmount],
		 [PmtStatus],
		 [MasterId],
         [MasterType],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [hm].[InvoiceDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceHTML_Generate]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[InvoiceHTML_Generate]
(
    @InvoiceId INT 
)
AS
BEGIN
    SET NOCOUNT ON;

    IF OBJECT_ID('tempdb..#TempTable') IS NOT NULL DROP TABLE #TempTable;
    CREATE TABLE #TempTable
    (
        RowNo INT,
        WardName NVARCHAR(100),
        RoomNo NVARCHAR(100),
        BedNo NVARCHAR(100),
        FromDate DATETIME,
        BedTime INT,
        DailyRate DECIMAL(18,2),
        TotalBedCharges DECIMAL(18,2)
    );

    DECLARE
        @PageCounter INT = 0,
        @RowCounter INT = 0,
        @PerPageLimit INT = 26,
        @NoOfInvoicePages INT,
        @CompanyId INT,

        @PageCss NVARCHAR(MAX) = '',
        @HeaderHTML NVARCHAR(MAX) = '',
        @ClientHeaderHTML NVARCHAR(MAX) = '',
        @BedChargesHTML NVARCHAR(MAX) = '',
        @ServiceChargesHTML NVARCHAR(MAX) = '',
        @TreatmentChargesHTML NVARCHAR(MAX) = '',
		@GrandTotalHTML NVARCHAR(MAX) = '',
        @BodyHTML NVARCHAR(MAX) = '',
        @ContinuedFooterHTML NVARCHAR(MAX) = '',
        @LastPageFooterHTML NVARCHAR(MAX) = '',
        @RowHTML NVARCHAR(MAX) = '',

		@HospitalId INT = 0,
		@HospitalName NVARCHAR(100) = '',
		@HospitalAddress NVARCHAR(MAX) = '',
		@HospitalContact NVARCHAR(20) = '',
		@HospitalEmail NVARCHAR(100) = '',

		@PatientId INT = 0,

        @InvoiceNumber NVARCHAR(50) = '',
        @InvoiceDate NVARCHAR(50) = '',
        @PatientName NVARCHAR(100) = '',
        @PaymentTerms NVARCHAR(10) = '',
        @PatientAddress NVARCHAR(2000),
        @PatientEmail NVARCHAR(100) = '',
        @PatientGender NVARCHAR(100) = '',
        @PatientPhone NVARCHAR(100) = '',
        @PatientDOB NVARCHAR(100) = '',
        @PatientContactPerson NVARCHAR(100) = '',
        @PatientBloodGroup NVARCHAR(100) = '',

        @WardName NVARCHAR(50) = '',
        @RoomNo NVARCHAR(50) = '',
        @BedNo NVARCHAR(50) = '',
        @FromDate DATETIME = NULL,
        @ToDate DATETIME = NULL,
        @BedTime INT = 0,
        @DailyRate DECIMAL(18,2) = 0,
        @TotalBedCharges DECIMAL(18,2) = 0,

		@ServiceName NVARCHAR(200),
		@ServiceDate DATETIME,
		@DoctorName NVARCHAR(200),
		@ServiceCost DECIMAL(18,2),
		@ServiceDiscount DECIMAL(18,2),
		@ServiceTax DECIMAL(18,2),
		@ServiceTotalAmount DECIMAL(18,2),

		@TreatmentName NVARCHAR(200),
		@TreatmentTime NVARCHAR(100),
		@TreatmentCost DECIMAL(18,2),
		@TreatmentDiscount DECIMAL(18,2),
		@TreatmentTax DECIMAL(18,2),
		@TreatmentTotalAmount DECIMAL(18,2);


    SELECT
		@HospitalId = HospitalId,
		@PatientId = UserId,
        @InvoiceNumber = InvoiceNumber,
        @InvoiceDate = FORMAT(CAST(InvoiceDate AS DATE), 'dd/MM/yyyy')
    FROM hm.InvoiceMaster 
    WHERE InvoiceId = @InvoiceId;

	SELECT 
	@HospitalName = HospitalName,
	@HospitalAddress = Address,
	@HospitalContact = ContactNumber,
	@HospitalEmail = Email
	from hm.HospitalMaster 
	WHERE HospitalId = @HospitalId;

    SELECT 
        @PatientName = FirstName + ' ' + ISNULL(MiddleName,'') + ' ' + ISNULL(LastName,''),
        @PatientAddress = Address,
        @PatientEmail = EmailId,
        @PatientGender = Gender,
        @PatientPhone = MobileNo,
        @PatientDOB = FORMAT(CAST(DOB AS DATE), 'dd/MM/yyyy'),
        @PatientContactPerson = '',
        @PatientBloodGroup = BloodGroup
    FROM dbo.UserMaster 
    WHERE UserId = @PatientId;


    SET @PageCss = N'
	<!DOCTYPE html>
	<html>

	<head>
    <meta charset="UTF-8">
    <title>Quotation</title>
  <style>
  body {
    margin: 0;
    background: #ccc;
    /* Grey outside */
    display: flex;
    justify-content: center;
    padding: 20px;
  }

  .a4-page {
    width: 210mm;
    height: 297mm;
    background: #fff;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
    padding: 5mm;
    /* reduced padding */
    box-sizing: border-box;
    font-family: Arial, sans-serif;
    font-size: 13px;
    color: #000;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    /* push footer to bottom */
  }

  h2 {
    text-align: center;
    margin: 5px 0;
    font-size: 18px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  .header-table td {
    vertical-align: top;
  }

  .address td {
    font-size: 11px;
    color: #555;
    vertical-align: top;
    padding: 4px 6px;
  }

  .data-table th,
  .data-table td {
    border: 1px solid #ccc;
    padding: 6px;
    font-size: 12px;
  }

  .data-table th {
    background: #f2f2f2;
  }

  .footer-note {
    margin-top: 10px;
    font-size: 11px;
    color: #555;
  }

  /* Commercial Terms */
  .terms-title {
    font-weight: bold;
    margin: 15px 0 5px 0;
    text-decoration: underline;
  }

  .terms-table {
    border: 1px solid #000;
    border-collapse: collapse;
    width: 100%;
    font-size: 12px;
  }

  .terms-table td {
    border: 1px solid #000;
    padding: 6px;
    vertical-align: top;
  }

  .signatory {
    margin-top: 20px;
    font-size: 12px;
    text-align: right;
  }

  .signatory b {
    display: block;
    margin-top: 40px;
  }

  @page {
    size: A4;
    margin: 20mm;
  }

  .footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 25mm;
    font-size: 11px;
    color: #555;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4mm 10mm;
    background: #f9f9f9;
  }

  .footer .left {
    text-align: left;
  }

  .footer .right {
    text-align: right;
  }

  @media print {
    body {
      background: none;
      padding: 0;
    }

    .a4-page {
      box-shadow: none;
      margin: 0;
    }
  }
</style>
</head>
';

    SET @HeaderHTML = N'<body> <div class="a4-page">
        <table class="header-table" style="width:100%; border-bottom:2px solid #000; margin-bottom:10px;">
            <tr>
                <td style="width:60%;">
                    <img src="./images/logo.png" alt="Company Logo" style="height:40px;"><br>
                    <span style="font-size:16px; font-weight:bold; color:#444;">' + @HospitalName + '</span><br>
                    <span style="font-size:11px; color:#555;">' + @HospitalAddress + '</span><br>
                    <span style="font-size:11px; color:#777;">TEL.: ' + @HospitalContact + '</span><br>
                    <span style="font-size:11px; color:#777;">Email:' + @HospitalEmail + '</span>
                </td>
            </tr>
        </table>';

    SET @ClientHeaderHTML = 
    N'<table style="width:100%; border-collapse:collapse;">
        <tr><td style="text-align:center;"><h2>Invoice Details</h2></td></tr>
    </table>
    <table style="width:100%; border:1px solid #ccc; border-collapse: collapse; text-align:left; margin-bottom:15px; font-size:14px;">
        <tr>
            <td style="width:50%; border-right:1px solid #ccc; padding:8px; vertical-align:top;">
                <b>Invoice No.:</b> ' + @InvoiceNumber + '<br>
                <b>Date:</b> ' + @InvoiceDate + '<br>
                <b>Patient Name:</b> ' + @PatientName + '<br>
                <b>Gender:</b> ' + @PatientGender + '<br>
                <b>Date of Birth:</b> ' + @PatientDOB + '<br>
            </td>
            <td style="width:50%; padding:8px; vertical-align:top;">
                <b>Phone:</b> ' + @PatientPhone + '<br>
                <b>Email:</b> ' + @PatientEmail + '<br>
                <b>Blood Group:</b> ' + @PatientBloodGroup + '<br>
                <b>Address:</b> ' + ISNULL(@PatientAddress,'') + '
            </td>
        </tr>
    </table>';

    SET @BedChargesHTML = 
    N'<table class="data-table" style="width:100%; border-collapse: collapse; border:1px solid #000; margin-bottom:20px;">
        <thead>
            <tr><th colspan="8" style="text-align:start; background:none;">BED CHARGES (WITH TAX)</th></tr>
            <tr style="background:#f9f9f9; font-weight:bold;">
                <th>No.</th>
                <th>Ward Name</th>
                <th>Room No.</th>
                <th>Bed No.</th>
                <th>From Date</th>
                <th>Bed Time</th>
                <th>Daily Rate</th>
                <th>Total Bed Charges</th>
            </tr>
        </thead>
        <tbody>';

    DECLARE curBed CURSOR FOR
    SELECT 
        B.WardName,
        C.RoomNumber,
        D.BedNumber,
        A.OccupiedFrom,
        A.OccupiedTo,
        CASE 
            WHEN A.OccupiedTo IS NOT NULL THEN DATEDIFF(DAY, A.OccupiedFrom, A.OccupiedTo)
            ELSE DATEDIFF(DAY, A.OccupiedFrom, GETDATE())
        END AS BedTime,
        D.BaseCharge
    FROM hm.PatientBedAllocationMapping A
        LEFT JOIN hm.HospitalWardMaster B ON A.WardId = B.WardId
        LEFT JOIN hm.HospitalRoomMaster C ON A.RoomId = C.RoomId
        LEFT JOIN hm.HospitalBedMaster D ON A.BedId = D.BedId
    WHERE A.PatientId = @PatientId AND A.IsDeleted = 0;

    OPEN curBed;
    FETCH NEXT FROM curBed INTO @WardName, @RoomNo, @BedNo, @FromDate, @ToDate, @BedTime, @DailyRate;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        IF @BedTime IS NULL SET @BedTime = 1;
        SET @RowCounter += 1;
        SET @TotalBedCharges = @BedTime * ISNULL(@DailyRate,0);

        INSERT INTO #TempTable
        SELECT @RowCounter, @WardName, @RoomNo, @BedNo, @FromDate, @BedTime, @DailyRate, @TotalBedCharges;

        SET @BedChargesHTML += 
            N'<tr>' +
            N'<td style="text-align:center;">' + CAST(@RowCounter AS NVARCHAR(10)) + N'</td>' +
            N'<td>' + ISNULL(@WardName,'') + N'</td>' +
            N'<td style="text-align:center;">' + ISNULL(@RoomNo,'') + N'</td>' +
            N'<td style="text-align:center;">' + ISNULL(@BedNo,'') + N'</td>' +
            N'<td style="text-align:center;">' + CONVERT(NVARCHAR(20), @FromDate, 105) + N'</td>' +
            N'<td style="text-align:center;">' + CAST(@BedTime AS NVARCHAR(10)) + N' Days</td>' +
            N'<td style="text-align:right;">' + FORMAT(ISNULL(@DailyRate,0), 'N2') + N'</td>' +
            N'<td style="text-align:right;">' + FORMAT(ISNULL(@TotalBedCharges,0), 'N2') + N'</td>' +
            N'</tr>';

        FETCH NEXT FROM curBed INTO @WardName, @RoomNo, @BedNo, @FromDate, @ToDate, @BedTime, @DailyRate;
    END

    CLOSE curBed;
    DEALLOCATE curBed;

    SET @BedChargesHTML += N'</tbody></table>';

	SET @ServiceChargesHTML = N'
    <table class="data-table" style="width:100%; border-collapse: collapse; border:1px solid #000; margin-bottom:20px;">
        <thead>
            <tr><th colspan="8" style="text-align:start; background:none;">SERVICE CHARGES</th></tr>
            <tr style="background:#f9f9f9; font-weight:bold;">
                <th>No.</th>
				<th>Service Name</th>
				<th>Date</th>
				<th>Doctor Name</th>
                <th>Cost</th>
				<th>Discount</th>
				<th>Tax</th>
				<th>Total</th>
            </tr>
        </thead><tbody>';

	SET @RowCounter = 0;

	DECLARE curService CURSOR FOR
	SELECT 
		SM.ServiceName,
		ID.CreatedOn AS ServiceDate,
		UM.FirstName + ' ' + ISNULL(UM.LastName,'') AS DoctorName,
		ID.BaseAmount AS ServiceCost,
		ID.DiscountAmount AS ServiceDiscount,
		ID.TaxAmount AS ServiceTax,
		ID.Charges AS ServiceTotalAmount
	FROM hm.InvoiceDetail ID
	LEFT JOIN hm.ServiceMaster SM ON ID.MasterId = SM.ServiceId
	LEFT JOIN dbo.UserMaster UM ON ID.DoctorId = UM.UserId
	WHERE ID.InvoiceId = @InvoiceId AND ID.IsDeleted = 0 AND ID.MasterType = 'Service';

	OPEN curService;
	FETCH NEXT FROM curService INTO @ServiceName, @ServiceDate, @DoctorName, @ServiceCost, @ServiceDiscount, @ServiceTax, @ServiceTotalAmount;

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @RowCounter += 1;
		SET @ServiceChargesHTML += 
			N'<tr><td style="text-align:center;">' + CAST(@RowCounter AS NVARCHAR(10)) + N'</td>' +
			N'<td>' + ISNULL(@ServiceName,'') + N'</td>' +
			N'<td style="text-align:center;">' + CONVERT(NVARCHAR(20), @ServiceDate, 105) + N'</td>' +
			N'<td>' + ISNULL(@DoctorName,'') + N'</td>' +
			N'<td style="text-align:right;">' + FORMAT(ISNULL(@ServiceCost,0), 'N2') + N'</td>' +
			N'<td style="text-align:right;">' + FORMAT(ISNULL(@ServiceDiscount,0), 'N2') + N'</td>' +
			N'<td style="text-align:right;">' + FORMAT(ISNULL(@ServiceTax,0), 'N2') + N'</td>' +
			N'<td style="text-align:right;">' + FORMAT(ISNULL(@ServiceTotalAmount,0), 'N2') + N'</td></tr>';
		FETCH NEXT FROM curService INTO @ServiceName, @ServiceDate, @DoctorName, @ServiceCost, @ServiceDiscount, @ServiceTax, @ServiceTotalAmount;
	END
	CLOSE curService; DEALLOCATE curService;
	SET @ServiceChargesHTML += N'</tbody></table>';

	SET @TreatmentChargesHTML = N'
    <table class="data-table"
        style="width:100%; border-collapse: collapse; border:1px solid #000; margin-bottom:20px;">
        <thead>
            <tr><th colspan="7" style="text-align:start; background:none;">TREATMENT CHARGES</th></tr>
            <tr style="background:#f9f9f9; font-weight:bold;">
                <th>No.</th>
				<th>Treatment / Surgery Name</th>
				<th>Time</th>
                <th>Service Cost</th>
				<th>Discount Amount</th>
				<th>Tax Amount</th>
				<th>Total Amount</th>
            </tr>
        </thead><tbody>';

	SET @RowCounter = 0;

	DECLARE curTreatment CURSOR FOR
	SELECT 
		SM.ServiceName AS TreatmentName,
		CONVERT(NVARCHAR(20), ID.CreatedOn, 108) AS TreatmentTime,
		ID.BaseAmount, ID.DiscountAmount, ID.TaxAmount, ID.Charges
	FROM hm.InvoiceDetail ID
	LEFT JOIN hm.ServiceMaster SM ON ID.MasterId = SM.ServiceId
	LEFT JOIN dbo.UserMaster UM ON ID.DoctorId = UM.UserId
	WHERE ID.InvoiceId = @InvoiceId AND ID.IsDeleted = 0 AND ID.MasterType = 'TreatmentService';

	OPEN curTreatment;
	FETCH NEXT FROM curTreatment 
	INTO @TreatmentName, @TreatmentTime, @TreatmentCost, @TreatmentDiscount, @TreatmentTax, @TreatmentTotalAmount;

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @RowCounter += 1;
		SET @TreatmentChargesHTML += 
			N'<tr><td style="text-align:center;">' + CAST(@RowCounter AS NVARCHAR(10)) + N'</td>' +
			N'<td>' + ISNULL(@TreatmentName,'') + N'</td>' +
			N'<td style="text-align:center;">' + ISNULL(@TreatmentTime,'') + N'</td>' +
			N'<td style="text-align:right;">' + FORMAT(ISNULL(@TreatmentCost,0), 'N2') + N'</td>' +
			N'<td style="text-align:right;">' + FORMAT(ISNULL(@TreatmentDiscount,0), 'N2') + N'</td>' +
			N'<td style="text-align:right;">' + FORMAT(ISNULL(@TreatmentTax,0), 'N2') + N'</td>' +
			N'<td style="text-align:right;">' + FORMAT(ISNULL(@TreatmentTotalAmount,0), 'N2') + N'</td></tr>';
		FETCH NEXT FROM curTreatment 
		INTO @TreatmentName, @TreatmentTime, @TreatmentCost, @TreatmentDiscount, @TreatmentTax, @TreatmentTotalAmount;
	END
	CLOSE curTreatment; DEALLOCATE curTreatment;
	SET @TreatmentChargesHTML += N'</tbody></table>';

	DECLARE 
    @BedTotal DECIMAL(18,2),
    @ServiceTotal DECIMAL(18,2),
    @TreatmentTotal DECIMAL(18,2),
    @GrandTotal DECIMAL(18,2);

	SELECT @BedTotal = ISNULL(SUM(TotalBedCharges), 0)
	FROM #TempTable;

	SELECT @ServiceTotal = ISNULL(SUM(Charges), 0)
	FROM hm.InvoiceDetail
	WHERE InvoiceId = @InvoiceId AND IsDeleted = 0 AND MasterType = 'Service';

	SELECT @TreatmentTotal = ISNULL(SUM(Charges), 0)
	FROM hm.InvoiceDetail
	WHERE InvoiceId = @InvoiceId AND IsDeleted = 0 AND MasterType = 'TreatmentService';

	SET @GrandTotal = @BedTotal + @ServiceTotal + @TreatmentTotal;

	SET @GrandTotalHTML = N'
		<table class="data-table" style="width:100%; border-collapse: collapse; border:1px solid #000;">
			<tr style="font-weight:bold;">
				<td colspan="7" style="text-align:right; padding:8px;">Grand Total Amount:</td>
				<td style="text-align:right; padding:8px;">' + FORMAT(@GrandTotal, 'N2') + '</td>
			</tr>
		</table>
	';

	SET @LastPageFooterHTML = N'
	<table width="100%" cellspacing="0" cellpadding="6"
    style="font-family: Arial, sans-serif; font-size: 13px; color: #000; border-collapse: collapse; margin-top: 20px; border:1px solid #000;">

    <!-- Amount Chargeable and Declaration -->
    <tr valign="top">
        <!-- Left Side -->
        <td style="width:70%; padding:8px; border-bottom:1px solid #000;">
            <b>Amount Chargeable (In Words):</b>
            <b>Forty-Nine Thousand Two Hundred Six Rupees Only</b><br><br>
            <b>All services are provided as per hospital standards and regulations.</b>
        </td>

        <!-- Right Side -->
        <td style="width:30%; padding:8px; border-bottom:1px solid #000; text-align:right;">
            <b>E & O.E</b>
        </td>
    </tr>

    <tr valign="top">
        <!-- Left Side -->
        <td style="border-top:1px solid #000; border-right:1px solid #000; padding:8px; text-align:left; line-height:1.5;">
            <b>Terms & Conditions:</b><br>
            1. Payment should be made within 7 days from the date of invoice.<br>
            2. Any discrepancy should be reported within 48 hours of receipt of goods.<br>
            3. Goods once sold will not be taken back.<br>
            4. Company is not responsible for delays due to unforeseen circumstances.<br>
            5. Interest @18% p.a. will be charged on overdue accounts.<br>
            6. All disputes are subject to Navi Mumbai jurisdiction only.
        </td>

        <!-- Right Side -->
        <td style="border-top:1px solid #000; padding:8px; text-align:center;">
            <div style="margin-top:5px; font-weight:bold;">For MGM Hospital Belapur</div>
            <div style="margin-top:40px; font-weight:bold;">Authorized Signatory</div>
        </td>
    </tr>
	</table>

    </div>

</body>

</html>
	'

    SET @BodyHTML = @PageCss + @HeaderHTML + @ClientHeaderHTML + @BedChargesHTML + @ServiceChargesHTML + @TreatmentChargesHTML + @GrandTotalHTML + @LastPageFooterHTML + '</div>';

    SELECT @BodyHTML AS FinalInvoiceHTML;
    SELECT * FROM #TempTable;
END
GO
/****** Object:  StoredProcedure [hm].[InvoiceMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[InvoiceMaster_Create]
(
    @InvoiceDate     DATETIME,
    @HospitalId      INT,
    @UserId          INT,
    @TotalAmount     DECIMAL(18, 2),
	@CheckInTime     DATETIME,
    @CheckOutTime    DATETIME,
    @PmtStatus      VARCHAR(20),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)  
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @InvoiceId INT;
    DECLARE @InvoiceNumber VARCHAR(100);
    DECLARE @NextNumber BIGINT;

    SELECT TOP 1 
           @NextNumber = CAST(REPLACE([InvoiceNumber], 'INV-', '') AS BIGINT)
    FROM [hm].[InvoiceMaster]
    WHERE ISNUMERIC(REPLACE([InvoiceNumber], 'INV-', '')) = 1
    ORDER BY [InvoiceId] DESC;

    IF @NextNumber IS NULL
        SET @NextNumber = 1;
    ELSE
        SET @NextNumber = @NextNumber + 1;

    IF @NextNumber < 100000
        SET @InvoiceNumber = 'INV-' + RIGHT('00000' + CAST(@NextNumber AS VARCHAR(10)), 5);
    ELSE
        SET @InvoiceNumber = 'INV-' + CAST(@NextNumber AS VARCHAR(20));

    INSERT INTO [hm].[InvoiceMaster]
    (
         [InvoiceNumber]
        ,[InvoiceDate]
        ,[HospitalId]
        ,[UserId]
	    ,[TotalAmount]
		,[CheckInTime]
        ,[CheckOutTime]
        ,[PmtStatus]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @InvoiceNumber
        ,@InvoiceDate
        ,@HospitalId
        ,@UserId
        ,@TotalAmount
		,@CheckInTime
		,@CheckOutTime
		,@PmtStatus
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1
        ,0
        ,@ActionUser
        ,GETDATE()
    );

    SET @InvoiceId = SCOPE_IDENTITY();

    SELECT
         [InvoiceId]
        ,[InvoiceNumber]
        ,[InvoiceDate]
        ,[HospitalId]
        ,[UserId]
        ,[TotalAmount]
	    ,[CheckInTime]
        ,[CheckOutTime]
        ,[PmtStatus]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [hm].[InvoiceMaster]
    WHERE [InvoiceId] = @InvoiceId;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[hm].[InvoiceMaster_Delete]
(
    @InvoiceId INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN 
	SET NOCOUNT ON;
	UPDATE  [hm].[InvoiceMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [InvoiceId] = @InvoiceId
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[hm].[InvoiceMaster_ReadAll]
AS
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [InvoiceId]
		,[InvoiceNumber]
		,[InvoiceDate]
		,[HospitalId]
		,[UserId]
		,[TotalAmount]
	    ,[CheckInTime]
        ,[CheckOutTime]
        ,[PmtStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[InvoiceMaster]
	WHERE [IsActive] = 1
	ORDER BY InvoiceId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [hm].[InvoiceMaster_ReadAllPaginated]
    @HospitalId    = 34,
    @PageSize      = 10,
    @PageNo        = 1,
	@OrderByClause ='',
	@WhereClause =''
*/
CREATE   PROCEDURE [hm].[InvoiceMaster_ReadAllPaginated]
(
    @HospitalId INT,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
 BEGIN 
		SET NOCOUNT ON; 

		DECLARE @Result INT = 0, @TotalCount INT = 0;
		SET @Result = (@PageNo - 1) * @PageSize;

		DECLARE @SQL NVARCHAR(MAX);

		SET @SQL = '
		SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
		') AS RowNum,
			A.[InvoiceId]   ,
			A.[InvoiceNumber] ,
			A.[InvoiceDate] ,
			A.[HospitalId]  ,
			A.[UserId]	  ,
			B.[FirstName] + '' '' + ISNULL(B.[LastName], '''') AS [PatientName],
			A.[TotalAmount] ,
		    A.[CheckInTime],
            A.[CheckOutTime],
            A.[PmtStatus],
			A.[OtherDetail1],
			A.[OtherDetail2],
			A.[OtherDetail3],
			A.[OtherDetail4],
			A.[OtherDetail5],
			A.[OtherDetail6],
			A.[IsActive],
			A.[IsDeleted],
			A.[CreatedBy],
			A.[CreatedOn],
			A.[ModifiedBy],
			A.[ModifiedOn],
		COUNT(*) OVER () AS TotalCount,
		' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
		' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [Nishwik].[hm].[InvoiceMaster]A
		LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]B
		ON A.[UserId] = B.[UserId]
		WHERE A.[HospitalId] = ' + CAST(@HospitalId AS NVARCHAR) + ' 
		AND A.[IsActive] = 1
		AND A.[IsDeleted] = 0
		AND B.[IsActive] = 1
		AND B.[IsDeleted] = 0';

		IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

		IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
		SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
		ELSE
		SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

		SET @SQL = @SQL + '
		OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
		FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

		PRINT @SQL;

		EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[hm].[InvoiceMaster_ReadByHospitalId]
(
    @HospitalId int
)
AS
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [InvoiceId]
		,[InvoiceNumber]
		,[InvoiceDate]
		,[HospitalId]
		,[UserId]
		,[TotalAmount]
		,[CheckInTime]
        ,[CheckOutTime]
        ,[PmtStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[InvoiceMaster]
	WHERE [HospitalId] = @HospitalId
	AND [IsActive] = 1
	ORDER BY InvoiceId DESC;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[hm].[InvoiceMaster_ReadById]
(
    @InvoiceId int
)
AS
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [InvoiceId]
		,[InvoiceNumber]
		,[InvoiceDate]
		,[HospitalId]
		,[UserId]
		,[TotalAmount]
	    ,[CheckInTime]
        ,[CheckOutTime]
        ,[PmtStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[InvoiceMaster]
	WHERE [InvoiceId] = @InvoiceId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceMaster_ReadByUserId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE[hm].[InvoiceMaster_ReadByUserId]
(
    @UserId int
)
AS
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [InvoiceId]
		,[InvoiceNumber]
		,[InvoiceDate]
		,[HospitalId]
		,[UserId]
		,[TotalAmount]
		,[CheckInTime]
        ,[CheckOutTime]
        ,[PmtStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[InvoiceMaster]
	WHERE [UserId] = @UserId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[InvoiceMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[InvoiceMaster_Update]
(
    @InvoiceId       INT,
    @InvoiceDate     DATETIME,
    @HospitalId      INT,
    @UserId       INT,
    @TotalAmount     DECIMAL(18, 2),
	@CheckInTime     DATETIME,
    @CheckOutTime    DATETIME,
    @PmtStatus      VARCHAR(20),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
	@IsActive          INT,
    @ActionUser      VARCHAR(50)  
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[InvoiceMaster]
    SET

         [InvoiceDate]   = @InvoiceDate,
         [HospitalId]    = @HospitalId,
         [UserId]     =   @UserId,
         [TotalAmount]   = @TotalAmount,
		 [CheckInTime]  = @CheckInTime,
		 [CheckOutTime] = @CheckOutTime,
		 [PmtStatus]    = @PmtStatus,
         [OtherDetail1]  = @OtherDetail1,
         [OtherDetail2]  = @OtherDetail2,
         [OtherDetail3]  = @OtherDetail3,
         [OtherDetail4]  = @OtherDetail4,
         [OtherDetail5]  = @OtherDetail5,
         [OtherDetail6]  = @OtherDetail6,
		 [IsActive]      = @IsActive,
         [ModifiedBy]    = @ActionUser,
         [ModifiedOn]    = GETDATE()
    WHERE
        [InvoiceId] = @InvoiceId;

    SELECT
         [InvoiceId]
        ,[InvoiceDate]
        ,[HospitalId]
        ,[UserId]
        ,[TotalAmount]
	    ,[CheckInTime]
        ,[CheckOutTime]
        ,[PmtStatus]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [hm].[InvoiceMaster]
    WHERE [InvoiceId] = @InvoiceId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[OnboardingPreCheck_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[OnboardingPreCheck_Create]
(
    @HospitalId     INT             = NULL,
    @PName          VARCHAR(100)    = NULL,
    @PDesc          VARCHAR(500)    = NULL,
    @IsVerified     INT             = NULL,
    @VerifiedBy     VARCHAR(100)    = NULL,
    @VerifiedDate   DATETIME        = NULL,
    @OtherDetail1   VARCHAR(50)     = NULL,
    @OtherDetail2   VARCHAR(50)     = NULL,
    @OtherDetail3   VARCHAR(100)    = NULL,
    @OtherDetail4   VARCHAR(100)    = NULL,
    @OtherDetail5   VARCHAR(500)    = NULL,
    @OtherDetail6   VARCHAR(500)    = NULL,
    @ActionUser     VARCHAR(50)     = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PreCheckId BIGINT;

    INSERT INTO [hm].[OnboardingPreCheck]
    (
        [HospitalId],
        [PName],
        [PDesc],
        [IsVerified],
        [VerifiedBy],
        [VerifiedDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        TRIM(@PName),
        TRIM(@PDesc),
        @IsVerified,
        TRIM(@VerifiedBy),
        @VerifiedDate,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1, 
        0, 
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @PreCheckId = SCOPE_IDENTITY();

    SELECT 
         A.[PreCheckId]
        ,A.[HospitalId]   
        ,A.[PName]
        ,A.[PDesc]
        ,A.[IsVerified]
        ,A.[VerifiedBy]
        ,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
        ,A.[VerifiedDate]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn] 
    FROM [hm].[OnboardingPreCheck] A   
    LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
        ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
       AND B.[IsActive] = 1
       AND B.[IsDeleted] = 0
    WHERE A.[PreCheckId] = @PreCheckId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[OnboardingPreCheck_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[OnboardingPreCheck_Delete]
(
   @PreCheckId BIGINT,
   @ActionUser VARCHAR(50)
)
AS 
BEGIN 
	SET NOCOUNT ON;
	UPDATE [hm].[OnboardingPreCheck]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE  [PreCheckId] = @PreCheckId
END;
GO
/****** Object:  StoredProcedure [hm].[OnboardingPreCheck_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[OnboardingPreCheck_ReadAll]
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PreCheckId]
		,[HospitalId]
		,[PName]
		,[PDesc]
		,[IsVerified]
		,[VerifiedBy]
		,[VerifiedDate]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[OnboardingPreCheck]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[OnboardingPreCheck_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[OnboardingPreCheck_ReadByHospitalId]
(
   @HospitalId INT
)
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 A.[PreCheckId]
		,A.[HospitalId]
		,A.[PName]
		,A.[PDesc]
		,A.[IsVerified]
		,A.[VerifiedBy]
		,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
		,A.[VerifiedDate]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [hm].[OnboardingPreCheck]A
        LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
			ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
			AND B.[IsActive] = 1
			AND B.[IsDeleted] = 0
    WHERE A.[HospitalId] = @HospitalId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[OnboardingPreCheck_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[OnboardingPreCheck_ReadById]
(
   @PreCheckId BIGINT
)
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PreCheckId]
		,[HospitalId]
		,[PName]
		,[PDesc]
		,[IsVerified]
		,[VerifiedBy]
		,[VerifiedDate]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[OnboardingPreCheck]
	WHERE  [PreCheckId] = @PreCheckId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[OnboardingPreCheck_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[OnboardingPreCheck_Update]
(
    @PreCheckId     BIGINT,
    @HospitalId     INT             = NULL,
    @PName          VARCHAR(100)    = NULL,
    @PDesc          VARCHAR(500)    = NULL,
    @IsVerified     INT             = NULL,
    @VerifiedBy     VARCHAR(100)    = NULL,
    @VerifiedDate   DATETIME        = NULL,
    @OtherDetail1   VARCHAR(50)     = NULL,
    @OtherDetail2   VARCHAR(50)     = NULL,
    @OtherDetail3   VARCHAR(100)    = NULL,
    @OtherDetail4   VARCHAR(100)    = NULL,
    @OtherDetail5   VARCHAR(500)    = NULL,
    @OtherDetail6   VARCHAR(500)    = NULL,
    @IsActive       INT             = NULL,
    @ActionUser     VARCHAR(50)     = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[OnboardingPreCheck]
    SET
        [HospitalId]    = @HospitalId,
        [PName]         = TRIM(@PName),
        [PDesc]         = TRIM(@PDesc),
        [IsVerified]    = @IsVerified,
        [VerifiedBy]    = TRIM(@VerifiedBy),
        [VerifiedDate]  = @VerifiedDate,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [PreCheckId] = @PreCheckId;

    SELECT 
        [PreCheckId],
        [HospitalId],
        [PName],
        [PDesc],
        [IsVerified],
        [VerifiedBy],
        [VerifiedDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[OnboardingPreCheck]
    WHERE [PreCheckId] = @PreCheckId
	AND [IsActive] = 1
	AND [IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[PatientBedAllocationMapping_Create]
(
    @HospitalId     INT = NULL,
    @PatientId      INT = NULL,
    @WardId         INT = NULL,
    @RoomId         INT = NULL,
    @BedId          INT = NULL,
    @WingId         INT = NULL,
    @OccupiedFrom   DATETIME = NULL,
    @OccupiedTo     DATETIME = NULL,
    @IsOccupied     INT = NULL,
    @PmtStatus      VARCHAR(80) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MappingId INT;

    INSERT INTO [hm].[PatientBedAllocationMapping]
    (
        [HospitalId],
        [PatientId],
        [WardId],
        [RoomId],
        [BedId],
        [WingId],
        [OccupiedFrom],
        [OccupiedTo],
        [IsOccupied],
        [PmtStatus],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        @PatientId,
        @WardId,
        @RoomId,
        @BedId,
        @WingId,
        @OccupiedFrom,
        @OccupiedTo,
        @IsOccupied,
        TRIM(@PmtStatus),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,      
        0,      
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT 
        [MappingId],
        [HospitalId],
        [PatientId],
        [WardId],
        [RoomId],
        [BedId],
        [WingId],
        [OccupiedFrom],
        [OccupiedTo],
        [IsOccupied],
        [PmtStatus],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[PatientBedAllocationMapping]
    WHERE [MappingId] = @MappingId
      AND [IsActive] = 1
      AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_Delete]
(
  @MappingId INT,
  @ActionUser VARCHAR(50)
)
AS
 BEGIN 
       SET NOCOUNT ON;
	   UPDATE [hm].[PatientBedAllocationMapping]
	   SET 
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [MappingId] = @MappingId
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_GetAdmittedDischargedSummary]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_GetAdmittedDischargedSummary]
(
    @HospitalId INT,
    @Year INT
)
AS
BEGIN
    SET NOCOUNT ON;

    ;WITH Months AS
    (
        SELECT 1 AS MonthNo
        UNION ALL
        SELECT MonthNo + 1 FROM Months WHERE MonthNo < 12
    )
    SELECT 
        M.MonthNo,
        DATENAME(MONTH, DATEFROMPARTS(@Year, M.MonthNo, 1)) AS MonthName,

        
        COUNT(A.MappingId) AS AdmittedCount,

        
        COUNT(D.MappingId) AS DischargedCount
    FROM Months M

    
    LEFT JOIN hm.PatientBedAllocationMapping A
        ON A.HospitalId = @HospitalId
        AND A.IsOccupied = 1
        AND YEAR(A.OccupiedFrom) = @Year
        AND MONTH(A.OccupiedFrom) = M.MonthNo

    
    LEFT JOIN hm.PatientBedAllocationMapping D
        ON D.HospitalId = @HospitalId
        AND D.IsOccupied = 0
        AND YEAR(D.OccupiedFrom) = @Year
        AND MONTH(D.OccupiedFrom) = M.MonthNo

    GROUP BY M.MonthNo
    ORDER BY M.MonthNo;

END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_ReadAll]
AS
 BEGIN 
       SET NOCOUNT ON;
	   SELECT 
		   [MappingId]
		  ,[HospitalId]
		  ,[PatientId]
		  ,[WardId]
		  ,[RoomId]
		  ,[BedId]
		  ,[WingId]
		  ,[OccupiedFrom]
		  ,[OccupiedTo]
		  ,[IsOccupied]
		  ,[PmtStatus]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PatientBedAllocationMapping]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_ReadByBedId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_ReadByBedId]
(
  @BedId INT
)
AS
 BEGIN 
       SET NOCOUNT ON;
	   SELECT 
		   [MappingId]
		  ,[HospitalId]
		  ,[PatientId]
		  ,[WardId]
		  ,[RoomId]
		  ,[BedId]
		  ,[WingId]
		  ,[OccupiedFrom]
		  ,[OccupiedTo]
		  ,[IsOccupied]
		  ,[PmtStatus]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PatientBedAllocationMapping]
	WHERE [BedId] = @BedId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_ReadByHospitalId]
(
  @HospitalId INT
)
AS
 BEGIN 
       SET NOCOUNT ON;
	   SELECT 
	    A.[MappingId],
        A.[HospitalId],
        A.[PatientId],
	(E.[FirstName] + ' ' + E.[LastName]) AS [PatientName],
        A.[WardId],
        B.[WardName],
        A.[RoomId],
        C.[RoomNumber],
        A.[BedId],
        D.[BedNumber],
        D.[BedType],
        D.[BaseCharge],
        A.[WingId],
        A.[OccupiedFrom],
        A.[OccupiedTo],
        A.[IsOccupied],
        A.[PmtStatus],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn]
    FROM [hm].[PatientBedAllocationMapping] A
    LEFT OUTER JOIN hm.HospitalWardMaster B
        ON A.[HospitalId] = B.[HospitalId]
       AND A.[WardId] = B.[WardId]
    LEFT OUTER JOIN hm.HospitalRoomMaster C
        ON A.[HospitalId] = C.[HospitalId]
       AND A.[RoomId] = C.[RoomId]
    LEFT OUTER JOIN hm.HospitalBedMaster D
        ON A.[HospitalId] = D.[HospitalId]
       AND A.[BedId] = D.[BedId]
	LEFT OUTER JOIN dbo.UserMaster E
	ON A.[PatientId] = E.UserId
    WHERE A.[HospitalId] = @HospitalId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_ReadById]
(
  @MappingId INT
)
AS
 BEGIN 
       SET NOCOUNT ON;
	   SELECT 
		   [MappingId]
		  ,[HospitalId]
		  ,[PatientId]
		  ,[WardId]
		  ,[RoomId]
		  ,[BedId]
		  ,[WingId]
		  ,[OccupiedFrom]
		  ,[OccupiedTo]
		  ,[IsOccupied]
		  ,[PmtStatus]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PatientBedAllocationMapping]
	WHERE [MappingId] = @MappingId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_ReadByPatientId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[PatientBedAllocationMapping_ReadByPatientId]
(
  @PatientId INT
)
AS
BEGIN 
    SET NOCOUNT ON;

    SELECT 
        A.[MappingId],
        A.[HospitalId],
        A.[PatientId],
        A.[WardId],
        B.[WardName],
        A.[RoomId],
        C.[RoomNumber],
        A.[BedId],
        D.[BedNumber],
        D.[BedType],
        D.[BaseCharge],
        A.[WingId],
        A.[OccupiedFrom],
        A.[OccupiedTo],
        A.[IsOccupied],
        A.[PmtStatus],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn]
    FROM [hm].[PatientBedAllocationMapping] A
    LEFT OUTER JOIN hm.HospitalWardMaster B
        ON A.[HospitalId] = B.[HospitalId]
       AND A.[WardId] = B.[WardId]
    LEFT OUTER JOIN hm.HospitalRoomMaster C
        ON A.[HospitalId] = C.[HospitalId]
       AND A.[RoomId] = C.[RoomId]
    LEFT OUTER JOIN hm.HospitalBedMaster D
        ON A.[HospitalId] = D.[HospitalId]
       AND A.[BedId] = D.[BedId]
    WHERE A.[PatientId] = @PatientId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_ReadByRoomId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_ReadByRoomId]
(
  @RoomId INT
)
AS
 BEGIN 
       SET NOCOUNT ON;
	   SELECT 
		   [MappingId]
		  ,[HospitalId]
		  ,[PatientId]
		  ,[WardId]
		  ,[RoomId]
		  ,[BedId]
		  ,[WingId]
		  ,[OccupiedFrom]
		  ,[OccupiedTo]
		  ,[IsOccupied]
		  ,[PmtStatus]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PatientBedAllocationMapping]
	WHERE [RoomId] = @RoomId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_ReadByWardId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_ReadByWardId]
(
  @WardId INT
)
AS
 BEGIN 
       SET NOCOUNT ON;
	   SELECT 
		   [MappingId]
		  ,[HospitalId]
		  ,[PatientId]
		  ,[WardId]
		  ,[RoomId]
		  ,[BedId]
		  ,[WingId]
		  ,[OccupiedFrom]
		  ,[OccupiedTo]
		  ,[IsOccupied]
		  ,[PmtStatus]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PatientBedAllocationMapping]
	WHERE [WardId] = @WardId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_ReadByWingId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientBedAllocationMapping_ReadByWingId]
(
  @WingId INT
)
AS
 BEGIN 
       SET NOCOUNT ON;
	   SELECT 
		   [MappingId]
		  ,[HospitalId]
		  ,[PatientId]
		  ,[WardId]
		  ,[RoomId]
		  ,[BedId]
		  ,[WingId]
		  ,[OccupiedFrom]
		  ,[OccupiedTo]
		  ,[IsOccupied]
		  ,[PmtStatus]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PatientBedAllocationMapping]
	WHERE [WingId] = @WingId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientBedAllocationMapping_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[PatientBedAllocationMapping_Update]
(
    @MappingId      INT,
    @HospitalId     INT = NULL,
    @PatientId      INT = NULL,
    @WardId         INT = NULL,
    @RoomId         INT = NULL,
    @BedId          INT = NULL,
    @WingId         INT = NULL,
    @OccupiedFrom   DATETIME = NULL,
    @OccupiedTo     DATETIME = NULL,
    @IsOccupied     INT = NULL,
    @PmtStatus      VARCHAR(80) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @IsActive       INT = 1,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[PatientBedAllocationMapping]
    SET
        [HospitalId]   = @HospitalId,
        [PatientId]    = @PatientId,
        [WardId]       = @WardId,
        [RoomId]       = @RoomId,
        [BedId]        = @BedId,
        [WingId]       = @WingId,
        [OccupiedFrom] = @OccupiedFrom,
        [OccupiedTo]   = @OccupiedTo,
        [IsOccupied]   = @IsOccupied,
        [PmtStatus]    = TRIM(@PmtStatus),
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive]     = @IsActive,
        [ModifiedBy]   = TRIM(@ActionUser),
        [ModifiedOn]   = GETDATE()
    WHERE [MappingId] = @MappingId

    SELECT 
        [MappingId],
        [HospitalId],
        [PatientId],
        [WardId],
        [RoomId],
        [BedId],
        [WingId],
        [OccupiedFrom],
        [OccupiedTo],
        [IsOccupied],
        [PmtStatus],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[PatientBedAllocationMapping]
    WHERE [MappingId] = @MappingId
      AND [IsDeleted] = 0
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[PatientRegistrationBackup_EOD]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [hm].[PatientRegistrationBackup_EOD]
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO hm.PatientRegistrationBackup
    (
        UserId, FirstName, MiddleName, LastName, DOB, MobileNo, EmailId,
        Gender, AadharNumber, ProfileImage, Address
    )
    SELECT 
        UserId, FirstName, MiddleName, LastName, DOB, MobileNo, EmailId,
        Gender, AadharNumber, ProfileImage, Address
    FROM dbo.UserMaster
    WHERE 
        IsActive = 1 AND IsDeleted = 0
        AND CONVERT(DATE, CreatedOn) = CONVERT(DATE, GETDATE());
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_Create]
(
    @HospitalId BIGINT,
	@PatientId BIGINT,
	@MasterId INT,
	@MasterType VARCHAR(50),
	@BedId BIGINT,
	@DoctorId BIGINT,
	@ServiceId BIGINT,
	@ReportType VARCHAR (100),
	@ReportName VARCHAR (200),
	@ReportURL VARCHAR (500),
	@Remarks VARCHAR (500),
	@TotalCost DECIMAL(18,2),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ReportId BIGINT;

    INSERT INTO [hm].[PatientReport]
    (
        [HospitalId],
        [PatientId],
        [MasterId],
	    [MasterType],
        [BedId],
        [DoctorId],
		[ServiceId],
        [ReportType],
        [ReportName],
        [ReportURL],
        [Remarks],
		[TotalCost],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        @PatientId,
        @MasterId,
		@MasterType,
        @BedId,
        @DoctorId,
		@ServiceId,
        TRIM(@ReportType),
        TRIM(@ReportName),
        TRIM(@ReportURL),
        TRIM(@Remarks),
		@TotalCost,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
         1,
         0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @ReportId = SCOPE_IDENTITY();

    SELECT 
	   [ReportId]
      ,[HospitalId]
      ,[PatientId]
      ,[MasterId]
	  ,[MasterType]
      ,[BedId]
      ,[DoctorId]
	  ,[ServiceId]
      ,[ReportType]
      ,[ReportName]
      ,[ReportURL]
      ,[Remarks]
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[PatientReport]
    WHERE [ReportId] = @ReportId;
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_Delete]
(
   @ReportId BIGINT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[PatientReport]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ReportId] = @ReportId
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [ReportId]
      ,[HospitalId]
      ,[PatientId]
      ,[MasterId]
	  ,[MasterType]
      ,[BedId]
      ,[DoctorId]
	  ,[ServiceId]
      ,[ReportType]
      ,[ReportName]
      ,[ReportURL]
      ,[Remarks]
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[PatientReport]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_ReadByBedId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_ReadByBedId]
(
   @BedId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [ReportId]
      ,[HospitalId]
      ,[PatientId]
      ,[MasterId]
	  ,[MasterType]
      ,[BedId]
      ,[DoctorId]
	  ,[ServiceId]
      ,[ReportType]
      ,[ReportName]
      ,[ReportURL]
      ,[Remarks]
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[PatientReport]
	  WHERE [BedId] = @BedId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_ReadByDoctorId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_ReadByDoctorId]
(
   @DoctorId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [ReportId]
      ,[HospitalId]
      ,[PatientId]
      ,[MasterId]
	  ,[MasterType]
      ,[BedId]
      ,[DoctorId]
	  ,[ServiceId]
      ,[ReportType]
      ,[ReportName]
      ,[ReportURL]
      ,[Remarks]
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[PatientReport]
	  WHERE [DoctorId] = @DoctorId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_ReadByHospitalId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_ReadByHospitalId]
(
   @HospitalId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [ReportId]
      ,[HospitalId]
      ,[PatientId]
      ,[MasterId]
	  ,[MasterType]
      ,[BedId]
      ,[DoctorId]
	  ,[ServiceId]
      ,[ReportType]
      ,[ReportName]
      ,[ReportURL]
      ,[Remarks]
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[PatientReport]
	  WHERE [HospitalId] = @HospitalId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_ReadById]
(
   @ReportId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [ReportId]
      ,[HospitalId]
      ,[PatientId]
      ,[MasterId]
	  ,[MasterType]
      ,[BedId]
      ,[DoctorId]
	  ,[ServiceId]
      ,[ReportType]
      ,[ReportName]
      ,[ReportURL]
      ,[Remarks]
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[PatientReport]
	  WHERE [ReportId] = @ReportId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_ReadByMasterId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [ReportId]
      ,[HospitalId]
      ,[PatientId]
      ,[MasterId]
	  ,[MasterType]
      ,[BedId]
      ,[DoctorId]
	  ,[ServiceId]
      ,[ReportType]
      ,[ReportName]
      ,[ReportURL]
      ,[Remarks]
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[PatientReport]
	  WHERE [MasterId] = @MasterId
	  AND [MasterType]  = @MasterType
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_ReadByPatientId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_ReadByPatientId]
(
   @PatientId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[ReportId]
      ,A.[HospitalId]
      ,A.[PatientId]
      ,A.[MasterId]
	  ,A.[MasterType]
      ,A.[BedId]
      ,A.[DoctorId]
      ,B.[FirstName] + ' ' + B.[LastName] AS DoctorName
	  ,A.[ServiceId]
      ,A.[ReportType]
      ,A.[ReportName]
      ,A.[ReportURL]
      ,A.[Remarks]
	  ,A.[TotalCost]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[PatientReport]A
	  LEFT OUTER JOIN  [Nishwik].[dbo].[UserMaster]B
	  ON A.[DoctorId] = B.[UserId]
	  WHERE A.[PatientId] = @PatientId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_ReadByServiceId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[PatientReport_ReadByServiceId]
(
   @ServiceId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [ReportId]
      ,[HospitalId]
      ,[PatientId]
      ,[MasterId]
	  ,[MasterType]
      ,[BedId]
      ,[DoctorId]
	  ,[ServiceId]
      ,[ReportType]
      ,[ReportName]
      ,[ReportURL]
      ,[Remarks]
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[PatientReport]
	  WHERE [ServiceId] = @ServiceId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PatientReport_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PatientReport_Update]
(
    @ReportId BIGINT,
    @HospitalId BIGINT,
	@PatientId BIGINT,
	@MasterId INT,
	@MasterType VARCHAR(50),
	@BedId BIGINT,
	@DoctorId BIGINT,
	@ServiceId BIGINT,
	@ReportType VARCHAR (100),
	@ReportName VARCHAR (200),
	@ReportURL VARCHAR (500),
	@Remarks VARCHAR (500),
	@TotalCost DECIMAL(18,2),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[PatientReport]
    SET
        [HospitalId] = @HospitalId,
        [PatientId] = @PatientId,
        [MasterId] = @MasterId,
		[MasterType] = @MasterType,
        [BedId] = @BedId,
        [DoctorId] = @DoctorId,
		[ServiceId] = @ServiceId,
        [ReportType] = TRIM(@ReportType),
        [ReportName] = TRIM(@ReportName),
        [ReportURL] = TRIM(@ReportURL),
        [Remarks] = TRIM(@Remarks),
		[TotalCost] = @TotalCost,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [ReportId] = @ReportId;

    SELECT 
        [ReportId]
       ,[HospitalId]
       ,[PatientId]
       ,[MasterId]
	   ,[MasterType]
       ,[BedId]
       ,[DoctorId]
	   ,[ServiceId]
       ,[ReportType]
       ,[ReportName]
       ,[ReportURL]
       ,[Remarks]
	   ,[TotalCost]
       ,[OtherDetail1]
       ,[OtherDetail2]
       ,[OtherDetail3]
       ,[OtherDetail4]
       ,[OtherDetail5]
       ,[OtherDetail6]
       ,[IsActive]
       ,[IsDeleted]
       ,[CreatedBy]
       ,[CreatedOn]
       ,[ModifiedBy]
       ,[ModifiedOn]
    FROM [hm].[PatientReport]
    WHERE [ReportId] = @ReportId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[PatientVisitSummary_BOD]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[PatientVisitSummary_BOD]
AS
BEGIN
    SET NOCOUNT ON;

    -- Today Date
    DECLARE @Today DATE = CAST(GETDATE() AS DATE);

    SELECT 
        im.HospitalId,
        hm.HospitalName,
        COUNT(im.InvoiceId) AS TotalVisits,
        SUM(im.TotalAmount) AS TotalRevenue,
        0 AS ScheduledVisits, -- placeholder (we will update once appointment table is ready)
        @Today AS ReportDate
    FROM hm.InvoiceMaster im
    INNER JOIN hm.HospitalMaster hm ON hm.HospitalId = im.HospitalId
    WHERE CAST(im.InvoiceDate AS DATE) = @Today
      AND im.IsDeleted = 0
    GROUP BY im.HospitalId, hm.HospitalName
    ORDER BY hm.HospitalName;
END;
GO
/****** Object:  StoredProcedure [hm].[PatientVisitSummary_EOD]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[PatientVisitSummary_EOD]
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Today DATE = CAST(GETDATE() AS DATE);

    SELECT 
        im.HospitalId,
        hm.HospitalName,
        COUNT(im.InvoiceId) AS TotalVisits,
        SUM(im.TotalAmount) AS TotalRevenue,
        0 AS ScheduledVisits, -- placeholder for future appointment table
        @Today AS ReportDate
    FROM hm.InvoiceMaster im
    INNER JOIN hm.HospitalMaster hm ON hm.HospitalId = im.HospitalId
    WHERE CAST(im.InvoiceDate AS DATE) = @Today
      AND im.IsDeleted = 0
    GROUP BY im.HospitalId, hm.HospitalName
    ORDER BY hm.HospitalName;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintMaster_Create]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[PrintMaster_Create]
(
    @TemplateId     INT = NULL,
    @HospitalId     INT = NULL,
    @MasterId       INT = NULL,
    @MasterType     NVARCHAR(100) = NULL,
    @PName          NVARCHAR(255) = NULL,
    @PDesc          NVARCHAR(MAX) = NULL,
    @PContent       NVARCHAR(MAX) = NULL,
    @PSeq           INT = NULL,
    @OtherDetail1   NVARCHAR(255) = NULL,
    @OtherDetail2   NVARCHAR(255) = NULL,
    @OtherDetail3   NVARCHAR(255) = NULL,
    @OtherDetail4   NVARCHAR(255) = NULL,
    @OtherDetail5   NVARCHAR(255) = NULL,
    @OtherDetail6   NVARCHAR(255) = NULL,
    @ActionUser     NVARCHAR(100)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PrintId INT;

    INSERT INTO [hm].[PrintMaster]
    (
        [TemplateId],
        [HospitalId],
        [MasterId],
        [MasterType],
        [PName],
        [PDesc],
        [PContent],
        [PSeq],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @TemplateId,
        @HospitalId,
        @MasterId,
        @MasterType,
        @PName,
        @PDesc,
        @PContent,
        @PSeq,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @PrintId = SCOPE_IDENTITY();

    SELECT 
        [PrintId],
        [TemplateId],
        [HospitalId],
        [MasterId],
        [MasterType],
        [PName],
        [PDesc],
        [PContent],
        [PSeq],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[PrintMaster]
    WHERE [PrintId] = @PrintId;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintMaster_Delete]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintMaster_Delete]
(
   @PrintId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[PrintMaster]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [PrintId] = @PrintId
END;
GO
/****** Object:  StoredProcedure [hm].[PrintMaster_ReadAll]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintMaster_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PrintId]
      ,[TemplateId]
      ,[MasterId]
      ,[MasterType]
      ,[PName]
      ,[PDesc]
      ,[PContent]
      ,[PSeq]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  ,[HospitalId]
	  FROM [hm].[PrintMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PrintMaster_ReadById]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintMaster_ReadById]
(
    @PrintId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        [PrintId],
		[TemplateId],
		[MasterId],
		[MasterType],
        [PName],
		[PDesc],
		[PContent],
		[PSeq],
        [OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
        [OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
        [HospitalId],
        [IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn],
		[ModifiedBy],
		[ModifiedOn]
    FROM [hm].[PrintMaster]
    WHERE [PrintId] = @PrintId AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintMaster_ReadByMasterId]
(
    @MasterId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        [PrintId],
		[TemplateId],
		[MasterId],
		[MasterType],
        [PName],
		[PDesc],
		[PContent],
		[PSeq],
        [OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
        [OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
        [HospitalId],
        [IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn],
		[ModifiedBy],
		[ModifiedOn]
    FROM [hm].[PrintMaster]
    WHERE [MasterId] = @MasterId AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintMaster_ReadByMasterType]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintMaster_ReadByMasterType]
(
    @MasterType VARCHAR(100),
	@HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;


	IF EXISTS (SELECT 1 FROM hm.PrintMaster WHERE MasterType = @MasterType AND HospitalId = @HospitalId AND IsActive = 1 AND IsDeleted = 0)
	BEGIN
		SELECT 
			[PrintId],
			[TemplateId],
			[MasterId],
			[MasterType],
			[PName],
			[PDesc],
			[PContent],
			[PSeq],
			[OtherDetail1],
			[OtherDetail2],
			[OtherDetail3],
			[OtherDetail4],
			[OtherDetail5],
			[OtherDetail6],
			[HospitalId],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[ModifiedBy],
			[ModifiedOn]
		FROM [hm].[PrintMaster]
		WHERE MasterType = @MasterType AND HospitalId = @HospitalId AND IsActive = 1 AND IsDeleted = 0
	END
	ELSE
	BEGIN
		SELECT 
			[PrintId],
			[TemplateId],
			[MasterId],
			[MasterType],
			[PName],
			[PDesc],
			[PContent],
			[PSeq],
			[OtherDetail1],
			[OtherDetail2],
			[OtherDetail3],
			[OtherDetail4],
			[OtherDetail5],
			[OtherDetail6],
			[HospitalId],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[ModifiedBy],
			[ModifiedOn]
		FROM [hm].[PrintMaster]
		WHERE MasterType = @MasterType AND HospitalId = 0 AND IsActive = 1 AND IsDeleted = 0
	END

    
END;
GO
/****** Object:  StoredProcedure [hm].[PrintMaster_ReadByTemplateId]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintMaster_ReadByTemplateId]
(
   @TemplateId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PrintId]
      ,[TemplateId]
      ,[MasterId]
      ,[MasterType]
      ,[PName]
      ,[PDesc]
      ,[PContent]
      ,[PSeq]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  ,[HospitalId]
	  FROM [hm].[PrintMaster]
	  WHERE [TemplateId] = @TemplateId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[PrintMaster_Update]    Script Date: 11/24/2025 5:47:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[PrintMaster_Update]
(
    @PrintId        INT,
    @TemplateId     INT = NULL,
    @HospitalId     INT = NULL,
    @MasterId       INT = NULL,
    @MasterType     NVARCHAR(100) = NULL,
    @PName          NVARCHAR(255) = NULL,
    @PDesc          NVARCHAR(MAX) = NULL,
    @PContent       NVARCHAR(MAX) = NULL,
    @PSeq           INT = NULL,
    @OtherDetail1   NVARCHAR(255) = NULL,
    @OtherDetail2   NVARCHAR(255) = NULL,
    @OtherDetail3   NVARCHAR(255) = NULL,
    @OtherDetail4   NVARCHAR(255) = NULL,
    @OtherDetail5   NVARCHAR(255) = NULL,
    @OtherDetail6   NVARCHAR(255) = NULL,
    @IsActive       INT = 1,
    @ActionUser     NVARCHAR(100)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[PrintMaster]
    SET
        [TemplateId]    = @TemplateId,
        [HospitalId]    = @HospitalId,
        [MasterId]      = @MasterId,
        [MasterType]    = TRIM(@MasterType),
        [PName]         = TRIM(@PName),
        [PDesc]         = TRIM(@PDesc),
        [PContent]      = TRIM(@PContent),
        [PSeq]          = @PSeq,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [PrintId] = @PrintId;

    SELECT 
        [PrintId],
        [TemplateId],
        [HospitalId],
        [MasterId],
        [MasterType],
        [PName],
        [PDesc],
        [PContent],
        [PSeq],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[PrintMaster]
    WHERE [PrintId] = @PrintId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintTemplate_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintTemplate_Create]
(
    @TemplateName VARCHAR(100),
    @TemplateType VARCHAR(50),
    @HospitalId INT,
	@PageCss NVARCHAR(MAX) NULL,
    @HeaderHTML NVARCHAR(MAX),
    @ClientHeaderHTML NVARCHAR(MAX),
    @BodyHTML NVARCHAR(MAX),
    @ContinuedFooterHTML NVARCHAR(MAX),
	@LastPageFooterHTML NVARCHAR(MAX),
	@RowHTML NVARCHAR(MAX),
    @LogoImage VARCHAR(MAX),
    @WatermarkText NVARCHAR(200),
    @WatermarkImage VARCHAR(MAX),
    @PaperSize VARCHAR(20),
    @Orientation VARCHAR(100),
    @IsDefault INT,
	@RowsInPage INT,
    @OtherDetail1 NVARCHAR(50),
    @OtherDetail2 NVARCHAR(50),
    @OtherDetail3 NVARCHAR(100),
    @OtherDetail4 NVARCHAR(100),
    @OtherDetail5 NVARCHAR(500),
    @OtherDetail6 NVARCHAR(500),
    @ActionUser varchar(50)
)
AS
BEGIN
		SET NOCOUNT ON;

		DECLARE @TemplateId INT;

		INSERT INTO [hm].[PrintTemplate]
		(
			   [TemplateName]
			  ,[TemplateType]
			  ,[HospitalId]
			  ,[PageCss]
			  ,[HeaderHTML]
			  ,[ClientHeaderHTML]
			  ,[BodyHTML]
			  ,[ContinuedFooterHTML]
			  ,[LastPageFooterHTML]
			  ,[RowHTML]
			  ,[LogoImage]
			  ,[WatermarkText]
			  ,[WatermarkImage]
			  ,[PaperSize]
			  ,[Orientation]
			  ,[IsDefault]
			  ,[RowsInPage]
			  ,[OtherDetail1]
			  ,[OtherDetail2]
			  ,[OtherDetail3]
			  ,[OtherDetail4]
			  ,[OtherDetail5]
			  ,[OtherDetail6]
			  ,[IsActive]
			  ,[IsDeleted]
			  ,[CreatedBy]
			  ,[CreatedOn]

		)
		VALUES
		(
				@TemplateName,
				@TemplateType,
				@HospitalId,
				@ContinuedFooterHTML,
				@HeaderHTML,
				@ClientHeaderHTML,
				@BodyHTML,
				@ContinuedFooterHTML,
				@LastPageFooterHTML,
				@RowHTML,
				@LogoImage,
				@WatermarkText,
				@WatermarkImage,
				@PaperSize,
				@Orientation,
				@IsDefault,
				@RowsInPage,
				@OtherDetail1,
				@OtherDetail2,
				@OtherDetail3,
				@OtherDetail4,
				@OtherDetail5,
				@OtherDetail6,
				1,
				0,
				@ActionUser,
				GETDATE()
		);

		SET @TemplateId = SCOPE_IDENTITY();

		SELECT 
			   [TemplateId]
			  ,[TemplateName]
			  ,[TemplateType]
			  ,[HospitalId]
			  ,[PageCss]
			  ,[HeaderHTML]
			  ,[ClientHeaderHTML]
			  ,[BodyHTML]
			  ,[ContinuedFooterHTML]
			  ,[LastPageFooterHTML]
			  ,[RowHTML]
			  ,[LogoImage]
			  ,[WatermarkText]
			  ,[WatermarkImage]
			  ,[PaperSize]
			  ,[Orientation]
			  ,[IsDefault]
			  ,[RowsInPage]
			  ,[OtherDetail1]
			  ,[OtherDetail2]
			  ,[OtherDetail3]
			  ,[OtherDetail4]
			  ,[OtherDetail5]
			  ,[OtherDetail6]
			  ,[IsActive]
			  ,[IsDeleted]
			  ,[CreatedBy]
			  ,[CreatedOn]
			  ,[ModifiedBy]
			  ,[ModifiedOn]
		FROM [hm].[PrintTemplate]
		WHERE [TemplateId] = @TemplateId;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintTemplate_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintTemplate_ReadAll]
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		   [TemplateId]
		  ,[TemplateName]
		  ,[TemplateType]
		  ,[HospitalId]
		  ,[PageCss]
		  ,[HeaderHTML]
		  ,[ClientHeaderHTML]
		  ,[BodyHTML]
		  ,[ContinuedFooterHTML]
		  ,[LastPageFooterHTML]
		  ,[RowHTML]
		  ,[LogoImage]
		  ,[WatermarkText]
		  ,[WatermarkImage]
		  ,[PaperSize]
		  ,[Orientation]
		  ,[IsDefault]
		  ,[RowsInPage]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PrintTemplate]
	WHERE [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintTemplate_ReadByHospitalId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintTemplate_ReadByHospitalId]
(
     @HospitalId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		   [TemplateId]
		  ,[TemplateName]
		  ,[TemplateType]
		  ,[HospitalId]
		  ,[PageCss]
		  ,[HeaderHTML]
		  ,[ClientHeaderHTML]
		  ,[BodyHTML]
		  ,[ContinuedFooterHTML]
		  ,[LastPageFooterHTML]
		  ,[RowHTML]
		  ,[LogoImage]
		  ,[WatermarkText]
		  ,[WatermarkImage]
		  ,[PaperSize]
		  ,[Orientation]
		  ,[IsDefault]
		  ,[RowsInPage]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PrintTemplate]
	WHERE  [HospitalId] = @HospitalId
	AND [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintTemplate_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[PrintTemplate_ReadById]
(
     @TemplateId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		   [TemplateId]
		  ,[TemplateName]
		  ,[TemplateType]
		  ,[HospitalId]
		  ,[PageCss]
		  ,[HeaderHTML]
		  ,[ClientHeaderHTML]
		  ,[BodyHTML]
		  ,[ContinuedFooterHTML]
		  ,[LastPageFooterHTML]
		  ,[RowHTML]
		  ,[LogoImage]
		  ,[WatermarkText]
		  ,[WatermarkImage]
		  ,[PaperSize]
		  ,[Orientation]
		  ,[IsDefault]
		  ,[RowsInPage]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [hm].[PrintTemplate]
	WHERE  [TemplateId] = @TemplateId
	AND [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [hm].[PrintTemplate_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*

*/
CREATE PROCEDURE [hm].[PrintTemplate_Update]
(
    @TemplateId INT,
    @TemplateName VARCHAR(100),
    @TemplateType VARCHAR(50),
    @HospitalId INT,
	@PageCss NVARCHAR(MAX) NULL,
    @HeaderHTML NVARCHAR(MAX),
    @ClientHeaderHTML NVARCHAR(MAX),
    @BodyHTML NVARCHAR(MAX),
    @ContinuedFooterHTML NVARCHAR(MAX),
	@LastPageFooterHTML NVARCHAR(MAX),
	@RowHTML NVARCHAR(MAX),
    @LogoImage VARCHAR(MAX),
    @WatermarkText NVARCHAR(200),
    @WatermarkImage VARCHAR(MAX),
    @PaperSize VARCHAR(20),
    @Orientation VARCHAR(100),
    @IsDefault INT,
	@RowsInPage int ,
    @OtherDetail1 NVARCHAR(50),
    @OtherDetail2 NVARCHAR(50),
    @OtherDetail3 NVARCHAR(100),
    @OtherDetail4 NVARCHAR(100),
    @OtherDetail5 NVARCHAR(500),
    @OtherDetail6 NVARCHAR(500),
	@IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[PrintTemplate]
    SET 
		[TemplateName] = @TemplateName,
		[TemplateType] = @TemplateType,
		[HospitalId] = @HospitalId,
		[PageCss] = @PageCss,
		[HeaderHTML] = @HeaderHTML,
		[ClientHeaderHTML] = @ClientHeaderHTML, 
		[BodyHTML] = @BodyHTML,
		[ContinuedFooterHTML] = @ContinuedFooterHTML,
		[LastPageFooterHTML] = @LastPageFooterHTML,
		[RowHTML]   = @RowHTML,
		[LogoImage] = @LogoImage,
		[WatermarkText] = @WatermarkText,
		[WatermarkImage] = @WatermarkImage,
		[PaperSize] = @PaperSize,
		[Orientation] = @Orientation,
		[IsDefault] = @IsDefault,
		[RowsInPage] = @RowsInPage,
		[IsActive] = @IsActive,
		[OtherDetail1] = @OtherDetail1,
		[OtherDetail2] = @OtherDetail2,
		[OtherDetail3] = @OtherDetail3,
		[OtherDetail4] = @OtherDetail4,
		[OtherDetail5] = @OtherDetail5,
		[OtherDetail6] = @OtherDetail6,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
    WHERE [TemplateId] = @TemplateId;

    SELECT 
		   [TemplateId]
		  ,[TemplateName]
		  ,[TemplateType]
		  ,[HospitalId]
		  ,[PageCss]
		  ,[HeaderHTML]
		  ,[ClientHeaderHTML]
		  ,[BodyHTML]
		  ,[ContinuedFooterHTML]
		  ,[LastPageFooterHTML]
		  ,[RowHTML]
		  ,[LogoImage]
		  ,[WatermarkText]
		  ,[WatermarkImage]
		  ,[PaperSize]
		  ,[Orientation]
		  ,[IsDefault]
		  ,[RowsInPage]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
    FROM [hm].[PrintTemplate]
    WHERE [TemplateId] = @TemplateId;
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptDetail_Create]
(
    @ReceiptId     INT,
    @MasterType    VARCHAR(50) = NULL,
    @MasterId      INT = NULL,
    @MasterAmt     DECIMAL(18,2) = NULL,
    @Remarks       VARCHAR(500) = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [hm].[ReceiptDetail]
    (
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ReceiptId,
        TRIM(@MasterType),
        @MasterId,
        @MasterAmt,
        TRIM(@Remarks),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,              
        0,              
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
        [DetailId],
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[ReceiptDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptDetail_Delete]
(
   @DetailId INT,
   @ActionUser VARCHAR(50)
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  UPDATE [hm].[ReceiptDetail]
	  SET
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [CreatedBy] = @ActionUser,
		  [CreatedOn] = GETDATE ()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptDetail_ReadAll]
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[ReceiptDetail] 
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptDetail_ReadById]
(
   @DetailId BIGINT
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[ReceiptDetail] 
	WHERE  [DetailId] = @DetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptDetail_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[ReceiptDetail_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[ReceiptDetail] 
	WHERE [MasterId] = @MasterId
	AND [MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptDetail_ReadByReceiptId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptDetail_ReadByReceiptId]
(
   @ReceiptId INT
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[ReceiptDetail] 
	WHERE  [ReceiptId] = @ReceiptId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptDetail_Update]
(
    @DetailId      INT,
    @ReceiptId     INT,
    @MasterType    VARCHAR(50) = NULL,
    @MasterId      INT = NULL,
    @MasterAmt     DECIMAL(18,2) = NULL,
    @Remarks       VARCHAR(500) = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @IsActive      INT = 1,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[ReceiptDetail]
    SET
        [ReceiptId]    = @ReceiptId,
        [MasterType]   = TRIM(@MasterType),
        [MasterId]     = @MasterId,
        [MasterAmt]    = @MasterAmt,
        [Remarks]      = TRIM(@Remarks),
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive]     = @IsActive,
        [ModifiedBy]   = TRIM(@ActionUser),
        [ModifiedOn]   = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT
        [DetailId],
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[ReceiptDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive]= 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptMaster_Create]
(
    @ReceiptDate DATETIME,
	@ReceiptNumber VARCHAR(20),
	@PRRN VARCHAR(20),
    @ReceiptAmount DECIMAL(18,2) = NULL,
    @RStatus VARCHAR(20) = NULL,
    @MasterType VARCHAR(50) = NULL,
    @MasterId INT = NULL,
    @Remarks VARCHAR(500) = NULL,
    @OtherDetail1 VARCHAR(50) = NULL,
    @OtherDetail2 VARCHAR(50) = NULL,
    @OtherDetail3 VARCHAR(100) = NULL,
    @OtherDetail4 VARCHAR(100) = NULL,
    @OtherDetail5 VARCHAR(500) = NULL,
    @OtherDetail6 VARCHAR(500) = NULL,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ReceiptId INT;

    INSERT INTO [hm].[ReceiptMaster]
    (
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ReceiptDate,
        @ReceiptNumber,
        @PRRN,
        @ReceiptAmount,
        TRIM(@RStatus),
        TRIM(@MasterType),
        @MasterId,
        TRIM(@Remarks),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );
    SET @ReceiptId = SCOPE_IDENTITY();

    SELECT
        [ReceiptId],
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[ReceiptMaster]
    WHERE [ReceiptId] = @ReceiptId;
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptMaster_Delete]
(
    @ReceiptId INT ,
	@ActionUser  VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE [hm].[ReceiptMaster]
	SET 
		[IsActive] = 0,
		[IsDeleted] = 1,
		[CreatedBy] = @ActionUser,
		[CreatedOn] = GETDATE()
	WHERE [ReceiptId] =  @ReceiptId
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptMaster_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	       [ReceiptId]
		  ,[ReceiptDate]
		  ,[ReceiptNumber]
		  ,[PRRN]
		  ,[ReceiptAmount]
		  ,[RStatus]
		  ,[MasterType]
		  ,[MasterId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [hm].[ReceiptMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptMaster_ReadById]
(
    @ReceiptId INT 
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	       [ReceiptId]
		  ,[ReceiptDate]
		  ,[ReceiptNumber]
		  ,[PRRN]
		  ,[ReceiptAmount]
		  ,[RStatus]
		  ,[MasterType]
		  ,[MasterId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [hm].[ReceiptMaster]
	  WHERE [ReceiptId] = @ReceiptId
	  AND   [IsActive] = 1
	  AND   [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[ReceiptMaster_ReadByMasterId]
(
    @MasterId INT ,
	@MasterType VARCHAR(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	       A.[ReceiptId]
		  ,A.[ReceiptDate]
		  ,A.[ReceiptNumber]
		  ,A.[PRRN]
		  ,A.[ReceiptAmount]
		  ,A.[RStatus]
		  ,A.[MasterType]
		  ,A.[MasterId]
		  ,B.[FirstName] + ' '+ B.[LastName] AS StudentName
		  ,C.[FirstName] +'  '+ C.[LastName] AS ParentName                      
		  ,A.[Remarks]
		  ,A.[OtherDetail1]
		  ,A.[OtherDetail2]
		  ,A.[OtherDetail3]
		  ,A.[OtherDetail4]
		  ,A.[OtherDetail5]
		  ,A.[OtherDetail6]
		  ,A.[IsActive]
		  ,A.[IsDeleted]
		  ,A.[CreatedBy]
		  ,A.[CreatedOn]
		  ,A.[ModifiedBy]
		  ,A.[ModifiedOn]
	  FROM [hm].[ReceiptMaster] A
	  LEFT OUTER JOIN dbo.UserMaster B
	  ON A.MasterId = B.UserId
	  LEFT OUTER JOIN   dbo.UserMaster C
	  ON A.OtherDetail1 = C.UserId
	  WHERE A.[MasterId]=  @MasterId
	  AND  A. [MasterType] = @MasterType
	  AND  A. [IsActive] =   1
	  AND  A. [IsDeleted] =  0
END;
GO
/****** Object:  StoredProcedure [hm].[ReceiptMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[ReceiptMaster_Update]
(
    @ReceiptId        INT,
    @ReceiptDate      DATETIME = NULL,
    @ReceiptNumber    VARCHAR(20) = NULL,
    @PRRN             VARCHAR(20) = NULL,
    @ReceiptAmount    DECIMAL(18,2) = NULL,
    @RStatus          VARCHAR(20) = NULL,
    @MasterType       VARCHAR(50) = NULL,
    @MasterId         INT = NULL,
    @Remarks          VARCHAR(500) = NULL,
    @OtherDetail1     VARCHAR(50) = NULL,
    @OtherDetail2     VARCHAR(50) = NULL,
    @OtherDetail3     VARCHAR(100) = NULL,
    @OtherDetail4     VARCHAR(100) = NULL,
    @OtherDetail5     VARCHAR(500) = NULL,
    @OtherDetail6     VARCHAR(500) = NULL,
	@IsActive      INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[ReceiptMaster]
    SET
        [ReceiptDate]     = @ReceiptDate,
        [ReceiptNumber]   = TRIM(@ReceiptNumber),
        [PRRN]            = TRIM(@PRRN),
        [ReceiptAmount]   = @ReceiptAmount,
        [RStatus]         = TRIM(@RStatus),
        [MasterType]      = TRIM(@MasterType),
        [MasterId]        = @MasterId,
        [Remarks]         = TRIM(@Remarks),
        [OtherDetail1]    = TRIM(@OtherDetail1),
        [OtherDetail2]    = TRIM(@OtherDetail2),
        [OtherDetail3]    = TRIM(@OtherDetail3),
        [OtherDetail4]    = TRIM(@OtherDetail4),
        [OtherDetail5]    = TRIM(@OtherDetail5),
        [OtherDetail6]    = TRIM(@OtherDetail6),
		[IsActive]        = @IsActive,
        [ModifiedBy]      = TRIM(@ActionUser),
        [ModifiedOn]      = GETDATE()
    WHERE [ReceiptId] = @ReceiptId;

    SELECT
        [ReceiptId],
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[ReceiptMaster]
    WHERE [ReceiptId] = @ReceiptId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[hm].[ServiceDetail_Delete] 
(
    @ServiceDetailId INT,
	@ActionUser varchar(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE[hm].[ServiceDetail]
	SET 
		[IsActive]   = 0,
		[IsDeleted]  = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ServiceDetailId] = @ServiceDetailId
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[hm].[ServiceDetail_ReadAll] 
AS
BEGIN
	SET NOCOUNT ON;
	SELECT
		 [ServiceDetailId]
		,[ServiceDetailName]
		,[ServiceDescrition]
		,[Charges]
		,[ChargeType]
		,[ChargeBasis]
		,[ChargeQuantity]
		,[TotalCharge]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[ServiceDetail]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[hm].[ServiceDetail_ReadById] 
(
    @ServiceDetailId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT
		 [ServiceDetailId]
		,[ServiceDetailName]
		,[ServiceDescrition]
		,[Charges]
		,[ChargeType]
		,[ChargeBasis]
		,[ChargeQuantity]
		,[TotalCharge]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[ServiceDetail]
	WHERE [ServiceDetailId] = @ServiceDetailId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[ServiceDetail_Update]
(
    @ServiceDetailId    INT,
    @ServiceDetailName  VARCHAR(100),
    @ServiceDescrition  VARCHAR(500),
    @Charges            DECIMAL(18, 2),
    @ChargeType         VARCHAR(50),
    @ChargeBasis        VARCHAR(100),
    @ChargeQuantity     DECIMAL(18, 2),
    @TotalCharge        DECIMAL(18, 2),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @IsActive           INT,
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[ServiceDetail]
    SET 
        [ServiceDetailName]   = @ServiceDetailName,
        [ServiceDescrition]   = @ServiceDescrition,
        [Charges]             = @Charges,
        [ChargeType]          = @ChargeType,
        [ChargeBasis]         = @ChargeBasis,
        [ChargeQuantity]      = @ChargeQuantity,
        [TotalCharge]         = @TotalCharge,
        [OtherDetail1]        = @OtherDetail1,
        [OtherDetail2]        = @OtherDetail2,
        [OtherDetail3]        = @OtherDetail3,
        [OtherDetail4]        = @OtherDetail4,
        [OtherDetail5]        = @OtherDetail5,
        [OtherDetail6]        = @OtherDetail6,
        [IsActive]            = @IsActive,
        [ModifiedBy]          = @ActionUser,
        [ModifiedOn]          = GETDATE()
    WHERE [ServiceDetailId] = @ServiceDetailId;

    SELECT 
        [ServiceDetailId],
        [ServiceDetailName],
        [ServiceDescrition],
        [Charges],
        [ChargeType],
        [ChargeBasis],
        [ChargeQuantity],
        [TotalCharge],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[ServiceDetail]
    WHERE [ServiceDetailId] = @ServiceDetailId
	      AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[ServiceMaster_Create]
(
    @HospitalId        INT,
    @ServiceName       VARCHAR(100),
    @ServiceCode       VARCHAR(50),
    @ServiceDescription VARCHAR(500),
    @TotalCharge       DECIMAL(18, 2),
    @EstimateDays      INT,
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ServiceId INT;

    INSERT INTO [hm].[ServiceMaster]
    (
        [HospitalId],
        [ServiceName],
        [ServiceCode],
        [ServiceDescription],
        [TotalCharge],
        [EstimateDays],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        @ServiceName,
        @ServiceCode,
        @ServiceDescription,
        @TotalCharge,
        @EstimateDays,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,               
        0,               
        @ActionUser,     
        GETDATE()        
    );

    SET @ServiceId = SCOPE_IDENTITY();

    SELECT 
        [ServiceId],
        [HospitalId],
        [ServiceName],
        [ServiceCode],
        [ServiceDescription],
        [TotalCharge],
        [EstimateDays],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[ServiceMaster]
    WHERE [ServiceId] = @ServiceId;
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[ServiceMaster_Delete]
(
   @ServiceId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE[hm].[ServiceMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ServiceId] = @ServiceId
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[ServiceMaster_ReadAll]
AS
 BEGIN
     SET NOCOUNT ON;
	SELECT
		 [ServiceId]
		,[HospitalId]
		,[ServiceName]
		,[ServiceCode]
		,[ServiceDescription]
		,[TotalCharge]
		,[EstimateDays]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[hm].[ServiceMaster]
	WHERE[IsActive]  = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[ServiceMaster_ReadAllPaginated]
(
    @HospitalId INT,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Offset INT = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);

    -- Build dynamic SQL
    SET @SQL = 
		'SELECT 
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum,
        [ServiceId],
        [HospitalId],
        [ServiceName],
        [ServiceCode],
        [ServiceDescription],
        [TotalCharge],
        [EstimateDays],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn],
		COUNT(*) OVER () AS TotalCount,
		' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
		' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [Nishwik].[hm].[ServiceMaster]
    WHERE [HospitalId] = ' + CAST(@HospitalId AS NVARCHAR) + N' AND [IsActive] = 1';

	-- Append additional WHERE clause safely
	IF @WhereClause IS NOT NULL AND LTRIM(RTRIM(@WhereClause)) <> ''
		SET @SQL = @SQL + ' AND (' + @WhereClause + ')';

	SET @SQL = @SQL + '
	ORDER BY RowNum
	OFFSET ' + CAST(@Offset AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL;
	EXEC sp_executesql @SQL;


END;
GO
/****** Object:  StoredProcedure [hm].[ServiceMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[ServiceMaster_ReadByHospitalId]
(
   @HospitalId INT
)
AS
 BEGIN
     SET NOCOUNT ON;
	SELECT
		 [ServiceId]
		,[HospitalId]
		,[ServiceName]
		,[ServiceCode]
		,[ServiceDescription]
		,[TotalCharge]
		,[EstimateDays]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[hm].[ServiceMaster]
	WHERE [HospitalId] = @HospitalId
	AND   [IsActive]  = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[ServiceMaster_ReadById]
(
   @ServiceId INT
)
AS
 BEGIN
     SET NOCOUNT ON;
	SELECT
		 [ServiceId]
		,[HospitalId]
		,[ServiceName]
		,[ServiceCode]
		,[ServiceDescription]
		,[TotalCharge]
		,[EstimateDays]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[hm].[ServiceMaster]
	WHERE [ServiceId] = @ServiceId
	AND [IsActive]  = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[ServiceMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[ServiceMaster_Update]
(
    @ServiceId         INT,
    @HospitalId        INT,
    @ServiceName       VARCHAR(100),
    @ServiceCode       VARCHAR(50),
    @ServiceDescription VARCHAR(500),
    @TotalCharge       DECIMAL(18, 2),
    @EstimateDays      INT,
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[ServiceMaster]
    SET
         [HospitalId]        = @HospitalId
        ,[ServiceName]       = @ServiceName
        ,[ServiceCode]       = @ServiceCode
        ,[ServiceDescription] = @ServiceDescription
        ,[TotalCharge]       = @TotalCharge
        ,[EstimateDays]      = @EstimateDays
        ,[OtherDetail1]      = @OtherDetail1
        ,[OtherDetail2]      = @OtherDetail2
        ,[OtherDetail3]      = @OtherDetail3
        ,[OtherDetail4]      = @OtherDetail4
        ,[OtherDetail5]      = @OtherDetail5
        ,[OtherDetail6]      = @OtherDetail6
        ,[IsActive]          = @IsActive
        ,[ModifiedBy]        = @ActionUser
        ,[ModifiedOn]        = GETDATE()
    WHERE [ServiceId] = @ServiceId ;

    SELECT 
         [ServiceId]
        ,[HospitalId]
        ,[ServiceName]
        ,[ServiceCode]
        ,[ServiceDescription]
        ,[TotalCharge]
        ,[EstimateDays]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [hm].[ServiceMaster]
    WHERE [ServiceId] = @ServiceId
	AND [IsActive] = 1 ;
END;
GO
/****** Object:  StoredProcedure [hm].[SocietyImgMaster_ReadByMasterType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [hm].[SocietyImgMaster_ReadByMasterType]
(
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[SocietyImgMaster]
	WHERE [MasterType] = @MasterType
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanDetail_Create]
(
	@PlanId INT,
	@StaffType varchar(50) = NULL,
	@StaffId int = NULL,
    @ServiceId INT,
	@ActionTime TIME,
	@ActionDetail VARCHAR(500),
    @ServiceCost DECIMAL,
    @DiscountValue DECIMAL,
    @TaxValue DECIMAL,
    @NetAmount DECIMAL,
	@IsCompleted INT,
	@DiscountType VARCHAR(50),
    @TaxType VARCHAR(50),
	@PmtStatus VARCHAR(50),
	@PlanDate DATETIME,
	@InvoiceId INT = NULL,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId BIGINT;

    INSERT INTO [hm].[TreatmentPlanDetail]
    (
		[StaffType],
		[StaffId],
        [ServiceId],
        [ActionTime],
        [ActionDetail],
		[PlanId],
		[ServiceCost],
        [DiscountValue],
        [TaxValue],
        [NetAmount],
		[IsCompleted],
		[DiscountType],
        [TaxType],
		[PmtStatus],
		[PlanDate],
		[InvoiceId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
		@StaffType,
		@StaffId,
        @ServiceId,
        @ActionTime,
        @ActionDetail,
		@PlanId,
		@ServiceCost,
        @DiscountValue,
        @TaxValue,
        @NetAmount,
		@IsCompleted,
		@DiscountType,
        @TaxType,
		@PmtStatus,
		@PlanDate,
		@InvoiceId,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
         1,
         0,
        @ActionUser,
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT 
	   [DetailId]
	  ,[StaffType]
	  ,[StaffId]
      ,[ServiceId]
      ,[ActionTime]
      ,[ActionDetail]
	  ,[PlanId]
	  ,[ServiceCost]
      ,[DiscountValue]
      ,[TaxValue]
      ,[NetAmount]
	  ,[IsCompleted]
	  ,[DiscountType]
      ,[TaxType]
	  ,[PmtStatus]
	  ,[PlanDate]
	  ,[InvoiceId]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[TreatmentPlanDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentPlanDetail_CreateBulk]
(
  @DetailList [hm].[udt_TreatmentPlanDetail] READONLY ,
  @ActionUser VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	INSERT INTO [hm].[TreatmentPlanDetail]
	(
		 [PlanId]
		,[StaffType]
		,[StaffId]
		,[ServiceId]
		,[ActionTime]
		,[ActionDetail]
		,[ServiceCost]
		,[DiscountValue]
		,[TaxValue]
		,[NetAmount]
		,[IsCompleted]
		,[DiscountType]
		,[TaxType]
		,[PmtStatus]
		,[PlanDate]
		,[InvoiceId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn] 
	)
	SELECT 
		 [PlanId]
		,[StaffType]
		,[StaffId]
		,[ServiceId]
		,[ActionTime]
		,[ActionDetail]
		,[ServiceCost]
		,[DiscountValue]
		,[TaxValue]
		,[NetAmount]
		,[IsCompleted]
		,[DiscountType]
		,[TaxType]
		,[PmtStatus]
		,[PlanDate]
		,[InvoiceId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,1
		,0
		,@ActionUser
		,GETDATE()
	FROM   @DetailList;

	SELECT 
		 [DetailId]
		,[PlanId]
		,[StaffType]
		,[StaffId]
		,[ServiceId]
		,[ActionTime]
		,[ActionDetail]
		,[ServiceCost]
		,[DiscountValue]
		,[TaxValue]
		,[NetAmount]
		,[IsCompleted]
		,[DiscountType]
		,[TaxType]
		,[PmtStatus]
		,[PlanDate]
		,[InvoiceId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [hm].[TreatmentPlanDetail]
	WHERE IsActive = 1
	AND IsDeleted = 0
	AND CreatedBy = @ActionUser
	AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;

GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanDetail_Delete]
(
   @DetailId BIGINT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[TreatmentPlanDetail]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanDetail_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	    [DetailId]
	  ,[StaffType]
	  ,[StaffId]
      ,[ServiceId]
      ,[ActionTime]
      ,[ActionDetail]
	  ,[PlanId]
	  ,[ServiceCost]
      ,[DiscountValue]
      ,[TaxValue]
      ,[NetAmount]
	  ,[IsCompleted]
	  ,[DiscountType]
      ,[TaxType]
	  ,[PmtStatus]
	  ,[PlanDate]
	  ,[InvoiceId]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[TreatmentPlanDetail]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanDetail_ReadById]
(
   @DetailId BIGINT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[DetailId]
	   , A.[StaffType]
	   , A.[StaffId]
      ,A.[ServiceId]
	  ,B.[ServiceName]
      ,A.[ActionTime]
      ,A.[ActionDetail]
	  ,A.[PlanId]
	  ,A.[ServiceCost]
      ,A.[DiscountValue]
      ,A.[TaxValue]
      ,A.[NetAmount]
	  ,A.[IsCompleted]
	  ,A.[DiscountType]
      ,A.[TaxType]
	  , A.[PmtStatus]
	  ,A.[PlanDate]
	  ,A.[InvoiceId]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentPlanDetail]A
	  LEFT OUTER JOIN [Nishwik].[hm].[ServiceMaster]B
	  ON A.[ServiceId] = B.[ServiceId]
	  WHERE A.[DetailId] = @DetailId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_ReadByInvoiceId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentPlanDetail_ReadByInvoiceId] 
(
	@InvoiceId INT
)
AS 
BEGIN
SET NOCOUNT ON;
SELECT 
	   [DetailId]
	  ,[StaffType]
	  ,[StaffId]
      ,[ServiceId]
      ,[ActionTime]
      ,[ActionDetail]
	  ,[PlanId]
	  ,[ServiceCost]
      ,[DiscountValue]
      ,[TaxValue]
      ,[NetAmount]
	  ,[IsCompleted]
	  ,[DiscountType]
      ,[TaxType]
	  ,[PmtStatus]
	  ,[PlanDate]
	  ,[InvoiceId]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [hm].[TreatmentPlanDetail]
	WHERE [InvoiceId] = @InvoiceId AND [IsActive] = 1 AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_ReadByPlanId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanDetail_ReadByPlanId]
(
   @PlanId INT
 
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[DetailId]
	   , A.[StaffType]
	   , A.[StaffId]
      ,A.[ServiceId]
	  ,B.[ServiceName]
      ,A.[ActionTime]
      ,A.[ActionDetail]
	  ,A.[PlanId]
	  ,A.[ServiceCost]
      ,A.[DiscountValue]
      ,A.[TaxValue]
      ,A.[NetAmount]
	  ,A.[IsCompleted]
	  ,A.[DiscountType]
      ,A.[TaxType]
	  ,A.[PmtStatus]
	  ,A.[PlanDate]
	  ,A.[InvoiceId]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentPlanDetail]A
	  LEFT OUTER JOIN [Nishwik].[hm].[ServiceMaster]B
	  ON A.[ServiceId] = B.[ServiceId]
	  WHERE A.[PlanId] = @PlanId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_ReadByServiceId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanDetail_ReadByServiceId]
(
   @ServiceId INT
 
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT
	   A.[DetailId]
	   , A.[StaffType]
	   , A.[StaffId]
      ,A.[ServiceId]
	  ,B.[ServiceName]
      ,A.[ActionTime]
      ,A.[ActionDetail]
	  ,A.[PlanId]
	  ,A.[ServiceCost]
      ,A.[DiscountValue]
      ,A.[TaxValue]
      ,A.[NetAmount]
	  ,A.[IsCompleted]
	  ,A.[DiscountType]
      ,A.[TaxType]
	  ,A.[PmtStatus]
	  ,A.[PlanDate]
	  ,A.[InvoiceId]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentPlanDetail]A
	  LEFT OUTER JOIN [Nishwik].[hm].[ServiceMaster]B
	  ON A.[ServiceId] = B.[ServiceId]
	  WHERE A.[ServiceId] = @ServiceId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanDetail_Update]
(
    @DetailId INT,
	@StaffType varchar(50) = NULL,
	@StaffId int = NULL,
	@ServiceId INT,
	@ActionTime TIME,
	@ActionDetail VARCHAR(500),
	@PlanId INT,
	@ServiceCost DECIMAL,
    @DiscountValue DECIMAL,
    @TaxValue DECIMAL,
    @NetAmount DECIMAL,
	@IsCompleted INT,
	@DiscountType VARCHAR(50),
    @TaxType VARCHAR(50),
	@PmtStatus VARCHAR(50),
	@PlanDate DATETIME,
	@InvoiceId INT = NULL,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[TreatmentPlanDetail]
    SET
		[StaffType] = @StaffType,
		[StaffId] = @StaffId,
        [ServiceId] = @ServiceId,
        [ActionTime] = @ActionTime,
        [ActionDetail] = @ActionDetail,
		[PlanId] = @PlanId,
		[ServiceCost] = @ServiceCost,
        [DiscountValue] = @DiscountValue,
        [TaxValue] = @TaxValue,
        [NetAmount] = @NetAmount,
		[IsCompleted] = @IsCompleted,
		[DiscountType] = @DiscountType,
        [TaxType] = @TaxType,
		[PmtStatus] = @PmtStatus,
		[PlanDate] =@PlanDate,
		[InvoiceId] = @InvoiceId,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT 
        [DetailId]
	  ,[StaffType]
	  ,[StaffId]
      ,[ServiceId]
      ,[ActionTime]
      ,[ActionDetail]
	  ,[PlanId]
	  ,[ServiceCost]
      ,[DiscountValue]
      ,[TaxValue]
      ,[NetAmount]
	  ,[IsCompleted]
	  ,[DiscountType]
      ,[TaxType]
	  ,[PmtStatus]
	  ,[PlanDate]
	  ,[InvoiceId]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[TreatmentPlanDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanMaster_Create]
(
    @PatientId INT,
	@StartDate DATETIME,
	@EndDate DATETIME,
	@DoctorId INT ,
	@BedId INT,
	@HospitalId INT,
	@TotalCost DECIMAL,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PlanId INT;

    INSERT INTO [hm].[TreatmentPlanMaster]
    (
        [PatientId],
        [StartDate],
		[EndDate],
        [DoctorId],
        [BedId],
		[HospitalId], 
		[TotalCost],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @PatientId,
        @StartDate,
		@EndDate,
        @DoctorId,
        @BedId,
		@HospitalId, 
		@TotalCost,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
         1,
         0,
        @ActionUser,
        GETDATE()
    );

    SET @PlanId = SCOPE_IDENTITY();

	SELECT 
	[PlanId],
	[PatientId],
	[StartDate],
	[EndDate],
	[DoctorId],
	[BedId],
	[HospitalId], 
	[TotalCost],
	[OtherDetail1],
	[OtherDetail2],
	[OtherDetail3],
	[OtherDetail4],
	[OtherDetail5],
	[OtherDetail6],
	[IsActive],
	[IsDeleted],
	[CreatedBy],
	[CreatedOn],
	[ModifiedBy],
	[ModifiedOn]
	FROM [hm].[TreatmentPlanMaster]
	WHERE [PlanId] = @PlanId;
END
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanMaster_Delete]
(
   @PlanId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[TreatmentPlanMaster]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [PlanId] = @PlanId
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanMaster_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PlanId]
      ,[PatientId]
      ,[StartDate]
	  ,[EndDate]
      ,[DoctorId]
      ,[BedId]
	  ,[HospitalId] 
	  ,[TotalCost]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[TreatmentPlanMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [hm].[TreatmentPlanMaster_ReadAllPaginated] 
     @PageSize = 10, 
     @PageNo = 1, 
     @OrderByClause = '', 
     @WhereClause = '';
*/

CREATE PROCEDURE [hm].[TreatmentPlanMaster_ReadAllPaginated]
(
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON; 

    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = 
        'SELECT
            ROW_NUMBER() OVER (ORDER BY ' + 
            ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'HospitalId DESC') + 
            ') AS RowNum,
           [PlanId],
           [PatientId],
           [StartDate],
           [DoctorId],
           [BedId],
           [OtherDetail1],
           [OtherDetail2],
           [OtherDetail3],
           [OtherDetail4],
           [OtherDetail5],
           [OtherDetail6],
           [IsActive],
           [IsDeleted],
           [CreatedBy],
           [CreatedOn],
           [ModifiedBy],
           [ModifiedOn],
           [HospitalId],
           [TotalCost],
           [EndDate],
             COUNT(*) OVER () AS TotalCount,
             ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
             ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
        FROM [Nishwik].[hm].[TreatmentPlanMaster]
        WHERE [IsActive] = 1 ';


    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;


    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY HospitalId DESC';

    SET @SQL = @SQL + '
        OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
        FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL; 
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_ReadByBedId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanMaster_ReadByBedId]
(
   @BedId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[PlanId]
      ,A.[PatientId]
	  ,B.[FirstName] AS PatientFirstName
	  ,B.[LastName] AS  PatientLastName
      ,A.[StartDate]
	  ,A.[EndDate]
	  ,A.[HospitalId]
	  ,C.[HospitalName]
      ,A.[DoctorId]
	  ,B.[FirstName] AS DoctorFirstName
	  ,B.[LastName] AS DoctorLastName
      ,A.[BedId]
	  , D.[BedNumber]
	  ,A.[TotalCost]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentPlanMaster]A
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]B
	ON   A.[PatientId]= B.[UserId] AND [DoctorId] = [DoctorId]
	LEFT OUTER JOIN [Nishwik].[hm].[HospitalMaster]C
	ON A.[HospitalId] = C.[HospitalId]
	LEFT OUTER JOIN [Nishwik].[hm].[HospitalBedMaster]D
	ON A.[BedId] = D.[BedId]
	  WHERE A. [BedId] = @BedId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_ReadByDoctorId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanMaster_ReadByDoctorId]
(
   @DoctorId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	   SELECT 
	   A.[PlanId]
      ,A.[PatientId]
	  ,B.[FirstName] AS PatientFirstName
	  ,B.[LastName] AS  PatientLastName
      ,A.[StartDate]
	  ,A.[EndDate]
	  ,A.[HospitalId]
	  ,D.[HospitalName]
      ,A.[DoctorId]
	  ,C.[FirstName] AS DoctorFirstName
	  ,C.[LastName] AS DoctorLastName
      ,A.[BedId]
	  ,E.[BedNumber]
	  ,A.[TotalCost]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentPlanMaster]A
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]B
		ON A.[PatientId]= B.[UserId]
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]C
		ON A.[DoctorId] = C.[UserId]
	  LEFT OUTER JOIN [Nishwik].[hm].[HospitalMaster]D
		ON A.[HospitalId] = D.[HospitalId]
	  LEFT OUTER JOIN [Nishwik].[hm].[HospitalBedMaster]E
		ON A.[BedId] = E.[BedId]
	  WHERE A. [DoctorId] = @DoctorId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentPlanMaster_ReadByHospitalId]
(
   @HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        A.[PlanId],
        A.[PatientId],
        P.[FirstName] AS PatientFirstName,
        P.[LastName]  AS PatientLastName,
        A.[StartDate],
        A.[EndDate],
        A.[HospitalId],
        C.[HospitalName],
        A.[DoctorId],
        D.[FirstName] AS DoctorFirstName,
        D.[LastName]  AS DoctorLastName,
        A.[BedId],
        B.[BedNumber],
        A.[TotalCost],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn]
    FROM [hm].[TreatmentPlanMaster] A
    LEFT JOIN [Nishwik].[dbo].[UserMaster] P
        ON A.[PatientId] = P.[UserId]
    LEFT JOIN [Nishwik].[dbo].[UserMaster] D
        ON A.[DoctorId] = D.[UserId]
    LEFT JOIN [Nishwik].[hm].[HospitalMaster] C
        ON A.[HospitalId] = C.[HospitalId]
    LEFT JOIN [Nishwik].[hm].[HospitalBedMaster] B
        ON A.[BedId] = B.[BedId]
    WHERE A.[HospitalId] = @HospitalId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanMaster_ReadById]
(
   @PlanId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	   SELECT 
	   A.[PlanId]
      ,A.[PatientId]
	  ,B.[FirstName] AS PatientFirstName
	  ,B.[LastName] AS  PatientLastName
      ,A.[StartDate]
	  ,A.[EndDate]
	  ,A.[HospitalId]
	  ,C.[HospitalName]
      ,A.[DoctorId]
	  ,B.[FirstName] AS DoctorFirstName
	  ,B.[LastName] AS DoctorLastName
      ,A.[BedId]
	  , D.[BedNumber]
	  ,A.[TotalCost]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentPlanMaster]A
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]B
	ON   A.[PatientId]= B.[UserId] AND [DoctorId] = [DoctorId]
	LEFT OUTER JOIN [Nishwik].[hm].[HospitalMaster]C
	ON A.[HospitalId] = C.[HospitalId]
	LEFT OUTER JOIN [Nishwik].[hm].[HospitalBedMaster]D
	ON A.[BedId] = D.[BedId]
	  WHERE A. [PlanId] = @PlanId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_ReadByPatientId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanMaster_ReadByPatientId]
(
   @PatientId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	   SELECT 
	   A.[PlanId]
      ,A.[PatientId]
	  ,B.[FirstName] AS PatientFirstName
	  ,B.[LastName] AS  PatientLastName
      ,A.[StartDate]
	  ,A.[EndDate]
	  ,A.[HospitalId]
	  ,C.[HospitalName]
      ,A.[DoctorId]
	  ,B.[FirstName] AS DoctorFirstName
	  ,B.[LastName] AS DoctorLastName
      ,A.[BedId]
	  , D.[BedNumber]
	  ,A.[TotalCost]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentPlanMaster]A
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]B
	ON   A.[PatientId]= B.[UserId] AND [DoctorId] = [DoctorId]
	LEFT OUTER JOIN [Nishwik].[hm].[HospitalMaster]C
	ON A.[HospitalId] = C.[HospitalId]
	LEFT OUTER JOIN [Nishwik].[hm].[HospitalBedMaster]D
	ON A.[BedId] = D.[BedId]
	  WHERE A. [PatientId] = @PatientId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentPlanMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[TreatmentPlanMaster_Update]
(
    @PlanId INT,   
    @PatientId INT,
	@StartDate DATETIME,
	@EndDate DATETIME,
	@DoctorId INT ,
	@BedId INT,
	@HospitalId INT,
	@TotalCost DECIMAL,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[TreatmentPlanMaster]
    SET
        [PatientId] = @PatientId,
        [StartDate] = @StartDate,
        [EndDate] = @EndDate,
        [DoctorId] = @DoctorId,
        [BedId] = @BedId,
		[HospitalId] = @HospitalId,
		[TotalCost] = @TotalCost,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive]     = @IsActive,
        [ModifiedBy]   = @ActionUser,
        [ModifiedOn]   = GETDATE()
    WHERE [PlanId] = @PlanId;

    SELECT 
        [PlanId],
        [PatientId],
        [StartDate],
		[EndDate],
        [DoctorId],
        [BedId],
		[HospitalId],
		[TotalCost],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[TreatmentPlanMaster]
    WHERE [PlanId] = @PlanId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateDetail_Create]
(
    @TemplateId INT,
	@StaffType VARCHAR(100),
	@ServiceId INT,
	@Actiondetail VARCHAR(500),
	@DiscountPercentage INT,
	@TaxPercentage INT,
	@ServiceAmount DECIMAL(18,2),
	@TotalCharge DECIMAL(18,2),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [hm].[TreatmentTemplateDetail]
    (
        [TemplateId],
        [StaffType],
        [ServiceId],
        [Actiondetail],
        [DiscountPercentage],
        [TaxPercentage],
		[ServiceAmount],
        [TotalCharge],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @TemplateId,
        TRIM(@StaffType),
        @ServiceId,
        TRIM(@Actiondetail),
        @DiscountPercentage,
        @TaxPercentage,
		@ServiceAmount,
		@TotalCharge,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
         1,
         0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT 
	   [DetailId]
      ,[TemplateId]
      ,[StaffType]
      ,[ServiceId]
      ,[Actiondetail]
      ,[DiscountPercentage]
      ,[TaxPercentage]
	  ,[ServiceAmount]
      ,[TotalCharge]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[TreatmentTemplateDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateDetail_Delete]
(
   @DetailId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[TreatmentTemplateDetail]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateDetail_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[TemplateId]
      ,[StaffType]
      ,[ServiceId]
      ,[Actiondetail]
      ,[DiscountPercentage]
      ,[TaxPercentage]
	  ,[ServiceAmount]
      ,[TotalCharge]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[TreatmentTemplateDetail]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateDetail_ReadById]
(
   @DetailId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	  A.[DetailId]
      ,A.[TemplateId]
      ,A.[StaffType]
      ,A.[ServiceId]
	  ,B.[ServiceName]
      ,A.[Actiondetail]
      ,A.[DiscountPercentage]
      ,A.[TaxPercentage]
	  ,A.[ServiceAmount]
      ,A.[TotalCharge]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentTemplateDetail] A
     LEFT OUTER JOIN [hm].[ServiceMaster]  B
        ON A.[ServiceId] = B.[ServiceId]
	  WHERE A.[DetailId] = @DetailId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateDetail_ReadByServiceId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateDetail_ReadByServiceId]
(
   @ServiceId INT

)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[DetailId]
      ,A.[TemplateId]
      ,A.[StaffType]
      ,A.[ServiceId]
	  ,B.[ServiceName]
      ,A.[Actiondetail]
      ,A.[DiscountPercentage]
      ,A.[TaxPercentage]
	  ,A.[ServiceAmount]
      ,A.[TotalCharge]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentTemplateDetail] A
     LEFT OUTER JOIN [hm].[ServiceMaster]  B
        ON A.[ServiceId] = B.[ServiceId]
	  WHERE A.[ServiceId] = @ServiceId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateDetail_ReadByTemplateId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateDetail_ReadByTemplateId]
(
   @TemplateId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
       A.[DetailId]
      ,A.[TemplateId]
      ,A.[StaffType]
      ,A.[ServiceId]
	  ,B.[ServiceName]
      ,A.[Actiondetail]
      ,A.[DiscountPercentage]
      ,A.[TaxPercentage]
	  ,A.[ServiceAmount]
      ,A.[TotalCharge]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [hm].[TreatmentTemplateDetail] A
     LEFT OUTER JOIN [hm].[ServiceMaster]  B
        ON A.[ServiceId] = B.[ServiceId]
	  WHERE A.[TemplateId] = @TemplateId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateDetail_Update]
(
    @DetailId INT,
	@TemplateId INT,
	@StaffType VARCHAR(100),
	@ServiceId INT,
	@Actiondetail VARCHAR(500),
	@DiscountPercentage INT,
	@TaxPercentage INT,
	@ServiceAmount DECIMAL(18,2),
	@TotalCharge DECIMAL(18,2),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[TreatmentTemplateDetail]
    SET
        [TemplateId] = @TemplateId,
        [StaffType] = TRIM(@StaffType),
        [ServiceId] = @ServiceId,
        [Actiondetail] = TRIM(@Actiondetail),
        [DiscountPercentage] = @DiscountPercentage,
        [TaxPercentage] = @TaxPercentage,
		[ServiceAmount] = @ServiceAmount,
		[TotalCharge] = @TotalCharge,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT 
        [DetailId],
        [TemplateId],
        [StaffType],
        [ServiceId],
        [Actiondetail],
        [DiscountPercentage],
        [TaxPercentage],
	    [ServiceAmount],
        [TotalCharge],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[TreatmentTemplateDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateMaster_Create]
(
    @HospitalId INT,
	@TemplateName VARCHAR(100),
	@Remark VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TemplateId INT;

    INSERT INTO [hm].[TreatmentTemplateMaster]
    (
        [HospitalId],
        [TemplateName],
        [Remark],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @HospitalId,
        TRIM(@TemplateName),
        TRIM(@Remark),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
         1,
         0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @TemplateId = SCOPE_IDENTITY();

    SELECT 
	   [TemplateId]
      ,[HospitalId]
      ,[TemplateName]
      ,[Remark]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [hm].[TreatmentTemplateMaster]
    WHERE [TemplateId] = @TemplateId;
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateMaster_Delete]
(
   @TemplateId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [hm].[TreatmentTemplateMaster]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [TemplateId] = @TemplateId
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateMaster_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [TemplateId]
      ,[HospitalId]
      ,[TemplateName]
      ,[Remark]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[TreatmentTemplateMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateMaster_ReadByHospitalId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateMaster_ReadByHospitalId]
(
   @HospitalId INT

)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [TemplateId]
      ,[HospitalId]
      ,[TemplateName]
      ,[Remark]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[TreatmentTemplateMaster]
	  WHERE [HospitalId] = @HospitalId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateMaster_ReadById]
(
   @TemplateId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [TemplateId]
      ,[HospitalId]
      ,[TemplateName]
      ,[Remark]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[TreatmentTemplateMaster]
	  WHERE [TemplateId] = @TemplateId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [hm].[TreatmentTemplateMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[TreatmentTemplateMaster_Update]
(
    @TemplateId INT,
	@HospitalId INT,
	@TemplateName VARCHAR(100),
	@Remark VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[TreatmentTemplateMaster]
    SET
        [HospitalId]    = @HospitalId,  
        [TemplateName]  = TRIM(@TemplateName),
        [Remark]        = TRIM(@Remark),
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [TemplateId] = @TemplateId;

    SELECT 
        [TemplateId],
        [HospitalId],
        [TemplateName],
        [Remark],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[TreatmentTemplateMaster]
    WHERE [TemplateId] = @TemplateId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[UserAffiliationMapping_Create]
(
    @UserId                 INT,
    @HospitalId             INT,
    @AffiliationType        VARCHAR(50) = NULL,
    @Designation            VARCHAR(50) = NULL,
    @IsPrimary              INT = NULL,
    @JoinedOn               DATETIME = NULL,
    @RegistrationNumber     VARCHAR(50)    NULL,  
    @LicensingAuthority     VARCHAR(100)   NULL, 
    @YearOfRegistration     INT            NULL, 
    @RegistrationDate       DATE           NULL, 
    @JoiningDate            DATE           NULL, 
    @ShiftType              VARCHAR(50)    NULL, 
    @VisitType              VARCHAR(50)    NULL, 
    @ReferredBy             VARCHAR(100)   NULL, 
    @SocialLink             VARCHAR(255)   NULL, 
    @Allergies              VARCHAR(255)   NULL,
    @ChronicCondition       VARCHAR(255)   NULL,
    @InsuranceProvider      VARCHAR(255)   NULL,
    @InsurancePolicyNo      VARCHAR(100)   NULL,
    @EmiEligibilityStatus   VARCHAR(50)    NULL,
    @LoanReferenceId        VARCHAR(100)   NULL,
    @TermsAccepted          INT,
    @OtherDetail1           VARCHAR(50) = NULL,
    @OtherDetail2           VARCHAR(50) = NULL,
    @OtherDetail3           VARCHAR(100) = NULL,
    @OtherDetail4           VARCHAR(100) = NULL,
    @OtherDetail5           VARCHAR(500) = NULL,
    @OtherDetail6           VARCHAR(500) = NULL,
    @Department             VARCHAR(100) = NULL,
    @Specialization         VARCHAR(100) = NULL,
    @Education              VARCHAR(100) = NULL,
    @EmploymentType         VARCHAR(50) = NULL,
    @ConsultationFee        DECIMAL(18,2) = NULL,
    @YearsOfExperience      DECIMAL(18,2) = NULL,
    @ActionUser             VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MappingId INT;

    INSERT INTO [hm].[UserAffiliationMapping]
    (
         [UserId]
        ,[HospitalId]
        ,[AffiliationType]
        ,[Designation]
        ,[IsPrimary]
        ,[JoinedOn]
        ,[RegistrationNumber]
        ,[LicensingAuthority]
        ,[YearOfRegistration]
        ,[RegistrationDate]
        ,[JoiningDate]
        ,[ShiftType]
        ,[VisitType]
        ,[ReferredBy]
        ,[SocialLink]
        ,[Allergies]
        ,[ChronicCondition]
        ,[InsuranceProvider]
        ,[InsurancePolicyNo]
        ,[EmiEligibilityStatus]
        ,[LoanReferenceId]
        ,[TermsAccepted]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[Department]
        ,[Specialization]
        ,[Education]
        ,[EmploymentType]
        ,[ConsultationFee]
        ,[YearsOfExperience]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @UserId
        ,@HospitalId
        ,TRIM(@AffiliationType)
        ,TRIM(@Designation)
        ,@IsPrimary
        ,@JoinedOn
        ,TRIM(@RegistrationNumber)
        ,TRIM(@LicensingAuthority)
        ,@YearOfRegistration
        ,@RegistrationDate
        ,@JoiningDate
        ,TRIM(@ShiftType)
        ,TRIM(@VisitType)
        ,TRIM(@ReferredBy)
        ,TRIM(@SocialLink)
        ,TRIM(@Allergies)
        ,TRIM(@ChronicCondition)
        ,TRIM(@InsuranceProvider)
        ,TRIM(@InsurancePolicyNo)
        ,TRIM(@EmiEligibilityStatus)
        ,TRIM(@LoanReferenceId)
        ,@TermsAccepted
        ,TRIM(@OtherDetail1)
        ,TRIM(@OtherDetail2)
        ,TRIM(@OtherDetail3)
        ,TRIM(@OtherDetail4)
        ,TRIM(@OtherDetail5)
        ,TRIM(@OtherDetail6)
        ,TRIM(@Department)
        ,TRIM(@Specialization)
        ,TRIM(@Education)
        ,TRIM(@EmploymentType)
        ,@ConsultationFee
        ,@YearsOfExperience
        ,1
        ,0
        ,TRIM(@ActionUser)
        ,GETDATE()
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT 
        [MappingId],
        [UserId],
        [HospitalId],
        [AffiliationType],
        [Designation],
        [IsPrimary],
        [JoinedOn],
        [RegistrationNumber],
        [LicensingAuthority],
        [YearOfRegistration],
        [RegistrationDate],
        [JoiningDate],
        [ShiftType],
        [VisitType],
        [ReferredBy],
        [SocialLink],
        [Allergies],
        [ChronicCondition],
        [InsuranceProvider],
        [InsurancePolicyNo],
        [EmiEligibilityStatus],
        [LoanReferenceId],
        [TermsAccepted],
        [Department],
        [Specialization],
        [Education],
        [EmploymentType],
        [ConsultationFee],
        [YearsOfExperience],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[UserAffiliationMapping]
    WHERE [MappingId] = @MappingId;
END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[UserAffiliationMapping_Delete]
(
    @MappingId int,
	@ActionUser varchar(50)
)
AS 
BEGIN 
	SET NOCOUNT ON;
	UPDATE [hm].[UserAffiliationMapping]
	SET 
		[IsActive] = 0 ,
		[IsDeleted] = 1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MappingId]  =@MappingId
END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_DoctorGetDictionary]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[UserAffiliationMapping_DoctorGetDictionary]
(
      @DoctorId INT
)
AS
BEGIN
    SET NOCOUNT ON;

   
    DECLARE @Today DATE = CAST(GETDATE() AS DATE);

    DECLARE @WeekStart DATE = DATEADD(DAY, 1 - DATEPART(WEEKDAY, @Today), @Today);
    DECLARE @WeekEnd   DATE = DATEADD(DAY, 7 - DATEPART(WEEKDAY, @Today), @Today);

    DECLARE @MonthStart DATE = DATEFROMPARTS(YEAR(@Today), MONTH(@Today), 1);
    DECLARE @MonthEnd   DATE = EOMONTH(@Today);

   
    DECLARE @DoctorName VARCHAR(200);

    SELECT TOP 1
        @DoctorName =
            CASE 
                WHEN Description IS NULL THEN 'Unknown Doctor'
                WHEN CHARINDEX(',', Description) > 0 
                    THEN LTRIM(RTRIM(LEFT(Description, CHARINDEX(',', Description) - 1)))
                ELSE LTRIM(RTRIM(Description))
            END
    FROM hm.AppoinmentMaster
    WHERE MasterType = 'Doctor'
      AND MasterId = @DoctorId;

    IF @DoctorName IS NULL
        SET @DoctorName = 'Unknown Doctor';

   
    SELECT
       
        (SELECT COUNT(*)
         FROM hm.AppointmentScheduleMaster
         WHERE DoctorId = @DoctorId
           AND IsActive = 1
           AND IsDeleted = 0
           AND CAST(AppointmentDate AS DATE) = @Today
        ) AS TodayPatientCount,

       
        (SELECT COUNT(*)
         FROM hm.AppointmentScheduleMaster
         WHERE DoctorId = @DoctorId
           AND IsActive = 1
           AND IsDeleted = 0
           AND CAST(AppointmentDate AS DATE) BETWEEN @WeekStart AND @WeekEnd
        ) AS PerWeekPatientCount,

 
        (SELECT COUNT(*)
         FROM hm.AppointmentScheduleMaster
         WHERE DoctorId = @DoctorId
           AND IsActive = 1
           AND IsDeleted = 0
           AND CAST(AppointmentDate AS DATE) BETWEEN @MonthStart AND @MonthEnd
        ) AS PerMonthPatientCount,

       
        0 AS EMIPatientCount,

        
        @DoctorName AS DoctorFullName;

END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[UserAffiliationMapping_ReadAll]
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[HospitalId]
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[joinedOn]
	  ,[Department]
      ,[Specialization]
      ,[Education]
      ,[EmploymentType]
	  ,[ConsultationFee]
      ,[YearsOfExperience]
	  ,[RegistrationNumber]
      ,[LicensingAuthority]
      ,[YearOfRegistration]
      ,[RegistrationDate]
      ,[JoiningDate]
      ,[ShiftType]
      ,[VisitType]
      ,[ReferredBy]
      ,[SocialLink]
	   ,[Allergies]
      ,[ChronicCondition]
      ,[InsuranceProvider]
      ,[InsurancePolicyNo]
      ,[EmiEligibilityStatus]
      ,[LoanReferenceId]
      ,[TermsAccepted]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[UserAffiliationMapping]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_ReadByHospitalId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[UserAffiliationMapping_ReadByHospitalId]
(
  @HospitalId INT
)
AS
BEGIN 
    SET NOCOUNT ON; 
	SELECT 
        B.[FirstName],
        B.[MiddleName],
        B.[LastName],
        B.[DOB],
        B.[MobileNo],
        B.[EmailId],
        B.[ProfileImage] AS ProfileImage,
        A.[MappingId],
        A.[UserId],
        A.[HospitalId],
        A.[AffiliationType],
        A.[Designation],
        A.[IsPrimary],
        A.[JoinedOn],
        A.[Department],
        A.[Specialization],
        A.[Education],
        A.[EmploymentType],
        A.[ConsultationFee],
        A.[YearsOfExperience],
        A.[RegistrationNumber],
        A.[LicensingAuthority],
        A.[YearOfRegistration],
        A.[RegistrationDate],
        A.[JoiningDate],
        A.[ShiftType],
        A.[VisitType],
        A.[ReferredBy],
        A.[SocialLink],
        A.[Allergies],
        A.[ChronicCondition],
        A.[InsuranceProvider],
        A.[InsurancePolicyNo],
        A.[EmiEligibilityStatus],
        A.[LoanReferenceId],
        A.[TermsAccepted],
        B.[Address],
        B.[Country],
        B.[State],
        B.[City],
        B.[BloodGroup],
        B.[Gender],
        B.[AadharNumber],
        B.[PanNumber],
        B.[Nationality],
        B.[Religion],
        B.[Caste],
        B.[EmergencyContactName],
        B.[EmergencyContactNo],
        B.[MaritalStatus],
        B.[PinCode],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn]
    FROM [hm].[UserAffiliationMapping] A
    LEFT OUTER JOIN [dbo].[UserMaster] B
        ON A.[UserId] = B.[UserId]
    WHERE A.[HospitalId] = @HospitalId
    AND A.[IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[UserAffiliationMapping_ReadById]
(
    @MappingId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[HospitalId]
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[joinedOn]
	  ,[Department]
      ,[Specialization]
      ,[Education]
      ,[EmploymentType]
	  ,[ConsultationFee]
      ,[YearsOfExperience]
	  ,[RegistrationNumber]
      ,[LicensingAuthority]
      ,[YearOfRegistration]
      ,[RegistrationDate]
      ,[JoiningDate]
      ,[ShiftType]
      ,[VisitType]
      ,[ReferredBy]
      ,[SocialLink]
	  ,[Allergies]
      ,[ChronicCondition]
      ,[InsuranceProvider]
      ,[InsurancePolicyNo]
      ,[EmiEligibilityStatus]
      ,[LoanReferenceId]
      ,[TermsAccepted]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[UserAffiliationMapping]
	  WHERE [MappingId]  =@MappingId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[UserAffiliationMapping_ReadByUserId]
(
    @UserId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[HospitalId]
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[JoinedOn]
	  ,[Department]
      ,[Specialization]
      ,[Education]
      ,[EmploymentType]
	  ,[ConsultationFee]
      ,[YearsOfExperience]
	  ,[RegistrationNumber]
      ,[LicensingAuthority]
      ,[YearOfRegistration]
      ,[RegistrationDate]
      ,[JoiningDate]
      ,[ShiftType]
      ,[VisitType]
      ,[ReferredBy]
      ,[SocialLink]
	  ,[Allergies]
      ,[ChronicCondition]
      ,[InsuranceProvider]
      ,[InsurancePolicyNo]
      ,[EmiEligibilityStatus]
      ,[LoanReferenceId]
      ,[TermsAccepted]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [hm].[UserAffiliationMapping]
	  WHERE [UserId]  =@UserId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_ReadUserByHospitalId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [hm].[UserAffiliationMapping_ReadUserByHospitalId]
(
    @HospitalId INT,
    @AffiliationType VARCHAR(50)= NULL,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Result INT = 0, @TotalCount INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' +
            ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') +
        ') AS RowNum,
        B.[FirstName],
        B.[MiddleName],
        B.[LastName],
        B.[DOB],
        B.[MobileNo],
        B.[EmailId],
        ISNULL(B.[ProfileImage], '''') AS ProfileImage,
        A.[MappingId],
        A.[UserId],
        A.[HospitalId],
        A.[AffiliationType],
        A.[Designation],
        A.[IsPrimary],
        A.[JoinedOn],
        A.[Department],
        A.[Specialization],
        A.[Education],
        A.[EmploymentType],
        A.[ConsultationFee],
        A.[YearsOfExperience],
        A.[RegistrationNumber],
        A.[LicensingAuthority],
        A.[YearOfRegistration],
        A.[RegistrationDate],
        A.[JoiningDate],
        A.[ShiftType],
        A.[VisitType],
        A.[ReferredBy],
        A.[SocialLink],
        A.[Allergies],
        A.[ChronicCondition],
        A.[InsuranceProvider],
        A.[InsurancePolicyNo],
        A.[EmiEligibilityStatus],
        A.[LoanReferenceId],
        A.[TermsAccepted],
        B.[Address],
        B.[Country],
        B.[State],
        B.[City],
        B.[BloodGroup],
        B.[Gender],
        B.[AadharNumber],
        B.[PanNumber],
        B.[Nationality],
        B.[Religion],
        B.[Caste],
        B.[EmergencyContactName],
        B.[EmergencyContactNo],
        B.[MaritalStatus],
        B.[PinCode],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn],
        COUNT(*) OVER () AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [hm].[UserAffiliationMapping] A
    LEFT JOIN [dbo].[UserMaster] B
        ON A.[UserId] = B.[UserId]
    WHERE A.[HospitalId] = ' + CAST(@HospitalId AS NVARCHAR) + '
      AND A.[AffiliationType] LIKE ''%' + ISNULL(@AffiliationType, '') + '%''
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0
      AND B.[IsActive] = 1
      AND B.[IsDeleted] = 0';

    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    SET @SQL = @SQL + '
        OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
        FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;
    ';

    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [hm].[UserAffiliationMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [hm].[UserAffiliationMapping_Update]
(
    @MappingId             INT,
    @UserId                INT = NULL,
    @HospitalId            INT = NULL,
    @AffiliationType       VARCHAR(50) = NULL,
    @Designation           VARCHAR(50) = NULL,
    @IsPrimary             INT = NULL,
    @JoinedOn              DATETIME = NULL,
    @RegistrationNumber    VARCHAR(50)   NULL,  
    @LicensingAuthority    VARCHAR(100)  NULL, 
    @YearOfRegistration    INT           NULL, 
    @RegistrationDate      DATE          NULL, 
    @JoiningDate           DATE          NULL, 
    @ShiftType             VARCHAR(50)   NULL, 
    @VisitType             VARCHAR(50)   NULL, 
    @ReferredBy            VARCHAR(100)  NULL, 
    @SocialLink            VARCHAR(255)  NULL, 
    @Allergies             VARCHAR(255)  NULL,
    @ChronicCondition      VARCHAR(255)  NULL,
    @InsuranceProvider     VARCHAR(255)  NULL,
    @InsurancePolicyNo     VARCHAR(100)  NULL,
    @EmiEligibilityStatus  VARCHAR(50)   NULL,
    @LoanReferenceId       VARCHAR(100)  NULL,
    @TermsAccepted         INT = NULL,
    @OtherDetail1          VARCHAR(50) = NULL,
    @OtherDetail2          VARCHAR(50) = NULL,
    @OtherDetail3          VARCHAR(100) = NULL,
    @OtherDetail4          VARCHAR(100) = NULL,
    @OtherDetail5          VARCHAR(500) = NULL,
    @OtherDetail6          VARCHAR(500) = NULL,
    @Department            VARCHAR(100) = NULL,
    @Specialization        VARCHAR(100) = NULL,
    @Education             VARCHAR(100) = NULL,
    @EmploymentType        VARCHAR(50) = NULL,
    @ConsultationFee       DECIMAL(18,2) = NULL,
    @YearsOfExperience     DECIMAL(18,2) = NULL,
    @IsActive              INT = NULL,
    @IsDeleted             INT = NULL,
    @ActionUser            VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [hm].[UserAffiliationMapping]
    SET
         [UserId]              = @UserId
        ,[HospitalId]          = @HospitalId
        ,[AffiliationType]     = TRIM(@AffiliationType)
        ,[Designation]         = TRIM(@Designation)
        ,[IsPrimary]           = @IsPrimary
        ,[JoinedOn]            = @JoinedOn
        ,[RegistrationNumber]  = TRIM(@RegistrationNumber)
        ,[LicensingAuthority]  = TRIM(@LicensingAuthority)
        ,[YearOfRegistration]  = @YearOfRegistration
        ,[RegistrationDate]    = @RegistrationDate
        ,[JoiningDate]         = @JoiningDate
        ,[ShiftType]           = TRIM(@ShiftType)
        ,[VisitType]           = TRIM(@VisitType)
        ,[ReferredBy]          = TRIM(@ReferredBy)
        ,[SocialLink]          = TRIM(@SocialLink)
        ,[Allergies]           = TRIM(@Allergies)
        ,[ChronicCondition]    = TRIM(@ChronicCondition)
        ,[InsuranceProvider]   = TRIM(@InsuranceProvider)
        ,[InsurancePolicyNo]   = TRIM(@InsurancePolicyNo)
        ,[EmiEligibilityStatus]= TRIM(@EmiEligibilityStatus)
        ,[LoanReferenceId]     = TRIM(@LoanReferenceId)
        ,[TermsAccepted]       = @TermsAccepted
        ,[OtherDetail1]        = TRIM(@OtherDetail1)
        ,[OtherDetail2]        = TRIM(@OtherDetail2)
        ,[OtherDetail3]        = TRIM(@OtherDetail3)
        ,[OtherDetail4]        = TRIM(@OtherDetail4)
        ,[OtherDetail5]        = TRIM(@OtherDetail5)
        ,[OtherDetail6]        = TRIM(@OtherDetail6)
        ,[Department]          = TRIM(@Department)
        ,[Specialization]      = TRIM(@Specialization)
        ,[Education]           = TRIM(@Education)
        ,[EmploymentType]      = TRIM(@EmploymentType)
        ,[ConsultationFee]     = @ConsultationFee
        ,[YearsOfExperience]   = @YearsOfExperience
        ,[IsActive]            = @IsActive
        ,[IsDeleted]           = @IsDeleted
        ,[ModifiedBy]          = TRIM(@ActionUser)
        ,[ModifiedOn]          = GETDATE()
    WHERE [MappingId] = @MappingId;

    -- Return updated record
    SELECT 
        [MappingId],
        [UserId],
        [HospitalId],
        [AffiliationType],
        [Designation],
        [IsPrimary],
        [JoinedOn],
        [RegistrationNumber],
        [LicensingAuthority],
        [YearOfRegistration],
        [RegistrationDate],
        [JoiningDate],
        [ShiftType],
        [VisitType],
        [ReferredBy],
        [SocialLink],
        [Allergies],
        [ChronicCondition],
        [InsuranceProvider],
        [InsurancePolicyNo],
        [EmiEligibilityStatus],
        [LoanReferenceId],
        [TermsAccepted],
        [Department],
        [Specialization],
        [Education],
        [EmploymentType],
        [ConsultationFee],
        [YearsOfExperience],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [hm].[UserAffiliationMapping]
    WHERE [MappingId] = @MappingId
      AND IsActive = 1
      AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [hm].[UserMaster_HospitalPatientPerWeek]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROCEDURE [hm].[UserMaster_HospitalPatientPerWeek]
(
    @HospitalId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @StartOfWeek DATE, @EndOfWeek DATE;

    -- Get current week range (Monday to Sunday)
    SET DATEFIRST 1;
    SET @StartOfWeek = DATEADD(DAY, 1 - DATEPART(WEEKDAY, GETDATE()), CAST(GETDATE() AS DATE));
    SET @EndOfWeek = DATEADD(DAY, 6, @StartOfWeek);

    SELECT 
        LEFT(DATENAME(WEEKDAY, U.CreatedOn), 3) AS [Days],
        CAST(U.CreatedOn AS DATE) AS [Date],
        COUNT(U.UserId) AS [NoPatientsCount]
    FROM [dbo].[UserMaster] U
    WHERE 
        U.IsActive = 1
        AND U.IsDeleted = 0
        AND U.Designation = 'Patient'
        AND U.OtherDetail1 = CAST(@HospitalId AS NVARCHAR(50))
        AND CAST(U.CreatedOn AS DATE) BETWEEN @StartOfWeek AND @EndOfWeek
    GROUP BY CAST(U.CreatedOn AS DATE), DATENAME(WEEKDAY, U.CreatedOn)
    ORDER BY CAST(U.CreatedOn AS DATE);
END;
GO
/****** Object:  StoredProcedure [hm].[usp_AppointmentReminderTrigger]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[usp_AppointmentReminderTrigger]
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Today DATE = CONVERT(DATE, GETDATE());

    -- Step 1: Get today's appointments that do NOT already have a reminder
    IF OBJECT_ID('tempdb..#TodayAppointments') IS NOT NULL
        DROP TABLE #TodayAppointments;

    SELECT 
        A.AppointmentId,
        A.PatientId,
        A.DoctorId,
        A.AppointmentDate,
        A.AppointmentTime,
        CONCAT(ISNULL(P.FirstName, ''), ' ', ISNULL(P.LastName, '')) AS PatientName,
        CONCAT(ISNULL(D.FirstName, ''), ' ', ISNULL(D.LastName, '')) AS DoctorName
    INTO #TodayAppointments
    FROM hm.AppointmentScheduleMaster A
    LEFT JOIN dbo.UserMaster P ON A.PatientId = P.UserId
    LEFT JOIN dbo.UserMaster D ON A.DoctorId = D.UserId
    WHERE CONVERT(DATE, A.AppointmentDate) = @Today
      AND A.IsActive = 1
      AND A.IsDeleted = 0
      AND NOT EXISTS (
          SELECT 1 
          FROM hm.NotificationLog NL
          WHERE NL.AppointmentId = A.AppointmentId
            AND NL.SentStatus = 'Sent'
      );

    -- Step 2: Insert reminder messages
    INSERT INTO hm.NotificationLog (AppointmentId, PatientId, DoctorId, MessageText, SentStatus, CreatedBy, CreatedOn)
    SELECT 
        T.AppointmentId,
        T.PatientId,
        T.DoctorId,
        CONCAT('Dear ', T.PatientName, ', this is a reminder for your appointment with Dr. ',
                T.DoctorName, ' today at ', CONVERT(VARCHAR(5), T.AppointmentTime, 108), '.'),
        'Sent',
        'System',
        GETDATE()
    FROM #TodayAppointments T;

    -- Step 3: Return summary of total reminders sent
    SELECT COUNT(*) AS RemindersSent
    FROM #TodayAppointments;

    PRINT ' Appointment Reminder Trigger completed successfully.';
END;
GO
/****** Object:  StoredProcedure [hm].[usp_AttendanceRollForward]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[usp_AttendanceRollForward]
AS
BEGIN
    SET NOCOUNT ON;

    PRINT ' Starting Attendance Roll-Forward...';

    --  Mark doctors who have appointments today as active
    UPDATE hm.UserAffiliationMapping
    SET IsActive = 1
    WHERE UserId IN (
        SELECT DISTINCT DoctorId
        FROM hm.AppointmentScheduleMaster
        WHERE CONVERT(DATE, AppointmentDate) = CONVERT(DATE, GETDATE())
    );

    PRINT ' Attendance Roll-Forward Completed.';
END;
GO
/****** Object:  StoredProcedure [hm].[usp_AutoQueueRefresh]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[usp_AutoQueueRefresh]
AS
BEGIN
    SET NOCOUNT ON;

    PRINT ' Auto Queue Refresh started...';

    UPDATE hm.AppointmentScheduleMaster
    SET OtherDetail1 = 'Queue refreshed at ' + CONVERT(VARCHAR(19), GETDATE(), 120)
    WHERE CONVERT(DATE, AppointmentDate) = CONVERT(DATE, GETDATE())
          AND IsActive = 1 AND IsDeleted = 0;

    PRINT ' Auto Queue Refresh completed.';
END;
GO
/****** Object:  StoredProcedure [hm].[usp_BedAllocationRefresh]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [hm].[usp_BedAllocationRefresh]
AS
BEGIN
    SET NOCOUNT ON;

    PRINT ' Bed Allocation Refresh started...';

    UPDATE hm.BedMaster
    SET IsAvailable = 1
    WHERE BedId IN (
        SELECT BedId
        FROM hm.InPatientMaster
        WHERE DischargeDate <= GETDATE()
    );

    PRINT ' Bed Allocation Refresh completed.';
END;
GO
/****** Object:  StoredProcedure [hm].[usp_FDInterestPosting]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [hm].[usp_FDInterestPosting]
AS
BEGIN
    SET NOCOUNT ON;

    PRINT ' FD Interest Posting started...';

    -- (Dummy sample)
    INSERT INTO fin.FDInterestLedger (FDId, InterestAmount, PostedOn)
    SELECT FDId, DailyInterest, GETDATE()
    FROM fin.FixedDepositMaster
    WHERE IsActive = 1;

    PRINT ' FD Interest Posting completed.';
END;
GO
/****** Object:  StoredProcedure [hm].[usp_PatientVisitSummary]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[usp_PatientVisitSummary]
AS
BEGIN
    SET NOCOUNT ON;

    PRINT ' Generating Patient Visit Summary...';

    SELECT 
        COUNT(*) AS TotalAppointments,
        SUM(CASE WHEN IsFirstVisit = 1 THEN 1 ELSE 0 END) AS NewPatients
    FROM hm.AppointmentScheduleMaster
    WHERE CONVERT(DATE, AppointmentDate) = CONVERT(DATE, GETDATE())
          AND IsActive = 1 AND IsDeleted = 0;

    PRINT ' Patient Visit Summary Completed.';
END;
GO
/****** Object:  StoredProcedure [hm].[usp_WalletTopupSweep]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [hm].[usp_WalletTopupSweep]
AS
BEGIN
    SET NOCOUNT ON;

    PRINT ' Wallet Top-up Sweep started...';

    -- Dummy example
    UPDATE fin.HealthWallet
    SET Balance = Balance + AutoTopupAmount
    WHERE IsAutoTopupEnabled = 1;

    PRINT ' Wallet Top-up Sweep completed.';
END;
GO
/****** Object:  StoredProcedure [pl].[AccountLedger_GetBalance]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [pl].[AccountLedger_GetBalance]
(
    @AccountId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        AccountId,
        SUM(CASE WHEN TransType = 'CREDIT' THEN Amount ELSE -Amount END) AS Balance
    FROM [pl].[AccountLedger]
    WHERE AccountId = @AccountId
      AND IsDeleted = 0
    GROUP BY AccountId;
END
GO
/****** Object:  StoredProcedure [pl].[AccountLedger_Insert]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[AccountLedger_Insert]
(
    @TransactionId   INT,
    @AccountId       INT,
    @TransType       VARCHAR(10), -- 'DEBIT' or 'CREDIT'
    @Amount          DECIMAL(18,2),
    @CurrencyCode    VARCHAR(10) = 'INR',
    @Remarks         NVARCHAR(255) = NULL,
    @ActionUser      VARCHAR(50) = 'SYSTEM'
)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO [pl].[AccountLedger]
    (
        TransactionId, AccountId, TransType, Amount, CurrencyCode,
        Remarks, CreatedBy, CreatedOn
    )
    VALUES
    (
        @TransactionId, @AccountId, @TransType, @Amount, @CurrencyCode,
        @Remarks, @ActionUser, GETDATE()
    );
END
GO
/****** Object:  StoredProcedure [pl].[AccountLedger_ReadByTransactionId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[AccountLedger_ReadByTransactionId]
(
    @TransactionId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[AccountLedger]
    WHERE TransactionId = @TransactionId
      AND IsDeleted = 0
    ORDER BY EntryDate ASC;
END
GO
/****** Object:  StoredProcedure [pl].[Accounts_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[Accounts_Create]
(
    @OwnerType        VARCHAR(20),
    @AccountType      VARCHAR(20),
    @ModuleName       VARCHAR(50),
    @EntityId         INT,
    @BankName         VARCHAR(100),
    @AccountHolderName VARCHAR(100),
    @AccountNo        VARCHAR(50),
    @IFSC             VARCHAR(20),
    @BranchName       VARCHAR(100),
    @Address          VARCHAR(500),
    @AccountBalance   DECIMAL(18,2) = 0,
    @CurrencyCode     VARCHAR(10) = 'INR',
    @ContactNo        VARCHAR(50),
    @IsDefault        INT = 0,
    @IsVerified       INT = 0,
    @OtherDetail1     VARCHAR(200) = '',
    @OtherDetail2     VARCHAR(200) = '',
    @OtherDetail3     VARCHAR(300) = '',
    @OtherDetail4     VARCHAR(300) = '',
    @OtherDetail5     VARCHAR(500) = '',
    @OtherDetail6     VARCHAR(500) = '',
    @ActionUser       VARCHAR(50) = 'SYSTEM'
)
AS
BEGIN
    SET NOCOUNT ON;
	DECLARE @AccountId INT = 0;

    INSERT INTO [pl].[Accounts]
    (
        OwnerType, AccountType, ModuleName, EntityId, BankName, AccountHolderName,
        AccountNo, IFSC, BranchName, Address, AccountBalance, CurrencyCode,
        ContactNo, IsDefault, IsVerified, OtherDetail1, OtherDetail2, OtherDetail3,
        OtherDetail4, OtherDetail5, OtherDetail6, CreatedBy
    )
    VALUES
    (
        @OwnerType, @AccountType, @ModuleName, @EntityId, @BankName, @AccountHolderName,
        @AccountNo, @IFSC, @BranchName, @Address, @AccountBalance, @CurrencyCode,
        @ContactNo, @IsDefault, @IsVerified, @OtherDetail1, @OtherDetail2, @OtherDetail3,
        @OtherDetail4, @OtherDetail5, @OtherDetail6, @ActionUser
    );

    SET @AccountId = SCOPE_IDENTITY();

	SELECT *
	FROM 
		[pl].[Accounts] 
	WHERE 
		AccountId = @AccountId
END
GO
/****** Object:  StoredProcedure [pl].[Accounts_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[Accounts_Delete]
(
    @AccountId INT,
    @ActionUser VARCHAR(50) = 'SYSTEM'
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[Accounts]
    SET IsDeleted = 1,
        IsActive = 0,
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()
    WHERE AccountId = @AccountId;
END
GO
/****** Object:  StoredProcedure [pl].[Accounts_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[Accounts_ReadAll]
(
    @OwnerType VARCHAR(20) = NULL,
    @AccountType VARCHAR(20) = NULL,
    @EntityId INT = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[Accounts]
    WHERE IsDeleted = 0
      AND (@OwnerType IS NULL OR LTRIM(RTRIM(@OwnerType)) = '' OR OwnerType = @OwnerType)
      AND (@AccountType IS NULL OR LTRIM(RTRIM(@AccountType)) = '' OR AccountType = @AccountType)
      AND (@EntityId IS NULL OR @EntityId = 0 OR EntityId = @EntityId);
END
GO
/****** Object:  StoredProcedure [pl].[Accounts_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[Accounts_ReadById]
(
    @AccountId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[Accounts]
    WHERE AccountId = @AccountId AND IsDeleted = 0;
END
GO
/****** Object:  StoredProcedure [pl].[Accounts_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[Accounts_Update]
(
    @AccountId        INT,
    @OwnerType        VARCHAR(20),
    @AccountType      VARCHAR(20),
    @ModuleName       VARCHAR(50),
    @EntityId         INT,
    @BankName         VARCHAR(100),
    @AccountHolderName VARCHAR(100),
    @AccountNo        VARCHAR(50),
    @IFSC             VARCHAR(20),
    @BranchName       VARCHAR(100),
    @Address          VARCHAR(500),
    @AccountBalance   DECIMAL(18,2) = 0,
    @CurrencyCode     VARCHAR(10) = 'INR',
    @ContactNo        VARCHAR(50),
    @IsDefault        INT = 0,
    @IsVerified       INT = 0,
    @OtherDetail1     VARCHAR(200) = NULL,
    @OtherDetail2     VARCHAR(200) = NULL,
    @OtherDetail3     VARCHAR(300) = NULL,
    @OtherDetail4     VARCHAR(300) = NULL,
    @OtherDetail5     VARCHAR(500) = NULL,
    @OtherDetail6     VARCHAR(500) = NULL,
    @ActionUser       VARCHAR(50) = 'SYSTEM'
)
AS
BEGIN
    SET NOCOUNT ON;

	IF @IsDefault = 1
	BEGIN
		UPDATE [pl].[Accounts]
		SET IsDefault = 0,
			ModifiedBy = @ActionUser,
			ModifiedOn = GETDATE()
		WHERE ModuleName = @ModuleName
			AND EntityId = @EntityId
			AND AccountId <> @AccountId
			AND IsActive = 1;
	END

    UPDATE [pl].[Accounts]
    SET 
        OwnerType        = @OwnerType,
        AccountType      = @AccountType,
        ModuleName       = @ModuleName,
        EntityId         = @EntityId,
        BankName         = @BankName,
        AccountHolderName= @AccountHolderName,
        AccountNo        = @AccountNo,
        IFSC             = @IFSC,
        BranchName       = @BranchName,
        Address          = @Address,
        AccountBalance   = ISNULL(@AccountBalance, AccountBalance),
        CurrencyCode     = ISNULL(@CurrencyCode, CurrencyCode),
        ContactNo        = @ContactNo,
        IsDefault        = ISNULL(@IsDefault, IsDefault),
        IsVerified       = ISNULL(@IsVerified, IsVerified),
        OtherDetail1     = @OtherDetail1,
        OtherDetail2     = @OtherDetail2,
        OtherDetail3     = @OtherDetail3,
        OtherDetail4     = @OtherDetail4,
        OtherDetail5     = @OtherDetail5,
        OtherDetail6     = @OtherDetail6,
        ModifiedBy       = @ActionUser,
        ModifiedOn       = GETDATE()
    WHERE AccountId = @AccountId;

	SELECT *
	FROM 
		[pl].[Accounts] 
	WHERE 
		AccountId = @AccountId
END
GO
/****** Object:  StoredProcedure [pl].[Application_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[Application_Create]
(
    @UserId                     INT = NULL,
    @ProductId                  INT = NULL,
    @ApplicationStatus          VARCHAR(50) = NULL,
    @RequestedAmount            DECIMAL(18,2) = NULL,
    @ApprovedAmount             DECIMAL(18,2) = NULL,
    @TenureMonths               INT = NULL,
    @CreditScore                INT = NULL,
    @ApplicationDate            DATETIME = NULL,
    @ApprovalDate               DATETIME = NULL,
    @ApprovedBy                 VARCHAR(100) = NULL,
    @RejectionReason            VARCHAR(255) = NULL,
    @RejectedBy                 VARCHAR(100) = NULL,
    @IsKYCVerified              INT = NULL,
    @KYCVerifiedOn              DATETIME = NULL,
    @IsDisbursed                INT = NULL,
    @DisbursedOn                DATETIME = NULL,
    @DisbursedAmount            DECIMAL(18,2) = NULL,
    @KycDocId                   INT = NULL,
    @SubUserId                  INT = NULL,
    @BusinessId                 INT = NULL,
    @ProductCode                VARCHAR(50) = NULL,
    @EmployerName               VARCHAR(50) = NULL,
    @Occupation                 VARCHAR(100) = NULL,
    @EmploymentType             VARCHAR(50) = NULL,
    @MinimumNetMonthlyIncome    DECIMAL(18,2) = NULL,
    @IncomeStabilityInMonths    INT = NULL,
    @BankMinimumAverageBalance  DECIMAL(18,2) = NULL,
    @BankMaximumBounceCount     INT = NULL,
    @PRRN                       VARCHAR(50) = NULL,
    @OtherDetail1               VARCHAR(50) = NULL,
    @OtherDetail2               VARCHAR(50) = NULL,
    @OtherDetail3               VARCHAR(100) = NULL,
    @OtherDetail4               VARCHAR(100) = NULL,
    @OtherDetail5               VARCHAR(500) = NULL,
    @OtherDetail6               VARCHAR(500) = NULL,
    @ActionUser                 VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ApplicationId BIGINT;
    DECLARE @ApplicationNumber VARCHAR(20);

    SET @ApplicationNumber = [pl].[GetMaxApplicationNumber]();  

    INSERT INTO [pl].[Application]
    (
        [UserId],
        [SubUserId],
        [BusinessId],
        [ProductId],
        [ProductCode],
        [ApplicationStatus],
        [RequestedAmount],
        [ApprovedAmount],
        [TenureMonths],
        [CreditScore],
        [ApplicationDate],
        [ApprovalDate],
        [ApprovedBy],
        [RejectionReason],
        [RejectedBy],
        [IsKYCVerified],
        [KYCVerifiedOn],
        [IsDisbursed],
        [DisbursedOn],
        [DisbursedAmount],
        [KycDocId],
        [EmployerName],
        [Occupation],
        [EmploymentType],
        [MinimumNetMonthlyIncome],
        [IncomeStabilityInMonths],
        [BankMinimumAverageBalance],
        [BankMaximumBounceCount],
        [PRRN],
        [ApplicationNumber],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @SubUserId,
        @BusinessId,
        @ProductId,
        @ProductCode,
        @ApplicationStatus,
        @RequestedAmount,
        @ApprovedAmount,
        @TenureMonths,
        @CreditScore,
        @ApplicationDate,
        @ApprovalDate,
        @ApprovedBy,
        @RejectionReason,
        @RejectedBy,
        @IsKYCVerified,
        @KYCVerifiedOn,
        @IsDisbursed,
        @DisbursedOn,
        @DisbursedAmount,
        @KycDocId,
        @EmployerName,
        @Occupation,
        @EmploymentType,
        @MinimumNetMonthlyIncome,
        @IncomeStabilityInMonths,
        @BankMinimumAverageBalance,
        @BankMaximumBounceCount,
        @PRRN,
        @ApplicationNumber,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @ApplicationId = SCOPE_IDENTITY();

    SELECT 
        [ApplicationId],
        [UserId],
        [SubUserId],
        [BusinessId],
        [ProductId],
        [ProductCode],
        [ApplicationStatus],
        [RequestedAmount],
        [ApprovedAmount],
        [TenureMonths],
        [CreditScore],
        [ApplicationDate],
        [ApprovalDate],
        [ApprovedBy],
        [RejectionReason],
        [RejectedBy],
        [IsKYCVerified],
        [KYCVerifiedOn],
        [IsDisbursed],
        [DisbursedOn],
        [DisbursedAmount],
        [KycDocId],
        [EmployerName],
        [Occupation],
        [EmploymentType],
        [MinimumNetMonthlyIncome],
        [IncomeStabilityInMonths],
        [BankMinimumAverageBalance],
        [BankMaximumBounceCount],
        [PRRN],
        [ApplicationNumber],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[Application]
    WHERE [ApplicationId] = @ApplicationId;
END;
GO
/****** Object:  StoredProcedure [pl].[Application_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[Application_Delete]
(
    @ApplicationId BIGINT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[Application]
    SET
        [IsDeleted]  = 1,
        [IsActive]   = 0,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE
        [ApplicationId] = @ApplicationId 
END;
GO
/****** Object:  StoredProcedure [pl].[Application_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Application_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
        [ApplicationId],
        [UserId],
        [SubUserId],
        [BusinessId],
        [ProductId],
        [ProductCode],
        [ApplicationStatus],
        [RequestedAmount],
        [ApprovedAmount],
        [TenureMonths],
        [CreditScore],
        [ApplicationDate],
        [ApprovalDate],
        [ApprovedBy],
        [RejectionReason],
        [RejectedBy],
        [IsKYCVerified],
        [KYCVerifiedOn],
        [IsDisbursed],
        [DisbursedOn],
        [DisbursedAmount],
        [KycDocId],
        [EmployerName],
        [Occupation],
        [EmploymentType],
        [MinimumNetMonthlyIncome],
        [IncomeStabilityInMonths],
        [BankMinimumAverageBalance],
        [BankMaximumBounceCount],
		[PRRN],
		[ApplicationNumber],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
	FROM [pl].[Application]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Application_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[Application_ReadAllPaginated]
(
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
    SET NOCOUNT ON; 
    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);
    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + ') AS RowNum,
        A.[ApplicationId],
        A.[UserId],
        B.[FirstName] + '' '' + B.[LastName] AS UserName,
        A.[ProductId],
        A.[ApplicationStatus],
        A.[RequestedAmount],
        A.[ApprovedAmount],
        A.[TenureMonths],
        A.[CreditScore],
        A.[ApplicationDate],
        A.[ApprovalDate],
        A.[ApprovedBy],
        A.[RejectionReason],
        A.[RejectedBy],
        A.[IsKYCVerified],
        A.[KYCVerifiedOn],
        A.[IsDisbursed],
        A.[DisbursedOn],
        A.[DisbursedAmount],
        A.[KycDocId],
        A.[SubUserId],
        C.[FirstName] + '' '' + C.[LastName] AS SubUserName,
        A.[BusinessId],
        COALESCE(SM.BusinessName, HM.BusinessName, SCM.BusinessName, PM.BusinessName) AS BusinessName,
        A.[ProductCode],
        A.[EmployerName],
        A.[Occupation],
        A.[EmploymentType],
        A.[MinimumNetMonthlyIncome],
        A.[IncomeStabilityInMonths],
        A.[BankMinimumAverageBalance],
        A.[BankMaximumBounceCount],
		A.[PRRN],
		A.[ApplicationNumber],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn],
	COUNT(*) OVER () AS TotalCount,
	' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
	' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [pl].[Application] A
    LEFT JOIN [Nishwik].[dbo].[UserMaster] B ON A.[UserId] = B.UserId
    LEFT JOIN [Nishwik].[dbo].[UserMaster] C ON A.[SubUserId] = C.UserId

    OUTER APPLY (
        SELECT S.SchoolName AS BusinessName  
        FROM [Nishwik].[spe].[SchoolMaster] S 
        WHERE S.SchoolId = A.BusinessId AND A.OtherDetail1 = ''School''
    ) SM

    OUTER APPLY (
        SELECT H.HospitalName AS BusinessName  
        FROM [Nishwik].[hm].[HospitalMaster] H 
        WHERE H.HospitalId = A.BusinessId AND A.OtherDetail1 = ''Hospital''
    ) HM

    OUTER APPLY (
        SELECT SC.SocietyName  AS BusinessName  
        FROM [Nishwik].[sm].[Society] SC 
        WHERE SC.[SocietyId]= A.BusinessId AND A.OtherDetail1 = ''Society''
    ) SCM

    OUTER APPLY (
        SELECT P.PropertyName AS BusinessName  
        FROM [Nishwik].[re].[Property] P 
        WHERE P.PropertyId = A.BusinessId AND A.OtherDetail1 = ''Property''
    ) PM

    WHERE A.[IsActive] = 1';

    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    SET @SQL = @SQL + '
    OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [pl].[Application_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Application_ReadByBusinessId]
(
   @BusinessId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ApplicationId]
		,[UserId]
		,[ProductId]
		,[ApplicationStatus]
		,[RequestedAmount]
		,[ApprovedAmount]
		,[TenureMonths]
		,[CreditScore]
		,[ApplicationDate]
		,[ApprovalDate]
		,[ApprovedBy]
		,[RejectionReason]
		,[RejectedBy]
		,[IsKYCVerified]
		,[KYCVerifiedOn]
		,[IsDisbursed]
		,[DisbursedOn]
		,[DisbursedAmount]
		,[KycDocId]
	    ,[SubUserId]
        ,[BusinessId]
        ,[ProductCode]
        ,[EmployerName]
        ,[Occupation]
        ,[EmploymentType]
        ,[MinimumNetMonthlyIncome]
        ,[IncomeStabilityInMonths]
        ,[BankMinimumAverageBalance]
        ,[BankMaximumBounceCount]
		,[PRRN]
		,[ApplicationNumber]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Application]
	WHERE [BusinessId] = @BusinessId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Application_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Application_ReadById]
(
   @ApplicationId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ApplicationId]
		,[UserId]
		,[ProductId]
		,[ApplicationStatus]
		,[RequestedAmount]
		,[ApprovedAmount]
		,[TenureMonths]
		,[CreditScore]
		,[ApplicationDate]
		,[ApprovalDate]
		,[ApprovedBy]
		,[RejectionReason]
		,[RejectedBy]
		,[IsKYCVerified]
		,[KYCVerifiedOn]
		,[IsDisbursed]
		,[DisbursedOn]
		,[DisbursedAmount]
		,[KycDocId]
		,[SubUserId]
        ,[BusinessId]
        ,[ProductCode]
        ,[EmployerName]
        ,[Occupation]
        ,[EmploymentType]
        ,[MinimumNetMonthlyIncome]
        ,[IncomeStabilityInMonths]
        ,[BankMinimumAverageBalance]
        ,[BankMaximumBounceCount]
		,[PRRN]
		,[ApplicationNumber]
	   	,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Application]
	WHERE [ApplicationId] = @ApplicationId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Application_ReadByProductId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Application_ReadByProductId]
(
   @ProductId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ApplicationId]
		,[UserId]
		,[ProductId]
		,[ApplicationStatus]
		,[RequestedAmount]
		,[ApprovedAmount]
		,[TenureMonths]
		,[CreditScore]
		,[ApplicationDate]
		,[ApprovalDate]
		,[ApprovedBy]
		,[RejectionReason]
		,[RejectedBy]
		,[IsKYCVerified]
		,[KYCVerifiedOn]
		,[IsDisbursed]
		,[DisbursedOn]
		,[DisbursedAmount]
		,[KycDocId]
		,[SubUserId]
        ,[BusinessId]
        ,[ProductCode]
        ,[EmployerName]
        ,[Occupation]
        ,[EmploymentType]
        ,[MinimumNetMonthlyIncome]
        ,[IncomeStabilityInMonths]
        ,[BankMinimumAverageBalance]
        ,[BankMaximumBounceCount]
		,[PRRN]
		,[ApplicationNumber]
	   	,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Application]
	WHERE [ProductId] = @ProductId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Application_ReadBySubUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Application_ReadBySubUserId]
(
   @SubUserId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ApplicationId]
		,[UserId]
		,[ProductId]
		,[ApplicationStatus]
		,[RequestedAmount]
		,[ApprovedAmount]
		,[TenureMonths]
		,[CreditScore]
		,[ApplicationDate]
		,[ApprovalDate]
		,[ApprovedBy]
		,[RejectionReason]
		,[RejectedBy]
		,[IsKYCVerified]
		,[KYCVerifiedOn]
		,[IsDisbursed]
		,[DisbursedOn]
		,[DisbursedAmount]
		,[KycDocId]
	    ,[SubUserId]
        ,[BusinessId]
        ,[ProductCode]
        ,[EmployerName]
        ,[Occupation]
        ,[EmploymentType]
        ,[MinimumNetMonthlyIncome]
        ,[IncomeStabilityInMonths]
        ,[BankMinimumAverageBalance]
        ,[BankMaximumBounceCount]
	    ,[PRRN]
		,[ApplicationNumber]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Application]
	WHERE [SubUserId] = @SubUserId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Application_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Application_ReadByUserId]
(
   @UserId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ApplicationId]
		,[UserId]
		,[ProductId]
		,[ApplicationStatus]
		,[RequestedAmount]
		,[ApprovedAmount]
		,[TenureMonths]
		,[CreditScore]
		,[ApplicationDate]
		,[ApprovalDate]
		,[ApprovedBy]
		,[RejectionReason]
		,[RejectedBy]
		,[IsKYCVerified]
		,[KYCVerifiedOn]
		,[IsDisbursed]
		,[DisbursedOn]
		,[DisbursedAmount]
		,[KycDocId]
	    ,[SubUserId]
        ,[BusinessId]
        ,[ProductCode]
        ,[EmployerName]
        ,[Occupation]
        ,[EmploymentType]
        ,[MinimumNetMonthlyIncome]
        ,[IncomeStabilityInMonths]
        ,[BankMinimumAverageBalance]
        ,[BankMaximumBounceCount]
		,[PRRN]
		,[ApplicationNumber]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Application]
	WHERE [UserId] = @UserId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Application_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[Application_Update]
(
    @ApplicationId             BIGINT,
    @UserId                    INT,
    @SubUserId                 INT,
    @BusinessId                INT,
    @ProductId                 INT,
    @ProductCode               VARCHAR(50),
    @ApplicationStatus         VARCHAR(50),
    @RequestedAmount           DECIMAL(18,2),
    @ApprovedAmount            DECIMAL(5,2),
    @TenureMonths              INT,
    @CreditScore               INT,
    @ApplicationDate           DATETIME,
    @ApprovalDate              DATETIME,
    @ApprovedBy                VARCHAR(100),
    @RejectionReason           VARCHAR(255),
    @RejectedBy                VARCHAR(100),
    @IsKYCVerified             INT,
    @KYCVerifiedOn             DATETIME,
    @IsDisbursed               INT,
    @DisbursedOn               DATETIME,
    @DisbursedAmount           DECIMAL(18,2),
    @KycDocId                  INT,
    @EmployerName              VARCHAR(50),
    @Occupation                VARCHAR(100),
    @EmploymentType            VARCHAR(50),
    @MinimumNetMonthlyIncome   DECIMAL(18,2),
    @IncomeStabilityInMonths   INT,
    @BankMinimumAverageBalance DECIMAL(18,2),
    @BankMaximumBounceCount    INT,
	@PRRN                       VARCHAR(50),
	@ApplicationNumber          VARCHAR(50),
    @OtherDetail1              VARCHAR(50),
    @OtherDetail2              VARCHAR(50),
    @OtherDetail3              VARCHAR(100),
    @OtherDetail4              VARCHAR(100),
    @OtherDetail5              VARCHAR(500),
    @OtherDetail6              VARCHAR(500),
    @IsActive                  INT,
    @ActionUser                VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[Application]
    SET
        [UserId]                  = @UserId,
        [SubUserId]               = @SubUserId,
        [BusinessId]              = @BusinessId,
        [ProductId]               = @ProductId,
        [ProductCode]             = @ProductCode,
        [ApplicationStatus]       = @ApplicationStatus,
        [RequestedAmount]         = @RequestedAmount,
        [ApprovedAmount]          = @ApprovedAmount,
        [TenureMonths]            = @TenureMonths,
        [CreditScore]             = @CreditScore,
        [ApplicationDate]         = @ApplicationDate,
        [ApprovalDate]            = @ApprovalDate,
        [ApprovedBy]              = @ApprovedBy,
        [RejectionReason]         = @RejectionReason,
        [RejectedBy]              = @RejectedBy,
        [IsKYCVerified]           = @IsKYCVerified,
        [KYCVerifiedOn]           = @KYCVerifiedOn,
        [IsDisbursed]             = @IsDisbursed,
        [DisbursedOn]             = @DisbursedOn,
        [DisbursedAmount]         = @DisbursedAmount,
        [KycDocId]                = @KycDocId,
        [EmployerName]            = @EmployerName,
        [Occupation]              = @Occupation,
        [EmploymentType]          = @EmploymentType,
        [MinimumNetMonthlyIncome] = @MinimumNetMonthlyIncome,
        [IncomeStabilityInMonths] = @IncomeStabilityInMonths,
        [BankMinimumAverageBalance] = @BankMinimumAverageBalance,
        [BankMaximumBounceCount]    = @BankMaximumBounceCount,
		[PRRN]                      = @PRRN,
		[ApplicationNumber]         = @ApplicationNumber,
        [OtherDetail1]            = @OtherDetail1,
        [OtherDetail2]            = @OtherDetail2,
        [OtherDetail3]            = @OtherDetail3,
        [OtherDetail4]            = @OtherDetail4,
        [OtherDetail5]            = @OtherDetail5,
        [OtherDetail6]            = @OtherDetail6,
        [IsActive]                = @IsActive,
        [ModifiedBy]              = @ActionUser,
        [ModifiedOn]              = GETDATE()
    WHERE [ApplicationId] = @ApplicationId;

    SELECT 
        [ApplicationId],
        [UserId],
        [SubUserId],
        [BusinessId],
        [ProductId],
        [ProductCode],
        [ApplicationStatus],
        [RequestedAmount],
        [ApprovedAmount],
        [TenureMonths],
        [CreditScore],
        [ApplicationDate],
        [ApprovalDate],
        [ApprovedBy],
        [RejectionReason],
        [RejectedBy],
        [IsKYCVerified],
        [KYCVerifiedOn],
        [IsDisbursed],
        [DisbursedOn],
        [DisbursedAmount],
        [KycDocId],
        [EmployerName],
        [Occupation],
        [EmploymentType],
        [MinimumNetMonthlyIncome],
        [IncomeStabilityInMonths],
        [BankMinimumAverageBalance],
        [BankMaximumBounceCount],
		[PRRN],
		[ApplicationNumber],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[Application]
    WHERE [ApplicationId] = @ApplicationId
      AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[CreditEngineConfiguration_Create]
(
    @MasterId INT,
    @MasterType VARCHAR(50),
    @AgeFrom INT,
    @AgeTo INT,
    @OccupationType VARCHAR(50),
    @Weightage DECIMAL(5,2),
    @MinimumNetMonthlyIncome DECIMAL(12,2),
    @IncomeStabilityInMonths INT,
    @BankMinimumAverageBalance DECIMAL(12,2),
    @BankMaximumBounceCount INT,
    @FOIR DECIMAL(5,2),
    @MaximumLoanTenureInMonths INT,
    @BaseInterestRate DECIMAL(5,2),
    @RiskVariance DECIMAL(5,2),
    @MinimumLoanAmount DECIMAL(15,2),
    @MaximumLoanAmount DECIMAL(15,2),
	@ExistingEmiAmount DECIMAL(18,2),
	@ResidenceType VARCHAR(50),
	@MonthsAtCurrentAddress VARCHAR(50),
	@AddressRisk VARCHAR(50),
	@ITR26ASAvailable INT,
	@EmploymentType VARCHAR(50),
	@ProductCode VARCHAR(50),
	@CreditScore INT = NULL,
    @Dpd12M INT = NULL,
    @ActiveLoans INT = NULL,
    @SimAgeMonths INT = NULL,
    @GeoPinRiskIndex DECIMAL(5,2) = NULL,
    @SchoolPaymentHistoryScore DECIMAL(5,2) = NULL,
    @VaultBalanceAverage DECIMAL(15,2) = NULL,
    @IncomeTruthIndex DECIMAL(4,2) = NULL,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @ConfigId INT;

    INSERT INTO [pl].[CreditEngineConfiguration]
    (
        [MasterId],
        [MasterType],
        [AgeFrom],
        [AgeTo],
        [OccupationType],
        [Weightage],
        [MinimumNetMonthlyIncome],
        [IncomeStabilityInMonths],
        [BankMinimumAverageBalance],
        [BankMaximumBounceCount],
        [FOIR],
        [MaximumLoanTenureInMonths],
        [BaseInterestRate],
        [RiskVariance],
        [MinimumLoanAmount],
        [MaximumLoanAmount],
		[ExistingEmiAmount],
        [ResidenceType],
        [MonthsAtCurrentAddress],
        [AddressRisk],
        [ITR26ASAvailable],
		[EmploymentType],
		[ProductCode],
		[CreditScore],
        [Dpd12M],
        [ActiveLoans],
        [SimAgeMonths],
        [GeoPinRiskIndex],
        [SchoolPaymentHistoryScore],
        [VaultBalanceAverage],
        [IncomeTruthIndex],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterId,
        @MasterType,
        @AgeFrom,
        @AgeTo,
        @OccupationType,
        @Weightage,
        @MinimumNetMonthlyIncome,
        @IncomeStabilityInMonths,
        @BankMinimumAverageBalance,
        @BankMaximumBounceCount,
        @FOIR,
        @MaximumLoanTenureInMonths,
        @BaseInterestRate,
        @RiskVariance,
        @MinimumLoanAmount,
        @MaximumLoanAmount,
		@ExistingEmiAmount,
		@ResidenceType,
		@MonthsAtCurrentAddress,
		@AddressRisk,
		@ITR26ASAvailable,
		@EmploymentType,
		@ProductCode,
	    @CreditScore,
        @Dpd12M,
        @ActiveLoans,
        @SimAgeMonths,
        @GeoPinRiskIndex,
        @SchoolPaymentHistoryScore,
        @VaultBalanceAverage,
        @IncomeTruthIndex,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,        -- IsActive
        0,        -- IsDeleted
        @ActionUser,
        GETDATE()
    );

    SET @ConfigId = SCOPE_IDENTITY();

    SELECT 
         [ConfigId],
         [MasterId],
         [MasterType],
         [AgeFrom],
         [AgeTo],
         [OccupationType],
         [Weightage],
         [MinimumNetMonthlyIncome],
         [IncomeStabilityInMonths],
         [BankMinimumAverageBalance],
         [BankMaximumBounceCount],
         [FOIR],
         [MaximumLoanTenureInMonths],
         [BaseInterestRate],
         [RiskVariance],
         [MinimumLoanAmount],
         [MaximumLoanAmount],
		 [ExistingEmiAmount],
         [ResidenceType],
         [MonthsAtCurrentAddress],
         [AddressRisk],
         [ITR26ASAvailable],
		 [EmploymentType],
		 [ProductCode],
		 [CreditScore],
         [Dpd12M],
         [ActiveLoans],
         [SimAgeMonths],
         [GeoPinRiskIndex],
         [SchoolPaymentHistoryScore],
         [VaultBalanceAverage],
         [IncomeTruthIndex],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [pl].[CreditEngineConfiguration]
    WHERE [ConfigId] = @ConfigId;
END;
GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[CreditEngineConfiguration_CreateBulk]
(
   @ConfigIdList [pl].[udt_CreditEngineConfiguration] READONLY,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN 
    SET NOCOUNT ON;
	INSERT INTO [pl].[CreditEngineConfiguration]
	(
	   [MasterId]
      ,[MasterType]
      ,[AgeFrom]
      ,[AgeTo]
      ,[OccupationType]
      ,[Weightage]
      ,[MinimumNetMonthlyIncome]
      ,[IncomeStabilityInMonths]
      ,[BankMinimumAverageBalance]
      ,[BankMaximumBounceCount]
      ,[FOIR]
      ,[MaximumLoanTenureInMonths]
      ,[BaseInterestRate]
      ,[RiskVariance]
      ,[MinimumLoanAmount]
      ,[MaximumLoanAmount]
	  ,[ExistingEmiAmount]
      ,[ResidenceType]
      ,[MonthsAtCurrentAddress]
      ,[AddressRisk]
      ,[ITR26ASAvailable]
      ,[EmploymentType]
      ,[ProductCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
	)
	SELECT 
	   [MasterId]
      ,[MasterType]
      ,[AgeFrom]
      ,[AgeTo]
      ,[OccupationType]
      ,[Weightage]
      ,[MinimumNetMonthlyIncome]
      ,[IncomeStabilityInMonths]
      ,[BankMinimumAverageBalance]
      ,[BankMaximumBounceCount]
      ,[FOIR]
      ,[MaximumLoanTenureInMonths]
      ,[BaseInterestRate]
      ,[RiskVariance]
      ,[MinimumLoanAmount]
      ,[MaximumLoanAmount]
	  ,[ExistingEmiAmount]
      ,[ResidenceType]
      ,[MonthsAtCurrentAddress]
      ,[AddressRisk]
      ,[ITR26ASAvailable]
      ,[EmploymentType]
      ,[ProductCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
	  ,1
	  ,0
	  ,@ActionUser 
	  ,GETDATE()
	 FROM   @ConfigIdList ;
	  SELECT
	   [ConfigId]
      ,[MasterId]
      ,[MasterType]
      ,[AgeFrom]
      ,[AgeTo]
      ,[OccupationType]
      ,[Weightage]
      ,[MinimumNetMonthlyIncome]
      ,[IncomeStabilityInMonths]
      ,[BankMinimumAverageBalance]
      ,[BankMaximumBounceCount]
      ,[FOIR]
      ,[MaximumLoanTenureInMonths]
      ,[BaseInterestRate]
      ,[RiskVariance]
      ,[MinimumLoanAmount]
      ,[MaximumLoanAmount]
	  ,[ExistingEmiAmount]
      ,[ResidenceType]
      ,[MonthsAtCurrentAddress]
      ,[AddressRisk]
      ,[ITR26ASAvailable]
      ,[EmploymentType]
      ,[ProductCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [Nishwik].[pl].[CreditEngineConfiguration]
     WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;

GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[CreditEngineConfiguration_Delete]
(
   @ConfigId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [pl].[CreditEngineConfiguration]
	SET
		[IsActive] = 0,
		[IsDeleted] =1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = getdate()
	WHERE [ConfigId] = @ConfigId
END;
GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_GetByLoanEligibilityCriteria]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
EXEC [pl].[CreditEngineConfiguration_GetByLoanEligibilityCriteria]
     @MasterType = 'CreditScore',
     @OccupationType = NULL,
     @MinimumNetMonthlyIncome = NULL,
     @IncomeStabilityInMonths = NULL,
     @BankMinimumAverageBalance = NULL,
     @BankMaximumBounceCount = NULL,
     @FOIR = NULL,
     @AgeTo = NULL,
     @LoanAmount = NULL,
     @CreditScore = 750,
     @Dpd12M = 10,
     @ActiveLoans = NULL,
     @SimAgeMonths = 12,
     @GeoPinRiskIndex = NULL,
     @SchoolPaymentHistoryScore = NULL,
     @VaultBalanceAverage = NULL,
     @IncomeTruthIndex = NULL,
     @ResidenceType = 'Owned',
     @MonthsAtCurrentAddress = NULL;


*/

CREATE PROCEDURE [pl].[CreditEngineConfiguration_GetByLoanEligibilityCriteria]
(
    @MasterType                VARCHAR(50)  = NULL,
    @OccupationType            VARCHAR(50)  = NULL,
    @MinimumNetMonthlyIncome   DECIMAL(12,2) = NULL,
    @IncomeStabilityInMonths   INT           = NULL,
    @BankMinimumAverageBalance DECIMAL(12,2) = NULL,
    @BankMaximumBounceCount    INT           = NULL,
    @FOIR                      DECIMAL(5,2)   = NULL,
    @AgeTo                     INT           = NULL,
    @LoanAmount                DECIMAL(12,2) = NULL,
    @CreditScore               INT           = NULL,
    @Dpd12M                    INT           = NULL,
    @ActiveLoans               INT           = NULL,
    @SimAgeMonths              INT           = NULL,
    @GeoPinRiskIndex           DECIMAL(5,2)  = NULL,
    @SchoolPaymentHistoryScore DECIMAL(5,2)  = NULL,
    @VaultBalanceAverage       DECIMAL(12,2) = NULL,
    @IncomeTruthIndex          DECIMAL(5,2)  = NULL,
    @ResidenceType             VARCHAR(50)  = NULL,
    @MonthsAtCurrentAddress    INT           = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
         A.[ConfigId]
        ,A.[MasterId]
        ,A.[MasterType]
        ,A.[AgeFrom]
        ,A.[AgeTo]
        ,A.[OccupationType]
        ,A.[Weightage]
        ,A.[MinimumNetMonthlyIncome]
        ,A.[IncomeStabilityInMonths]
        ,A.[BankMinimumAverageBalance]
        ,A.[BankMaximumBounceCount]
        ,A.[FOIR]
        ,A.[MaximumLoanTenureInMonths]
        ,A.[BaseInterestRate]
        ,A.[RiskVariance]
        ,A.[MinimumLoanAmount]
        ,A.[MaximumLoanAmount]
        ,A.[CreditScore]
        ,A.[Dpd12M]
        ,A.[ActiveLoans]
        ,A.[SimAgeMonths]
        ,A.[GeoPinRiskIndex]
        ,A.[SchoolPaymentHistoryScore]
        ,A.[VaultBalanceAverage]
        ,A.[IncomeTruthIndex]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
        ,A.[ExistingEmiAmount]
        ,A.[ResidenceType]
        ,A.[MonthsAtCurrentAddress]
        ,A.[AddressRisk]
        ,A.[ITR26ASAvailable]
        ,A.[EmploymentType]
        ,A.[ProductCode]
        ,B.[MinTenureMonths]
        ,B.[MaxTenureMonths]
        ,CASE 
            WHEN B.[ProductCode] IS NOT NULL THEN 'Matched'
            ELSE 'Not Matched'
         END AS ProductStatus
    FROM [pl].[CreditEngineConfiguration] A
    LEFT JOIN [pl].[Product] B
        ON A.[ProductCode] = B.[ProductCode]
        AND B.[IsActive] = 1
        AND B.[IsDeleted] = 0
    WHERE A.[IsActive] = 1
      AND A.[IsDeleted] = 0

      AND (
            (@MasterType IS NULL AND A.[MasterType] IS NULL)
            OR (@MasterType IS NOT NULL AND A.[MasterType] = @MasterType)
          )
      AND (
            (@OccupationType IS NULL AND A.[OccupationType] IS NULL)
            OR (@OccupationType IS NOT NULL AND A.[OccupationType] = @OccupationType)
          )
      AND (
            (@MinimumNetMonthlyIncome IS NULL AND A.[MinimumNetMonthlyIncome] IS NULL)
            OR (@MinimumNetMonthlyIncome IS NOT NULL AND A.[MinimumNetMonthlyIncome] = @MinimumNetMonthlyIncome)
          )
      AND (
            (@IncomeStabilityInMonths IS NULL AND A.[IncomeStabilityInMonths] IS NULL)
            OR (@IncomeStabilityInMonths IS NOT NULL AND A.[IncomeStabilityInMonths] = @IncomeStabilityInMonths)
          )
      AND (
            (@BankMinimumAverageBalance IS NULL AND A.[BankMinimumAverageBalance] IS NULL)
            OR (@BankMinimumAverageBalance IS NOT NULL AND A.[BankMinimumAverageBalance] = @BankMinimumAverageBalance)
          )
      AND (
            (@BankMaximumBounceCount IS NULL AND A.[BankMaximumBounceCount] IS NULL)
            OR (@BankMaximumBounceCount IS NOT NULL AND A.[BankMaximumBounceCount] = @BankMaximumBounceCount)
          )
      AND (
            (@FOIR IS NULL AND A.[FOIR] IS NULL)
            OR (@FOIR IS NOT NULL AND A.[FOIR] = @FOIR)
          )
      AND (
            @AgeTo IS NULL 
            OR (
                A.[AgeFrom] IS NOT NULL 
                AND A.[AgeTo] IS NOT NULL 
                AND @AgeTo BETWEEN A.[AgeFrom] AND A.[AgeTo]
            )
          )
      AND (
            @LoanAmount IS NULL 
            OR (@LoanAmount BETWEEN A.[MinimumLoanAmount] AND A.[MaximumLoanAmount])
          )
      AND (
            (@CreditScore IS NULL AND A.[CreditScore] IS NULL)
            OR (@CreditScore IS NOT NULL AND A.[CreditScore] = @CreditScore)
          )
      AND (
            (@Dpd12M IS NULL AND A.[Dpd12M] IS NULL)
            OR (@Dpd12M IS NOT NULL AND A.[Dpd12M] = @Dpd12M)
          )
      AND (
            (@ActiveLoans IS NULL AND A.[ActiveLoans] IS NULL)
            OR (@ActiveLoans IS NOT NULL AND A.[ActiveLoans] = @ActiveLoans)
          )
      AND (
            (@SimAgeMonths IS NULL AND A.[SimAgeMonths] IS NULL)
            OR (@SimAgeMonths IS NOT NULL AND A.[SimAgeMonths] = @SimAgeMonths)
          )
      AND (
            (@GeoPinRiskIndex IS NULL AND A.[GeoPinRiskIndex] IS NULL)
            OR (@GeoPinRiskIndex IS NOT NULL AND A.[GeoPinRiskIndex] = @GeoPinRiskIndex)
          )
      AND (
            (@SchoolPaymentHistoryScore IS NULL AND A.[SchoolPaymentHistoryScore] IS NULL)
            OR (@SchoolPaymentHistoryScore IS NOT NULL AND A.[SchoolPaymentHistoryScore] = @SchoolPaymentHistoryScore)
          )
      AND (
            (@VaultBalanceAverage IS NULL AND A.[VaultBalanceAverage] IS NULL)
            OR (@VaultBalanceAverage IS NOT NULL AND A.[VaultBalanceAverage] = @VaultBalanceAverage)
          )
      AND (
            (@IncomeTruthIndex IS NULL AND A.[IncomeTruthIndex] IS NULL)
            OR (@IncomeTruthIndex IS NOT NULL AND A.[IncomeTruthIndex] = @IncomeTruthIndex)
          )
      AND (
            (@ResidenceType IS NULL AND A.[ResidenceType] IS NULL)
            OR (@ResidenceType IS NOT NULL AND A.[ResidenceType] = @ResidenceType)
          )
      AND (
            (@MonthsAtCurrentAddress IS NULL AND A.[MonthsAtCurrentAddress] IS NULL)
            OR (@MonthsAtCurrentAddress IS NOT NULL AND A.[MonthsAtCurrentAddress] = @MonthsAtCurrentAddress)
          )

    ORDER BY A.[BaseInterestRate] ASC, A.[RiskVariance] ASC;
END

GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[CreditEngineConfiguration_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ConfigId]
      ,[MasterId]
      ,[MasterType]
      ,[AgeFrom]
      ,[AgeTo]
      ,[OccupationType]
      ,[Weightage]
      ,[MinimumNetMonthlyIncome]
      ,[IncomeStabilityInMonths]
      ,[BankMinimumAverageBalance]
      ,[BankMaximumBounceCount]
      ,[FOIR]
      ,[MaximumLoanTenureInMonths]
      ,[BaseInterestRate]
      ,[RiskVariance]
      ,[MinimumLoanAmount]
      ,[MaximumLoanAmount]
	  ,[ExistingEmiAmount]
      ,[ResidenceType]
      ,[MonthsAtCurrentAddress]
      ,[AddressRisk]
      ,[ITR26ASAvailable]
	  ,[EmploymentType]
	  ,[ProductCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [pl].[CreditEngineConfiguration]
	WHERE [IsActive] = 1
END;
GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_ReadAllPaginated]    Script Date: 9/25/2025 5:25:12 PM ******/
/*
USE [Nishwik];
GO

EXEC [pl].[CreditEngineConfiguration_ReadAllPaginated]
    @PageSize = 10,               -- Number of rows per page
    @PageNo = 1,                  -- Page number to fetch
    @OrderByClause = '',  -- Optional: column(s) to order by
    @WhereClause = '';  -- Optional: any additional filter


*/
CREATE PROCEDURE [pl].[CreditEngineConfiguration_ReadAllPaginated]
(
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
 BEGIN 
	SET NOCOUNT ON;
	DECLARE @Result INT= 0;
	SET @Result =(@PageNo-1)*@PageSize;
	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL='
	SELECT 
	  ROW_NUMBER() OVER (ORDER BY ' +
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + ') AS RowNum,
	   A.[ConfigId],
       A.[MasterId],
       A.[MasterType],
       A.[AgeFrom],
       A.[AgeTo],
       A.[OccupationType],
       A.[Weightage],
       A.[MinimumNetMonthlyIncome],
       A.[IncomeStabilityInMonths],
       A.[BankMinimumAverageBalance],
       A.[BankMaximumBounceCount],
       A.[FOIR],
       A.[MaximumLoanTenureInMonths],
       A.[BaseInterestRate],
       A.[RiskVariance],
       A.[MinimumLoanAmount],
       A.[MaximumLoanAmount],
	   A.[ExistingEmiAmount],
       A.[ResidenceType],
       A.[MonthsAtCurrentAddress],
       A.[AddressRisk],
       A.[ITR26ASAvailable],
	   A.[EmploymentType],
	   A.[ProductCode],
	   A.[CreditScore],
	   A.[Dpd12M],
	   A.[ActiveLoans],
	   A.[SimAgeMonths],
	   A.[GeoPinRiskIndex],
	   A.[SchoolPaymentHistoryScore],
	   A.[VaultBalanceAverage],
	   A.[IncomeTruthIndex],
       A.[OtherDetail1],
       A.[OtherDetail2],
       A.[OtherDetail3],
       A.[OtherDetail4],
       A.[OtherDetail5],
       A.[OtherDetail6],
       A.[IsActive],
       A.[IsDeleted],
       A.[CreatedBy],
       A.[CreatedOn],
       A.[ModifiedBy],
       A.[ModifiedOn],
	   B.[MinTenureMonths],
       B.[MaxTenureMonths],
			COUNT(*) OVER () AS TotalCount,
	' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
	' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [pl].[CreditEngineConfiguration] A
    LEFT OUTER JOIN [pl].[Product] B
        ON A.[ProductCode] = B.[ProductCode]
    WHERE A.[IsActive] = 1
      AND A.[IsDeleted] = 0';

	 IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    SET @SQL = @SQL + '
    OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL; -- optional for debugging

    EXEC sp_executesql @SQL;

END;
GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[CreditEngineConfiguration_ReadById]
(
   @ConfigId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ConfigId]
      ,[MasterId]
      ,[MasterType]
      ,[AgeFrom]
      ,[AgeTo]
      ,[OccupationType]
      ,[Weightage]
      ,[MinimumNetMonthlyIncome]
      ,[IncomeStabilityInMonths]
      ,[BankMinimumAverageBalance]
      ,[BankMaximumBounceCount]
      ,[FOIR]
      ,[MaximumLoanTenureInMonths]
      ,[BaseInterestRate]
      ,[RiskVariance]
      ,[MinimumLoanAmount]
      ,[MaximumLoanAmount]
	  ,[ExistingEmiAmount]
      ,[ResidenceType]
      ,[MonthsAtCurrentAddress]
      ,[AddressRisk]
      ,[ITR26ASAvailable]
	  ,[EmploymentType]
	  ,[ProductCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [pl].[CreditEngineConfiguration]
	WHERE [ConfigId] = @ConfigId
	AND [IsActive] = 1;
END;

GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[CreditEngineConfiguration_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ConfigId]
      ,[MasterId]
      ,[MasterType]
      ,[AgeFrom]
      ,[AgeTo]
      ,[OccupationType]
      ,[Weightage]
      ,[MinimumNetMonthlyIncome]
      ,[IncomeStabilityInMonths]
      ,[BankMinimumAverageBalance]
      ,[BankMaximumBounceCount]
      ,[FOIR]
      ,[MaximumLoanTenureInMonths]
      ,[BaseInterestRate]
      ,[RiskVariance]
      ,[MinimumLoanAmount]
      ,[MaximumLoanAmount]
	  ,[ExistingEmiAmount]
      ,[ResidenceType]
      ,[MonthsAtCurrentAddress]
      ,[AddressRisk]
      ,[ITR26ASAvailable]
	  ,[EmploymentType]
	  ,[ProductCode]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [pl].[CreditEngineConfiguration]
	WHERE [MasterId] = @MasterId AND  
	[MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;

GO
/****** Object:  StoredProcedure [pl].[CreditEngineConfiguration_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[CreditEngineConfiguration_Update]
(
    @ConfigId INT,
	@MasterId INT,
    @MasterType VARCHAR(50),
    @AgeFrom INT,
    @AgeTo INT,
    @OccupationType VARCHAR(50),
    @Weightage DECIMAL(5,2),
    @MinimumNetMonthlyIncome DECIMAL(12,2),
    @IncomeStabilityInMonths INT,
    @BankMinimumAverageBalance DECIMAL(12,2),
    @BankMaximumBounceCount INT,
    @FOIR DECIMAL(5,2),
    @MaximumLoanTenureInMonths INT,
    @BaseInterestRate DECIMAL(5,2),
    @RiskVariance DECIMAL(5,2),
    @MinimumLoanAmount DECIMAL(15,2),
    @MaximumLoanAmount DECIMAL(15,2),
    @ExistingEmiAmount DECIMAL(18,2),
	@ResidenceType VARCHAR(50),
	@MonthsAtCurrentAddress VARCHAR(50),
	@AddressRisk VARCHAR(50),
	@ITR26ASAvailable INT,
	@EmploymentType VARCHAR(50),
	@ProductCode VARCHAR(50),
	@CreditScore INT = NULL,
    @Dpd12M INT = NULL,
    @ActiveLoans INT = NULL,
    @SimAgeMonths INT = NULL,
    @GeoPinRiskIndex DECIMAL(5,2) = NULL,
    @SchoolPaymentHistoryScore DECIMAL(5,2) = NULL,
    @VaultBalanceAverage DECIMAL(15,2) = NULL,
    @IncomeTruthIndex DECIMAL(4,2) = NULL,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[CreditEngineConfiguration]
    SET
         [MasterId] = @MasterId,
         [MasterType] = @MasterType,
         [AgeFrom] = @AgeFrom,
         [AgeTo] = @AgeTo,
         [OccupationType] = @OccupationType,
         [Weightage] = @Weightage,
         [MinimumNetMonthlyIncome] = @MinimumNetMonthlyIncome,
         [IncomeStabilityInMonths] = @IncomeStabilityInMonths,
         [BankMinimumAverageBalance] = @BankMinimumAverageBalance,
         [BankMaximumBounceCount] = @BankMaximumBounceCount,
         [FOIR] = @FOIR,
         [MaximumLoanTenureInMonths] = @MaximumLoanTenureInMonths,
         [BaseInterestRate] = @BaseInterestRate,
         [RiskVariance] = @RiskVariance,
         [MinimumLoanAmount] = @MinimumLoanAmount,
         [MaximumLoanAmount] = @MaximumLoanAmount,
		 [ExistingEmiAmount] = @ExistingEmiAmount,
         [ResidenceType] = @ResidenceType,
         [MonthsAtCurrentAddress] = @MonthsAtCurrentAddress,
         [AddressRisk] = @AddressRisk,
         [ITR26ASAvailable] = @ITR26ASAvailable,
		 [EmploymentType] = @EmploymentType,
		 [ProductCode] = @ProductCode,
		 [CreditScore] = @CreditScore,
         [Dpd12M] = @Dpd12M,
         [ActiveLoans] = @ActiveLoans,
         [SimAgeMonths] = @SimAgeMonths,
         [GeoPinRiskIndex] = @GeoPinRiskIndex,
         [SchoolPaymentHistoryScore] = @SchoolPaymentHistoryScore,
         [VaultBalanceAverage] = @VaultBalanceAverage,
         [IncomeTruthIndex] = @IncomeTruthIndex,
         [OtherDetail1] = @OtherDetail1,
         [OtherDetail2] = @OtherDetail2,
         [OtherDetail3] = @OtherDetail3,
         [OtherDetail4] = @OtherDetail4,
         [OtherDetail5] = @OtherDetail5,
         [OtherDetail6] = @OtherDetail6,
         [IsActive] = @IsActive,
         [ModifiedBy] = @ActionUser,
         [ModifiedOn] = GETDATE()
    WHERE [ConfigId] = @ConfigId;

    SELECT 
         [ConfigId],
         [MasterId],
         [MasterType],
         [AgeFrom],
         [AgeTo],
         [OccupationType],
         [Weightage],
         [MinimumNetMonthlyIncome],
         [IncomeStabilityInMonths],
         [BankMinimumAverageBalance],
         [BankMaximumBounceCount],
         [FOIR],
         [MaximumLoanTenureInMonths],
         [BaseInterestRate],
         [RiskVariance],
         [MinimumLoanAmount],
         [MaximumLoanAmount],
		 [ExistingEmiAmount],
         [ResidenceType],
         [MonthsAtCurrentAddress],
         [AddressRisk],
         [ITR26ASAvailable],
		 [EmploymentType],
		 [ProductCode],
		 [CreditScore],
         [Dpd12M],
         [ActiveLoans],
         [SimAgeMonths],
         [GeoPinRiskIndex],
         [SchoolPaymentHistoryScore],
         [VaultBalanceAverage],
         [IncomeTruthIndex],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [pl].[CreditEngineConfiguration]
    WHERE [ConfigId] = @ConfigId;
END;
GO
/****** Object:  StoredProcedure [pl].[DigilockerSessionKey_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[DigilockerSessionKey_Create]
(
    @UserId        INT,
    @SessionKey    VARCHAR(100),
    @ValidFrom     DATETIME = NULL,
    @ValidTo       DATETIME = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @KeyId BIGINT;

    INSERT INTO [pl].[DigilockerSessionKey]
    (
        [UserId],
        [SessionKey],
        [ValidFrom],
        [ValidTo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @SessionKey,
        @ValidFrom,
        @ValidTo,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @KeyId = SCOPE_IDENTITY();

    SELECT 
        [KeyId],
        [UserId],
        [SessionKey],
        [ValidFrom],
        [ValidTo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[DigilockerSessionKey]
    WHERE [KeyId] = @KeyId;
END;
GO
/****** Object:  StoredProcedure [pl].[DigilockerSessionKey_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[DigilockerSessionKey_Delete]
(
	@KeyId int,
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [pl].[DigilockerSessionKey]
	SET
		[IsActive] = 0,
		[IsDeleted] =  1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE KeyId =@KeyId
END;
GO
/****** Object:  StoredProcedure [pl].[DigilockerSessionKey_GetUserSessionKey]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[DigilockerSessionKey_GetUserSessionKey]
(
    @UserId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SessionKey NVARCHAR(200);
    DECLARE @ValidFrom DATETIME;
    DECLARE @ValidTo DATETIME;

    SELECT 
        @SessionKey = SessionKey,
        @ValidFrom = ValidFrom,
        @ValidTo = ValidTo
    FROM [pl].[DigilockerSessionKey]
    WHERE UserId = @UserId;

    IF @SessionKey IS NULL
    BEGIN
        SELECT 'NO_RECORD_FOUND' AS Message;
        RETURN;
    END

    IF GETDATE() < @ValidFrom OR GETDATE() > @ValidTo
    BEGIN
        SELECT 'SESSION_KEY_EXPIRED' AS Message;
        RETURN;
    END

    SELECT @SessionKey AS SessionKey;
END
GO
/****** Object:  StoredProcedure [pl].[DigilockerSessionKey_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[DigilockerSessionKey_ReadAll]
AS
 BEGIN
     SET NOCOUNT ON;
	 SELECT 
	   [KeyId]
      ,[UserId]
      ,[SessionKey]
      ,[ValidFrom]
      ,[ValidTo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [pl].[DigilockerSessionKey]
	WHERE IsActive = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[DigilockerSessionKey_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[DigilockerSessionKey_ReadById]
(
	@KeyId int
)
AS
 BEGIN
     SET NOCOUNT ON;
	 SELECT 
	   [KeyId]
      ,[UserId]
      ,[SessionKey]
      ,[ValidFrom]
      ,[ValidTo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [pl].[DigilockerSessionKey]
	WHERE KeyId= @KeyId 
	AND IsActive = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[DigilockerSessionKey_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[DigilockerSessionKey_ReadByUserId]
(
	@UserId int
)
AS
 BEGIN
     SET NOCOUNT ON;
	 SELECT 
	   [KeyId]
      ,[UserId]
      ,[SessionKey]
      ,[ValidFrom]
      ,[ValidTo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [pl].[DigilockerSessionKey]
	WHERE UserId= @UserId 
	AND IsActive = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[DigilockerSessionKey_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[DigilockerSessionKey_Update]
(
    @KeyId         BIGINT,
    @UserId        INT = NULL,
    @SessionKey    VARCHAR(100) = NULL,
    @ValidFrom     DATETIME = NULL,
    @ValidTo       DATETIME = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @IsActive      INT = NULL,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[DigilockerSessionKey]
    SET
        [UserId]       = @UserId,
        [SessionKey]   = TRIM(@SessionKey),
        [ValidFrom]    = @ValidFrom,
        [ValidTo]      = @ValidTo,
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive]     = @IsActive,
        [ModifiedBy]   = TRIM(@ActionUser),
        [ModifiedOn]   = GETDATE()
    WHERE [KeyId] = @KeyId;

    SELECT 
        [KeyId],
        [UserId],
        [SessionKey],
        [ValidFrom],
        [ValidTo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[DigilockerSessionKey]
    WHERE [KeyId] = @KeyId
      AND IsActive = 1
      AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[FetchProductDetails]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[FetchProductDetails]
(
	 @ProductId INT
)
AS
BEGIN
	
		SELECT TotalCount,Approved,Pending,Rejected,UnderReview,TotalDisbursedAmount,AvgRequestedAmount,AvgApprovedAmount,AvgTenure,AvgCreditScore
		FROM [pl].[GetProductDashboardStats]()
		WHERE ProductId = @ProductId

		SELECT 
			ProductId,
			ProductName,
			ProductCode,
			ProductType,
			Description,
			MaxLoanAmount,
			MinLoanAmount,
			InterestRate,
			MaxTenureMonths,
			MinTenureMonths,
			CreatedOn
		FROM 
			[pl].[Product]
		WHERE 
			IsDeleted = 0 AND ProductId = @ProductId

		SELECT 
			A.ApplicationId,
			A.UserId,
			CONCAT(ISNULL(U.FirstName,''), ' ', ISNULL(U.LastName,'')) AS ApplicantName,
			A.ProductId,
			P.ProductName,
			P.Description,
			A.ApplicationStatus,
			A.RequestedAmount,
			A.ApprovedAmount,
			A.TenureMonths,
			A.CreditScore,
			A.ApplicationDate,
			A.ApprovalDate,
			ISNULL(A.ApprovedBy,0) AS ApprovedById,
			CONCAT(ISNULL(U2.FirstName,''), ' ', ISNULL(U2.LastName,'')) AS ApprovedBy,
			ISNULL(A.RejectionReason,'') RejectionReason,
			ISNULL(A.RejectedBy,0) AS RejectedById,
			CONCAT(ISNULL(U3.FirstName,''), ' ', ISNULL(U3.LastName,'')) AS RejectedBy,
			A.IsKYCVerified,
			A.IsDisbursed,
			ISNULL(A.DisbursedAmount,0) DisbursedAmount,
			ISNULL(A.KycDocId,0) KycDocId
		FROM 
			[pl].[Application] A WITH (NOLOCK)
		LEFT JOIN 
			[pl].[Product] P ON P.ProductId = A.ProductId
		LEFT JOIN 
			[dbo].[Usermaster] U WITH (NOLOCK) ON U.UserId = A.UserId
		LEFT JOIN 
			[dbo].[Usermaster] U2 WITH (NOLOCK) ON U2.UserId = A.ApprovedBy
		LEFT JOIN 
			[dbo].[Usermaster] U3 WITH (NOLOCK) ON U3.UserId = A.ApprovedBy
		WHERE 
			P.IsDeleted = 0 
			AND A.IsDeleted = 0 
			AND P.ProductId = @ProductId

END
GO
/****** Object:  StoredProcedure [pl].[GeneratePRRN]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[GeneratePRRN]
	@PRRN VARCHAR(20) OUTPUT
AS
BEGIN
    SET NOCOUNT ON;

    WHILE 1 = 1
    BEGIN
        DECLARE @TempPRRN VARCHAR(20);

        -- Generate PRRN: YYYYMMDDHHMMSS + 4 random digits
        SET @TempPRRN = CONVERT(CHAR(8), GETDATE(), 112) + 
                        REPLACE(CONVERT(CHAR(8), GETDATE(), 108), ':', '') + 
                        RIGHT('0000' + CAST(ABS(CHECKSUM(NEWID())) % 10000 AS VARCHAR(4)), 4);

        -- Ensure uniqueness
        IF NOT EXISTS (SELECT 1 FROM pl.PaymentTransactions WHERE PRRN = @TempPRRN)
        BEGIN
            SET @PRRN = @TempPRRN;
            BREAK;
        END
    END
END;
GO
/****** Object:  StoredProcedure [pl].[GetLoanSlabs]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [pl].[GetLoanSlabs]
    @Principal = 100000,       
    @AnnualRatePct = 12,       
    @DurationsCsv = '3,6,9,12';
*/

CREATE PROCEDURE [pl].[GetLoanSlabs]
(
    @Principal        DECIMAL(18,2),    
    @AnnualRatePct    DECIMAL(9,4),     
    @DurationsCsv     VARCHAR(100)      
)
AS
BEGIN
    SET NOCOUNT ON;

    ----------------------------------------------------------------
    -- 1. Parse CSV into list of durations
    ----------------------------------------------------------------
    ;WITH TenureList AS
    (
        SELECT TRY_CAST(value AS INT) AS Months
        FROM STRING_SPLIT(@DurationsCsv, ',')
        WHERE TRY_CAST(value AS INT) IS NOT NULL
    ),
    ----------------------------------------------------------------
    -- 2. Compute Monthly Interest & EMI (Simple Interest formula)
    --    Now dividing Interest and EMI by 3,6,9,12 respectively
    ----------------------------------------------------------------
    Calc AS
    (
        SELECT
            tl.Months,
            CAST(@Principal AS DECIMAL(18,2)) AS Amount,
            
            -- Interest divided by tenure months
            CAST((@Principal * (@AnnualRatePct/100.0) * (tl.Months/12.0)) / tl.Months AS DECIMAL(18,2)) AS Interest,
            
            -- Total Payable = Principal + Interest * tl.Months (reconstructed)
            CAST(@Principal + ((@Principal * (@AnnualRatePct/100.0) * (tl.Months/12.0))) AS DECIMAL(18,2)) AS TotalPayable,
            
            -- EMI divided by tenure months again (per your request)
            CAST((((@Principal + (@Principal * (@AnnualRatePct/100.0) * (tl.Months/12.0))) / tl.Months) / tl.Months) AS DECIMAL(18,2)) AS EMI
        FROM TenureList tl
    ),
    ----------------------------------------------------------------
    -- 3. Unpivot to RowLabel format
    ----------------------------------------------------------------
    Unpivoted AS
    (
        SELECT 'Amount' AS RowLabel, Months, Amount AS Val FROM Calc
        UNION ALL
        SELECT 'Interest', Months, Interest FROM Calc
        UNION ALL
        SELECT 'EMI', Months, EMI FROM Calc
        UNION ALL
        SELECT 'Total Payable', Months, TotalPayable FROM Calc
    )

    ----------------------------------------------------------------
    -- 4. Store data in temp table for pivot
    ----------------------------------------------------------------
    SELECT * INTO #Unpivoted FROM Unpivoted;

    ----------------------------------------------------------------
    -- 5. Build dynamic pivot SQL
    ----------------------------------------------------------------
    DECLARE @cols NVARCHAR(MAX) = '';
    DECLARE @sql NVARCHAR(MAX) = '';

    SELECT @cols = STRING_AGG(QUOTENAME(Months), ',') 
    FROM (SELECT DISTINCT Months FROM #Unpivoted) d;

    SET @sql = N'
        SELECT RowLabel, ' + @cols + N'
        FROM
        (
            SELECT RowLabel, CAST(Months AS NVARCHAR(10)) AS Months, Val
            FROM #Unpivoted
        ) src
        PIVOT
        (
            MAX(Val) FOR Months IN (' + @cols + N')
        ) p
        ORDER BY
            CASE RowLabel
                WHEN ''Amount'' THEN 1
                WHEN ''Interest'' THEN 2
                WHEN ''EMI'' THEN 3
                WHEN ''Total Payable'' THEN 4
                ELSE 99
            END;
    ';

    EXEC sp_executesql @sql;
    DROP TABLE #Unpivoted;
END;
GO
/****** Object:  StoredProcedure [pl].[KYCDocument_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[KYCDocument_Create]
(
    @KYCId             INT,
    @DocumentTypeId    INT,
    @DocumentName      VARCHAR(200),
    @FilePath          VARCHAR(1000),
    @DocumentStatus    VARCHAR(50),
    @VerifiedBy        INT,
    @VerifiedOn        DATETIME,
    @RejectionReason   VARCHAR(500),
    @UploadedOn        DATETIME,
    @UploadedBy        INT,
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DocumentId INT;

    INSERT INTO [pl].[KYCDocument]
    (
         [KYCId]
        ,[DocumentTypeId]
        ,[DocumentName]
        ,[FilePath]
        ,[DocumentStatus]
        ,[VerifiedBy]
        ,[VerifiedOn]
        ,[RejectionReason]
        ,[UploadedOn]
        ,[UploadedBy]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @KYCId
        ,@DocumentTypeId
        ,@DocumentName
        ,@FilePath
        ,@DocumentStatus
        ,@VerifiedBy
        ,@VerifiedOn
        ,@RejectionReason
        ,@UploadedOn
        ,@UploadedBy
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1              
        ,0              
        ,@ActionUser    
        ,GETDATE()      
    );

    SET @DocumentId = SCOPE_IDENTITY();

    SELECT
         [DocumentId]
        ,[KYCId]
        ,[DocumentTypeId]
        ,[DocumentName]
        ,[FilePath]
        ,[DocumentStatus]
        ,[VerifiedBy]
        ,[VerifiedOn]
        ,[RejectionReason]
        ,[UploadedOn]
        ,[UploadedBy]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [pl].[KYCDocument]
    WHERE [DocumentId] = @DocumentId;
END;
GO
/****** Object:  StoredProcedure [pl].[KYCDocument_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[pl].[KYCDocument_Delete]
(
  @DocumentTypeId INT,
  @ActionUser varchar(50)
)
AS
 BEGIN
  SET NOCOUNT ON;
  UPDATE[pl].[KYCDocument]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [DocumentTypeId] = @DocumentTypeId
END
GO
/****** Object:  StoredProcedure [pl].[KYCDocument_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[pl].[KYCDocument_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT
       [DocumentId]
      ,[KYCId]
      ,[DocumentTypeId]
      ,[DocumentName]
      ,[FilePath]
      ,[DocumentStatus]
      ,[VerifiedBy]
      ,[VerifiedOn]
      ,[RejectionReason]
      ,[UploadedOn]
      ,[UploadedBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[KYCDocument]
	  WHERE [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [pl].[KYCDocument_ReadByDocumentTypeId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[pl].[KYCDocument_ReadByDocumentTypeId]
(
  @DocumentTypeId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT
       [DocumentId]
      ,[KYCId]
      ,[DocumentTypeId]
      ,[DocumentName]
      ,[FilePath]
      ,[DocumentStatus]
      ,[VerifiedBy]
      ,[VerifiedOn]
      ,[RejectionReason]
      ,[UploadedOn]
      ,[UploadedBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[KYCDocument]
	  WHERE [DocumentTypeId] =@DocumentTypeId
	  AND [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [pl].[KYCDocument_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[pl].[KYCDocument_ReadById]
(
  @DocumentId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT
       [DocumentId]
      ,[KYCId]
      ,[DocumentTypeId]
      ,[DocumentName]
      ,[FilePath]
      ,[DocumentStatus]
      ,[VerifiedBy]
      ,[VerifiedOn]
      ,[RejectionReason]
      ,[UploadedOn]
      ,[UploadedBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[KYCDocument]
	  WHERE [DocumentId] =@DocumentId
	  AND [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [pl].[KYCDocument_ReadByKYCId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[pl].[KYCDocument_ReadByKYCId]
(
  @KYCId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT
       [DocumentId]
      ,[KYCId]
      ,[DocumentTypeId]
      ,[DocumentName]
      ,[FilePath]
      ,[DocumentStatus]
      ,[VerifiedBy]
      ,[VerifiedOn]
      ,[RejectionReason]
      ,[UploadedOn]
      ,[UploadedBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[KYCDocument]
	  WHERE [KYCId] =@KYCId
	  AND [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [pl].[KYCDocument_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[KYCDocument_Update]
(
    @DocumentId        INT,
    @KYCId             INT,
    @DocumentTypeId    INT,
    @DocumentName      VARCHAR(200),
    @FilePath          VARCHAR(1000),
    @DocumentStatus    VARCHAR(50),
    @VerifiedBy        INT,
    @VerifiedOn        DATETIME,
    @RejectionReason   VARCHAR(500),
    @UploadedOn        DATETIME,
    @UploadedBy        INT,
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @IsDeleted         INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[KYCDocument]
    SET
         [KYCId]           = @KYCId
        ,[DocumentTypeId]  = @DocumentTypeId
        ,[DocumentName]    = @DocumentName
        ,[FilePath]        = @FilePath
        ,[DocumentStatus]  = @DocumentStatus
        ,[VerifiedBy]      = @VerifiedBy
        ,[VerifiedOn]      = @VerifiedOn
        ,[RejectionReason] = @RejectionReason
        ,[UploadedOn]      = @UploadedOn
        ,[UploadedBy]      = @UploadedBy
        ,[OtherDetail1]    = @OtherDetail1
        ,[OtherDetail2]    = @OtherDetail2
        ,[OtherDetail3]    = @OtherDetail3
        ,[OtherDetail4]    = @OtherDetail4
        ,[OtherDetail5]    = @OtherDetail5
        ,[OtherDetail6]    = @OtherDetail6
        ,[IsActive]        = @IsActive
        ,[IsDeleted]       = @IsDeleted
        ,[ModifiedBy]      = @ActionUser
        ,[ModifiedOn]      = GETDATE()
    WHERE [DocumentId] = @DocumentId;

    SELECT 
         [DocumentId]
        ,[KYCId]
        ,[DocumentTypeId]
        ,[DocumentName]
        ,[FilePath]
        ,[DocumentStatus]
        ,[VerifiedBy]
        ,[VerifiedOn]
        ,[RejectionReason]
        ,[UploadedOn]
        ,[UploadedBy]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [pl].[KYCDocument]
    WHERE [DocumentId] = @DocumentId;
END;
GO
/****** Object:  StoredProcedure [pl].[KYCDocumentType_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[KYCDocumentType_Create]
(
    @Code            VARCHAR(50),
    @DocumentName    VARCHAR(200),
    @EntityType      VARCHAR(50),
    @IsMandatory     INT,
    @MaxFileSizeMB   INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DocumentTypeId INT;

    INSERT INTO [pl].[KYCDocumentType]
    (
         [Code]
        ,[DocumentName]
        ,[EntityType]
        ,[IsMandatory]
        ,[MaxFileSizeMB]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @Code
        ,@DocumentName
        ,@EntityType
        ,@IsMandatory
        ,@MaxFileSizeMB
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1             
        ,0             
        ,@ActionUser   
        ,GETDATE()     
    );

    SET @DocumentTypeId = SCOPE_IDENTITY();

    SELECT
         [DocumentTypeId]
        ,[Code]
        ,[DocumentName]
        ,[EntityType]
        ,[IsMandatory]
        ,[MaxFileSizeMB]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [pl].[KYCDocumentType]
    WHERE [DocumentTypeId] = @DocumentTypeId;
END;
GO
/****** Object:  StoredProcedure [pl].[KYCDocumentType_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[KYCDocumentType_Delete]
(
    @DocumentTypeId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [pl].[KYCDocumentType]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [DocumentTypeId] = @DocumentTypeId
END;
GO
/****** Object:  StoredProcedure [pl].[KYCDocumentType_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[KYCDocumentType_ReadAll]
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT 
			 [DocumentTypeId]
			,[Code]
			,[DocumentName]
			,[EntityType]
			,[IsMandatory]
			,[MaxFileSizeMB]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [pl].[KYCDocumentType]
		WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[KYCDocumentType_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[KYCDocumentType_ReadById]
(
    @DocumentTypeId INT
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT 
			 [DocumentTypeId]
			,[Code]
			,[DocumentName]
			,[EntityType]
			,[IsMandatory]
			,[MaxFileSizeMB]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [pl].[KYCDocumentType]
		WHERE [DocumentTypeId] = @DocumentTypeId
		AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[KYCDocumentType_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[KYCDocumentType_Update]
(
    @DocumentTypeId  INT,
    @Code            VARCHAR(50),
    @DocumentName    VARCHAR(200),
    @EntityType      VARCHAR(50),
    @IsMandatory     INT,
    @MaxFileSizeMB   INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @IsActive        INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[KYCDocumentType]
    SET
         [Code]           = @Code
        ,[DocumentName]   = @DocumentName
        ,[EntityType]     = @EntityType
        ,[IsMandatory]    = @IsMandatory
        ,[MaxFileSizeMB]  = @MaxFileSizeMB
        ,[OtherDetail1]   = @OtherDetail1
        ,[OtherDetail2]   = @OtherDetail2
        ,[OtherDetail3]   = @OtherDetail3
        ,[OtherDetail4]   = @OtherDetail4
        ,[OtherDetail5]   = @OtherDetail5
        ,[OtherDetail6]   = @OtherDetail6
        ,[IsActive]       = @IsActive
        ,[ModifiedBy]     = @ActionUser
        ,[ModifiedOn]     = GETDATE()
    WHERE
        [DocumentTypeId] = @DocumentTypeId
        AND [IsDeleted] = 0;

    SELECT
         [DocumentTypeId]
        ,[Code]
        ,[DocumentName]
        ,[EntityType]
        ,[IsMandatory]
        ,[MaxFileSizeMB]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [pl].[KYCDocumentType]
    WHERE [DocumentTypeId] = @DocumentTypeId;
END;
GO
/****** Object:  StoredProcedure [pl].[PayLaterImgMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[PayLaterImgMaster_Create]
(
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ImgId INT;
		IF @IsDefault = 1
	BEGIN
	UPDATE[pl].[PayLaterImgMaster]
		SET IsDefault = 0,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND IsActive = 1;
	END
    INSERT INTO [pl].[PayLaterImgMaster]
    (
        [MasterType],
        [MasterId],
        [ImgPath],
        [ImgTitle],
        [IsDefault],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterType,
        @MasterId,
        @ImgPath,
        @ImgTitle,
        @IsDefault,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,       
        0,       
        @ActionUser,
        GETDATE()
    );

    SET @ImgId = SCOPE_IDENTITY();

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [pl].[PayLaterImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [pl].[PayLaterImgMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[PayLaterImgMaster_Delete]
(
   @ImgId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [pl].[PayLaterImgMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] =1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = getdate()
	WHERE [ImgId] = @ImgId
END;
GO
/****** Object:  StoredProcedure [pl].[PayLaterImgMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[PayLaterImgMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[PayLaterImgMaster]
	WHERE [IsActive] = 1
	ORDER BY imgId;
END;
GO
/****** Object:  StoredProcedure [pl].[PayLaterImgMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[PayLaterImgMaster_ReadById]
(
   @ImgId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[PayLaterImgMaster]
	WHERE [ImgId] = @ImgId
	AND [IsActive] = 1;
END;

GO
/****** Object:  StoredProcedure [pl].[PayLaterImgMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[PayLaterImgMaster_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[PayLaterImgMaster]
	WHERE --[MasterId] = @MasterId AND  
	[MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;

GO
/****** Object:  StoredProcedure [pl].[PayLaterImgMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[PayLaterImgMaster_Update]
(
    @ImgId          INT,
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
		IF @IsDefault = 1
		BEGIN
		UPDATE [pl].[PayLaterImgMaster]
		SET 
			IsDefault = 0,
			ModifiedBy = @ActionUser,
			ModifiedOn = GETDATE()
		WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND ImgId <> @ImgId
		AND IsActive = 1;
		END
    UPDATE [pl].[PayLaterImgMaster]
    SET
         [MasterType]    = @MasterType
        ,[MasterId]      = @MasterId
        ,[ImgPath]       = @ImgPath
        ,[ImgTitle]      = @ImgTitle
        ,[IsDefault]     = @IsDefault
        ,[OtherDetail1]  = @OtherDetail1
        ,[OtherDetail2]  = @OtherDetail2
        ,[OtherDetail3]  = @OtherDetail3
        ,[OtherDetail4]  = @OtherDetail4
        ,[OtherDetail5]  = @OtherDetail5
        ,[OtherDetail6]  = @OtherDetail6
        ,[IsActive]      = @IsActive
        ,[ModifiedBy]    = @ActionUser
        ,[ModifiedOn]    = GETDATE()
    WHERE [ImgId] = @ImgId;

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [pl].[PayLaterImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentReceipts_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentReceipts_Create]
(
    @TransactionId    INT,
    @CreatedBy        VARCHAR(50) = 'SYSTEM'
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @CurrentYear INT = YEAR(GETDATE());
    DECLARE @NextId INT, @ReceiptNo VARCHAR(50), @ReceiptId INT;

    -- Generate new Receipt Number (auto-increment per year)
    SELECT @NextId = ISNULL(MAX(CAST(RIGHT(ReceiptNo, 6) AS INT)), 0) + 1
    FROM [pl].[PaymentReceipts] WITH (TABLOCKX)
    WHERE ReceiptNo LIKE 'RCPT-' + CAST(@CurrentYear AS VARCHAR(4)) + '-%';

    SET @ReceiptNo = 'RCPT-' + CAST(@CurrentYear AS VARCHAR(4)) 
                   + '-' + RIGHT('000000' + CAST(@NextId AS VARCHAR), 6);

	IF EXISTS (SELECT 1 FROM [pl].[PaymentTransactions] WHERE TransactionId = @TransactionId AND IsDeleted = 0)
	BEGIN
		-- Fetch transaction details
		DECLARE 
			@UserId INT,
			@BusinessId INT,
			@ModuleType VARCHAR(50),
			@ModuleEntityId INT,
			@TransactionAmount DECIMAL(18,2),
			@PaymentMethod VARCHAR(50),
			@StatusCode VARCHAR(20),
			@Notes NVARCHAR(500),
			@OtherDetail1 VARCHAR(200),
			@OtherDetail2 VARCHAR(200),
			@OtherDetail3 VARCHAR(300),
			@OtherDetail4 VARCHAR(300),
			@OtherDetail5 VARCHAR(500),
			@OtherDetail6 VARCHAR(500);

		SELECT 
			@UserId = UserId,
			@BusinessId = BusinessId,
			@ModuleType = ModuleType,
			@ModuleEntityId = ModuleEntityId,
			@TransactionAmount = TransactionAmount,
			@PaymentMethod = PaymentMethod,
			@StatusCode = StatusCode,
			@Notes = 'Payment Success',
			@OtherDetail1 = OtherDetail1,
			@OtherDetail2 = OtherDetail2,
			@OtherDetail3 = OtherDetail3,
			@OtherDetail4 = OtherDetail4,
			@OtherDetail5 = OtherDetail5,
			@OtherDetail6 = OtherDetail6
		FROM [pl].[PaymentTransactions]
		WHERE TransactionId = @TransactionId;

		-- Insert into PaymentReceipts
		INSERT INTO [pl].[PaymentReceipts]
		(
			ReceiptNo, TransactionId, UserId, BusinessId, ModuleType, ModuleEntityId,
			ReceiptAmount, PaymentMethod, StatusCode, Notes,
			OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
			CreatedBy
		)
		VALUES
		(
			@ReceiptNo, @TransactionId, ISNULL(@UserId,0), @BusinessId, @ModuleType, @ModuleEntityId,
			@TransactionAmount, @PaymentMethod, @StatusCode, @Notes,
			@OtherDetail1, @OtherDetail2, @OtherDetail3, @OtherDetail4, @OtherDetail5, @OtherDetail6,
			@CreatedBy
		);

		SELECT @ReceiptId = SCOPE_IDENTITY();

		--  Return created receipt
		SELECT * FROM [pl].[PaymentReceipts] WHERE ReceiptId = @ReceiptId;
	END
	ELSE
	BEGIN
		RAISERROR('Transaction not found..', 16, 1);
        RETURN;
	END
END
GO
/****** Object:  StoredProcedure [pl].[PaymentReceipts_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[PaymentReceipts_Delete]
(
    @ReceiptId INT,
    @ModifiedBy VARCHAR(50) = 'SYSTEM'
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[PaymentReceipts]
    SET 
        IsDeleted = 1,
        ModifiedBy = @ModifiedBy,
        ModifiedOn = GETDATE()
    WHERE ReceiptId = @ReceiptId;
END
GO
/****** Object:  StoredProcedure [pl].[PaymentReceipts_Get]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[PaymentReceipts_Get]
(
    @UserId INT = NULL,
    @BusinessId INT = NULL,
    @ModuleType VARCHAR(50) = NULL,
    @FromDate DATETIME = NULL,
    @ToDate DATETIME = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[PaymentReceipts]
    WHERE IsDeleted = 0
      AND (@UserId IS NULL OR UserId = @UserId)
      AND (@BusinessId IS NULL OR BusinessId = @BusinessId)
      AND (@ModuleType IS NULL OR ModuleType = @ModuleType)
      AND (@FromDate IS NULL OR CreatedOn >= @FromDate)
      AND (@ToDate IS NULL OR CreatedOn <= @ToDate)
    ORDER BY CreatedOn DESC;
END
GO
/****** Object:  StoredProcedure [pl].[PaymentReceipts_GetById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentReceipts_GetById]
(
    @ReceiptId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[PaymentReceipts]
    WHERE ReceiptId = @ReceiptId
      AND IsDeleted = 0;
END
GO
/****** Object:  StoredProcedure [pl].[PaymentReceipts_ReadByBusiness]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentReceipts_ReadByBusiness]
(
    @BusinessId INT,
    @ModuleType VARCHAR(50) = NULL   -- optional filter (eg. 'Hospital', 'School')
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        R.ReceiptId,
        R.ReceiptNo,
        R.UserId,
        R.BusinessId,
        R.ModuleType,
        R.ModuleEntityId,
        R.ReceiptAmount,
        R.PaymentMethod,
        R.StatusCode AS ReceiptStatus,
        R.CreatedOn,
        T.TransactionType,
        T.StatusCode AS TransactionStatus,
        T.TransactionAmount,
        T.CurrencyCode
    FROM [pl].[PaymentReceipts] R
    INNER JOIN [pl].[PaymentTransactions] T
        ON R.TransactionId = T.TransactionId
    WHERE R.BusinessId = @BusinessId
      AND (@ModuleType IS NULL OR R.ModuleType = @ModuleType)
    ORDER BY R.CreatedOn DESC;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentReceipts_ReadByReceiptNo]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [pl].[PaymentReceipts_ReadByReceiptNo]
(
    @ReceiptNo VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        R.ReceiptId,
        R.ReceiptNo,
        R.TransactionId,
        R.UserId,
        R.BusinessId,
        R.ModuleType,
        R.ModuleEntityId,
        R.ReceiptAmount,
        R.PaymentMethod,
        R.StatusCode AS ReceiptStatus,
        R.Notes,
        R.CreatedOn,
        T.TransactionType,
        T.TransactionAmount,
        T.CurrencyCode,
        T.StatusCode AS TransactionStatus,
        T.CreatedOn AS TransactionDate
    FROM [pl].[PaymentReceipts] R
    INNER JOIN [pl].[PaymentTransactions] T
        ON R.TransactionId = T.TransactionId
    WHERE R.ReceiptNo = @ReceiptNo;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentReceipts_ReadByUser]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentReceipts_ReadByUser]
(
    @UserId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        R.ReceiptId,
        R.ReceiptNo,
        R.ReceiptAmount,
        R.ModuleType,
        R.ModuleEntityId,
        R.CreatedOn,
        T.PaymentMethod,
        T.TransactionType,
        T.StatusCode AS TransactionStatus
    FROM [pl].[PaymentReceipts] R
    INNER JOIN [pl].[PaymentTransactions] T
        ON R.TransactionId = T.TransactionId
    WHERE R.UserId = @UserId
    ORDER BY R.CreatedOn DESC;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentReceipts_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [pl].[PaymentReceipts_Update]
(
    @ReceiptId INT,
    @StatusCode VARCHAR(20) = NULL,
    @Notes NVARCHAR(500) = NULL,
    @ModifiedBy VARCHAR(50) = 'SYSTEM'
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[PaymentReceipts]
    SET 
        StatusCode = ISNULL(@StatusCode, StatusCode),
        Notes = ISNULL(@Notes, Notes),
        ModifiedBy = @ModifiedBy,
        ModifiedOn = GETDATE()
    WHERE ReceiptId = @ReceiptId
      AND IsDeleted = 0;
END
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_Create]
(
    @ParentTransactionId   INT = NULL,
    @ReferenceTransactionId INT = NULL,
    @LoanId                INT = NULL,
    @UserId                INT,
    @TransactionType       VARCHAR(50),
    @PaymentMethod         VARCHAR(50),
    @TransactionAmount     DECIMAL(18,2),
    @CurrencyCode          VARCHAR(10) = 'INR',
    @StatusCode            VARCHAR(20),
    @ModuleType            VARCHAR(50),
    @ModuleEntityId        INT,
    @BusinessId            INT = NULL,
    @OtherDetail1          VARCHAR(200) = NULL,
    @OtherDetail2          VARCHAR(200) = NULL,
    @OtherDetail3          VARCHAR(300) = NULL,
    @OtherDetail4          VARCHAR(300) = NULL,
    @OtherDetail5          VARCHAR(500) = NULL,
    @OtherDetail6          VARCHAR(500) = NULL,
    @ActionUser            VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TransactionId INT, @PRRN VARCHAR(50);

    -- Generate unique PRRN
    EXEC [pl].[GeneratePRRN] @PRRN OUTPUT;

    INSERT INTO [pl].[PaymentTransactions]
    (
        ParentTransactionId,
        ReferenceTransactionId,
        LoanId,
        UserId,
        PRRN,
        TransactionType,
        PaymentMethod,
        TransactionAmount,
        CurrencyCode,
        StatusCode,
        ModuleType,
        ModuleEntityId,
        BusinessId,
        InitiatedAt,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    VALUES
    (
        @ParentTransactionId,
        @ReferenceTransactionId,
        @LoanId,
        @UserId,
        @PRRN,
        @TransactionType,
        @PaymentMethod,
        @TransactionAmount,
        @CurrencyCode,
        @StatusCode,
        @ModuleType,
        @ModuleEntityId,
        @BusinessId,
        GETDATE(),
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @TransactionId = SCOPE_IDENTITY();

    SELECT * 
    FROM [pl].[PaymentTransactions]
    WHERE TransactionId = @TransactionId;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_Delete]
(
    @TransactionId INT,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[PaymentTransactions]
    SET 
        IsActive = 0,
        IsDeleted = 1,
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()
    WHERE TransactionId = @TransactionId;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_ReadAll]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[PaymentTransactions]
    WHERE IsActive = 1 AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_ReadByBusinessId]
(
    @BusinessId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[PaymentTransactions]
    WHERE BusinessId = @BusinessId
      AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_ReadById]
(
    @TransactionId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[PaymentTransactions]
    WHERE TransactionId = @TransactionId
      AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_ReadByModule]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_ReadByModule]
(
    @ModuleType    VARCHAR(50),
    @ModuleEntityId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[PaymentTransactions]
    WHERE ModuleType = @ModuleType
      AND ModuleEntityId = @ModuleEntityId
      AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_ReadByPRRN]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_ReadByPRRN]
(
    @PRRN VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[PaymentTransactions]
    WHERE PRRN = @PRRN
      AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_ReadByUserId]
(
    @UserId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM [pl].[PaymentTransactions]
    WHERE UserId = @UserId
      AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[PaymentTransactions_UpdateStatus]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[PaymentTransactions_UpdateStatus]
(
    @TransactionId INT,
    @StatusCode    VARCHAR(20),
    @CompletedAt   DATETIME = NULL,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[PaymentTransactions]
    SET 
        StatusCode = @StatusCode,
        CompletedAt = ISNULL(@CompletedAt, CASE WHEN @StatusCode IN ('SUCCESS','FAILED','CHARGEBACK') THEN GETDATE() END),
        ModifiedBy = @ActionUser,
        ModifiedOn = GETDATE()
    WHERE TransactionId = @TransactionId
      AND IsDeleted = 0;

    SELECT * FROM [pl].[PaymentTransactions] WHERE TransactionId = @TransactionId;
END;
GO
/****** Object:  StoredProcedure [pl].[Product_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[Product_Create]
(
    @ProductName			  VARCHAR(100),
	@ProductCode			  VARCHAR(20),
    @ProductType			  VARCHAR(50),
    @Description			  VARCHAR(255),
    @MaxLoanAmount            DECIMAL(18, 2),
    @MinLoanAmount            DECIMAL(18, 2),
    @InterestRate             DECIMAL(5, 2),
	@MinTenureMonths          INT,
    @MaxTenureMonths          INT,
	@ProcessingFeePercent     DECIMAL(5, 2),
    @MinCreditScore           INT,
    @MinIncomePerMonth        DECIMAL(18, 2),
    @AllowPreclosure          BIT,
    @PreclosureChargesPercent DECIMAL(18, 2),
    @OtherDetail1			  VARCHAR(50),
    @OtherDetail2			  VARCHAR(50),
    @OtherDetail3			  VARCHAR(100),
    @OtherDetail4			  VARCHAR(100),
    @OtherDetail5			  VARCHAR(500),
    @OtherDetail6			  VARCHAR(500),
    @ActionUser				  VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ProductId INT;

    INSERT INTO [pl].[Product]
    (
        ProductName,			  
        ProductCode,			  
        ProductType,
        Description,
        MaxLoanAmount,           
        MinLoanAmount,           
        InterestRate,             
        MinTenureMonths,          
        MaxTenureMonths,          
        ProcessingFeePercent,     
        MinCreditScore,          
        MinIncomePerMonth,        
        AllowPreclosure,          
        PreclosureChargesPercent, 
        OtherDetail1,			  
        OtherDetail2,			  
        OtherDetail3,			  
        OtherDetail4,			  
        OtherDetail5,			  
    	OtherDetail6,
		[IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn]
	)
    VALUES
    (
        @ProductName,			  
		@ProductCode,		  
		@ProductType,			  
		@Description,			  
		@MaxLoanAmount,            
		@MinLoanAmount,            
		@InterestRate,            
		@MinTenureMonths,         
		@MaxTenureMonths,          
		@ProcessingFeePercent,   
		@MinCreditScore,           
		@MinIncomePerMonth,        
		@AllowPreclosure,         
		@PreclosureChargesPercent,
		@OtherDetail1,		  
		@OtherDetail2,			  
		@OtherDetail3,			  
		@OtherDetail4,			  
		@OtherDetail5,			  
		@OtherDetail6,			  
        1, 
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @ProductId = SCOPE_IDENTITY();

    SELECT
         [ProductId]
        ,[ProductName]
        ,[ProductCode]
        ,[ProductType]
        ,[Description]
        ,[MaxLoanAmount]
        ,[MinLoanAmount]
        ,[InterestRate]
        ,[MinTenureMonths]
        ,[MaxTenureMonths]
        ,[ProcessingFeePercent]
        ,[MinCreditScore]
        ,[MinIncomePerMonth]
        ,[AllowPreclosure]
        ,[PreclosureChargesPercent]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [pl].[Product]
    WHERE [ProductId] = @ProductId
			AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Product_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Product_Delete]
(
     @ProductId INT,
	 @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [pl].[Product]
	SET
		  [IsActive] =  0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [ProductId] = @ProductId
END;
GO
/****** Object:  StoredProcedure [pl].[Product_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Product_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ProductId]
		,[ProductName]
		,[ProductCode]
		,[ProductType]
		,[Description]
		,[MaxLoanAmount]
		,[MinLoanAmount]
		,[InterestRate]
		,[MinTenureMonths]
		,[MaxTenureMonths]
		,[ProcessingFeePercent]
		,[MinCreditScore]
		,[MinIncomePerMonth]
		,[AllowPreclosure]
		,[PreclosureChargesPercent]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Product]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Product_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [pl].[Product_ReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL =
		'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum,
		   [ProductId]
		  ,[ProductName]
		  ,[ProductCode]
		  ,[ProductType]
		  ,[Description]
		  ,[MaxLoanAmount]
		  ,[MinLoanAmount]
		  ,[InterestRate]
		  ,[MinTenureMonths]
		  ,[MaxTenureMonths]
		  ,[ProcessingFeePercent]
		  ,[MinCreditScore]
		  ,[MinIncomePerMonth]
		  ,[AllowPreclosure]
		  ,[PreclosureChargesPercent]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	   FROM [Nishwik].[pl].[Product]
       WHERE [IsActive] = 1';

	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [pl].[Product_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Product_ReadById]
(
     @ProductId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ProductId]
		,[ProductName]
		,[ProductCode]
		,[ProductType]
		,[Description]
		,[MaxLoanAmount]
		,[MinLoanAmount]
		,[InterestRate]
		,[MinTenureMonths]
		,[MaxTenureMonths]
		,[ProcessingFeePercent]
		,[MinCreditScore]
		,[MinIncomePerMonth]
		,[AllowPreclosure]
		,[PreclosureChargesPercent]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Product]
	WHERE [ProductId] = @ProductId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Product_ReadByProductCode]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Product_ReadByProductCode]
(
   @ProductCode VARCHAR(20)
)
AS
BEGIN 
 SET NOCOUNT ON;
 SELECT
       [ProductId]
      ,[ProductName]
      ,[ProductCode]
      ,[ProductType]
      ,[Description]
      ,[MaxLoanAmount]
      ,[MinLoanAmount]
      ,[InterestRate]
      ,[MinTenureMonths]
      ,[MaxTenureMonths]
      ,[ProcessingFeePercent]
      ,[MinCreditScore]
      ,[MinIncomePerMonth]
      ,[AllowPreclosure]
      ,[PreclosureChargesPercent]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[Product]
	  WHERE [ProductCode] = @ProductCode
	  AND [IsActive] = 1
	  AND [IsDeleted] =0;
END;
GO
/****** Object:  StoredProcedure [pl].[Product_ReadByProductType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Product_ReadByProductType]
(
   @ProductType VARCHAR(50)
)
AS
BEGIN 
 SET NOCOUNT ON;
 SELECT
       [ProductId]
      ,[ProductName]
      ,[ProductCode]
      ,[ProductType]
      ,[Description]
      ,[MaxLoanAmount]
      ,[MinLoanAmount]
      ,[InterestRate]
      ,[MinTenureMonths]
      ,[MaxTenureMonths]
      ,[ProcessingFeePercent]
      ,[MinCreditScore]
      ,[MinIncomePerMonth]
      ,[AllowPreclosure]
      ,[PreclosureChargesPercent]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[Product]
	  WHERE [ProductType] = @ProductType
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[Product_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[Product_Update]
(
    @ProductId                INT,
    @ProductName              VARCHAR(100),
    @ProductCode              VARCHAR(20),
    @ProductType              VARCHAR(50),
    @Description              VARCHAR(500),
    @MaxLoanAmount            DECIMAL(18, 2),
    @MinLoanAmount            DECIMAL(18, 2),
    @InterestRate             DECIMAL(5, 2),
    @MinTenureMonths          INT,
    @MaxTenureMonths          INT,
    @ProcessingFeePercent     DECIMAL(5, 2),
    @MinCreditScore           INT,
    @MinIncomePerMonth        DECIMAL(18, 2),
    @AllowPreclosure          BIT,
    @PreclosureChargesPercent DECIMAL(18, 2),
    @OtherDetail1             VARCHAR(50),
    @OtherDetail2             VARCHAR(50),
    @OtherDetail3             VARCHAR(100),
    @OtherDetail4             VARCHAR(100),
    @OtherDetail5             VARCHAR(500),
    @OtherDetail6             VARCHAR(500),
    @IsActive                 INT,
    @ActionUser               VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[Product]
    SET
         [ProductName]              = @ProductName,
         [ProductCode]              = @ProductCode,
         [ProductType]              = @ProductType,
         [Description]              = @Description,
         [MaxLoanAmount]            = @MaxLoanAmount,
         [MinLoanAmount]            = @MinLoanAmount,
         [InterestRate]             = @InterestRate,
         [MinTenureMonths]          = @MinTenureMonths,
         [MaxTenureMonths]          = @MaxTenureMonths,
         [ProcessingFeePercent]     = @ProcessingFeePercent,
         [MinCreditScore]           = @MinCreditScore,
         [MinIncomePerMonth]        = @MinIncomePerMonth,
         [AllowPreclosure]          = @AllowPreclosure,
         [PreclosureChargesPercent] = @PreclosureChargesPercent,
         [OtherDetail1]             = @OtherDetail1,
         [OtherDetail2]             = @OtherDetail2,
         [OtherDetail3]             = @OtherDetail3,
         [OtherDetail4]             = @OtherDetail4,
         [OtherDetail5]             = @OtherDetail5,
         [OtherDetail6]             = @OtherDetail6,
         [IsActive]                 = @IsActive,
         [ModifiedBy]               = @ActionUser,
         [ModifiedOn]               = GETDATE()
    WHERE [ProductId] = @ProductId;

    SELECT
         [ProductId]
        ,[ProductName]
        ,[ProductCode]
        ,[ProductType]
        ,[Description]
        ,[MaxLoanAmount]
        ,[MinLoanAmount]
        ,[InterestRate]
        ,[MinTenureMonths]
        ,[MaxTenureMonths]
        ,[ProcessingFeePercent]
        ,[MinCreditScore]
        ,[MinIncomePerMonth]
        ,[AllowPreclosure]
        ,[PreclosureChargesPercent]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [pl].[Product]
    WHERE [ProductId] = @ProductId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[ReceiptMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[ReceiptMaster_Create]
(
    @ReceiptDate    DATETIME = NULL,
    @PRRN           VARCHAR(20) = NULL,
    @ReceiptAmount  DECIMAL(18,2) = NULL,
    @ModuleName     VARCHAR(20) = NULL,
    @Remarks        VARCHAR(500) = NULL,
    @PaymentId      VARCHAR(50) = NULL,
    @Mode           VARCHAR(20) = NULL,
    @Status         VARCHAR(20) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ReceiptId INT;
    DECLARE @OrderId VARCHAR(50);
	DECLARE  @ReceiptNumber  VARCHAR(20);

    SET @OrderId = [pl].[GenerateOrderId]();
	SET @ReceiptNumber = [pl].[GetMaxReceiptNumber]();

    INSERT INTO [pl].[ReceiptMaster]
    (
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [ModuleName],
        [Remarks],
        [OrderId],
        [PaymentId],
        [Mode],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ReceiptDate,
        TRIM(@ReceiptNumber),
        TRIM(@PRRN),
        @ReceiptAmount,
        TRIM(@ModuleName),
        TRIM(@Remarks),
        TRIM(@OrderId),
        TRIM(@PaymentId),
        TRIM(@Mode),
        TRIM(@Status),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @ReceiptId = SCOPE_IDENTITY();

    SELECT
        [ReceiptId],
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [ModuleName],
        [Remarks],
		[OrderId],
        [PaymentId],
        [Mode],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[ReceiptMaster]
    WHERE [ReceiptId] = @ReceiptId
      AND [IsActive] = 1
      AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[ReceiptMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ReceiptMaster_Delete]
(
     @ReceiptId INT,
	 @ActionUser VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT  ON;
	UPDATE  [pl].[ReceiptMaster]
	SET 
		 [IsActive] = 0,
		 [IsDeleted] = 1,
		 [ModifiedBy] = @ActionUser,
		 [ModifiedOn] = GETDATE()
	FROM [pl].[ReceiptMaster]
	WHERE [ReceiptId] = @ReceiptId
END;
GO
/****** Object:  StoredProcedure [pl].[ReceiptMaster_GetAmountByPRRN]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[ReceiptMaster_GetAmountByPRRN] 
(
    @PRRN VARCHAR(20),
    @ModuleName VARCHAR(50)  -- Logical module name: school, hospital, realestate, society
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SchemaName SYSNAME;
    DECLARE @SQL NVARCHAR(MAX);

    -- Trim spaces
    SET @ModuleName = LTRIM(RTRIM(@ModuleName));

    -- Map logical module names to actual schemas
    IF @ModuleName = 'school'
        SET @SchemaName = 'spe';
    ELSE IF @ModuleName = 'hospital'
        SET @SchemaName = 'hm';
    ELSE IF @ModuleName = 'realestate'
        SET @SchemaName = 're';
    ELSE IF @ModuleName = 'society'
        SET @SchemaName = 'sm';
    ELSE
    BEGIN
        RAISERROR(
            'Invalid ModuleName. Allowed values: school, hospital, realestate, society',
            16, 1
        );
        RETURN;
    END

    -- Build dynamic SQL with ModuleName as a constant
    SET @SQL = N'
        SELECT 
            ReceiptId,
            ReceiptDate,
            ReceiptNumber,
            PRRN,
            ReceiptAmount,
            ''' + @ModuleName + ''' AS ModuleName,
            Remarks,
			RStatus,
            OtherDetail1,
            OtherDetail2,
            OtherDetail3,
            OtherDetail4,
            OtherDetail5,
            OtherDetail6,
            IsActive,
            IsDeleted,
            CreatedBy,
            CreatedOn,
            ModifiedBy,
            ModifiedOn
        FROM ' + QUOTENAME(@SchemaName) + '.ReceiptMaster
        WHERE PRRN = @DynamicPRRN
          AND IsActive = 1
          AND IsDeleted = 0';

    -- Execute the dynamic SQL safely
    EXEC sp_executesql @SQL, N'@DynamicPRRN VARCHAR(20)', @DynamicPRRN = @PRRN;
END
GO
/****** Object:  StoredProcedure [pl].[ReceiptMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ReceiptMaster_ReadAll]
AS
 BEGIN
	SET NOCOUNT  ON;
	SELECT 
		 [ReceiptId]
		,[ReceiptDate]
		,[ReceiptNumber]
		,[PRRN]
		,[ReceiptAmount]
		,[ModuleName]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[OrderId]
        ,[PaymentId]
        ,[Mode]
        ,[Status]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[ReceiptMaster]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[ReceiptMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ReceiptMaster_ReadById]
(
     @ReceiptId INT
)
AS
 BEGIN
	SET NOCOUNT  ON;
	SELECT 
		 [ReceiptId]
		,[ReceiptDate]
		,[ReceiptNumber]
		,[PRRN]
		,[ReceiptAmount]
		,[ModuleName]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[OrderId]
        ,[PaymentId]
        ,[Mode]
        ,[Status]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[ReceiptMaster]
	WHERE [ReceiptId] = @ReceiptId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[ReceiptMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[ReceiptMaster_Update]
(
    @ReceiptId     INT,
    @ReceiptDate    DATETIME,
    @ReceiptNumber  VARCHAR(20),
    @PRRN           VARCHAR(20) = NULL,
    @ReceiptAmount  DECIMAL(18,2) = NULL,
    @ModuleName     VARCHAR(20) = NULL,
    @Remarks        VARCHAR(500) = NULL,
	@OrderId        VARCHAR(50) = NULL,
    @PaymentId      VARCHAR(50) = NULL,
    @Mode           VARCHAR(20) = NULL,
    @Status         VARCHAR(20) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @IsActive       INT = 1,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[ReceiptMaster]
    SET
        [ReceiptDate]   = @ReceiptDate,
        [ReceiptNumber] = TRIM(@ReceiptNumber),
        [PRRN]          = TRIM(@PRRN),
        [ReceiptAmount] = @ReceiptAmount,
        [ModuleName]    = TRIM(@ModuleName),
        [Remarks]       = TRIM(@Remarks),
		[OrderId]       = TRIM(@OrderId),
        [PaymentId]     = TRIM(@PaymentId),
        [Mode]          = TRIM(@Mode),
        [Status]        = TRIM(@Status),
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [ReceiptId] = @ReceiptId;

    SELECT
        [ReceiptId],
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [ModuleName],
        [Remarks],
		[OrderId],
        [PaymentId],
        [Mode],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[ReceiptMaster]
    WHERE [ReceiptId] = @ReceiptId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[Repayment_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[Repayment_Create]
(
    @AccountId           INT,
    @DueDate             DATETIME,
    @EMIAmount           DECIMAL(18, 2),
    @PrincipalComponent  DECIMAL(18, 2),
    @InterestComponent   DECIMAL(18, 2),
    @PaymentDate         DATETIME = NULL,
    @PaidAmount          DECIMAL(18, 2) = NULL,
    @PenaltyAmount       DECIMAL(18, 2) = NULL,
    @Status              VARCHAR(50) = NULL,
    @OtherDetail1        VARCHAR(50) = NULL,
    @OtherDetail2        VARCHAR(50) = NULL,
    @OtherDetail3        VARCHAR(100) = NULL,
    @OtherDetail4        VARCHAR(100) = NULL,
    @OtherDetail5        VARCHAR(500) = NULL,
    @OtherDetail6        VARCHAR(500) = NULL,
    @ActionUser          VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RepaymentId BIGINT;

    INSERT INTO [pl].[Repayment]
    (
        [AccountId],
        [DueDate],
        [EMIAmount],
        [PrincipalComponent],
        [InterestComponent],
        [PaymentDate],
        [PaidAmount],
        [PenaltyAmount],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @AccountId,
        @DueDate,
        @EMIAmount,
        @PrincipalComponent,
        @InterestComponent,
        @PaymentDate,
        @PaidAmount,
        @PenaltyAmount,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @RepaymentId = SCOPE_IDENTITY();

    SELECT
        [RepaymentId],
        [AccountId],
        [DueDate],
        [EMIAmount],
        [PrincipalComponent],
        [InterestComponent],
        [PaymentDate],
        [PaidAmount],
        [PenaltyAmount],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[Repayment]
    WHERE [RepaymentId] = @RepaymentId;
END;
GO
/****** Object:  StoredProcedure [pl].[Repayment_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Repayment_Delete]
(
   @RepaymentId int,
   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [pl].[Repayment]
	SET 
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [RepaymentId] = @RepaymentId
END;
GO
/****** Object:  StoredProcedure [pl].[Repayment_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Repayment_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	 	 [RepaymentId]
		,[AccountId]
		,[DueDate]
		,[EMIAmount]
		,[PrincipalComponent]
		,[InterestComponent]
		,[PaymentDate]
		,[PaidAmount]
		,[PenaltyAmount]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Repayment]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Repayment_ReadByAccountId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Repayment_ReadByAccountId]
(
   @AccountId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	 	 [RepaymentId]
		,[AccountId]
		,[DueDate]
		,[EMIAmount]
		,[PrincipalComponent]
		,[InterestComponent]
		,[PaymentDate]
		,[PaidAmount]
		,[PenaltyAmount]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Repayment]
	WHERE [AccountId] = @AccountId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[Repayment_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[Repayment_ReadById]
(
   @RepaymentId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	 	 [RepaymentId]
		,[AccountId]
		,[DueDate]
		,[EMIAmount]
		,[PrincipalComponent]
		,[InterestComponent]
		,[PaymentDate]
		,[PaidAmount]
		,[PenaltyAmount]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [pl].[Repayment]
	WHERE [RepaymentId] = @RepaymentId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffAmount_Fetch]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
	EXEC [pl].[RoundOffAmount_Fetch] 17001 ,1024
*/
CREATE   PROCEDURE [pl].[RoundOffAmount_Fetch]
(
    @TotalAmount INT,
    @UserId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE 
        @RoundOffAmount INT = 0,
        @IsEnabled INT = 0,
        @FinalPayableAmount INT = @TotalAmount; 

    IF EXISTS (SELECT 1 FROM [pl].[RoundOffSaving] WHERE UserId = @UserId AND IsDeleted = 0)
    BEGIN
        SELECT 
            @IsEnabled = IsActive,
            @RoundOffAmount = RoundOffAmount
        FROM [pl].[RoundOffSaving]
        WHERE UserId = @UserId AND IsDeleted = 0;

        IF @IsEnabled = 1 AND @RoundOffAmount > 0
        BEGIN
			 SET @FinalPayableAmount = CEILING(@TotalAmount * 1.0 / @RoundOffAmount) * @RoundOffAmount;
        END
    END

    -- Output
    SELECT 
        @TotalAmount AS TotalAmount,
        @IsEnabled AS IsRoundOffEnabled,
        @RoundOffAmount AS RoundOffAmount,
        @FinalPayableAmount AS FinalPayableAmount,
        @UserId AS UserId;
END
GO
/****** Object:  StoredProcedure [pl].[RoundOffSaving_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffSaving_Create]
(
    @UserId           INT,
    @RoundOffAmount   DECIMAL(10, 2),
    @Description       VARCHAR(255),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RoundOffSavingId INT;

    -- Check if mapping already exists for this UserId (and not deleted)
    IF EXISTS (
        SELECT 1
        FROM [pl].[RoundOffSaving]
        WHERE [UserId] = @UserId
    )
    BEGIN
        -- Update existing record
        UPDATE [pl].[RoundOffSaving]
        SET 
            [RoundOffAmount] = @RoundOffAmount,
            [Description]    = @Description,
            [OtherDetail1]   = @OtherDetail1,
            [OtherDetail2]   = @OtherDetail2,
            [OtherDetail3]   = @OtherDetail3,
            [OtherDetail4]   = @OtherDetail4,
            [OtherDetail5]   = @OtherDetail5,
            [OtherDetail6]   = @OtherDetail6,
            [ModifiedBy]     = @ActionUser,
            [ModifiedOn]     = GETDATE(),
			[IsActive]		 = 1,
			[IsDeleted]      = 0
        WHERE [UserId] = @UserId

        -- Get the updated record's ID
        SELECT @RoundOffSavingId = [RoundOffSavingId]
        FROM [pl].[RoundOffSaving]
        WHERE [UserId] = @UserId
    END
    ELSE
    BEGIN
        -- Insert new record
        INSERT INTO [pl].[RoundOffSaving]
        (
            [UserId],
            [RoundOffAmount],
            [Description],
            [OtherDetail1],
            [OtherDetail2],
            [OtherDetail3],
            [OtherDetail4],
            [OtherDetail5],
            [OtherDetail6],
            [IsActive],
            [IsDeleted],
            [CreatedBy],
            [CreatedOn]
        )
        VALUES
        (
            @UserId,
            @RoundOffAmount,
            @Description,
            @OtherDetail1,
            @OtherDetail2,
            @OtherDetail3,
            @OtherDetail4,
            @OtherDetail5,
            @OtherDetail6,
            1,              
            0,              
            @ActionUser,    
            GETDATE()       
        );

        SET @RoundOffSavingId = SCOPE_IDENTITY();
    END

    -- Return the final record (either updated or inserted)
    SELECT 
        [RoundOffSavingId],
        [UserId],
        [RoundOffAmount],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[RoundOffSaving]
    WHERE [RoundOffSavingId] = @RoundOffSavingId;
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffSaving_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffSaving_Delete]
(
   @RoundOffSavingId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE  [pl].[RoundOffSaving]
	SET 
		[IsActive] = 0 ,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE ()
	WHERE  [RoundOffSavingId] = @RoundOffSavingId
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffSaving_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffSaving_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [RoundOffSavingId]
      ,[UserId]
      ,[RoundOffAmount]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[RoundOffSaving]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffSaving_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffSaving_ReadById]
(
   @RoundOffSavingId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [RoundOffSavingId]
      ,[UserId]
      ,[RoundOffAmount]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[RoundOffSaving]
	  WHERE  [RoundOffSavingId] = @RoundOffSavingId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffSaving_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffSaving_ReadByUserId]
(
   @UserId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [RoundOffSavingId]
      ,[UserId]
      ,[RoundOffAmount]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[RoundOffSaving]
	  WHERE  [UserId] = @UserId
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffSaving_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffSaving_Update]
(
    @RoundOffSavingId  INT,
    @UserId            INT,
    @RoundOffAmount    DECIMAL(10, 2),
    @Description       VARCHAR(255),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[RoundOffSaving]
    SET
        [UserId]         = @UserId,
        [RoundOffAmount] = @RoundOffAmount,
        [Description]    = @Description,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE [RoundOffSavingId] = @RoundOffSavingId

    SELECT 
        [RoundOffSavingId],
        [UserId],
        [RoundOffAmount],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[RoundOffSaving]
    WHERE [RoundOffSavingId] = @RoundOffSavingId

END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffTransaction_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffTransaction_Create]
(
    @RoundOffSavingId BIGINT,
	@UserId BIGINT,
	@MasterId BIGINT,
	@MasterType VARCHAR(100),
	@TransactionType VARCHAR(50),
	@TransactionAmount DECIMAL (18,2),
	@TransactionDate DATETIME,
	@PaymentMethod VARCHAR(50),
	@ReferenceNumber VARCHAR(100),
	@Remarks NVARCHAR(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
		SET NOCOUNT ON;

		DECLARE @TransactionId BIGINT;

		INSERT INTO [pl].[RoundOffTransaction]
		(
			 [RoundOffSavingId]
            ,[UserId]
            ,[MasterId]
            ,[MasterType]
            ,[TransactionType]
            ,[TransactionAmount]
            ,[TransactionDate]
            ,[PaymentMethod]
            ,[ReferenceNumber]
            ,[Remarks]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
		)
		VALUES
		(
			 @RoundOffSavingId
            ,@UserId
            ,@MasterId
            ,@MasterType
            ,@TransactionType
            ,@TransactionAmount
            ,GETDATE()
            ,@PaymentMethod
            ,@ReferenceNumber
            ,@Remarks
			,@OtherDetail1
			,@OtherDetail2
			,@OtherDetail3
			,@OtherDetail4
			,@OtherDetail5
			,@OtherDetail6
			,1        
			,0        
			,@ActionUser
			,GETDATE()
			);

		SET @TransactionId = SCOPE_IDENTITY();

		SELECT 
			[TransactionId]
           ,[RoundOffSavingId]
           ,[UserId]
           ,[MasterId]
           ,[MasterType]
           ,[TransactionType]
           ,[TransactionAmount]
           ,[TransactionDate]
           ,[PaymentMethod]
           ,[ReferenceNumber]
           ,[Remarks]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [pl].[RoundOffTransaction] 
		WHERE [TransactionId] = @TransactionId;
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffTransaction_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[RoundOffTransaction_Delete]
(
   @TransactionId BIGINT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE  [pl].[RoundOffTransaction]
	SET 
		[IsActive] = 0 ,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE ()
	WHERE  [TransactionId] = @TransactionId
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffTransaction_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffTransaction_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [TransactionId]
      ,[RoundOffSavingId]
      ,[UserId]
      ,[MasterId]
      ,[MasterType]
      ,[TransactionType]
      ,[TransactionAmount]
      ,[TransactionDate]
      ,[PaymentMethod]
      ,[ReferenceNumber]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[RoundOffTransaction]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffTransaction_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffTransaction_ReadById]
(
   @TransactionId BIGINT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [TransactionId]
      ,[RoundOffSavingId]
      ,[UserId]
      ,[MasterId]
      ,[MasterType]
      ,[TransactionType]
      ,[TransactionAmount]
      ,[TransactionDate]
      ,[PaymentMethod]
      ,[ReferenceNumber]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[RoundOffTransaction]
	  WHERE  [TransactionId] = @TransactionId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffTransaction_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffTransaction_ReadByMasterId]
(
   @MasterId BIGINT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [TransactionId]
      ,[RoundOffSavingId]
      ,[UserId]
      ,[MasterId]
      ,[MasterType]
      ,[TransactionType]
      ,[TransactionAmount]
      ,[TransactionDate]
      ,[PaymentMethod]
      ,[ReferenceNumber]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[RoundOffTransaction]
	  WHERE  [MasterId] = @MasterId
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffTransaction_ReadByRoundOffSavingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffTransaction_ReadByRoundOffSavingId]
(
   @RoundOffSavingId BIGINT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [TransactionId]
      ,[RoundOffSavingId]
      ,[UserId]
      ,[MasterId]
      ,[MasterType]
      ,[TransactionType]
      ,[TransactionAmount]
      ,[TransactionDate]
      ,[PaymentMethod]
      ,[ReferenceNumber]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[RoundOffTransaction]
	  WHERE  [RoundOffSavingId] = @RoundOffSavingId
END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffTransaction_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[RoundOffTransaction_ReadByUserId]
(
   @UserId BIGINT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [TransactionId]
      ,[RoundOffSavingId]
      ,[UserId]
      ,[MasterId]
      ,[MasterType]
      ,[TransactionType]
      ,[TransactionAmount]
      ,[TransactionDate]
      ,[PaymentMethod]
      ,[ReferenceNumber]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [pl].[RoundOffTransaction]
	  WHERE  [UserId] = @UserId
	  AND IsDeleted = 0 AND IsActive = 1

	 SELECT  
		SUM(CASE WHEN TransactionType = 'CREDIT' THEN TransactionAmount ELSE 0 END) AS TotalSaving,
		SUM(CASE WHEN TransactionType = 'CREDIT' THEN TransactionAmount 
				 WHEN TransactionType = 'DEBIT'  THEN -TransactionAmount 
				 ELSE 0 END) AS AvailableSaving
	 FROM [pl].[RoundOffTransaction]
	 WHERE [UserId] = @UserId 
		AND IsDeleted = 0 
		AND IsActive = 1;

END;
GO
/****** Object:  StoredProcedure [pl].[RoundOffTransaction_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[RoundOffTransaction_Update]
(
    @TransactionId BIGINT,
	@RoundOffSavingId BIGINT,
	@UserId BIGINT,
	@MasterId BIGINT,
	@MasterType VARCHAR(100),
	@TransactionType VARCHAR(50),
	@TransactionAmount DECIMAL (18,2),
	@TransactionDate DATETIME,
	@PaymentMethod VARCHAR(50),
	@ReferenceNumber VARCHAR(100),
	@Remarks NVARCHAR(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[RoundOffTransaction]
    SET
        [RoundOffSavingId] = @RoundOffSavingId,
        [UserId] = @UserId,
        [MasterId] = @MasterId,
        [MasterType] = @MasterType,
        [TransactionType] = @TransactionType,
        [TransactionAmount] = @TransactionAmount,
        [TransactionDate] = @TransactionDate,
        [PaymentMethod] = @PaymentMethod,
        [ReferenceNumber] = @ReferenceNumber,
        [Remarks] = @Remarks,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE [TransactionId] = @TransactionId

    SELECT 
        [TransactionId],
        [RoundOffSavingId],
        [UserId],
        [MasterId],
        [MasterType],
        [TransactionType],
        [TransactionAmount],
        [TransactionDate],
        [PaymentMethod],
        [ReferenceNumber],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [pl].[RoundOffTransaction]
    WHERE [TransactionId] = @TransactionId

END;
GO
/****** Object:  StoredProcedure [pl].[ServiceProvider_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[ServiceProvider_Create]
(
      @ProviderCode     VARCHAR(50),
      @ProviderName     VARCHAR(200),
      @ProviderType     VARCHAR(100) = NULL,
      @BaseUrl          VARCHAR(500) = NULL,
      @EnvName          VARCHAR(100) = NULL,

      @OtherDetail1     VARCHAR(200) = NULL,
      @OtherDetail2     VARCHAR(200) = NULL,
      @OtherDetail3     VARCHAR(300) = NULL,
      @OtherDetail4     VARCHAR(300) = NULL,
      @OtherDetail5     VARCHAR(500) = NULL,
      @OtherDetail6     VARCHAR(500) = NULL,

      @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ServiceProviderId INT;

    INSERT INTO [pl].[ServiceProvider]
    (
          [ProviderCode]
        , [ProviderName]
        , [ProviderType]
        , [BaseUrl]
        , [EnvName]
        , [OtherDetail1]
        , [OtherDetail2]
        , [OtherDetail3]
        , [OtherDetail4]
        , [OtherDetail5]
        , [OtherDetail6]
        , [IsActive]
        , [IsDeleted]
        , [CreatedBy]
        , [CreatedOn]
    )
    VALUES
    (
          @ProviderCode
        , @ProviderName
        , @ProviderType
        , @BaseUrl
        , @EnvName
        , @OtherDetail1
        , @OtherDetail2
        , @OtherDetail3
        , @OtherDetail4
        , @OtherDetail5
        , @OtherDetail6
        , 1
        , 0
        , @ActionUser
        , GETDATE()
    );

    SET @ServiceProviderId = SCOPE_IDENTITY();

    SELECT
          [ServiceProviderId]
        , [ProviderCode]
        , [ProviderName]
        , [ProviderType]
        , [BaseUrl]
        , [EnvName]
        , [OtherDetail1]
        , [OtherDetail2]
        , [OtherDetail3]
        , [OtherDetail4]
        , [OtherDetail5]
        , [OtherDetail6]
        , [IsActive]
        , [IsDeleted]
        , CASE 
              WHEN IsDeleted = 1 THEN 'Inactive'
              WHEN IsActive = 1 THEN 'Active'
              ELSE 'Inactive'
          END AS [Status]
        , [CreatedBy]
        , [CreatedOn]
        , [ModifiedBy]
        , [ModifiedOn]
    FROM [pl].[ServiceProvider]
    WHERE [ServiceProviderId] = @ServiceProviderId;

END;
GO
/****** Object:  StoredProcedure [pl].[ServiceProvider_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceProvider_Delete]
(
    @ServiceProviderId INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[ServiceProvider]
    SET 
        [IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [ServiceProviderId] = @ServiceProviderId;
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceProvider_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceProvider_ReadAll]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
          [ServiceProviderId],
          [ProviderCode],
          [ProviderName],
          [ProviderType],
          [BaseUrl],
          [EnvName],
          [OtherDetail1],
          [OtherDetail2],
          [OtherDetail3],
          [OtherDetail4],
          [OtherDetail5],
          [OtherDetail6],
          [IsActive],
          [IsDeleted],
          [CreatedBy],
          [CreatedOn],
          [ModifiedBy],
          [ModifiedOn]
    FROM [pl].[ServiceProvider]
    WHERE [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceProvider_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceProvider_ReadById]
(
    @ServiceProviderId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
          [ServiceProviderId],
          [ProviderCode],
          [ProviderName],
          [ProviderType],
          [BaseUrl],
          [EnvName],
          [OtherDetail1],
          [OtherDetail2],
          [OtherDetail3],
          [OtherDetail4],
          [OtherDetail5],
          [OtherDetail6],
          [IsActive],
          [IsDeleted],
          [CreatedBy],
          [CreatedOn],
          [ModifiedBy],
          [ModifiedOn]
    FROM [pl].[ServiceProvider]
    WHERE [ServiceProviderId] = @ServiceProviderId;
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceProvider_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[ServiceProvider_Update]
(
      @ServiceProviderId   INT,
      @ProviderCode        VARCHAR(50),
      @ProviderName        VARCHAR(200),
      @ProviderType        VARCHAR(100) = NULL,
      @BaseUrl             VARCHAR(500) = NULL,
      @EnvName             VARCHAR(100) = NULL,

      @OtherDetail1        VARCHAR(200) = NULL,
      @OtherDetail2        VARCHAR(200) = NULL,
      @OtherDetail3        VARCHAR(300) = NULL,
      @OtherDetail4        VARCHAR(300) = NULL,
      @OtherDetail5        VARCHAR(500) = NULL,
      @OtherDetail6        VARCHAR(500) = NULL,

      @IsActive            INT,
      @ActionUser          VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[ServiceProvider]
    SET
          [ProviderCode]   = @ProviderCode,
          [ProviderName]   = @ProviderName,
          [ProviderType]   = @ProviderType,
          [BaseUrl]        = @BaseUrl,
          [EnvName]        = @EnvName,

          [OtherDetail1]   = @OtherDetail1,
          [OtherDetail2]   = @OtherDetail2,
          [OtherDetail3]   = @OtherDetail3,
          [OtherDetail4]   = @OtherDetail4,
          [OtherDetail5]   = @OtherDetail5,
          [OtherDetail6]   = @OtherDetail6,

          [IsActive]       = @IsActive,
          [ModifiedBy]     = @ActionUser,
          [ModifiedOn]     = GETDATE()
    WHERE [ServiceProviderId] = @ServiceProviderId
      AND [IsActive] = 1;


    SELECT 
          [ServiceProviderId],
          [ProviderCode],
          [ProviderName],
          [ProviderType],
          [BaseUrl],
          [EnvName],

          [OtherDetail1],
          [OtherDetail2],
          [OtherDetail3],
          [OtherDetail4],
          [OtherDetail5],
          [OtherDetail6],

          [IsActive],
          [IsDeleted],
          [CreatedBy],
          [CreatedOn],
          [ModifiedBy],
          [ModifiedOn]
    FROM [pl].[ServiceProvider]
    WHERE [ServiceProviderId] = @ServiceProviderId;

END
GO
/****** Object:  StoredProcedure [pl].[ServiceRequestLog_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
EXEC [pl].[ServiceRequestLog_Create]
      @ServiceProviderId = 1,
      @ServiceName = 'School',
      @EndpointUrl = 'string',
      @HttpMethod = 'POST',
      @RequestHeaders = NULL,
      @RequestBody = 'content',
      @CorrelationId = NULL,
      @MasterId = 100,
      @MasterType = 'School',
      @SourceSystem = 'API',
      @RequestedOn = '2025-04-25',     -- NO PROBLEM HERE
      @RequestTimeoutMs = 30000,
      @OtherDetail1 = 'NULL',
      @OtherDetail2 = 'NULL',
      @OtherDetail3 = NULL,
      @OtherDetail4 = NULL,
      @OtherDetail5 = NULL,
      @OtherDetail6 = NULL,
      @ActionUser = 'Vaibhav';




*/

CREATE PROCEDURE [pl].[ServiceRequestLog_Create]
(
      @ServiceProviderId     INT,
      @ServiceName           VARCHAR(200) = NULL,
      @EndpointUrl           VARCHAR(1000) = NULL,
      @HttpMethod            VARCHAR(10) = NULL,
      @RequestHeaders        NVARCHAR(MAX) = NULL,
      @RequestBody           NVARCHAR(MAX) = NULL,
      @CorrelationId         VARCHAR(100)= NULL,
      @MasterId              INT  = NULL,
      @MasterType            VARCHAR(50),
      @SourceSystem          VARCHAR(100) = NULL,
      @RequestedOn           DATETIME ,
      @RequestTimeoutMs      INT = NULL,
      @OtherDetail1          VARCHAR(200) = NULL,
      @OtherDetail2          VARCHAR(200) = NULL,
      @OtherDetail3          VARCHAR(300) = NULL,
      @OtherDetail4          VARCHAR(300) = NULL,
      @OtherDetail5          VARCHAR(500) = NULL,
      @OtherDetail6          VARCHAR(500) = NULL,
      @ActionUser            VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RequestLogId BIGINT;

    

    INSERT INTO [pl].[ServiceRequestLog]
    (
          [ServiceProviderId]
        , [ServiceName]
        , [EndpointUrl]
        , [HttpMethod]
        , [RequestHeaders]
        , [RequestBody]
        , [CorrelationId]
        , [MasterId]
        , [MasterType]
        , [SourceSystem]
        , [RequestedOn]
        , [RequestTimeoutMs]
        , [OtherDetail1]
        , [OtherDetail2]
        , [OtherDetail3]
        , [OtherDetail4]
        , [OtherDetail5]
        , [OtherDetail6]
        , [IsActive]
        , [IsDeleted]
        , [CreatedBy]
        , [CreatedOn]
    )
    VALUES
    (
          @ServiceProviderId
        , @ServiceName
        , @EndpointUrl
        , @HttpMethod
        , @RequestHeaders
        , @RequestBody
        , @CorrelationId
        , @MasterId
        , @MasterType
        , @SourceSystem
        , @RequestedOn
        , @RequestTimeoutMs
        , @OtherDetail1
        , @OtherDetail2
        , @OtherDetail3
        , @OtherDetail4
        , @OtherDetail5
        , @OtherDetail6
        , 1
        , 0
        , @ActionUser
        , GETDATE()
    );

    SET @RequestLogId = SCOPE_IDENTITY();

    SELECT 
          [RequestLogId]
        , [ServiceProviderId]
        , [ServiceName]
        , [EndpointUrl]
        , [HttpMethod]
        , [RequestHeaders]
        , [RequestBody]
        , [CorrelationId]
        , [MasterId]
        , [MasterType]
        , [SourceSystem]
        , [RequestedOn]
        , [RequestTimeoutMs]
        , [OtherDetail1]
        , [OtherDetail2]
        , [OtherDetail3]
        , [OtherDetail4]
        , [OtherDetail5]
        , [OtherDetail6]
        , [IsActive]
        , [IsDeleted]
        , [CreatedBy]
        , [CreatedOn]
        , [ModifiedBy]
        , [ModifiedOn]
    FROM [pl].[ServiceRequestLog]
    WHERE [RequestLogId] = @RequestLogId;

END;
GO
/****** Object:  StoredProcedure [pl].[ServiceRequestLog_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceRequestLog_Delete]
(
  @RequestLogId BIGINT,
  @ActionUser VARCHAR(50)

)
AS
 BEGIN
  SET NOCOUNT ON;
UPDATE [pl].[ServiceRequestLog]
	   SET	
			[IsActive] = 0,
			[IsDeleted] = 1,
		    [ModifiedBy] = @ActionUser,
		    [ModifiedOn] = GETDATE()
	  WHERE [RequestLogId] =  @RequestLogId
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceRequestLog_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceRequestLog_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
	   [RequestLogId]
      ,[ServiceProviderId]
      ,[ServiceName]
      ,[EndpointUrl]
      ,[HttpMethod]
      ,[RequestHeaders]
      ,[RequestBody]
      ,[CorrelationId]
      ,[MasterId]
      ,[MasterType]
      ,[SourceSystem]
      ,[RequestedOn]
      ,[RequestTimeoutMs]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM  [pl].[ServiceRequestLog]
	  WHERE IsDeleted = 0
	     AND[IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceRequestLog_ReadByRequestLogId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceRequestLog_ReadByRequestLogId]
(
  @RequestLogId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [ServiceProviderId]
      ,[ServiceName]
      ,[EndpointUrl]
      ,[HttpMethod]
      ,[RequestHeaders]
      ,[RequestBody]
      ,[CorrelationId]
      ,[MasterId]
      ,[MasterType]
      ,[SourceSystem]
      ,[RequestedOn]
      ,[RequestTimeoutMs]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM  [pl].[ServiceRequestLog]
	  WHERE [RequestLogId]= @RequestLogId
	  AND IsDeleted = 0
	  AND[IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceRequestLog_ReadByServiceProviderId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceRequestLog_ReadByServiceProviderId]
(
  @ServiceProviderId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT 
       [RequestLogId]
      ,[ServiceName]
      ,[EndpointUrl]
      ,[HttpMethod]
      ,[RequestHeaders]
      ,[RequestBody]
      ,[CorrelationId]
      ,[MasterId]
      ,[MasterType]
      ,[SourceSystem]
      ,[RequestedOn]
      ,[RequestTimeoutMs]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM  [pl].[ServiceRequestLog]
	  WHERE [ServiceProviderId]= @ServiceProviderId
	  AND IsDeleted = 0
	  AND[IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceRequestLog_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [pl].[ServiceRequestLog_Update]
(
      @RequestLogId        BIGINT,
      @ServiceProviderId   INT,
      @ServiceName         VARCHAR(200),
      @EndpointUrl         VARCHAR(1000),
      @HttpMethod          VARCHAR(10),
      @RequestHeaders      NVARCHAR(MAX),
      @RequestBody         NVARCHAR(MAX),
      @CorrelationId       VARCHAR(100),
      @MasterId            INT,
      @MasterType          VARCHAR(50),
      @SourceSystem        VARCHAR(100),
      @RequestedOn         DATETIME2(3),
      @RequestTimeoutMs    INT,
      @OtherDetail1        VARCHAR(200),
      @OtherDetail2        VARCHAR(200),
      @OtherDetail3        VARCHAR(300),
      @OtherDetail4        VARCHAR(300),
      @OtherDetail5        VARCHAR(500),
      @OtherDetail6        VARCHAR(500),
      @IsActive            INT,
      @ActionUser          VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[ServiceRequestLog]
    SET
          [ServiceProviderId] = @ServiceProviderId,
          [ServiceName]       = @ServiceName,
          [EndpointUrl]       = @EndpointUrl,
          [HttpMethod]        = @HttpMethod,
          [RequestHeaders]    = @RequestHeaders,
          [RequestBody]       = @RequestBody,
          [CorrelationId]     = @CorrelationId,
          [MasterId]          = @MasterId,
          [MasterType]        = @MasterType,
          [SourceSystem]      = @SourceSystem,
          [RequestedOn]       = @RequestedOn,
          [RequestTimeoutMs]  = @RequestTimeoutMs,
          [OtherDetail1]      = @OtherDetail1,
          [OtherDetail2]      = @OtherDetail2,
          [OtherDetail3]      = @OtherDetail3,
          [OtherDetail4]      = @OtherDetail4,
          [OtherDetail5]      = @OtherDetail5,
          [OtherDetail6]      = @OtherDetail6,
          [IsActive]          = @IsActive,
          [ModifiedBy]        = @ActionUser,
          [ModifiedOn]        = GETDATE()
    WHERE [RequestLogId] = @RequestLogId AND [IsActive] = 1;


    SELECT
          [RequestLogId],
          [ServiceProviderId],
          [ServiceName],
          [EndpointUrl],
          [HttpMethod],
          [RequestHeaders],
          [RequestBody],
          [CorrelationId],
          [MasterId],
          [MasterType],
          [SourceSystem],
          [RequestedOn],
          [RequestTimeoutMs],
          [OtherDetail1],
          [OtherDetail2],
          [OtherDetail3],
          [OtherDetail4],
          [OtherDetail5],
          [OtherDetail6],
          [IsActive],
          [IsDeleted],
          [CreatedBy],
          [CreatedOn],
          [ModifiedBy],
          [ModifiedOn]
    FROM [pl].[ServiceRequestLog]
    WHERE [RequestLogId] = @RequestLogId;

END;
GO
/****** Object:  StoredProcedure [pl].[ServiceResponseLog_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [pl].[ServiceResponseLog_Create]
(
      @RequestLogId        BIGINT,
      @HttpStatusCode      INT            = NULL,
      @IsSuccess           INT,
      @ErrorCode           VARCHAR(100)   = NULL,
      @ErrorMessage        NVARCHAR(1000) = NULL,
      @ResponseHeaders     NVARCHAR(MAX)  = NULL,
      @ResponseBody        NVARCHAR(MAX)  = NULL,
      @RespondedOn         DATETIME2(3)   = NULL,
      @DurationMs          INT            = NULL,
      @RetryAttemptNo      INT            = NULL,
      @OtherDetail1        VARCHAR(200)   = NULL,
      @OtherDetail2        VARCHAR(200)   = NULL,
      @OtherDetail3        VARCHAR(300)   = NULL,
      @OtherDetail4        VARCHAR(300)   = NULL,
      @OtherDetail5        VARCHAR(500)   = NULL,
      @OtherDetail6        VARCHAR(500)   = NULL,
      @ActionUser          VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ResponseLogId BIGINT;

    INSERT INTO [pl].[ServiceResponseLog]
    (
          [RequestLogId]
        , [HttpStatusCode]
        , [IsSuccess]
        , [ErrorCode]
        , [ErrorMessage]
        , [ResponseHeaders]
        , [ResponseBody]
        , [RespondedOn]
        , [DurationMs]
        , [RetryAttemptNo]
        , [OtherDetail1]
        , [OtherDetail2]
        , [OtherDetail3]
        , [OtherDetail4]
        , [OtherDetail5]
        , [OtherDetail6]
        , [IsActive]
        , [IsDeleted]
        , [CreatedBy]
        , [CreatedOn]
    )
    VALUES
    (
          @RequestLogId
        , @HttpStatusCode
        , @IsSuccess
        , @ErrorCode
        , @ErrorMessage
        , @ResponseHeaders
        , @ResponseBody
        , @RespondedOn
        , @DurationMs
        , @RetryAttemptNo
        , @OtherDetail1
        , @OtherDetail2
        , @OtherDetail3
        , @OtherDetail4
        , @OtherDetail5
        , @OtherDetail6
        , 1
        , 0
        , @ActionUser
        , GETDATE()
    );

    SET @ResponseLogId = SCOPE_IDENTITY();

    SELECT
          [ResponseLogId]
        , [RequestLogId]
        , [HttpStatusCode]
        , [IsSuccess]
        , [ErrorCode]
        , [ErrorMessage]
        , [ResponseHeaders]
        , [ResponseBody]
        , [RespondedOn]
        , [DurationMs]
        , [RetryAttemptNo]
        , [OtherDetail1]
        , [OtherDetail2]
        , [OtherDetail3]
        , [OtherDetail4]
        , [OtherDetail5]
        , [OtherDetail6]
        , [IsActive]
        , [IsDeleted]
        , [CreatedBy]
        , [CreatedOn]
        , [ModifiedBy]
        , [ModifiedOn]
    FROM [pl].[ServiceResponseLog]
    WHERE [ResponseLogId] = @ResponseLogId;

END;
GO
/****** Object:  StoredProcedure [pl].[ServiceResponseLog_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceResponseLog_Delete]
(
  @ResponseLogId  BIGINT,
  @ActionUser VARCHAR(50)
)
AS
 BEGIN
  SET NOCOUNT ON;
UPDATE [pl].[ServiceResponseLog]
	   SET	
			[IsActive] = 0,
			[IsDeleted] = 1,
		    [ModifiedBy] = @ActionUser,
		    [ModifiedOn] = GETDATE()
	  WHERE [ResponseLogId] =  @ResponseLogId
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceResponseLog_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceResponseLog_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT
       [ResponseLogId]
      ,[RequestLogId]
      ,[HttpStatusCode]
      ,[IsSuccess]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[ResponseHeaders]
      ,[ResponseBody]
      ,[RespondedOn]
      ,[DurationMs]
      ,[RetryAttemptNo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM  [pl].[ServiceResponsetLog]
	  WHERE IsDeleted = 0
	     AND[IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceResponseLog_ReadByResponseLogId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceResponseLog_ReadByResponseLogId]
(
  @ResponseLogId  BIGINT
)
AS
 BEGIN
  SET NOCOUNT ON;
  SELECT      
       [RequestLogId]
      ,[HttpStatusCode]
      ,[IsSuccess]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[ResponseHeaders]
      ,[ResponseBody]
      ,[RespondedOn]
      ,[DurationMs]
      ,[RetryAttemptNo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM  [pl].[ServiceResponsetLog]
	  WHERE [ResponseLogId] = @ResponseLogId
	     AND IsDeleted = 0
	     AND[IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [pl].[ServiceResponseLog_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [pl].[ServiceResponseLog_Update]
(
      @ResponseLogId      BIGINT,
      @RequestLogId       BIGINT,
      @HttpStatusCode     INT,
      @IsSuccess          INT,
      @ErrorCode          VARCHAR(100),
      @ErrorMessage       NVARCHAR(1000),
      @ResponseHeaders    NVARCHAR(MAX),
      @ResponseBody       NVARCHAR(MAX),
      @RespondedOn        DATETIME2(3),
      @DurationMs         INT,
      @RetryAttemptNo     INT,

      @OtherDetail1       VARCHAR(200),
      @OtherDetail2       VARCHAR(200),
      @OtherDetail3       VARCHAR(300),
      @OtherDetail4       VARCHAR(300),
      @OtherDetail5       VARCHAR(500),
      @OtherDetail6       VARCHAR(500),

      @IsActive           INT,
      @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [pl].[ServiceResponseLog]
    SET
          [RequestLogId]     = @RequestLogId,
          [HttpStatusCode]   = @HttpStatusCode,
          [IsSuccess]        = @IsSuccess,
          [ErrorCode]        = @ErrorCode,
          [ErrorMessage]     = @ErrorMessage,
          [ResponseHeaders]  = @ResponseHeaders,
          [ResponseBody]     = @ResponseBody,
          [RespondedOn]      = @RespondedOn,
          [DurationMs]       = @DurationMs,
          [RetryAttemptNo]   = @RetryAttemptNo,
          [OtherDetail1]     = @OtherDetail1,
          [OtherDetail2]     = @OtherDetail2,
          [OtherDetail3]     = @OtherDetail3,
          [OtherDetail4]     = @OtherDetail4,
          [OtherDetail5]     = @OtherDetail5,
          [OtherDetail6]     = @OtherDetail6,
          [IsActive]         = @IsActive,
          [ModifiedBy]       = @ActionUser,
          [ModifiedOn]       = GETDATE()
    WHERE [ResponseLogId] = @ResponseLogId AND [IsActive] = 1;

    SELECT 
	   [ResponseLogId]
      ,[RequestLogId]
      ,[HttpStatusCode]
      ,[IsSuccess]
      ,[ErrorCode]
      ,[ErrorMessage]
      ,[ResponseHeaders]
      ,[ResponseBody]
      ,[RespondedOn]
      ,[DurationMs]
      ,[RetryAttemptNo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [pl].[ServiceResponseLog]
    WHERE [ResponseLogId] = @ResponseLogId;

END;
GO
/****** Object:  StoredProcedure [pl].[UserKYC_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[UserKYC_Create]
(
    @UserId             INT,
    @CareOf            NVARCHAR(255),
    @FullAddress       NVARCHAR(MAX),
    @DateOfBirth       DATE,
    @YearOfBirth       INT,
    @Email             NVARCHAR(255),
    @Mobile            NVARCHAR(255),
    @Gender            NVARCHAR(10),
    @Name              NVARCHAR(255),
    @AadharNumber      NVARCHAR(255),
    @PanNumber         NVARCHAR(255),
    @Photo             NVARCHAR(MAX),
    @ShareCode         NVARCHAR(50),
    @Country           NVARCHAR(100),
    @State             NVARCHAR(100),
    @District          NVARCHAR(100),
    @SubDistrict       NVARCHAR(100),
    @VTC               NVARCHAR(100),
    @Street            NVARCHAR(255),
    @House             NVARCHAR(255),
    @Landmark          NVARCHAR(255),
    @PostOffice        NVARCHAR(255),
    @Pincode           NVARCHAR(20),
    @IsAadharVerified  INT,
    @IsPanVerified     INT,
	@Relation          VARCHAR(50),
	@MonthlyIncome     DECIMAL(18,2),
	@OccupationType    VARCHAR(50),
	@EmploymentType    VARCHAR(50),
	@AadhaarXML        VARCHAR(20),
	@PanXML        VARCHAR(20),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
		SET NOCOUNT ON;

		DECLARE @KycId INT;

		INSERT INTO [pl].[UserKYC]
		(
			 [UserId]
			,[CareOf]
			,[FullAddress]
			,[DateOfBirth]
			,[YearOfBirth]
			,[Email]
			,[Mobile]
			,[Gender]
			,[Name]
			,[AadharNumber]
			,[PanNumber]
			,[Photo]
			,[ShareCode]
			,[Country]
			,[State]
			,[District]
			,[SubDistrict]
			,[VTC]
			,[Street]
			,[House]
			,[Landmark]
			,[PostOffice]
			,[Pincode]
			,[IsAadharVerified]
			,[IsPanVerified]
			,[Relation]
			,[MonthlyIncome]
	        ,[OccupationType]
	        ,[EmploymentType]
			,[AadhaarXML]
            ,[PanXML]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
		)
		VALUES
		(
			 @UserId
			,@CareOf
			,@FullAddress
			,@DateOfBirth
			,@YearOfBirth
			,@Email
			,@Mobile
			,@Gender
			,@Name
			,@AadharNumber
			,@PanNumber
			,@Photo
			,@ShareCode
			,@Country
			,@State
			,@District
			,@SubDistrict
			,@VTC
			,@Street
			,@House
			,@Landmark
			,@PostOffice
			,@Pincode
			,@IsAadharVerified
			,@IsPanVerified
			,@Relation
			,@MonthlyIncome
			,@OccupationType
			,@EmploymentType
			,@AadhaarXML
			,@PanXML
			,@OtherDetail1
			,@OtherDetail2
			,@OtherDetail3
			,@OtherDetail4
			,@OtherDetail5
			,@OtherDetail6
			,1        
			,0        
			,@ActionUser
			,GETDATE()
			);

		SET @KycId = SCOPE_IDENTITY();

		SELECT 
			 [KycId]
			,[UserId]
			,[CareOf]
			,[FullAddress]
			,[DateOfBirth]
			,[YearOfBirth]
			,[Email]
			,[Mobile]
			,[Gender]
			,[Name]
			,[AadharNumber]
			,[PanNumber]
			,[Photo]
			,[ShareCode]
			,[Country]
			,[State]
			,[District]
			,[SubDistrict]
			,[VTC]
			,[Street]
			,[House]
			,[Landmark]
			,[PostOffice]
			,[Pincode]
			,[IsAadharVerified]
			,[Relation]
			,[IsPanVerified]
			,[MonthlyIncome]
	        ,[OccupationType]
	        ,[EmploymentType]
			,[AadhaarXML]
            ,[PanXML]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [pl].[UserKYC] 
		WHERE [KycId] = @KycId;
END;
GO
/****** Object:  StoredProcedure [pl].[UserKYC_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[UserKYC_Delete]
(
   @KYCId INT,
   @ActionUser varchar(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [pl].[UserKYC]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [KYCId] = @KYCId
END;
GO
/****** Object:  StoredProcedure [pl].[UserKYC_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [pl].[UserKYC_ReadAll]
AS
BEGIN
 SET NOCOUNT ON;
  SELECT
		   [KycId]
		  ,[UserId]
		  ,[CareOf]
		  ,[FullAddress]
		  ,[DateOfBirth]
		  ,[YearOfBirth]
		  ,[Email]
		  ,[Mobile]
		  ,[Gender]
		  ,[Name]
		  ,[AadharNumber]
		  ,[PanNumber]
		  ,[Photo]
		  ,[ShareCode]
		  ,[Country]
		  ,[State]
		  ,[District]
		  ,[SubDistrict]
		  ,[VTC]
		  ,[Street]
		  ,[House]
		  ,[Landmark]
		  ,[PostOffice]
		  ,[Pincode]
		  ,[IsAadharVerified]
		  ,[IsPanVerified]
		  ,[Relation]
		  ,[MonthlyIncome]
	      ,[OccupationType]
	      ,[EmploymentType]
		  ,[AadhaarXML]
          ,[PanXML]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
          ,[ModifiedOn]
		FROM [pl].[UserKYC]
		WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[UserKYC_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[UserKYC_ReadById]
(
   @KYCId INT
)
AS
BEGIN
 SET NOCOUNT ON;
  SELECT
		   [KycId]
		  ,[UserId]
		  ,[CareOf]
		  ,[FullAddress]
		  ,[DateOfBirth]
		  ,[YearOfBirth]
		  ,[Email]
		  ,[Mobile]
		  ,[Gender]
		  ,[Name]
		  ,[AadharNumber]
		  ,[PanNumber]
		  ,[Photo]
		  ,[ShareCode]
		  ,[Country]
		  ,[State]
		  ,[District]
		  ,[SubDistrict]
		  ,[VTC]
		  ,[Street]
		  ,[House]
		  ,[Landmark]
		  ,[PostOffice]
		  ,[Pincode]
		  ,[IsAadharVerified]
		  ,[IsPanVerified]
		  ,[Relation]
		  ,[MonthlyIncome]
		  ,[OccupationType]
		  ,[EmploymentType]
		  ,[AadhaarXML]
          ,[PanXML]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		FROM [pl].[UserKYC]
		WHERE [KYCId] = @KYCId
		AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[UserKYC_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[UserKYC_ReadByUserId]
(
   @UserId INT
)
AS
BEGIN
 SET NOCOUNT ON;
  SELECT
		   [KycId]
		  ,[UserId]
		  ,[CareOf]
		  ,[FullAddress]
		  ,[DateOfBirth]
		  ,[YearOfBirth]
		  ,[Email]
		  ,[Mobile]
		  ,[Gender]
		  ,[Name]
		  ,[AadharNumber]
		  ,[PanNumber]
		  ,[Photo]
		  ,[ShareCode]
		  ,[Country]
		  ,[State]
		  ,[District]
		  ,[SubDistrict]
		  ,[VTC]
		  ,[Street]
		  ,[House]
		  ,[Landmark]
		  ,[PostOffice]
		  ,[Pincode]
		  ,[IsAadharVerified]
		  ,[IsPanVerified]
		  ,[Relation]
		  ,[MonthlyIncome]
		  ,[OccupationType]
		  ,[EmploymentType]
		  ,[AadhaarXML]
          ,[PanXML]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		FROM [pl].[UserKYC]
		WHERE [UserId] = @UserId
		AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [pl].[UserKYC_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [pl].[UserKYC_Update]
(
			@KycId              INT,
			@UserId             INT,
			@CareOf             NVARCHAR(255),
			@FullAddress        NVARCHAR(MAX),
			@DateOfBirth        DATE,
			@YearOfBirth        INT,
			@Email              NVARCHAR(255),
			@Mobile             NVARCHAR(255),
			@Gender             NVARCHAR(10),
			@Name               NVARCHAR(255),
			@AadharNumber       NVARCHAR(255),
			@PanNumber          NVARCHAR(255),
			@Photo              NVARCHAR(MAX),
			@ShareCode          NVARCHAR(50),
			@Country            NVARCHAR(100),
			@State              NVARCHAR(100),
			@District           NVARCHAR(100),
			@SubDistrict        NVARCHAR(100),
			@VTC                NVARCHAR(100),
			@Street             NVARCHAR(255),
			@House              NVARCHAR(255),
			@Landmark           NVARCHAR(255),
			@PostOffice         NVARCHAR(255),
			@Pincode            NVARCHAR(20),
			@IsAadharVerified   INT,
			@IsPanVerified      INT,
			@Relation           VARCHAR(50),
			@MonthlyIncome     DECIMAL(18,2),
			@OccupationType    VARCHAR(50),
			@EmploymentType    VARCHAR(50),
			@AadhaarXML        VARCHAR(20),
			@PanXML            VARCHAR(20),
			@OtherDetail1       VARCHAR(50),
			@OtherDetail2       VARCHAR(50),
			@OtherDetail3       VARCHAR(100),
			@OtherDetail4       VARCHAR(100),
			@OtherDetail5       VARCHAR(500),
			@OtherDetail6       VARCHAR(500),
			@IsActive           INT,
			@ActionUser         VARCHAR(50)
)
AS
BEGIN
		SET NOCOUNT ON;

		UPDATE [pl].[UserKYC]
		SET
			 [UserId]            = @UserId
			,[CareOf]            = @CareOf
			,[FullAddress]       = @FullAddress
			,[DateOfBirth]       = @DateOfBirth
			,[YearOfBirth]       = @YearOfBirth
			,[Email]             = @Email
			,[Mobile]            = @Mobile
			,[Gender]            = @Gender
			,[Name]              = @Name
			,[AadharNumber]      = @AadharNumber
			,[PanNumber]         = @PanNumber
			,[Photo]             = @Photo
			,[ShareCode]         = @ShareCode
			,[Country]           = @Country
			,[State]             = @State
			,[District]          = @District
			,[SubDistrict]       = @SubDistrict
			,[VTC]               = @VTC
			,[Street]            = @Street
			,[House]             = @House
			,[Landmark]          = @Landmark
			,[PostOffice]        = @PostOffice
			,[Pincode]           = @Pincode
			,[IsAadharVerified]  = @IsAadharVerified
			,[IsPanVerified]     = @IsPanVerified
			,[Relation]          = @Relation
			,[MonthlyIncome]	 = @MonthlyIncome
			,[OccupationType]	 = @OccupationType
			,[EmploymentType]	 = @EmploymentType
			,[AadhaarXML]	     = @AadhaarXML
			,[PanXML]	         = @PanXML
			,[OtherDetail1]      = @OtherDetail1
			,[OtherDetail2]      = @OtherDetail2
			,[OtherDetail3]      = @OtherDetail3
			,[OtherDetail4]      = @OtherDetail4
			,[OtherDetail5]      = @OtherDetail5
			,[OtherDetail6]      = @OtherDetail6
			,[IsActive]          = @IsActive
			,[ModifiedBy]        = @ActionUser
			,[ModifiedOn]        = GETDATE()
		WHERE
		[KycId] = @KycId ;

		SELECT 
			 [KycId]
			,[UserId]
			,[CareOf]
			,[FullAddress]
			,[DateOfBirth]
			,[YearOfBirth]
			,[Email]
			,[Mobile]
			,[Gender]
			,[Name]
			,[AadharNumber]
			,[PanNumber]
			,[Photo]
			,[ShareCode]
			,[Country]
			,[State]
			,[District]
			,[SubDistrict]
			,[VTC]
			,[Street]
			,[House]
			,[Landmark]
			,[PostOffice]
			,[Pincode]
			,[IsAadharVerified]
			,[IsPanVerified]
			,[Relation]
			,[MonthlyIncome]
			,[OccupationType]
			,[EmploymentType]
			,[AadhaarXML]
            ,[PanXML]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [pl].[UserKYC] 
		WHERE [KycId] = @KycId
		AND [IsDeleted] = 0
		AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [print].[DynamicSQL]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [print].[DynamicSQL]
(
	@DynamicSQL NVARCHAR(MAX)
)
AS
BEGIN
	SET NOCOUNT ON;

    EXECUTE AS LOGIN = 'NishwikReadOnlyLogin';

    BEGIN TRY
        EXEC (@DynamicSQL);
    END TRY
    BEGIN CATCH
        REVERT;
        THROW;
    END CATCH;

    REVERT;
END
GO
/****** Object:  StoredProcedure [re].[AmenitiesMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [re].[AmenitiesMaster_Create]
(
    @AmenityName       VARCHAR(100)  = NULL,
    @AmenityCategory   VARCHAR(50)   = NULL,
    @IconPath          VARCHAR(50)   = NULL,
    @Description       VARCHAR(500)  = NULL,
    @OtherDetail1      VARCHAR(50)   = NULL,
    @OtherDetail2      VARCHAR(50)   = NULL,
    @OtherDetail3      VARCHAR(100)  = NULL,
    @OtherDetail4      VARCHAR(100)  = NULL,
    @OtherDetail5      VARCHAR(500)  = NULL,
    @OtherDetail6      VARCHAR(500)  = NULL,
    @ActionUser        VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AmenityId BIGINT;

    INSERT INTO [re].[AmenitiesMaster]
    (
        [AmenityName],
        [AmenityCategory],
        [IconPath],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        TRIM(@AmenityName),
        TRIM(@AmenityCategory),
        TRIM(@IconPath),
        TRIM(@Description),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @AmenityId = SCOPE_IDENTITY();

    SELECT 
        [AmenityId],
        [AmenityName],
        [AmenityCategory],
        [IconPath],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[AmenitiesMaster]
    WHERE [AmenityId] = @AmenityId;
END
GO
/****** Object:  StoredProcedure [re].[AmenitiesMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[AmenitiesMaster_Delete]
(
   @AmenityId BIGINT,
   @ActionUser VARCHAR (50)
)
AS
 BEGIN
	UPDATE[re].[AmenitiesMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [AmenityId] = @AmenityId
END;
GO
/****** Object:  StoredProcedure [re].[AmenitiesMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[AmenitiesMaster_ReadAll]
AS
 BEGIN
     SELECT
		 [AmenityId]
		,[AmenityName]
		,[AmenityCategory]
		,[IconPath]
		,[Description]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		FROM [re].[AmenitiesMaster]
		WHERE [IsActive]= 1
		AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [re].[AmenitiesMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[AmenitiesMaster_ReadById]
(
   @AmenityId BIGINT
)
AS
 BEGIN
     SELECT
		 [AmenityId]
		,[AmenityName]
		,[AmenityCategory]
		,[IconPath]
		,[Description]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		FROM [re].[AmenitiesMaster]
		WHERE [AmenityId] = @AmenityId
		AND  [IsActive]= 1
		AND [IsDeleted] =0
END;
GO
/****** Object:  StoredProcedure [re].[AmenitiesMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[AmenitiesMaster_Update]
(
    @AmenityId        BIGINT,
    @AmenityName      VARCHAR(100)  = NULL,
    @AmenityCategory  VARCHAR(50)   = NULL,
    @IconPath         VARCHAR(50)   = NULL,
    @Description      VARCHAR(500)  = NULL,
    @OtherDetail1     VARCHAR(50)   = NULL,
    @OtherDetail2     VARCHAR(50)   = NULL,
    @OtherDetail3     VARCHAR(100)  = NULL,
    @OtherDetail4     VARCHAR(100)  = NULL,
    @OtherDetail5     VARCHAR(500)  = NULL,
    @OtherDetail6     VARCHAR(500)  = NULL,
    @IsActive         INT           = NULL,
    @ActionUser       VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[AmenitiesMaster]
    SET 
        [AmenityName]     = TRIM(@AmenityName),
        [AmenityCategory] = TRIM(@AmenityCategory),
        [IconPath]        = TRIM(@IconPath),
        [Description]     = TRIM(@Description),
        [OtherDetail1]    = TRIM(@OtherDetail1),
        [OtherDetail2]    = TRIM(@OtherDetail2),
        [OtherDetail3]    = TRIM(@OtherDetail3),
        [OtherDetail4]    = TRIM(@OtherDetail4),
        [OtherDetail5]    = TRIM(@OtherDetail5),
        [OtherDetail6]    = TRIM(@OtherDetail6),
        [IsActive]        = @IsActive,
        [ModifiedBy]      = TRIM(@ActionUser),
        [ModifiedOn]      = GETDATE()
    WHERE [AmenityId] = @AmenityId;

    SELECT 
        [AmenityId],
        [AmenityName],
        [AmenityCategory],
        [IconPath],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[AmenitiesMaster]
    WHERE [AmenityId] = @AmenityId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [re].[BankMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BankMaster_Create]
(
    @MasterType           VARCHAR(50),
    @MasterId             INT,
    @AccountHolderName    VARCHAR(100),
    @BankName             VARCHAR(100),
    @AccountNo            VARCHAR(50),
    @AccountType          VARCHAR(50),
    @BranchName           VARCHAR(100),
    @IFSCCode             VARCHAR(50),
    @Address              VARCHAR(500),
    @Contact              VARCHAR(200),
    @IsDefault            INT,
    @IsVerified           INT,
    @OtherDetail1         VARCHAR(50),
    @OtherDetail2         VARCHAR(50),
    @OtherDetail3         VARCHAR(100),
    @OtherDetail4         VARCHAR(100),
    @OtherDetail5         VARCHAR(500),
    @OtherDetail6         VARCHAR(500),
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BankId INT;

    INSERT INTO [re].[BankMaster]
    (
         [MasterType]
        ,[MasterId]
        ,[AccountHolderName]
        ,[BankName]
        ,[AccountNo]
        ,[AccountType]
        ,[BranchName]
        ,[IFSCCode]
        ,[Address]
        ,[Contact]
        ,[IsDefault]
        ,[IsVerified]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @MasterType
        ,@MasterId
        ,@AccountHolderName
        ,@BankName
        ,@AccountNo
        ,@AccountType
        ,@BranchName
        ,@IFSCCode
        ,@Address
        ,@Contact
        ,@IsDefault
        ,@IsVerified
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1               
        ,0               
        ,@ActionUser     
        ,GETDATE()       
    );

    SET @BankId = SCOPE_IDENTITY();

    -- Return the inserted row
    SELECT 
         [BankId]
        ,[MasterType]
        ,[MasterId]
        ,[AccountHolderName]
        ,[BankName]
        ,[AccountNo]
        ,[AccountType]
        ,[BranchName]
        ,[IFSCCode]
        ,[Address]
        ,[Contact]
        ,[IsDefault]
        ,[IsVerified]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[BankMaster]
    WHERE [BankId] = @BankId;
END;
GO
/****** Object:  StoredProcedure [re].[BankMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BankMaster_Delete]
(
   @BankId INT,
   @ActionUser  VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [re].[BankMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [BankId]  = @BankId
END;
GO
/****** Object:  StoredProcedure [re].[BankMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BankMaster_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [BankId]
      ,[MasterType]
      ,[MasterId]
      ,[AccountHolderName]
      ,[BankName]
      ,[AccountNo]
      ,[AccountType]
      ,[BranchName]
      ,[IFSCCode]
      ,[Address]
      ,[Contact]
      ,[IsDefault]
      ,[IsVerified]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[BankMaster]
	  WHERE [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[BankMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BankMaster_ReadById]
(
   @BankId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [BankId]
      ,[MasterType]
      ,[MasterId]
      ,[AccountHolderName]
      ,[BankName]
      ,[AccountNo]
      ,[AccountType]
      ,[BranchName]
      ,[IFSCCode]
      ,[Address]
      ,[Contact]
      ,[IsDefault]
      ,[IsVerified]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[BankMaster]
	  WHERE [BankId]  = @BankId
	  AND   [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[BankMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BankMaster_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [BankId]
      ,[MasterType]
      ,[MasterId]
      ,[AccountHolderName]
      ,[BankName]
      ,[AccountNo]
      ,[AccountType]
      ,[BranchName]
      ,[IFSCCode]
      ,[Address]
      ,[Contact]
      ,[IsDefault]
      ,[IsVerified]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[BankMaster]
	  WHERE [MasterId]  = @MasterId
	  AND [MasterType]  = @MasterType
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[BankMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BankMaster_Update]
(
    @BankId               INT,
    @MasterType           VARCHAR(50),
    @MasterId             INT,
    @AccountHolderName    VARCHAR(100),
    @BankName             VARCHAR(100),
    @AccountNo            VARCHAR(50),
    @AccountType          VARCHAR(50),
    @BranchName           VARCHAR(100),
    @IFSCCode             VARCHAR(50),
    @Address              VARCHAR(500),
    @Contact              VARCHAR(200),
    @IsDefault            INT,
    @IsVerified           INT,
    @OtherDetail1         VARCHAR(50),
    @OtherDetail2         VARCHAR(50),
    @OtherDetail3         VARCHAR(100),
    @OtherDetail4         VARCHAR(100),
    @OtherDetail5         VARCHAR(500),
    @OtherDetail6         VARCHAR(500),
    @IsActive             INT,
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[BankMaster]
    SET 
         [MasterType]         = @MasterType
        ,[MasterId]           = @MasterId
        ,[AccountHolderName]  = @AccountHolderName
        ,[BankName]           = @BankName
        ,[AccountNo]          = @AccountNo
        ,[AccountType]        = @AccountType
        ,[BranchName]         = @BranchName
        ,[IFSCCode]           = @IFSCCode
        ,[Address]            = @Address
        ,[Contact]            = @Contact
        ,[IsDefault]          = @IsDefault
        ,[IsVerified]         = @IsVerified
        ,[OtherDetail1]       = @OtherDetail1
        ,[OtherDetail2]       = @OtherDetail2
        ,[OtherDetail3]       = @OtherDetail3
        ,[OtherDetail4]       = @OtherDetail4
        ,[OtherDetail5]       = @OtherDetail5
        ,[OtherDetail6]       = @OtherDetail6
        ,[IsActive]           = @IsActive
        ,[ModifiedBy]         = @ActionUser
        ,[ModifiedOn]         = GETDATE()
    WHERE 
        [BankId] = @BankId ;

    SELECT 
         [BankId]
        ,[MasterType]
        ,[MasterId]
        ,[AccountHolderName]
        ,[BankName]
        ,[AccountNo]
        ,[AccountType]
        ,[BranchName]
        ,[IFSCCode]
        ,[Address]
        ,[Contact]
        ,[IsDefault]
        ,[IsVerified]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[BankMaster]
    WHERE [BankId] = @BankId
	      AND [IsDeleted] = 0
		   AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[BusinessMaster_Create]
(
    @BusinessName         VARCHAR(100),
    @BusinessType         VARCHAR(50),
	@Description          VARCHAR(500),
    @ReraNumber           VARCHAR(50),
    @PanNumber            VARCHAR(20),
    @GstNumber            VARCHAR(20),
    @LogoUrl              VARCHAR(50),
    @Address              VARCHAR(100),
    @City                 VARCHAR(100),
    @State                VARCHAR(100),
    @Pincode              VARCHAR(10),
    @ContactEmail         VARCHAR(100),
    @ContactPhone         VARCHAR(10),
    @WebsiteUrl           VARCHAR(50),
    @IsVerified           INT,
    @OnBoardingStatus      VARCHAR(50),
    @Latitude             DECIMAL(18, 2),
    @Longitude            DECIMAL(18, 2),
	@TotalProjects        DECIMAL(18,2),
	@Experience            INT,
    @OtherDetail1         VARCHAR(50),
    @OtherDetail2         VARCHAR(50),
    @OtherDetail3         VARCHAR(100),
    @OtherDetail4         VARCHAR(100),
    @OtherDetail5         VARCHAR(500),
    @OtherDetail6         VARCHAR(500),
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BusinessId INT;

    INSERT INTO [re].[BusinessMaster]
    (
        [BusinessName],
        [BusinessType],
        [ReraNumber],
		[Description],
        [PanNumber],
        [GstNumber],
        [LogoUrl],
        [Address],
        [City],
        [State],
        [Pincode],
        [ContactEmail],
        [ContactPhone],
        [WebsiteUrl],
        [IsVerified],
		[OnBoardingStatus],
        [Latitude],
        [Longitude],
		[TotalProjects],
		[Experience],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @BusinessName,
        @BusinessType,
        @ReraNumber,
		@Description,
        @PanNumber,
        @GstNumber,
        @LogoUrl,
        @Address,
        @City,
        @State,
        @Pincode,
        @ContactEmail,
        @ContactPhone,
        @WebsiteUrl,
        @IsVerified,
		@OnBoardingStatus,
        @Latitude,
        @Longitude,
		@TotalProjects,
		@Experience,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,                
        0,                
        @ActionUser,      
        GETDATE()         
    );

    SET @BusinessId = SCOPE_IDENTITY();

    SELECT 
        [BusinessId],
        [BusinessName],
        [BusinessType],
		[Description],
        [ReraNumber],
        [PanNumber],
        [GstNumber],
        [LogoUrl],
        [Address],
        [City],
        [State],
        [Pincode],
        [ContactEmail],
        [ContactPhone],
        [WebsiteUrl],
        [IsVerified],
		[OnBoardingStatus],
        [Latitude],
        [Longitude],
		[TotalProjects],
        [Experience],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[BusinessMaster]
    WHERE [BusinessId] = @BusinessId;
END;
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BusinessMaster_Delete]
(
   @BusinessId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [re].[BusinessMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE[BusinessId] = @BusinessId
END;
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_GetDictionary]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
Sample Execution:
    -- Get all active businesses where BusinessName contains 'Tech'
    EXEC [re].[BusinessMaster_GetDictionary] @BusinessName = 'Tech'
*/

CREATE PROCEDURE [re].[BusinessMaster_GetDictionary]
(
    @BusinessName NVARCHAR(250) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
         CAST([BusinessId] AS NVARCHAR(50)) AS [Key],
         [BusinessName] AS [Value]
    FROM [re].[BusinessMaster]
    WHERE 
        IsDeleted = 0
        AND IsActive = 1
        AND (@BusinessName IS NULL OR BusinessName LIKE '%' + @BusinessName + '%');
END
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_OnboardingComplete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[BusinessMaster_OnboardingComplete]
    @BusinessId BIGINT
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[BusinessMaster]
    SET OnBoardingStatus = 'Completed', IsVerified = 1
    WHERE BusinessId = @BusinessId;
END
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_OnboardingReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[BusinessMaster_OnboardingReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL

)
AS
 BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL =
		'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum
		  ,[BusinessId]
		  ,[BusinessName]
		  ,[BusinessType]
		  ,[Description]
		  ,[ReraNumber]
		  ,[PanNumber]
		  ,[GstNumber]
		  ,[LogoUrl]
		  ,[Address]
		  ,[City]
		  ,[State]
		  ,[Pincode]
		  ,[ContactEmail]
		  ,[ContactPhone]
		  ,[WebsiteUrl]
		  ,[IsVerified]
		  ,[OnBoardingStatus]
		  ,[Latitude]
		  ,[Longitude]
		  ,[TotalProjects]
          ,[Experience]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
				,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [re].[BusinessMaster]
		WHERE [IsActive] = 1 AND [OnBoardingStatus] = ''Pending''';


	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
	END;
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BusinessMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [BusinessId]
		,[BusinessName]
		,[BusinessType]
		,[Description]
		,[ReraNumber]
		,[PanNumber]
		,[GstNumber]
		,[LogoUrl]
		,[Address]
		,[City]
		,[State]
		,[Pincode]
		,[ContactEmail]
		,[ContactPhone]
		,[WebsiteUrl]
		,[IsVerified]
		,[OnBoardingStatus]
		,[Latitude]
		,[Longitude]
	    ,[TotalProjects]
        ,[Experience]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[BusinessMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[BusinessMaster_ReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL

)
AS
 BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL =
		'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum
		  ,[BusinessId]
		  ,[BusinessName]
		  ,[BusinessType]
		  ,[Description]
		  ,[ReraNumber]
		  ,[PanNumber]
		  ,[GstNumber]
		  ,[LogoUrl]
		  ,[Address]
		  ,[City]
		  ,[State]
		  ,[Pincode]
		  ,[ContactEmail]
		  ,[ContactPhone]
		  ,[WebsiteUrl]
		  ,[IsVerified]
		  ,[OnBoardingStatus]
		  ,[Latitude]
		  ,[Longitude]
		  ,[TotalProjects]
          ,[Experience]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
				,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [re].[BusinessMaster]
		WHERE [IsActive] = 1 AND [OnBoardingStatus] = ''Completed''';


	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
	END;
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_ReadByBusinessType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BusinessMaster_ReadByBusinessType]
(
    @BusinessType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [BusinessId]
		,[BusinessName]
		,[BusinessType]
		,[Description]
		,[ReraNumber]
		,[PanNumber]
		,[GstNumber]
		,[LogoUrl]
		,[Address]
		,[City]
		,[State]
		,[Pincode]
		,[ContactEmail]
		,[ContactPhone]
		,[WebsiteUrl]
		,[IsVerified]
		,[OnBoardingStatus]
		,[Latitude]
		,[Longitude]
	    ,[TotalProjects]
        ,[Experience]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[BusinessMaster]
	WHERE[BusinessType] = @BusinessType
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[BusinessMaster_ReadById]
(
    @BusinessId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [BusinessId]
		,[BusinessName]
		,[BusinessType]
		,[Description]
		,[ReraNumber]
		,[PanNumber]
		,[GstNumber]
		,[LogoUrl]
		,[Address]
		,[City]
		,[State]
		,[Pincode]
		,[ContactEmail]
		,[ContactPhone]
		,[WebsiteUrl]
		,[IsVerified]
		,[OnBoardingStatus]
		,[Latitude]
		,[Longitude]
	    ,[TotalProjects]
        ,[Experience]
	   	,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[BusinessMaster]
	WHERE[BusinessId] = @BusinessId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[BusinessMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[BusinessMaster_Update]
(
    @BusinessId      INT,
    @BusinessName    VARCHAR(100),
    @BusinessType    VARCHAR(50),
	@Description    VARCHAR(500),
    @ReraNumber      VARCHAR(50),
    @PanNumber       VARCHAR(20),
    @GstNumber       VARCHAR(20),
    @LogoUrl         VARCHAR(500),
    @Address         VARCHAR(100),
    @City            VARCHAR(100),
    @State           VARCHAR(100),
    @Pincode         VARCHAR(10),
    @ContactEmail    VARCHAR(100),
    @ContactPhone    VARCHAR(10),
    @WebsiteUrl      VARCHAR(50),
    @IsVerified      INT,
	@OnBoardingStatus   VARCHAR(50),
    @Latitude        DECIMAL(18, 2),
    @Longitude       DECIMAL(18, 2),
    @TotalProjects        DECIMAL(18,2),
	@Experience            INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @IsActive        INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[BusinessMaster]
    SET
         [BusinessName]    = @BusinessName
        ,[BusinessType]    = @BusinessType
		,[Description]     = @Description
        ,[ReraNumber]      = @ReraNumber
        ,[PanNumber]       = @PanNumber
        ,[GstNumber]       = @GstNumber
        ,[LogoUrl]         = @LogoUrl
        ,[Address]         = @Address
        ,[City]            = @City
        ,[State]           = @State
        ,[Pincode]         = @Pincode
        ,[ContactEmail]    = @ContactEmail
        ,[ContactPhone]    = @ContactPhone
        ,[WebsiteUrl]      = @WebsiteUrl
        ,[IsVerified]      = @IsVerified
		,[OnBoardingStatus] = @OnBoardingStatus
        ,[Latitude]        = @Latitude
        ,[Longitude]       = @Longitude
		,[TotalProjects]   =@TotalProjects
		,[Experience]     = @Experience
        ,[OtherDetail1]    = @OtherDetail1
        ,[OtherDetail2]    = @OtherDetail2
        ,[OtherDetail3]    = @OtherDetail3
        ,[OtherDetail4]    = @OtherDetail4
        ,[OtherDetail5]    = @OtherDetail5
        ,[OtherDetail6]    = @OtherDetail6
        ,[IsActive]        = @IsActive
        ,[ModifiedBy]      = @ActionUser
        ,[ModifiedOn]      = GETDATE()
    WHERE [BusinessId] = @BusinessId 
	

    SELECT 
         [BusinessId]
        ,[BusinessName]
        ,[BusinessType]
		,[Description]
        ,[ReraNumber]
        ,[PanNumber]
        ,[GstNumber]
        ,[LogoUrl]
        ,[Address]
        ,[City]
        ,[State]
        ,[Pincode]
        ,[ContactEmail]
        ,[ContactPhone]
        ,[WebsiteUrl]
        ,[IsVerified]
		,[OnBoardingStatus]
        ,[Latitude]
        ,[Longitude]
	    ,[TotalProjects]
        ,[Experience]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[BusinessMaster]
    WHERE [BusinessId] = @BusinessId
	  AND [IsActive] = 1;;
END;
GO
/****** Object:  StoredProcedure [re].[FeedbackMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [re].[FeedbackMaster_Create]
(
    @BusinessId     INT = NULL,
    @MasterId       INT,
    @MasterType     VARCHAR(20),
    @Rating         INT = NULL,
    @Description    NVARCHAR(1000) = NULL,
	@PostedBy       VARCHAR(50),
    @PostedOn       DATETIME = NULL,
    @OtherDetail1   NVARCHAR(255) = NULL,
    @OtherDetail2   NVARCHAR(255) = NULL,
    @OtherDetail3   NVARCHAR(255) = NULL,
    @OtherDetail4   NVARCHAR(255) = NULL,
    @OtherDetail5   NVARCHAR(255) = NULL,
    @OtherDetail6   NVARCHAR(255) = NULL,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FeedbackId INT;

    INSERT INTO [re].[FeedbackMaster]
    (
        [BusinessId],
        [MasterId],
        [MasterType],
        [Rating],
        [Description],
		[PostedBy],
        [PostedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @BusinessId,
        @MasterId,
        TRIM(@MasterType),
        @Rating,
        TRIM(@Description),
		@PostedBy,
        @PostedOn,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,              
        0,              
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @FeedbackId = SCOPE_IDENTITY();

    SELECT
        [FeedbackId],
        [BusinessId],
        [MasterId],
        [MasterType],
        [Rating],
        [Description],
		[PostedBy],
        [PostedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[FeedbackMaster]
    WHERE [FeedbackId] = @FeedbackId;
END;
GO
/****** Object:  StoredProcedure [re].[FeedbackMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[FeedbackMaster_Delete]
(
   @FeedbackId INT,
   @ActionUser  VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[re].[FeedbackMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [FeedbackId]  = @FeedbackId
END;
GO
/****** Object:  StoredProcedure [re].[FeedbackMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[FeedbackMaster_ReadAll]
AS
BEGIN 
     SET NOCOUNT ON;
	SELECT
		 [FeedbackId]
		,[BusinessId]
		,[MasterId]
		,[MasterType]
		,[Rating]
		,[Description]
		,[PostedBy]
		,[PostedOn]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[FeedbackMaster]
	WHERE [IsActive] = 1
	 AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [re].[FeedbackMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[FeedbackMaster_ReadById]
(
  @FeedbackId int
)
AS
BEGIN 
     SET NOCOUNT ON;
	SELECT
		 [FeedbackId]
		,[BusinessId]
		,[MasterId]
		,[MasterType]
		,[Rating]
		,[Description]
		,[PostedBy]
		,[PostedOn]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[FeedbackMaster]
	WHERE [FeedbackId] =  @FeedbackId
	 AND [IsActive] = 1
	 AND [IsDeleted] =0
END;
GO
/****** Object:  StoredProcedure [re].[FeedbackMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[FeedbackMaster_ReadByMasterId]
(
  @MasterId INT ,
  @MasterType VARCHAR(50)
)
AS
BEGIN 
     SET NOCOUNT ON;
	SELECT
		 A.[FeedbackId]
		,A.[BusinessId]
		,A.[MasterId]
		,A.[MasterType]
		,A.[Rating]
		,A.[Description]
		,A.[PostedBy]
		,A.[PostedOn]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
		,B.[FirstName] + ' '+ B.[LastName] as UserName
		,B.[ProfileImage] as userProfilePic
	FROM [re].[FeedbackMaster] A
	LEFT OUTER JOIN [dbo].[UserMaster] B
		ON B.UserId =  CAST (A.PostedBy AS INT)
	WHERE A.[MasterId] =  @MasterId
	 AND A.[MasterType] = @MasterType
	 AND A.[IsActive] = 1
	 AND A.[IsDeleted] =0
END;
GO
/****** Object:  StoredProcedure [re].[FeedbackMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[FeedbackMaster_Update]
(
    @FeedbackId     INT,
    @BusinessId     INT = NULL,
    @MasterId       INT,
    @MasterType     VARCHAR(20),
    @Rating         INT = NULL,
    @Description    NVARCHAR(1000) = NULL,
	@PostedBy        VARCHAR(50) NULL,
    @PostedOn       DATETIME = NULL,
    @OtherDetail1   NVARCHAR(255) = NULL,
    @OtherDetail2   NVARCHAR(255) = NULL,
    @OtherDetail3   NVARCHAR(255) = NULL,
    @OtherDetail4   NVARCHAR(255) = NULL,
    @OtherDetail5   NVARCHAR(255) = NULL,
    @OtherDetail6   NVARCHAR(255) = NULL,
    @IsActive       INT = 1,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[FeedbackMaster]
    SET
        [BusinessId]   = @BusinessId,
        [MasterId]     = @MasterId,
        [MasterType]   = TRIM(@MasterType),
        [Rating]       = @Rating,
        [Description]  = TRIM(@Description),
		[PostedBy]      = @PostedBy,
        [PostedOn]     = @PostedOn,
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive]     = @IsActive,
        [ModifiedBy]   = TRIM(@ActionUser),
        [ModifiedOn]   = GETDATE()
    WHERE [FeedbackId] = @FeedbackId;

    SELECT
        [FeedbackId],
        [BusinessId],
        [MasterId],
        [MasterType],
        [Rating],
        [Description],
		[PostedBy],
        [PostedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[FeedbackMaster]
    WHERE [FeedbackId] = @FeedbackId
	AND [IsActive] = 1
	AND [IsDeleted]= 0;
END;
GO
/****** Object:  StoredProcedure [re].[OnboardingPreCheck_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [re].[OnboardingPreCheck_Create]
(
    @BusinessId     INT             = NULL,
    @PName          VARCHAR(100)    = NULL,
    @PDesc          VARCHAR(500)    = NULL,
    @IsVerified     INT             = NULL,
    @VerifiedBy     VARCHAR(100)    = NULL,
    @VerifiedDate   DATETIME        = NULL,
    @OtherDetail1   VARCHAR(50)     = NULL,
    @OtherDetail2   VARCHAR(50)     = NULL,
    @OtherDetail3   VARCHAR(100)    = NULL,
    @OtherDetail4   VARCHAR(100)    = NULL,
    @OtherDetail5   VARCHAR(500)    = NULL,
    @OtherDetail6   VARCHAR(500)    = NULL,
    @ActionUser     VARCHAR(50)     = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PreCheckId BIGINT;

    INSERT INTO [re].[OnboardingPreCheck]
    (
        [BusinessId],
        [PName],
        [PDesc],
        [IsVerified],
        [VerifiedBy],
        [VerifiedDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @BusinessId,
        TRIM(@PName),
        TRIM(@PDesc),
        @IsVerified,
        TRIM(@VerifiedBy),
        @VerifiedDate,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1, 
        0, 
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @PreCheckId = SCOPE_IDENTITY();

    SELECT 
         A.[PreCheckId]
		,A.[BusinessId]
		,A.[PName]
		,A.[PDesc]
		,A.[IsVerified]
		,A.[VerifiedBy]
		,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
		,A.[VerifiedDate]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [re].[OnboardingPreCheck]A
        LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
			ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
			AND B.[IsActive] = 1
			AND B.[IsDeleted] = 0
    WHERE A.[PreCheckId] = @PreCheckId
	AND A.[IsActive] = 1
	AND A.[IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [re].[OnboardingPreCheck_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[OnboardingPreCheck_Delete]
(
   @PreCheckId BIGINT,
   @ActionUser VARCHAR(50)
)
AS 
BEGIN 
	SET NOCOUNT ON;
	UPDATE [re].[OnboardingPreCheck]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE  [PreCheckId] = @PreCheckId
END;
GO
/****** Object:  StoredProcedure [re].[OnboardingPreCheck_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[OnboardingPreCheck_ReadAll]
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PreCheckId]
		,[BusinessId]
		,[PName]
		,[PDesc]
		,[IsVerified]
		,[VerifiedBy]
		,[VerifiedDate]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[OnboardingPreCheck]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [re].[OnboardingPreCheck_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[OnboardingPreCheck_ReadByBusinessId]
(
   @BusinessId INT
)
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 A.[PreCheckId]
		,A.[BusinessId]
		,A.[PName]
		,A.[PDesc]
		,A.[IsVerified]
		,A.[VerifiedBy]
		,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
		,A.[VerifiedDate]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [re].[OnboardingPreCheck]A
        LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
			ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
			AND B.[IsActive] = 1
			AND B.[IsDeleted] = 0
    WHERE A.[BusinessId] = @BusinessId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[OnboardingPreCheck_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[OnboardingPreCheck_ReadById]
(
   @PreCheckId BIGINT
)
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PreCheckId]
		,[BusinessId]
		,[PName]
		,[PDesc]
		,[IsVerified]
		,[VerifiedBy]
		,[VerifiedDate]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[OnboardingPreCheck]
	WHERE  [PreCheckId] = @PreCheckId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [re].[OnboardingPreCheck_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[OnboardingPreCheck_Update]
(
    @PreCheckId     BIGINT,
    @BusinessId     INT             = NULL,
    @PName          VARCHAR(100)    = NULL,
    @PDesc          VARCHAR(500)    = NULL,
    @IsVerified     INT             = NULL,
    @VerifiedBy     VARCHAR(100)    = NULL,
    @VerifiedDate   DATETIME        = NULL,
    @OtherDetail1   VARCHAR(50)     = NULL,
    @OtherDetail2   VARCHAR(50)     = NULL,
    @OtherDetail3   VARCHAR(100)    = NULL,
    @OtherDetail4   VARCHAR(100)    = NULL,
    @OtherDetail5   VARCHAR(500)    = NULL,
    @OtherDetail6   VARCHAR(500)    = NULL,
    @IsActive       INT             = NULL,
    @ActionUser     VARCHAR(50)     = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[OnboardingPreCheck]
    SET
        [BusinessId]    = @BusinessId,
        [PName]         = TRIM(@PName),
        [PDesc]         = TRIM(@PDesc),
        [IsVerified]    = @IsVerified,
        [VerifiedBy]    = TRIM(@VerifiedBy),
        [VerifiedDate]  = @VerifiedDate,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [PreCheckId] = @PreCheckId;

SELECT 
		 A.[PreCheckId]
		,A.[BusinessId]
		,A.[PName]
		,A.[PDesc]
		,A.[IsVerified]
		,A.[VerifiedBy]
		,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
		,A.[VerifiedDate]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [re].[OnboardingPreCheck]A
        LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
			ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
			AND B.[IsActive] = 1
			AND B.[IsDeleted] = 0
    WHERE A.[PreCheckId] = @PreCheckId
	AND A.[IsActive] = 1
	AND A.[IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [re].[OptionMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [re].[OptionMaster_Create]
(
    @DetailId      INT,
    @Type          VARCHAR(100) = NULL,
    @OptioName     VARCHAR(100) = NULL,
    @OptioValue    VARCHAR(100) = NULL,
    @Remarks       VARCHAR(500) = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(100) = NULL,
    @OtherDetail3  VARCHAR(500) = NULL,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @OptioId INT;

    INSERT INTO [re].[OptionMaster]
    (
        [DetailId],
        [Type],
        [OptioName],
        [OptioValue],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @DetailId,
        TRIM(@Type),
        TRIM(@OptioName),
        TRIM(@OptioValue),
        TRIM(@Remarks),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        1,              
        0,             
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @OptioId = SCOPE_IDENTITY();

    SELECT 
        [OptioId],
        [DetailId],
        [Type],
        [OptioName],
        [OptioValue],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[OptionMaster]
    WHERE [OptioId] = @OptioId;
END;
GO
/****** Object:  StoredProcedure [re].[Project_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_Create]
(
    @BusinessId   INT = NULL,
	@ProjectName VARCHAR(255) = NULL,
	@Description VARCHAR(500) = NULL,
	@City VARCHAR(100) = NULL,
	@State VARCHAR(100) = NULL,
	@Locality VARCHAR(100) = NULL,
	@Address VARCHAR(100) = NULL,
	@Pincode VARCHAR(10) = NULL,
	@Latitude DECIMAL(10,6) = NULL,
	@Longitude DECIMAL(10,6) = NULL,
	@Status VARCHAR(50) = NULL,
	@LaunchDate DATE = NULL,
	@PossessionDate DATE = NULL,
	@TotalUnits INT = NULL,
	@ProjectArea   DECIMAL(5,2) null,
    @OtherDetail1  VARCHAR(50)   = NULL,
    @OtherDetail2  VARCHAR(50)   = NULL,
    @OtherDetail3  VARCHAR(100)  = NULL,
    @OtherDetail4  VARCHAR(100)  = NULL,
    @OtherDetail5  VARCHAR(500)  = NULL,
    @OtherDetail6  VARCHAR(500)  = NULL,
    @ActionUser    VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ProjectId BIGINT;

    INSERT INTO [re].[Project]
    (
        [BusinessId],
        [ProjectName],
        [Description],
        [City],
        [State],
        [Locality],
        [Address],
        [Pincode],
        [Latitude],
        [Longitude],
        [Status],
        [LaunchDate],
        [PossessionDate],
        [TotalUnits],
		[ProjectArea],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @BusinessId,
        TRIM(@ProjectName),
        TRIM(@Description),
        TRIM(@City),
        TRIM(@State),
        TRIM(@Locality),
        TRIM(@Address),
        TRIM(@Pincode),
        @Latitude,
        @Longitude,
        TRIM(@Status),
        @LaunchDate,
        @PossessionDate,
        @TotalUnits,
		@ProjectArea,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @ProjectId = SCOPE_IDENTITY();

    SELECT 
        [ProjectId],
        [BusinessId],
        [ProjectName],
        [Description],
        [City],
        [State],
        [Locality],
        [Address],
        [Pincode],
        [Latitude],
        [Longitude],
        [Status],
        [LaunchDate],
        [PossessionDate],
        [TotalUnits],
		[ProjectArea],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[Project]
    WHERE [ProjectId] = @ProjectId;
END;
GO
/****** Object:  StoredProcedure [re].[Project_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_Delete]
(
   @ProjectId BIGINT,
   @ActionUser VARCHAR (50)
)
AS
 BEGIN
	UPDATE[re].[Project]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ProjectId] = @ProjectId;

	UPDATE [re].[ProjectBuilding]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ProjectId] = @ProjectId

	UPDATE [re].[ProjectUnitType]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ProjectId] = @ProjectId

	UPDATE [re].[RealEstateImgMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MasterId] = @ProjectId AND [MasterType] = 'Project'

	UPDATE [re].[RealEstateDocMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MasterId] = @ProjectId AND [MasterType] = 'Project'

	UPDATE [re].[PropertyAmenities]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MasterId] = @ProjectId AND [MasterType] = 'Project'

	UPDATE [re].[Property]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GetDate()
	WHERE [ProjectId] = @ProjectId;


	DECLARE @PropertyIds TABLE (PropertyId BIGINT);

	INSERT INTO @PropertyIds (PropertyId)
	SELECT 
		[PropertyId]
	FROM [re].[Property]
	WHERE [ProjectId] = @ProjectId


	UPDATE PL
	SET
		PL.[IsActive] = 0,
		PL.[IsDeleted] = 1,
		PL.[ModifiedBy] = @ActionUser,
		PL.[ModifiedOn] = GETDATE()
	FROM [re].[PropertyListing] PL
	INNER JOIN @PropertyIds P ON PL.[PropertyId] = P.[PropertyId]

	UPDATE PD
	SET
		PD.[IsActive] = 0,
		PD.[IsDeleted] = 1,
		PD.[ModifiedBy] = @ActionUser,
		PD.[ModifiedOn] = GETDATE()
	FROM [re].[PropertyDetails] PD
	INNER JOIN @PropertyIds P ON PD.[PropertyId] = P.[PropertyId]

END;
GO
/****** Object:  StoredProcedure [re].[Project_FlatBulkCreate]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Procedure [re].[Project_FlatBulkCreate]
(
@FlatList [re].[udt_FlatBulk] READONLY,
@ActionUserVARCHAR(50)
)
AS
BEGIN
SET NOCOUNT ON;
-- Table variable to capture inserted PropertyIds with Mapping
Declare @AllPropertyDetails TABLE
(
	TTId INT IDENTITY(1,1) PRIMARY KEY,
ProjectId INT,
BuildingId INT,
UnitTypeId INT,
	FlatNo INT,
FloorNo INT,
Status VARCHAR(50),
PropertyId INT,
	BusinessId INT,
	ProjectName VARCHAR(255),
	Description VARCHAR(500),
	City VARCHAR(100),
	State VARCHAR(100),
	Locality VARCHAR(100),
	Address VARCHAR(100),
	Pincode VARCHAR(10),
	Latitude DECIMAL(10,6),
	Longitude DECIMAL(10,6),
	LaunchDate DATE
);


	INSERT INTO @AllPropertyDetails
	(
		ProjectId, BuildingId, UnitTypeId, FlatNo, FloorNo, Status, PropertyId,
		BusinessId, ProjectName, Description, City, State, Locality, Address, Pincode, Latitude, Longitude, LaunchDate
	)
	SELECT 
		A.ProjectId, A.BuildingId, A.UnitTypeId, A.FlatNo, A.FloorNo, A.Status, 0,
		B.BusinessId, B.ProjectName, B.Description, B.City, B.State, B.Locality, B.Address, B.Pincode,B.Latitude, B.Longitude, B.LaunchDate
	FROM @FlatList A
	LEFT OUTER JOIN Re.Project B ON A.ProjectId = B.ProjectId
	WHERE B.IsActive = 1 AND B.IsDeleted = 0 AND B.ProjectId IS NOT NULL


	-- Table to capture output of inserted Property records
    DECLARE @InsertedProperties TABLE
    (
		DetailTTId INT,
        PropertyId INT,
        ProjectId INT,
        BuildingId INT,
        UnitTypeId INT,
        FloorNo INT,
        Status VARCHAR(50)
    );



 -- Step 2: Insert new properties


	DECLARE 
	@LoopStart INT = 0,
	@LoopEnd INT = 0;

	SELECT @LoopStart = 0
	SELECT @LoopEnd =  Max(TTId) FROM @AllPropertyDetails;

	WHILE @LoopEnd >= @LoopStart
	BEGIN

		DECLARE @NewPropertyID INT = 0
		INSERT INTO [re].[Property]
		(
			[BusinessId],
			[PostedBy],
			[Title],
			[Description],
			[PropertyType],
			[ListingType],
			[City],
			[State],
			[Locality],
			[Address],
			[Pincode],
			[Latitude],
			[Longitude],
			[Status],
			[ListedOn],
			[OtherDetail1],
			[OtherDetail2],
			[OtherDetail3],
			[OtherDetail4],
			[OtherDetail5],
			[OtherDetail6],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[PropertyName],
			[ProjectId],
			[BuildingId],
			[UnitTypeId]
		)
		SELECT 
			BusinessId,
			0 AS PostedBy,
			ProjectName AS Title,
			Description,
			'Project' AS PropertyType,
			'Sale' AS ListingType,
			City,
			State,
			Locality,
			Address,
			Pincode,
			Latitude,
			Longitude,
			Status,
			GETDATE() AS ListedOn,
			'', '', '', '', '', '',
			1 AS IsActive,
			0 AS IsDeleted,
			@ActionUser AS CreatedBy,
			GETDATE() AS CreatedOn,
			FlatNo,
			ProjectId,
			BuildingId,
			UnitTypeId
		FROM @AllPropertyDetails 
		WHERE TTId = @LoopStart

		SET @NewPropertyID = SCOPE_IDENTITY();
		

		UPDATE @AllPropertyDetails
		SET PropertyId = @NewPropertyID
		WHERE TTId = @LoopStart
		
		SET @LoopStart = @LoopStart + 1

	END

	--SELECT * FROM @AllPropertyDetails




--INSERT INTO PROPERTY_LISTING TABLE
INSERT INTO [re].[PropertyListing]
(
	   [PropertyId]
      ,[ListingType]
      ,[Price]
      ,[AvailableFrom]
      ,[PostedBy]
      ,[ListingStatus]
      ,[PropertyName]
      ,[Negotiable]
      ,[PropertyStatus]
      ,[IsVerified]
      ,[ValidityPeriod]
      ,[ValidFrom]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
)
	SELECT 
	APD.PropertyId,
	'Project' AS ListingType,
	ISNULL(B.BasePrice,0.00) AS Price,
	APD.LaunchDate,
		CONVERT(VARCHAR,ISNULL(@ActionUser, 0)) AS PostedBy,
		APD.Status,
		APD.ProjectName,
		0 AS Negotiable,
		APD.Status,
		0 AS IsVerified,
		120 AS ValidityPeriod,
		GETDATE() AS ValidFrom,
	1,
	0,
	@ActionUser,
	GETDATE()
	FROM @AllPropertyDetails APD
	LEFT OUTER JOIN RE.ProjectUnitType B
	ON APD.UnitTypeId = B.UnitTypeId
	WHERE B.IsActive = 1 AND IsDeleted = 0 AND B.UnitTypeId IS NOT NULL





-- STEP 3: Insert into PropertyDetail Table
INSERT INTO [re].[PropertyDetails]
(
	   [PropertyId]
	  ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[FloorNumber]
      ,[TotalFloors]
      ,[AgeOfConstruction]
      ,[Facing]
      ,[OwnershipType]
      ,[Bathroom]
      ,[Balcony]
      ,[Parking]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
)
SELECT 
APD.PropertyId,
ISNULL(C.BHK,0) AS BHK,
ISNULL(C.SuperArea,0.00) SuperArea,
ISNULL(C.CarpetArea,0.00) CarpetArea,
ISNULL(C.Furnishing,0.00) Furnishing,
APD.FloorNo,
B.Floors,
0,
	'',
	'',
	0,
	0,
	0,
1,
0,
@ActionUser,
  GETDATE()
FROM @AllPropertyDetails APD
LEFT OUTER JOIN [re].[ProjectBuilding] B ON B.BuildingId = APD.BuildingId
LEFT OUTER JOIN [re].[ProjectUnitType] C ON C.UnitTypeId = APD.UnitTypeId;


	-- Instead of selecting from Property table again, return from @AllPropertyDetails
	SELECT * FROM @AllPropertyDetails

END;
GO
/****** Object:  StoredProcedure [re].[Project_FlatBulkCreate2]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


Create Procedure [re].[Project_FlatBulkCreate2]
(
@FlatList [re].[udt_FlatBulk] READONLY,
@ActionUserVARCHAR(50)
)
AS
BEGIN
SET NOCOUNT ON;
-- Table variable to capture inserted PropertyIds with Mapping
Declare @AllPropertyDetails TABLE
(
	TTId INT IDENTITY(1,1) PRIMARY KEY,
ProjectId INT,
BuildingId INT,
UnitTypeId INT,
	FlatNo INT,
FloorNo INT,
Status VARCHAR(50),
PropertyId INT,
	BusinessId INT,
	ProjectName VARCHAR(255),
	Description VARCHAR(500),
	City VARCHAR(100),
	State VARCHAR(100),
	Locality VARCHAR(100),
	Address VARCHAR(100),
	Pincode VARCHAR(10),
	Latitude DECIMAL(10,6),
	Longitude DECIMAL(10,6),
	LaunchDate DATE
);


	INSERT INTO @AllPropertyDetails
	(
		ProjectId, BuildingId, UnitTypeId, FlatNo, FloorNo, Status, PropertyId,
		BusinessId, ProjectName, Description, City, State, Locality, Address, Pincode, Latitude, Longitude, LaunchDate
	)
	SELECT 
		A.ProjectId, A.BuildingId, A.UnitTypeId, A.FlatNo, A.FloorNo, A.Status, 0,
		B.BusinessId, B.ProjectName, B.Description, B.City, B.State, B.Locality, B.Address, B.Pincode,B.Latitude, B.Longitude, B.LaunchDate
	FROM @FlatList A
	LEFT OUTER JOIN Re.Project B ON A.ProjectId = B.ProjectId
	WHERE B.IsActive = 1 AND B.IsDeleted = 0 AND B.ProjectId IS NOT NULL


	-- Table to capture output of inserted Property records
    DECLARE @InsertedProperties TABLE
    (
		DetailTTId INT,
        PropertyId INT,
        ProjectId INT,
        BuildingId INT,
        UnitTypeId INT,
        FloorNo INT,
        Status VARCHAR(50)
    );


 -- Step 2: Insert new properties


	DECLARE 
	@LoopStart INT = 0,
	@LoopEnd INT = 0;

	SELECT @LoopStart = 0
	SELECT @LoopEnd =  Max(TTId) FROM @AllPropertyDetails;

	WHILE @LoopEnd > @LoopStart
	BEGIN

		DECLARE @NewPropertyID INT = 0
		INSERT INTO [re].[Property]
		(
			[BusinessId],
			[PostedBy],
			[Title],
			[Description],
			[PropertyType],
			[ListingType],
			[City],
			[State],
			[Locality],
			[Address],
			[Pincode],
			[Latitude],
			[Longitude],
			[Status],
			[ListedOn],
			[OtherDetail1],
			[OtherDetail2],
			[OtherDetail3],
			[OtherDetail4],
			[OtherDetail5],
			[OtherDetail6],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[PropertyName],
			[ProjectId],
			[BuildingId],
			[UnitTypeId]
		)
		SELECT 
			BusinessId,
			0 AS PostedBy,
			ProjectName AS Title,
			Description,
			'Project' AS PropertyType,
			'Sale' AS ListingType,
			City,
			State,
			Locality,
			Address,
			Pincode,
			Latitude,
			Longitude,
			Status,
			GETDATE() AS ListedOn,
			'', '', '', '', '', '',
			1 AS IsActive,
			0 AS IsDeleted,
			@ActionUser AS CreatedBy,
			GETDATE() AS CreatedOn,
			FlatNo,
			ProjectId,
			BuildingId,
			UnitTypeId
		FROM @AllPropertyDetails 
		WHERE TTId = @LoopStart

		SET @NewPropertyID = SCOPE_IDENTITY();
		

		UPDATE @AllPropertyDetails
		SET PropertyId = @NewPropertyID
		WHERE TTId = @LoopStart
		
		SET @LoopStart = @LoopStart + 1

	END

	--SELECT * FROM @AllPropertyDetails




--INSERT INTO PROPERTY_LISTING TABLE
INSERT INTO [re].[PropertyListing]
(
	   [PropertyId]
      ,[ListingType]
      ,[Price]
      ,[AvailableFrom]
      ,[PostedBy]
      ,[ListingStatus]
      ,[PropertyName]
      ,[Negotiable]
      ,[PropertyStatus]
      ,[IsVerified]
      ,[ValidityPeriod]
      ,[ValidFrom]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
)
	SELECT 
	APD.PropertyId,
	'Project' AS ListingType,
	ISNULL(B.BasePrice,0.00) AS Price,
	APD.LaunchDate,
		CONVERT(VARCHAR,ISNULL(@ActionUser, 0)) AS PostedBy,
		APD.Status,
		APD.ProjectName,
		0 AS Negotiable,
		APD.Status,
		0 AS IsVerified,
		120 AS ValidityPeriod,
		GETDATE() AS ValidFrom,
	1,
	0,
	@ActionUser,
	GETDATE()
	FROM @AllPropertyDetails APD
	LEFT OUTER JOIN RE.ProjectUnitType B
	ON APD.UnitTypeId = B.UnitTypeId
	WHERE B.IsActive = 1 AND IsDeleted = 0 AND B.UnitTypeId IS NOT NULL





-- STEP 3: Insert into PropertyDetail Table
INSERT INTO [re].[PropertyDetails]
(
	   [PropertyId]
	  ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[FloorNumber]
      ,[TotalFloors]
      ,[AgeOfConstruction]
      ,[Facing]
      ,[OwnershipType]
      ,[Bathroom]
      ,[Balcony]
      ,[Parking]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
)
SELECT 
APD.PropertyId,
ISNULL(C.BHK,0) AS BHK,
ISNULL(C.SuperArea,0.00) SuperArea,
ISNULL(C.CarpetArea,0.00) CarpetArea,
ISNULL(C.Furnishing,0.00) Furnishing,
APD.FloorNo,
B.Floors,
0,
	'',
	'',
	0,
	0,
	0,
1,
0,
@ActionUser,
  GETDATE()
FROM @AllPropertyDetails APD
LEFT OUTER JOIN [re].[ProjectBuilding] B ON B.BuildingId = APD.BuildingId
LEFT OUTER JOIN [re].[ProjectUnitType] C ON C.UnitTypeId = APD.UnitTypeId;


	-- Instead of selecting from Property table again, return from @AllPropertyDetails
	SELECT 
		PropertyId,
		ProjectId,
		BuildingId,
		UnitTypeId,
		FlatNo,
		FloorNo,
		Status
	FROM @AllPropertyDetails
	ORDER BY PropertyId;

END;
GO
/****** Object:  StoredProcedure [re].[Project_GetDetails]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [re].[Project_GetDetails]
	@ProjectId INT
AS
BEGIN
	SET NOCOUNT ON;

	-- 1. Project Info + Business + Price Range

	SELECT
		A.ProjectId,
		A.ProjectName,
		A.Description,
		A.Address,
		A.City,
		A.State,
		A.Pincode,
		A.Status,
		A.LaunchDate,
		A.PossessionDate,
		A.TotalUnits,
		A.ProjectArea,
		A.Longitude,
		A.Latitude,
		B.BusinessName,
		B.BusinessType,
		B.LogoUrl,
		B.Address as BusinessAddress,
		B.State as BusinessState,
		B.City as BusinessCity,
		B.Pincode as BusinessPincode,
		B.ContactEmail as BusinessEmail,
		B.ContactPhone as BusinessPhone,
		B.Description as BusinessDescription,
		B.TotalProjects as BusinessTotalProjects,
		B.Experience as BusinessExperience,

		--Send No of Building
		(Select Count(B.BuildingId)
			FROM [Nishwik].[re].[ProjectBuilding] B
			WHERE B.ProjectId = A.ProjectId
				AND B.IsActive = 1 AND B.IsDeleted = 0) AS BuildingCount,

		--Min & Max Price
		(Select MIN(C.BasePrice)
			FROM [Nishwik].[re].[ProjectUnitType] C
			WHERE C.ProjectId = A.ProjectId
				AND C.IsActive = 1 AND C.IsDeleted = 0) AS MinPrice,

		(SELECT MAX(C.BasePrice) 
			FROM [Nishwik].[re].[ProjectUnitType] C
			WHERE C.ProjectId = A.ProjectId
			AND C.IsActive = 1 AND C.IsDeleted = 0) AS MaxPrice,

		--Min & Max CarpetArea
		(Select MIN(C.CarpetArea)
			FROM [Nishwik].[re].[ProjectUnitType] C
			WHERE C.ProjectId = A.ProjectId
			AND IsActive = 1 AND IsDeleted = 0) AS MinCarpetArea,

		(Select MAX(C.CarpetArea)
			FROM [Nishwik].[re].[ProjectUnitType] C
			WHERE C.ProjectId = A.ProjectId
			AND IsActive = 1 AND IsDeleted = 0) AS MaxCarpetArea

	FROM [Nishwik].[re].[Project] A
	LEFT OUTER JOIN [Nishwik].[re].[BusinessMaster] B
		ON A.BusinessId = B.BusinessId
	WHERE A.ProjectId = @ProjectId
		AND A.IsActive = 1 AND A.IsDeleted = 0;


	-- 2. Buildings under The Project

	SELECT 
		A.BuildingId,
		A.BuildingName,
		A.Floors,
		A.Units,
		A.Status
	FROM [Nishwik].[re].[ProjectBuilding] A
	WHERE A.ProjectId = @ProjectId
		AND A.IsActive = 1 AND A.IsDeleted = 0; 


	-- 3. Unit Types

	SELECT
		A.UnitTypeId,
		A.UnitTypeName,
		A.BHK,
		A.SuperArea,
		A.CarpetArea,
		A.Furnishing,
		A.BasePrice,
		A.Status,
		B.ImgPath as UnitImage
	FROM [Nishwik].[re].[ProjectUnitType] A
	OUTER Apply (
		SELECT TOP 1 ImgPath
		FROM [Nishwik].[re].[RealEstateImgMaster] B
		WHERE B.MasterType = 'ProjectUnitType'
			AND B.MasterId = A.UnitTypeId
			AND B.IsActive = 1 AND B.IsDeleted = 0
		) B
	WHERE A.ProjectId = @ProjectId
		AND A.IsActive = 1 AND A.IsDeleted = 0;

	
	-- 4. Project Documents
	SELECT 
		A.DocId,
		A.MasterType,
		A.MasterId,
		A.DocType,
		A.DocNo,
		A.DocDescription,
		A.DocPath,
		A.OtherDetail1,
		A.OtherDetail2,
		A.OtherDetail3,
		A.OtherDetail4,
		A.OtherDetail5,
		A.OtherDetail6
	FROM [Nishwik].[re].[RealEstateDocMaster] A
	WHERE A.MasterType = 'Project'
		AND A.MasterId = @ProjectId
		AND A.IsActive = 1 AND A.IsDeleted = 0



	-- 5. Unique Floor Plans

	SELECT DISTINCT A.BHK
	FROM [Nishwik].[re].[ProjectUnitType] A
	WHERE A.ProjectId = @ProjectId
	 AND A.IsActive = 1 AND A.IsDeleted = 0
	 AND A.BHK IS NOT NULL
	ORDER BY A.BHK;
END
GO
/****** Object:  StoredProcedure [re].[Project_GetDictionary]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_GetDictionary]
(
	@BusinessId INT,
	@ProjectId INT = NULL
)
AS
BEGIN
	SET NOCOUNT ON;

	IF @ProjectId IS NULL OR @ProjectId = 0
	BEGIN
		SELECT 
			ProjectId AS [Key],
			ProjectName AS [Value]
		FROM [re].[Project]
		WHERE [BusinessId] = @BusinessId 
			AND [IsDeleted] = 0 
			AND [IsActive] = 1
		ORDER BY ProjectName;
		RETURN;
	END;

	SELECT 
		BuildingId AS [Key],
		BuildingName AS [Value]
	FROM [re].[ProjectBuilding]
	WHERE ProjectId = @ProjectId  
		AND [IsDeleted] = 0 
		AND [IsActive] = 1
	ORDER BY BuildingName;
	RETURN;
END;
GO
/****** Object:  StoredProcedure [re].[Project_GetFlatListForProjectForm]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_GetFlatListForProjectForm]
(
    @ProjectId INT
)
AS
BEGIN 
    SET NOCOUNT ON;

    SELECT 
		A.[PropertyId],
        A.[ProjectId],
        A.[BuildingId],
        A.[UnitTypeId],
        A.[PropertyName] as FlatNo,
        A.[Status],
        B.[FloorNumber] as FloorNo
    FROM [Nishwik].[re].[Property] A
    LEFT OUTER JOIN [Nishwik].[re].[PropertyDetails] B
        ON A.PropertyId = B.PropertyId
    WHERE A.ProjectId = @ProjectId;
END;
GO
/****** Object:  StoredProcedure [re].[Project_GetNumberByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_GetNumberByBusinessId]
(
 @BusinessId INT
)
AS
 BEGIN
    SET NOCOUNT ON;
SELECT 
    YEAR(CreatedOn) AS [Year],
    COUNT(*) AS [NoOfProjects]
FROM [Nishwik].[re].[Property]
WHERE 
    IsActive = 1 
    AND IsDeleted = 0
    AND BusinessId = @BusinessId     
GROUP BY YEAR(CreatedOn)
ORDER BY YEAR(CreatedOn);
END;
GO
/****** Object:  StoredProcedure [re].[Project_GetProjectEntitiesForEdit]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_GetProjectEntitiesForEdit]
(
	@ProjectId INT
)
AS 
BEGIN
	SET NOCOUNT ON;

	SELECT 
		BuildingId
	FROM [Nishwik].[re].[ProjectBuilding]
	WHERE ProjectId = @ProjectId
		AND IsActive = 1
		AND IsDeleted = 0;

	SELECT 
		UnitTypeId
	FROM [Nishwik].[re].[ProjectUnitType]
	WHERE ProjectId = @ProjectId
		AND IsActive = 1
		AND IsDeleted = 0;

	SELECT 
		AmenityId 
	FROM [Nishwik].[re].[PropertyAmenities]
	WHERE MasterId = @ProjectId
		AND MasterType = 'Project'
		AND IsActive = 1
		AND IsDeleted = 0;

	SELECT 
		ImgId
	FROM [Nishwik].[re].[RealEstateImgMaster]
	WHERE MasterId = @ProjectId
		AND MasterType = 'Project' OR MasterType = 'ProjectUnitType'
		AND IsActive = 1
		AND IsDeleted = 0;

	SELECT 
		DocId
	FROM [Nishwik].[re].[RealEstateDocMaster]
	WHERE MasterId = @ProjectId
		AND MasterType = 'Project'
		AND IsActive = 1
		AND IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [re].[Project_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[Project_ReadAll]
AS
 BEGIN
     SELECT
	   [ProjectId]
      ,[BusinessId]
      ,[ProjectName]
      ,[Description]
      ,[City]
      ,[State]
      ,[Locality]
      ,[Address]
      ,[Pincode]
      ,[Latitude]
      ,[Longitude]
      ,[Status]
      ,[LaunchDate]
      ,[PossessionDate]
      ,[TotalUnits]
	  ,[ProjectArea]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
		FROM [re].[Project]
		WHERE [IsActive]= 1
		AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [re].[Project_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[Project_ReadAllPaginated]
(
  	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);

	SET @SQL = '
	SELECT 
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
		') AS RowNum,
		A.ProjectId,
		A.ProjectName,
		A.Address,
		A.City,
		A.State,
		A.Pincode,
		A.BusinessId,
		B.BusinessName,
		B.BusinessType,
		B.LogoURL,
		A.Status,
		C.ImgPath AS DefaultImage,

		--GET DISTINCT BHK as Comma Seperated
		STUFF((
			SELECT DISTINCT '', '' + CAST(D.BHK AS VARCHAR(10))
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0
				AND D.BHK IS NOT NULL
			FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)''),
			1, 2, '''') AS BHKConfig,

		--Min Carpet Area
		(SELECT MIN(D.CarpetArea)
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0
				AND D.CarpetArea IS NOT NULL) AS MinCarpetArea,

		--Max Carpet Area
		(SELECT MAX(D.CarpetArea)
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0
				AND D.CarpetArea IS NOT NULL) AS MaxCarpetArea,

		--Min Price
		(SELECT MIN(D.BasePrice)
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0	
				AND D.BasePrice IS NOT NULL) AS MinPrice,

		--Max Price
		(SELECT MAX(D.BasePrice)
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0
				AND D.BasePrice IS NOT NULL) AS MaxPrice

	FROM [Nishwik].[re].[Project] A
	INNER JOIN [Nishwik].[re].[BusinessMaster] B
		ON A.[BusinessId] = B.[BusinessId]
	OUTER APPLY (
		SELECT TOP 1 ImgPath
		FROM [Nishwik].[re].[RealEstateImgMaster] C
		WHERE C.MasterType = ''Project''
			AND C.MasterId = A.ProjectId
			AND C.IsDefault = 1
			AND C.IsActive = 1 AND C.IsDeleted = 0
	) C
	WHERE A.IsActive = 1 AND A.IsDeleted = 0';

	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
		SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
		SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL;
	EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [re].[Project_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_ReadByBusinessId]
(
   @BusinessId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ProjectId]
      ,[BusinessId]
      ,[ProjectName]
      ,[Description]
      ,[City]
      ,[State]
      ,[Locality]
      ,[Address]
      ,[Pincode]
      ,[Latitude]
      ,[Longitude]
      ,[Status]
      ,[LaunchDate]
      ,[PossessionDate]
      ,[TotalUnits]
	  ,[ProjectArea]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[Project]
	  WHERE [BusinessId]  = @BusinessId
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[Project_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_ReadById]
(
   @ProjectId BIGINT
)
AS
 BEGIN
     SELECT
	   [ProjectId]
      ,[BusinessId]
      ,[ProjectName]
      ,[Description]
      ,[City]
      ,[State]
      ,[Locality]
      ,[Address]
      ,[Pincode]
      ,[Latitude]
      ,[Longitude]
      ,[Status]
      ,[LaunchDate]
      ,[PossessionDate]
      ,[TotalUnits]
	  ,[ProjectArea]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
		FROM [re].[Project]
		WHERE [ProjectId] = @ProjectId
		AND  [IsActive]= 1
		AND [IsDeleted] =0
END;
GO
/****** Object:  StoredProcedure [re].[Project_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[Project_Update]
(
    @ProjectId BIGINT = NULL,
    @BusinessId  INT = NULL,
	@ProjectName VARCHAR(255) = NULL,
	@Description VARCHAR(500) = NULL,
	@City VARCHAR(100) = NULL,
	@State VARCHAR(100) = NULL,
	@Locality VARCHAR(100) = NULL,
	@Address VARCHAR(100) = NULL,
	@Pincode VARCHAR(10) = NULL,
	@Latitude DECIMAL(10,6) = NULL,
	@Longitude DECIMAL(10,6) = NULL,
	@Status VARCHAR(50) = NULL,
	@LaunchDate DATE = NULL,
	@PossessionDate DATE = NULL,
	@TotalUnits INT = NULL,
	@ProjectArea  DECIMAL(5,2) null,
    @OtherDetail1 VARCHAR(50)   = NULL,
    @OtherDetail2 VARCHAR(50)   = NULL,
    @OtherDetail3 VARCHAR(100)  = NULL,
    @OtherDetail4 VARCHAR(100)  = NULL,
    @OtherDetail5 VARCHAR(500)  = NULL,
    @OtherDetail6 VARCHAR(500)  = NULL,
    @IsActive     INT           = NULL,
    @ActionUser   VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[Project]
    SET 
        [BusinessId] = @BusinessId,
        [ProjectName]	  = TRIM(@ProjectName),
        [Description]	  = TRIM(@Description),
        [City]			  = TRIM(@City),
        [State]			  = TRIM(@State),
        [Locality]		  = TRIM(@Locality),
        [Address]         = TRIM(@Address),
        [Pincode]		  = TRIM(@Pincode),
        [Latitude]		  = @Latitude,
        [Longitude]		  = @Longitude,
        [Status]		  = TRIM(@Status),
        [LaunchDate]	  = @LaunchDate,
        [PossessionDate]  = @PossessionDate,
        [TotalUnits]      = @TotalUnits,
		[ProjectArea]     = @ProjectArea,
        [OtherDetail1]    = TRIM(@OtherDetail1),
        [OtherDetail2]    = TRIM(@OtherDetail2),
        [OtherDetail3]    = TRIM(@OtherDetail3),
        [OtherDetail4]    = TRIM(@OtherDetail4),
        [OtherDetail5]    = TRIM(@OtherDetail5),
        [OtherDetail6]    = TRIM(@OtherDetail6),
        [IsActive]        = @IsActive,
        [ModifiedBy]      = TRIM(@ActionUser),
        [ModifiedOn]      = GETDATE()
    WHERE [ProjectId] = @ProjectId;

    SELECT 
        [ProjectId],
        [BusinessId],
        [ProjectName],
        [Description],
        [City],
        [State],
        [Locality],
        [Address],
        [Pincode],
        [Latitude],
        [Longitude],
        [Status],
        [LaunchDate],
        [PossessionDate],
        [TotalUnits],
		[ProjectArea],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[Project]
    WHERE [ProjectId] = @ProjectId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectBuilding_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [re].[ProjectBuilding_Create]
(
    @ProjectId     BIGINT,
    @BuildingName     VARCHAR(100) = NULL,
    @Floors        INT = NULL,
    @Units         INT = NULL,
    @Status        VARCHAR(50) = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BuildingId BIGINT;

    INSERT INTO [re].[ProjectBuilding]
    (
         [ProjectId]
        ,[BuildingName]
        ,[Floors]
        ,[Units]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @ProjectId
        ,TRIM(@BuildingName)
        ,@Floors
        ,@Units
        ,TRIM(@Status)
        ,TRIM(@OtherDetail1)
        ,TRIM(@OtherDetail2)
        ,TRIM(@OtherDetail3)
        ,TRIM(@OtherDetail4)
        ,TRIM(@OtherDetail5)
        ,TRIM(@OtherDetail6)
        ,1             -- IsActive
        ,0             -- IsDeleted
        ,@ActionUser
        ,GETDATE()
    );

    SET @BuildingId = SCOPE_IDENTITY();

    -- Return the inserted row
    SELECT 
         [BuildingId]
        ,[ProjectId]
        ,[BuildingName]
        ,[Floors]
        ,[Units]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[ProjectBuilding]
    WHERE [BuildingId] = @BuildingId;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectBuilding_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[ProjectBuilding_CreateBulk]
(
    @BuildingIdList [re].[udt_ProjectBuilding] READONLY,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO [re].[ProjectBuilding]
    (
         [ProjectId]
        ,[BuildingName]
        ,[Floors]
        ,[Units]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    SELECT
         [ProjectId]
        ,[BuildingName]
        ,[Floors]
        ,[Units]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,1
        ,0
        ,@ActionUser
        ,GETDATE()
    FROM @BuildingIdList;

    SELECT 
         [BuildingId]
        ,[ProjectId]
        ,[BuildingName]
        ,[Floors]
        ,[Units]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[ProjectBuilding]
    WHERE [IsActive] = 1
      AND [IsDeleted] = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [re].[ProjectBuilding_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectBuilding_Delete]
(
     @BuildingId BIGINT ,
	 @ActionUser VARCHAR(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	  UPDATE[re].[ProjectBuilding]
	  SET 
		   [IsActive] = 0,
		   [IsDeleted] = 1,
		   [ModifiedBy] = @ActionUser,
		   [ModifiedOn] = GETDATE()
	  WHERE  [BuildingId] = @BuildingId
END;
GO
/****** Object:  StoredProcedure [re].[ProjectBuilding_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectBuilding_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT
		   [BuildingId]
		  ,[ProjectId]
		  ,[BuildingName]
		  ,[Floors]
		  ,[Units]
		  ,[Status]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[ProjectBuilding]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectBuilding_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectBuilding_ReadById]
(
     @BuildingId BIGINT 
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT
		   [BuildingId]
		  ,[ProjectId]
		  ,[BuildingName]
		  ,[Floors]
		  ,[Units]
		  ,[Status]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[ProjectBuilding]
	  WHERE  [BuildingId] = @BuildingId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectBuilding_ReadByProjectId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectBuilding_ReadByProjectId]
(
     @ProjectId BIGINT 
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT
		   [BuildingId]
		  ,[ProjectId]
		  ,[BuildingName]
		  ,[Floors]
		  ,[Units]
		  ,[Status]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[ProjectBuilding]
	  WHERE  [ProjectId] = @ProjectId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectBuilding_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [re].[ProjectBuilding_Update]
(
    @BuildingId    BIGINT,
    @ProjectId     BIGINT,
    @BuildingName     VARCHAR(100),
    @Floors        INT,
    @Units         INT,
    @Status        VARCHAR(50),
    @OtherDetail1  VARCHAR(50),
    @OtherDetail2  VARCHAR(50),
    @OtherDetail3  VARCHAR(100),
    @OtherDetail4  VARCHAR(100),
    @OtherDetail5  VARCHAR(500),
    @OtherDetail6  VARCHAR(500),
    @IsActive      INT,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[ProjectBuilding]
    SET
         [ProjectId]    = @ProjectId
        ,[BuildingName]    = TRIM(@BuildingName)
        ,[Floors]       = @Floors
        ,[Units]        = @Units
        ,[Status]       = TRIM(@Status)
        ,[OtherDetail1] = TRIM(@OtherDetail1)
        ,[OtherDetail2] = TRIM(@OtherDetail2)
        ,[OtherDetail3] = TRIM(@OtherDetail3)
        ,[OtherDetail4] = TRIM(@OtherDetail4)
        ,[OtherDetail5] = TRIM(@OtherDetail5)
        ,[OtherDetail6] = TRIM(@OtherDetail6)
        ,[IsActive]     = @IsActive
        ,[ModifiedBy]   = @ActionUser
        ,[ModifiedOn]   = GETDATE()
    WHERE [BuildingId] = @BuildingId;
    SELECT 
         [BuildingId]
        ,[ProjectId]
        ,[BuildingName]
        ,[Floors]
        ,[Units]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[ProjectBuilding]
    WHERE [BuildingId] = @BuildingId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectUnitType_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectUnitType_Create]
(
    @ProjectId BIGINT = NULL,
	@BuildingId BIGINT= NULL,
	@UnitTypeName VARCHAR(100) = NULL,
	@BHK INT = NULL,
	@SuperArea DECIMAL(10,2) = NULL,
	@CarpetArea DECIMAL(10,2) = NULL,
	@Furnishing VARCHAR(50) = NULL,
	@BasePrice DECIMAL(18,2) = NULL,
	@Status VARCHAR(50) = NULL,
	@Facing  VARCHAR(50) NULL,
	@Bathroom INT NULL,
	@Balcony  INT,
	@Parking VARCHAR(50) NULL,
	@Type             VARCHAR(20)  = NULL,
    @PricePerSqFt     DECIMAL(18,2)= NULL,
    @View             VARCHAR(100) = NULL,
    @OtherDetail1  VARCHAR(50)   = NULL,
    @OtherDetail2  VARCHAR(50)   = NULL,
    @OtherDetail3  VARCHAR(100)  = NULL,
    @OtherDetail4  VARCHAR(100)  = NULL,
    @OtherDetail5  VARCHAR(500)  = NULL,
    @OtherDetail6  VARCHAR(500)  = NULL,
    @ActionUser    VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @UnitTypeId BIGINT;

    INSERT INTO [re].[ProjectUnitType]
    (
        [ProjectId],
        [BuildingId],
        [UnitTypeName],
        [BHK],
        [SuperArea],
        [CarpetArea],
        [Furnishing],
        [BasePrice],
        [Status],
		[Facing],
		[Bathroom],
		[Balcony],
		[Parking],
        [Type],
        [PricePerSqFt],
        [View],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ProjectId,
        @BuildingId,
        TRIM(@UnitTypeName),
        @BHK,
        @SuperArea,
        @CarpetArea,
        TRIM(@Furnishing),
        @BasePrice,
        TRIM(@Status),
		@Facing,
		@Bathroom,
		@Balcony,
		@Parking,
        @Type,
        @PricePerSqFt,
        @View,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @UnitTypeId = SCOPE_IDENTITY();

    SELECT 
        [UnitTypeId],
        [ProjectId],
        [BuildingId],
        [UnitTypeName],
        [BHK],
        [SuperArea],
        [CarpetArea],
        [Furnishing],
        [BasePrice],
        [Status],
		[Facing],
		[Bathroom],
		[Balcony],
		[Parking],
        [Type],
        [PricePerSqFt],
        [View],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[ProjectUnitType]
    WHERE [UnitTypeId] = @UnitTypeId;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectUnitType_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectUnitType_CreateBulk]
(
   @UnitTypeIdList [re].[udt_ProjectUnitType] READONLY,
   @ActionUser VARCHAR(50)
)
AS 
 BEGIN
       SET NOCOUNT ON;
	   INSERT INTO [re].[ProjectUnitType]
	   (
	   [ProjectId]
      ,[BuildingId]
      ,[UnitTypeName]
      ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[BasePrice]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
	   )
	  SELECT 
	   [ProjectId]
      ,[BuildingId]
      ,[UnitTypeName]
      ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[BasePrice]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,1
      ,0
      ,@ActionUser
      ,GETDATE()
	FROM @UnitTypeIdList;
	SELECT 
	   [UnitTypeId]
      ,[ProjectId]
      ,[BuildingId]
      ,[UnitTypeName]
      ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[BasePrice]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [Nishwik].[re].[ProjectUnitType]
	  WHERE IsActive = 1
	AND IsDeleted = 0
	AND CreatedBy = @ActionUser
	AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [re].[ProjectUnitType_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectUnitType_Delete]
(
   @UnitTypeId BIGINT,
   @ActionUser VARCHAR (50)
)
AS
 BEGIN
	UPDATE[re].[ProjectUnitType]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [UnitTypeId] = @UnitTypeId
END;
GO
/****** Object:  StoredProcedure [re].[ProjectUnitType_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectUnitType_ReadAll]
AS
 BEGIN
     SELECT
	   [UnitTypeId]
      ,[ProjectId]
      ,[BuildingId]
      ,[UnitTypeName]
      ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[BasePrice]
      ,[Status]
      ,[Facing]
      ,[Bathroom]
      ,[Balcony]
      ,[Parking]
	  ,[Type]
      ,[PricePerSqFt]
      ,[View]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
		FROM [re].[ProjectUnitType]
		WHERE [IsActive]= 1
		AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [re].[ProjectUnitType_ReadByBuildingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectUnitType_ReadByBuildingId]
(
   @BuildingId BIGINT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [UnitTypeId]
      ,[ProjectId]
      ,[BuildingId]
      ,[UnitTypeName]
      ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[BasePrice]
      ,[Status]
	  ,[Facing]
      ,[Bathroom]
      ,[Balcony]
      ,[Parking]
	  ,[Type]
      ,[PricePerSqFt]
      ,[View]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[ProjectUnitType]
	  WHERE [BuildingId]  = @BuildingId
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectUnitType_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectUnitType_ReadById]
(
   @UnitTypeId BIGINT
)
AS
 BEGIN
     SELECT
	   [UnitTypeId]
      ,[ProjectId]
      ,[BuildingId]
      ,[UnitTypeName]
      ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[BasePrice]
      ,[Status]
	  ,[Facing]
      ,[Bathroom]
      ,[Balcony]
      ,[Parking]
	  ,[Type]
      ,[PricePerSqFt]
      ,[View]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
		FROM [re].[ProjectUnitType]
		WHERE [UnitTypeId] = @UnitTypeId
		AND  [IsActive]= 1
		AND [IsDeleted] =0
END;
GO
/****** Object:  StoredProcedure [re].[ProjectUnitType_ReadByProjectId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectUnitType_ReadByProjectId]
(
   @ProjectId BIGINT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [UnitTypeId]
      ,[ProjectId]
      ,[BuildingId]
      ,[UnitTypeName]
      ,[BHK]
      ,[SuperArea]
      ,[CarpetArea]
      ,[Furnishing]
      ,[BasePrice]
      ,[Status]
      ,[Facing]
      ,[Bathroom]
      ,[Balcony]
      ,[Parking]
	  ,[Type]
      ,[PricePerSqFt]
      ,[View]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[ProjectUnitType]
	  WHERE [ProjectId]  = @ProjectId
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ProjectUnitType_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[ProjectUnitType_Update]
(
    @UnitTypeId BIGINT = NULL,
    @ProjectId BIGINT = NULL,
	@BuildingId BIGINT= NULL,
	@UnitTypeName VARCHAR(100) = NULL,
	@BHK INT = NULL,
	@SuperArea DECIMAL(10,2) = NULL,
	@CarpetArea DECIMAL(10,2) = NULL,
	@Furnishing VARCHAR(50) = NULL,
	@BasePrice DECIMAL(18,2) = NULL,
	@Status VARCHAR(50) = NULL,
	@Facing  VARCHAR(50) NULL,
	@Bathroom INT NULL,
	@Balcony  INT,
	@Parking VARCHAR(50) NULL,
    @Type VARCHAR(20) = NULL,
    @PricePerSqFt DECIMAL(18,2) = NULL,
    @View VARCHAR(100) = NULL,
    @OtherDetail1 VARCHAR(50)   = NULL,
    @OtherDetail2 VARCHAR(50)   = NULL,
    @OtherDetail3 VARCHAR(100)  = NULL,
    @OtherDetail4 VARCHAR(100)  = NULL,
    @OtherDetail5 VARCHAR(500)  = NULL,
    @OtherDetail6 VARCHAR(500)  = NULL,
    @IsActive     INT           = NULL,
    @ActionUser   VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[ProjectUnitType]
    SET 
        [ProjectId]       = @ProjectId,
        [BuildingId]      = @BuildingId,
        [UnitTypeName]    = TRIM(@UnitTypeName),
        [BHK]             = @BHK,
        [SuperArea]       = @SuperArea,
        [CarpetArea]      = @CarpetArea,
        [Furnishing]      = TRIM(@Furnishing),
        [BasePrice]       = @BasePrice,
        [Status]          = TRIM(@Status),
		[Facing]          = @Facing,
		[Bathroom]        = @Bathroom,
		[Balcony]         = @Balcony,
		[Parking]         = @Parking,
        [Type]            = @Type,
        [PricePerSqFt]    = @PricePerSqFt,
        [View]            = @View,
        [OtherDetail1]    = TRIM(@OtherDetail1),
        [OtherDetail2]    = TRIM(@OtherDetail2),
        [OtherDetail3]    = TRIM(@OtherDetail3),
        [OtherDetail4]    = TRIM(@OtherDetail4),
        [OtherDetail5]    = TRIM(@OtherDetail5),
        [OtherDetail6]    = TRIM(@OtherDetail6),
        [IsActive]        = @IsActive,
        [ModifiedBy]      = TRIM(@ActionUser),
        [ModifiedOn]      = GETDATE()
    WHERE [UnitTypeId] = @UnitTypeId;

    SELECT 
        [UnitTypeId],
        [ProjectId],
        [BuildingId],
        [UnitTypeName],
        [BHK],
        [SuperArea],
        [CarpetArea],
        [Furnishing],
        [BasePrice],
        [Status],
		[Facing],
        [Bathroom],
        [Balcony],
        [Parking],
        [Type],
        [PricePerSqFt],
        [View],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[ProjectUnitType]
    WHERE [UnitTypeId] = @UnitTypeId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[Property_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [re].[Property_Create]
(
    @BusinessId INT,
    @PostedBy INT,
    @Title VARCHAR(255),
    @Description VARCHAR(255),
    @PropertyType VARCHAR(50),
	@PropertyName  VARCHAR(100),
    @ListingType VARCHAR(10),
    @City VARCHAR(100),
    @State VARCHAR(100),
    @Locality VARCHAR(150),
    @Address VARCHAR(100),
    @Pincode VARCHAR(10),
    @Latitude DECIMAL(18, 8),
    @Longitude DECIMAL(18, 8),
    @Status VARCHAR(50),
    @ListedOn DATETIME,
	@ProjectId BIGINT,
    @BuildingId BIGINT,
    @UnitTypeId BIGINT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PropertyId BIGINT;

    INSERT INTO [re].[Property]
    (
	    [BusinessId],
        [PostedBy],
        [Title],
        [Description],
        [PropertyType],
		[PropertyName],
        [ListingType],
        [City],
        [State],
        [Locality],
        [Address],
        [Pincode],
        [Latitude],
        [Longitude],
        [Status],
        [ListedOn],
        [ProjectId],
        [BuildingId],
        [UnitTypeId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
	    @BusinessId,
        @PostedBy,
        @Title,
        @Description,
        @PropertyType,
		@PropertyName,
        @ListingType,
        @City,
        @State,
        @Locality,
        @Address,
        @Pincode,
        @Latitude,
        @Longitude,
        @Status,
        @ListedOn,
		@ProjectId,
		@BuildingId,
		@UnitTypeId,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1, 
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @PropertyId = SCOPE_IDENTITY();

    SELECT 
        [PropertyId],
        [BusinessId],
        [PostedBy],
        [Title],
        [Description],
        [PropertyType],
		[PropertyName],
        [ListingType],
        [City],
        [State],
        [Locality],
        [Address],
        [Pincode],
        [Latitude],
        [Longitude],
        [Status],
        [ListedOn],
        [ProjectId],
        [BuildingId],
        [UnitTypeId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[Property]
    WHERE [PropertyId] = @PropertyId;
END;
GO
/****** Object:  StoredProcedure [re].[Property_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[Property_CreateBulk]
(
    @ProjectIdList [re].[udt_Property] READONLY,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
		INSERT INTO [re].[Property]
		(
			[BusinessId],
			[PropertyName],
			[Description],
			[City],
			[State],
			[Locality],
			[Address],
			[Pincode],
			[Latitude],
			[Longitude],
			[Status],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn]
		)
		SELECT
			[BusinessId],
			[Title],
			[Description],
			[City],
			[State],
			[Locality],
			[Address],
			[Pincode],
			[Latitude],
			[Longitude],
			[Status],
			1,
			0,
			@ActionUser,
			GETDATE()
		FROM @ProjectIdList;


		SELECT 
		   [ProjectId]
		  ,[BusinessId]
		  ,[ProjectName]
		  ,[Description]
		  ,[City]
		  ,[State]
		  ,[Locality]
		  ,[Address]
		  ,[Pincode]
		  ,[Latitude]
		  ,[Longitude]
		  ,[Status]
		  ,[LaunchDate]
		  ,[PossessionDate]
		  ,[TotalUnits]
		  ,[ProjectArea]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
    FROM [re].[Project]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [re].[Property_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[Property_ReadAll]
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PropertyId]
		,[BusinessId]
        ,[PostedBy]
		,[Title]
		,[Description]
		,[PropertyType]
		,[PropertyName]
		,[ListingType]
		,[City]
		,[State]
		,[Locality]
		,[Address]
		,[Pincode]
		,[Latitude]
		,[Longitude]
		,[Status]
		,[ListedOn]
        ,[ProjectId]
        ,[BuildingId]
        ,[UnitTypeId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[Property]
	WHERE [IsActive] =1
	AND[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[Property_ReadByBusinessIdPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[Property_ReadByBusinessIdPaginated]
(
    @BusinessId INT,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' + 
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
        ') AS RowNum,
         A.[PropertyId]
        ,A.[BusinessId]
        ,A.[PostedBy]
        ,A.[Title]
        ,A.[Description]
        ,A.[PropertyType]
		,A.[PropertyName]
        ,A.[ListingType]
        ,A.[City]
        ,A.[State]
        ,A.[Locality]
        ,A.[Address]
        ,A.[Pincode]
        ,A.[Latitude]
        ,A.[Longitude]
        ,A.[Status]
        ,A.[ListedOn]
        ,A.[ProjectId]
        ,A.[BuildingId]
        ,A.[UnitTypeId]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
        ,C.[BHK]
        ,C.[SuperArea]
        ,C.[CarpetArea]
        ,C.[Furnishing]
        ,C.[FloorNumber]
        ,C.[TotalFloors]
        ,C.[AgeOfConstruction]
        ,C.[Facing]
        ,C.[OwnershipType]
        ,C.[IsActive]
        ,C.[IsDeleted]
        ,C.[CreatedBy]
        ,C.[CreatedOn]
        ,C.[ModifiedBy]
        ,C.[ModifiedOn]
        ,D.[ListingId]
        ,D.[PropertyId]
        ,D.[ListingType]
        ,D.[Price]
        ,D.[MaintenanceCharge]
        ,D.[DepositAmount]
        ,D.[AvailableFrom]
        ,D.[PostedBy]
        ,D.[ListingStatus]
        ,D.[IsActive]
        ,D.[IsDeleted]
        ,D.[CreatedBy]
        ,D.[CreatedOn]
        ,D.[ModifiedBy]
        ,D.[ModifiedOn]
		,E.[BusinessName]
        ,E.[BusinessType]
		,E.[ReraNumber]
        ,E.[PanNumber]
        ,E.[GstNumber]
        ,E.[LogoUrl]
        ,E.[Address]
        ,E.[City]
        ,E.[State]
        ,E.[Pincode]
        ,E.[ContactEmail]
        ,E.[ContactPhone]
        ,E.[WebsiteUrl],
        COUNT(*) OVER () AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [Nishwik].[re].[Property] A
    LEFT OUTER JOIN [re].[PropertyDetails] C ON A.[PropertyId] = C.[PropertyId]
    LEFT OUTER JOIN [re].[PropertyListing] D ON A.[PropertyId] = D.[PropertyId]
	LEFT OUTER JOIN .[re].[BusinessMaster] E ON A.[BusinessId] = E.[BusinessId]
    WHERE A.[BusinessId] = ' + CAST(@BusinessId AS VARCHAR) + ' 
	  AND A.[PropertyType] <> ''Project''
      AND A.[IsActive] = 1 
      AND A.[IsDeleted] = 0
	  AND D.[IsActive] = 1 AND D.[IsDeleted] = 0';

    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    SET @SQL = @SQL + '
    OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL;
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [re].[Property_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[Property_ReadById]
(
    @PropertyId BIGINT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PropertyId]
	    ,[BusinessId]
        ,[PostedBy]
		,[Title]
		,[Description]
		,[PropertyType]
		,[PropertyName]
		,[ListingType]
		,[City]
		,[State]
		,[Locality]
		,[Address]
		,[Pincode]
		,[Latitude]
		,[Longitude]
		,[Status]
		,[ListedOn]
        ,[ProjectId]
        ,[BuildingId]
        ,[UnitTypeId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[Property]
	WHERE [PropertyId] = @PropertyId
	AND[IsActive] =1
	AND [IsDeleted]= 0;
END;
GO
/****** Object:  StoredProcedure [re].[Property_ReadByListingType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[Property_ReadByListingType]
(
   @ListingType  varchar(50)
)
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT
		 [PropertyId]
	    ,[BusinessId]
        ,[PostedBy]
		,[Title]
		,[Description]
		,[PropertyType]
		,[PropertyName]
		,[ListingType]
		,[City]
		,[State]
		,[Locality]
		,[Address]
		,[Pincode]
		,[Latitude]
		,[Longitude]
		,[Status]
		,[ListedOn]
	    ,[ProjectId]
        ,[BuildingId]
        ,[UnitTypeId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[Property]
	WHERE [ListingType] = @ListingType
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[Property_ReadByPropertyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[Property_ReadByPropertyId]
(
   @ListingType  varchar(10)
)
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT
		 [PropertyId]
	    ,[BusinessId]
        ,[PostedBy]
		,[Title]
		,[Description]
		,[PropertyType]
		,[PropertyName]
		,[ListingType]
		,[City]
		,[State]
		,[Locality]
		,[Address]
		,[Pincode]
		,[Latitude]
		,[Longitude]
		,[Status]
		,[ListedOn]
		,[ProjectId]
        ,[BuildingId]
        ,[UnitTypeId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[Property]
	WHERE [ListingType] = @ListingType
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[Property_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [re].[Property_Update]
(
    @PropertyId BIGINT,
	@BusinessId int,
    @PostedBy INT,
    @Title VARCHAR(255),
    @Description VARCHAR(255),
    @PropertyType VARCHAR(50),
	@PropertyName VARCHAR(100),
    @ListingType VARCHAR(10),
    @City VARCHAR(100),
    @State VARCHAR(100),
    @Locality VARCHAR(150),
    @Address VARCHAR(100),
    @Pincode VARCHAR(10),
    @Latitude DECIMAL(18, 8),
    @Longitude DECIMAL(18, 8),
    @Status VARCHAR(50),
    @ListedOn DATETIME,
	@ProjectId BIGINT,
    @BuildingId BIGINT,
    @UnitTypeId BIGINT,
    @OtherDetail1 VARCHAR(50), 
    @OtherDetail2 VARCHAR(50), 
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
	@IsActive int,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[Property]
    SET
	    [BusinessId] = @BusinessId,
        [PostedBy] = @PostedBy,
        [Title] = @Title,
        [Description] = @Description,
        [PropertyType] = @PropertyType,
		[PropertyName] = @PropertyName,
        [ListingType] = @ListingType,
        [City] = @City,
        [State] = @State,
        [Locality] = @Locality,
        [Address] = @Address,
        [Pincode] = @Pincode,
        [Latitude] = @Latitude,
        [Longitude] = @Longitude,
        [Status] = @Status,
        [ListedOn] = @ListedOn,
		[ProjectId] = @ProjectId,
        [BuildingId] = @BuildingId,
        [UnitTypeId] = @UnitTypeId,
		[IsActive] = @IsActive,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [PropertyId] = @PropertyId;

    SELECT 
        [PropertyId],
		[BusinessId],
        [PostedBy],
        [Title],
        [Description],
        [PropertyType],
		[PropertyName],
        [ListingType],
        [City],
        [State],
        [Locality],
        [Address],
        [Pincode],
        [Latitude],
        [Longitude],
        [Status],
        [ListedOn],
		[ProjectId],
        [BuildingId],
        [UnitTypeId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[Property]
    WHERE [PropertyId] = @PropertyId
	AND [IsActive]= 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyAmenities_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[PropertyAmenities_Create]
(
    @AmenityId BIGINT,
    @MasterId     INT,
    @MasterType   VARCHAR(50),
    @IsAvailable  INT,
    @OtherDetail1 VARCHAR(50) = NULL,
    @OtherDetail2 VARCHAR(50) = NULL,
    @OtherDetail3 VARCHAR(100) = NULL,
    @OtherDetail4 VARCHAR(100) = NULL,
    @OtherDetail5 VARCHAR(500) = NULL,
    @OtherDetail6 VARCHAR(500) = NULL,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;


    INSERT INTO [re].[PropertyAmenities]
    (
	    [AmenityId],
        [MasterId],
        [MasterType],
        [IsAvailable],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    ( 
	    @AmenityId,
        @MasterId,
        TRIM(@MasterType),
        @IsAvailable,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );
    SELECT 
        [AmenityId],
        [MasterId],
        [MasterType],
        [IsAvailable],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[PropertyAmenities]
    WHERE [AmenityId] = @AmenityId
	  AND [MasterId] = @MasterId
	  AND [MasterType] = @MasterType
      AND [IsActive] = 1
      AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyAmenities_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[PropertyAmenities_Delete]
(
   @AmenityId  BIGINT,
   @ActionUser varchar(50)
)
AS
	BEGIN 
	SET NOCOUNT ON;
   update[re].[PropertyAmenities]
   SET 
			 [IsActive]  = 0,
			 [IsDeleted] = 1,
			 [ModifiedBy] = @ActionUser,
			 [ModifiedOn] = GETDATE()
	WHERE [AmenityId] = @AmenityId
END;
GO
/****** Object:  StoredProcedure [re].[PropertyAmenities_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[PropertyAmenities_ReadAll]
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [AmenityId]
		,[MasterId]
        ,[MasterType]
		,[IsAvailable]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[PropertyAmenities]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyAmenities_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[PropertyAmenities_ReadById]
(
   @AmenityId  BIGINT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
	     [AmenityId]
	    ,[MasterId]
        ,[MasterType]
		,[IsAvailable]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[PropertyAmenities]
	WHERE [AmenityId] = @AmenityId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyAmenities_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[PropertyAmenities_ReadByMasterId]
(
   @MasterId  INT,
   @MasterType VARCHAR(50)
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 A.[AmenityId]
		,A.[MasterId]
        ,A.[MasterType]
		,A.[IsAvailable]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
		,B.[AmenityId]
		,B.[AmenityName]
		,B.[AmenityCategory]
		,B.[IconPath]
	FROM [re].[PropertyAmenities] A
	LEFT OUTER JOIN [re].[AmenitiesMaster] B
	ON A.[AmenityId] = B.[AmenityId]
	WHERE A.[MasterId] = @MasterId
	AND A.[MasterType] = @MasterType
	AND A.[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyAmenities_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[PropertyAmenities_Update]
(
    @AmenityId    BIGINT,
    @MasterId     INT,
    @MasterType   VARCHAR(50),
    @IsAvailable  INT,
    @OtherDetail1 VARCHAR(50) = NULL,
    @OtherDetail2 VARCHAR(50) = NULL,
    @OtherDetail3 VARCHAR(100) = NULL,
    @OtherDetail4 VARCHAR(100) = NULL,
    @OtherDetail5 VARCHAR(500) = NULL,
    @OtherDetail6 VARCHAR(500) = NULL,
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[PropertyAmenities]
    SET
        [MasterId] = @MasterId,
        [MasterType] = TRIM(@MasterType),
        [IsAvailable] = @IsAvailable,
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive] = @IsActive,
        [ModifiedBy] = TRIM(@ActionUser),
        [ModifiedOn] = GETDATE()
    WHERE [AmenityId] = @AmenityId

    SELECT 
        [AmenityId],
        [MasterId],
        [MasterType],
        [IsAvailable],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[PropertyAmenities]
    WHERE [AmenityId] = @AmenityId
      AND [IsDeleted] = 0
	    AND [IsActive] = 1;
END;

GO
/****** Object:  StoredProcedure [re].[PropertyById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyById]
(
   @ListingId  BIGINT
)
AS
	BEGIN
	SET NOCOUNT ON;
	SELECT
		 [ListingId]
		,[PropertyId]
		,[ListingType]
		,[Price]
		,[MaintenanceCharge]
		,[DepositAmount]
		,[AvailableFrom]
		,[PostedBy]
		,[ListingStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
	    ,[ModifiedOn]
	FROM [re].[PropertyListing]
	WHERE [ListingId] = @ListingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyDetails_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[PropertyDetails_Create]
(
    @PropertyId BIGINT,
    @BHK INT,
    @SuperArea DECIMAL(18, 2),
    @CarpetArea DECIMAL(18, 2),
	@Bathroom  DECIMAL (18,2),
	@Balcony   DECIMAL(18,2),
	@Parking   Varchar(50),
    @Furnishing VARCHAR(50),
    @FloorNumber INT,
    @TotalFloors INT,
    @AgeOfConstruction INT,
    @Facing VARCHAR(50),
    @OwnershipType VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [re].[PropertyDetails]
    (
	    [PropertyId],
        [BHK],
        [SuperArea],
        [CarpetArea],
		[Bathroom],
		[Balcony] ,
		[Parking] ,
        [Furnishing],
        [FloorNumber],
        [TotalFloors],
        [AgeOfConstruction],
        [Facing],
        [OwnershipType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
	    @PropertyId,
        @BHK,
        @SuperArea,
        @CarpetArea,
		@Bathroom,
		@Balcony,
		@Parking,
        @Furnishing,
        @FloorNumber,
        @TotalFloors,
        @AgeOfConstruction,
        @Facing,
        @OwnershipType,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT 
	    [DetailId],
        [PropertyId],
        [BHK],
        [SuperArea],
        [CarpetArea],
		[Bathroom],
		[Balcony] ,
		[Parking] ,
        [Furnishing],
        [FloorNumber],
        [TotalFloors],
        [AgeOfConstruction],
        [Facing],
        [OwnershipType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[PropertyDetails]
    WHERE [PropertyId] = @PropertyId;
END
GO
/****** Object:  StoredProcedure [re].[PropertyDetails_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyDetails_Delete]
(
   @DetailId BIGINT,
   @ActionUser varchar(50)
)
AS
	BEGIN 
	SET NOCOUNT ON;
	UPDATE[re].[PropertyDetails]
	SET
		 [IsActive] = 0,
		 [IsDeleted] =1,
		 [ModifiedBy] = @ActionUser,
		 [ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [re].[PropertyDetails_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyDetails_ReadAll]
AS
  BEGIN 
   SET NOCOUNT ON;
   SELECT 
           [DetailId]
		  ,[PropertyId]
		  ,[BHK]
		  ,[SuperArea]
		  ,[CarpetArea]
		  ,[Bathroom]
		  ,[Balcony] 
		  ,[Parking] 
		  ,[Furnishing]
		  ,[FloorNumber]
		  ,[TotalFloors]
		  ,[AgeOfConstruction]
		  ,[Facing]
		  ,[OwnershipType]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[PropertyDetails]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyDetails_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyDetails_ReadById]
(
   @PropertyId BIGINT
)
AS
  BEGIN 
   SET NOCOUNT ON;
   SELECT 
           [DetailId]
		  ,[PropertyId]
		  ,[BHK]
		  ,[SuperArea]
		  ,[CarpetArea]
		  ,[Bathroom]
		  ,[Balcony] 
		  ,[Parking] 
		  ,[Furnishing]
		  ,[FloorNumber]
		  ,[TotalFloors]
		  ,[AgeOfConstruction]
		  ,[Facing]
		  ,[OwnershipType]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[PropertyDetails]
	  WHERE [PropertyId] = @PropertyId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyDetails_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [re].[PropertyDetails_Update]
(
    @DetailId  INT,
    @PropertyId BIGINT,
    @BHK INT,
    @SuperArea DECIMAL(18, 2),
    @CarpetArea DECIMAL(18, 2),
	@Bathroom  DECIMAL (18,2),
	@Balcony   DECIMAL(18,2),
	@Parking   Varchar(50),
    @Furnishing VARCHAR(50),
    @FloorNumber INT,
    @TotalFloors INT,
    @AgeOfConstruction INT,
    @Facing VARCHAR(50),
    @OwnershipType VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[PropertyDetails]
    SET
	    [PropertyId] = @PropertyId,
        [BHK] = @BHK,
        [SuperArea] = @SuperArea,
        [CarpetArea] = @CarpetArea,
		[Bathroom]   = @Bathroom,
		[Balcony]    = @Balcony,
		[Parking]     = @Parking,
        [Furnishing] = @Furnishing,
        [FloorNumber] = @FloorNumber,
        [TotalFloors] = @TotalFloors,
        [AgeOfConstruction] = @AgeOfConstruction,
        [Facing] = @Facing,
        [OwnershipType] = @OwnershipType,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [PropertyId] = @PropertyId;

    SELECT 
	    [DetailId],
        [PropertyId],
        [BHK],
        [SuperArea],
        [CarpetArea],
		[Bathroom],
		[Balcony] ,
		[Parking] ,
        [Furnishing],
        [FloorNumber],
        [TotalFloors],
        [AgeOfConstruction],
        [Facing],
        [OwnershipType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[PropertyDetails]
    WHERE [PropertyId] = @PropertyId;
END
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_CheckIfUserEnquired]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_CheckIfUserEnquired]
(
   @MasterId INT,
   @MasterType VARCHAR(50),
   @UserId BIGINT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ContactLogId]
	  ,[MasterId]
      ,[MasterType]
      ,[UserId]
      ,[OwnerUserId]
      ,[ClickedOn]
      ,[ContactType]
      ,[Source]
      ,[IPAddress]
      ,[UserAgent]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[PropertyInquiries]
	  WHERE  [UserId] = @UserId
	    AND [MasterId] = @MasterId
		AND [MasterType] = @MasterType
		AND [IsActive] = 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_Create]
(
    @MasterId   INT,                 -- New required
    @MasterType VARCHAR(50), 
	@UserId INT,
	@OwnerUserId INT,
	@ClickedOn DATETIME,
	@ContactType VARCHAR(20),
	@Source VARCHAR(50),
	@IPAddress VARCHAR(45),
	@UserAgent VARCHAR(255),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50) 
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ContactLogId BIGINT;

    INSERT INTO [re].[PropertyInquiries]
    ( 
	    [MasterId],
        [MasterType],
        [UserId],
        [OwnerUserId],
        [ClickedOn],
        [ContactType],
        [Source],
        [IPAddress],
        [UserAgent],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
	    @MasterId,
		@MasterType,
        @UserId,
        @OwnerUserId,
        @ClickedOn,
        @ContactType,
        @Source,
        @IPAddress,
        @UserAgent,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @ContactLogId = SCOPE_IDENTITY();

    SELECT 
        [ContactLogId],
		[MasterId],
        [MasterType],
        [UserId],
        [OwnerUserId],
        [ClickedOn],
        [ContactType],
        [Source],
        [IPAddress],
        [UserAgent],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[PropertyInquiries]
    WHERE [ContactLogId] = @ContactLogId;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_Delete]
(
   @ContactLogId BIGINT,
   @ActionUser VARCHAR (50)
)
AS
 BEGIN
	UPDATE[re].[PropertyInquiries]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ContactLogId] = @ContactLogId
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_GetEnquiredUserDetails]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_GetEnquiredUserDetails]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
	   A.[UserId]
	  ,A.[MasterId]
      ,A.[MasterType]
      ,A.[OwnerUserId]
      ,A.[ClickedOn]
      ,A.[ContactType]
      ,A.[Source]
      ,A.[IPAddress]
      ,A.[UserAgent]
	  ,B.[FirstName]
	  ,B.[MiddleName]
	  ,B.[LastName]
	  ,B.[AadharNumber]
	  ,B.[PanNumber]
	  ,B.[MobileNo]
	  ,B.[EmailId]
	  ,B.[Address]
	  FROM [re].[PropertyInquiries] A
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B
		ON B.[UserId] = A.[UserId]
	  WHERE A.[MasterId]  = @MasterId
		AND A.[MasterType] = @MasterType
		AND B.[IsActive] = 1
		AND A.[IsActive] = 1
		AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_ReadAll]
AS
 BEGIN
     SELECT
	   [ContactLogId]
      ,[MasterId]
      ,[MasterType]
      ,[UserId]
      ,[OwnerUserId]
      ,[ClickedOn]
      ,[ContactType]
      ,[Source]
      ,[IPAddress]
      ,[UserAgent]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
		FROM [re].[PropertyInquiries]
		WHERE [IsActive]= 1
		AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_ReadById]
(
   @ContactLogId BIGINT
)
AS
 BEGIN
     SELECT
	   [ContactLogId]
	  ,[MasterId]
      ,[MasterType]
      ,[UserId]
      ,[OwnerUserId]
      ,[ClickedOn]
      ,[ContactType]
      ,[Source]
      ,[IPAddress]
      ,[UserAgent]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
		FROM [re].[PropertyInquiries]
		WHERE [ContactLogId] = @ContactLogId
		AND  [IsActive]= 1
		AND [IsDeleted] =0
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ContactLogId]
      ,[MasterId]
      ,[MasterType]
      ,[UserId]
      ,[OwnerUserId]
      ,[ClickedOn]
      ,[ContactType]
      ,[Source]
      ,[IPAddress]
      ,[UserAgent]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[PropertyInquiries]
	  WHERE [MasterId]  = @MasterId
	  AND [MasterType] = @MasterType
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_ReadByOwnerUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_ReadByOwnerUserId]
(
   @OwnerUserId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ContactLogId]
	  ,[MasterId]
      ,[MasterType]
      ,[UserId]
      ,[OwnerUserId]
      ,[ClickedOn]
      ,[ContactType]
      ,[Source]
      ,[IPAddress]
      ,[UserAgent]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[PropertyInquiries]
	  WHERE [OwnerUserId]  = @OwnerUserId
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_ReadByUserId]
(
   @UserId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ContactLogId]
      ,[MasterId]
      ,[MasterType]
      ,[UserId]
      ,[OwnerUserId]
      ,[ClickedOn]
      ,[ContactType]
      ,[Source]
      ,[IPAddress]
      ,[UserAgent]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[PropertyInquiries]
	  WHERE [UserId]  = @UserId
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyInquiries_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[PropertyInquiries_Update]
(
    @ContactLogId BIGINT,
    @MasterId   INT,                 -- New required
    @MasterType VARCHAR(50), 
	@UserId INT,
	@OwnerUserId INT,
	@ClickedOn DATETIME,
	@ContactType VARCHAR(20),
	@Source VARCHAR(50),
	@IPAddress VARCHAR(45),
	@UserAgent VARCHAR(255),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50) 
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[PropertyInquiries]
    SET  
        [MasterId] =  @MasterId,
		[MasterType] = @MasterType,
        [UserId] = @UserId,
        [OwnerUserId] = @OwnerUserId,
        [ClickedOn] = @ClickedOn,
        [ContactType] = @ContactType,
        [Source] = @Source,
        [IPAddress] = @IPAddress,
        [UserAgent] = @UserAgent,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive]     = @IsActive,
        [ModifiedBy]   = @ActionUser,
        [ModifiedOn]   = GETDATE()
    WHERE [ContactLogId] = @ContactLogId;

    SELECT 
        [ContactLogId],
        [MasterId],
        [MasterType],
        [UserId],
        [OwnerUserId],
        [ClickedOn],
        [ContactType],
        [Source],
        [IPAddress],
        [UserAgent],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[PropertyInquiries]
    WHERE [ContactLogId] = @ContactLogId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_CompareListings]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[PropertyListing_CompareListings]
(
    @PropertyId1 BIGINT = NULL,
    @PropertyId2 BIGINT = NULL,
    @PropertyId3 BIGINT = NULL
)
AS
BEGIN 

   SET NOCOUNT ON;

    SELECT
         A.[ListingId]
        ,A.[PropertyId]
        ,A.[ListingType]
        ,A.[Price]
        ,A.[Negotiable]
        ,A.[MaintenanceCharge]
        ,A.[DepositAmount]
        ,A.[AvailableFrom]
        ,A.[PropertyStatus]
        ,A.[PostedBy]
        ,A.[IsVerified]
        ,A.[ListingStatus]
        ,B.[BusinessId]
        ,B.[Title]
        ,B.[Description]
        ,B.[PropertyType]
        ,B.[City]
        ,B.[State]
        ,B.[Locality]
        ,B.[Address]
        ,B.[Pincode]
        ,B.[Latitude]
        ,B.[Longitude]
        ,B.[Status]
        ,B.[ListedOn]
        ,C.[BHK]
        ,C.[SuperArea]
        ,C.[CarpetArea]
        ,C.[Furnishing]
        ,C.[FloorNumber]
        ,C.[TotalFloors]
        ,C.[AgeOfConstruction]
        ,C.[Facing]
        ,C.[OwnershipType]
        ,D.[BusinessName]
        ,D.[BusinessType]
        ,D.[LogoUrl]
	   FROM [re].[PropertyListing] A
    LEFT JOIN [re].[Property] B ON B.PropertyId = A.PropertyId
    LEFT JOIN [re].[PropertyDetails] C ON C.PropertyId = A.PropertyId
    LEFT JOIN [re].[BusinessMaster] D ON D.BusinessId = B.BusinessId
    WHERE A.[PropertyId] IN (@PropertyId1, @PropertyId2, @PropertyId3)
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyListing_Create]
(
    @PropertyId BIGINT,
    @ListingType VARCHAR(50),
    @Price DECIMAL(18, 2),
	@Negotiable INT,
    @MaintenanceCharge DECIMAL(18, 2),
    @DepositAmount DECIMAL(18, 2),
    @AvailableFrom DATETIME,
	@PropertyStatus VARCHAR(50),
    @PostedBy INT,
	@IsVerified  INT,
    @ListingStatus VARCHAR(50),
	@ValidityPeriod INT,
	@ValidFrom DATETIME ,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ListingId BIGINT;

    INSERT INTO [re].[PropertyListing]
    (
        [PropertyId],
        [ListingType],
        [Price],
		[Negotiable],
        [MaintenanceCharge],
        [DepositAmount],
        [AvailableFrom],
		[PropertyStatus],
        [PostedBy],
		[IsVerified],
        [ListingStatus],
		[ValidityPeriod],
		[ValidFrom] ,
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @PropertyId,
        @ListingType,
        @Price,
		@Negotiable,
        @MaintenanceCharge,
        @DepositAmount,
        @AvailableFrom,
		@PropertyStatus,
        @PostedBy,
		@IsVerified,
        @ListingStatus,
		@ValidityPeriod,
		@ValidFrom,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @ListingId = SCOPE_IDENTITY();

    SELECT
	   [ListingId]
      ,[PropertyId]
      ,[ListingType]
      ,[Price]
	  ,[Negotiable]
      ,[MaintenanceCharge]
      ,[DepositAmount]
      ,[AvailableFrom]
	  ,[PropertyStatus]
      ,[PostedBy]
	  ,[IsVerified]
      ,[ListingStatus]
	  ,[ValidityPeriod]
	  ,[ValidFrom]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [re].[PropertyListing]
    WHERE [ListingId] = @ListingId;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyListing_Delete]
(
    @ListingId bigint,
	@ActionUser varchar(50)
)
AS
BEGIN 

  SET NOCOUNT ON;
  UPDATE [re].[PropertyListing]
  SET
         [IsActive] = 0,
         [IsDeleted] = 1,
         [ModifiedBy] = @ActionUser,
         [ModifiedOn] = GETDATE()
	  WHERE [ListingId] = @ListingId

END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_GetPropertyDetails]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[PropertyListing_GetPropertyDetails]
(
    @PropertyId bigint
)
AS
BEGIN 

  SET NOCOUNT ON;
  SELECT
       A.[ListingId]
      ,A.[PropertyId]
      ,A.[ListingType]
      ,A.[Price]
	  ,A.[Negotiable]
      ,A.[MaintenanceCharge]
      ,A.[DepositAmount]
      ,A.[AvailableFrom]
	  ,A.[PropertyStatus]
      ,A.[PostedBy]
	  ,A.[IsVerified]
      ,A.[ListingStatus]
	  ,A.[ValidityPeriod]
	  ,A.[ValidFrom]
      ,B.[BusinessId]
      ,B.[Title]
      ,B.[Description]
      ,B.[PropertyType]
      ,B.[City]
      ,B.[State]
      ,B.[Locality]
      ,B.[Address]
      ,B.[Pincode]
      ,B.[Latitude]
      ,B.[Longitude]
      ,B.[Status]
      ,B.[ListedOn]
	  ,C.[BHK]
      ,C.[SuperArea]
      ,C.[CarpetArea]
      ,C.[Furnishing]
      ,C.[FloorNumber]
      ,C.[TotalFloors]
      ,C.[AgeOfConstruction]
      ,C.[Facing]
      ,C.[OwnershipType]
	  ,D.[BusinessName]
      ,D.[BusinessType]
      ,D.[LogoUrl]
	  FROM[re].[PropertyListing]A
	  LEFT OUTER JOIN [re].[Property]B
	  ON B.PropertyId = @PropertyId
	  LEFT OUTER JOIN [re].[PropertyDetails]C
	  ON C.PropertyId = @PropertyId
	  LEFT OUTER JOIN [re].[BusinessMaster]D
	  ON D.[BusinessId]= B.[BusinessId]
	  WHERE A.[PropertyId] = @PropertyId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyListing_ReadAll]
AS
BEGIN
   SET NOCOUNT ON;
   SELECT 
	   [ListingId]
      ,[PropertyId]
      ,[ListingType]
      ,[Price]
	  ,[Negotiable]
      ,[MaintenanceCharge]
      ,[DepositAmount]
      ,[AvailableFrom]
	  ,[PropertyStatus]
      ,[PostedBy]
	  ,[IsVerified]
      ,[ListingStatus]
	  ,[ValidityPeriod]
	  ,[ValidFrom]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[PropertyListing]
	  WHERE[IsActive] =1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyListing_ReadAllPaginated]
(
    @UserId INT = NULL,
	@PageSize INT,
	@PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' + 
            ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
        ') AS RowNum,
        A.[ListingId],
        A.[PropertyId],
        A.[Price],
        A.[MaintenanceCharge],
        A.[DepositAmount],
        A.[AvailableFrom],
        B.[BusinessId],
        B.[PostedBy],
        B.[Title],
        B.[PropertyType],
        B.[ListingType],
        B.[City],
        B.[State],
        B.[Locality],
        B.[Address],
        B.[Pincode],
        B.[Status],
        B.[ListedOn],
        C.[BusinessName],
        C.[BusinessType],
        C.[IsVerified],
        C.[LogoUrl],
        D.[BHK],
        D.[SuperArea],
        D.[Furnishing],
        D.[FloorNumber],
        D.[TotalFloors],
        D.[AgeOfConstruction],
        D.[Facing],
        -- Get only the default listing image
        (
            SELECT TOP 1 RIM.[ImgPath]
            FROM [re].[RealEstateImgMaster] RIM
            WHERE RIM.[MasterType] = ''Listing''
              AND RIM.[MasterId] = A.[PropertyId]
              AND RIM.[IsActive] = 1
              AND RIM.[IsDeleted] = 0
            ORDER BY 
                CASE WHEN RIM.[IsDefault] = 1 THEN 0 ELSE 1 END,
                RIM.[CreatedOn] DESC
        ) AS ListingImage,
					COUNT(*) OVER () AS TotalCount,
	' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
	' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [re].[PropertyListing] A
    LEFT JOIN [re].[Property] B ON A.[PropertyId] = B.[PropertyId]
    LEFT JOIN [re].[BusinessMaster] C ON B.[BusinessId] = C.[BusinessId]
    LEFT JOIN [re].[PropertyDetails] D ON A.[PropertyId] = D.[PropertyId]
    WHERE 
        A.[IsActive] = 1
        AND A.[IsDeleted] = 0
		AND B.[PropertyType] <> ''Project''
        AND (
            ' + 
            CASE 
                WHEN @UserId IS NULL THEN '1=1' 
                ELSE '
                    A.[PropertyId] NOT IN (
                        SELECT R.[MasterId]
                        FROM [re].[ReportedListing] R
                        WHERE 
                            R.[UserId] = ' + CAST(@UserId AS NVARCHAR) + '
							AND R.[MasterType] = ''Property''
                            AND R.[IsActive] = 1
                            AND R.[IsDeleted] = 0
                    )'
            END + '
        )';

    IF @WhereClause IS NOT NULL AND LEN(LTRIM(RTRIM(@WhereClause))) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';


	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_ReadAllPaginatedForAdmin]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [re].[PropertyListing_ReadAllPaginatedForAdmin]  
    @UserId = 1,           
    @PageSize = 10,        
    @PageNo = 1,            
    @OrderByClause = '',  
    @WhereClause = NULL;   


*/
CREATE PROCEDURE [re].[PropertyListing_ReadAllPaginatedForAdmin] 
(
    @UserId INT = NULL,
	@PageSize INT,
	@PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' + 
            ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
        ') AS RowNum,
        A.[ListingId],
        A.[PropertyId],
        A.[Price],
        A.[MaintenanceCharge],
        A.[DepositAmount],
        A.[AvailableFrom],
        B.[BusinessId],
        B.[PostedBy],
		E.[FirstName] + '' '' + E.[LastName] AS [ContactPersonName],
		E.[MobileNo] AS [ContactPersonNumber],
        B.[Title],
        B.[PropertyType],
        B.[ListingType],
        B.[City],
        B.[State],
        B.[Locality],
        B.[Address],
        B.[Pincode],
        B.[Status],
        B.[ListedOn],
        C.[BusinessName],
        C.[BusinessType],
        C.[IsVerified],
        C.[LogoUrl],
        D.[BHK],
		D.[Bathroom],
        D.[SuperArea],
        D.[Furnishing],
        D.[FloorNumber],
        D.[TotalFloors],
        D.[AgeOfConstruction],
        D.[Facing],
        -- Get only the default listing image
        (
            SELECT TOP 1 RIM.[ImgPath]
            FROM [re].[RealEstateImgMaster] RIM
            WHERE RIM.[MasterType] = ''Listing''
              AND RIM.[MasterId] = A.[PropertyId]
              AND RIM.[IsActive] = 1
              AND RIM.[IsDeleted] = 0
            ORDER BY 
                CASE WHEN RIM.[IsDefault] = 1 THEN 0 ELSE 1 END,
                RIM.[CreatedOn] DESC
        ) AS ListingImage,
			COUNT(*) OVER () AS TotalCount,
	' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
	' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [re].[PropertyListing] A
    LEFT JOIN [re].[Property] B ON A.[PropertyId] = B.[PropertyId]
    LEFT JOIN [re].[BusinessMaster] C ON B.[BusinessId] = C.[BusinessId]
    LEFT JOIN [re].[PropertyDetails] D ON A.[PropertyId] = D.[PropertyId]
	LEFT JOIN [dbo].[UserMaster] E on E.[UserId] = B.[PostedBy]
    WHERE 
        A.[IsActive] = 1 AND A.[IsDeleted] = 0
        AND A.[IsDeleted] = 0
		AND B.[PropertyType] <> ''Project''
        AND (
            ' + 
            CASE 
                WHEN @UserId IS NULL THEN '1=1' 
                ELSE '
                    A.[PropertyId] NOT IN (
                        SELECT R.[MasterId]
                        FROM [re].[ReportedListing] R
                        WHERE 
                            R.[UserId] = ' + CAST(@UserId AS NVARCHAR) + '
							AND R.[MasterType] = ''Property''
                            AND R.[IsActive] = 1
                            AND R.[IsDeleted] = 0
                    )'
            END + '
        )';

    IF @WhereClause IS NOT NULL AND LEN(LTRIM(RTRIM(@WhereClause))) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
	END;

GO
/****** Object:  StoredProcedure [re].[PropertyListing_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyListing_ReadById]
(
    @ListingId bigint
)
AS
BEGIN 

  SET NOCOUNT ON;
  SELECT
       [ListingId]
      ,[PropertyId]
      ,[ListingType]
      ,[Price]
	  ,[Negotiable]
      ,[MaintenanceCharge]
      ,[DepositAmount]
      ,[AvailableFrom]
	  ,[PropertyStatus]
      ,[PostedBy]
	  ,[IsVerified]
      ,[ListingStatus]
	  ,[ValidityPeriod]
	  ,[ValidFrom]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[re].[PropertyListing]
	  WHERE [ListingId] = @ListingId
	  AND IsActive =1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_ReadByPropertyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyListing_ReadByPropertyId]
(
    @PropertyId bigint
)
AS
BEGIN 

  SET NOCOUNT ON;
  SELECT
       [ListingId]
      ,[PropertyId]
      ,[ListingType]
      ,[Price]
	  ,[Negotiable]
      ,[MaintenanceCharge]
      ,[DepositAmount]
      ,[AvailableFrom]
	  ,[PropertyStatus]
      ,[PostedBy]
	  ,[IsVerified]
      ,[ListingStatus]
	  ,[ValidityPeriod]
	  ,[ValidFrom]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[re].[PropertyListing]
	  WHERE [PropertyId] = @PropertyId
	  AND IsActive =1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyListing_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyListing_Update]
(
    @ListingId BIGINT,
    @PropertyId BIGINT,
    @ListingType VARCHAR(50),
    @Price DECIMAL(18, 2),
	@Negotiable INT,
    @MaintenanceCharge DECIMAL(18, 2),
    @DepositAmount DECIMAL(18, 2),
    @AvailableFrom DATETIME,
	@PropertyStatus VARCHAR(50),
    @PostedBy INT,
	@IsVerified  INT,
    @ListingStatus VARCHAR(50),
	@ValidityPeriod INT,
	@ValidFrom DATETIME,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[PropertyListing]
    SET
        [PropertyId] = @PropertyId,
        [ListingType] = @ListingType,
        [Price] = @Price,
		[Negotiable] = @Negotiable,
        [MaintenanceCharge] = @MaintenanceCharge,
        [DepositAmount] = @DepositAmount,
        [AvailableFrom] = @AvailableFrom,
		[PropertyStatus] = @PropertyStatus,
        [PostedBy] = @PostedBy,
		[IsVerified] = @IsVerified,
        [ListingStatus] = @ListingStatus,
		[ValidityPeriod] = @ValidityPeriod,
		[ValidFrom] = @ValidFrom,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [ListingId] = @ListingId;

    SELECT
       [ListingId]
      ,[PropertyId]
      ,[ListingType]
      ,[Price]
	  ,[Negotiable]
      ,[MaintenanceCharge]
      ,[DepositAmount]
      ,[AvailableFrom]
	  ,[PropertyStatus]
      ,[PostedBy]
	  ,[IsVerified]
      ,[ListingStatus]
	  ,[ValidityPeriod]
	  ,[ValidFrom]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [re].[PropertyListing]
    WHERE [ListingId] = @ListingId;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyOffer_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyOffer_Create]
(
    @ListingId BIGINT,
    @OfferedBy INT,
    @OfferAmount DECIMAL(18, 2),
    @OfferDate DATETIME,
    @Status VARCHAR(50),
    @CounterOfferAmount DECIMAL(18, 2),
    @Remarks VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @OfferId BIGINT;

    INSERT INTO [re].[PropertyOffer]
    (
        [ListingId],
        [OfferedBy],
        [OfferAmount],
        [OfferDate],
        [Status],
        [CounterOfferAmount],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ListingId,
        @OfferedBy,
        @OfferAmount,
        @OfferDate,
        @Status,
        @CounterOfferAmount,
        @Remarks,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @OfferId = SCOPE_IDENTITY();

    SELECT 
       [OfferId],
       [ListingId],
       [OfferedBy],
       [OfferAmount],
       [OfferDate],
       [Status],
       [CounterOfferAmount],
       [Remarks],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
    FROM [re].[PropertyOffer]
    WHERE [OfferId] = @OfferId;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyOffer_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyOffer_Delete]
(
   @OfferId BIGINT ,
   @ActionUser varchar(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
   UPDATE [re].[PropertyOffer]
   SET
          [IsActive] = 0,
          [IsDeleted] = 1, 
          [ModifiedBy] = @ActionUser,
          [ModifiedOn] = GETDATE()
	  WHERE  [OfferId]  = @OfferId
END;
GO
/****** Object:  StoredProcedure [re].[PropertyOffer_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyOffer_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [OfferId]
      ,[ListingId]
      ,[OfferedBy]
      ,[OfferAmount]
      ,[OfferDate]
      ,[Status]
      ,[CounterOfferAmount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[PropertyOffer]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyOffer_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyOffer_ReadById]
(
   @OfferId BIGINT 
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [OfferId]
      ,[ListingId]
      ,[OfferedBy]
      ,[OfferAmount]
      ,[OfferDate]
      ,[Status]
      ,[CounterOfferAmount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[PropertyOffer]
	  WHERE  [OfferId]  = @OfferId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyOffer_ReadByListingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyOffer_ReadByListingId]
(
   @ListingId BIGINT 
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [OfferId]
      ,[ListingId]
      ,[OfferedBy]
      ,[OfferAmount]
      ,[OfferDate]
      ,[Status]
      ,[CounterOfferAmount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[PropertyOffer]
	  WHERE  [ListingId]  = @ListingId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyOffer_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyOffer_Update]
(
    @OfferId BIGINT,
    @ListingId BIGINT,
    @OfferedBy INT,
    @OfferAmount DECIMAL(18, 2),
    @OfferDate DATETIME,
    @Status VARCHAR(50),
    @CounterOfferAmount DECIMAL(18, 2),
    @Remarks VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[PropertyOffer]
    SET
        [ListingId] = @ListingId,
        [OfferedBy] = @OfferedBy,
        [OfferAmount] = @OfferAmount,
        [OfferDate] = @OfferDate,
        [Status] = @Status,
        [CounterOfferAmount] = @CounterOfferAmount,
        [Remarks] = @Remarks,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [OfferId] = @OfferId;

    SELECT 
       [OfferId],
       [ListingId],
       [OfferedBy],
       [OfferAmount],
       [OfferDate],
       [Status],
       [CounterOfferAmount],
       [Remarks],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
    FROM [re].[PropertyOffer]
    WHERE [OfferId] = @OfferId;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyStatus_Update_EOD]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [re].[PropertyStatus_Update_EOD]
AS
BEGIN
    SET NOCOUNT ON;

    -- Sold / Booked
    UPDATE PL
    SET PL.PropertyStatus = 'Sold',
        PL.ModifiedOn = GETDATE(),
        PL.ModifiedBy = 'SYSTEM'
    FROM re.PropertyListing PL
    INNER JOIN re.PropertyTransaction PT ON PL.PropertyId = PT.PropertyId
    WHERE PT.Status IN ('Sold', 'Booked')
      AND CONVERT(DATE, PT.TransactionDate) = CONVERT(DATE, GETDATE());

    -- Cancelled -> Back to Available
    UPDATE PL
    SET PL.PropertyStatus = 'Available',
        PL.ModifiedOn = GETDATE(),
        PL.ModifiedBy = 'SYSTEM'
    FROM re.PropertyListing PL
    INNER JOIN re.PropertyTransaction PT ON PL.PropertyId = PT.PropertyId
    WHERE PT.Status = 'Cancelled'
      AND CONVERT(DATE, PT.TransactionDate) = CONVERT(DATE, GETDATE());

    -- Hold
    UPDATE PL
    SET PL.PropertyStatus = 'Hold',
        PL.ModifiedOn = GETDATE(),
        PL.ModifiedBy = 'SYSTEM'
    FROM re.PropertyListing PL
    INNER JOIN re.PropertyTransaction PT ON PL.PropertyId = PT.PropertyId
    WHERE PT.Status = 'Hold'
      AND CONVERT(DATE, PT.TransactionDate) = CONVERT(DATE, GETDATE());

    -- Expire Old Listings
    UPDATE PL
    SET PL.ListingStatus = 'Expired',
        PL.ModifiedOn = GETDATE(),
        PL.ModifiedBy = 'SYSTEM'
    FROM re.PropertyListing PL
    WHERE PL.ListingStatus = 'Active'
      AND DATEADD(DAY, PL.ValidityPeriod, PL.ValidFrom) < GETDATE();
END;
GO
/****** Object:  StoredProcedure [re].[PropertyVisit_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyVisit_Create]
(
    @MasterId   INT,               
    @MasterType VARCHAR(50), 
    @VisitorUserId  INT,
    @ScheduledDate  DATETIME,
	@TimeSlot       VARCHAR(20),
    @Status         VARCHAR(50),
    @Notes          VARCHAR(255),
	@AssignedTo            INT,
	@RescheduledDate         DATETIME,
	@VisitFeedback         VARCHAR(50),
	@VisitorInterestLevel   VARCHAR(50),
	@FollowUpRequired      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @VisitId BIGINT;

    INSERT INTO [re].[PropertyVisit]
    (
         MasterId,
	     MasterType,
        VisitorUserId,
        ScheduledDate,
		TimeSlot,
        Status,
        Notes,
		AssignedTo,
        RescheduledDate,
        VisitFeedback,
        VisitorInterestLevel,
        FollowUpRequired,
		OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    VALUES
    (
        @MasterId,
		@MasterType,
        @VisitorUserId,
        @ScheduledDate,
		@TimeSlot,
        @Status,
        @Notes,
		@AssignedTo  ,         
		@RescheduledDate  ,    
		@VisitFeedback   ,     
		@VisitorInterestLevel ,
		@FollowUpRequired  ,   
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @VisitId = SCOPE_IDENTITY();

    SELECT
	   [VisitId]
	  ,[MasterId]
	  ,[MasterType]
      ,[VisitorUserId]
      ,[ScheduledDate]
	  ,[TimeSlot]
      ,[Status]
      ,[Notes]
	  ,[AssignedTo]
      ,[RescheduledDate]
      ,[VisitFeedback]
      ,[FollowUpRequired]
      ,[VisitorInterestLevel]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [re].[PropertyVisit]
    WHERE VisitId = @VisitId;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyVisit_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyVisit_Delete]
(
   @VisitId BIGINT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
  SET NOCOUNT ON;
  UPDATE[re].[PropertyVisit]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = getdate()
	WHERE [VisitId] = @VisitId
END;
GO
/****** Object:  StoredProcedure [re].[PropertyVisit_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyVisit_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
		   [VisitId]
	  	  ,[MasterId]
	      ,[MasterType]
		  ,[VisitorUserId]
		  ,[ScheduledDate]
		  ,[TimeSlot]
		  ,[Status]
		  ,[Notes]
		  ,[AssignedTo]
          ,[RescheduledDate]
          ,[VisitFeedback]
          ,[FollowUpRequired]
          ,[VisitorInterestLevel]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[PropertyVisit]
	  WHERE [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyVisit_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyVisit_ReadByBusinessId]
(
  @BusinessId  INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT 
       A.[VisitId]
	  ,A.[MasterId]
	  ,A.[MasterType]
	  ,B.[BusinessId]
	  ,B.[Title]
      ,A.[VisitorUserId]
	  ,C.[FirstName]
	  ,C.[LastName]
	  ,C.[MobileNo]
	  ,C.[EmailId]
      ,A.[ScheduledDate]
      ,A.[TimeSlot]
      ,A.[Status]
      ,A.[Notes]
	  ,A.[AssignedTo]
      ,A.[RescheduledDate]
      ,A.[VisitFeedback]
      ,A.[FollowUpRequired]
      ,A.[VisitorInterestLevel]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [Nishwik].[re].[PropertyVisit]A
	  LEFT OUTER JOIN [re].[Property]B
	  ON A.[MasterId] = B.[PropertyId]
	  AND A.[MasterType] = 'Property'
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]C
	  ON C.[UserId] = A.[VisitorUserId]
	  WHERE B.[BusinessId] = @BusinessId
	  AND A.[IsActive] = 1 AND A.[IsDeleted]= 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyVisit_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[PropertyVisit_ReadById]
(
    @VisitId BIGINT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
		   [VisitId]
		  ,[MasterId]
	      ,[MasterType]
		  ,[VisitorUserId]
		  ,[ScheduledDate]
		  ,[TimeSlot]
		  ,[Status]
		  ,[AssignedTo]
          ,[RescheduledDate]
          ,[VisitFeedback]
          ,[FollowUpRequired]
          ,[VisitorInterestLevel]
		  ,[Notes]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[PropertyVisit]
	  WHERE [VisitId] =@VisitId
	  AND [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyVisit_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[PropertyVisit_ReadByMasterId]
(
    @MasterId  INT,
	@MasterType  VARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
		   [VisitId]
		  ,[MasterId]
	      ,[MasterType]
		  ,[VisitorUserId]
		  ,[ScheduledDate]
		  ,[TimeSlot]
		  ,[Status]
		  ,[AssignedTo]
          ,[RescheduledDate]
          ,[VisitFeedback]
          ,[FollowUpRequired]
          ,[VisitorInterestLevel]
		  ,[Notes]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[PropertyVisit]
	  WHERE [MasterId] =@MasterId
	  AND [MasterType] = @MasterType
	  AND [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyVisit_ReadByVisitorUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyVisit_ReadByVisitorUserId]
(
	  @MasterId INT,
	  @MasterType VARCHAR(50),
	  @VisitorUserId INT
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT
		 [VisitId]
	  	 ,[MasterId]
	    ,[MasterType]
		,[VisitorUserId]
		,[ScheduledDate]
		,[TimeSlot]
		,[Status]
		,[Notes]
	    ,[AssignedTo]
        ,[RescheduledDate]
        ,[VisitFeedback]
        ,[FollowUpRequired]
        ,[VisitorInterestLevel]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[re].[PropertyVisit] 
	WHERE [VisitorUserId] = @VisitorUserId
	AND [MasterId] = @MasterId
	AND [MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[PropertyVisit_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[PropertyVisit_Update]
(
    @VisitId        BIGINT,
    @MasterId   INT,                 -- New required
    @MasterType VARCHAR(50), 
    @VisitorUserId  INT,
    @ScheduledDate  DATETIME,
	@TimeSlot         VARCHAR(20),
    @Status         VARCHAR(50),
    @Notes          VARCHAR(255),
	@AssignedTo            INT,
	@RescheduledDate       DATETIME,
	@VisitFeedback         VARCHAR(50),
	@VisitorInterestLevel  VARCHAR(50),
	@FollowUpRequired      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    -- Update the existing PropertyVisit record
    UPDATE [re].[PropertyVisit]
    SET
        MasterId       = @MasterId,
		MasterType   = @MasterType,
        VisitorUserId   = @VisitorUserId,
        ScheduledDate   = @ScheduledDate,
		TimeSlot        = @TimeSlot,
        Status          = @Status,
        Notes           = @Notes,
		AssignedTo      = @AssignedTo,
		RescheduledDate  = @RescheduledDate,
		VisitFeedback    = @VisitFeedback,
		VisitorInterestLevel  = @VisitorInterestLevel,
		FollowUpRequired  = @FollowUpRequired,
        OtherDetail1    = @OtherDetail1,
        OtherDetail2    = @OtherDetail2,
        OtherDetail3    = @OtherDetail3,
        OtherDetail4    = @OtherDetail4,
        OtherDetail5    = @OtherDetail5,
        OtherDetail6    = @OtherDetail6,
        IsActive        = @IsActive,
        ModifiedBy      = @ActionUser,
        ModifiedOn      = GETDATE()
    WHERE VisitId = @VisitId;

    SELECT
        VisitId,
        MasterId,
	    MasterType,
        VisitorUserId,
        ScheduledDate,
		TimeSlot,
        Status,
        Notes,
	    AssignedTo,
        RescheduledDate,
        VisitFeedback,
        FollowUpRequired,
        VisitorInterestLevel,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [re].[PropertyVisit]
    WHERE VisitId = @VisitId
	 AND IsActive = 1;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateDocMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[RealEstateDocMaster_Create]
(
    @MasterType      VARCHAR(50),
    @MasterId        INT,
    @DocType         VARCHAR(50),
    @DocNo           VARCHAR(50),
    @DocDescription  VARCHAR(200),
    @DocPath         VARCHAR(500),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @DocId INT;

	INSERT INTO [re].[RealEstateDocMaster]
	(
		[MasterType],
		[MasterId],
		[DocType],
		[DocNo],
		[DocDescription],
		[DocPath],
		[OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
		[OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
		[IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn]
	)
	VALUES
	(
		@MasterType,
		@MasterId,
		@DocType,
		@DocNo,
		@DocDescription,
		@DocPath,
		@OtherDetail1,
		@OtherDetail2,
		@OtherDetail3,
		@OtherDetail4,
		@OtherDetail5,
		@OtherDetail6,
		1,        
		0,        
		@ActionUser,
		GETDATE()
		);

	SET @DocId = SCOPE_IDENTITY();

	SELECT 
		 [DocId]
		,[MasterType]
		,[MasterId]
		,[DocType]
		,[DocNo]
		,[DocDescription]
		,[DocPath]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[RealEstateDocMaster]
	WHERE [DocId] = @DocId;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateDocMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[RealEstateDocMaster_Delete]
(
      @DocId  INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [re].[RealEstateDocMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 0,
		[ModifiedBy] =  @ActionUser,
		[ModifiedOn] = getdate()
	WHERE  [DocId] = @DocId
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateDocMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[RealEstateDocMaster_ReadAll]
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [re].[RealEstateDocMaster]
		WHERE [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateDocMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 CREATE   PROCEDURE [re].[RealEstateDocMaster_ReadById]
 (
	 @DocId INT 
 )
 AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [DocId]
      ,[MasterType]
      ,[MasterId]
      ,[DocType]
      ,[DocNo]
      ,[DocDescription]
      ,[DocPath]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[RealEstateDocMaster]
	  WHERE DocId = @DocId
	  AND IsActive = 1 
	  AND IsDeleted=0;
END
GO
/****** Object:  StoredProcedure [re].[RealEstateDocMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[RealEstateDocMaster_ReadByMasterId]
(
      @MasterId  INT,
	  @MasterType VARCHAR(50)
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [re].[RealEstateDocMaster]
		WHERE [MasterId] =@MasterId
		AND [MasterType]= @MasterType
		AND [IsActive]= 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateDocMaster_ReadByMasterType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[RealEstateDocMaster_ReadByMasterType]
(
      @MasterType  VARCHAR(50)
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [re].[RealEstateDocMaster]
		WHERE  [MasterType] = @MasterType
		AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateDocMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[RealEstateDocMaster_Update]
(
    @DocId           INT,
    @MasterType      VARCHAR(50),
    @MasterId        INT,
    @DocType         VARCHAR(50),
    @DocNo           VARCHAR(50),
    @DocDescription  VARCHAR(200),
    @DocPath         VARCHAR(500),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
	@IsActive       int,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[RealEstateDocMaster]
    SET 
        [MasterType]     = @MasterType,
        [MasterId]       = @MasterId,
        [DocType]        = @DocType,
        [DocNo]          = @DocNo,
        [DocDescription] = @DocDescription,
        [DocPath]        = @DocPath,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
		[IsActive]		 = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE 
        [DocId] = @DocId;

    SELECT 
         [DocId]
        ,[MasterType]
        ,[MasterId]
        ,[DocType]
        ,[DocNo]
        ,[DocDescription]
        ,[DocPath]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[RealEstateDocMaster]
    WHERE [DocId] = @DocId;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateImgMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[RealEstateImgMaster_Create]
(
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ImgId INT;
		IF @IsDefault = 1
	BEGIN
	UPDATE[re].[RealEstateImgMaster]
		SET IsDefault = 0,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND IsActive = 1;
	END
    INSERT INTO [re].[RealEstateImgMaster]
    (
        [MasterType],
        [MasterId],
        [ImgPath],
        [ImgTitle],
        [IsDefault],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterType,
        @MasterId,
        @ImgPath,
        @ImgTitle,
        @IsDefault,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,       
        0,       
        @ActionUser,
        GETDATE()
    );

    SET @ImgId = SCOPE_IDENTITY();

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[RealEstateImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateImgMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[RealEstateImgMaster_Delete]
(
   @ImgId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [re].[RealEstateImgMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] =1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = getdate()
	WHERE [ImgId] = @ImgId
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateImgMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[RealEstateImgMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[RealEstateImgMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateImgMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[RealEstateImgMaster_ReadById]
(
   @ImgId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[RealEstateImgMaster]
	WHERE [ImgId] = @ImgId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateImgMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[RealEstateImgMaster_ReadByMasterId]
(
   @MasterId INT,
   @MasterType varchar(50)

)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[RealEstateImgMaster]
	WHERE [MasterId] = @MasterId
	  And[MasterType]=@MasterType
	AND [IsActive] = 1
	And [IsDeleted]=0;

END;
GO
/****** Object:  StoredProcedure [re].[RealEstateImgMaster_ReadByMasterType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[RealEstateImgMaster_ReadByMasterType]
(
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[RealEstateImgMaster]
	WHERE [MasterType] = @MasterType
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[RealEstateImgMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[RealEstateImgMaster_Update]
(
    @ImgId          INT,
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
		IF @IsDefault = 1
		BEGIN
		UPDATE [re].[RealEstateImgMaster]
		SET 
			IsDefault = 0,
			ModifiedBy = @ActionUser,
			ModifiedOn = GETDATE()
		WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND ImgId <> @ImgId
		AND IsActive = 1;
		END
    UPDATE [re].[RealEstateImgMaster]
    SET
         [MasterType]    = @MasterType
        ,[MasterId]      = @MasterId
        ,[ImgPath]       = @ImgPath
        ,[ImgTitle]      = @ImgTitle
        ,[IsDefault]     = @IsDefault
        ,[OtherDetail1]  = @OtherDetail1
        ,[OtherDetail2]  = @OtherDetail2
        ,[OtherDetail3]  = @OtherDetail3
        ,[OtherDetail4]  = @OtherDetail4
        ,[OtherDetail5]  = @OtherDetail5
        ,[OtherDetail6]  = @OtherDetail6
        ,[IsActive]      = @IsActive
        ,[ModifiedBy]    = @ActionUser
        ,[ModifiedOn]    = GETDATE()
    WHERE [ImgId] = @ImgId;

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [re].[RealEstateImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[REBackendDiscount_Create]
(
    @BusinessId        INT,
    @ProjectId         INT = NULL,
    @BuildingId        INT = NULL,
    @UnitTypeId        INT = NULL,
    @DiscountType      VARCHAR(50),
    @DiscountValue     DECIMAL(18,2),
    @CommitmentPeriod  INT = NULL,
    @SaleCommitment    VARCHAR(20) = NULL,
    @ValidFrom         DATE = NULL,
    @ValidTo           DATE = NULL,
    @OtherDetail1      VARCHAR(50) = NULL,
    @OtherDetail2      VARCHAR(50) = NULL,
    @OtherDetail3      VARCHAR(100) = NULL,
    @OtherDetail4      VARCHAR(100) = NULL,
    @OtherDetail5      VARCHAR(500) = NULL,
    @OtherDetail6      VARCHAR(500) = NULL,
    @MeasurementType   VARCHAR(50) = NULL,
    @MarkUp            DECIMAL(4,2) = NULL,
    @CostPrice         DECIMAL(18,2) = NULL,
    @FinalPrice        DECIMAL(18,2) = NULL,
    @ActionUser        VARCHAR(50) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BackendDiscountId INT;

    INSERT INTO [re].[REBackendDiscount]
    (
        [BusinessId],
        [ProjectId],
        [BuildingId],
        [UnitTypeId],
        [DiscountType],
        [DiscountValue],
        [CommitmentPeriod],
        [SaleCommitment],
        [ValidFrom],
        [ValidTo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [MeasurementType],
        [MarkUp],
        [CostPrice],
        [FinalPrice],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @BusinessId,
        @ProjectId,
        @BuildingId,
        @UnitTypeId,
        TRIM(@DiscountType),
        @DiscountValue,
        @CommitmentPeriod,
        TRIM(@SaleCommitment),
        @ValidFrom,
        @ValidTo,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        TRIM(@MeasurementType),
        @MarkUp,
        @CostPrice,
        @FinalPrice,
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @BackendDiscountId = SCOPE_IDENTITY();

    SELECT 
        [BackendDiscountId],
        [BusinessId],
        [ProjectId],
        [BuildingId],
        [UnitTypeId],
        [DiscountType],
        [DiscountValue],
        [CommitmentPeriod],
        [SaleCommitment],
        [ValidFrom],
        [ValidTo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [MeasurementType],
        [MarkUp],
        [CostPrice],
        [FinalPrice],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[REBackendDiscount]
    WHERE [BackendDiscountId] = @BackendDiscountId;
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[REBackendDiscount_Delete]
(
   @BackendDiscountId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN 
      UPDATE  [re].[REBackendDiscount]
	  SET
			[IsActive] = 0,
			[IsDeleted] = 1,
			[ModifiedBy] = @ActionUser,
			[ModifiedOn] = GETDATE()
	  WHERE [BackendDiscountId] = @BackendDiscountId
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[REBackendDiscount_ReadAll]
AS
 BEGIN 
      SELECT 
		   A.[BackendDiscountId]
		  ,A.[BusinessId]
		  ,E.[BusinessName]
		  ,A.[ProjectId]
		  ,B.[ProjectName]
		  ,A.[BuildingId]
		  ,C.[BuildingName]
		  ,A.[UnitTypeId]
		  ,D.[UnitTypeName]
		  ,A.[DiscountType]
		  ,A.[DiscountValue]
		  ,A.[CommitmentPeriod]
		  ,A.[SaleCommitment]
		  ,A.[ValidFrom]
		  ,A.[ValidTo]
		  ,A.[MeasurementType]
		  ,A.[MarkUp]
          ,A.[CostPrice]
          ,A.[FinalPrice]
		  ,A.[OtherDetail1]
		  ,A.[OtherDetail2]
		  ,A.[OtherDetail3]
		  ,A.[OtherDetail4]
		  ,A.[OtherDetail5]
		  ,A.[OtherDetail6]
		  ,A.[IsActive]
		  ,A.[IsDeleted]
		  ,A.[CreatedBy]
		  ,A.[CreatedOn]
		  ,A.[ModifiedBy]
		  ,A.[ModifiedOn]
	  FROM [re].[REBackendDiscount] A
	  LEFT OUTER JOIN [re].[Project] B
	  ON A.ProjectId = B.ProjectId
	  LEFT OUTER JOIN [re].[ProjectBuilding] C
	  ON A.BuildingId = C.BuildingId
	  LEFT OUTER JOIN [re].[ProjectUnitType] D
	  ON A.UnitTypeId = D.UnitTypeId
	  LEFT OUTER JOIN [re].[BusinessMaster] E
	  ON A.BusinessId = E.BusinessId
	  WHERE A.IsActive = 1
	  AND A.IsDeleted = 0
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_ReadByBuildingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[REBackendDiscount_ReadByBuildingId]
(
   @BuildingId INT
)
AS
 BEGIN 
      SELECT 
		   [BackendDiscountId]
		  ,[BusinessId]
		  ,[ProjectId]
		  ,[BuildingId]
		  ,[UnitTypeId]
		  ,[DiscountType]
		  ,[DiscountValue]
		  ,[CommitmentPeriod]
		  ,[SaleCommitment]
		  ,[ValidFrom]
		  ,[ValidTo]
		  ,[MeasurementType]
		  ,[MarkUp]
		  ,[CostPrice]
		  ,[FinalPrice]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[REBackendDiscount]
	  WHERE [BuildingId] = @BuildingId
	  AND IsActive = 1
	  AND IsDeleted = 0
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[REBackendDiscount_ReadByBusinessId]
(
   @BusinessId INT
)
AS
 BEGIN 
      SELECT 
		   [BackendDiscountId]
		  ,[BusinessId]
		  ,[ProjectId]
		  ,[BuildingId]
		  ,[UnitTypeId]
		  ,[DiscountType]
		  ,[DiscountValue]
		  ,[CommitmentPeriod]
		  ,[SaleCommitment]
		  ,[ValidFrom]
		  ,[ValidTo]
		  ,[MeasurementType]
		  ,[MarkUp]
		  ,[CostPrice]
		  ,[FinalPrice]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[REBackendDiscount]
	  WHERE [BusinessId] = @BusinessId
	  AND IsActive = 1
	  AND IsDeleted = 0
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[REBackendDiscount_ReadById]
(
   @BackendDiscountId INT
)
AS
 BEGIN 
      SELECT 
		    [BackendDiscountId]
		  ,[BusinessId]
		  ,[ProjectId]
		  ,[BuildingId]
		  ,[UnitTypeId]
		  ,[DiscountType]
		  ,[DiscountValue]
		  ,[CommitmentPeriod]
		  ,[SaleCommitment]
		  ,[ValidFrom]
		  ,[ValidTo]
		  ,[MeasurementType]
		  ,[MarkUp]
		  ,[CostPrice]
		  ,[FinalPrice]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[REBackendDiscount]
	  WHERE [BackendDiscountId] = @BackendDiscountId
	  AND IsActive = 1
	  AND IsDeleted = 0
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_ReadByProjectId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[REBackendDiscount_ReadByProjectId]
(
   @ProjectId INT
)
AS
 BEGIN 
      SELECT 
		    [BackendDiscountId]
		  ,[BusinessId]
		  ,[ProjectId]
		  ,[BuildingId]
		  ,[UnitTypeId]
		  ,[DiscountType]
		  ,[DiscountValue]
		  ,[CommitmentPeriod]
		  ,[SaleCommitment]
		  ,[ValidFrom]
		  ,[ValidTo]
		  ,[MeasurementType]
		  ,[MarkUp]
		  ,[CostPrice]
		  ,[FinalPrice]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[REBackendDiscount]
	  WHERE [ProjectId] = @ProjectId
	  AND IsActive = 1
	  AND IsDeleted = 0
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_ReadByUnitTypeId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[REBackendDiscount_ReadByUnitTypeId]
(
   @UnitTypeId INT
)
AS
 BEGIN 
      SELECT 
		   [BackendDiscountId]
		  ,[BusinessId]
		  ,[ProjectId]
		  ,[BuildingId]
		  ,[UnitTypeId]
		  ,[DiscountType]
		  ,[DiscountValue]
		  ,[CommitmentPeriod]
		  ,[SaleCommitment]
		  ,[ValidFrom]
		  ,[ValidTo]
		  ,[MeasurementType]
		  ,[MarkUp]
		  ,[CostPrice]
		  ,[FinalPrice]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [re].[REBackendDiscount]
	  WHERE [UnitTypeId] = @UnitTypeId
	  AND IsActive = 1
	  AND IsDeleted = 0
END;
GO
/****** Object:  StoredProcedure [re].[REBackendDiscount_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[REBackendDiscount_Update]
(
    @BackendDiscountId INT,
    @BusinessId        INT = NULL,
    @ProjectId         INT = NULL,
    @BuildingId        INT = NULL,
    @UnitTypeId        INT = NULL,
    @DiscountType      VARCHAR(50) = NULL,
    @DiscountValue     DECIMAL(18,2) = NULL,
    @CommitmentPeriod  INT = NULL,
    @SaleCommitment    VARCHAR(20) = NULL,
    @ValidFrom         DATE = NULL,
    @ValidTo           DATE = NULL,
    @OtherDetail1      VARCHAR(50) = NULL,
    @OtherDetail2      VARCHAR(50) = NULL,
    @OtherDetail3      VARCHAR(100) = NULL,
    @OtherDetail4      VARCHAR(100) = NULL,
    @OtherDetail5      VARCHAR(500) = NULL,
    @OtherDetail6      VARCHAR(500) = NULL,
    @MeasurementType   VARCHAR(50) = NULL,
    @MarkUp            DECIMAL(4,2) = NULL,
    @CostPrice         DECIMAL(18,2) = NULL,
    @FinalPrice        DECIMAL(18,2) = NULL,
    @IsActive          INT = NULL,
    @ActionUser        VARCHAR(50) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[REBackendDiscount]
    SET 
        [BusinessId]       = @BusinessId,
        [ProjectId]        = @ProjectId,
        [BuildingId]       = @BuildingId,
        [UnitTypeId]       = @UnitTypeId,
        [DiscountType]     = TRIM(@DiscountType),
        [DiscountValue]    = @DiscountValue,
        [CommitmentPeriod] = @CommitmentPeriod,
        [SaleCommitment]   = TRIM(@SaleCommitment),
        [ValidFrom]        = @ValidFrom,
        [ValidTo]          = @ValidTo,
        [OtherDetail1]     = TRIM(@OtherDetail1),
        [OtherDetail2]     = TRIM(@OtherDetail2),
        [OtherDetail3]     = TRIM(@OtherDetail3),
        [OtherDetail4]     = TRIM(@OtherDetail4),
        [OtherDetail5]     = TRIM(@OtherDetail5),
        [OtherDetail6]     = TRIM(@OtherDetail6),
        [MeasurementType]  = TRIM(@MeasurementType),
        [MarkUp]           = @MarkUp,
        [CostPrice]        = @CostPrice,
        [FinalPrice]       = @FinalPrice,
        [IsActive]         = @IsActive,
        [ModifiedBy]       = TRIM(@ActionUser),
        [ModifiedOn]       = GETDATE()
    WHERE [BackendDiscountId] = @BackendDiscountId;

    SELECT 
        [BackendDiscountId],
        [BusinessId],
        [ProjectId],
        [BuildingId],
        [UnitTypeId],
        [DiscountType],
        [DiscountValue],
        [CommitmentPeriod],
        [SaleCommitment],
        [ValidFrom],
        [ValidTo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [MeasurementType],
        [MarkUp],
        [CostPrice],
        [FinalPrice],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[REBackendDiscount]
    WHERE [BackendDiscountId] = @BackendDiscountId
      AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[RentalAgreement_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[RentalAgreement_Create]
(
    @PropertyId BIGINT,
	@TenantUserId INT,
	@OwnerUserId INT,
	@AgreementType VARCHAR(50),
	@LeaseStartDate DATE,
	@LeaseEndDate DATE,
	@RentAmount DECIMAL(18,2),
	@DepositAmount DECIMAL(18,2),
	@NoticePeriodDays INT,
	@AgreementStatus VARCHAR(50),
	@eSigned INT,
	@SignedOn DATETIME,
	@PoliceVerification INT,
	@DocumentId BIGINT,
	@AgreementContent NVARCHAR(MAX),
    @AgreementURL VARCHAR(100),
	@MaintenanceAmount Decimal(18,2),
	@MaintenancePayableBy VARCHAR(50),
	@DepositPaid INT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50) 
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AgreementId BIGINT;
	DECLARE @GeneratedAgreementNo VARCHAR(30);

    INSERT INTO [re].[RentalAgreement]
    (
        [PropertyId],
        [TenantUserId],
        [OwnerUserId],
        [AgreementType],
        [LeaseStartDate],
        [LeaseEndDate],
        [RentAmount],
        [DepositAmount],
        [NoticePeriodDays],
        [AgreementStatus],
        [eSigned],
        [SignedOn],
		[PoliceVerification],
        [DocumentId],
		[AgreementContent],
        [AgreementURL],
		[MaintenanceAmount],
		[MaintenancePayableBy],
		[DepositPaid],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
      @PropertyId,
      @TenantUserId,
      @OwnerUserId,
      @AgreementType,
      @LeaseStartDate,
      @LeaseEndDate,
      @RentAmount,
      @DepositAmount,
      @NoticePeriodDays,
      @AgreementStatus,
      @eSigned,
      @SignedOn,
	  @PoliceVerification,
      @DocumentId,
	  @AgreementContent,
	  @AgreementURL,
	  @MaintenanceAmount,
	  @MaintenancePayableBy,
	  @DepositPaid,
      @OtherDetail1,
      @OtherDetail2,
      @OtherDetail3,
      @OtherDetail4,
      @OtherDetail5,
      @OtherDetail6,
       1,
       0,
      @ActionUser,
       GETDATE()
    );

    SET @AgreementId = SCOPE_IDENTITY();

	-- Step 3: Generate AgreementNo using the scalar function
    SET @GeneratedAgreementNo = [re].[fn_GenerateAgreementNo](@AgreementId);

    -- Step 4: Update the record with the generated AgreementNo
    UPDATE [re].[RentalAgreement]
    SET AgreementNo = @GeneratedAgreementNo
    WHERE AgreementId = @AgreementId;

    SELECT 
		[AgreementNo],
        [AgreementId],
        [PropertyId],
        [TenantUserId],
        [OwnerUserId],
        [AgreementType],
        [LeaseStartDate],
        [LeaseEndDate],
        [RentAmount],
        [DepositAmount],
        [NoticePeriodDays],
        [AgreementStatus],
        [eSigned],
        [SignedOn],
		[PoliceVerification],
        [DocumentId],
		[AgreementContent],
		[AgreementURL],
		[MaintenanceAmount],
		[MaintenancePayableBy],
		[DepositPaid],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[RentalAgreement]
    WHERE [AgreementId] = @AgreementId;
END
GO
/****** Object:  StoredProcedure [re].[RentalAgreement_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [re].[RentalAgreement_Delete]
(
   @AgreementId BIGINT,
   @ActionUser VARCHAR (50)
)
AS
 BEGIN
	UPDATE[re].[RentalAgreement]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [AgreementId] = @AgreementId
END;
GO
/****** Object:  StoredProcedure [re].[RentalAgreement_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[RentalAgreement_ReadAll]
AS
 BEGIN
     SELECT
	   [AgreementNo]
	  ,[AgreementId]
      ,[PropertyId]
      ,[TenantUserId]
      ,[OwnerUserId]
      ,[AgreementType]
      ,[LeaseStartDate]
      ,[LeaseEndDate]
      ,[RentAmount]
      ,[DepositAmount]
      ,[NoticePeriodDays]
      ,[AgreementStatus]
      ,[eSigned]
      ,[SignedOn]
	  ,[PoliceVerification]
      ,[DocumentId]
	  ,[AgreementContent]
	  ,[AgreementURL]
	  ,[MaintenanceAmount]
	  ,[MaintenancePayableBy]
	  ,[DepositPaid]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
		FROM [re].[RentalAgreement]
		WHERE [IsActive]= 1
		AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [re].[RentalAgreement_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[RentalAgreement_ReadById]
(
   @AgreementId BIGINT
)
AS
 BEGIN
     SELECT
	   A.[AgreementNo]
	  ,A.[AgreementId]
      ,A.[PropertyId]
      ,A.[TenantUserId]
      ,A.[OwnerUserId]
      ,A.[AgreementType]
      ,A.[LeaseStartDate]
      ,A.[LeaseEndDate]
      ,A.[RentAmount]
      ,A.[DepositAmount]
      ,A.[NoticePeriodDays]
      ,A.[AgreementStatus]
      ,A.[eSigned]
      ,A.[SignedOn]
	  ,A.[PoliceVerification]
      ,A.[DocumentId]
	  ,A.[AgreementContent]
	  ,A.[AgreementURL]
	  ,A.[MaintenanceAmount]
	  ,A.[MaintenancePayableBy]
	  ,A.[DepositPaid]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  ,B.[FirstName] +' '+ B.[LastName] AS OwnerFullName
	  ,B.[MobileNo] AS OwnerMobileNo
	  ,B.[EmailId] AS OwnerEmailId
	  ,B.[ProfileImage] AS OwnerProfileImage
	  ,C.[FirstName] +' '+ C.[LastName] AS TenantFullName
	  ,C.[MobileNo] AS TenantMobileNo
	  ,C.[EmailId] AS TenantEmailId
	  ,C.[ProfileImage] AS TenantProfileImage
	  ,D.[Title]
	  ,D.[PropertyName]
	  ,D.[PropertyType]
	  ,D.[Address]
	  ,D.[State]
	  ,D.[City]
	  ,D.[Pincode]
	  ,E.[BHK]
	  ,E.[CarpetArea]
	  ,E.[Furnishing]
	  FROM [re].[RentalAgreement] A
	  LEFT OUTER JOIN [dbo].[UserMaster] B
		ON B.[UserId] = A.[OwnerUserId]
	  LEFT OUTER JOIN [dbo].[UserMaster] C
		ON C.[UserId] = A.[TenantUserId]
	  LEFT OUTER JOIN [re].[Property] D
		ON D.[PropertyId] = A.[PropertyId]
	  LEFT OUTER JOIN [re].[PropertyDetails] E
		ON E.[PropertyId] = A.[PropertyId]
	  WHERE [AgreementId] = @AgreementId
		AND A.[IsActive]= 1
		AND A.[IsDeleted] =0
END;
GO
/****** Object:  StoredProcedure [re].[RentalAgreement_ReadByOwnerUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[RentalAgreement_ReadByOwnerUserId]
(
   @OwnerUserId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
	   A.[AgreementNo]
      ,A.[AgreementId]
      ,A.[PropertyId]
      ,A.[TenantUserId]
      ,A.[OwnerUserId]
      ,A.[AgreementType]
      ,A.[LeaseStartDate]
      ,A.[LeaseEndDate]
      ,A.[RentAmount]
      ,A.[DepositAmount]
      ,A.[NoticePeriodDays]
      ,A.[AgreementStatus]
      ,A.[eSigned]
      ,A.[SignedOn]
	  ,A.[PoliceVerification]
      ,A.[DocumentId]
	  ,A.[AgreementContent]
	  ,A.[AgreementURL]
	  ,A.[MaintenanceAmount]
	  ,A.[MaintenancePayableBy]
	  ,A.[DepositPaid]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  ,B.[FirstName]
	  ,B.[MiddleName]
	  ,B.[LastName]
	  ,C.[Title] AS PropertyTitle
	  ,C.[City]
	  FROM [re].[RentalAgreement] A
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B
		ON A.[TenantUserId] = B.[UserId]
	  LEFT OUTER JOIN [Nishwik].[re].[Property] C
	    ON A.[PropertyId] = C.[PropertyId]
	  WHERE A.[OwnerUserId] = @OwnerUserId
		AND A.[IsActive] = 1
		AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[RentalAgreement_ReadByPropertyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[RentalAgreement_ReadByPropertyId]
(
   @PropertyId BIGINT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
	   [AgreementNo]
      ,[AgreementId]
      ,[PropertyId]
      ,[TenantUserId]
      ,[OwnerUserId]
      ,[AgreementType]
      ,[LeaseStartDate]
      ,[LeaseEndDate]
      ,[RentAmount]
      ,[DepositAmount]
      ,[NoticePeriodDays]
      ,[AgreementStatus]
      ,[eSigned]
      ,[SignedOn]
	  ,[PoliceVerification]
      ,[DocumentId]
	  ,[AgreementContent]
	  ,[AgreementURL]
	  ,[MaintenanceAmount]
	  ,[MaintenancePayableBy]
	  ,[DepositPaid]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[RentalAgreement]
	  WHERE [PropertyId]  = @PropertyId
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[RentalAgreement_ReadByTenantUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[RentalAgreement_ReadByTenantUserId]
(
   @TenantUserId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
	   A.[AgreementNo]
      ,A.[AgreementId]
      ,A.[PropertyId]
      ,A.[TenantUserId]
      ,A.[OwnerUserId]
      ,A.[AgreementType]
      ,A.[LeaseStartDate]
      ,A.[LeaseEndDate]
      ,A.[RentAmount]
      ,A.[DepositAmount]
      ,A.[NoticePeriodDays]
      ,A.[AgreementStatus]
      ,A.[eSigned]
      ,A.[SignedOn]
	  ,A.[PoliceVerification]
      ,A.[DocumentId]
	  ,A.[AgreementContent]
	  ,A.[AgreementURL]
	  ,A.[MaintenanceAmount]
	  ,A.[MaintenancePayableBy]
	  ,A.[DepositPaid]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  ,B.[FirstName]
	  ,B.[MiddleName]
	  ,B.[LastName]
	  ,C.[Title] AS PropertyTitle
	  ,C.[City]
	  FROM [re].[RentalAgreement] A
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B
		ON A.[OwnerUserId] = B.[UserId]
	  LEFT OUTER JOIN [Nishwik].[re].[Property] C
	    ON A.[PropertyId] = C.[PropertyId]
	  WHERE A.[TenantUserId]  = @TenantUserId
		AND A.[IsActive] = 1
		AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[RentalAgreement_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [re].[RentalAgreement_Update]
(
    @AgreementId BIGINT,
	@AgreementNo VARCHAR(50),
	@PropertyId BIGINT,
	@TenantUserId INT,
	@OwnerUserId INT,
	@AgreementType VARCHAR(50),
	@LeaseStartDate DATE,
	@LeaseEndDate DATE,
	@RentAmount DECIMAL(18,2),
	@DepositAmount DECIMAL(18,2),
	@NoticePeriodDays INT,
	@AgreementStatus VARCHAR(50),
	@eSigned INT,
	@SignedOn DATETIME,
	@PoliceVerification INT,
	@DocumentId BIGINT,
	@AgreementContent NVARCHAR(MAX),
	@AgreementURL VARCHAR(100),
	@MaintenanceAmount Decimal(18,2),
	@MaintenancePayableBy VARCHAR(50),
	@DepositPaid INT,
    @OtherDetail1 VARCHAR(50) ,
    @OtherDetail2 VARCHAR(50) ,
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50) 
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[RentalAgreement]
    SET 
		[AgreementNo] = @AgreementNo,
        [PropertyId] = @PropertyId,
        [TenantUserId] = @TenantUserId,
        [OwnerUserId] = @OwnerUserId,
        [AgreementType] = @AgreementType,
        [LeaseStartDate] = @LeaseStartDate,
        [LeaseEndDate] = @LeaseEndDate,
        [RentAmount] = @RentAmount,
        [DepositAmount] = @DepositAmount,
        [NoticePeriodDays] = @NoticePeriodDays,
        [AgreementStatus] = @AgreementStatus,
        [eSigned] = @eSigned,
        [SignedOn] = @SignedOn,
		[PoliceVerification] = @PoliceVerification,
        [DocumentId] = @DocumentId,
		[AgreementContent] = @AgreementContent,
		[AgreementURL] = @AgreementURL,
		[MaintenanceAmount] = @MaintenanceAmount,
		[MaintenancePayableBy] = @MaintenancePayableBy,
		[DepositPaid] = @DepositPaid,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive]     = @IsActive,
        [ModifiedBy]   = @ActionUser,
        [ModifiedOn]   = GETDATE()
    WHERE [AgreementId] = @AgreementId;

    SELECT 
        [AgreementId],
		[AgreementNo],
        [PropertyId],
        [TenantUserId],
        [OwnerUserId],
        [AgreementType],
        [LeaseStartDate],
        [LeaseEndDate],
        [RentAmount],
        [DepositAmount],
        [NoticePeriodDays],
        [AgreementStatus],
        [eSigned],
        [SignedOn],
		[PoliceVerification],
        [DocumentId],
		[AgreementContent],
		[AgreementURL],
		[MaintenanceAmount],
		[MaintenancePayableBy],
		[DepositPaid],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[RentalAgreement]
    WHERE [AgreementId] = @AgreementId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [re].[ReportedListing_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[ReportedListing_Create]
(
	@UserId INT,
    @MasterId   INT,                 -- New required
    @MasterType VARCHAR(50), 
	@BusinessId BIGINT,
	@Reason VARCHAR(100),
	@Comment VARCHAR(500),
	@ReportedOn DATETIME ,
	@Status VARCHAR(20),
	@Name VARCHAR(100),
	@PhoneNo VARCHAR(20),
	@ReviewedBy INT ,
	@ReviewedOn DATETIME ,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ReportId BIGINT;

    INSERT INTO [re].[ReportedListing]
    (
       [UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
    )
    VALUES
    (
         @UserId
        ,@MasterId
		,@MasterType
        ,@BusinessId
        ,@Reason
        ,@Comment
        ,@ReportedOn
        ,@Status
        ,@Name
        ,@PhoneNo
        ,@ReviewedBy
        ,@ReviewedOn
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1               
        ,0               
        ,@ActionUser     
        ,GETDATE()       
    );

    SET @ReportId = SCOPE_IDENTITY();

    -- Return the inserted row
    SELECT 
       [ReportId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [re].[ReportedListing]
    WHERE [ReportId] = @ReportId;
END;

GO
/****** Object:  StoredProcedure [re].[ReportedListing_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[ReportedListing_Delete]
(
   @ReportId INT,
   @ActionUser  VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [re].[ReportedListing]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ReportId]  = @ReportId
END;
GO
/****** Object:  StoredProcedure [re].[ReportedListing_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[ReportedListing_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ReportId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[ReportedListing]
	  WHERE [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ReportedListing_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[ReportedListing_ReadByBusinessId]
(
   @BusinessId INT   
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ReportId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[ReportedListing]
	  WHERE [BusinessId]  = @BusinessId
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ReportedListing_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[ReportedListing_ReadById]
(
   @ReportId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ReportId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[ReportedListing]
	  WHERE [ReportId]  = @ReportId
	  AND   [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ReportedListing_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[ReportedListing_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ReportId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[ReportedListing]
	  WHERE [MasterId]  = @MasterId
	  AND [MasterType] = @MasterType
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ReportedListing_ReadByPropertyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[ReportedListing_ReadByPropertyId]
(
   @PropertyId INT   
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ReportId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[ReportedListing]
	  WHERE [PropertyId]  = @PropertyId
	  AND [IsActive] = 1
	   AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ReportedListing_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[ReportedListing_ReadByUserId]
(
   @MasterId INT,
   @MasterType VARCHAR(50),
   @UserId INT   
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT 
       [ReportId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[ReportedListing]
	  WHERE [UserId]  = @UserId
	  AND [MasterId] = @MasterId
	  AND [MasterType] = @MasterType
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[ReportedListing_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[ReportedListing_Update]
(
    @ReportId BIGINT,
	@UserId INT,
    @MasterId   INT,                 -- New required
    @MasterType VARCHAR(50), 
	@BusinessId BIGINT,
	@Reason VARCHAR(100),
	@Comment VARCHAR(500),
	@ReportedOn DATETIME ,
	@Status VARCHAR(20),
	@Name VARCHAR(100),
	@PhoneNo VARCHAR(20),
	@ReviewedBy INT ,
	@ReviewedOn DATETIME ,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[ReportedListing]
    SET 
         [UserId]  = @UserId
        ,[MasterId] = @MasterId
		,[MasterType] = @MasterType
        ,[BusinessId]  = @BusinessId
        ,[Reason]  = @Reason
        ,[Comment]  = @Comment
        ,[ReportedOn]  = @ReportedOn
        ,[Status]  = @Status
        ,[Name]  = @Name
        ,[PhoneNo]  = @PhoneNo
        ,[ReviewedBy]  = @ReviewedBy
        ,[ReviewedOn]  = @ReviewedOn
        ,[OtherDetail1] = @OtherDetail1
        ,[OtherDetail2] = @OtherDetail2
        ,[OtherDetail3] = @OtherDetail3
        ,[OtherDetail4] = @OtherDetail4
        ,[OtherDetail5] = @OtherDetail5
        ,[OtherDetail6] = @OtherDetail6
        ,[IsActive]     = @IsActive
        ,[ModifiedBy]   = @ActionUser
        ,[ModifiedOn]   = GETDATE()
    WHERE 
        [ReportId] = @ReportId ;

    SELECT 
       [ReportId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[BusinessId]
      ,[Reason]
      ,[Comment]
      ,[ReportedOn]
      ,[Status]
      ,[Name]
      ,[PhoneNo]
      ,[ReviewedBy]
      ,[ReviewedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [re].[ReportedListing]
    WHERE [ReportId] = @ReportId
	      AND [IsDeleted] = 0
		   AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserAffiliationMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[UserAffiliationMapping_Create]
(
    @UserId           INT,
    @BusinessId       INT,
    @AffiliationType  VARCHAR(50),
    @Designation      VARCHAR(50),
    @IsPrimary        INT,
    @JoinedOn         DATETIME,
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MappingId INT;

	IF @IsPrimary = 1
	BEGIN
		UPDATE [re].[UserAffiliationMapping]
		SET IsPrimary = 0,
			ModifiedBy = 'SYSTEM',
			ModifiedOn = GETDATE()
		WHERE BusinessId = @BusinessId
			AND IsPrimary = 1
			AND IsDeleted = 0
	END

    INSERT INTO [re].[UserAffiliationMapping]
    (
        [UserId],
        [BusinessId],
        [AffiliationType],
        [Designation],
        [IsPrimary],
        [JoinedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @BusinessId,
        @AffiliationType,
        @Designation,
        @IsPrimary,
        @JoinedOn,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,    
        GETDATE()       
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT 
        [MappingId],
        [UserId],
        [BusinessId],
        [AffiliationType],
        [Designation],
        [IsPrimary],
        [JoinedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[UserAffiliationMapping]
    WHERE [MappingId] = @MappingId;
END;
GO
/****** Object:  StoredProcedure [re].[UserAffiliationMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserAffiliationMapping_Delete]
(
    @MappingId int,
	@ActionUser varchar(50)
)
AS 
BEGIN 
	SET NOCOUNT ON;
	UPDATE [re].[UserAffiliationMapping]
	SET 
		[IsActive] = 0 ,
		[IsDeleted] = 1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MappingId]  =@MappingId
END;
GO
/****** Object:  StoredProcedure [re].[UserAffiliationMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserAffiliationMapping_ReadAll]
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[BusinessId]
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[joinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[UserAffiliationMapping]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserAffiliationMapping_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserAffiliationMapping_ReadByBusinessId]
(
    @BusinessId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[BusinessId]
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[JoinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[UserAffiliationMapping]
	  WHERE [BusinessId]  =@BusinessId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserAffiliationMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserAffiliationMapping_ReadById]
(
    @MappingId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[BusinessId]
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[joinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[UserAffiliationMapping]
	  WHERE [MappingId]  =@MappingId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserAffiliationMapping_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserAffiliationMapping_ReadByUserId]
(
    @UserId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[BusinessId]
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[JoinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[UserAffiliationMapping]
	  WHERE [UserId]  =@UserId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserAffiliationMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[UserAffiliationMapping_Update]
(
    @MappingId        INT,
    @UserId           INT,
    @BusinessId       INT,
    @AffiliationType  VARCHAR(50),
    @Designation      VARCHAR(50),
    @IsPrimary        INT,
    @JoinedOn         DATETIME,
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	--  Step 1: If making this record Primary, demote all others
    IF @IsPrimary = 1
    BEGIN
        UPDATE [re].[UserAffiliationMapping]
        SET IsPrimary = 0,
            ModifiedBy = @ActionUser,
            ModifiedOn = GETDATE()
        WHERE BusinessId = @BusinessId
          AND MappingId <> @MappingId  -- exclude current record
          AND IsPrimary = 1
          AND IsDeleted = 0; -- optional safeguard
    END

    UPDATE [re].[UserAffiliationMapping]
    SET
        [UserId]         = @UserId,
        [BusinessId]     = @BusinessId,
        [AffiliationType]= @AffiliationType,
        [Designation]    = @Designation,
        [IsPrimary]      = @IsPrimary,
        [JoinedOn]       = @JoinedOn,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE [MappingId] = @MappingId ;

    SELECT 
        [MappingId],
        [UserId],
        [BusinessId],
        [AffiliationType],
        [Designation],
        [IsPrimary],
        [JoinedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[UserAffiliationMapping]
    WHERE [MappingId] = @MappingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_CheckShortlist]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [re].[UserPropertyShortlist_CheckShortlist]
     @MasterId = 1,
     @MasterType = 'Property',
     @UserId = 5;


*/
CREATE   PROCEDURE [re].[UserPropertyShortlist_CheckShortlist]
(
    @MasterId INT,
	@MasterType VARCHAR(50),
	@UserId INT
)
AS
 BEGIN
		SET NOCOUNT ON;
		SELECT 
			 [ShortlistId]
			,[UserId]
	        ,[MasterId]
		    ,[MasterType]
			,[ShortlistedOn]
			,[Remarks]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM   [re].[UserPropertyShortlist]
		WHERE [UserId] = @UserId
		AND [MasterId] = @MasterId
		AND [MasterType] = @MasterType
		AND [IsActive] = 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [re].[UserPropertyShortlist_Create]
(
    @UserId         INT,
    @MasterId   INT,                 -- New required
    @MasterType VARCHAR(50), 
    @ShortlistedOn  DATETIME,
    @Remarks        VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ShortlistId BIGINT;

    INSERT INTO [re].[UserPropertyShortlist]
    (
        [UserId],
	    [MasterId],
		[MasterType],
        [ShortlistedOn],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @MasterId,
		@MasterType,
        @ShortlistedOn,
        TRIM(@Remarks),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @ShortlistId = SCOPE_IDENTITY();

    SELECT 
        [ShortlistId],
        [UserId],
	    [MasterId],
		[MasterType],
        [ShortlistedOn],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[UserPropertyShortlist]
    WHERE [ShortlistId] = @ShortlistId;
END;
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserPropertyShortlist_Delete]
(
    @ShortlistId BIGINT,
	@ActionUser VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE [re].[UserPropertyShortlist]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ShortlistId] = @ShortlistId
END
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_GetUserShortlistProject]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [re].[UserPropertyShortlist_GetUserShortlistProject]
(
	@UserId INT
)
AS
BEGIN
	SET NOCOUNT ON;

	SELECT 
		UPS.[ShortlistId],
        UPS.[UserId],
	    UPS.[MasterId],
		UPS.[MasterType],
        UPS.[ShortlistedOn],
        UPS.[Remarks],
		A.ProjectName,
		A.Address,
		A.City,
		A.State,
		A.Pincode,
		A.BusinessId,
		B.BusinessName,
		B.BusinessType,
		B.LogoURL,
		A.Status,
		C.ImgPath AS DefaultImage,

		--GET DISTINCT BHK as Comma Seperated
		STUFF((
			SELECT DISTINCT ', ' + CAST(D.BHK AS VARCHAR(10))
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0
				AND D.BHK IS NOT NULL
			FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS BHKConfig,

		--Min Carpet Area
		(SELECT MIN(D.CarpetArea)
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0
				AND D.CarpetArea IS NOT NULL) AS MinCarpetArea,

		--Max Carpet Area
		(SELECT MAX(D.CarpetArea)
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0
				AND D.CarpetArea IS NOT NULL) AS MaxCarpetArea,

		--Min Price
		(SELECT MIN(D.BasePrice)
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0	
				AND D.BasePrice IS NOT NULL) AS MinPrice,

		--Max Price
		(SELECT MAX(D.BasePrice)
			FROM [Nishwik].[re].[ProjectUnitType] D
			WHERE D.ProjectId = A.ProjectId
				AND D.IsActive = 1 AND D.IsDeleted = 0
				AND D.BasePrice IS NOT NULL) AS MaxPrice

	FROM [Nishwik].[re].[UserPropertyShortlist] UPS
	LEFT OUTER JOIN [Nishwik].[re].[Project] A
		ON UPS.MasterId = A.ProjectId
	INNER JOIN [Nishwik].[re].[BusinessMaster] B
		ON A.[BusinessId] = B.[BusinessId]
	OUTER APPLY (
		SELECT TOP 1 ImgPath
		FROM [Nishwik].[re].[RealEstateImgMaster] C
		WHERE C.MasterType = 'Project'
			AND C.MasterId = A.ProjectId
			AND C.IsDefault = 1
			AND C.IsActive = 1 AND C.IsDeleted = 0
	) C
	WHERE UPS.[UserId] = @UserId
	  AND UPS.[MasterType] = 'Project'
      AND UPS.[IsActive] = 1
      AND UPS.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_GetUserShortlistProperties]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserPropertyShortlist_GetUserShortlistProperties]
(
    @UserId INT
)
AS
BEGIN 
    SET NOCOUNT ON;

    SELECT 
        A.[ShortlistId],
        A.[UserId],
	    A.[MasterId],
		A.[MasterType],
        A.[ShortlistedOn],
        A.[Remarks],
        B.[BusinessId],
        B.[PostedBy],
        B.[Title],
        B.[PropertyType],
        B.[ListingType],
        B.[City],
        B.[State],
        B.[Locality],
        B.[Address],
        B.[Pincode],
        B.[Status],
        B.[ListedOn],
        C.[Price],
        D.[BHK],
        D.[SuperArea],
        D.[CarpetArea],
        D.[Furnishing],
        D.[FloorNumber],
        D.[TotalFloors],
        D.[AgeOfConstruction],
        D.[Facing],
        -- Get only the default listing image
        (
            SELECT TOP 1 RIM.[ImgPath]
            FROM [re].[RealEstateImgMaster] RIM
            WHERE RIM.[MasterType] = 'Listing'
              AND RIM.[MasterId] = A.[MasterId]
              AND RIM.[IsActive] = 1
              AND RIM.[IsDeleted] = 0
            ORDER BY 
                CASE WHEN RIM.[IsDefault] = 1 THEN 0 ELSE 1 END,
                RIM.[CreatedOn] DESC
        ) AS ListingImage
    FROM [re].[UserPropertyShortlist] A
    LEFT JOIN [re].[Property] B
        ON A.[MasterId] = B.[PropertyId]
    LEFT JOIN [re].[PropertyListing] C
        ON A.[MasterId] = C.[PropertyId]
    LEFT JOIN [re].[PropertyDetails] D
        ON A.[MasterId] = D.[PropertyId]
    WHERE A.[UserId] = @UserId
	  AND A.[MasterType] = 'Property'
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserPropertyShortlist_ReadAll]
AS
 BEGIN
    SET NOCOUNT ON;
	 SELECT 
	   [ShortlistId]
      ,[UserId]
	  ,[MasterId]
	  ,[MasterType]
      ,[ShortlistedOn]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [re].[UserPropertyShortlist]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserPropertyShortlist_ReadById]
(
    @ShortlistId BIGINT
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [ShortlistId]
		,[UserId]
	    ,[MasterId]
	    ,[MasterType]
		,[ShortlistedOn]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[UserPropertyShortlist]
	WHERE [ShortlistId] = @ShortlistId
	AND  [IsActive] = 1
	AND [IsDeleted] = 0
END
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_ReadByPropertyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserPropertyShortlist_ReadByPropertyId]
(
    @PropertyId BIGINT
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [ShortlistId]
		,[UserId]
	    ,[MasterId]
	    ,[MasterType]
		,[ShortlistedOn]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[UserPropertyShortlist]
	WHERE [PropertyId] = @PropertyId
	AND  [IsActive] = 1
	AND [IsDeleted] = 0
END
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserPropertyShortlist_ReadByUserId]
(
    @UserId INT,
	@MasterType VARCHAR(30)
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [ShortlistId]
		,[UserId]
	    ,[MasterId]
	    ,[MasterType]
		,[ShortlistedOn]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[UserPropertyShortlist]
	WHERE [UserId] = @UserId
		AND [MasterType] = @MasterType
		AND  [IsActive] = 1
		AND [IsDeleted] = 0
END
GO
/****** Object:  StoredProcedure [re].[UserPropertyShortlist_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [re].[UserPropertyShortlist_Update]
(
    @ShortlistId    BIGINT,
    @UserId         INT,
    @MasterId   INT,                 -- New required
    @MasterType VARCHAR(50), 
    @ShortlistedOn  DATETIME,
    @Remarks        VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[UserPropertyShortlist]
    SET 
        [UserId]     =    @UserId,
        [MasterId]   =    @MasterId,
		[MasterType] =    @MasterType,
        [ShortlistedOn]  = @ShortlistedOn,
        [Remarks]        = TRIM(@Remarks),
        [OtherDetail1]   = TRIM(@OtherDetail1),
        [OtherDetail2]   = TRIM(@OtherDetail2),
        [OtherDetail3]   = TRIM(@OtherDetail3),
        [OtherDetail4]   = TRIM(@OtherDetail4),
        [OtherDetail5]   = TRIM(@OtherDetail5),
        [OtherDetail6]   = TRIM(@OtherDetail6),
        [IsActive]       = @IsActive,
        [ModifiedBy]     = TRIM(@ActionUser),
        [ModifiedOn]     = GETDATE()
    WHERE [ShortlistId] = @ShortlistId;

    SELECT 
        [ShortlistId],
        [UserId],
 	    [MasterId],
		[MasterType],
        [ShortlistedOn],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [re].[UserPropertyShortlist]
    WHERE [ShortlistId] = @ShortlistId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [re].[UserRoleInProperty_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [re].[UserRoleInProperty_Create]
(
    @PropertyId          BIGINT,
    @UserId              INT,
    @Role                VARCHAR(50),
    @IsPrimary           INT,
    @FullName            VARCHAR(150),
    @ContactNumber       VARCHAR(15),
    @Email               VARCHAR(100),
    @AgencyName          VARCHAR(150),
    @RERARegistrationNo  VARCHAR(100),
    @Verified            INT,
    @OtherDetail1        VARCHAR(50),
    @OtherDetail2        VARCHAR(50),
    @OtherDetail3        VARCHAR(100),
    @OtherDetail4        VARCHAR(100),
    @OtherDetail5        VARCHAR(500),
    @OtherDetail6        VARCHAR(500),
    @ActionUser          VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RecordId BIGINT;

    INSERT INTO [re].[UserRoleInProperty]
    (
        PropertyId,
        UserId,
        Role,
        IsPrimary,
        FullName,
        ContactNumber,
        Email,
        AgencyName,
        RERARegistrationNo,
        Verified,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    VALUES
    (
        @PropertyId,
        @UserId,
        @Role,
        @IsPrimary,
        @FullName,
        @ContactNumber,
        @Email,
        @AgencyName,
        @RERARegistrationNo,
        @Verified,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @RecordId = SCOPE_IDENTITY();

    SELECT
        RecordId,
        PropertyId,
        UserId,
        Role,
        IsPrimary,
        FullName,
        ContactNumber,
        Email,
        AgencyName,
        RERARegistrationNo,
        Verified,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [re].[UserRoleInProperty]
    WHERE RecordId = @RecordId;
END;
GO
/****** Object:  StoredProcedure [re].[UserRoleInProperty_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserRoleInProperty_Delete]
(
   @RecordId bigint,
   @ActionUser  varchar(50)
)
AS
	BEGIN 
	SET NOCOUNT ON;
	UPDATE [re].[UserRoleInProperty]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [RecordId] = @RecordId
END;
GO
/****** Object:  StoredProcedure [re].[UserRoleInProperty_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserRoleInProperty_ReadAll]
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [RecordId]
		,[PropertyId]
		,[UserId]
		,[Role]
		,[IsPrimary]
		,[FullName]
		,[ContactNumber]
		,[Email]
		,[AgencyName]
		,[RERARegistrationNo]
		,[Verified]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[UserRoleInProperty]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserRoleInProperty_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserRoleInProperty_ReadById]
(
   @RecordId BIGINT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [RecordId]
		,[PropertyId]
		,[UserId]
		,[Role]
		,[IsPrimary]
		,[FullName]
		,[ContactNumber]
		,[Email]
		,[AgencyName]
		,[RERARegistrationNo]
		,[Verified]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[UserRoleInProperty]
	WHERE [RecordId] = @RecordId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserRoleInProperty_ReadByPropertyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserRoleInProperty_ReadByPropertyId]
(
   @PropertyId BIGINT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [RecordId]
		,[PropertyId]
		,[UserId]
		,[Role]
		,[IsPrimary]
		,[FullName]
		,[ContactNumber]
		,[Email]
		,[AgencyName]
		,[RERARegistrationNo]
		,[Verified]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[UserRoleInProperty]
	WHERE [PropertyId] = @PropertyId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserRoleInProperty_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserRoleInProperty_ReadByUserId]
(
   @UserId INT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [RecordId]
		,[PropertyId]
		,[UserId]
		,[Role]
		,[IsPrimary]
		,[FullName]
		,[ContactNumber]
		,[Email]
		,[AgencyName]
		,[RERARegistrationNo]
		,[Verified]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [re].[UserRoleInProperty]
	WHERE [UserId] = @UserId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [re].[UserRoleInProperty_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [re].[UserRoleInProperty_Update]
(
    @RecordId            BIGINT,
    @PropertyId          BIGINT,
    @UserId              INT,
    @Role                VARCHAR(50),
    @IsPrimary           INT,
    @FullName            VARCHAR(150),
    @ContactNumber       VARCHAR(15),
    @Email               VARCHAR(100),
    @AgencyName          VARCHAR(150),
    @RERARegistrationNo  VARCHAR(100),
    @Verified            INT,
    @OtherDetail1        VARCHAR(50),
    @OtherDetail2        VARCHAR(50),
    @OtherDetail3        VARCHAR(100),
    @OtherDetail4        VARCHAR(100),
    @OtherDetail5        VARCHAR(500),
    @OtherDetail6        VARCHAR(500),
    @IsActive            INT,
    @ActionUser          VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [re].[UserRoleInProperty]
    SET
        PropertyId         = @PropertyId,
        UserId             = @UserId,
        Role               = @Role,
        IsPrimary          = @IsPrimary,
        FullName           = @FullName,
        ContactNumber      = @ContactNumber,
        Email              = @Email,
        AgencyName         = @AgencyName,
        RERARegistrationNo = @RERARegistrationNo,
        Verified           = @Verified,
        OtherDetail1       = @OtherDetail1,
        OtherDetail2       = @OtherDetail2,
        OtherDetail3       = @OtherDetail3,
        OtherDetail4       = @OtherDetail4,
        OtherDetail5       = @OtherDetail5,
        OtherDetail6       = @OtherDetail6,
        IsActive           = @IsActive,
        ModifiedBy         = @ActionUser,
        ModifiedOn         = GETDATE()
    WHERE
        RecordId = @RecordId

    SELECT
        RecordId,
        PropertyId,
        UserId,
        Role,
        IsPrimary,
        FullName,
        ContactNumber,
        Email,
        AgencyName,
        RERARegistrationNo,
        Verified,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn,
        ModifiedBy,
        ModifiedOn
    FROM [re].[UserRoleInProperty]
    WHERE RecordId = @RecordId;
END;
GO
/****** Object:  StoredProcedure [sm].[Announcement_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*

EXEC [sm].[Announcement_Create]
    @SocietyId     = 1,
    @Title         = 'Maintenance Notice',
    @Message       = N'Water supply will be unavailable from 10 AM to 2 PM tomorrow.',
    @Audience      = 'All',
    @PostedBy      = 101,
    @PostedAt      = NULL,
    @ValidUntil    = NULL,
    @Languages     = N'English,Hindi',
    @OtherDetail1  = 'Urgent',
    @OtherDetail2  = NULL,
    @OtherDetail3  = NULL,
    @OtherDetail4  = NULL,
    @OtherDetail5  = NULL,
    @OtherDetail6  = NULL,
    @ActionUser    = 'Admin';


*/

CREATE   PROCEDURE [sm].[Announcement_Create]
(
    @SocietyId     INT,
    @Title         VARCHAR(200),
    @Message       NVARCHAR(2000),
    @Audience      VARCHAR(50),
    @PostedBy      INT,
    @PostedAt      DATETIME,
    @ValidUntil    DATETIME,
	@Languages    NVARCHAR(MAX),
    @OtherDetail1  VARCHAR(50),
    @OtherDetail2  VARCHAR(50),
    @OtherDetail3  VARCHAR(100),
    @OtherDetail4  VARCHAR(100),
    @OtherDetail5  VARCHAR(500),
    @OtherDetail6  VARCHAR(500),
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AnnouncementId INT;

    INSERT INTO [sm].[Announcement]
    (
        [SocietyId],
        [Title],
        [Message],
        [Audience],
        [PostedBy],
        [PostedAt],
        [ValidUntil],
		[Languages],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SocietyId,
        @Title,
        @Message,
        @Audience,
        @PostedBy,
        @PostedAt,
        @ValidUntil,
		@Languages,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,
        GETDATE()
    );

    SET @AnnouncementId = SCOPE_IDENTITY();

    SELECT
        [AnnouncementId],
        [SocietyId],
        [Title],
        [Message],
        [Audience],
        [PostedBy],
        [PostedAt],
        [ValidUntil],
		[Languages],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Announcement]
    WHERE [AnnouncementId] = @AnnouncementId;
END;
GO
/****** Object:  StoredProcedure [sm].[Announcement_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Announcement_Delete]
(
    @AnnouncementId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[sm].[Announcement]
	SET
		  [IsActive] = 0,  
		  [IsDeleted] = 1, 
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [AnnouncementId] = @AnnouncementId
END;
GO
/****** Object:  StoredProcedure [sm].[Announcement_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Announcement_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [AnnouncementId]
		,[SocietyId]
		,[Title]
		,[Message]
		,[Audience]
		,[PostedBy]
		,[PostedAt]
		,[ValidUntil]
		,[Languages]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Announcement]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Announcement_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Announcement_ReadById]
(
    @AnnouncementId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [AnnouncementId]
		,[SocietyId]
		,[Title]
		,[Message]
		,[Audience]
		,[PostedBy]
		,[PostedAt]
		,[ValidUntil]
		 ,[Languages]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Announcement]
	WHERE [AnnouncementId] = @AnnouncementId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Announcement_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Announcement_ReadBySocietyId]
(
    @SocietyId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [AnnouncementId]
		,[SocietyId]
		,[Title]
		,[Message]
		,[Audience]
		,[PostedBy]
		,[PostedAt]
		,[ValidUntil]
	    ,[Languages]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Announcement]
	WHERE [SocietyId] = @SocietyId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Announcement_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Announcement_Update]
(
    @AnnouncementId INT,
    @SocietyId      INT,
    @Title          VARCHAR(200),
    @Message        NVARCHAR(2000),
    @Audience       VARCHAR(50),
    @PostedBy       INT,
    @PostedAt       DATETIME,
    @ValidUntil     DATETIME,
	@Languages      NVARCHAR(MAX),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[Announcement]
    SET
        [SocietyId]     = @SocietyId,
        [Title]         = @Title,
        [Message]       = @Message,
        [Audience]      = @Audience,
        [PostedBy]      = @PostedBy,
        [PostedAt]      = @PostedAt,
        [ValidUntil]    = @ValidUntil,
		[Languages]    = @Languages,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [AnnouncementId] = @AnnouncementId;

    SELECT
        [AnnouncementId],
        [SocietyId],
        [Title],
        [Message],
        [Audience],
        [PostedBy],
        [PostedAt],
        [ValidUntil],
		[Languages],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Announcement]
    WHERE [AnnouncementId] = @AnnouncementId;
END;
GO
/****** Object:  StoredProcedure [sm].[Building_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Building_Create]
(
    @SocietyId       INT,
    @BuildingName    VARCHAR(100),
    @Floors          INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BuildingId INT;

    INSERT INTO [sm].[Building]
    (
        SocietyId,
        BuildingName,
        Floors,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    VALUES
    (
        @SocietyId,
        @BuildingName,
        @Floors,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @BuildingId = SCOPE_IDENTITY();

    SELECT
	   [BuildingId]
      ,[SocietyId]
      ,[BuildingName]
      ,[Floors]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [sm].[Building]
    WHERE BuildingId = @BuildingId;
END;
GO
/****** Object:  StoredProcedure [sm].[Building_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Building_CreateBulk]
(
  @BuildingIdList  [sm].[udt_Building] READONLY,
  @ActionUser VARCHAR(50)
)
AS
BEGIN 
    SET NOCOUNT ON;

    INSERT INTO [Nishwik].[sm].[Building]
    (
       [SocietyId],
       [BuildingName],
       [Floors],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn]
    )
    SELECT 
       [SocietyId],
       [BuildingName],
       [Floors],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       1,
       0,               
       @ActionUser,    
       GETDATE()      
    FROM @BuildingIdList;

    SELECT 
       [BuildingId],
       [SocietyId],
       [BuildingName],
       [Floors],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
    FROM [Nishwik].[sm].[Building]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [sm].[Building_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Building_Delete]
(
    @BuildingId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
    SET NOCOUNT ON;
	UPDATE [sm].[Building]
   SET
           [IsActive] = 0,
           [IsDeleted] = 1,
           [ModifiedBy] = @ActionUser,
           [ModifiedOn] = GETDATE()
	  WHERE [BuildingId] = @BuildingId
END;
GO
/****** Object:  StoredProcedure [sm].[Building_GetDictionary]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Building_GetDictionary]
(
    @SocietyId BIGINT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT  
          [Key]   = BuildingId,
          [Value] = BuildingName
    FROM sm.Building
    WHERE 
            SocietyId = @SocietyId
        AND IsActive = 1
        AND IsDeleted = 0
    ORDER BY 
        BuildingName;
END;
GO
/****** Object:  StoredProcedure [sm].[Building_GetFlatSummaryBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Building_GetFlatSummaryBySocietyId]
(
    @SocietyId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        -- Building Details
        B.BuildingId,
        B.BuildingName,
        B.Floors,

        -- Flat Details
        F.FlatId,
        F.FlatNumber,
        F.Wing,
        F.Floor,
        F.Status,
        F.OccupantType,
        F.OwnerId,
        F.PossessionDate,
        F.ParkingSlotNumber,
        F.IntercomNumber,
        F.MaintenanceStatus,
        F.FlatTypeId,
        F.CreatedOn,
        F.ModifiedOn

    FROM sm.Building AS B
    LEFT JOIN sm.Flat AS F
        ON F.BuildingId = B.BuildingId
       AND F.IsActive = 1
       AND F.IsDeleted = 0

    WHERE 
        B.SocietyId = @SocietyId
        AND B.IsActive = 1 
        AND B.IsDeleted = 0

    ORDER BY 
        B.BuildingName,
        F.Floor,
        F.FlatNumber;
END
GO
/****** Object:  StoredProcedure [sm].[Building_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Building_ReadAll]
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [BuildingId]
      ,[SocietyId]
      ,[BuildingName]
      ,[Floors]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Building]
	  WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Building_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [sm].[Building_ReadAllPaginated] 
    @PageSize = 100,
    @PageNo = 1,
    @OrderByClause = '',
    @WhereClause = '';
*/
CREATE   PROCEDURE [sm].[Building_ReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL

)
AS
 BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL =

	'SELECT
	ROW_NUMBER() OVER (ORDER BY ' + 
	ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
	') AS RowNum,
		[BuildingId],
		[SocietyId],
		[BuildingName],
		[Floors],
		[OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
		[OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
		[IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn],
		[ModifiedBy],
		[ModifiedOn],
	COUNT(*) OVER () AS TotalCount,
	' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
	' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [Nishwik].[sm].[Building]
	WHERE [IsActive] = 1 ';


	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
	END;
GO
/****** Object:  StoredProcedure [sm].[Building_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Building_ReadById]
(
    @BuildingId INT
)
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [BuildingId]
      ,[SocietyId]
      ,[BuildingName]
      ,[Floors]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Building]
	  WHERE [BuildingId] = @BuildingId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Building_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Building_ReadBySocietyId]
(
    @SocietyId INT
)
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [BuildingId]
      ,[SocietyId]
      ,[BuildingName]
      ,[Floors]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Building]
	  WHERE [SocietyId] = @SocietyId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Building_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Building_Update]
(
    @BuildingId      INT,
    @SocietyId       INT,
    @BuildingName    VARCHAR(100),
    @Floors          INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @IsActive        INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[Building]
    SET
        SocietyId      = @SocietyId,
        BuildingName   = @BuildingName,
        Floors         = @Floors,
        OtherDetail1   = @OtherDetail1,
        OtherDetail2   = @OtherDetail2,
        OtherDetail3   = @OtherDetail3,
        OtherDetail4   = @OtherDetail4,
        OtherDetail5   = @OtherDetail5,
        OtherDetail6   = @OtherDetail6,
        IsActive       = @IsActive,
        ModifiedBy     = @ActionUser,
        ModifiedOn     = GETDATE()
    WHERE
        BuildingId = @BuildingId
 

    SELECT
       [BuildingId],
       [SocietyId],
       [BuildingName],
       [Floors],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
    FROM [sm].[Building]
    WHERE BuildingId = @BuildingId
	 AND IsActive =1;
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[DiscussionDetail_Create]
(
    @DiscussionId     INT,
	@PostedByFlatId    INT,
    @PostedBy         VARCHAR(50),
    @PostedAt         DATETIME = NULL,
    @DiscDesc         NVARCHAR(4000) = NULL,
    @OtherDetail1     VARCHAR(50) = NULL,
    @OtherDetail2     VARCHAR(50) = NULL,
    @OtherDetail3     VARCHAR(100) = NULL,
    @OtherDetail4     VARCHAR(100) = NULL,
    @OtherDetail5     VARCHAR(500) = NULL,
    @OtherDetail6     VARCHAR(500) = NULL,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId BIGINT;

    INSERT INTO [sm].[DiscussionDetail]
    (
        [DiscussionId],
		[PostedByFlatId],
        [PostedBy],
        [PostedAt],
        [DiscDesc],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @DiscussionId,
		@PostedByFlatId,
        TRIM(@PostedBy),
        @PostedAt,
        @DiscDesc,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,           
        0,           
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
        [DetailId],
        [DiscussionId],
		[PostedByFlatId],
        [PostedBy],
        [PostedAt],
        [DiscDesc],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[DiscussionDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[DiscussionDetail_Delete]
(
   @DetailId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	UPDATE [sm].[DiscussionDetail]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[CreatedBy] = @ActionUser,
		[CreatedOn] = GETDATE()
	WHERE  [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[DiscussionDetail_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		   [DetailId]
		  ,[DiscussionId]
		  ,[PostedByFlatId]
		  ,[PostedBy]
		  ,[PostedAt]
		  ,[DiscDesc]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[DiscussionDetail]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionDetail_ReadByDiscussionId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[DiscussionDetail_ReadByDiscussionId] 
(
   @DiscussionId INT
)
AS
BEGIN
    SET NOCOUNT ON;

	SELECT 
		 A.[DetailId],
		 A.[DiscussionId],
		 A.[PostedByFlatId],
		 A.[PostedBy],
		 B.FirstName + ' ' + B.LastName AS UserName,
		 A.[PostedAt],
		 A.[DiscDesc],
		 A.[OtherDetail1],
		 A.[OtherDetail2],
		 A.[OtherDetail3],
		 A.[OtherDetail4],
		 A.[OtherDetail5],
		 A.[OtherDetail6],
		 A.[IsActive],
		 A.[IsDeleted],
		 A.[CreatedBy],
		 A.[CreatedOn],
		 A.[ModifiedBy],
		 A.[ModifiedOn]
	FROM [sm].[DiscussionDetail] A
	LEFT JOIN [dbo].[UserMaster] B
		ON A.PostedBy = B.UserId
	WHERE A.[DiscussionId] = @DiscussionId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
	ORDER BY A.[PostedAt] ASC;   -- oldest first, or DESC for newest first
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[DiscussionDetail_ReadById]
(
   @DetailId BIGINT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		   [DetailId]
		  ,[DiscussionId]
		  ,[PostedByFlatId]
		  ,[PostedBy]
		  ,[PostedAt]
		  ,[DiscDesc]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[DiscussionDetail]
	  WHERE  [DetailId] = @DetailId
	  AND    [IsActive] = 1
	  AND    [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[DiscussionDetail_Update]
(
    @DetailId        BIGINT,
    @DiscussionId    INT,
	@PostedByFlatId   INT,
    @PostedBy        VARCHAR(50) = NULL,
    @PostedAt        DATETIME = NULL,
    @DiscDesc        NVARCHAR(4000) = NULL,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @IsActive        INT = 1,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[DiscussionDetail]
    SET
        [DiscussionId] = @DiscussionId,
		[PostedByFlatId] = @PostedByFlatId,
        [PostedBy] = TRIM(@PostedBy),
        [PostedAt] = @PostedAt,
        [DiscDesc] = @DiscDesc,
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive] = @IsActive,
        [ModifiedBy] = TRIM(@ActionUser),
        [ModifiedOn] = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT
        [DetailId],
        [DiscussionId],
		[PostedByFlatId],
        [PostedBy],
        [PostedAt],
        [DiscDesc],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[DiscussionDetail]
    WHERE [DetailId] = @DetailId
      AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[DiscussionMaster_Create]
(
    @SocietyId   INT = NULL,
    @BuildingId        INT = NULL,
    @DiscTitle       VARCHAR(500) = NULL,
    @DiscDesc        NVARCHAR(4000) = NULL,
	@PostedByFlatId    INT = NULL,
    @PostedBy        VARCHAR(50) = NULL,
    @PostedAt        DATETIME = NULL,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DiscussionId INT;

    INSERT INTO [sm].[DiscussionMaster]
    (
      [SocietyId],
      [BuildingId],
      [DiscTitle],
      [DiscDesc],
      [PostedByFlatId],
      [PostedBy],
      [PostedAt],
      [OtherDetail1],
      [OtherDetail2],
      [OtherDetail3],
      [OtherDetail4],
      [OtherDetail5],
      [OtherDetail6],
      [IsActive],
      [IsDeleted],
      [CreatedBy],
      [CreatedOn]
    )
    VALUES
    (
        @SocietyId,
        @BuildingId,
        TRIM(@DiscTitle),
        @DiscDesc,
		@PostedByFlatId,
        TRIM(@PostedBy),
        @PostedAt,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,             
        0,             
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DiscussionId = SCOPE_IDENTITY();

    SELECT
           [DiscussionId]
		  ,[SocietyId]
		  ,[BuildingId]
		  ,[DiscTitle]
		  ,[DiscDesc]
		  ,[PostedByFlatId]
		  ,[PostedBy]
		  ,[PostedAt]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
    FROM [sm].[DiscussionMaster]
    WHERE [DiscussionId] = @DiscussionId;
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[DiscussionMaster_Delete]
( 
   @DiscussionId INT,
   @ActionUser VARCHAR(50)
)
 AS
  BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[DiscussionMaster]
	SET 
		[IsActive] = 0,
		[IsDeleted] = 1,
		[CreatedBy] = @ActionUser,
		[CreatedOn] = GETDATE()
	FROM [sm].[DiscussionMaster]
	WHERE  [DiscussionId] = @DiscussionId 
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[DiscussionMaster_ReadAll]
 AS
  BEGIN 
	SET NOCOUNT ON;
	SELECT 
       [DiscussionId]
      ,[SocietyId]
      ,[BuildingId]
      ,[DiscTitle]
      ,[DiscDesc]
      ,[PostedByFlatId]
      ,[PostedBy]
      ,[PostedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[DiscussionMaster]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionMaster_ReadByBuildingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[DiscussionMaster_ReadByBuildingId]
( 
   @BuildingId INT
)
 AS
  BEGIN 
	SET NOCOUNT ON;
	SELECT 
       [DiscussionId]
      ,[SocietyId]
      ,[BuildingId]
      ,[DiscTitle]
      ,[DiscDesc]
      ,[PostedByFlatId]
      ,[PostedBy]
      ,[PostedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[DiscussionMaster]
	WHERE  [BuildingId] = @BuildingId
	AND  [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[DiscussionMaster_ReadById]
( 
   @DiscussionId INT
)
 AS
  BEGIN 
	SET NOCOUNT ON;
	SELECT 
       [DiscussionId]
      ,[SocietyId]
      ,[BuildingId]
      ,[DiscTitle]
      ,[DiscDesc]
      ,[PostedByFlatId]
      ,[PostedBy]
      ,[PostedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[DiscussionMaster]
	WHERE  [DiscussionId] = @DiscussionId
	AND  [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionMaster_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[DiscussionMaster_ReadBySocietyId]
( 
   @SocietyId INT
)
 AS
  BEGIN 
	SET NOCOUNT ON;
	SELECT 
       [DiscussionId]
      ,[SocietyId]
      ,[BuildingId]
      ,[DiscTitle]
      ,[DiscDesc]
      ,[PostedByFlatId]
      ,[PostedBy]
      ,[PostedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[DiscussionMaster]
	WHERE  [SocietyId] = @SocietyId
	AND  [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[DiscussionMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[DiscussionMaster_Update]
(
    @DiscussionId     INT,
    @SocietyId        INT = NULL,
    @BuildingId       INT = NULL,
    @DiscTitle        VARCHAR(500) = NULL,
    @DiscDesc         NVARCHAR(4000) = NULL,
    @PostedByFlatId   INT = NULL,
    @PostedBy         VARCHAR(50) = NULL,
    @PostedAt         DATETIME = NULL,
    @OtherDetail1     VARCHAR(50) = NULL,
    @OtherDetail2     VARCHAR(50) = NULL,
    @OtherDetail3     VARCHAR(100) = NULL,
    @OtherDetail4     VARCHAR(100) = NULL,
    @OtherDetail5     VARCHAR(500) = NULL,
    @OtherDetail6     VARCHAR(500) = NULL,
    @IsActive         INT = 1,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[DiscussionMaster]
    SET
        [SocietyId]      = @SocietyId,
        [BuildingId]     = @BuildingId,
        [DiscTitle]      = TRIM(@DiscTitle),
        [DiscDesc]       = @DiscDesc,
        [PostedByFlatId] = @PostedByFlatId,
        [PostedBy]       = TRIM(@PostedBy),
        [PostedAt]       = @PostedAt,
        [OtherDetail1]   = TRIM(@OtherDetail1),
        [OtherDetail2]   = TRIM(@OtherDetail2),
        [OtherDetail3]   = TRIM(@OtherDetail3),
        [OtherDetail4]   = TRIM(@OtherDetail4),
        [OtherDetail5]   = TRIM(@OtherDetail5),
        [OtherDetail6]   = TRIM(@OtherDetail6),
        [IsActive]       = @IsActive,
        [ModifiedBy]     = TRIM(@ActionUser),
        [ModifiedOn]     = GETDATE()
    WHERE [DiscussionId] = @DiscussionId;

    SELECT
          [DiscussionId],
          [SocietyId],
          [BuildingId],
          [DiscTitle],
          [DiscDesc],
          [PostedByFlatId],
          [PostedBy],
          [PostedAt],
          [OtherDetail1],
          [OtherDetail2],
          [OtherDetail3],
          [OtherDetail4],
          [OtherDetail5],
          [OtherDetail6],
          [IsActive],
          [IsDeleted],
          [CreatedBy],
          [CreatedOn],
          [ModifiedBy],
          [ModifiedOn]
    FROM [sm].[DiscussionMaster]
    WHERE [DiscussionId] = @DiscussionId
          AND [IsDeleted] = 0
		  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Facility_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Facility_Create]
(
    @SocietyId                INT,
    @FacilityName             VARCHAR(100),
    @Description              VARCHAR(500),
    @BookingCharges           DECIMAL(18, 2),
    @AdvanceNoticeHours       INT,
    @ChargeType               VARCHAR(20),
    @SlotDurationMinutes      INT,
    @IsSlotBased              INT,
    @IsApprovalRequired       INT,
    @MaxBookingPerDay         INT,
    @MaintenanceBlackoutDays  NVARCHAR(100),
    @MaxUsersPerSlot          INT,
    @AllowGuestAccess         INT,
	@StartTime                 TIME,
	@EndTime                   TIME,
    @FacilityImageUrl         NVARCHAR(200),
    @OtherDetail1             VARCHAR(50),
    @OtherDetail2             VARCHAR(50),
    @OtherDetail3             VARCHAR(100),
    @OtherDetail4             VARCHAR(100),
    @OtherDetail5             VARCHAR(500),
    @OtherDetail6             VARCHAR(500),
    @ActionUser               VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FacilityId INT;

    INSERT INTO [sm].[Facility]
    (
        [SocietyId],
        [FacilityName],
        [Description],
        [BookingCharges],
        [AdvanceNoticeHours],
        [ChargeType],
        [SlotDurationMinutes],
        [IsSlotBased],
        [IsApprovalRequired],
        [MaxBookingPerDay],
        [MaintenanceBlackoutDays],
        [MaxUsersPerSlot],
        [AllowGuestAccess],
        [FacilityImageUrl],
		[StartTime],
		[EndTime],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SocietyId,
        @FacilityName,
        @Description,
        @BookingCharges,
        @AdvanceNoticeHours,
        @ChargeType,
        @SlotDurationMinutes,
        @IsSlotBased,
        @IsApprovalRequired,
        @MaxBookingPerDay,
        @MaintenanceBlackoutDays,
        @MaxUsersPerSlot,
        @AllowGuestAccess,
        @FacilityImageUrl,
		@StartTime,
		@EndTime,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,
        GETDATE()
    );

    SET @FacilityId = SCOPE_IDENTITY();

    SELECT 
        [FacilityId],
        [SocietyId],
        [FacilityName],
        [Description],
        [BookingCharges],
        [AdvanceNoticeHours],
        [ChargeType],
        [SlotDurationMinutes],
        [IsSlotBased],
        [IsApprovalRequired],
        [MaxBookingPerDay],
        [MaintenanceBlackoutDays],
        [MaxUsersPerSlot],
        [AllowGuestAccess],
        [FacilityImageUrl],
	    [StartTime],
		[EndTime],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Facility]
    WHERE [FacilityId] = @FacilityId;
END;
GO
/****** Object:  StoredProcedure [sm].[Facility_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[Facility_CreateBulk]
(
	@FacilityIdList   [sm].[udt_Facility] READONLY,
	@ActionUser Varchar(50)
)
AS
BEGIN
      SET NOCOUNT ON;
	  INSERT INTO [sm].[Facility]
	  (
	   [SocietyId]
      ,[FacilityName]
      ,[Description]
      ,[BookingCharges]
      ,[AdvanceNoticeHours]
	  ,[ChargeType]
      ,[SlotDurationMinutes]
      ,[IsSlotBased]
      ,[IsApprovalRequired]
      ,[MaxBookingPerDay]
      ,[MaintenanceBlackoutDays]
      ,[MaxUsersPerSlot]
      ,[AllowGuestAccess]
      ,[FacilityImageUrl]
      ,[StartTime]
      ,[EndTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
	  )
	  SELECT 
	   [SocietyId]
      ,[FacilityName]
      ,[Description]
      ,[BookingCharges]
      ,[AdvanceNoticeHours]
	  ,[ChargeType]
      ,[SlotDurationMinutes]
      ,[IsSlotBased]
      ,[IsApprovalRequired]
      ,[MaxBookingPerDay]
      ,[MaintenanceBlackoutDays]
      ,[MaxUsersPerSlot]
      ,[AllowGuestAccess]
      ,[FacilityImageUrl]
      ,[StartTime]
      ,[EndTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,1
      ,0
      ,@ActionUser
      ,GETDATE()
	FROM @FacilityIdList;

	SELECT 
	   [FacilityId]
      ,[SocietyId]
      ,[FacilityName]
      ,[Description]
      ,[BookingCharges]
      ,[AdvanceNoticeHours]
	  ,[ChargeType]
      ,[SlotDurationMinutes]
      ,[IsSlotBased]
      ,[IsApprovalRequired]
      ,[MaxBookingPerDay]
      ,[MaintenanceBlackoutDays]
      ,[MaxUsersPerSlot]
      ,[AllowGuestAccess]
      ,[FacilityImageUrl]
      ,[StartTime]
      ,[EndTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [Nishwik].[sm].[Facility]
	  	    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE()); 
END;


	

GO
/****** Object:  StoredProcedure [sm].[Facility_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Facility_Delete]
(
   @FacilityId int,
   @ActionUser varchar(50)
)
AS
 BEGIN
   SET NOCOUNT ON;
   UPDATE [sm].[Facility]
   SET 
         [IsActive] = 0,
         [IsDeleted] = 1,
         [ModifiedBy] = @ActionUser,
         [ModifiedOn] = GETDATE()
	  WHERE [FacilityId] = @FacilityId
END;
GO
/****** Object:  StoredProcedure [sm].[Facility_GetBookingDetailsBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [sm].[Facility_GetBookingDetailsBySocietyId]
    @SocietyId = 14,
    @Date = '2025-11-18';

*/
CREATE PROCEDURE [sm].[Facility_GetBookingDetailsBySocietyId]
(
    @SocietyId INT,
    @Date DATE
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        -- Concatenate FullName and FacilityName into a single message
        ISNULL(D.FirstName,'') + ' ' + ISNULL(D.LastName,'') 
        + ' booked ' + ISNULL(C.FacilityName, 'Unknown Facility') AS Message,
		B.FlatNumber,
        FB.TimeSlot,
        FB.BookingDate

    FROM [sm].[FacilityBooking] AS FB

    LEFT JOIN [sm].[Flat] AS B
        ON FB.FlatId = B.FlatId

    LEFT JOIN [sm].[Building] AS A
        ON B.BuildingId = A.BuildingId

    LEFT JOIN [sm].[Facility] AS C
        ON FB.FacilityId = C.FacilityId

    LEFT JOIN [sm].[UserAffiliationMapping] AS UAM
        ON UAM.FlatId = FB.FlatId
        AND UAM.SocietyId = FB.SocietyId
        AND UAM.IsActive = 1
        AND UAM.IsDeleted = 0
        AND UAM.IsPrimary = 1

    LEFT JOIN [dbo].[UserMaster] AS D
        ON UAM.UserId = D.UserId

    WHERE FB.SocietyId = @SocietyId
      AND CONVERT(DATE, FB.BookingDate) = @Date
      AND FB.IsActive = 1
      AND FB.IsDeleted = 0

    ORDER BY FB.TimeSlot;
END
GO
/****** Object:  StoredProcedure [sm].[Facility_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Facility_ReadAll]
AS
 BEGIN
   SET NOCOUNT ON;
   SELECT
       [FacilityId]
      ,[SocietyId]
      ,[FacilityName]
      ,[Description]
      ,[BookingCharges]
      ,[AdvanceNoticeHours]
	  ,[ChargeType]
      ,[SlotDurationMinutes]
      ,[IsSlotBased]
      ,[IsApprovalRequired]
      ,[MaxBookingPerDay]
      ,[MaintenanceBlackoutDays]
      ,[MaxUsersPerSlot]
      ,[AllowGuestAccess]
      ,[FacilityImageUrl]
	  ,[StartTime]
	  ,[EndTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Facility]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Facility_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Facility_ReadById]
(
   @FacilityId int
)
AS
 BEGIN
   SET NOCOUNT ON;
   SELECT
       [FacilityId]
      ,[SocietyId]
      ,[FacilityName]
      ,[Description]
      ,[BookingCharges]
      ,[AdvanceNoticeHours]
	  ,[ChargeType]
      ,[SlotDurationMinutes]
      ,[IsSlotBased]
      ,[IsApprovalRequired]
      ,[MaxBookingPerDay]
      ,[MaintenanceBlackoutDays]
      ,[MaxUsersPerSlot]
      ,[AllowGuestAccess]
      ,[FacilityImageUrl]
	  ,[StartTime]
	  ,[EndTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Facility]
	  WHERE [FacilityId] = @FacilityId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Facility_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Facility_ReadBySocietyId]
(
   @SocietyId int
)
AS
 BEGIN
   SET NOCOUNT ON;
   SELECT
       [FacilityId]
      ,[SocietyId]
      ,[FacilityName]
      ,[Description]
      ,[BookingCharges]
      ,[AdvanceNoticeHours]
	  ,[ChargeType]
      ,[SlotDurationMinutes]
      ,[IsSlotBased]
      ,[IsApprovalRequired]
      ,[MaxBookingPerDay]
      ,[MaintenanceBlackoutDays]
      ,[MaxUsersPerSlot]
      ,[AllowGuestAccess]
      ,[FacilityImageUrl]
	  ,[StartTime]
	  ,[EndTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Facility]
	  WHERE [SocietyId] = @SocietyId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Facility_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Facility_Update]
(
    @FacilityId            INT,
    @SocietyId             INT,
    @FacilityName          VARCHAR(100),
    @Description           VARCHAR(500),
    @BookingCharges        DECIMAL(18, 2),
    @AdvanceNoticeHours    INT,
    @OtherDetail1          VARCHAR(50),
    @OtherDetail2          VARCHAR(50),
    @OtherDetail3          VARCHAR(100),
    @OtherDetail4          VARCHAR(100),
    @OtherDetail5          VARCHAR(500),
    @OtherDetail6          VARCHAR(500),
    @ChargeType            VARCHAR(20),
    @SlotDurationMinutes   INT,
    @IsSlotBased           INT,
    @IsApprovalRequired    INT,
    @MaxBookingPerDay      INT,
    @MaintenanceBlackoutDays NVARCHAR(100),
    @MaxUsersPerSlot       INT,
	@StartTime              TIME,
	@EndTime                TIME,
    @AllowGuestAccess      INT,
    @FacilityImageUrl      NVARCHAR(200),
    @IsActive              INT,
    @ActionUser            VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[Facility]
    SET
        [SocietyId]              = @SocietyId,
        [FacilityName]           = @FacilityName,
        [Description]            = @Description,
        [BookingCharges]         = @BookingCharges,
        [AdvanceNoticeHours]     = @AdvanceNoticeHours,
		[ChargeType]             = @ChargeType,
        [SlotDurationMinutes]    = @SlotDurationMinutes,
        [IsSlotBased]            = @IsSlotBased,
        [IsApprovalRequired]     = @IsApprovalRequired,
        [MaxBookingPerDay]       = @MaxBookingPerDay,
        [MaintenanceBlackoutDays]= @MaintenanceBlackoutDays,
        [MaxUsersPerSlot]        = @MaxUsersPerSlot,
        [AllowGuestAccess]       = @AllowGuestAccess,
        [FacilityImageUrl]       = @FacilityImageUrl,
		[StartTime]             =  @StartTime,
		[EndTime]               =  @EndTime,
        [OtherDetail1]           = @OtherDetail1,
        [OtherDetail2]           = @OtherDetail2,
        [OtherDetail3]           = @OtherDetail3,
        [OtherDetail4]           = @OtherDetail4,
        [OtherDetail5]           = @OtherDetail5,
        [OtherDetail6]           = @OtherDetail6,
        [IsActive]               = @IsActive,
        [ModifiedBy]             = @ActionUser,
        [ModifiedOn]             = GETDATE()
    WHERE [FacilityId] = @FacilityId;

    SELECT 
        [FacilityId],
        [SocietyId],
        [FacilityName],
        [Description],
        [BookingCharges],
        [AdvanceNoticeHours],
	    [ChargeType],
        [SlotDurationMinutes],
        [IsSlotBased],
        [IsApprovalRequired],
        [MaxBookingPerDay],
        [MaintenanceBlackoutDays],
        [MaxUsersPerSlot],
        [AllowGuestAccess],
        [FacilityImageUrl],
		[StartTime],
		[EndTime],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Facility]
    WHERE [FacilityId] = @FacilityId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[FacilityBooking_Create]
(
    @FacilityId     INT,
    @FlatId         INT,
	@SocietyId      INT,
    @BookingDate    DATETIME,
    @TimeSlot       VARCHAR(50),
    @Status         VARCHAR(50),
    @AmountPaid     DECIMAL(18, 2),
    @PaymentRefNo   VARCHAR(100),
    @BookedAt       DATETIME,
	@StartTime      DATETIME,
	@EndTime        DATETIME,
	@ApprovedBy     INT,
	@ApprovedOn     DATETIME,
	@GuestCount     INT,
	@Notes          VARCHAR(500) ,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BookingId INT;

    INSERT INTO [sm].[FacilityBooking]
    (
        [FacilityId],
        [FlatId],
		[SocietyId],
        [BookingDate],
        [TimeSlot],
        [Status],
        [AmountPaid],
        [PaymentRefNo],
        [BookedAt],
		[StartTime],
		[EndTime],
		[ApprovedBy],
		[ApprovedOn],
		[GuestCount],
		[Notes],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @FacilityId,
        @FlatId,
		@SocietyId,
        @BookingDate,
        @TimeSlot,
        @Status,
        @AmountPaid,
        @PaymentRefNo,
        @BookedAt,
		@StartTime,
		@EndTime,
		@ApprovedBy,
		@ApprovedOn,
		@GuestCount,
		@Notes,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1, 
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @BookingId = SCOPE_IDENTITY();

    SELECT 
	   [BookingId]
      ,[FacilityId]
      ,[FlatId]
	  ,[SocietyId]
      ,[BookingDate]
      ,[TimeSlot]
      ,[Status]
      ,[AmountPaid]
      ,[PaymentRefNo]
      ,[BookedAt]
	  ,[StartTime]
	  ,[EndTime]
	  ,[ApprovedBy]
	  ,[ApprovedOn]
	  ,[GuestCount]
	  ,[Notes]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[FacilityBooking] 
	WHERE [BookingId] = @BookingId;
END;
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FacilityBooking_Delete]
(
    @BookingId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
  SET NOCOUNT ON;
	UPDATE[sm].[FacilityBooking]
	SET
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [BookingId] = @BookingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_GetBookingDetailsBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [sm].[FacilityBooking_GetBookingDetailsBySocietyId]
    @SocietyId = 14,         -- Replace with your SocietyId
    @Date = '2025-11-18';    -- Replace with the desired date
*/

CREATE PROCEDURE [sm].[FacilityBooking_GetBookingDetailsBySocietyId]
(
    @SocietyId INT,
    @Date DATETIME
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        -- Concatenated message for UI
        ISNULL(D.FirstName + ' ' + D.LastName, 'Unknown User') 
        + ' booked ' + ISNULL(C.FacilityName, 'Unknown Facility') 
        + ' (' + ISNULL(B.FlatNumber, 'Unknown Flat') + ')' AS [Message],

        ISNULL(B.FlatNumber, 'Unknown Flat') AS FlatNo,
        ISNULL(A.BuildingName, 'Unknown Building') AS BuildingName,

        FORMAT(F.StartTime, 'h:mm tt') + ' to ' + FORMAT(F.EndTime, 'h:mm tt') AS TimeSlot

    FROM [sm].[FacilityBooking] AS F
    LEFT JOIN [sm].[Flat] AS B
        ON F.FlatId = B.FlatId
    LEFT JOIN [sm].[Building] AS A
        ON B.BuildingId = A.BuildingId
    LEFT JOIN [sm].[Facility] AS C
        ON F.FacilityId = C.FacilityId
    LEFT JOIN [dbo].[UserMaster] AS D
        ON ISNULL(F.FacilityId, B.OwnerId) = D.UserId  -- Booking user fallback
    WHERE F.SocietyId = @SocietyId
      AND CONVERT(DATE, F.BookingDate) = CONVERT(DATE, @Date)
      AND F.IsActive = 1
      AND F.IsDeleted = 0
    ORDER BY F.StartTime;
END
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FacilityBooking_ReadAll]
AS
 BEGIN 
  SET NOCOUNT ON;
	SELECT
		 [BookingId]
		,[FacilityId]
		,[FlatId]
		,[SocietyId]
		,[BookingDate]
		,[TimeSlot]
		,[Status]
		,[AmountPaid]
		,[PaymentRefNo]
		,[BookedAt]
	    ,[StartTime]
	    ,[EndTime]
	    ,[ApprovedBy]
	    ,[ApprovedOn]
	    ,[GuestCount]
	    ,[Notes]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FacilityBooking]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_ReadByFacilityId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FacilityBooking_ReadByFacilityId]
(
    @FacilityId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
	SELECT
		 [BookingId]
		,[FacilityId]
		,[FlatId]
		,[SocietyId]
		,[BookingDate]
		,[TimeSlot]
		,[Status]
		,[AmountPaid]
		,[PaymentRefNo]
		,[BookedAt]
	    ,[StartTime]
	    ,[EndTime]
	    ,[ApprovedBy]
	    ,[ApprovedOn]
	    ,[GuestCount]
	    ,[Notes]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FacilityBooking]
	WHERE [FacilityId] = @FacilityId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FacilityBooking_ReadByFlatId]
(
    @FlatId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
	SELECT
		 [BookingId]
		,[FacilityId]
		,[FlatId]
		,[SocietyId]
		,[BookingDate]
		,[TimeSlot]
		,[Status]
		,[AmountPaid]
		,[PaymentRefNo]
		,[BookedAt]
		,[StartTime]
	    ,[EndTime]
	    ,[ApprovedBy]
	    ,[ApprovedOn]
	    ,[GuestCount]
	    ,[Notes]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FacilityBooking]
	WHERE [FlatId] = @FlatId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FacilityBooking_ReadById]
(
    @BookingId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
	SELECT
		 [BookingId]
		,[FacilityId]
		,[FlatId]
		,[SocietyId]
		,[BookingDate]
		,[TimeSlot]
		,[Status]
		,[AmountPaid]
		,[PaymentRefNo]
		,[BookedAt]
        ,[StartTime]
	    ,[EndTime]
	    ,[ApprovedBy]
	    ,[ApprovedOn]
	    ,[GuestCount]
	    ,[Notes]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FacilityBooking]
	WHERE [BookingId] = @BookingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[FacilityBooking_ReadBySocietyId]
(
    @SocietyId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
	SELECT
		 [BookingId]
		,[FacilityId]
		,[FlatId]
		,[SocietyId]
		,[BookingDate]
		,[TimeSlot]
		,[Status]
		,[AmountPaid]
		,[PaymentRefNo]
		,[BookedAt]
	    ,[StartTime]
	    ,[EndTime]
	    ,[ApprovedBy]
	    ,[ApprovedOn]
	    ,[GuestCount]
	    ,[Notes]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FacilityBooking]
	WHERE [SocietyId] = @SocietyId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FacilityBooking_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[FacilityBooking_Update]
(
    @BookingId      INT,
    @FacilityId     INT,
    @FlatId         INT,
	@SocietyId      INT,
    @BookingDate    DATETIME,
    @TimeSlot       VARCHAR(50),
    @Status         VARCHAR(50),
    @AmountPaid     DECIMAL(18, 2),
    @PaymentRefNo   VARCHAR(100),
    @BookedAt       DATETIME,
	@StartTime      DATETIME,
	@EndTime        DATETIME,
	@ApprovedBy     INT,
	@ApprovedOn     DATETIME,
	@GuestCount     INT,
	@Notes          VARCHAR(500) ,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[FacilityBooking]
    SET
        [FacilityId]    = @FacilityId,
        [FlatId]        = @FlatId,
		[SocietyId]     = @SocietyId,
        [BookingDate]   = @BookingDate,
        [TimeSlot]      = @TimeSlot,
        [Status]        = @Status,
        [AmountPaid]    = @AmountPaid,
        [PaymentRefNo]  = @PaymentRefNo,
        [BookedAt]      = @BookedAt,
		[StartTime]     = @StartTime,
		[EndTime]       = @EndTime,
		[ApprovedBy]    = @ApprovedBy,
		[ApprovedOn]    = @ApprovedOn,
		[GuestCount]    = @GuestCount,
		[Notes]         = @Notes,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [BookingId] = @BookingId;

    SELECT 
        [BookingId],
        [FacilityId],
        [FlatId],
		[SocietyId],
        [BookingDate],
        [TimeSlot],
        [Status],
        [AmountPaid],
        [PaymentRefNo],
        [BookedAt],
		[StartTime],
	    [EndTime],
	    [ApprovedBy],
	    [ApprovedOn],
	    [GuestCount],
	    [Notes],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FacilityBooking]
    WHERE [BookingId] = @BookingId;
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Flat_Create]
(
    @BuildingId         INT,
    @Wing               VARCHAR(10),
	@FlatTypeId         INT,
    @FlatNumber         VARCHAR(50),
    @Floor              INT,
    @Status             VARCHAR(50),
    @OccupantType       VARCHAR(20),
    @OwnerId            INT,
    @PossessionDate     DATETIME,
    @ParkingSlotNumber  VARCHAR(20),
    @IntercomNumber     VARCHAR(10),
    @MaintenanceStatus  VARCHAR(20),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FlatId INT;

    INSERT INTO [sm].[Flat]
    (
        [BuildingId],
        [Wing],
		[FlatTypeId],
        [FlatNumber],
        [Floor],
        [Status],
        [OccupantType],
        [OwnerId],
        [PossessionDate],
        [ParkingSlotNumber],
        [IntercomNumber],
        [MaintenanceStatus],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @BuildingId,
        @Wing,
		@FlatTypeId,
        @FlatNumber,
        @Floor,
        @Status,
        @OccupantType,
        @OwnerId,
        @PossessionDate,
        @ParkingSlotNumber,
        @IntercomNumber,
        @MaintenanceStatus,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @FlatId = SCOPE_IDENTITY();

    SELECT 
        [FlatId],
        [BuildingId],
        [Wing],
		[FlatTypeId],
        [FlatNumber],
        [Floor],
        [Status],
        [OccupantType],
        [OwnerId],
        [PossessionDate],
        [ParkingSlotNumber],
        [IntercomNumber],
        [MaintenanceStatus],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Flat]
    WHERE [FlatId] = @FlatId;
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [sm].[Flat_CreateBulk]
(
    @FlatIdList  [sm].[udt_Flat] READONLY,
	@ActionUser VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	INSERT INTO [sm].[Flat]
	(
		 [BuildingId]
		,[Wing]
		,[FlatTypeId]
		,[FlatNumber]
		,[Floor]
		,[Status]
		,[OccupantType]
		,[OwnerId]
		,[PossessionDate]
		,[ParkingSlotNumber]
		,[IntercomNumber]
		,[MaintenanceStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
	)
	SELECT
		 [BuildingId]
		,[Wing]
		,[FlatTypeId]
		,[FlatNumber]
		,[Floor]
		,[Status]
		,[OccupantType]
		,[OwnerId]
		,[PossessionDate]
		,[ParkingSlotNumber]
		,[IntercomNumber]
		,[MaintenanceStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,1
		,0
		,@ActionUser
		,GETDATE()
	FROM @FlatIdList;
	SELECT
		 [FlatId]
		,[BuildingId]
		,[Wing]
		,[FlatTypeId]
		,[FlatNumber]
		,[Floor]
		,[Status]
		,[OccupantType]
		,[OwnerId]
		,[PossessionDate]
		,[ParkingSlotNumber]
		,[IntercomNumber]
		,[MaintenanceStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Flat]
	WHERE IsActive = 1
	AND IsDeleted = 0
	AND CreatedBy = @ActionUser
	AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Flat_Delete]
(
  @FlatId INT,
  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE  [sm].[Flat]
	SET 
		[IsActive] =0 ,
		[IsDeleted] =1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE[FlatId] = @FlatId
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_GetFlatsCountBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Flat_GetFlatsCountBySocietyId]
(
    @SocietyId INT
)
AS
BEGIN
     SET NOCOUNT ON;

    SELECT
        COUNT(F.FlatId) AS TotalFlats,
        SUM(CASE WHEN F.Status = 'Occupied' THEN 1 ELSE 0 END) AS OccupiedFlats,
        COUNT(F.FlatId) - SUM(CASE WHEN F.Status = 'Occupied' THEN 1 ELSE 0 END) AS UnoccupiedFlats
    FROM sm.Building AS B
    LEFT JOIN sm.Flat AS F
        ON B.BuildingId = F.BuildingId
        AND F.IsActive = 1
        AND F.IsDeleted = 0
    WHERE B.SocietyId = @SocietyId
        AND B.IsActive = 1
        AND B.IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Flat_ReadAll]
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [FlatId]
		,[BuildingId]
		,[Wing]
		,[FlatTypeId]
		,[FlatNumber]
		,[Floor]
		,[Status]
		,[OccupantType]
		,[OwnerId]
		,[PossessionDate]
		,[ParkingSlotNumber]
		,[IntercomNumber]
		,[MaintenanceStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Flat]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [sm].[Flat_ReadAllPaginated] 
    @PageSize = 100,
    @PageNo = 1,
    @OrderByClause = '',
    @WhereClause = '';
*/
CREATE   PROCEDURE [sm].[Flat_ReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL

)
AS
 BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL =

	'SELECT
	ROW_NUMBER() OVER (ORDER BY ' + 
	ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
	') AS RowNum,
       [FlatId],
       [BuildingId],
       [Wing],
       [FlatNumber],
       [Floor],
       [Status],
       [OccupantType],
       [OwnerId],
       [PossessionDate],
       [ParkingSlotNumber],
       [IntercomNumber],
       [MaintenanceStatus],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn],
       [FlatTypeId],
	COUNT(*) OVER () AS TotalCount,
	' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
	' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [Nishwik].[sm].[Flat]
	WHERE [IsActive] = 1 ';


	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
	END;
GO
/****** Object:  StoredProcedure [sm].[Flat_ReadByBuildingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Flat_ReadByBuildingId]
(
  @BuildingId INT
)
AS
BEGIN 
  SET NOCOUNT ON;

  SELECT 
       A.[FlatId]
      ,A.[BuildingId]
      ,A.[Wing]
      ,A.[FlatTypeId]
      ,A.[FlatNumber]
      ,A.[Floor]
      ,A.[Status]
      ,A.[OccupantType]
      ,A.[OwnerId]
      ,A.[PossessionDate]
      ,A.[ParkingSlotNumber]
      ,A.[IntercomNumber]
      ,A.[MaintenanceStatus]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
      ,B.[FMId]
      ,B.[FlatId] 
      ,B.[BillingMonth]
      ,B.[TotalMaintenance]
      ,B.[DueDate]
      ,B.[PaidAmount]
      ,B.[PaymentDate]
      ,B.[PaymentStatus]
      ,B.[Remarks]
  FROM [sm].[Flat] A
  LEFT OUTER JOIN [sm].[FlatMaintenance] B
    ON A.[FlatId] = B.[FlatId]
  WHERE A.[BuildingId] = @BuildingId
    AND A.[IsActive] = 1
    AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_ReadByFlatTypeId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Flat_ReadByFlatTypeId]
(
  @FlatTypeId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT 
		   [FlatId]
		  ,[BuildingId]
		  ,[Wing]
		  ,[FlatTypeId]
		  ,[FlatNumber]
		  ,[Floor]
		  ,[Status]
		  ,[OccupantType]
		  ,[OwnerId]
		  ,[PossessionDate]
		  ,[ParkingSlotNumber]
		  ,[IntercomNumber]
		  ,[MaintenanceStatus]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[Flat]
	  WHERE[FlatTypeId] = @FlatTypeId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Flat_ReadById]
(
    @FlatId INT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [FlatId]
		,[BuildingId]
		,[Wing]
		,[FlatTypeId]
		,[FlatNumber]
		,[Floor]
		,[Status]
		,[OccupantType]
		,[OwnerId]
		,[PossessionDate]
		,[ParkingSlotNumber]
		,[IntercomNumber]
		,[MaintenanceStatus]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Flat]
	WHERE [FlatId] = @FlatId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_ReadByOwnerId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Flat_ReadByOwnerId]
(
  @OwnerId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT 
		   [FlatId]
		  ,[BuildingId]
		  ,[Wing]
		  ,[FlatTypeId]
		  ,[FlatNumber]
		  ,[Floor]
		  ,[Status]
		  ,[OccupantType]
		  ,[OwnerId]
		  ,[PossessionDate]
		  ,[ParkingSlotNumber]
		  ,[IntercomNumber]
		  ,[MaintenanceStatus]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[Flat]
	  WHERE[OwnerId] = @OwnerId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Flat_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Flat_Update]
(
    @FlatId             INT,
    @BuildingId         INT,
    @Wing               VARCHAR(10),
	@FlatTypeId          INT,
    @FlatNumber         VARCHAR(50),
    @Floor              INT,
    @Status             VARCHAR(50),
    @OccupantType       VARCHAR(20),
    @OwnerId            INT,
    @PossessionDate     DATETIME,
    @ParkingSlotNumber  VARCHAR(20),
    @IntercomNumber     VARCHAR(10),
    @MaintenanceStatus  VARCHAR(20),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @IsActive           INT,
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[Flat]
    SET
        [BuildingId]         = @BuildingId,
        [Wing]               = @Wing,
		[FlatTypeId]         = @FlatTypeId,
        [FlatNumber]         = @FlatNumber,
        [Floor]              = @Floor,
        [Status]             = @Status,
        [OccupantType]       = @OccupantType,
        [OwnerId]            = @OwnerId,
        [PossessionDate]     = @PossessionDate,
        [ParkingSlotNumber]  = @ParkingSlotNumber,
        [IntercomNumber]     = @IntercomNumber,
        [MaintenanceStatus]  = @MaintenanceStatus,
        [OtherDetail1]       = @OtherDetail1,
        [OtherDetail2]       = @OtherDetail2,
        [OtherDetail3]       = @OtherDetail3,
        [OtherDetail4]       = @OtherDetail4,
        [OtherDetail5]       = @OtherDetail5,
        [OtherDetail6]       = @OtherDetail6,
        [IsActive]           = @IsActive,
        [ModifiedBy]         = @ActionUser,
        [ModifiedOn]         = GETDATE()
    WHERE
        [FlatId] = @FlatId;

    SELECT 
        [FlatId],
        [BuildingId],
        [Wing],
		[FlatTypeId],
        [FlatNumber],
        [Floor],
        [Status],
        [OccupantType],
        [OwnerId],
        [PossessionDate],
        [ParkingSlotNumber],
        [IntercomNumber],
        [MaintenanceStatus],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Flat]
    WHERE [FlatId] = @FlatId AND [IsActive] = 1
	AND  [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatFacility_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatFacility_Create]
(
    @FlatId         BIGINT,
    @DetailId       BIGINT,
    @Remarks        VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FacilityId BIGINT;

    -- Check if same FlatId + DetailId exists but marked as deleted
    SELECT TOP 1 @FacilityId = [FacilityId]
    FROM [sm].[FlatFacility]
    WHERE [FlatId] = @FlatId
      AND [DetailId] = @DetailId
	  AND [IsActive] = 0
      AND [IsDeleted] = 1;

    IF @FacilityId IS NOT NULL
    BEGIN
        -- Reactivate existing record
        UPDATE [sm].[FlatFacility]
        SET [IsDeleted] = 0,
            [IsActive] = 1,
            [Remarks] = @Remarks,
            [OtherDetail1] = @OtherDetail1,
            [OtherDetail2] = @OtherDetail2,
            [OtherDetail3] = @OtherDetail3,
            [OtherDetail4] = @OtherDetail4,
            [OtherDetail5] = @OtherDetail5,
            [OtherDetail6] = @OtherDetail6,
            [ModifiedBy] = @ActionUser,
            [ModifiedOn] = GETDATE()
        WHERE [FacilityId] = @FacilityId;
    END
    ELSE
    BEGIN
        -- Insert new record
        INSERT INTO [sm].[FlatFacility]
        (
            [FlatId],
            [DetailId],
            [Remarks],
            [OtherDetail1],
            [OtherDetail2],
            [OtherDetail3],
            [OtherDetail4],
            [OtherDetail5],
            [OtherDetail6],
            [IsActive],
            [IsDeleted],
            [CreatedBy],
            [CreatedOn]
        )
        VALUES
        (
            @FlatId,
            @DetailId,
            @Remarks,
            @OtherDetail1,
            @OtherDetail2,
            @OtherDetail3,
            @OtherDetail4,
            @OtherDetail5,
            @OtherDetail6,
            1,
            0,
            @ActionUser,
            GETDATE()
        );

        SET @FacilityId = SCOPE_IDENTITY();
    END;

    -- Return the record
    SELECT 
        [FacilityId],
        [FlatId],
        [DetailId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatFacility]
    WHERE [FacilityId] = @FacilityId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatFacility_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[FlatFacility_Delete]
(
   @FacilityId BIGINT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[FlatFacility]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [FacilityId] = @FacilityId
END;
GO
/****** Object:  StoredProcedure [sm].[FlatFacility_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[FlatFacility_ReadAll]
AS
BEGIN 
    SET NOCOUNT ON;
	 SELECT 
		   [FacilityId]
		  ,[FlatId]
		  ,[DetailId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[FlatFacility]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatFacility_ReadByDetailId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[FlatFacility_ReadByDetailId]
(
   @DetailId BIGINT
)
AS
BEGIN 
    SET NOCOUNT ON;
	 SELECT 
		   [FacilityId]
		  ,[FlatId]
		  ,[DetailId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[FlatFacility]
	  WHERE [DetailId] = @DetailId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatFacility_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[FlatFacility_ReadByFlatId]
(
   @FlatId BIGINT
)
AS
BEGIN 
    SET NOCOUNT ON;
	 SELECT 
		   [FacilityId]
		  ,[FlatId]
		  ,[DetailId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[FlatFacility]
	  WHERE [FlatId] = @FlatId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatFacility_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[FlatFacility_ReadById]
(
   @FacilityId BIGINT
)
AS
BEGIN 
    SET NOCOUNT ON;
	 SELECT 
		   [FacilityId]
		  ,[FlatId]
		  ,[DetailId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[FlatFacility]
	  WHERE [FacilityId] = @FacilityId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatFacility_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[FlatFacility_Update]
(
    @FacilityId     BIGINT,
    @FlatId         BIGINT,
    @DetailId       BIGINT,
    @Remarks        VARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	UPDATE [sm].[FlatFacility]
	SET
		[FlatId]        = @FlatId,
		[DetailId]      = @DetailId,
		[Remarks]       = @Remarks,
		[OtherDetail1]  = @OtherDetail1,
		[OtherDetail2]  = @OtherDetail2,
		[OtherDetail3]  = @OtherDetail3,
		[OtherDetail4]  = @OtherDetail4,
		[OtherDetail5]  = @OtherDetail5,
		[OtherDetail6]  = @OtherDetail6,
		[IsActive]      = @IsActive,
		[ModifiedBy]    = @ActionUser,
		[ModifiedOn]    = GETDATE()
	WHERE [FacilityId] = @FacilityId;

	SELECT 
		[FacilityId],
		[FlatId],
		[DetailId],
		[Remarks],
		[OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
		[OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
		[IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn],
		[ModifiedBy],
		[ModifiedOn]
	FROM [sm].[FlatFacility]
	WHERE [FacilityId] = @FacilityId
	AND [IsDeleted] = 0
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenance_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenance_Create]
(
    @FlatId INT,
	@FlatTypeId INT,
	@SocietyId INT,
	@TotalMaintenance DECIMAL(18, 2),
	@BillingMonth  VARCHAR (50) ,
	@DueDate       DATETIME ,
	@PaidAmount     DECIMAL(18,2) ,
	@PaymentDate    DATETIME ,
	@PaymentStatus VARCHAR(50) ,
	@Remarks       VARCHAR (50),
    @OtherDetail1  VARCHAR(50),
    @OtherDetail2  VARCHAR(50),
    @OtherDetail3  VARCHAR(100),
    @OtherDetail4  VARCHAR(100),
    @OtherDetail5  VARCHAR(500),
    @OtherDetail6  VARCHAR(500),
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FMId INT;

    INSERT INTO [sm].[FlatMaintenance]
    (
        [FlatId],
        [FlatTypeId],
        [SocietyId],
        [TotalMaintenance],
	    [BillingMonth] , 
		[DueDate]     ,  
		[PaidAmount]  ,  
		[PaymentDate]  , 
		[PaymentStatus] ,
		[Remarks]   ,    
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @FlatId,
        @FlatTypeId,
        @SocietyId,
        @TotalMaintenance,
		@BillingMonth ,
		@DueDate      ,
		@PaidAmount   ,
		@PaymentDate  ,
		@PaymentStatus,
		@Remarks    ,  
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,
        GETDATE()
    );

    SET @FMId = SCOPE_IDENTITY();

    SELECT
        [FMId],
        [FlatId],
        [FlatTypeId],
        [SocietyId],
        [TotalMaintenance],
	    [BillingMonth] ,
	    [DueDate],
	    [PaidAmount],
	    [PaymentDate],
	    [PaymentStatus],
	    [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatMaintenance]
    WHERE [FMId] = @FMId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenance_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenance_Delete]
(
    @FMId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[sm].[FlatMaintenance]
	SET
		  [IsActive] = 0,  
		  [IsDeleted] = 1, 
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [FMId] = @FMId
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenance_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenance_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
	   [FMId]
      ,[FlatId]
      ,[FlatTypeId]
      ,[SocietyId]
      ,[TotalMaintenance]
	  ,[BillingMonth] 
	  ,[DueDate]
	  ,[PaidAmount]
	  ,[PaymentDate]
	  ,[PaymentStatus]
	  ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[FlatMaintenance]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenance_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenance_ReadByFlatId]
(
    @FlatId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [FMId]
        ,[FlatId]
        ,[FlatTypeId]
        ,[SocietyId]
        ,[TotalMaintenance]
		,[BillingMonth] 
	    ,[DueDate]
	    ,[PaidAmount]
	    ,[PaymentDate]
	    ,[PaymentStatus]
	    ,[Remarks]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
	FROM [sm].[FlatMaintenance]
	WHERE [FlatId] = @FlatId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenance_ReadByFlatTypeId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenance_ReadByFlatTypeId]
(
    @FlatTypeId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [FMId]
        ,[FlatId]
        ,[FlatTypeId]
        ,[SocietyId]
        ,[TotalMaintenance]
		,[BillingMonth] 
	    ,[DueDate]
	    ,[PaidAmount]
	    ,[PaymentDate]
	    ,[PaymentStatus]
	    ,[Remarks]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
	FROM [sm].[FlatMaintenance]
	WHERE [FlatTypeId] = @FlatTypeId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenance_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenance_ReadById]
(
    @FMId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
	   [FMId]
      ,[FlatId]
      ,[FlatTypeId]
      ,[SocietyId]
      ,[TotalMaintenance]
	  ,[BillingMonth] 
	  ,[DueDate]
	  ,[PaidAmount]
	  ,[PaymentDate]
	  ,[PaymentStatus]
	  ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[FlatMaintenance]
	WHERE [FMId] = @FMId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenance_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenance_ReadBySocietyId]
(
    @SocietyId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [FMId]
        ,[FlatId]
        ,[FlatTypeId]
        ,[SocietyId]
        ,[TotalMaintenance]
	    ,[BillingMonth] 
	    ,[DueDate]
	    ,[PaidAmount]
	    ,[PaymentDate]
	    ,[PaymentStatus]
	    ,[Remarks]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
	FROM [sm].[FlatMaintenance]
	WHERE [SocietyId] = @SocietyId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenance_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenance_Update]
(
    @FMId INT,
	@FlatId INT,
	@FlatTypeId INT,
	@SocietyId INT,
	@TotalMaintenance DECIMAL(18, 2), 
	@BillingMonth  VARCHAR (50) ,
	@DueDate       DATETIME ,
	@PaidAmount     DECIMAL(18,2) ,
	@PaymentDate    DATETIME ,
	@PaymentStatus VARCHAR(50) ,
	@Remarks       VARCHAR (50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[FlatMaintenance]
    SET
        [FlatId] = @FlatId,
        [FlatTypeId] = @FlatTypeId,
        [SocietyId] = @SocietyId,
        [TotalMaintenance] = @TotalMaintenance,
		[BillingMonth] = @BillingMonth,
		[DueDate] =   @DueDate,
		[PaidAmount] = @PaidAmount,
		[PaymentDate] = @PaymentDate,
		[PaymentStatus] = @PaymentStatus,
		[Remarks] = @Remarks,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [FMId] = @FMId;

    SELECT
        [FMId],
        [FlatId],
        [FlatTypeId],
        [SocietyId],
        [TotalMaintenance],
		[BillingMonth] ,
	    [DueDate],
	    [PaidAmount],
	    [PaymentDate],
	    [PaymentStatus],
	    [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatMaintenance]
    WHERE [FMId] = @FMId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenanceDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenanceDetail_Create]
(
    @FMId INT,
	@ChargeId INT,
	@ChargeName VARCHAR(50),
	@ChargeDescription VARCHAR(50), 
	@ChargeAmt DECIMAL(18,2),
    @OtherDetail1  VARCHAR(50),
    @OtherDetail2  VARCHAR(50),
    @OtherDetail3  VARCHAR(100),
    @OtherDetail4  VARCHAR(100),
    @OtherDetail5  VARCHAR(500),
    @OtherDetail6  VARCHAR(500),
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [sm].[FlatMaintenanceDetail]
    (
        [FMId],
        [ChargeId],
        [ChargeName],
        [ChargeDescription],
		[ChargeAmt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @FMId,
        @ChargeId,
        @ChargeName,
        @ChargeDescription,
		@ChargeAmt,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
        [DetailId],
        [FMId],
        [ChargeId],
        [ChargeName],
        [ChargeDescription],
		[ChargeAmt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatMaintenanceDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenanceDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenanceDetail_Delete]
(
    @DetailId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[sm].[FlatMaintenanceDetail]
	SET
		  [IsActive] = 0,  
		  [IsDeleted] = 1, 
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenanceDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenanceDetail_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
	   [DetailId]
      ,[FMId]
      ,[ChargeId]
      ,[ChargeName]
      ,[ChargeDescription]
	  ,[ChargeAmt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[FlatMaintenanceDetail]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenanceDetail_ReadByChargeId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenanceDetail_ReadByChargeId]
(
    @ChargeId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
        ,[FMId]
        ,[ChargeId]
        ,[ChargeName]
        ,[ChargeDescription]
		,[ChargeAmt]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
	FROM [sm].[FlatMaintenanceDetail]
	WHERE [ChargeId] = @ChargeId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenanceDetail_ReadByFMId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenanceDetail_ReadByFMId]
(
    @FMId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
        ,[FMId]
        ,[ChargeId]
        ,[ChargeName]
        ,[ChargeDescription]
		,[ChargeAmt]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
	FROM [sm].[FlatMaintenanceDetail]
	WHERE [FMId] = @FMId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenanceDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenanceDetail_ReadById]
(
    @DetailId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
        ,[FMId]
        ,[ChargeId]
        ,[ChargeName]
        ,[ChargeDescription]
  		,[ChargeAmt]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
	FROM [sm].[FlatMaintenanceDetail]
	WHERE [DetailId] = @DetailId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMaintenanceDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[FlatMaintenanceDetail_Update]
(
    @DetailId INT,
	@FMId INT,
	@ChargeId INT,
	@ChargeName VARCHAR(50),
	@ChargeDescription VARCHAR(50), 
	@ChargeAmt  DECIMAL(18,2),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[FlatMaintenanceDetail]
    SET
        [FMId] = @FMId,
        [ChargeId] = @ChargeId,
        [ChargeName] = @ChargeName,
        [ChargeDescription] = @ChargeDescription,
		[ChargeAmt]  = @ChargeAmt,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT
        [DetailId],
        [FMId],
        [ChargeId],
        [ChargeName],
        [ChargeDescription],
		[ChargeAmt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatMaintenanceDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMember_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[FlatMember_Create]
(
    @FlatId            INT,
    @UserId            INT,
    @FullName          VARCHAR(150),
    @MobileNumber      VARCHAR(15),
    @Email             VARCHAR(100),
    @Role              VARCHAR(50),
    @IsPrimaryOwner    INT,
    @MoveInDate        DATETIME,
    @MoveOutDate       DATETIME,
    @KYCStatus         VARCHAR(50),
    @Status            VARCHAR(50),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MemberId INT;

    INSERT INTO [sm].[FlatMember]
    (
        [FlatId],
        [UserId],
        [FullName],
        [MobileNumber],
        [Email],
        [Role],
        [IsPrimaryOwner],
        [MoveInDate],
        [MoveOutDate],
        [KYCStatus],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @FlatId,
        @UserId,
        @FullName,
        @MobileNumber,
        @Email,
        @Role,
        @IsPrimaryOwner,
        @MoveInDate,
        @MoveOutDate,
        @KYCStatus,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              -- IsActive
        0,              -- IsDeleted
        @ActionUser,    
        GETDATE()
    );

    SET @MemberId = SCOPE_IDENTITY();

    SELECT 
        [MemberId],
        [FlatId],
        [UserId],
        [FullName],
        [MobileNumber],
        [Email],
        [Role],
        [IsPrimaryOwner],
        [MoveInDate],
        [MoveOutDate],
        [KYCStatus],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatMember]
    WHERE [MemberId] = @MemberId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMember_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMember_Delete]
(
    @MemberId int,
	@ActionUser varchar(50)
)
AS
	BEGIN 

	SET NOCOUNT ON;
	UPDATE [sm].[FlatMember]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MemberId] = @MemberId
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMember_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMember_ReadAll]
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT
       [MemberId]
      ,[FlatId]
      ,[UserId]
      ,[FullName]
      ,[MobileNumber]
      ,[Email]
      ,[Role]
      ,[IsPrimaryOwner]
      ,[MoveInDate]
      ,[MoveOutDate]
      ,[KYCStatus]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[FlatMember]
	  WHERE [IsActive] =  1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMember_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMember_ReadByFlatId]
(
     @FlatId int
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT
       [MemberId]
      ,[FlatId]
      ,[UserId]
      ,[FullName]
      ,[MobileNumber]
      ,[Email]
      ,[Role]
      ,[IsPrimaryOwner]
      ,[MoveInDate]
      ,[MoveOutDate]
      ,[KYCStatus]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[sm].[FlatMember]
	  WHERE [FlatId] = @FlatId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMember_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMember_ReadById]
(
     @MemberId int
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT
       [MemberId]
      ,[FlatId]
      ,[UserId]
      ,[FullName]
      ,[MobileNumber]
      ,[Email]
      ,[Role]
      ,[IsPrimaryOwner]
      ,[MoveInDate]
      ,[MoveOutDate]
      ,[KYCStatus]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[sm].[FlatMember]
	  WHERE [MemberId] = @MemberId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMember_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMember_ReadByUserId]
(
     @UserId int
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT
       [MemberId]
      ,[FlatId]
      ,[UserId]
      ,[FullName]
      ,[MobileNumber]
      ,[Email]
      ,[Role]
      ,[IsPrimaryOwner]
      ,[MoveInDate]
      ,[MoveOutDate]
      ,[KYCStatus]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[sm].[FlatMember]
	  WHERE [UserId] = @UserId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMember_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[FlatMember_Update]
(
    @MemberId          INT,
    @FlatId            INT,
    @UserId            INT,
    @FullName          VARCHAR(150),
    @MobileNumber      VARCHAR(15),
    @Email             VARCHAR(100),
    @Role              VARCHAR(50),
    @IsPrimaryOwner    INT,
    @MoveInDate        DATETIME,
    @MoveOutDate       DATETIME,
    @KYCStatus         VARCHAR(50),
    @Status            VARCHAR(50),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[FlatMember]
    SET
        [FlatId]         = @FlatId,
        [UserId]         = @UserId,
        [FullName]       = @FullName,
        [MobileNumber]   = @MobileNumber,
        [Email]          = @Email,
        [Role]           = @Role,
        [IsPrimaryOwner] = @IsPrimaryOwner,
        [MoveInDate]     = @MoveInDate,
        [MoveOutDate]    = @MoveOutDate,
        [KYCStatus]      = @KYCStatus,
        [Status]         = @Status,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE
        [MemberId] = @MemberId;

    SELECT 
        [MemberId],
        [FlatId],
        [UserId],
        [FullName],
        [MobileNumber],
        [Email],
        [Role],
        [IsPrimaryOwner],
        [MoveInDate],
        [MoveOutDate],
        [KYCStatus],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatMember]
    WHERE [MemberId] = @MemberId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMemberDetailsByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
	EXEC [sm].[FlatMemberDetailsByUserId] 14,36,14
*/
CREATE   PROCEDURE [sm].[FlatMemberDetailsByUserId]
(
	@SocietyId INT ,
	@FlatId INT ,
	@UserId INT 
)
AS
BEGIN
    SET NOCOUNT ON;

		SELECT SocietyId,SocietyName,Address,City,ZipCode,ContactEmail,ContactPhone,State
			FROM 
		[sm].[Society] 
			WHERE SocietyId = @SocietyId 
			AND IsDeleted = 0 
			AND IsActive = 1;

		SELECT F.FlatId,F.BuildingId,B.BuildingName,F.Wing,F.FlatNumber,F.Floor,F.Status,F.OccupantType,F.OwnerId,F.PossessionDate,F.ParkingSlotNumber,F.MaintenanceStatus
		FROM [sm].[Flat] F WITH (NOLOCK)
		LEFT JOIN  [sm].[Building] B WITH (NOLOCK)
		ON F.BuildingId = B.BuildingId
		WHERE 
			F.FlatId = @FlatId AND
			F.IsDeleted = 0 AND
			F.IsActive = 1

		SELECT UserId,FirstName,LastName,DOB,MobileNo,EmailId,Designation,ISNULL(ProfileImage,'') ProfileImage
		FROM [dbo].[UserMaster] 
		WHERE 
			UserId = @UserId
			AND IsDeleted = 0 
			AND IsActive = 1;


END;
GO
/****** Object:  StoredProcedure [sm].[FlatMemberKYC_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[FlatMemberKYC_Create]
(
    @MemberId        INT,
    @DocumentType    VARCHAR(50),
    @DocumentNumber  VARCHAR(50),
    @FilePath        VARCHAR(255),
    @Verified        INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @KYCId INT;

    INSERT INTO [sm].[FlatMemberKYC]
    (
        [MemberId],
        [DocumentType],
        [DocumentNumber],
        [FilePath],
        [Verified],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MemberId,
        @DocumentType,
        @DocumentNumber,
        @FilePath,
        @Verified,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @KYCId = SCOPE_IDENTITY();

    SELECT
        [KYCId],
        [MemberId],
        [DocumentType],
        [DocumentNumber],
        [FilePath],
        [Verified],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatKYC]
    WHERE [KYCId] = @KYCId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMemberKYC_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMemberKYC_Delete]
(
    @KYCId int,
	@ActionUser varchar(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE[sm].[FlatKYC]
	SET
		   [IsActive] = 0,
		   [IsDeleted] = 1,
		   [ModifiedBy] = @ActionUser,
		   [ModifiedOn] = GETDATE()
	WHERE [KYCId] = @KYCId 
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMemberKYC_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMemberKYC_ReadAll]
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT
		 [KYCId]
		,[MemberId]
		,[DocumentType]
		,[DocumentNumber]
		,[FilePath]
		,[Verified]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FlatKYC]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMemberKYC_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMemberKYC_ReadById]
(
    @KYCId int
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT
		 [KYCId]
		,[MemberId]
		,[DocumentType]
		,[DocumentNumber]
		,[FilePath]
		,[Verified]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FlatKYC]
	WHERE [KYCId] = @KYCId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMemberKYC_ReadByMemberId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatMemberKYC_ReadByMemberId]
(
    @MemberId int
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT
		 [KYCId]
		,[MemberId]
		,[DocumentType]
		,[DocumentNumber]
		,[FilePath]
		,[Verified]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FlatKYC]
	WHERE [MemberId] = @MemberId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatMemberKYC_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[FlatMemberKYC_Update]
(
    @KYCId           INT,
    @MemberId        INT,
    @DocumentType    VARCHAR(50),
    @DocumentNumber  VARCHAR(50),
    @FilePath        VARCHAR(255),
    @Verified        INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @IsActive        INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[FlatMemberKYC]
    SET
        [MemberId]        = @MemberId,
        [DocumentType]    = @DocumentType,
        [DocumentNumber]  = @DocumentNumber,
        [FilePath]        = @FilePath,
        [Verified]        = @Verified,
        [OtherDetail1]    = @OtherDetail1,
        [OtherDetail2]    = @OtherDetail2,
        [OtherDetail3]    = @OtherDetail3,
        [OtherDetail4]    = @OtherDetail4,
        [OtherDetail5]    = @OtherDetail5,
        [OtherDetail6]    = @OtherDetail6,
        [IsActive]        = @IsActive,
        [ModifiedBy]      = @ActionUser,
        [ModifiedOn]      = GETDATE()
    WHERE
        [KYCId] = @KYCId ;

    SELECT
        [KYCId],
        [MemberId],
        [DocumentType],
        [DocumentNumber],
        [FilePath],
        [Verified],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatKYC]
    WHERE [KYCId] = @KYCId AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatType_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[FlatType_Create]
(
    @SocietyId        INT,
    @TypeName         VARCHAR(100),
    @TypeDescription  VARCHAR(500),
    @BHK              INT,
    @Status           VARCHAR(50),
    @SuperArea        DECIMAL(10, 2),
    @CarpetArea       DECIMAL(10, 2),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FlatTypeId INT;

    INSERT INTO [sm].[FlatType]
    (
         [SocietyId],
         [TypeName],
         [TypeDescription],
         [BHK],
         [Status],
         [SuperArea],
         [CarpetArea],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn]
    )
    VALUES
    (
         @SocietyId,
         @TypeName,
         @TypeDescription,
         @BHK,
         @Status,
         @SuperArea,
         @CarpetArea,
         @OtherDetail1,
         @OtherDetail2,
         @OtherDetail3,
         @OtherDetail4,
         @OtherDetail5,
         @OtherDetail6,
         1,            
         0,            
         @ActionUser,  
         GETDATE()     
    );

    SET @FlatTypeId = SCOPE_IDENTITY();

    SELECT 
         [FlatTypeId],
         [SocietyId],
         [TypeName],
         [TypeDescription],
         [BHK],
         [Status],
         [SuperArea],
         [CarpetArea],
         [OtherDetail1],
         [OtherDetail2],
         [OtherDetail3],
         [OtherDetail4],
         [OtherDetail5],
         [OtherDetail6],
         [IsActive],
         [IsDeleted],
         [CreatedBy],
         [CreatedOn],
         [ModifiedBy],
         [ModifiedOn]
    FROM [sm].[FlatType]
    WHERE [FlatTypeId] = @FlatTypeId;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatType_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatType_Delete]
(
    @FlatTypeId INT,
	@ActionUser VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	Update [sm].[FlatType]
	SET
		[IsActive] =    0 ,
		[IsDeleted] =   1,
		[ModifiedBy] =  @ActionUser,
		[ModifiedOn] =  GETDATE()
	WHERE [FlatTypeId] =@FlatTypeId
END;
GO
/****** Object:  StoredProcedure [sm].[FlatType_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatType_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [FlatTypeId]
		,[SocietyId]
		,[TypeName]
		,[TypeDescription]
		,[BHK]
		,[Status]
		,[SuperArea]
		,[CarpetArea]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FlatType]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatType_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[FlatType_ReadById]
(
    @FlatTypeId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [FlatTypeId]
		,[SocietyId]
		,[TypeName]
		,[TypeDescription]
		,[BHK]
		,[Status]
		,[SuperArea]
		,[CarpetArea]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FlatType]
	WHERE  [FlatTypeId] =@FlatTypeId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatType_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[FlatType_ReadBySocietyId]
(
    @SocietyId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [FlatTypeId]
		,[SocietyId]
		,[TypeName]
		,[TypeDescription]
		,[BHK]
		,[Status]
		,[SuperArea]
		,[CarpetArea]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[FlatType]
	WHERE  [SocietyId] =@SocietyId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[FlatType_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[FlatType_Update]
(
    @FlatTypeId        INT,
    @SocietyId         INT,
    @TypeName          VARCHAR(100),
    @TypeDescription   VARCHAR(500),
    @BHK               INT,
    @Status            VARCHAR(50),
    @SuperArea         DECIMAL(10, 2),
    @CarpetArea        DECIMAL(10, 2),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[FlatType]
    SET
        [SocietyId]       = @SocietyId,
        [TypeName]        = @TypeName,
        [TypeDescription] = @TypeDescription,
        [BHK]             = @BHK,
        [Status]          = @Status,
        [SuperArea]     =  @SuperArea,
        [CarpetArea]      = @CarpetArea,
        [OtherDetail1]    = @OtherDetail1,
        [OtherDetail2]    = @OtherDetail2,
        [OtherDetail3]    = @OtherDetail3,
        [OtherDetail4]    = @OtherDetail4,
        [OtherDetail5]    = @OtherDetail5,
        [OtherDetail6]    = @OtherDetail6,
        [IsActive]        = @IsActive,
        [ModifiedBy]      = @ActionUser,
        [ModifiedOn]      = GETDATE()
    WHERE 
        [FlatTypeId] = @FlatTypeId ;

    SELECT 
        [FlatTypeId],
        [SocietyId],
        [TypeName],
        [TypeDescription],
        [BHK],
        [Status],
        [SuperArea],
        [CarpetArea],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[FlatType]
    WHERE [FlatTypeId] = @FlatTypeId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeDetail_Create]
(
    @ChargeId           INT,
    @ChargeName         VARCHAR(50),
    @ChargeDescription  VARCHAR(50),
    @ChargeAmt          DECIMAL(10, 2),
	@ChargeType         VARCHAR(100),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [sm].[MaintenanceChargeDetail]
    (
         [ChargeId]
        ,[ChargeName]
        ,[ChargeDescription]
        ,[ChargeAmt]
		,[ChargeType]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @ChargeId
        ,@ChargeName
        ,@ChargeDescription
        ,@ChargeAmt
		,@ChargeType
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1                  
        ,0                  
        ,@ActionUser
        ,GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT 
         [DetailId]
        ,[ChargeId]
        ,[ChargeName]
        ,[ChargeDescription]
        ,[ChargeAmt]
		,[ChargeType]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [sm].[MaintenanceChargeDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeDetail_Delete]
(
   @DetailId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[sm].[MaintenanceChargeDetail]
	SET 
		[IsActive]   = 0,
		[IsDeleted]  = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeDetail_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
		,[ChargeId]
		,[ChargeName]
		,[ChargeDescription]
		,[ChargeAmt]
		,[ChargeType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[sm].[MaintenanceChargeDetail]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeDetail_ReadByChargeId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeDetail_ReadByChargeId]
(
   @ChargeId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
		,[ChargeId]
		,[ChargeName]
		,[ChargeDescription]
		,[ChargeAmt]
		,[ChargeType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[sm].[MaintenanceChargeDetail]
	WHERE [ChargeId] = @ChargeId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeDetail_ReadById]
(
   @DetailId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
		,[ChargeId]
		,[ChargeName]
		,[ChargeDescription]
		,[ChargeAmt]
		,[ChargeType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[sm].[MaintenanceChargeDetail]
	WHERE [DetailId] = @DetailId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[MaintenanceChargeDetail_Update]
(
    @DetailId           INT,
    @ChargeId           INT,
    @ChargeName         VARCHAR(50),
    @ChargeDescription  VARCHAR(50),
    @ChargeAmt          DECIMAL(10, 2),
	@ChargeType         VARCHAR(100),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @IsActive           INT,
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[MaintenanceChargeDetail]
    SET
        [ChargeId]         = @ChargeId,
        [ChargeName]       = @ChargeName,
        [ChargeDescription]= @ChargeDescription,
        [ChargeAmt]        = @ChargeAmt,
		[ChargeType]       = @ChargeType,
        [OtherDetail1]     = @OtherDetail1,
        [OtherDetail2]     = @OtherDetail2,
        [OtherDetail3]     = @OtherDetail3,
        [OtherDetail4]     = @OtherDetail4,
        [OtherDetail5]     = @OtherDetail5,
        [OtherDetail6]     = @OtherDetail6,
        [IsActive]         = @IsActive,
        [ModifiedBy]       = @ActionUser,
        [ModifiedOn]       = GETDATE()
    WHERE 
        [DetailId] = @DetailId ;

    SELECT 
        [DetailId],
        [ChargeId],
        [ChargeName],
        [ChargeDescription],
        [ChargeAmt],
		[ChargeType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[MaintenanceChargeDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_CloneMaintenanceCharge]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[MaintenanceChargeMaster_CloneMaintenanceCharge]
(
    @SourceFlatTypeId INT,
    @TargetFlatTypeId INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SourceChargeId INT;
    DECLARE @TargetChargeId INT;

    -- 1. Get Source ChargeId
    SELECT TOP 1 @SourceChargeId = ChargeId
    FROM [sm].[MaintenanceChargeMaster]
    WHERE FlatTypeId = @SourceFlatTypeId
      AND IsActive = 1
      AND IsDeleted = 0
    ORDER BY CreatedOn DESC;

    IF @SourceChargeId IS NULL
    BEGIN
        RAISERROR('No active MaintenanceChargeMaster found for Source FlatTypeId', 16, 1);
        RETURN;
    END

    -- 2. Insert into Master for Target FlatTypeId
    INSERT INTO [sm].[MaintenanceChargeMaster]
    (
        FlatTypeId,
        SocietyId,
        MaintenanceCharges,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted,
        CreatedBy, CreatedOn
    )
    SELECT
        @TargetFlatTypeId,
        SocietyId,
        MaintenanceCharges,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        1, 0,
        ISNULL(@ActionUser, CreatedBy), GETDATE()
    FROM [sm].[MaintenanceChargeMaster]
    WHERE ChargeId = @SourceChargeId;

    -- Get the new ChargeId
    SET @TargetChargeId = SCOPE_IDENTITY();

    -- 3. Clone Details for the new ChargeId
    INSERT INTO [sm].[MaintenanceChargeDetail]
    (
        ChargeId,
        ChargeName,
        ChargeDescription,
        ChargeAmt,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted,
        CreatedBy, CreatedOn,
        ChargeType
    )
    SELECT
        @TargetChargeId,
        ChargeName,
        ChargeDescription,
        ChargeAmt,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        1, 0,
        ISNULL(@ActionUser, CreatedBy), GETDATE(),
        ChargeType
    FROM [sm].[MaintenanceChargeDetail]
    WHERE ChargeId = @SourceChargeId
      AND IsActive = 1
      AND IsDeleted = 0;

    PRINT 'Cloning completed successfully.';

END
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeMaster_Create]
(
    @FlatTypeId           INT,
    @SocietyId            INT,
    @MaintenanceCharges   DECIMAL(10, 2),
    @OtherDetail1         VARCHAR(50),
    @OtherDetail2         VARCHAR(50),
    @OtherDetail3         VARCHAR(100),
    @OtherDetail4         VARCHAR(100),
    @OtherDetail5         VARCHAR(500),
    @OtherDetail6         VARCHAR(500),
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ChargeId INT;

    INSERT INTO [sm].[MaintenanceChargeMaster]
    (
         [FlatTypeId]
        ,[SocietyId]
        ,[MaintenanceCharges]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @FlatTypeId
        ,@SocietyId
        ,@MaintenanceCharges
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1               
        ,0               
        ,@ActionUser
        ,GETDATE()
    );

    SET @ChargeId = SCOPE_IDENTITY();

    SELECT 
         [ChargeId]
        ,[FlatTypeId]
        ,[SocietyId]
        ,[MaintenanceCharges]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [sm].[MaintenanceChargeMaster]
    WHERE [ChargeId] = @ChargeId;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[MaintenanceChargeMaster_CreateBulk]
(
      @ChargeList     [sm].[udt_MaintenanceChargeMaster] READONLY,
      @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

		DECLARE @InsertedMasters TABLE
    (
        ChargeId INT,
        FlatTypeId INT,
        SocietyId INT
    );

    -------------------------------------------------------
    -- Step 1: Calculate MaintenanceCharges per FlatType + Society
    -------------------------------------------------------
    ;WITH ChargeSum AS
    (
        SELECT
              FlatTypeId
            , SocietyId
            , SUM(ChargeAmt)     AS TotalCharge
            , MAX(OtherDetail1)  AS OtherDetail1
            , MAX(OtherDetail2)  AS OtherDetail2
            , MAX(OtherDetail3)  AS OtherDetail3
            , MAX(OtherDetail4)  AS OtherDetail4
            , MAX(OtherDetail5)  AS OtherDetail5
            , MAX(OtherDetail6)  AS OtherDetail6
        FROM @ChargeList
        GROUP BY FlatTypeId, SocietyId
    )

    -------------------------------------------------------
    -- Step 2: Insert calculated charges into MaintenanceChargeMaster
    -------------------------------------------------------

    INSERT INTO [sm].[MaintenanceChargeMaster]
    (
          FlatTypeId
        , SocietyId
        , MaintenanceCharges
        , OtherDetail1
        , OtherDetail2
        , OtherDetail3
        , OtherDetail4
        , OtherDetail5
        , OtherDetail6
        , IsActive
        , IsDeleted
        , CreatedBy
        , CreatedOn
    )
	OUTPUT inserted.ChargeId, inserted.FlatTypeId, inserted.SocietyId
	INTO @InsertedMasters(ChargeId, FlatTypeId, SocietyId)
    SELECT
          C.FlatTypeId
        , C.SocietyId
        , C.TotalCharge
        , C.OtherDetail1
        , C.OtherDetail2
        , C.OtherDetail3
        , C.OtherDetail4
        , C.OtherDetail5
        , C.OtherDetail6
        , 1
        , 0
        , @ActionUser
        , GETDATE()
    FROM ChargeSum C;

    -------------------------------------------------------
    -- Step 2a: Insert individual charges into MaintenanceChargeDetail
    -- Link each detail to Master ChargeId
    -------------------------------------------------------
    INSERT INTO [sm].[MaintenanceChargeDetail]
    (
          ChargeId
        , ChargeName
        , ChargeDescription
        , ChargeAmt
        , ChargeType
        , IsActive
        , IsDeleted
        , CreatedBy
        , CreatedOn
    )
    SELECT
          M.ChargeId
        , D.ChargeName
        , D.ChargeDescription
        , D.ChargeAmt
        , D.ChargeType
        , 1
        , 0
        , @ActionUser
        , GETDATE()
    FROM @ChargeList D
	INNER JOIN @InsertedMasters M
		ON D.FlatTypeId  = M.FlatTypeId
		AND D.SocietyId = M.SocietyId;

    -------------------------------------------------------
    -- Step 3: Return inserted rows (Master + Details)
    -------------------------------------------------------
    SELECT
          M.ChargeId
        , M.FlatTypeId
        , M.SocietyId
        , M.MaintenanceCharges
        , D.ChargeName
        , D.ChargeDescription
        , D.ChargeAmt
        , D.ChargeType
        , M.OtherDetail1
        , M.OtherDetail2
        , M.OtherDetail3
        , M.OtherDetail4
        , M.OtherDetail5
        , M.OtherDetail6
        , M.IsActive
        , M.IsDeleted
        , M.CreatedBy
        , M.CreatedOn
        , M.ModifiedBy
        , M.ModifiedOn
    FROM [sm].[MaintenanceChargeMaster] M
    LEFT OUTER JOIN [sm].[MaintenanceChargeDetail] D
        ON M.ChargeId = D.ChargeId
    WHERE M.IsActive = 1
      AND M.IsDeleted = 0
      AND M.CreatedBy = @ActionUser
      AND M.CreatedOn >= DATEADD(MINUTE, -5, GETDATE());

END;

GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeMaster_Delete]
(
    @ChargeId           INT,
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	UPDATE [sm].[MaintenanceChargeMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[CreatedBy] = @ActionUser,
		[CreatedOn] = GETDATE()
	FROM [sm].[MaintenanceChargeMaster]
	WHERE [ChargeId] = @ChargeId;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_GenerateMonthlyMaintenance]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[MaintenanceChargeMaster_GenerateMonthlyMaintenance]

    @SocietyId INT,

    @ActionUser VARCHAR

AS

BEGIN

    SET NOCOUNT ON;



    DECLARE @CurrYear INT = YEAR(GETDATE());

    DECLARE @CurrMonth INT = MONTH(GETDATE());



    ;WITH FlatTypes AS (

        SELECT FT.FlatTypeId

        FROM [sm].[FlatType] FT

        WHERE FT.SocietyId = @SocietyId

          AND FT.IsActive = 1 

          AND FT.IsDeleted = 0

    )

    INSERT INTO [sm].[MaintenanceChargeMaster] 

        (FlatTypeId, SocietyId, MaintenanceCharges, 

         IsActive, IsDeleted, CreatedBy, CreatedOn)

    SELECT 

        FT.FlatTypeId,

        @SocietyId,

        1000,  

        1,

        0,

        @ActionUser,

        GETDATE()

    FROM FlatTypes FT

    WHERE NOT EXISTS (

        SELECT 1 

        FROM [sm].[MaintenanceChargeMaster] MCM

        WHERE MCM.SocietyId = @SocietyId

          AND MCM.FlatTypeId = FT.FlatTypeId

          AND MCM.IsDeleted = 0

          AND YEAR(MCM.CreatedOn) = @CurrYear

          AND MONTH(MCM.CreatedOn) = @CurrMonth

    );

END
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeMaster_ReadAll]
AS
 BEGIN
   SET NOCOUNT ON;
     SELECT
	   [ChargeId]
      ,[FlatTypeId]
      ,[SocietyId]
      ,[MaintenanceCharges]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[MaintenanceChargeMaster]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_ReadByFlatTypeId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeMaster_ReadByFlatTypeId]
(
    @FlatTypeId INT
)
AS
 BEGIN
   SET NOCOUNT ON;
     SELECT
	   [ChargeId]
      ,[FlatTypeId]
      ,[SocietyId]
      ,[MaintenanceCharges]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[MaintenanceChargeMaster]
	  WHERE [FlatTypeId] = @FlatTypeId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeMaster_ReadById]
(
    @ChargeId INT
)
AS
 BEGIN
   SET NOCOUNT ON;
     SELECT
	   [ChargeId]
      ,[FlatTypeId]
      ,[SocietyId]
      ,[MaintenanceCharges]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[MaintenanceChargeMaster]
	  WHERE [ChargeId] = @ChargeId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenanceChargeMaster_ReadBySocietyId]
(
    @SocietyId INT
)
AS
 BEGIN
   SET NOCOUNT ON;
     SELECT
	   [ChargeId]
      ,[FlatTypeId]
      ,[SocietyId]
      ,[MaintenanceCharges]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[MaintenanceChargeMaster]
	  WHERE [SocietyId] = @SocietyId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenanceChargeMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[MaintenanceChargeMaster_Update]
(
    @ChargeId             INT,
    @FlatTypeId           INT,
    @SocietyId            INT,
    @MaintenanceCharges   DECIMAL(10, 2),
    @OtherDetail1         VARCHAR(50),
    @OtherDetail2         VARCHAR(50),
    @OtherDetail3         VARCHAR(100),
    @OtherDetail4         VARCHAR(100),
    @OtherDetail5         VARCHAR(500),
    @OtherDetail6         VARCHAR(500),
    @IsActive             INT,
    @ModifiedBy           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[MaintenanceChargeMaster]
    SET
        [FlatTypeId]         = @FlatTypeId,
        [SocietyId]          = @SocietyId,
        [MaintenanceCharges] = @MaintenanceCharges,
        [OtherDetail1]       = @OtherDetail1,
        [OtherDetail2]       = @OtherDetail2,
        [OtherDetail3]       = @OtherDetail3,
        [OtherDetail4]       = @OtherDetail4,
        [OtherDetail5]       = @OtherDetail5,
        [OtherDetail6]       = @OtherDetail6,
        [IsActive]           = @IsActive,
        [ModifiedBy]         = @ModifiedBy,
        [ModifiedOn]         = GETDATE()
    WHERE [ChargeId] = @ChargeId;

    SELECT 
        [ChargeId],
        [FlatTypeId],
        [SocietyId],
        [MaintenanceCharges],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[MaintenanceChargeMaster]
    WHERE [ChargeId] = @ChargeId
	AND [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenancePayment_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[MaintenancePayment_Create]
(
    @ChargeId          INT,
    @AmountPaid        DECIMAL(18, 2),
    @PaymentDate       DATETIME,
    @ModeOfPayment     VARCHAR(50),
    @TransactionRefNo  VARCHAR(100),
    @Status            VARCHAR(50),
	@ProductType       VARCHAR(50),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PaymentId INT;

    INSERT INTO [sm].[MaintenancePayment]
    (
        [ChargeId],
        [AmountPaid],
        [PaymentDate],
        [ModeOfPayment],
        [TransactionRefNo],
        [Status],
		[ProductType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ChargeId,
        @AmountPaid,
        @PaymentDate,
        @ModeOfPayment,
        @TransactionRefNo,
        @Status,
		@ProductType,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1, 
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @PaymentId = SCOPE_IDENTITY();

    SELECT
	   [PaymentId]
      ,[ChargeId]
      ,[AmountPaid]
      ,[PaymentDate]
      ,[ModeOfPayment]
      ,[TransactionRefNo]
      ,[Status]
	  ,[ProductType]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[MaintenancePayment]
    WHERE [PaymentId] = @PaymentId;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenancePayment_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenancePayment_Delete]
(
	   @PaymentId INT,
	   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE  [sm].[MaintenancePayment]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE  [PaymentId] = @PaymentId
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenancePayment_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenancePayment_ReadAll]
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT 
		 [PaymentId]
		,[ChargeId]
		,[AmountPaid]
		,[PaymentDate]
		,[ModeOfPayment]
		,[TransactionRefNo]
		,[Status]
		,[ProductType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[MaintenancePayment]
	WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenancePayment_ReadByChargeId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenancePayment_ReadByChargeId]
(
   @ChargeId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PaymentId]
		,[ChargeId]
		,[AmountPaid]
		,[PaymentDate]
		,[ModeOfPayment]
		,[TransactionRefNo]
		,[Status]
		,[ProductType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[MaintenancePayment]
	WHERE  [ChargeId] = @ChargeId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenancePayment_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MaintenancePayment_ReadById]
(
   @PaymentId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PaymentId]
		,[ChargeId]
		,[AmountPaid]
		,[PaymentDate]
		,[ModeOfPayment]
		,[TransactionRefNo]
		,[Status]
		,[ProductType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[MaintenancePayment]
	WHERE  [PaymentId] = @PaymentId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MaintenancePayment_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE  [sm].[MaintenancePayment_Update]
(
    @PaymentId         INT,
    @ChargeId          INT,
    @AmountPaid        DECIMAL(18, 2),
    @PaymentDate       DATETIME,
    @ModeOfPayment     VARCHAR(50),
    @TransactionRefNo  VARCHAR(100),
    @Status            VARCHAR(50),
	@ProductType       VARCHAR(50),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[MaintenancePayment]
    SET
        [ChargeId]         = @ChargeId,
        [AmountPaid]       = @AmountPaid,
        [PaymentDate]      = @PaymentDate,
        [ModeOfPayment]    = @ModeOfPayment,
        [TransactionRefNo] = @TransactionRefNo,
        [Status]           = @Status,
		[ProductType]      = @ProductType,
        [OtherDetail1]     = @OtherDetail1,
        [OtherDetail2]     = @OtherDetail2,
        [OtherDetail3]     = @OtherDetail3,
        [OtherDetail4]     = @OtherDetail4,
        [OtherDetail5]     = @OtherDetail5,
        [OtherDetail6]     = @OtherDetail6,
        [IsActive]         = @IsActive,
        [ModifiedBy]       = @ActionUser,
        [ModifiedOn]       = GETDATE()
    WHERE
        [PaymentId] = @PaymentId;

    SELECT
        [PaymentId],
        [ChargeId],
        [AmountPaid],
        [PaymentDate],
        [ModeOfPayment],
        [TransactionRefNo],
        [Status],
        [ProductType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[MaintenancePayment]
    WHERE [PaymentId] = @PaymentId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Meeting_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Meeting_Create]
(
    @SocietyId      INT,
    @Title          VARCHAR(200),
    @Agenda         VARCHAR(50),
    @MeetingDate    DATETIME,
    @Mode           VARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MeetingId INT;

    INSERT INTO [sm].[Meeting]
    (
        [SocietyId],
        [Title],
        [Agenda],
        [MeetingDate],
        [Mode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SocietyId,
        @Title,
        @Agenda,
        @MeetingDate,
        @Mode,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @MeetingId = SCOPE_IDENTITY();

    SELECT
        [MeetingId],
        [SocietyId],
        [Title],
        [Agenda],
        [MeetingDate],
        [Mode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Meeting]
    WHERE [MeetingId] = @MeetingId;
END;
GO
/****** Object:  StoredProcedure [sm].[Meeting_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[Meeting_Delete] 
(
    @MeetingId int,
	@ActionUser varchar(50)
)
AS
 BEGIN
   SET NOCOUNT ON;
	UPDATE[sm].[Meeting]
  SET 
		   [IsActive] = 0,
		   [IsDeleted] = 1,
		   [ModifiedBy] = @ActionUser,
		   [ModifiedOn] = GETDATE()
	WHERE [MeetingId] = @MeetingId
END;
GO
/****** Object:  StoredProcedure [sm].[Meeting_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[Meeting_ReadAll] 
AS
 BEGIN
   SET NOCOUNT ON;
	SELECT
		 [MeetingId]
		,[SocietyId]
		,[Title]
		,[Agenda]
		,[MeetingDate]
		,[Mode]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Meeting]
	WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Meeting_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[Meeting_ReadById] 
(
    @MeetingId int
)
AS
 BEGIN
   SET NOCOUNT ON;
	SELECT
		 [MeetingId]
		,[SocietyId]
		,[Title]
		,[Agenda]
		,[MeetingDate]
		,[Mode]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Meeting]
	WHERE [MeetingId] = @MeetingId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Meeting_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[sm].[Meeting_ReadBySocietyId] 
(
    @SocietyId int
)
AS
 BEGIN
   SET NOCOUNT ON;
	SELECT
		 [MeetingId]
		,[SocietyId]
		,[Title]
		,[Agenda]
		,[MeetingDate]
		,[Mode]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Meeting]
	WHERE [SocietyId] = @SocietyId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Meeting_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Meeting_Update]
(
    @MeetingId      INT,
    @SocietyId      INT,
    @Title          VARCHAR(200),
    @Agenda         VARCHAR(50),
    @MeetingDate    DATETIME,
    @Mode           VARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[Meeting]
    SET
        [SocietyId]     = @SocietyId,
        [Title]         = @Title,
        [Agenda]        = @Agenda,
        [MeetingDate]   = @MeetingDate,
        [Mode]          = @Mode,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [MeetingId] = @MeetingId;

    SELECT
        [MeetingId],
        [SocietyId],
        [Title],
        [Agenda],
        [MeetingDate],
        [Mode],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Meeting]
    WHERE [MeetingId] = @MeetingId;
END;
GO
/****** Object:  StoredProcedure [sm].[MeetingVote_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[MeetingVote_Create]
(
    @MeetingId      INT,
    @FlatId         INT,
    @VoteOption     VARCHAR(50),
    @VotedAt        DATETIME,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @VoteId INT;

    INSERT INTO [sm].[MeetingVote]
    (
        [MeetingId],
        [FlatId],
        [VoteOption],
        [VotedAt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MeetingId,
        @FlatId,
        @VoteOption,
        @VotedAt,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,         
        0,         
        @ActionUser,
        GETDATE()
    );

    SET @VoteId = SCOPE_IDENTITY();

    SELECT 
	   [VoteId]
      ,[MeetingId]
      ,[FlatId]
      ,[VoteOption]
      ,[VotedAt]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[MeetingVote]
	  WHERE [VoteId] = @VoteId;
END;
GO
/****** Object:  StoredProcedure [sm].[MeetingVote_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MeetingVote_Delete]
(
    @VoteId int,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[MeetingVote]
	SET
		   [IsActive] = 0, 
		   [IsDeleted] = 1,
		   [ModifiedBy] = @ActionUser,
		   [ModifiedOn] = GETDATE()
	WHERE  [VoteId] = @VoteId

END;
GO
/****** Object:  StoredProcedure [sm].[MeetingVote_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MeetingVote_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VoteId]
		,[MeetingId]
		,[FlatId]
		,[VoteOption]
		,[VotedAt]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[MeetingVote]
	WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MeetingVote_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MeetingVote_ReadByFlatId]
(
    @FlatId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VoteId]
		,[MeetingId]
		,[FlatId]
		,[VoteOption]
		,[VotedAt]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[MeetingVote]
	WHERE  [FlatId] = @FlatId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MeetingVote_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MeetingVote_ReadById]
(
    @VoteId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VoteId]
		,[MeetingId]
		,[FlatId]
		,[VoteOption]
		,[VotedAt]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[MeetingVote]
	WHERE  [VoteId] = @VoteId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MeetingVote_ReadByMeetingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[MeetingVote_ReadByMeetingId]
(
    @MeetingId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VoteId]
		,[MeetingId]
		,[FlatId]
		,[VoteOption]
		,[VotedAt]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[MeetingVote]
	WHERE  [MeetingId] = @MeetingId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[MeetingVote_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[MeetingVote_Update]
(
    @VoteId         INT,
    @MeetingId      INT,
    @FlatId         INT,
    @VoteOption     VARCHAR(50),
    @VotedAt        DATETIME,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[MeetingVote]
    SET 
        [MeetingId] = @MeetingId,
        [FlatId] = @FlatId,
        [VoteOption] = @VoteOption,
        [VotedAt] = @VotedAt,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser , 
        [ModifiedOn] = GETDATE()
    WHERE 
        [VoteId] = @VoteId ;

    SELECT 
        [VoteId],
        [MeetingId],
        [FlatId],
        [VoteOption],
        [VotedAt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[MeetingVote]
    WHERE [VoteId] = @VoteId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[member_getResidentOverview]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[member_getResidentOverview]
(
    @SocietyId INT,
    @BuildingId INT = 0,
    @FlatId INT = 0,
    @UserId INT = 0
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        ROW_NUMBER() OVER(ORDER BY A.Wing, A.FlatNumber) AS SrNo,
        A.FlatNumber AS FlatNo,
        COALESCE(UA.FirstName + ' ' + ISNULL(UA.MiddleName,'') + ' ' + ISNULL(UA.LastName,''), 'N/A') AS OwnerName,
        COALESCE(P.ParkingNumber, 'N/A') AS ParkingSlot,
        COALESCE(LS.FirstName + ' ' + ISNULL(LS.MiddleName,'') + ' ' + ISNULL(LS.LastName,''), 'N/A') AS LinkedStaff,
        COALESCE(UA.MobileNo, 'N/A') AS ContactNo,
        A.Status,
        MC.MaintenanceCharges AS MaintenanceDue
    FROM [Nishwik].[sm].[Flat] AS A
    LEFT JOIN [Nishwik].[sm].[UserAffiliationMapping] AS B
        ON A.FlatId = B.FlatId
		AND B.AffiliationType = 'Owner'
		AND B.IsActive = 1 AND B.IsDeleted = 0
    LEFT JOIN [Nishwik].[dbo].[UserMaster] AS UA
        ON B.UserId = UA.UserId 
		AND UA.IsActive = 1 AND UA.IsDeleted = 0
    LEFT JOIN [Nishwik].[sm].[Parking] AS P
        ON A.FlatId = P.FlatId 
		AND P.IsActive = 1 AND P.IsDeleted = 0
    LEFT JOIN [Nishwik].[sm].[UserAffiliationMapping] AS C
        ON A.FlatId = C.FlatId 
		AND C.AffiliationType = 'Staff'
		AND C.IsActive = 1 AND C.IsDeleted = 0
    LEFT JOIN [Nishwik].[dbo].[UserMaster] AS LS
        ON C.UserId = LS.UserId AND LS.IsActive = 1 AND LS.IsDeleted = 0
    LEFT JOIN [Nishwik].[sm].[MaintenanceChargeMaster] AS MC
        ON A.FlatTypeId = MC.FlatTypeId 
		AND MC.IsActive = 1 AND MC.IsDeleted = 0
    WHERE A.IsActive = 1
      AND A.IsDeleted = 0
      AND A.BuildingId = CASE WHEN @BuildingId = 0 THEN A.BuildingId ELSE @BuildingId END
      AND A.FlatId = CASE WHEN @FlatId = 0 THEN A.FlatId ELSE @FlatId END
      AND (@UserId = 0 OR UA.UserId = @UserId)
    ORDER BY A.Wing, A.FlatNumber;
END;
GO
/****** Object:  StoredProcedure [sm].[OnboardingPreCheck_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [sm].[OnboardingPreCheck_Create]
(
    @SocietyId    INT             = NULL,
    @PName          VARCHAR(100)    = NULL,
    @PDesc          VARCHAR(500)    = NULL,
    @IsVerified     INT             = NULL,
    @VerifiedBy     VARCHAR(100)    = NULL,
    @VerifiedDate   DATETIME        = NULL,
    @OtherDetail1   VARCHAR(50)     = NULL,
    @OtherDetail2   VARCHAR(50)     = NULL,
    @OtherDetail3   VARCHAR(100)    = NULL,
    @OtherDetail4   VARCHAR(100)    = NULL,
    @OtherDetail5   VARCHAR(500)    = NULL,
    @OtherDetail6   VARCHAR(500)    = NULL,
    @ActionUser     VARCHAR(50)     = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PreCheckId BIGINT;

    INSERT INTO [sm].[OnboardingPreCheck]
    (
        [SocietyId],
        [PName],
        [PDesc],
        [IsVerified],
        [VerifiedBy],
        [VerifiedDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SocietyId,
        TRIM(@PName),
        TRIM(@PDesc),
        @IsVerified,
        TRIM(@VerifiedBy),
        @VerifiedDate,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1, 
        0, 
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @PreCheckId = SCOPE_IDENTITY();

  SELECT 
     A.[PreCheckId]
    ,A.[SocietyId]
    ,A.[PName]
    ,A.[PDesc]
    ,A.[IsVerified]
    ,A.[VerifiedBy]
    ,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
    ,A.[VerifiedDate]
    ,A.[OtherDetail1]
    ,A.[OtherDetail2]
    ,A.[OtherDetail3]
    ,A.[OtherDetail4]
    ,A.[OtherDetail5]
    ,A.[OtherDetail6]
    ,A.[IsActive]
    ,A.[IsDeleted]
    ,A.[CreatedBy]
    ,A.[CreatedOn]
    ,A.[ModifiedBy]
    ,A.[ModifiedOn] 
FROM [sm].[OnboardingPreCheck] A  
LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
    ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
   AND B.[IsActive] = 1
   AND B.[IsDeleted] = 0
WHERE A.[PreCheckId] = @PreCheckId
  AND A.[IsActive] = 1
  AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[OnboardingPreCheck_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[OnboardingPreCheck_Delete]
(
   @PreCheckId BIGINT,
   @ActionUser VARCHAR(50)
)
AS 
BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[OnboardingPreCheck]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE  [PreCheckId] = @PreCheckId
END;
GO
/****** Object:  StoredProcedure [sm].[OnboardingPreCheck_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[OnboardingPreCheck_ReadAll]
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PreCheckId]
		,[SocietyId]
		,[PName]
		,[PDesc]
		,[IsVerified]
		,[VerifiedBy]
		,[VerifiedDate]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[OnboardingPreCheck]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[OnboardingPreCheck_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[OnboardingPreCheck_ReadById]
(
   @PreCheckId BIGINT
)
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PreCheckId]
		,[SocietyId]
		,[PName]
		,[PDesc]
		,[IsVerified]
		,[VerifiedBy]
		,[VerifiedDate]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[OnboardingPreCheck]
	WHERE  [PreCheckId] = @PreCheckId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[OnboardingPreCheck_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[OnboardingPreCheck_ReadBySocietyId]
(
   @SocietyId INT
)
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 A.[PreCheckId]
		,A.[SocietyId]
		,A.[PName]
		,A.[PDesc]
		,A.[IsVerified]
		,A.[VerifiedBy]
		,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
		,A.[VerifiedDate]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [sm].[OnboardingPreCheck]A
        LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
			ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
			AND B.[IsActive] = 1
			AND B.[IsDeleted] = 0
    WHERE A.[SocietyId] = @SocietyId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[OnboardingPreCheck_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[OnboardingPreCheck_Update]
(
    @PreCheckId     BIGINT,
    @SocietyId    INT             = NULL,
    @PName          VARCHAR(100)    = NULL,
    @PDesc          VARCHAR(500)    = NULL,
    @IsVerified     INT             = NULL,
    @VerifiedBy     VARCHAR(100)    = NULL,
    @VerifiedDate   DATETIME        = NULL,
    @OtherDetail1   VARCHAR(50)     = NULL,
    @OtherDetail2   VARCHAR(50)     = NULL,
    @OtherDetail3   VARCHAR(100)    = NULL,
    @OtherDetail4   VARCHAR(100)    = NULL,
    @OtherDetail5   VARCHAR(500)    = NULL,
    @OtherDetail6   VARCHAR(500)    = NULL,
    @IsActive       INT             = NULL,
    @ActionUser     VARCHAR(50)     = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[OnboardingPreCheck]
    SET
        [SocietyId]    = @SocietyId,
        [PName]         = TRIM(@PName),
        [PDesc]         = TRIM(@PDesc),
        [IsVerified]    = @IsVerified,
        [VerifiedBy]    = TRIM(@VerifiedBy),
        [VerifiedDate]  = @VerifiedDate,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [PreCheckId] = @PreCheckId;

    SELECT 
        [PreCheckId],
        [SocietyId],
        [PName],
        [PDesc],
        [IsVerified],
        [VerifiedBy],
        [VerifiedDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[OnboardingPreCheck]
    WHERE [PreCheckId] = @PreCheckId
	AND [IsActive] = 1
	AND [IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [sm].[Parking_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [sm].[Parking_Create]
    @SocietyId = 1,
    @BuilidngId = 2,
    @FlatId = 101,
    @ParkingNumbe = N'P-101',
    @ParkingType = N'Covered',
    @Level = N'B1',
    @VehicleType = N'Car',
    @IsReserved = 1,
    @Remarks = N'Personal vehicle',
    @OtherDetail1 = 'Detail1',
    @OtherDetail2 = 'Detail2',
    @OtherDetail3 = 'Detail3',
    @OtherDetail4 = 'Detail4',
    @OtherDetail5 = 'Detail5',
    @OtherDetail6 = 'Detail6',
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [sm].[Parking_Create]
(
    @SocietyId        INT,
    @BuildingId       INT,
    @FlatId           INT,
    @ParkingNumber     NVARCHAR(50),
    @ParkingType      NVARCHAR(50),
    @Level            NVARCHAR(50),
    @VehicleType      NVARCHAR(50),
    @IsReserved       INT,
    @Remarks          NVARCHAR(255),
	@OwnershipType    VARCHAR(50),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ParkingId INT;

    INSERT INTO [sm].[Parking] (
        [SocietyId],
        [BuildingId],
        [FlatId],
        [ParkingNumber],
        [ParkingType],
        [Level],
        [VehicleType],
        [IsReserved],
        [Remarks],
		[OwnershipType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES (
        @SocietyId,
        @BuildingId,
        @FlatId,
        @ParkingNumber,
        @ParkingType,
        @Level,
        @VehicleType,
        @IsReserved,
        @Remarks,
		@OwnershipType,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,
        GETDATE()
    );

    SET @ParkingId = SCOPE_IDENTITY();

    SELECT
        [ParkingId],
        [SocietyId],
        [BuildingId],
        [FlatId],
        [ParkingNumber],
        [ParkingType],
        [Level],
        [VehicleType],
        [IsReserved],
        [Remarks],
		[OwnershipType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Parking]
    WHERE [ParkingId] = @ParkingId;

END;
GO
/****** Object:  StoredProcedure [sm].[Parking_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Parking_CreateBulk]
(
   @ParkingIdList [sm].[udt_Parking] READONLY,
   @ActionUser Varchar(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	  INSERT INTO [sm].[Parking]
	  (
	   [SocietyId]
      ,[BuildingId]
      ,[FlatId]
      ,[ParkingNumber]
      ,[ParkingType]
      ,[Level]
      ,[VehicleType]
      ,[IsReserved]
      ,[Remarks]
      ,[OwnershipType]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
	  )
	  SELECT 
	   [SocietyId]
      ,[BuildingId]
      ,[FlatId]
      ,[ParkingNumber]
      ,[ParkingType]
      ,[Level]
      ,[VehicleType]
      ,[IsReserved]
      ,[Remarks]
      ,[OwnershipType]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,1
      ,0
      ,@ActionUser
      ,GETDATE()
	 
	 FROM @ParkingIdList ;
	 SELECT
       [ParkingId]
      ,[SocietyId]
      ,[BuildingId]
      ,[FlatId]
      ,[ParkingNumber]
      ,[ParkingType]
      ,[Level]
      ,[VehicleType]
      ,[IsReserved]
      ,[Remarks]
      ,[OwnershipType]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Parking]
	    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE()); 
END;
GO
/****** Object:  StoredProcedure [sm].[Parking_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Parking_Delete]
(
    @ParkingId INT,
	@ActionUser VARCHAR(50)
)
AS
	BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[Parking]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn]= GETDATE()
	WHERE [ParkingId] = @ParkingId
END;
GO
/****** Object:  StoredProcedure [sm].[Parking_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Parking_ReadAll]
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ParkingId]
		,[SocietyId]
		,[BuildingId]
		,[FlatId]
		,[ParkingNumber]
		,[ParkingType]
		,[Level]
		,[VehicleType]
		,[IsReserved]
		,[Remarks]
		,[OwnershipType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Parking]
	WHERE [IsActive] = 1
	AND  [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Parking_ReadByBuildingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Parking_ReadByBuildingId]
(
    @BuildingId INT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ParkingId]
		,[SocietyId]
		,[BuildingId]
		,[FlatId]
		,[ParkingNumber]
		,[ParkingType]
		,[Level]
		,[VehicleType]
		,[IsReserved]
		,[Remarks]
		,[OwnershipType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Parking]
	WHERE [BuildingId] = @BuildingId
	AND  [IsActive] = 1
	AND  [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Parking_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Parking_ReadByFlatId]
(
    @FlatId INT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 A.[ParkingId]
		,A.[SocietyId]
		,A.[BuildingId]
		,A.[FlatId]
		,A.[ParkingNumber]
		,A.[ParkingType]
		,A.[Level]
		,A.[VehicleType]
		,A.[IsReserved]
		,A.[Remarks]
		,A.[OwnershipType]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
		,B.[FlatNumber]
	FROM [sm].[Parking] A
	LEFT OUTER JOIN [sm].[Flat] B
	ON A.[FlatId] = B.[FlatId]
	WHERE A.[FlatId] = @FlatId
	AND  A.[IsActive] = 1
	AND  A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Parking_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Parking_ReadById]
(
    @ParkingId INT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ParkingId]
		,[SocietyId]
		,[BuildingId]
		,[FlatId]
		,[ParkingNumber]
		,[ParkingType]
		,[Level]
		,[VehicleType]
		,[IsReserved]
		,[Remarks]
		,[OwnershipType]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Parking]
	WHERE [ParkingId] = @ParkingId
	AND  [IsActive] = 1
	AND  [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Parking_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Parking_ReadBySocietyId]
(
    @SocietyId INT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 A.[ParkingId]
		,A.[SocietyId]
		,A.[BuildingId]
		,A.[FlatId]
		,A.[ParkingNumber]
		,A.[ParkingType]
		,A.[Level]
		,A.[VehicleType]
		,A.[IsReserved]
		,A.[Remarks]
		,A.[OwnershipType]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
		,B.[FlatNumber]
	FROM [sm].[Parking] A
	LEFT OUTER JOIN [sm].[Flat] B
	ON A.[FlatId] = B.[FlatId]
	WHERE A.[SocietyId] = @SocietyId
	AND A.[IsActive] = 1
	AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Parking_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [sm].[Parking_Update]
    @ParkingId = 1,
    @SocietyId = 1,
    @BuilidingId = 2,
    @FlatId = 101,
    @ParkingNumbe = N'P-101',
    @ParkingType = N'Open',
    @Level = N'G1',
    @VehicleType = N'Bike',
    @IsReserved = 0,
    @Remarks = N'Changed parking',
    @OtherDetail1 = 'Updated1',
    @OtherDetail2 = 'Updated2',
    @OtherDetail3 = 'Updated3',
    @OtherDetail4 = 'Updated4',
    @OtherDetail5 = 'Updated5',
    @OtherDetail6 = 'Updated6',
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [sm].[Parking_Update]
(
    @ParkingId        INT,
    @SocietyId        INT,
    @BuildingId       INT,
    @FlatId           INT,
    @ParkingNumber     NVARCHAR(50),
    @ParkingType      NVARCHAR(50),
    @Level            NVARCHAR(50),
    @VehicleType      NVARCHAR(50),
    @IsReserved       INT,
    @Remarks          NVARCHAR(255),
	@OwnershipType    VARCHAR(50),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[Parking]
    SET
        [SocietyId]     = @SocietyId,
        [BuildingId]    = @BuildingId,
        [FlatId]        = @FlatId,
        [ParkingNumber]  = @ParkingNumber,
        [ParkingType]   = @ParkingType,
        [Level]         = @Level,
        [VehicleType]   = @VehicleType,
        [IsReserved]    = @IsReserved,
        [Remarks]       = @Remarks,
		[OwnershipType] = @OwnershipType,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [ParkingId] = @ParkingId;

    SELECT
        [ParkingId],
        [SocietyId],
        [BuildingId],
        [FlatId],
        [ParkingNumber],
        [ParkingType],
        [Level],
        [VehicleType],
        [IsReserved],
        [Remarks],
		[OwnershipType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[Parking]
    WHERE [ParkingId] = @ParkingId;

END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [sm].[ReceiptDetail_Create]
    @ReceiptId = 1001,
    @MasterType = 'Fee',
    @MasterId = 25,
    @MasterAmt = 5500.00,
    @Remarks = 'First installment',
    @OtherDetail1 = 'OD1',
    @OtherDetail2 = 'OD2',
    @OtherDetail3 = 'OD3',
    @OtherDetail4 = 'OD4',
    @OtherDetail5 = 'OD5',
    @OtherDetail6 = 'OD6',
    @ActionUser = 'admin';
*/

CREATE PROCEDURE [sm].[ReceiptDetail_Create]
(
    @ReceiptId     INT,
    @MasterType    VARCHAR(50) = NULL,
    @MasterId      INT = NULL,
    @MasterAmt     DECIMAL(18,2) = NULL,
    @Remarks       VARCHAR(500) = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [sm].[ReceiptDetail]
    (
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ReceiptId,
        TRIM(@MasterType),
        @MasterId,
        @MasterAmt,
        TRIM(@Remarks),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,              
        0,              
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
        [DetailId],
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[ReceiptDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[ReceiptDetail_ReadAll]
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [sm].[ReceiptDetail] 
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[ReceiptDetail_ReadById]
(
   @DetailId BIGINT
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [sm].[ReceiptDetail] 
	WHERE  [DetailId] = @DetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptDetail_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[ReceiptDetail_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [sm].[ReceiptDetail] 
	WHERE [MasterId] = @MasterId
	AND [MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptDetail_ReadByReceiptId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[ReceiptDetail_ReadByReceiptId]
(
   @ReceiptId INT
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [sm].[ReceiptDetail] 
	WHERE  [ReceiptId] = @ReceiptId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [sm].[ReceiptDetail_Update]
    @DetailId = 1,
    @ReceiptId = 1001,
    @MasterType = 'Fee',
    @MasterId = 25,
    @MasterAmt = 5500.00,
    @Remarks = 'Updated installment',
    @OtherDetail1 = 'OD1',
    @OtherDetail2 = 'OD2',
    @OtherDetail3 = 'OD3',
    @OtherDetail4 = 'OD4',
    @OtherDetail5 = 'OD5',
    @OtherDetail6 = 'OD6',
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE PROCEDURE [sm].[ReceiptDetail_Update]
(
    @DetailId      INT,
    @ReceiptId     INT,
    @MasterType    VARCHAR(50) = NULL,
    @MasterId      INT = NULL,
    @MasterAmt     DECIMAL(18,2) = NULL,
    @Remarks       VARCHAR(500) = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @IsActive      INT = 1,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[ReceiptDetail]
    SET
        [ReceiptId]    = @ReceiptId,
        [MasterType]   = TRIM(@MasterType),
        [MasterId]     = @MasterId,
        [MasterAmt]    = @MasterAmt,
        [Remarks]      = TRIM(@Remarks),
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive]     = @IsActive,
        [ModifiedBy]   = TRIM(@ActionUser),
        [ModifiedOn]   = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT
        [DetailId],
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[ReceiptDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive]= 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [sm].[ReceiptMaster_Create]
    @ReceiptDate = '2025-10-04',
    @ReceiptAmount = 15000.00,
    @RStatus = 'Pending',
    @MasterType = 'Student',
    @MasterId = 101,
    @Remarks = 'First installment',
    @OtherDetail1 = 'OD1',
    @OtherDetail2 = 'OD2',
    @OtherDetail3 = 'OD3',
    @OtherDetail4 = 'OD4',
    @OtherDetail5 = 'OD5',
    @OtherDetail6 = 'OD6',
    @ActionUser = 'admin';
*/

CREATE PROCEDURE [sm].[ReceiptMaster_Create]
(
    @ReceiptDate      DATETIME,
    @ReceiptAmount    DECIMAL(18,2) = NULL,
    @RStatus          VARCHAR(20) = NULL,
    @MasterType       VARCHAR(50) = NULL,
    @MasterId         INT = NULL,
    @Remarks          VARCHAR(500) = NULL,
    @OtherDetail1     VARCHAR(50) = NULL,
    @OtherDetail2     VARCHAR(50) = NULL,
    @OtherDetail3     VARCHAR(100) = NULL,
    @OtherDetail4     VARCHAR(100) = NULL,
    @OtherDetail5     VARCHAR(500) = NULL,
    @OtherDetail6     VARCHAR(500) = NULL,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;


    DECLARE @ReceiptId INT;
    DECLARE @PRRN VARCHAR(20);
    DECLARE @ReceiptNumber VARCHAR(20);

    SET @PRRN = [sm].[GetMaxReceiptPRRN]();
    SET @ReceiptNumber = [sm].[GetMaxReceiptNumber]();


    INSERT INTO [sm].[ReceiptMaster]
    (
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ReceiptDate,
        TRIM(@ReceiptNumber),
        TRIM(@PRRN),
        @ReceiptAmount,
        TRIM(@RStatus),
        TRIM(@MasterType),
        @MasterId,
        TRIM(@Remarks),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,             
        0,             
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @ReceiptId = SCOPE_IDENTITY();

    SELECT
        [ReceiptId],
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[ReceiptMaster]
    WHERE [ReceiptId] = @ReceiptId;
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[ReceiptMaster_Delete]
(
    @ReceiptId INT ,
	@ActionUser  VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE [sm].[ReceiptMaster]
	SET 
		[IsActive] = 0,
		[IsDeleted] = 1,
		[CreatedBy] = @ActionUser,
		[CreatedOn] = GETDATE()
	WHERE [ReceiptId] =  @ReceiptId
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[ReceiptMaster_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	       [ReceiptId]
		  ,[ReceiptDate]
		  ,[ReceiptNumber]
		  ,[PRRN]
		  ,[ReceiptAmount]
		  ,[RStatus]
		  ,[MasterType]
		  ,[MasterId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[ReceiptMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[ReceiptMaster_ReadById]
(
    @ReceiptId INT 
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	       [ReceiptId]
		  ,[ReceiptDate]
		  ,[ReceiptNumber]
		  ,[PRRN]
		  ,[ReceiptAmount]
		  ,[RStatus]
		  ,[MasterType]
		  ,[MasterId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [sm].[ReceiptMaster]
	  WHERE [ReceiptId] = @ReceiptId
	  AND   [IsActive] = 1
	  AND   [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [sm].[ReceiptMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[ReceiptMaster_Update]
(
    @ReceiptId        INT,
    @ReceiptDate      DATETIME = NULL,
    @ReceiptNumber    VARCHAR(20) = NULL,
    @PRRN             VARCHAR(20) = NULL,
    @ReceiptAmount    DECIMAL(18,2) = NULL,
    @RStatus          VARCHAR(20) = NULL,
    @MasterType       VARCHAR(50) = NULL,
    @MasterId         INT = NULL,
    @Remarks          VARCHAR(500) = NULL,
    @OtherDetail1     VARCHAR(50) = NULL,
    @OtherDetail2     VARCHAR(50) = NULL,
    @OtherDetail3     VARCHAR(100) = NULL,
    @OtherDetail4     VARCHAR(100) = NULL,
    @OtherDetail5     VARCHAR(500) = NULL,
    @OtherDetail6     VARCHAR(500) = NULL,
	@IsActive      INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[ReceiptMaster]
    SET
        [ReceiptDate]     = @ReceiptDate,
        [ReceiptNumber]   = TRIM(@ReceiptNumber),
        [PRRN]            = TRIM(@PRRN),
        [ReceiptAmount]   = @ReceiptAmount,
        [RStatus]         = TRIM(@RStatus),
        [MasterType]      = TRIM(@MasterType),
        [MasterId]        = @MasterId,
        [Remarks]         = TRIM(@Remarks),
        [OtherDetail1]    = TRIM(@OtherDetail1),
        [OtherDetail2]    = TRIM(@OtherDetail2),
        [OtherDetail3]    = TRIM(@OtherDetail3),
        [OtherDetail4]    = TRIM(@OtherDetail4),
        [OtherDetail5]    = TRIM(@OtherDetail5),
        [OtherDetail6]    = TRIM(@OtherDetail6),
		[IsActive]        = @IsActive,
        [ModifiedBy]      = TRIM(@ActionUser),
        [ModifiedOn]      = GETDATE()
    WHERE [ReceiptId] = @ReceiptId;

    SELECT
        [ReceiptId],
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[ReceiptMaster]
    WHERE [ReceiptId] = @ReceiptId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_Create]
(
    @SocietyId INT,
	@FlatId INT,
	@BuildingId INT,
	@UserId INT,
	@VisitorName VARCHAR(255),
	@VisitorMobileNo VARCHAR(50),
	@VehicleNumber VARCHAR(50),
	@EntryType VARCHAR(500),
	@OTPCode VARCHAR(6),
	@QRCode VARCHAR(255),
	@Purpose VARCHAR (255),
	@EntryTime DATETIME,
	@ExitTime DATETIME,
	@Remarks VARCHAR(500),
	@RequestedBy INT,
	@ApprovalStatus VARCHAR(500),
	@ApprovalBy INT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @EntryId INT;
	  DECLARE @OTP INT;

    -- Generate a random number between 100000 and 999999
    SET @OTP = FLOOR(RAND() * 900000) + 100000;

    -- Return it in a result set
    SELECT @OTP AS OTP;

    INSERT INTO [sm].[Security]
    (
       [SocietyId],
       [FlatId],
       [BuildingId],
       [UserId],
       [VisitorName],
       [VisitorMobileNo],
       [VehicleNumber],
       [EntryType],
       [OTPCode],
       [QRCode],
       [Purpose],
       [EntryTime],
       [ExitTime],
       [Remarks],
       [RequestedBy],
       [ApprovalStatus],
       [ApprovalBy],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn]
    )
    VALUES
    (
        @SocietyId,
        @FlatId,
        @BuildingId,
        @UserId,
        @VisitorName,
        @VisitorMobileNo,
        @VehicleNumber,
        @EntryType,
        @OTP,
        @QRCode,
        @Purpose,
        @EntryTime,
        @ExitTime,
        @Remarks,
        @RequestedBy,
        @ApprovalStatus,
        @ApprovalBy,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @EntryId = SCOPE_IDENTITY();

    SELECT
	   [EntryId]
      ,[SocietyId]
      ,[FlatId]
      ,[BuildingId]
      ,[UserId]
      ,[VisitorName]
      ,[VisitorMobileNo]
      ,[VehicleNumber]
      ,[EntryType]
      ,[OTPCode]
      ,[QRCode]
      ,[Purpose]
      ,[EntryTime]
      ,[ExitTime]
      ,[Remarks]
      ,[RequestedBy]
      ,[ApprovalStatus]
      ,[ApprovalBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [sm].[Security]
    WHERE [EntryId] = @EntryId;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_Delete]
(
    @EntryId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
    SET NOCOUNT ON;
	UPDATE [sm].[Security]
   SET
           [IsActive] = 0,
           [IsDeleted] = 1,
           [ModifiedBy] = @ActionUser,
           [ModifiedOn] = GETDATE()
	  WHERE [EntryId] = @EntryId
END;
GO
/****** Object:  StoredProcedure [sm].[Security_GetVisitorDetail]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [sm].[Security_GetVisitorDetail] 
    @SocietyId = 14,
    @Date = '2025-10-25';

*/
CREATE PROCEDURE [sm].[Security_GetVisitorDetail]
(
    @SocietyId INT,
    @Date DATETIME   
)
AS
BEGIN
    SET NOCOUNT ON;


    -- Create inline table of weekdays
    ;WITH WeekDays AS
    (
        SELECT 1 AS DayOrder, 'Monday' AS WeekNo
        UNION ALL
        SELECT 2, 'Tuesday'
        UNION ALL
        SELECT 3, 'Wednesday'
        UNION ALL
        SELECT 4, 'Thursday'
        UNION ALL
        SELECT 5, 'Friday'
        UNION ALL
        SELECT 6, 'Saturday'
        UNION ALL
        SELECT 7, 'Sunday'
    ),
    VisitorCounts AS
    (
        SELECT 
            DATENAME(WEEKDAY, EntryTime) AS WeekNo,
            COUNT(*) AS NoOfVisitors
        FROM [sm].[Security]
        WHERE SocietyId = @SocietyId
          AND IsActive = 1
          AND IsDeleted = 0
          AND EntryTime >= @Date
        GROUP BY DATENAME(WEEKDAY, EntryTime)
    )
    SELECT 
        w.WeekNo,
        ISNULL(vc.NoOfVisitors, 0) AS NoOfVisitors
    FROM WeekDays w
    LEFT JOIN VisitorCounts vc
        ON w.WeekNo = vc.WeekNo
    ORDER BY w.DayOrder;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_ReadAll]
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [EntryId]
      ,[SocietyId]
      ,[FlatId]
      ,[BuildingId]
      ,[UserId]
      ,[VisitorName]
      ,[VisitorMobileNo]
      ,[VehicleNumber]
      ,[EntryType]
      ,[OTPCode]
      ,[QRCode]
      ,[Purpose]
      ,[EntryTime]
      ,[ExitTime]
      ,[Remarks]
      ,[RequestedBy]
      ,[ApprovalStatus]
      ,[ApprovalBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Security]
	  WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_ReadByBuildingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_ReadByBuildingId]
(
    @BuildingId INT
)
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [EntryId]
      ,[SocietyId]
      ,[FlatId]
      ,[BuildingId]
      ,[UserId]
      ,[VisitorName]
      ,[VisitorMobileNo]
      ,[VehicleNumber]
      ,[EntryType]
      ,[OTPCode]
      ,[QRCode]
      ,[Purpose]
      ,[EntryTime]
      ,[ExitTime]
      ,[Remarks]
      ,[RequestedBy]
      ,[ApprovalStatus]
      ,[ApprovalBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Security]
	  WHERE [BuildingId] = @BuildingId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_ReadByFlatId]
(
    @FlatId INT
)
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [EntryId]
      ,[SocietyId]
      ,[FlatId]
      ,[BuildingId]
      ,[UserId]
      ,[VisitorName]
      ,[VisitorMobileNo]
      ,[VehicleNumber]
      ,[EntryType]
      ,[OTPCode]
      ,[QRCode]
      ,[Purpose]
      ,[EntryTime]
      ,[ExitTime]
      ,[Remarks]
      ,[RequestedBy]
      ,[ApprovalStatus]
      ,[ApprovalBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Security]
	  WHERE [FlatId] = @FlatId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_ReadById]
(
    @EntryId INT
)
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [EntryId]
      ,[SocietyId]
      ,[FlatId]
      ,[BuildingId]
      ,[UserId]
      ,[VisitorName]
      ,[VisitorMobileNo]
      ,[VehicleNumber]
      ,[EntryType]
      ,[OTPCode]
      ,[QRCode]
      ,[Purpose]
      ,[EntryTime]
      ,[ExitTime]
      ,[Remarks]
      ,[RequestedBy]
      ,[ApprovalStatus]
      ,[ApprovalBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Security]
	  WHERE [EntryId] = @EntryId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_ReadBySocietyId]
(
    @SocietyId INT
)
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [EntryId]
      ,[SocietyId]
      ,[FlatId]
      ,[BuildingId]
      ,[UserId]
      ,[VisitorName]
      ,[VisitorMobileNo]
      ,[VehicleNumber]
      ,[EntryType]
      ,[OTPCode]
      ,[QRCode]
      ,[Purpose]
      ,[EntryTime]
      ,[ExitTime]
      ,[Remarks]
      ,[RequestedBy]
      ,[ApprovalStatus]
      ,[ApprovalBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Security]
	  WHERE [SocietyId] = @SocietyId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_ReadByUserId]
(
    @UserId INT
)
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [EntryId]
      ,[SocietyId]
      ,[FlatId]
      ,[BuildingId]
      ,[UserId]
      ,[VisitorName]
      ,[VisitorMobileNo]
      ,[VehicleNumber]
      ,[EntryType]
      ,[OTPCode]
      ,[QRCode]
      ,[Purpose]
      ,[EntryTime]
      ,[ExitTime]
      ,[Remarks]
      ,[RequestedBy]
      ,[ApprovalStatus]
      ,[ApprovalBy]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[Security]
	  WHERE [UserId] = @UserId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Security_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [sm].[Security_Update]
(
    @EntryId INT,
	@SocietyId INT,
	@FlatId INT,
	@BuildingId INT,
	@UserId INT,
	@VisitorName VARCHAR(255),
	@VisitorMobileNo VARCHAR(50),
	@VehicleNumber VARCHAR(50),
	@EntryType VARCHAR(500),
	@OTPCode VARCHAR(6),
	@QRCode VARCHAR(255),
	@Purpose VARCHAR (255),
	@EntryTime DATETIME,
	@ExitTime DATETIME,
	@Remarks VARCHAR(500),
	@RequestedBy INT,
	@ApprovalStatus VARCHAR(500),
	@ApprovalBy INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @IsActive        INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[Security]
    SET
       [SocietyId] = @SocietyId,
       [FlatId] = @FlatId,
       [BuildingId] = @BuildingId,
       [UserId] = @UserId,
       [VisitorName] = @VisitorName,
       [VisitorMobileNo] = @VisitorMobileNo,
       [VehicleNumber] = @VehicleNumber,
       [EntryType] = @EntryType,
       [OTPCode] = @OTPCode,
       [QRCode] = @QRCode,
       [Purpose] = @Purpose,
       [EntryTime] = @EntryTime,
       [ExitTime] = @ExitTime,
       [Remarks] = @Remarks,
       [RequestedBy] = @RequestedBy,
       [ApprovalStatus] = @ApprovalStatus,
       [ApprovalBy] = @ApprovalBy,
       [OtherDetail1]  = @OtherDetail1,
       [OtherDetail2]  = @OtherDetail2,
       [OtherDetail3]  = @OtherDetail3,
       [OtherDetail4]  = @OtherDetail4,
       [OtherDetail5]  = @OtherDetail5,
       [OtherDetail6]  = @OtherDetail6,
       [IsActive]       = @IsActive,
       [ModifiedBy]     = @ActionUser,
       [ModifiedOn]     = GETDATE()
    WHERE
        [EntryId] = @EntryId;
 

    SELECT
       [EntryId],
       [SocietyId],
       [FlatId],
       [BuildingId],
       [UserId],
       [VisitorName],
       [VisitorMobileNo],
       [VehicleNumber],
       [EntryType],
       [OTPCode],
       [QRCode],
       [Purpose],
       [EntryTime],
       [ExitTime],
       [Remarks],
       [RequestedBy],
       [ApprovalStatus],
       [ApprovalBy],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
    FROM [sm].[Security]
    WHERE [EntryId] = @EntryId
	 AND IsActive =1
	 AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[ServiceRequest_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[ServiceRequest_Create]
(
    @FlatId         INT,
    @Category       VARCHAR(100),
    @Subject        VARCHAR(200),
    @Description    VARCHAR(50),
    @Status         VARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RequestId INT;

    INSERT INTO [sm].[ServiceRequest]
    (
        [FlatId],
        [Category],
        [Subject],
        [Description],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @FlatId,
        @Category,
        @Subject,
        @Description,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,
        GETDATE()
    );

    SET @RequestId = SCOPE_IDENTITY();

    SELECT
        [RequestId],
        [FlatId],
        [Category],
        [Subject],
        [Description],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[ServiceRequest]
    WHERE [RequestId] = @RequestId;
END;
GO
/****** Object:  StoredProcedure [sm].[ServiceRequest_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[ServiceRequest_Delete]
(
      @RequestId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE  [sm].[ServiceRequest]
	SET
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE  [RequestId] = @RequestId
END;
GO
/****** Object:  StoredProcedure [sm].[ServiceRequest_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[ServiceRequest_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [RequestId]
		,[FlatId]
		,[Category]
		,[Subject]
		,[Description]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[ServiceRequest]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[ServiceRequest_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[ServiceRequest_ReadByFlatId]
(
      @FlatId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [RequestId]
		,[FlatId]
		,[Category]
		,[Subject]
		,[Description]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[ServiceRequest]
	WHERE  [FlatId] = @FlatId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[ServiceRequest_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[ServiceRequest_ReadById]
(
      @RequestId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [RequestId]
		,[FlatId]
		,[Category]
		,[Subject]
		,[Description]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[ServiceRequest]
	WHERE  [RequestId] = @RequestId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[ServiceRequest_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[ServiceRequest_Update]
(
    @RequestId      INT,
    @FlatId         INT,
    @Category       VARCHAR(100),
    @Subject        VARCHAR(200),
    @Description    VARCHAR(50),
    @Status         VARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[ServiceRequest]
    SET
        [FlatId]        = @FlatId,
        [Category]      = @Category,
        [Subject]       = @Subject,
        [Description]   = @Description,
        [Status]        = @Status,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [RequestId] = @RequestId;

    SELECT
        [RequestId],
        [FlatId],
        [Category],
        [Subject],
        [Description],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[ServiceRequest]
    WHERE [RequestId] = @RequestId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Society_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Society_Create]
(
    @SocietyName VARCHAR(200),
    @Address VARCHAR(50),
    @City VARCHAR(100),
    @State VARCHAR(100),
    @ZipCode VARCHAR(10),
    @ContactEmail VARCHAR(100),
    @ContactPhone VARCHAR(15),
	@OnBoardingStatus   VARCHAR(50),
	@SocietyDescription varchar(500) ,
	@RegistrationNumber  VARCHAR(100),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SocietyId INT;
	

	IF EXISTS(SELECT 1 FROM [sm].[Society] WHERE RegistrationNumber = @RegistrationNumber )
	BEGIN
		RAISERROR('Duplicate Registration Exists!', 16 , 1)
		RETURN;
	END

    INSERT INTO [sm].[Society]
    (
        [SocietyName],
        [Address],
        [City],
        [State],
        [ZipCode],
        [ContactEmail],
        [ContactPhone],
		[OnBoardingStatus],
		[SocietyDescription],
		[RegistrationNumber],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SocietyName,
        @Address,
        @City,
        @State,
        @ZipCode,
        @ContactEmail,
        @ContactPhone,
		@OnBoardingStatus,
		@SocietyDescription,
		@RegistrationNumber,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @SocietyId = SCOPE_IDENTITY();

    SELECT 
	   [SocietyId]
      ,[SocietyName]
      ,[Address]
      ,[City]
      ,[State]
      ,[ZipCode]
      ,[ContactEmail]
      ,[ContactPhone]
	  ,[OnBoardingStatus]
	  ,[SocietyDescription]
	  ,[RegistrationNumber]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[Society]
	WHERE [SocietyId] = @SocietyId;
END;
GO
/****** Object:  StoredProcedure [sm].[Society_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Society_Delete]
(
    @SocietyId INT,
	@ActionUser varchar(50)
)
AS
	BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[Society]
	SET 
		 [IsActive] = 0,
		 [IsDeleted] = 1,
		 [ModifiedBy] = @ActionUser,
		 [ModifiedOn] = GETDATE()
	WHERE [SocietyId] = @SocietyId

END;
GO
/****** Object:  StoredProcedure [sm].[Society_GetDashboardNotification]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [sm].[Society_GetDashboardNotification]
     @SocietyId = 14;

*/
CREATE PROCEDURE [sm].[Society_GetDashboardNotification]
(
      @SocietyId INT
)
AS
BEGIN
      SET NOCOUNT ON;

      SELECT 
            A.Message
      FROM sm.Announcement A
      WHERE 
            A.IsActive = 1
            AND A.IsDeleted = 0
            AND A.SocietyId = @SocietyId
            AND (
                  A.ValidUntil IS NULL
                  OR CAST(A.ValidUntil AS DATE) >= CAST(GETDATE() AS DATE)
                )
      ORDER BY 
            CASE 
                WHEN A.PostedAt IS NULL OR A.PostedAt = '1900-01-01'
                     THEN A.CreatedOn
                ELSE A.PostedAt
            END DESC;
END;
GO
/****** Object:  StoredProcedure [sm].[Society_GetSocietyByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Society_GetSocietyByUserId]
(
   @UserId int
)
AS BEGIN
  SET NOCOUNT ON;
  SELECT
       A.[SocietyId]
	  ,B.[UserId]
      ,A.[SocietyName]
      ,A.[Address]
      ,A.[City]
      ,A.[State]
      ,A.[ZipCode]
      ,A.[ContactEmail]
      ,A.[ContactPhone]
	  ,A.[OnBoardingStatus]
	  ,A.[SocietyDescription]
	  ,A.[RegistrationNumber]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [Nishwik].[sm].[Society]A
	  LEFT OUTER JOIN [Nishwik].[sm].[UserAffiliationMapping]B
	  ON A.[SocietyId] = B.[SocietyId]
	  WHERE B.[UserId] = @UserId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
END;

GO
/****** Object:  StoredProcedure [sm].[Society_OnboardingComplete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[Society_OnboardingComplete]
    @SocietyId BIGINT
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[Society]
    SET 
	OnBoardingStatus = 'Completed'
    WHERE SocietyId = @SocietyId;
END
GO
/****** Object:  StoredProcedure [sm].[Society_OnboardingReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [sm].[Society_OnboardingReadAllPaginated] 
    @PageSize = 10,
    @PageNo = 1,
    @OrderByClause = '',
    @WhereClause = '';
*/
CREATE   PROCEDURE [sm].[Society_OnboardingReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL

)
AS
 BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL =
		'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum
		  ,[SocietyId]
          ,[SocietyName]
          ,[Address]
          ,[City]
          ,[State]
          ,[ZipCode]
          ,[ContactEmail]
          ,[ContactPhone]
          ,[OnBoardingStatus]
		  ,[SocietyDescription]
		  ,[RegistrationNumber]
          ,[OtherDetail1]
          ,[OtherDetail2]
          ,[OtherDetail3]
          ,[OtherDetail4]
          ,[OtherDetail5]
          ,[OtherDetail6]
          ,[IsActive]
          ,[IsDeleted]
          ,[CreatedBy]
          ,[CreatedOn]
          ,[ModifiedBy]
          ,[ModifiedOn]
	     ,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [sm].[Society]
		WHERE [IsActive] = 1 AND [OnBoardingStatus] = ''Pending''';


	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
	END;
GO
/****** Object:  StoredProcedure [sm].[Society_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Society_ReadAll]
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [SocietyId]
		,[SocietyName]
		,[Address]
		,[City]
		,[State]
		,[ZipCode]
		,[ContactEmail]
		,[ContactPhone]
		,[OnBoardingStatus]
		,[SocietyDescription]
		,[RegistrationNumber]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		FROM [sm].[Society]
	WHERE [IsActive] = 1
	  AND [OnBoardingStatus] = 'Completed';
END;
GO
/****** Object:  StoredProcedure [sm].[Society_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[Society_ReadById]
(
    @SocietyId INT
)
AS
	BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [SocietyId]
		,[SocietyName]
		,[Address]
		,[City]
		,[State]
		,[ZipCode]
		,[ContactEmail]
		,[ContactPhone]
		,[OnBoardingStatus]
		,[SocietyDescription]
		,[RegistrationNumber]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Society]
	WHERE [SocietyId] = @SocietyId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[Society_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[Society_Update]
(
		@SocietyId INT,
		@SocietyName VARCHAR(200),
		@Address VARCHAR(50),
		@City VARCHAR(100),
		@State VARCHAR(100),
		@ZipCode VARCHAR(10),
		@ContactEmail VARCHAR(100),
		@ContactPhone VARCHAR(15),
		@OnBoardingStatus VARCHAR(50) ,
		@SocietyDescription VARCHAR(500),
		@RegistrationNumber  VARCHAR(100) NULL,
		@OtherDetail1 VARCHAR(50),
		@OtherDetail2 VARCHAR(50),
		@OtherDetail3 VARCHAR(100),
		@OtherDetail4 VARCHAR(100),
		@OtherDetail5 VARCHAR(500),
		@OtherDetail6 VARCHAR(500),
		@IsActive INT = 1,
		@ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	UPDATE [sm].[Society]
	SET
		[SocietyName] = @SocietyName,
		[Address] = @Address,
		[City] = @City,
		[State] = @State,
		[ZipCode] = @ZipCode,
		[ContactEmail] = @ContactEmail,
		[ContactPhone] = @ContactPhone,
		[OnBoardingStatus] = @OnBoardingStatus,
		[SocietyDescription] = @SocietyDescription,
		[RegistrationNumber] = @RegistrationNumber,
		[OtherDetail1] = @OtherDetail1,
		[OtherDetail2] = @OtherDetail2,
		[OtherDetail3] = @OtherDetail3,
		[OtherDetail4] = @OtherDetail4,
		[OtherDetail5] = @OtherDetail5,
		[OtherDetail6] = @OtherDetail6,
		[IsActive] =	ISNULL(@IsActive,1),
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [SocietyId] = @SocietyId;

	SELECT 
		 [SocietyId]
		,[SocietyName]
		,[Address]
		,[City]
		,[State]
		,[ZipCode]
		,[ContactEmail]
		,[ContactPhone]
		,[OnBoardingStatus]
		,[SocietyDescription]
		,[RegistrationNumber]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[Society] 
	WHERE [SocietyId] = @SocietyId AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyData_DailyBackup_EOD]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[SocietyData_DailyBackup_EOD]
AS
BEGIN
    SET NOCOUNT ON;

    ---------------------------------------------------
    -- 1) Backup FlatMember
    ---------------------------------------------------
    TRUNCATE TABLE sm.FlatMember_BACKUP;

    SET IDENTITY_INSERT sm.FlatMember_BACKUP ON;
    INSERT INTO sm.FlatMember_BACKUP (
        MemberId, FlatId, UserId, FullName, MobileNumber, Email, Role, IsPrimaryOwner,
        MoveInDate, MoveOutDate, KYCStatus, Status,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    )
    SELECT 
        MemberId, FlatId, UserId, FullName, MobileNumber, Email, Role, IsPrimaryOwner,
        MoveInDate, MoveOutDate, KYCStatus, Status,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    FROM sm.FlatMember;
    SET IDENTITY_INSERT sm.FlatMember_BACKUP OFF;

    ---------------------------------------------------
    -- 2) Backup FlatMemberKYC
    ---------------------------------------------------
    TRUNCATE TABLE sm.FlatMemberKYC_BACKUP;

    SET IDENTITY_INSERT sm.FlatMemberKYC_BACKUP ON;
    INSERT INTO sm.FlatMemberKYC_BACKUP (
        KYCId, MemberId, DocumentType, DocumentNumber, FilePath, Verified,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    )
    SELECT 
        KYCId, MemberId, DocumentType, DocumentNumber, FilePath, Verified,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    FROM sm.FlatMemberKYC;
    SET IDENTITY_INSERT sm.FlatMemberKYC_BACKUP OFF;

    ---------------------------------------------------
    -- 3) Backup MaintenanceChargeMaster
    ---------------------------------------------------
    TRUNCATE TABLE sm.MaintenanceChargeMaster_BACKUP;

    SET IDENTITY_INSERT sm.MaintenanceChargeMaster_BACKUP ON;
    INSERT INTO sm.MaintenanceChargeMaster_BACKUP (
        ChargeId, FlatTypeId, SocietyId, MaintenanceCharges,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    )
    SELECT 
        ChargeId, FlatTypeId, SocietyId, MaintenanceCharges,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    FROM sm.MaintenanceChargeMaster;
    SET IDENTITY_INSERT sm.MaintenanceChargeMaster_BACKUP OFF;

    ---------------------------------------------------
    -- 4) Backup MaintenanceChargeDetail
    ---------------------------------------------------
    TRUNCATE TABLE sm.MaintenanceChargeDetail_BACKUP;

    SET IDENTITY_INSERT sm.MaintenanceChargeDetail_BACKUP ON;
    INSERT INTO sm.MaintenanceChargeDetail_BACKUP (
        DetailId, ChargeId, ChargeName, ChargeDescription, ChargeAmt, ChargeType,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    )
    SELECT 
        DetailId, ChargeId, ChargeName, ChargeDescription, ChargeAmt, ChargeType,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    FROM sm.MaintenanceChargeDetail;
    SET IDENTITY_INSERT sm.MaintenanceChargeDetail_BACKUP OFF;

    ---------------------------------------------------
    -- 5) Backup MaintenancePayment
    ---------------------------------------------------
    TRUNCATE TABLE sm.MaintenancePayment_BACKUP;

    SET IDENTITY_INSERT sm.MaintenancePayment_BACKUP ON;
    INSERT INTO sm.MaintenancePayment_BACKUP (
        PaymentId, ChargeId, AmountPaid, PaymentDate, ModeOfPayment, TransactionRefNo, Status,
        ProductType,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    )
    SELECT 
        PaymentId, ChargeId, AmountPaid, PaymentDate, ModeOfPayment, TransactionRefNo, Status,
        ProductType,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    FROM sm.MaintenancePayment;
    SET IDENTITY_INSERT sm.MaintenancePayment_BACKUP OFF;

    ---------------------------------------------------
    -- 6) Backup ReceiptMaster
    ---------------------------------------------------
    TRUNCATE TABLE sm.ReceiptMaster_BACKUP;

    SET IDENTITY_INSERT sm.ReceiptMaster_BACKUP ON;
    INSERT INTO sm.ReceiptMaster_BACKUP (
        ReceiptId, ReceiptDate, ReceiptNumber, PRRN, ReceiptAmount, RStatus,
        MasterType, MasterId, Remarks,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    )
    SELECT 
        ReceiptId, ReceiptDate, ReceiptNumber, PRRN, ReceiptAmount, RStatus,
        MasterType, MasterId, Remarks,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    FROM sm.ReceiptMaster;
    SET IDENTITY_INSERT sm.ReceiptMaster_BACKUP OFF;

    ---------------------------------------------------
    -- 7) Backup ReceiptDetail
    ---------------------------------------------------
    TRUNCATE TABLE sm.ReceiptDetail_BACKUP;

    SET IDENTITY_INSERT sm.ReceiptDetail_BACKUP ON;
    INSERT INTO sm.ReceiptDetail_BACKUP (
        DetailId, ReceiptId, MasterType, MasterId, MasterAmt, Remarks,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    )
    SELECT 
        DetailId, ReceiptId, MasterType, MasterId, MasterAmt, Remarks,
        OtherDetail1, OtherDetail2, OtherDetail3, OtherDetail4, OtherDetail5, OtherDetail6,
        IsActive, IsDeleted, CreatedBy, CreatedOn, ModifiedBy, ModifiedOn
    FROM sm.ReceiptDetail;
    SET IDENTITY_INSERT sm.ReceiptDetail_BACKUP OFF;

END;
GO
/****** Object:  StoredProcedure [sm].[SocietyDocMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[SocietyDocMaster_Create]
(
    @MasterType      VARCHAR(50),
    @MasterId        INT,
    @DocType         VARCHAR(50),
    @DocNo           VARCHAR(50),
    @DocDescription  VARCHAR(200),
    @DocPath         VARCHAR(500),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @DocId INT;

	INSERT INTO [sm].[SocietyDocMaster]
	(
		[MasterType],
		[MasterId],
		[DocType],
		[DocNo],
		[DocDescription],
		[DocPath],
		[OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
		[OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
		[IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn]
	)
	VALUES
	(
		@MasterType,
		@MasterId,
		@DocType,
		@DocNo,
		@DocDescription,
		@DocPath,
		@OtherDetail1,
		@OtherDetail2,
		@OtherDetail3,
		@OtherDetail4,
		@OtherDetail5,
		@OtherDetail6,
		1,        
		0,        
		@ActionUser,
		GETDATE()
		);

	SET @DocId = SCOPE_IDENTITY();

	SELECT 
		 [DocId]
		,[MasterType]
		,[MasterId]
		,[DocType]
		,[DocNo]
		,[DocDescription]
		,[DocPath]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[SocietyDocMaster]
	WHERE [DocId] = @DocId;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyDocMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[SocietyDocMaster_Delete]
(
      @DocId  INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[SocietyDocMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] =  @ActionUser,
		[ModifiedOn] = getdate()
	WHERE  [DocId] = @DocId
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyDocMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[SocietyDocMaster_ReadAll]
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [sm].[SocietyDocMaster]
		WHERE [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyDocMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[SocietyDocMaster_ReadById]
(
      @DocId  int
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [sm].[SocietyDocMaster]
		WHERE  [DocId] = @DocId
		AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyDocMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[SocietyDocMaster_ReadByMasterId]
(
      @MasterId  INT
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [sm].[SocietyDocMaster]
		WHERE  [MasterId] = @MasterId
		AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyDocMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [sm].[SocietyDocMaster_Update]
(
    @DocId           INT,
    @MasterType      VARCHAR(50),
    @MasterId        INT,
    @DocType         VARCHAR(50),
    @DocNo           VARCHAR(50),
    @DocDescription  VARCHAR(200),
    @DocPath         VARCHAR(500),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
	@IsActive       int,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[SocietyDocMaster]
    SET 
        [MasterType]     = @MasterType,
        [MasterId]       = @MasterId,
        [DocType]        = @DocType,
        [DocNo]          = @DocNo,
        [DocDescription] = @DocDescription,
        [DocPath]        = @DocPath,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
		[IsActive]		 = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE 
        [DocId] = @DocId;

    SELECT 
         [DocId]
        ,[MasterType]
        ,[MasterId]
        ,[DocType]
        ,[DocNo]
        ,[DocDescription]
        ,[DocPath]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [sm].[SocietyDocMaster]
    WHERE [DocId] = @DocId;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyImgMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[SocietyImgMaster_Create]
(
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ImgId INT;
		IF @IsDefault = 1
	BEGIN
	UPDATE[sm].[SocietyImgMaster]
		SET IsDefault = 0,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND IsActive = 1;
	END
    INSERT INTO [sm].[SocietyImgMaster]
    (
        [MasterType],
        [MasterId],
        [ImgPath],
        [ImgTitle],
        [IsDefault],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterType,
        @MasterId,
        @ImgPath,
        @ImgTitle,
        @IsDefault,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,       
        0,       
        @ActionUser,
        GETDATE()
    );

    SET @ImgId = SCOPE_IDENTITY();

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [sm].[SocietyImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyImgMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[SocietyImgMaster_Delete]
(
   @ImgId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[SocietyImgMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] =1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = getdate()
	WHERE [ImgId] = @ImgId
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyImgMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[SocietyImgMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[SocietyImgMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyImgMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[SocietyImgMaster_ReadById]
(
   @ImgId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[SocietyImgMaster]
	WHERE [ImgId] = @ImgId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyImgMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[SocietyImgMaster_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[SocietyImgMaster]
	WHERE [MasterId] = @MasterId
	AND  [MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[SocietyImgMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[SocietyImgMaster_Update]
(
    @ImgId          INT,
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
		IF @IsDefault = 1
		BEGIN
		UPDATE [sm].[SocietyImgMaster]
		SET 
			IsDefault = 0,
			ModifiedBy = @ActionUser,
			ModifiedOn = GETDATE()
		WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND ImgId <> @ImgId
		AND IsActive = 1;
		END
    UPDATE [sm].[SocietyImgMaster]
    SET
         [MasterType]    = @MasterType
        ,[MasterId]      = @MasterId
        ,[ImgPath]       = @ImgPath
        ,[ImgTitle]      = @ImgTitle
        ,[IsDefault]     = @IsDefault
        ,[OtherDetail1]  = @OtherDetail1
        ,[OtherDetail2]  = @OtherDetail2
        ,[OtherDetail3]  = @OtherDetail3
        ,[OtherDetail4]  = @OtherDetail4
        ,[OtherDetail5]  = @OtherDetail5
        ,[OtherDetail6]  = @OtherDetail6
        ,[IsActive]      = @IsActive
        ,[ModifiedBy]    = @ActionUser
        ,[ModifiedOn]    = GETDATE()
    WHERE [ImgId] = @ImgId;

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [sm].[SocietyImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [sm].[UserAffiliationMapping_Create]
(
    @UserId           INT,
    @SocietyId       INT,
	@BuildingId      INT,                                                	
	@FlatId          INT,
    @AffiliationType  VARCHAR(50),
    @Designation      VARCHAR(50),
    @IsPrimary        INT,
    @JoinedOn         DATETIME,
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MappingId INT;

    INSERT INTO [sm].[UserAffiliationMapping]
    (
        [UserId],
        [SocietyId],
	    [BuildingId],
	    [FlatId] ,
        [AffiliationType],
        [Designation],
        [IsPrimary],
        [JoinedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @SocietyId,
		@BuildingId,
		@FlatId,
        @AffiliationType,
        @Designation,
        @IsPrimary,
        @JoinedOn,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,    
        GETDATE()       
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT 
        [MappingId],
        [UserId],
        [SocietyId],
	    [BuildingId],
	    [FlatId] ,
        [AffiliationType],
        [Designation],
        [IsPrimary],
        [JoinedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[UserAffiliationMapping]
    WHERE [MappingId] = @MappingId;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[UserAffiliationMapping_Delete]
(
    @MappingId int,
	@ActionUser varchar(50)
)
AS 
BEGIN 
	SET NOCOUNT ON;
	UPDATE [sm].[UserAffiliationMapping]
	SET 
		[IsActive] = 0 ,
		[IsDeleted] = 1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MappingId]  =@MappingId
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_GetMemberByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[UserAffiliationMapping_GetMemberByUserId]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        B.UserId,
        CONCAT(B.FirstName, ' ',
               ISNULL(B.MiddleName + ' ', ''),
               ISNULL(B.LastName, '')) AS TenantName,
        C.FlatNumber AS FlatNo,
        A.JoinedOn AS StartDate,
        A.OtherDetail1 AS EndDate,      
        B.MobileNo AS ContactNo,
        A.AffiliationType,
        A.IsActive
    FROM [Nishwik].[sm].[UserAffiliationMapping] AS A 
    LEFT JOIN [Nishwik].[dbo].[UserMaster] AS B       
        ON A.UserId = B.UserId
    LEFT JOIN [Nishwik].[sm].[Flat] AS C              
        ON A.FlatId = C.FlatId
    LEFT JOIN [Nishwik].[sm].[Society] AS D           
        ON A.SocietyId = D.SocietyId
    WHERE A.IsActive = 1
      AND A.IsDeleted = 0
      AND B.IsActive = 1
      AND B.IsDeleted = 0
      AND A.AffiliationType = 'Tenant'
    ORDER BY A.JoinedOn DESC;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_GetResidentDetailBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [sm].[UserAffiliationMapping_GetResidentDetailBySocietyId]
(
    @BuildingId INT,
    @SocietyId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        ROW_NUMBER() OVER (ORDER BY C.FlatNumber) AS SrNo,
        C.FlatNumber AS FlatNo,
        CONCAT(B.FirstName, ' ',
               ISNULL(B.MiddleName + ' ', ''),
               ISNULL(B.LastName, '')) AS OwnerName,
        P.ParkingNumber AS ParkingSlot,
        B.MobileNo AS ContactNo,
        C.Status  AS Status 
    FROM [Nishwik].[sm].[UserAffiliationMapping] AS A
    LEFT JOIN [Nishwik].[dbo].[UserMaster] AS B
        ON A.UserId = B.UserId
    LEFT JOIN [Nishwik].[sm].[Flat] AS C
        ON A.FlatId = C.FlatId
   LEFT JOIN [Nishwik].[sm].[Parking] AS P
     ON C.FlatId = P.FlatId
       --AND A.SocietyId = P.SocietyId
       --AND A.BuildingId = P.BuildingId
    WHERE A.IsActive = 1
      AND A.IsDeleted = 0
      AND B.IsActive = 1
      AND B.IsDeleted = 0
      AND A.AffiliationType = 'FlatMember'
      AND A.SocietyId = @SocietyId
     AND C.BuildingId = @BuildingId   
    ORDER BY C.FlatNumber;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_GetTenantsByBuildingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [sm].[UserAffiliationMapping_GetTenantsByBuildingId]
    @BuildingId = 1,
    @Date = '2025-12-31';
*/
CREATE PROCEDURE [sm].[UserAffiliationMapping_GetTenantsByBuildingId]
(
    @BuildingId INT,
    @Date DATETIME = NULL   -- Optional filter for lease expiry
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        ROW_NUMBER() OVER (ORDER BY A.FlatId) AS [SrNo],
        B.FirstName + ' ' + ISNULL(B.MiddleName,'') + ' ' + B.LastName AS [TenantName],
        C.UserId AS [FlatNo],
        A.OtherDetail1 AS [LeaseExpiry],   -- Assuming lease expiry is stored in OtherDetail1
        B.MobileNo AS [ContactNo],
        CASE 
            WHEN A.IsActive = 1 AND (A.OtherDetail1 IS NULL OR A.OtherDetail1 >= GETDATE()) THEN 'Present'
            WHEN A.IsActive = 0 THEN 'Absent'
            ELSE 'Late'
        END AS [Status]
    FROM sm.UserAffiliationMapping AS A
    LEFT OUTER JOIN dbo.UserMaster AS B ON B.UserId = A.UserId
    LEFT OUTER JOIN dbo.UserMaster AS C ON C.UserId = A.FlatId   -- Replace if your flat table is different
    WHERE A.BuildingId = @BuildingId
      AND A.AffiliationType = 'Tenant'  -- Only tenants
      AND A.IsDeleted = 0
      AND (B.IsDeleted = 0 OR B.IsDeleted IS NULL)
      AND (B.IsActive = 1 OR B.IsActive IS NULL)
      AND (@Date IS NULL OR A.OtherDetail1 <= @Date)  -- Optional lease expiry filter
    ORDER BY A.FlatId
END
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[UserAffiliationMapping_ReadAll]
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[SocietyId]
	  ,[BuildingId]
	  ,[FlatId] 
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[joinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[UserAffiliationMapping]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_ReadByBuildingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[UserAffiliationMapping_ReadByBuildingId]
(
    @BuildingId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[SocietyId]
	  ,[BuildingId]
	  ,[FlatId] 
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[JoinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[UserAffiliationMapping]
	  WHERE [BuildingId]  =@BuildingId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[UserAffiliationMapping_ReadByFlatId]
(
    @FlatId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[SocietyId]
	  ,[BuildingId]
	  ,[FlatId] 
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[JoinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[UserAffiliationMapping]
	  WHERE [FlatId]  =@FlatId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[UserAffiliationMapping_ReadById]
(
    @MappingId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[SocietyId]
	  ,[BuildingId]
	  ,[FlatId] 
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[joinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[UserAffiliationMapping]
	  WHERE [MappingId]  =@MappingId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[UserAffiliationMapping_ReadBySocietyId]
(
    @SocietyId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[SocietyId]
	  ,[BuildingId]
	  ,[FlatId] 
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[JoinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[UserAffiliationMapping]
	  WHERE [SocietyId]  =@SocietyId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[sm].[UserAffiliationMapping_ReadByUserId] 1026
*/
CREATE   PROCEDURE [sm].[UserAffiliationMapping_ReadByUserId]
(
    @UserId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[SocietyId]
	  ,[BuildingId]
	  ,[FlatId] 
      ,[AffiliationType]
      ,[Designation]
      ,[IsPrimary]
      ,[JoinedOn]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[UserAffiliationMapping]
	  WHERE [UserId]  = @UserId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[UserAffiliationMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[UserAffiliationMapping_Update]
(
    @MappingId        INT,
    @UserId           INT,
    @SocietyId       INT,
	@BuildingId      INT,                                                	
	@FlatId          INT,
    @AffiliationType  VARCHAR(50),
    @Designation      VARCHAR(50),
    @IsPrimary        INT,
    @JoinedOn         DATETIME,
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[UserAffiliationMapping]
    SET
        [UserId]         = @UserId,
        [SocietyId]     = @SocietyId,
		[BuildingId]    = @BuildingId,
		[FlatId]        = @FlatId,
        [AffiliationType]= @AffiliationType,
        [Designation]    = @Designation,
        [IsPrimary]      = @IsPrimary,
        [JoinedOn]       = @JoinedOn,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE [MappingId] = @MappingId ;

    SELECT 
        [MappingId],
        [UserId],
        [SocietyId],
		[BuildingId],
	    [FlatId] ,
        [AffiliationType],
        [Designation],
        [IsPrimary],
        [JoinedOn],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[UserAffiliationMapping]
    WHERE [MappingId] = @MappingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VaultDocument_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[VaultDocument_Create]
(
    @SocietyId         INT,
    @Title             VARCHAR(200),
    @FilePath          VARCHAR(255),
    @Description       VARCHAR(50),
    @Category          VARCHAR(50),
    @UploadedBy        INT,
    @UploadDate        DATETIME,
    @IsConfidential    INT,
    @AccessLevel       VARCHAR(50),
    @Status            VARCHAR(50),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @VaultDocId INT;

    INSERT INTO [sm].[VaultDocument]
    (
        [SocietyId],
        [Title],
        [FilePath],
        [Description],
        [Category],
        [UploadedBy],
        [UploadDate],
        [IsConfidential],
        [AccessLevel],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SocietyId,
        @Title,
        @FilePath,
        @Description,
        @Category,
        @UploadedBy,
        @UploadDate,
        @IsConfidential,
        @AccessLevel,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,
        GETDATE()
    );

    SET @VaultDocId = SCOPE_IDENTITY();

    SELECT 
        [VaultDocId],
        [SocietyId],
        [Title],
        [FilePath],
        [Description],
        [Category],
        [UploadedBy],
        [UploadDate],
        [IsConfidential],
        [AccessLevel],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[VaultDocument]
    WHERE [VaultDocId] = @VaultDocId;
END;
GO
/****** Object:  StoredProcedure [sm].[VaultDocument_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VaultDocument_Delete]
(
  @VaultDocId INT,
  @ActionUser varchar(50)
)
AS
 BEGIN 
		SET NOCOUNT ON;
		UPDATE [sm].[VaultDocument]
		SET
			[IsActive] = 0,
			[IsDeleted] = 1, 
			[ModifiedBy] = @ActionUser,
			[ModifiedOn] = GETDATE()
		WHERE [VaultDocId] = @VaultDocId
END;
GO
/****** Object:  StoredProcedure [sm].[VaultDocument_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VaultDocument_ReadAll]
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT
       [VaultDocId]
      ,[SocietyId]
      ,[Title]
      ,[FilePath]
      ,[Description]
      ,[Category]
      ,[UploadedBy]
      ,[UploadDate]
      ,[IsConfidential]
      ,[AccessLevel]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[sm].[VaultDocument]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VaultDocument_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[VaultDocument_ReadById]
(
  @VaultDocId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT
       [VaultDocId]
      ,[SocietyId]
      ,[Title]
      ,[FilePath]
      ,[Description]
      ,[Category]
      ,[UploadedBy]
      ,[UploadDate]
      ,[IsConfidential]
      ,[AccessLevel]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[sm].[VaultDocument]
	  WHERE [VaultDocId] = @VaultDocId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VaultDocument_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VaultDocument_ReadBySocietyId]
(
  @SocietyId INT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT
       [VaultDocId]
      ,[SocietyId]
      ,[Title]
      ,[FilePath]
      ,[Description]
      ,[Category]
      ,[UploadedBy]
      ,[UploadDate]
      ,[IsConfidential]
      ,[AccessLevel]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM[sm].[VaultDocument]
	  WHERE [SocietyId] = @SocietyId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VaultDocument_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[VaultDocument_Update]
(
    @VaultDocId        INT,
    @SocietyId         INT,
    @Title             VARCHAR(200),
    @FilePath          VARCHAR(255),
    @Description       VARCHAR(50),
    @Category          VARCHAR(50),
    @UploadedBy        INT,
    @UploadDate        DATETIME,
    @IsConfidential    INT,
    @AccessLevel       VARCHAR(50),
    @Status            VARCHAR(50),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @ModifiedBy        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[VaultDocument]
    SET
        [SocietyId]       = @SocietyId,
        [Title]           = @Title,
        [FilePath]        = @FilePath,
        [Description]     = @Description,
        [Category]        = @Category,
        [UploadedBy]      = @UploadedBy,
        [UploadDate]      = @UploadDate,
        [IsConfidential]  = @IsConfidential,
        [AccessLevel]     = @AccessLevel,
        [Status]          = @Status,
        [OtherDetail1]    = @OtherDetail1,
        [OtherDetail2]    = @OtherDetail2,
        [OtherDetail3]    = @OtherDetail3,
        [OtherDetail4]    = @OtherDetail4,
        [OtherDetail5]    = @OtherDetail5,
        [OtherDetail6]    = @OtherDetail6,
        [IsActive]        = @IsActive,
        [ModifiedBy]      = @ModifiedBy,
        [ModifiedOn]      = GETDATE()
    WHERE [VaultDocId] = @VaultDocId;

    SELECT 
	   [VaultDocId]
      ,[SocietyId]
      ,[Title]
      ,[FilePath]
      ,[Description]
      ,[Category]
      ,[UploadedBy]
      ,[UploadDate]
      ,[IsConfidential]
      ,[AccessLevel]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [sm].[VaultDocument]
	WHERE [VaultDocId] = @VaultDocId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VisitorLog_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[VisitorLog_Create]
(
    @FlatId         INT,
    @VisitorName    VARCHAR(100),
    @VisitorMobile  VARCHAR(15),
    @VisitPurpose   VARCHAR(100),
    @CheckIn        DATETIME,
    @CheckOut       DATETIME,
    @ApprovedBy     VARCHAR(100),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @VisitorLogId BIGINT;

    INSERT INTO [sm].[VisitorLog]
    (
        [FlatId],
        [VisitorName],
        [VisitorMobile],
        [VisitPurpose],
        [CheckIn],
        [CheckOut],
        [ApprovedBy],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @FlatId,
        @VisitorName,
        @VisitorMobile,
        @VisitPurpose,
        @CheckIn,
        @CheckOut,
        @ApprovedBy,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,               
        0,               
        @ActionUser,
        GETDATE()
    );

    SET @VisitorLogId = SCOPE_IDENTITY();

    SELECT
        [VisitorLogId],
        [FlatId],
        [VisitorName],
        [VisitorMobile],
        [VisitPurpose],
        [CheckIn],
        [CheckOut],
        [ApprovedBy],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[VisitorLog]
    WHERE [VisitorLogId] = @VisitorLogId;
END;
GO
/****** Object:  StoredProcedure [sm].[VisitorLog_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VisitorLog_Delete]
(
    @VisitorLogId int,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[sm].[VisitorLog]
	SET
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [VisitorLogId] = @VisitorLogId
END;
GO
/****** Object:  StoredProcedure [sm].[VisitorLog_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VisitorLog_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VisitorLogId]
		,[FlatId]
		,[VisitorName]
		,[VisitorMobile]
		,[VisitPurpose]
		,[CheckIn]
		,[CheckOut]
		,[ApprovedBy]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VisitorLog]
	WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VisitorLog_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VisitorLog_ReadByFlatId]
(
    @FlatId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VisitorLogId]
		,[FlatId]
		,[VisitorName]
		,[VisitorMobile]
		,[VisitPurpose]
		,[CheckIn]
		,[CheckOut]
		,[ApprovedBy]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VisitorLog]
	WHERE [FlatId] = @FlatId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VisitorLog_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VisitorLog_ReadById]
(
    @VisitorLogId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		[VisitorLogId]
		,[FlatId]
		,[VisitorName]
		,[VisitorMobile]
		,[VisitPurpose]
		,[CheckIn]
		,[CheckOut]
		,[ApprovedBy]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VisitorLog]
	WHERE [VisitorLogId] = @VisitorLogId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VisitorLog_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[VisitorLog_Update]
(
    @VisitorLogId      BIGINT,
    @FlatId         INT,
    @VisitorName    VARCHAR(100),
    @VisitorMobile  VARCHAR(15),
    @VisitPurpose   VARCHAR(100),
    @CheckIn        DATETIME,
    @CheckOut       DATETIME,
    @ApprovedBy     VARCHAR(100),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[VisitorLog]
    SET
        [FlatId] = @FlatId,
        [VisitorName] = @VisitorName,
        [VisitorMobile] = @VisitorMobile,
        [VisitPurpose] = @VisitPurpose,
        [CheckIn] = @CheckIn,
        [CheckOut] = @CheckOut,
        [ApprovedBy] = @ApprovedBy,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [VisitorLogId] = @VisitorLogId;

    SELECT
        [VisitorLogId],
        [FlatId],
        [VisitorName],
        [VisitorMobile],
        [VisitPurpose],
        [CheckIn],
        [CheckOut],
        [ApprovedBy],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[VisitorLog]
    WHERE [VisitorLogId] = @VisitorLogId;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingDetail_Create]
(
    @VotingId INT,
	@UserId INT,
	@FlatId INT,
	@OptionSelected NVARCHAR(100),
	@Remarks NVARCHAR(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [sm].[VotingDetail]
    (
        [VotingId],
        [UserId],
		[FlatId],
        [OptionSelected],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @VotingId,
        @UserId,
		@FlatId,
        @OptionSelected,
        @Remarks,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
        [DetailId],
        [VotingId],
        [UserId],
		[FlatId],
        [OptionSelected],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[VotingDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingDetail_Delete]
(
    @DetailId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[sm].[VotingDetail]
	SET
		  [IsActive] = 0,  
		  [IsDeleted] = 1, 
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [sm].[VotingDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingDetail_ReadAll]
AS
 BEGIN 
    SET NOCOUNT ON;
	SELECT
	   [DetailId]
      ,[VotingId]
      ,[UserId]
	  ,[FlatId]
      ,[OptionSelected]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [sm].[VotingDetail]
	  WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingDetail_ReadByFlatId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [sm].[VotingDetail_ReadByFlatId]
(
    @FlatId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
        ,[VotingId]
        ,[UserId]
		,[FlatId]
        ,[OptionSelected]
        ,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VotingDetail]
	WHERE [FlatId] = @FlatId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingDetail_ReadById]
(
    @DetailId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
        ,[VotingId]
        ,[UserId]
		,[FlatId]
        ,[OptionSelected]
        ,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VotingDetail]
	WHERE [DetailId] = @DetailId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingDetail_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingDetail_ReadByUserId]
(
    @UserId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
        ,[VotingId]
        ,[UserId]
		,[FlatId]
        ,[OptionSelected]
        ,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VotingDetail]
	WHERE [UserId] = @UserId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingDetail_ReadByVotingId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingDetail_ReadByVotingId]
(
    @VotingId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [DetailId]
        ,[VotingId]
        ,[UserId]
		,[FlatId]
        ,[OptionSelected]
        ,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VotingDetail]
	WHERE [VotingId] = @VotingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingDetail_Update]
(
    @DetailId INT,
    @VotingId INT,
	@UserId INT,
	@FlatId INT,
	@OptionSelected NVARCHAR(100),
	@Remarks NVARCHAR(500),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[VotingDetail]
    SET
        [VotingId] = @VotingId,
        [UserId] = @UserId,
		[FlatId] = @FlatId,
        [OptionSelected] = @OptionSelected,
        [Remarks] = @Remarks,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT
        [DetailId],
        [VotingId],
        [UserId],
		[FlatId],
        [OptionSelected],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[VotingDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingMaster_Create]
(
    @SocietyId INT,
	@VotingDate DATETIME,
	@MasterCode VARCHAR(50),
	@Question NVARCHAR(500),
	@Options NVARCHAR(MAX),
	@IsAnonymous INT,
	@VotingDescription VARCHAR(500),
	@RequestedBy VARCHAR(50),
	@StartDate DATETIME,
	@EndDate DATETIME,
	@Status NVARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @VotingId INT;

    INSERT INTO [sm].[VotingMaster]
    (
        [SocietyId],
        [VotingDate],
        [MasterCode],
        [Question],
        [Options],
        [IsAnonymous],
        [VotingDescription],
        [RequestedBy],
        [StartDate],
        [EndDate],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SocietyId,
        @VotingDate,
        @MasterCode,
        @Question,
        @Options,
        @IsAnonymous,
        @VotingDescription,
        @RequestedBy,
        @StartDate,
        @EndDate,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,
        GETDATE()
    );

    SET @VotingId = SCOPE_IDENTITY();

    SELECT
        [VotingId],
        [SocietyId],
        [VotingDate],
        [MasterCode],
        [Question],
        [Options],
        [IsAnonymous],
        [VotingDescription],
        [RequestedBy],
        [StartDate],
        [EndDate],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[VotingMaster]
    WHERE [VotingId] = @VotingId;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingMaster_Delete]
(
    @VotingId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[sm].[VotingMaster]
	SET
		  [IsActive] = 0,  
		  [IsDeleted] = 1, 
		  [ModifiedBy] = @ActionUser,
		  [ModifiedOn] = GETDATE()
	WHERE [VotingId] = @VotingId
END;
GO
/****** Object:  StoredProcedure [sm].[VotingMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VotingId]
        ,[SocietyId]
        ,[VotingDate]
        ,[MasterCode]
        ,[Question]
        ,[Options]
        ,[IsAnonymous]
        ,[VotingDescription]
        ,[RequestedBy]
        ,[StartDate]
        ,[EndDate]
        ,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VotingMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingMaster_ReadById]
(
    @VotingId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VotingId]
        ,[SocietyId]
        ,[VotingDate]
        ,[MasterCode]
        ,[Question]
        ,[Options]
        ,[IsAnonymous]
        ,[VotingDescription]
        ,[RequestedBy]
        ,[StartDate]
        ,[EndDate]
        ,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VotingMaster]
	WHERE [VotingId] = @VotingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingMaster_ReadBySocietyId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingMaster_ReadBySocietyId]
(
    @SocietyId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [VotingId]
        ,[SocietyId]
        ,[VotingDate]
        ,[MasterCode]
        ,[Question]
        ,[Options]
        ,[IsAnonymous]
        ,[VotingDescription]
        ,[RequestedBy]
        ,[StartDate]
        ,[EndDate]
        ,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [sm].[VotingMaster]
	WHERE [SocietyId] = @SocietyId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [sm].[VotingMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [sm].[VotingMaster_Update]
(
    @VotingId INT,
    @SocietyId INT,
	@VotingDate DATETIME,
	@MasterCode VARCHAR(50),
	@Question NVARCHAR(500),
	@Options NVARCHAR(MAX),
	@IsAnonymous INT,
	@VotingDescription VARCHAR(500),
	@RequestedBy VARCHAR(50),
	@StartDate DATETIME,
	@EndDate DATETIME,
	@Status NVARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [sm].[VotingMaster]
    SET
        [SocietyId] = @SocietyId,
        [VotingDate] = @VotingDate,
        [MasterCode] = @MasterCode,
        [Question] = @Question,
        [Options] = @Options,
        [IsAnonymous] = @IsAnonymous,
        [VotingDescription] = @VotingDescription,
        [RequestedBy] = @RequestedBy,
        [StartDate] = @StartDate,
        [EndDate] = @EndDate,
        [Status] = @Status,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [VotingId] = @VotingId;

    SELECT
        [VotingId],
        [SocietyId],
        [VotingDate],
        [MasterCode],
        [Question],
        [Options],
        [IsAnonymous],
        [VotingDescription],
        [RequestedBy],
        [StartDate],
        [EndDate],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [sm].[VotingMaster]
    WHERE [VotingId] = @VotingId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[Activity_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Activity_Create]
(
	@MasterId INT,
	@MasterType VARCHAR(20),
	@Message NVARCHAR(max),
	@MessageType NVARCHAR(50),
	@Status NVARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ActivityId INT;

    INSERT INTO [spe].[Activity]
    (
        [MasterId],
        [MasterType],
        [Message],
        [MessageType],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterId,
        @MasterType,
        @Message,
        @MessageType,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @ActivityId = SCOPE_IDENTITY();

    SELECT
        [ActivityId],
        [MasterId],
        [MasterType],
        [Message],
        [MessageType],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[Activity]
    WHERE [ActivityId] = @ActivityId;
END;
GO
/****** Object:  StoredProcedure [spe].[Activity_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Activity_Delete]
(
  @ActivityId INT,
  @ActionUser VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[Activity]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [ActivityId] = @ActivityId
END;
GO
/****** Object:  StoredProcedure [spe].[Activity_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Activity_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ActivityId]
      ,[MasterId]
      ,[MasterType]
      ,[Message]
      ,[MessageType]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[Activity]
	WHERE [IsActive] = 1
	AND [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Activity_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Activity_ReadById]
(
  @ActivityId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ActivityId]
      ,[MasterId]
      ,[MasterType]
      ,[Message]
      ,[MessageType]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[Activity]
	WHERE [ActivityId] = @ActivityId
    AND[IsActive] = 1
    AND [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Activity_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Activity_ReadByMasterId]
(
  @MasterId INT,
  @MasterType VARCHAR(20)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ActivityId]
      ,[MasterId]
      ,[MasterType]
      ,[Message]
      ,[MessageType]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[Activity]
	WHERE [MasterId] = @MasterId
	AND [MasterType] = @MasterType
    AND  [IsActive] = 1
    AND  [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Activity_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Activity_Update]
(
    @ActivityId INT,
    @MasterId INT,
	@MasterType VARCHAR(20),
	@Message NVARCHAR(max),
	@MessageType NVARCHAR(50),
	@Status NVARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[Activity]
    SET
        [MasterId] = @MasterId,
        [MasterType] = @MasterType,
        [Message] = @Message,
        [MessageType] = @MessageType,
        [Status] = @Status,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [ActivityId] = @ActivityId;

    SELECT
        [ActivityId],
        [MasterId],
        [MasterType],
        [Message],
        [MessageType],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[Activity]
    WHERE [ActivityId] = @ActivityId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[Announcement_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[Announcement_Create]
    @SchoolId     = 1,
    @Title        = N'Holiday Notice',
    @MasterId         = '',
	@MasterType = '',
    @Message      = N'School will remain closed tomorrow due to maintenance.',
    @Audience     = 'Students,Parents',
    @PostedAt     = NULL,
    @ValidUntil   = NULL,
    @Languages    = N'English,Hindi',
    @OtherDetail1 = 'Urgent',
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @ActionUser   = 'Admin';


*/

CREATE PROCEDURE [spe].[Announcement_Create]
(
    @SchoolId     INT,
    @Title        NVARCHAR(250),
    @MasterId       INT = NULL,
	@MasterType     VARCHAR(50),
    @Message      NVARCHAR(2000) = NULL,
    @Audience     VARCHAR(MAX) = NULL,
    @PostedAt     DATETIME = NULL,
    @ValidUntil   DATETIME = NULL,
    @Languages    NVARCHAR(MAX) = NULL,
    @OtherDetail1 VARCHAR(50) = NULL,
    @OtherDetail2 VARCHAR(50) = NULL,
    @OtherDetail3 VARCHAR(100) = NULL,
    @OtherDetail4 VARCHAR(100) = NULL,
    @OtherDetail5 VARCHAR(500) = NULL,
    @OtherDetail6 VARCHAR(500) = NULL,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AnnouncementId INT;

    INSERT INTO [spe].[Announcement]
    (
         [SchoolId]
        ,[Title]
        ,[MasterId]
		,[MasterType]
        ,[Message]
        ,[Audience]
        ,[PostedAt]
        ,[ValidUntil]
        ,[Languages]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @SchoolId
        ,TRIM(@Title)
        ,@MasterId
		,TRIM(@MasterType)
        ,TRIM(@Message)
        ,TRIM(@Audience)
        ,@PostedAt
        ,@ValidUntil
        ,TRIM(@Languages)
        ,TRIM(@OtherDetail1)
        ,TRIM(@OtherDetail2)
        ,TRIM(@OtherDetail3)
        ,TRIM(@OtherDetail4)
        ,TRIM(@OtherDetail5)
        ,TRIM(@OtherDetail6)
        ,1               
        ,0               
        ,TRIM(@ActionUser)
        ,GETDATE()
    );

    SET @AnnouncementId = SCOPE_IDENTITY();

    SELECT 
	   [AnnouncementId]
      ,[SchoolId]
      ,[Title]
      ,[MasterId]
	  ,[MasterType]
      ,[Message]
      ,[Audience]
      ,[PostedAt]
      ,[ValidUntil]
      ,[Languages]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [spe].[Announcement]
    WHERE [AnnouncementId] = @AnnouncementId;
END;
GO
/****** Object:  StoredProcedure [spe].[Announcement_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Announcement_Delete]
(
  @AnnouncementId INT,
  @ActionUser VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[Announcement]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [AnnouncementId] = @AnnouncementId
END;
GO
/****** Object:  StoredProcedure [spe].[Announcement_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Announcement_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [AnnouncementId]
		,[SchoolId]
		,[Title]
		,[MasterId]
		,[MasterType]
		,[Message]
		,[Audience]
		,[PostedAt]
		,[ValidUntil]
		,[Languages]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[Announcement]
	WHERE [IsActive] = 1
	AND [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Announcement_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Announcement_ReadById]
(
  @AnnouncementId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [AnnouncementId]
		,[SchoolId]
		,[Title]
		,[MasterId]
		,[MasterType]
		,[Message]
		,[Audience]
		,[PostedAt]
		,[ValidUntil]
		,[Languages]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[Announcement]
	WHERE [AnnouncementId] = @AnnouncementId
    AND[IsActive] = 1
    AND [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Announcement_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Announcement_ReadByMasterId]
(
  @MasterId INT,
  @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [AnnouncementId]
		,[SchoolId]
		,[Title]
		,[MasterId]
		,[MasterType]
		,[Message]
		,[Audience]
		,[PostedAt]
		,[ValidUntil]
		,[Languages]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[Announcement]
	WHERE [MasterId] = @MasterId
	AND [MasterType] = @MasterType
    AND[IsActive] = 1
    AND [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Announcement_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Announcement_ReadBySchoolId]
(
  @SchoolId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [AnnouncementId]
		,[SchoolId]
		,[Title]
		,[MasterId]
		,[MasterType]
		,[Message]
		,[Audience]
		,[PostedAt]
		,[ValidUntil]
		,[Languages]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[Announcement]
	WHERE [SchoolId] = @SchoolId
    AND  [IsActive] = 1
    AND  [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Announcement_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*


EXEC [spe].[Announcement_Update] 
    @AnnouncementId = 1,             -- ID of the record to update
    @SchoolId       = 101,           -- Example SchoolId
    @Title          = 'Holiday Notice',
    @Type           = 'General',
    @Message        = 'School will remain closed tomorrow due to weather conditions.',
    @Audience       = 'Students, Parents',
    @PostedAt       = NULL,
    @ValidUntil     = NULL,
    @Languages      = 'English',
    @OtherDetail1   = 'Detail1',
    @OtherDetail2   = 'Detail2',
    @OtherDetail3   = 'Detail3',
    @OtherDetail4   = 'Detail4',
    @OtherDetail5   = 'Detail5',
    @OtherDetail6   = 'Detail6',
    @IsActive       = 1,
    @ActionUser     = 'Admin';

*/

CREATE PROCEDURE [spe].[Announcement_Update]
(
    @AnnouncementId INT,
    @SchoolId       INT,
    @Title          NVARCHAR(250),
    @MasterId          int= NULL,
	@MasterType       VARCHAR(50),
    @Message        NVARCHAR(2000) = NULL,
    @Audience       VARCHAR(MAX) = NULL,
    @PostedAt       DATETIME = NULL,
    @ValidUntil     DATETIME = NULL,
    @Languages      NVARCHAR(MAX) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @IsActive       INT ,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[Announcement]
    SET
         [SchoolId]     = @SchoolId
        ,[Title]        = TRIM(@Title)
        ,[MasterId]         = @MasterId
	    ,[MasterType]     = TRIM(@MasterType)
        ,[Message]      = TRIM(@Message)
        ,[Audience]     = TRIM(@Audience)
        ,[PostedAt]     = @PostedAt
        ,[ValidUntil]   = @ValidUntil
        ,[Languages]    = TRIM(@Languages)
        ,[OtherDetail1] = TRIM(@OtherDetail1)
        ,[OtherDetail2] = TRIM(@OtherDetail2)
        ,[OtherDetail3] = TRIM(@OtherDetail3)
        ,[OtherDetail4] = TRIM(@OtherDetail4)
        ,[OtherDetail5] = TRIM(@OtherDetail5)
        ,[OtherDetail6] = TRIM(@OtherDetail6)
        ,[IsActive]     = @IsActive
        ,[ModifiedBy]   = TRIM(@ActionUser)
        ,[ModifiedOn]   = GETDATE()
    WHERE [AnnouncementId] = @AnnouncementId;

    SELECT 
         [AnnouncementId]
        ,[SchoolId]
        ,[Title]
        ,[MasterId]
		,[MasterType]
        ,[Message]
        ,[Audience]
        ,[PostedAt]
        ,[ValidUntil]
        ,[Languages]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[Announcement]
    WHERE [AnnouncementId] = @AnnouncementId
	AND [IsActive] = 1
    AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_Create]
(
    @SchoolId INT,
	@ClassId INT,
	@SectionId INT,
	@SubjectId INT,
	@TeacherId INT,
	@Title NVARCHAR(200),
	@Description NVARCHAR(500),
	@AssignedDate DATETIME,
	@DueDate DATETIME,
	@SubmissionType VARCHAR(20),
	@TotalMarks DECIMAL(5,2),
	@FileUrl NVARCHAR(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AssignmentId INT;

    INSERT INTO [spe].[AssignmentMaster]
    (
        [SchoolId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [TeacherId],
        [Title],
        [Description],
        [AssignedDate],
        [DueDate],
        [SubmissionType],
        [TotalMarks],
		[FileUrl],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @ClassId,
        @SectionId,
        @SubjectId,
        @TeacherId,
        @Title,
        @Description,
        @AssignedDate,
        @DueDate,
        @SubmissionType,
        @TotalMarks,
		@FileUrl,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @AssignmentId = SCOPE_IDENTITY();

    SELECT
        [AssignmentId],
        [SchoolId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [TeacherId],
        [Title],
        [Description],
        [AssignedDate],
        [DueDate],
        [SubmissionType],
        [TotalMarks],
		[FileUrl],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[AssignmentMaster]
    WHERE [AssignmentId] = @AssignmentId;
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_Delete]
(
      @AssignmentId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[AssignmentMaster]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [AssignmentId]  = @AssignmentId
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [AssignmentId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[TeacherId]
      ,[Title]
      ,[Description]
      ,[AssignedDate]
      ,[DueDate]
      ,[SubmissionType]
      ,[TotalMarks]
	  ,[FileUrl]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[AssignmentMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_ReadByClassId]
(
    @ClassId INT,
    @SectionId INT = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
         [AssignmentId]
        ,[SchoolId]
        ,[ClassId]
        ,[SectionId]
        ,[SubjectId]
        ,[TeacherId]
        ,[Title]
        ,[Description]
        ,[AssignedDate]
        ,[DueDate]
        ,[SubmissionType]
        ,[TotalMarks]
        ,[FileUrl]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[AssignmentMaster]
    WHERE [ClassId] = @ClassId
      AND [IsActive] = 1
      AND (@SectionId IS NULL OR [SectionId] = @SectionId);
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_ReadByClassSubject]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_ReadByClassSubject]
(
    @ClassId INT,
    @SubjectId INT,             
    @PageSize INT,
    @PageNo INT,
    @SectionId INT = NULL,     
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Result INT = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' +
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
        ') AS RowNum,
        A.[AssignmentId],
        A.[SchoolId],
        A.[ClassId],
        B.[ClassName],
        A.[SectionId],
        C.[SectionName],
        A.[SubjectId],
        D.[SubjectName],
        A.[TeacherId],
        E.[FirstName] + '' '' + ISNULL(E.[LastName], '''') AS [TeacherName],
        A.[Title],
        A.[Description],
        A.[AssignedDate],
        A.[DueDate],
        A.[SubmissionType],
        A.[TotalMarks],
        A.[FileUrl],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn],
        COUNT(*) OVER () AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [spe].[AssignmentMaster] A
    LEFT JOIN [Nishwik].[spe].[ClassMaster] B 
		ON A.[ClassId] = B.[ClassId]
    LEFT JOIN [Nishwik].[spe].[SectionMaster] C 
		ON A.[SectionId] = C.[SectionId]
    LEFT JOIN [Nishwik].[spe].[SubjectMaster] D 
		ON A.[SubjectId] = D.[SubjectId]
    LEFT JOIN [Nishwik].[dbo].[UserMaster] E 
		ON A.[TeacherId] = E.[UserId]
    WHERE A.[ClassId] = ' + CAST(@ClassId AS NVARCHAR) + '
      AND A.[SubjectId] = ' + CAST(@SubjectId AS NVARCHAR) + '  
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0';

    -- Optional filters
    IF @SectionId IS NOT NULL
        SET @SQL = @SQL + ' AND A.[SectionId] = ' + CAST(@SectionId AS NVARCHAR);

    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    -- Sorting
    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    -- Paging
    SET @SQL = @SQL + '
     OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
     FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL; -- Debugging
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_ReadById]
(
      @AssignmentId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [AssignmentId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[TeacherId]
      ,[Title]
      ,[Description]
      ,[AssignedDate]
      ,[DueDate]
      ,[SubmissionType]
      ,[TotalMarks]
	  ,[FileUrl]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[AssignmentMaster]
	WHERE  [AssignmentId]  = @AssignmentId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_ReadBySchoolId]
(
      @SchoolId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [AssignmentId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[TeacherId]
      ,[Title]
      ,[Description]
      ,[AssignedDate]
      ,[DueDate]
      ,[SubmissionType]
      ,[TotalMarks]
	  ,[FileUrl]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[AssignmentMaster]
	WHERE  [SchoolId]  = @SchoolId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_ReadBySectionId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_ReadBySectionId]
(
      @SectionId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [AssignmentId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[TeacherId]
      ,[Title]
      ,[Description]
      ,[AssignedDate]
      ,[DueDate]
      ,[SubmissionType]
      ,[TotalMarks]
	  ,[FileUrl]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[AssignmentMaster]
	WHERE  [SectionId]  = @SectionId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_ReadBySubjectId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_ReadBySubjectId]
(
      @SubjectId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [AssignmentId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[TeacherId]
      ,[Title]
      ,[Description]
      ,[AssignedDate]
      ,[DueDate]
      ,[SubmissionType]
      ,[TotalMarks]
	  ,[FileUrl]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[AssignmentMaster]
	WHERE  [SubjectId]  = @SubjectId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_ReadByTeacherId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[AssignmentMaster_ReadByTeacherId] 
     @TeacherId = 1283,       -- Example TeacherId
     @PageSize = 10,         -- Number of records per page
     @PageNo = 1,            -- Page number
     @OrderByClause = NULL, -- Optional (default is CreatedOn DESC)
     @WhereClause = NULL;    
*/
CREATE PROCEDURE [spe].[AssignmentMaster_ReadByTeacherId]
(
      @TeacherId INT,
	  @PageSize INT,
	  @PageNo INT,
	  @OrderByClause NVARCHAR(MAX) = NULL,
	  @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL ='
	SELECT
	ROW_NUMBER() OVER (ORDER BY ' + 
	ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
	') AS RowNum,
	   A.[AssignmentId]
      ,A.[SchoolId]
      ,A.[ClassId]
	  ,B.[ClassName]
      ,A.[SectionId]
	  ,C.[SectionName]
      ,A.[SubjectId]
	  ,D.[SubjectName]
      ,A.[TeacherId]
	  ,E.[FirstName] + '' '' + ISNULL(E.[LastName], '''') AS [TeacherName]
      ,A.[Title]
      ,A.[Description]
      ,A.[AssignedDate]
      ,A.[DueDate]
      ,A.[SubmissionType]
      ,A.[TotalMarks]
	  ,A.[FileUrl]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
		,COUNT(*) OVER () AS TotalCount,
		' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
		' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [spe].[AssignmentMaster] A
	LEFT JOIN [Nishwik].[spe].[ClassMaster] B ON A.[ClassId] = B.[ClassId]
	LEFT JOIN [Nishwik].[spe].[SectionMaster] C ON A.[SectionId] = C.[SectionId]
	LEFT JOIN [Nishwik].[spe].[SubjectMaster] D ON A.[SubjectId] = D.[SubjectId]
	LEFT JOIN [Nishwik].[dbo].[UserMaster] E ON A.[TeacherId] = E.[UserId]
	WHERE A.[TeacherId] = ' + CAST(@TeacherId AS NVARCHAR) + '
	AND A.[IsActive] = 1
	AND A.[IsDeleted] = 0';

	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

	-- Always enforce ORDER BY for OFFSET
	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
		SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
		SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

	SET @SQL = @SQL + '
	 OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	 FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL; -- for debugging
	EXEC sp_executesql @SQL;	
END;
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_SubmissionLineList]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_SubmissionLineList]
(
    @SchoolId INT,
    @ClassId INT,
    @SectionId INT = NULL,
    @TeacherId INT = 0,
    @StartDate DATE = NULL,
    @EndDate DATE = NULL,
    @TopN INT = 0
)
AS
BEGIN
    SET NOCOUNT ON;

    IF @StartDate IS NULL SET @StartDate = DATEFROMPARTS(YEAR(GETDATE()), MONTH(GETDATE()), 1);
    IF @EndDate IS NULL SET @EndDate = EOMONTH(GETDATE());

    SELECT
        A.AssignmentId,
        A.Title AS AssignmentTitle,
        SUM(CASE WHEN SAS.Status <> 'Submitted' OR SAS.Status IS NULL THEN 1 ELSE 0 END) AS PendingCount,
        SUM(CASE WHEN SAS.Status = 'Submitted' THEN 1 ELSE 0 END) AS CompletedCount,
        A.DueDate
    FROM [spe].[AssignmentMaster] AS A
    LEFT JOIN [spe].[StudentAssignmentSubmission] AS SAS
        ON A.AssignmentId = SAS.AssignmentId
    WHERE 
        A.IsActive = 1
        AND A.IsDeleted = 0
        AND A.SchoolId = @SchoolId
        AND A.ClassId = @ClassId
        AND (@SectionId IS NULL OR A.SectionId = @SectionId)
        AND (@TeacherId = 0 OR A.TeacherId = @TeacherId)
        AND A.AssignedDate BETWEEN @StartDate AND @EndDate
    GROUP BY
        A.AssignmentId, A.Title, A.DueDate, A.AssignedDate
    ORDER BY A.AssignedDate DESC
    OFFSET 0 ROWS
    FETCH NEXT CASE WHEN @TopN = 0 THEN 1000000 ELSE @TopN END ROWS ONLY;
END
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_SubmissionProgress]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[AssignmentSubmission_Progress]
    @SchoolId = 5,
    @ClassId = 32,
    @SectionId = 5,
    @TeacherId = 1284,
    @StartDate = '2025-08-01',
    @EndDate = '2025-11-13';
*/

CREATE PROCEDURE [spe].[AssignmentMaster_SubmissionProgress]
(
    @SchoolId INT,
    @ClassId INT,
    @SectionId INT = NULL, 
    @TeacherId INT = 0,    
    @StartDate DATE = NULL,
    @EndDate DATE = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    -- Default date range: current month
    IF @StartDate IS NULL SET @StartDate = DATEFROMPARTS(YEAR(GETDATE()), MONTH(GETDATE()), 1);
    IF @EndDate IS NULL SET @EndDate = EOMONTH(GETDATE());

    SELECT
        CAST(
            CASE WHEN COUNT(SAS.StudentId) = 0 THEN 0
                 ELSE SUM(CASE WHEN SAS.Status = 'Submitted' THEN 1 ELSE 0 END) * 100.0 / COUNT(SAS.StudentId)
            END AS INT
        ) AS CompletedPercentage,
        CAST(
            CASE WHEN COUNT(SAS.StudentId) = 0 THEN 0
                 ELSE SUM(CASE WHEN SAS.Status <> 'Submitted' OR SAS.Status IS NULL THEN 1 ELSE 0 END) * 100.0 / COUNT(SAS.StudentId)
            END AS INT
        ) AS PendingPercentage
    FROM [spe].[AssignmentMaster] AS A
    LEFT JOIN [spe].[StudentAssignmentSubmission] AS SAS
        ON A.AssignmentId = SAS.AssignmentId
    WHERE 
        A.IsActive = 1
        AND A.IsDeleted = 0
        AND A.SchoolId = @SchoolId
        AND A.ClassId = @ClassId
        AND (@SectionId IS NULL OR A.SectionId = @SectionId)
        AND (@TeacherId = 0 OR A.TeacherId = @TeacherId)
        AND A.AssignedDate BETWEEN @StartDate AND @EndDate;
END
GO
/****** Object:  StoredProcedure [spe].[AssignmentMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[AssignmentMaster_Update]
(
    @AssignmentId INT, 
	@SchoolId INT,
	@ClassId INT,
	@SectionId INT,
	@SubjectId INT,
	@TeacherId INT,
	@Title NVARCHAR(200),
	@Description NVARCHAR(500),
	@AssignedDate DATETIME,
	@DueDate DATETIME,
	@SubmissionType VARCHAR(20),
	@TotalMarks DECIMAL(5,2),
	@FileUrl NVARCHAr(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[AssignmentMaster]
    SET
        [SchoolId] = @SchoolId,
        [ClassId] = @ClassId,
        [SectionId] = @SectionId,
        [SubjectId] = @SubjectId,
        [TeacherId] = @TeacherId,
        [Title] = @Title,
        [Description] = @Description,
        [AssignedDate] = @AssignedDate,
        [DueDate] = @DueDate,
        [SubmissionType] = @SubmissionType,
        [TotalMarks]= @TotalMarks,
		[FileUrl] = @FileUrl,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [AssignmentID] = @AssignmentID;

    SELECT
        [AssignmentId],
        [SchoolId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [TeacherId],
        [Title],
        [Description],
        [AssignedDate],
        [DueDate],
        [SubmissionType],
        [TotalMarks],
		[FileUrl],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[AssignmentMaster]
    WHERE [AssignmentId] = @AssignmentId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ClassMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[ClassMaster_Create]
(
    @SchoolId       INT,
    @ClassName      NVARCHAR(50),
    @Description    NVARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1
        FROM [spe].[ClassMaster]
        WHERE SchoolId = @SchoolId
          AND ClassName = @ClassName
          AND IsActive = 1
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('Duplicate Entry Found. Class already exists in this school.', 16, 1);
        RETURN;
    END;

    DECLARE @ClassId INT;

    INSERT INTO [spe].[ClassMaster]
    (
        [SchoolId],
        [ClassName],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @ClassName,
        @Description,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @ClassId = SCOPE_IDENTITY();

    SELECT
        [ClassId],
        [SchoolId],
        [ClassName],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ClassMaster]
    WHERE [ClassId] = @ClassId;
END;
GO
/****** Object:  StoredProcedure [spe].[ClassMaster_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ClassMaster_CreateBulk]
(
   @ClassIdList [spe].[udt_ClassMaster] READONLY,
   @ActionUser Varchar(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	  INSERT INTO [spe].[ClassMaster]
	  (
	   [SchoolId]
      ,[ClassName]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
	  )
	  SELECT 
	   [SchoolId]
      ,[ClassName]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,1
      ,0
      ,@ActionUser
      ,GETDATE()
	 
	 FROM @ClassIdList ;
	 SELECT
	   [ClassId]
      ,[SchoolId]
      ,[ClassName]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[ClassMaster]
	    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE()); 
END;
GO
/****** Object:  StoredProcedure [spe].[ClassMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[ClassMaster_Delete]
(
      @ClassId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[ClassMaster]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [ClassId]  = @ClassId
END;
GO
/****** Object:  StoredProcedure [spe].[ClassMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[ClassMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	[ClassId]
	,[SchoolId]
	,[ClassName]
	,[Description]
	,[OtherDetail1]
	,[OtherDetail2]
	,[OtherDetail3]
	,[OtherDetail4]
	,[OtherDetail5]
	,[OtherDetail6]
	,[IsActive]
	,[IsDeleted]
	,[CreatedBy]
	,[CreatedOn]
	,[ModifiedBy]
	,[ModifiedOn]
	FROM [spe].[ClassMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ClassMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[ClassMaster_ReadAllPaginated]
(
    @SchoolId INT,
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL
)
AS
 BEGIN 
		SET NOCOUNT ON; 
		DECLARE @Result INT = 0, @TotalCount INT = 0;
		SET @Result = (@PageNo - 1) * @PageSize;
		SET NOCOUNT ON;

		DECLARE @SQL NVARCHAR(MAX);
		SET @SQL =
		'SELECT 
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum,
			 [ClassId]
			,[SchoolId]
			,[ClassName]
			,[Description]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [spe].[ClassMaster]
		WHERE [SchoolId] = ' + CAST(@SchoolId AS NVARCHAR) + '
		AND [IsActive] = 1';

	-- Append additional WHERE clause safely
	IF @WhereClause IS NOT NULL AND LTRIM(RTRIM(@WhereClause)) <> ''
		SET @SQL = @SQL + ' AND (' + @WhereClause + ')';

	-- Ensure a valid ORDER BY for OFFSET/FETCH
	DECLARE @FinalOrderBy NVARCHAR(MAX) = ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC');

	SET @SQL = @SQL + '
	ORDER BY ' + @FinalOrderBy + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL;
	EXEC sp_executesql @SQL;


END;
GO
/****** Object:  StoredProcedure [spe].[ClassMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[ClassMaster_ReadById]
(
      @ClassId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	 A.[ClassId]
	,A.[SchoolId]
	,B.[SchoolName]
	,A.[ClassName]
	,A.[Description]
	,A.[OtherDetail1]
	,A.[OtherDetail2]
	,A.[OtherDetail3]
	,A.[OtherDetail4]
	,A.[OtherDetail5]
	,A.[OtherDetail6]
	,A.[IsActive]
	,A.[IsDeleted]
	,A.[CreatedBy]
	,A.[CreatedOn]
	,A.[ModifiedBy]
	,A.[ModifiedOn]
	FROM [spe].[ClassMaster] A
	LEFT OUTER JOIN spe.SchoolMaster B
	ON A.SchoolId= B.SchoolId
	WHERE   A.[ClassId]  = @ClassId
	AND A. [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ClassMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[ClassMaster_ReadBySchoolId]
(
      @SchoolId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	 A.[ClassId]
	,A.[SchoolId]
	,B.[SchoolName]
	,A.[ClassName]
	,A.[Description]
	,A.[OtherDetail1]
	,A.[OtherDetail2]
	,A.[OtherDetail3]
	,A.[OtherDetail4]
	,A.[OtherDetail5]
	,A.[OtherDetail6]
	,A.[IsActive]
	,A.[IsDeleted]
	,A.[CreatedBy]
	,A.[CreatedOn]
	,A.[ModifiedBy]
	,A.[ModifiedOn]
	FROM [spe].[ClassMaster] A
	LEFT OUTER JOIN spe.SchoolMaster B
	ON A.SchoolId= B.SchoolId
	WHERE   A.[SchoolId]  = @SchoolId
	AND A. [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ClassMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[ClassMaster_Update]
(
    @ClassId        INT,
    @SchoolId       INT,
    @ClassName      NVARCHAR(50),
    @Description    NVARCHAR(50),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[ClassMaster]
    SET
        [SchoolId]      = @SchoolId,
        [ClassName]     = @ClassName,
        [Description]   = @Description,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [ClassId] = @ClassId;

    SELECT
        [ClassId],
        [SchoolId],
        [ClassName],
        [Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ClassMaster]
    WHERE [ClassId] = @ClassId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumMaster_Create]
(
    @SchoolId INT,
	@ClassId INT,
	@CurriculumName VARCHAR(100),
	@Description VARCHAR(500),
	@StartYear DATETIME, 
	@EndYear DATETIME,
	@AcademicYear varchar(100),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @CurriculumId INT;

    INSERT INTO [spe].[CurriculumMaster]
    (
        [SchoolId],
        [ClassId],
        [CurriculumName],
        [Description],
        [StartYear],
        [EndYear],
		[AcademicYear],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @ClassId,
        @CurriculumName,
        @Description,
        @StartYear,
        @EndYear,
		@AcademicYear,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @CurriculumId = SCOPE_IDENTITY();

    SELECT
        [CurriculumId],
        [SchoolId],
        [ClassId],
        [CurriculumName],
        [Description],
        [StartYear],
        [EndYear],
		[AcademicYear],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[CurriculumMaster]
    WHERE [CurriculumId] = @CurriculumId;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumMaster_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[CurriculumMaster_CreateBulk]
(
    @CurriculumIdList [spe].[udt_CurriculumMaster] READONLY,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO [spe].[CurriculumMaster]
    (
       [SchoolId]
      ,[ClassId]
      ,[CurriculumName]
      ,[Description]
      ,[StartYear]
      ,[EndYear]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
    )
    SELECT
        SchoolId,
        ClassId,
        CurriculumName,
        Description,
        StartYear,
        EndYear,
		AcademicYear,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        1,
        0,               -- default IsDeleted
        @ActionUser,     -- CreatedBy
        GETDATE()        -- CreatedOn
    FROM @CurriculumIdList;

    -- Return inserted rows
    SELECT 
        [CurriculumId]
      ,[SchoolId]
      ,[ClassId]
      ,[CurriculumName]
      ,[Description]
      ,[StartYear]
      ,[EndYear]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [Nishwik].[spe].[CurriculumMaster]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumMaster_Delete]
(
      @CurriculumId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[CurriculumMaster]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [CurriculumId]  = @CurriculumId
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [CurriculumId]
      ,[SchoolId]
      ,[ClassId]
      ,[CurriculumName]
      ,[Description]
      ,[StartYear]
      ,[EndYear]
	  ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[CurriculumMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumMaster_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumMaster_ReadByClassId]
(
      @ClassId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   A.[CurriculumId]
      ,A.[SchoolId]
      ,A.[ClassId]
	  ,B.[ClassName]
      ,A.[CurriculumName]
      ,A.[Description]
      ,A.[StartYear]
      ,A.[EndYear]
	  ,A.[AcademicYear]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	FROM [spe].[CurriculumMaster]A
	LEFT OUTER JOIN [Nishwik].[spe].[ClassMaster]B
	ON A.[ClassId] = B.[ClassId]
	WHERE A.[ClassId]  = @ClassId
	AND A.[IsActive] = 1
	AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumMaster_ReadById]
(
      @CurriculumId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [CurriculumId]
      ,[SchoolId]
      ,[ClassId]
      ,[CurriculumName]
      ,[Description]
      ,[StartYear]
      ,[EndYear]
	  ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[CurriculumMaster]
	WHERE  [CurriculumId]  = @CurriculumId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumMaster_ReadBySchoolId]
(
      @SchoolId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   A.[CurriculumId]
      ,A.[SchoolId]
	  ,C.[SchoolName]
      ,A.[ClassId]
	  ,B.[ClassName]
      ,A.[CurriculumName]
      ,A.[Description]
      ,A.[StartYear]
      ,A.[EndYear]
	  ,A.[AcademicYear]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	FROM [spe].[CurriculumMaster]A
	LEFT OUTER JOIN [Nishwik].[spe].[ClassMaster]B
	ON A.[ClassId] = B.[ClassId]
	LEFT OUTER JOIN [Nishwik].[spe].[SchoolMaster]C
	ON A.[SchoolId] = C.[SchoolId]
	WHERE A.[SchoolId]  = @SchoolId
	AND A.[IsActive] = 1
	AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumMaster_Update]
(
    @CurriculumId INT,
    @SchoolId INT,
	@ClassId INT,
	@CurriculumName VARCHAR(100),
	@Description VARCHAR(500),
	@StartYear DATETIME,
	@EndYear DATETIME,
	@AcademicYear VARCHAR(100),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[CurriculumMaster]
    SET
        [SchoolId] = @SchoolId,
        [ClassId] = @ClassId,
        [CurriculumName] = @CurriculumName,
        [Description] = @Description,
        [StartYear] = @StartYear,
        [EndYear] = @EndYear,
		[AcademicYear] = @AcademicYear,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [CurriculumId] = @CurriculumId;

    SELECT
        [CurriculumId],
        [SchoolId],
        [ClassId],
        [CurriculumName],
        [Description],
        [StartYear],
        [EndYear],
		[AcademicYear],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[CurriculumMaster]
    WHERE [CurriculumId] = @CurriculumId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumSubjectMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumSubjectMapping_Create]
(
    @CurriculumId INT,
	@SubjectId INT,
	@ClassId INT,
	@SequenceOrder INT,
	@Remarks VARCHAR(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
	
    --  Prevent duplicates (same CurriculumId + SubjectId + ClassId)
    IF EXISTS (
        SELECT 1
        FROM [spe].[CurriculumSubjectMapping]
        WHERE CurriculumId = @CurriculumId
          AND SubjectId = @SubjectId
          AND ClassId = @ClassId
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('Curriculum-Subject-Class mapping already exists.', 16, 1);
        RETURN;
    END
    DECLARE @MappingId INT;

    INSERT INTO [spe].[CurriculumSubjectMapping]
    (
        [CurriculumId],
        [SubjectId],
        [ClassId],
        [SequenceOrder],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @CurriculumId,
        @SubjectId,
        @ClassId,
        @SequenceOrder,
        @Remarks,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT
        [MappingId],
        [CurriculumId],
        [SubjectId],
        [ClassId],
        [SequenceOrder],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[CurriculumSubjectMapping]
    WHERE [MappingId] = @MappingId;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumSubjectMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumSubjectMapping_Delete]
(
      @MappingId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[CurriculumSubjectMapping]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [MappingId]  = @MappingId
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumSubjectMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumSubjectMapping_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [MappingId]
      ,[CurriculumId]
      ,[SubjectId]
      ,[ClassId]
      ,[SequenceOrder]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[CurriculumSubjectMapping]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumSubjectMapping_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumSubjectMapping_ReadByClassId]
(
      @ClassId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [MappingId]
      ,[CurriculumId]
      ,[SubjectId]
      ,[ClassId]
      ,[SequenceOrder]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[CurriculumSubjectMapping]
	WHERE  [ClassId]  = @ClassId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumSubjectMapping_ReadByCurriculumId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumSubjectMapping_ReadByCurriculumId]
(
      @CurriculumId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   A.[MappingId]
      ,A.[CurriculumId]
      ,A.[SubjectId]
	  ,B.[SubjectName]
      ,A.[ClassId]
	  ,C.[ClassName]
      ,A.[SequenceOrder]
      ,A.[Remarks]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	FROM [spe].[CurriculumSubjectMapping]A
	LEFT OUTER JOIN spe.SubjectMaster B
	ON A.[SubjectId] = B.[SubjectId]
	LEFT OUTER JOIN spe.ClassMaster C
	ON A.ClassId = C.ClassId
	WHERE A. [CurriculumId]  = @CurriculumId
	AND A.[IsActive] = 1
	AND A.IsDeleted = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumSubjectMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumSubjectMapping_ReadById]
(
      @MappingId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [MappingId]
      ,[CurriculumId]
      ,[SubjectId]
      ,[ClassId]
      ,[SequenceOrder]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[CurriculumSubjectMapping]
	WHERE  [MappingId]  = @MappingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumSubjectMapping_ReadBySubjectId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumSubjectMapping_ReadBySubjectId]
(
      @SubjectId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [MappingId]
      ,[CurriculumId]
      ,[SubjectId]
      ,[ClassId]
      ,[SequenceOrder]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[CurriculumSubjectMapping]
	WHERE  [SubjectId]  = @SubjectId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[CurriculumSubjectMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[CurriculumSubjectMapping_Update]
(
    @MappingId INT,
	@CurriculumId INT,
	@SubjectId INT,
	@ClassId INT,
	@SequenceOrder INT,
	@Remarks VARCHAR(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[CurriculumSubjectMapping]
    SET
        [CurriculumId] = @CurriculumId,
        [SubjectId] = @SubjectId,
        [ClassId] = @ClassId,
        [SequenceOrder] = @SequenceOrder,
        [Remarks] = @Remarks,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [MappingId] = @MappingId;

    SELECT
        [MappingId],
        [CurriculumId],
        [SubjectId],
        [ClassId],
        [SequenceOrder],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[CurriculumSubjectMapping]
    WHERE [MappingId] = @MappingId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[DiscussionDetail_Create]
(
    @DiscussionId     INT,
    @PostedBy         VARCHAR(50),
    @PostedAt         DATETIME = NULL,
    @DiscDesc         NVARCHAR(4000) = NULL,
    @OtherDetail1     VARCHAR(50) = NULL,
    @OtherDetail2     VARCHAR(50) = NULL,
    @OtherDetail3     VARCHAR(100) = NULL,
    @OtherDetail4     VARCHAR(100) = NULL,
    @OtherDetail5     VARCHAR(500) = NULL,
    @OtherDetail6     VARCHAR(500) = NULL,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId BIGINT;

    INSERT INTO [spe].[DiscussionDetail]
    (
        [DiscussionId],
        [PostedBy],
        [PostedAt],
        [DiscDesc],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @DiscussionId,
        TRIM(@PostedBy),
        @PostedAt,
        @DiscDesc,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,           
        0,           
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
        [DetailId],
        [DiscussionId],
        [PostedBy],
        [PostedAt],
        [DiscDesc],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[DiscussionDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[DiscussionDetail_Delete]
(
   @DetailId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	UPDATE [spe].[DiscussionDetail]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[CreatedBy] = @ActionUser,
		[CreatedOn] = GETDATE()
	WHERE  [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[DiscussionDetail_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		   [DetailId]
		  ,[DiscussionId]
		  ,[PostedBy]
		  ,[PostedAt]
		  ,[DiscDesc]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [spe].[DiscussionDetail]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionDetail_ReadByDiscussionId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[DiscussionDetail_ReadByDiscussionId] 
(
   @DiscussionId INT
)
AS
BEGIN
    SET NOCOUNT ON;

	SELECT 
		 A.[DetailId],
		 A.[DiscussionId],
		 A.[PostedBy],
		 B.FirstName + ' ' + B.LastName AS UserName,
		 A.[PostedAt],
		 A.[DiscDesc],
		 A.[OtherDetail1],
		 A.[OtherDetail2],
		 A.[OtherDetail3],
		 A.[OtherDetail4],
		 A.[OtherDetail5],
		 A.[OtherDetail6],
		 A.[IsActive],
		 A.[IsDeleted],
		 A.[CreatedBy],
		 A.[CreatedOn],
		 A.[ModifiedBy],
		 A.[ModifiedOn]
	FROM [spe].[DiscussionDetail] A
	LEFT JOIN [dbo].[UserMaster] B
		ON A.PostedBy = B.UserId
	WHERE A.[DiscussionId] = @DiscussionId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0
	ORDER BY A.[PostedAt] ASC;   -- oldest first, or DESC for newest first
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[DiscussionDetail_ReadById]
(
   @DetailId BIGINT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		   [DetailId]
		  ,[DiscussionId]
		  ,[PostedBy]
		  ,[PostedAt]
		  ,[DiscDesc]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [spe].[DiscussionDetail]
	  WHERE  [DetailId] = @DetailId
	  AND    [IsActive] = 1
	  AND    [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[DiscussionDetail_Update]
(
    @DetailId        BIGINT,
    @DiscussionId    INT,
    @PostedBy        VARCHAR(50) = NULL,
    @PostedAt        DATETIME = NULL,
    @DiscDesc        NVARCHAR(4000) = NULL,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @IsActive        INT = 1,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[DiscussionDetail]
    SET
        [DiscussionId] = @DiscussionId,
        [PostedBy] = TRIM(@PostedBy),
        [PostedAt] = @PostedAt,
        [DiscDesc] = @DiscDesc,
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive] = @IsActive,
        [ModifiedBy] = TRIM(@ActionUser),
        [ModifiedOn] = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT
        [DetailId],
        [DiscussionId],
        [PostedBy],
        [PostedAt],
        [DiscDesc],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[DiscussionDetail]
    WHERE [DetailId] = @DetailId
      AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[DiscussionMaster_Create]
(
    @MasterType      VARCHAR(50) = NULL,
    @MasterId        INT = NULL,
    @DiscTitle       VARCHAR(500) = NULL,
    @DiscDesc        NVARCHAR(4000) = NULL,
    @PostedBy        VARCHAR(50) = NULL,
    @PostedAt        DATETIME = NULL,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DiscussionId INT;

    INSERT INTO [spe].[DiscussionMaster]
    (
        [MasterType],
        [MasterId],
        [DiscTitle],
        [DiscDesc],
        [PostedBy],
        [PostedAt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        TRIM(@MasterType),
        @MasterId,
        TRIM(@DiscTitle),
        @DiscDesc,
        TRIM(@PostedBy),
        @PostedAt,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,             
        0,             
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DiscussionId = SCOPE_IDENTITY();

    SELECT
        [DiscussionId],
        [MasterType],
        [MasterId],
        [DiscTitle],
        [DiscDesc],
        [PostedBy],
        [PostedAt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[DiscussionMaster]
    WHERE [DiscussionId] = @DiscussionId;
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[DiscussionMaster_Delete]
( 
   @DiscussionId INT,
   @ActionUser VARCHAR(50)
)
 AS
  BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[DiscussionMaster]
	SET 
		[IsActive] = 0,
		[IsDeleted] = 1,
		[CreatedBy] = @ActionUser,
		[CreatedOn] = GETDATE()
	FROM [spe].[DiscussionMaster]
	WHERE  [DiscussionId] = @DiscussionId 
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionMaster_DiscussionListing]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[DiscussionMaster_DiscussionListing]
(
    @SchoolId INT  -- you can keep it, but won't use directly
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        B.FirstName + ' ' + ISNULL(B.MiddleName,'') + ' ' + ISNULL(B.LastName,'') AS [TeacherName],
        A.DiscTitle AS [DiscussionTitle],
        A.DiscDesc AS [DiscussionDescription],
        CASE 
            WHEN DATEDIFF(MINUTE, A.PostedAt, GETDATE()) < 60 
                THEN CAST(DATEDIFF(MINUTE, A.PostedAt, GETDATE()) AS VARCHAR(10)) + 'm ago'
            WHEN DATEDIFF(HOUR, A.PostedAt, GETDATE()) < 24
                THEN CAST(DATEDIFF(HOUR, A.PostedAt, GETDATE()) AS VARCHAR(10)) + 'h ago'
            ELSE CAST(DATEDIFF(DAY, A.PostedAt, GETDATE()) AS VARCHAR(10)) + 'd ago'
        END AS [TimeAgo]
    FROM [Nishwik].[spe].[DiscussionMaster] AS A
    LEFT JOIN [Nishwik].[dbo].[UserMaster] AS B
        ON A.PostedBy = B.UserId
    WHERE 
        A.IsActive = 1
        AND A.IsDeleted = 0
        AND B.IsActive = 1
        AND B.IsDeleted = 0
        AND A.MasterType = 'Teacher'
    ORDER BY A.PostedAt DESC;
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[DiscussionMaster_ReadAll]
 AS
  BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [DiscussionId]
		,[MasterType]
		,[MasterId]
		,[DiscTitle]
		,[DiscDesc]
		,[PostedBy]
		,[PostedAt]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[DiscussionMaster]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionMaster_ReadByClass]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC  [spe].[DiscussionMaster_ReadByClass]
    @ClassId = 6,
    @SectionId = 6,
    @TopN = 5;

*/
CREATE PROCEDURE [spe].[DiscussionMaster_ReadByClass]
(
    @ClassId INT,
    @SectionId INT = NULL,
    @TopN INT = 10
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT TOP (@TopN)
        PostedBy AS ParentName,
        CASE 
            WHEN DATEDIFF(MINUTE, PostedAt, GETDATE()) < 60
                THEN CAST(DATEDIFF(MINUTE, PostedAt, GETDATE()) AS VARCHAR(10)) + 'm ago'
            WHEN DATEDIFF(HOUR, PostedAt, GETDATE()) < 24
                THEN CAST(DATEDIFF(HOUR, PostedAt, GETDATE()) AS VARCHAR(10)) + 'h ago'
            ELSE CAST(DATEDIFF(DAY, PostedAt, GETDATE()) AS VARCHAR(10)) + 'd ago'
        END AS TimeAgo,
        DiscTitle AS DiscussionTitle
    FROM [spe].[DiscussionMaster]
    WHERE
        IsActive = 1
        AND IsDeleted = 0
        AND MasterType = 'master'       -- updated value
        AND MasterId = @ClassId
        AND (@SectionId IS NULL OR LTRIM(RTRIM(OtherDetail1)) = CAST(@SectionId AS VARCHAR(50)))
    ORDER BY PostedAt DESC;
END
GO
/****** Object:  StoredProcedure [spe].[DiscussionMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[DiscussionMaster_ReadById]
( 
   @DiscussionId INT
)
 AS
  BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [DiscussionId]
		,[MasterType]
		,[MasterId]
		,[DiscTitle]
		,[DiscDesc]
		,[PostedBy]
		,[PostedAt]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[DiscussionMaster]
	WHERE  [DiscussionId] = @DiscussionId
	AND  [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [spe].[DiscussionMaster_ReadByMasterId]
( 
   @MasterId INT,
   @MasterType VARCHAR(50) = NULL,
   @PageSize INT,
   @PageNo INT,
   @WhereClause NVARCHAR(MAX),
   @OrderByClause NVARCHAR(MAX)
)
AS
BEGIN 
    SET NOCOUNT ON;

    DECLARE @Result INT = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);

    -- Build dynamic SQL (same format as original)
    SET @SQL = 
    'SELECT 
        ROW_NUMBER() OVER (ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)),''),'A.DiscussionId DESC') + ') AS RowNum,
        A.[DiscussionId],
        A.[MasterType],
        A.[MasterId],
        A.[DiscTitle],
        A.[DiscDesc],
        A.[PostedBy],
        B.[FirstName] + '' '' + B.[LastName] AS UserName,
        A.[PostedAt],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn],
        COUNT(*) OVER () AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [spe].[DiscussionMaster] A
    LEFT JOIN [dbo].[UserMaster] B
        ON A.PostedBy = B.UserId
    WHERE A.[MasterId] = ' + CAST(@MasterId AS NVARCHAR) + ' ';

    -- Handle NULL MasterType safely
    IF @MasterType IS NOT NULL
        SET @SQL = @SQL + ' AND A.[MasterType] = ''' + @MasterType + ''' ';

    SET @SQL = @SQL + '
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0';

    -- Add dynamic where clause if provided
    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND (' + @WhereClause + ')';

    -- Add ORDER BY and pagination
    SET @SQL = @SQL + '
    ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)),''),'A.DiscussionId DESC') + '
    OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL;
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [spe].[DiscussionMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[DiscussionMaster_Update]
(
    @DiscussionId    INT,
    @MasterType      VARCHAR(50) = NULL,
    @MasterId        INT = NULL,
    @DiscTitle       VARCHAR(500) = NULL,
    @DiscDesc        NVARCHAR(4000) = NULL,
    @PostedBy        VARCHAR(50) = NULL,
    @PostedAt        DATETIME = NULL,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @IsActive        INT = 1,     
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[DiscussionMaster]
    SET
        [MasterType]   = TRIM(@MasterType),
        [MasterId]     = @MasterId,
        [DiscTitle]    = TRIM(@DiscTitle),
        [DiscDesc]     = @DiscDesc,
        [PostedBy]     = TRIM(@PostedBy),
        [PostedAt]     = @PostedAt,
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive]     = @IsActive,      
        [ModifiedBy]   = TRIM(@ActionUser),
        [ModifiedOn]   = GETDATE()
    WHERE [DiscussionId] = @DiscussionId

    SELECT
        [DiscussionId],
        [MasterType],
        [MasterId],
        [DiscTitle],
        [DiscDesc],
        [PostedBy],
        [PostedAt],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[DiscussionMaster]
    WHERE [DiscussionId] = @DiscussionId
	      AND [IsActive] = 1
          AND [IsDeleted] = 0;;
END;
GO
/****** Object:  StoredProcedure [spe].[EventMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[EventMaster_Create]
(
    @SchoolId INT,
    @ClassId INT,
    @SectionId INT,
    @Title NVARCHAR(200),
    @EventCategory VARCHAR(50),
    @EventDate DATE,
    @EventType VARCHAR(20), 
    @Description NVARCHAR(MAX),
    @IsPublished INT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @EventId INT;

    INSERT INTO [spe].[EventMaster]
    (
        [SchoolId],
        [ClassId],
        [SectionId],
        [Title],
        [EventCategory],
        [EventDate],
        [EventType],
        [Description],
        [IsPublished],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @ClassId,
        @SectionId,
        @Title,
        @EventCategory,
        @EventDate,
        @EventType,
        @Description,
        @IsPublished,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,                
        0,                
        @ActionUser,      
        GETDATE()         
    );

    SET @EventId = SCOPE_IDENTITY();

    SELECT
        [EventId],
        [SchoolId],
        [ClassId],
        [SectionId],
        [Title],
        [EventCategory],
        [EventDate],
        [EventType],
        [Description],
        [IsPublished],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[EventMaster]
    WHERE [EventId] = @EventId;
END;
GO
/****** Object:  StoredProcedure [spe].[EventMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[EventMaster_Delete]
(
      @EventId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[EventMaster]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [EventId]  = @EventId
END;
GO
/****** Object:  StoredProcedure [spe].[EventMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[EventMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	       [EventId]
		  ,[SchoolId]
		  ,[ClassId]
		  ,[SectionId]
		  ,[Title]
		  ,[EventCategory]
		  ,[EventDate]
		  ,[EventType]
		  ,[Description]
		  ,[IsPublished]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [spe].[EventMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[EventMaster_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[EventMaster_ReadByClassId]
(
      @ClassId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	       [EventId]
		  ,[SchoolId]
		  ,[ClassId]
		  ,[SectionId]
		  ,[Title]
		  ,[EventCategory]
		  ,[EventDate]
		  ,[EventType]
		  ,[Description]
		  ,[IsPublished]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [spe].[EventMaster]
	WHERE  [ClassId]  = @ClassId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[EventMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[EventMaster_ReadById]
(
      @EventId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	      [EventId]
		  ,[SchoolId]
		  ,[ClassId]
		  ,[SectionId]
		  ,[Title]
		  ,[EventCategory]
		  ,[EventDate]
		  ,[EventType]
		  ,[Description]
		  ,[IsPublished]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [spe].[EventMaster]
	WHERE  [EventId]  = @EventId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[EventMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[EventMaster_ReadBySchoolId]
(
    @SchoolId INT,
    @ClassId INT = NULL,
    @SectionId INT = NULL,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
    SET NOCOUNT ON;

    DECLARE @Offset INT = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);

    -- Base SQL
    SET @SQL = '
    SELECT 
        ROW_NUMBER() OVER (ORDER BY ' + 
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + ') AS RowNum, 
        A.[EventId],
        A.[SchoolId],
        A.[ClassId],
        A.[SectionId],
        A.[Title],
        A.[EventCategory],
        A.[EventDate],
        A.[EventType],
        A.[Description],
        A.[IsPublished],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn],
        COUNT(*) OVER() AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [spe].[EventMaster] A
    WHERE A.[SchoolId] = ' + CAST(@SchoolId AS NVARCHAR) + '
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0
      AND (';


    IF @ClassId IS NULL AND @SectionId IS NULL

        SET @SQL += '1 = 1'; 
    ELSE IF @ClassId IS NOT NULL AND @SectionId IS NULL

        SET @SQL += '(A.ClassId IS NULL AND A.SectionId IS NULL) 
                     OR (A.ClassId = ' + CAST(@ClassId AS NVARCHAR) + ' AND A.SectionId IS NULL)';
    ELSE IF @ClassId IS NOT NULL AND @SectionId IS NOT NULL

        SET @SQL += '(A.ClassId IS NULL AND A.SectionId IS NULL) 
                     OR (A.ClassId = ' + CAST(@ClassId AS NVARCHAR) + ' AND A.SectionId IS NULL)
                     OR (A.ClassId = ' + CAST(@ClassId AS NVARCHAR) + ' AND A.SectionId = ' + CAST(@SectionId AS NVARCHAR) + ')';
    ELSE
        SET @SQL += '1 = 1'; 

    SET @SQL += ')';  


    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL += ' AND ' + @WhereClause;


    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL += ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL += ' ORDER BY A.CreatedOn DESC';


    SET @SQL += '
        OFFSET ' + CAST(@Offset AS NVARCHAR) + ' ROWS
        FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';


    EXEC(@SQL);
END;
GO
/****** Object:  StoredProcedure [spe].[EventMaster_ReadBySectionId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[EventMaster_ReadBySectionId]
(
      @SectionId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	       [EventId]
		  ,[SchoolId]
		  ,[ClassId]
		  ,[SectionId]
		  ,[Title]
		  ,[EventCategory]
		  ,[EventDate]
		  ,[EventType]
		  ,[Description]
		  ,[IsPublished]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	FROM [spe].[EventMaster]
	WHERE  [SectionId]  = @SectionId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[EventMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[EventMaster_Update]
(
    @EventId INT,
    @SchoolId INT,
    @ClassId INT,
    @SectionId INT,
    @Title NVARCHAR(200),
    @EventCategory VARCHAR(50),
    @EventDate DATE,
    @EventType VARCHAR(20), 
    @Description NVARCHAR(MAX),
    @IsPublished INT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[EventMaster]
    SET
        [SchoolId] = @SchoolId,
        [ClassId] = @ClassId,
        [SectionId] = @SectionId,
        [Title] = @Title,
        [EventCategory] = @EventCategory,
        [EventDate] = @EventDate,
        [EventType] = @EventType,
        [Description] = @Description,
        [IsPublished] = @IsPublished,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE
        [EventId] = @EventId;

    -- Return the updated record
    SELECT
        [EventId],
        [SchoolId],
        [ClassId],
        [SectionId],
        [Title],
        [EventCategory],
        [EventDate],
        [EventType],
        [Description],
        [IsPublished],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[EventMaster]
    WHERE [EventId] = @EventId
      AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[EventTimetable_Sync]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[EventTimetable_Sync]
AS
BEGIN
    -- Pull recent timetable changes
    SELECT * FROM [spe].[Timetable]
    WHERE ModifiedOn >= DATEADD(HOUR, -1, GETDATE());
END;
GO
/****** Object:  StoredProcedure [spe].[ExamMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamMaster_Create]
(
    @SchoolId INT,
	@AcademicYear VARCHAR(50),
	@ExamName NVARCHAR(100),
	@ExamType VARCHAR(20),
	@StartDate DATE,
	@EndDate DATE,
	@Status VARCHAR(20),
	@GraceMarks INT,
	@Description VARCHAR(500),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ExamId INT;

    INSERT INTO [spe].[ExamMaster]
    (
        [SchoolId],
        [AcademicYear],
        [ExamName],
        [ExamType],
        [StartDate],
        [EndDate],
        [Status],
		[GraceMarks],
		[Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @AcademicYear,
        @ExamName,
        @ExamType,
        @StartDate,
        @EndDate,
        @Status,
		@GraceMarks,
        @Description,
		@OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @ExamId = SCOPE_IDENTITY();

    SELECT
        [ExamId],
        [SchoolId],
        [AcademicYear],
        [ExamName],
        [ExamType],
        [StartDate],
        [EndDate],
        [Status],
		[GraceMarks],
		[Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ExamMaster]
    WHERE [ExamId] = @ExamId;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamMaster_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamMaster_CreateBulk]
	(
	  @ExamIdList  [spe].[udt_ExamMaster]  READONLY,
      @ActionUser VARCHAR(50)
	)
AS
 BEGIN 
	 SET NOCOUNT ON;
	 INSERT INTO [Nishwik].[spe].[ExamMaster]
	 (
		 [SchoolId]
		,[AcademicYear]
		,[ExamName]
		,[ExamType]
		,[StartDate]
		,[EndDate]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[GraceMarks]
		,[Description]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		)
		SELECT 
		 [SchoolId]
		,[AcademicYear]
		,[ExamName]
		,[ExamType]
		,[StartDate]
		,[EndDate]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[GraceMarks]
		,[Description]
		,1
		,0
		,@ActionUser
		,GETDATE()
		FROM  @ExamIdList;

		SELECT 
		 [ExamId]
		,[SchoolId]
		,[AcademicYear]
		,[ExamName]
		,[ExamType]
		,[StartDate]
		,[EndDate]
		,[Status]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[GraceMarks]
		,[Description]
	 FROM   [Nishwik].[spe].[ExamMaster]
	  WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [spe].[ExamMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamMaster_Delete]
(
      @ExamId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[ExamMaster]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [ExamId]  = @ExamId
END;
GO
/****** Object:  StoredProcedure [spe].[ExamMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ExamId]
      ,[SchoolId]
      ,[AcademicYear]
      ,[ExamName]
      ,[ExamType]
      ,[StartDate]
      ,[EndDate]
      ,[Status]
	  ,[GraceMarks]
	  ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[ExamMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [spe].[ExamMaster_ReadAllPaginated]
(
    @SchoolId INT,
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL
)
AS
 BEGIN 
		SET NOCOUNT ON; 
		DECLARE @Result INT = 0, @TotalCount INT = 0;
		SET @Result = (@PageNo - 1) * @PageSize;
		SET NOCOUNT ON;

		DECLARE @SQL NVARCHAR(MAX);
		SET @SQL =
		'SELECT 
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum,
			 [ExamId]
			 ,[SchoolId]
			 ,[AcademicYear]
			 ,[ExamName]
			 ,[ExamType]
			 ,[StartDate]
			 ,[EndDate]
			 ,[Status]
			 ,[GraceMarks]
			 ,[Description]
			 ,[OtherDetail1]
			 ,[OtherDetail2]
			 ,[OtherDetail3]
			 ,[OtherDetail4]
			 ,[OtherDetail5]
			 ,[OtherDetail6]
			 ,[IsActive]
			 ,[IsDeleted]
			 ,[CreatedBy]
			 ,[CreatedOn]
			 ,[ModifiedBy]
			 ,[ModifiedOn]
		,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [spe].[ExamMaster]
		WHERE [SchoolId] = ' + CAST(@SchoolId AS NVARCHAR) + '
		AND [IsActive] = 1';

	
		IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

		IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
		SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
		ELSE
		SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

		SET @SQL = @SQL + '
		OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
		FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

		PRINT @SQL
		EXEC sp_executesql @SQL;

END;
GO
/****** Object:  StoredProcedure [spe].[ExamMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamMaster_ReadById]
(
      @ExamId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ExamId]
      ,[SchoolId]
      ,[AcademicYear]
      ,[ExamName]
      ,[ExamType]
      ,[StartDate]
      ,[EndDate]
      ,[Status]
	  ,[GraceMarks]
	  ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[ExamMaster]
	WHERE  [ExamId]  = @ExamId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamMaster_ReadBySchoolId]
(
      @SchoolId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ExamId]
      ,[SchoolId]
      ,[AcademicYear]
      ,[ExamName]
      ,[ExamType]
      ,[StartDate]
      ,[EndDate]
      ,[Status]
	  ,[GraceMarks]
	  ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[ExamMaster]
	WHERE  [SchoolId]  = @SchoolId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamMaster_Update]
(
    @ExamId INT,
	@SchoolId INT,
	@AcademicYear VARCHAR(50),
	@ExamName NVARCHAR(100),
	@ExamType VARCHAR(20),
	@StartDate DATE,
	@EndDate DATE,
	@Status VARCHAR(20), 
	@GraceMarks INT,
    @Description VARCHAR(500),
	@OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[ExamMaster]
    SET
        [SchoolId] = @SchoolId,
        [AcademicYear] = @AcademicYear,
        [ExamName] = @ExamName,
        [ExamType] = @ExamType,
        [StartDate] = @StartDate,
        [EndDate] = @EndDate,
        [Status] = @Status,
		[GraceMarks] = @GraceMarks,
		[Description] = @Description,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [ExamId] = @ExamId;

    SELECT
        [ExamId],
        [SchoolId],
        [AcademicYear],
        [ExamName],
        [ExamType],
        [StartDate],
        [EndDate],
        [Status],
		[GraceMarks],
		[Description],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ExamMaster]
    WHERE [ExamId] = @ExamId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamSchedule_Create]
(
    @ExamId INT,
	@ClassId INT,
	@SectionId INT,
	@SubjectId INT,
	@ExamDate DATE,
	@TotalMarks DECIMAL(5,2),
	@Duration INT,
	@Weightage DECIMAL(5,2),
	@Description VARCHAR(500),
	@IsPublished   INT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ScheduleId INT;

    INSERT INTO [spe].[ExamSchedule]
    (
        [ExamId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [ExamDate],
        [TotalMarks],
        [Duration],
        [Weightage],
		[Description],
		[IsPublished],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ExamId,
        @ClassId,
        @SectionId,
        @SubjectId,
        @ExamDate,
        @TotalMarks,
        @Duration,
        @Weightage,
		@Description,
		@IsPublished ,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @ScheduleId = SCOPE_IDENTITY();

    SELECT
        [ScheduleId],
        [ExamId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [ExamDate],
        [TotalMarks],
        [Duration],
        [Weightage],
		[Description],
		[IsPublished] ,
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ExamSchedule]
    WHERE [ScheduleId] = @ScheduleId;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamSchedule_Delete]
(
      @ScheduleId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[ExamSchedule]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [ScheduleId]  = @ScheduleId
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_PublishResult]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[ExamSchedule_PublishResult]
    @ExamId = 5,
    @ClassId = 1107,
    @SectionId = 1024;

	EXEC [spe].[ExamSchedule_PublishResult]
    @ExamId = 5,
    @ClassId = 1107,
    @SectionId = 1025;
	*/
CREATE PROCEDURE [spe].[ExamSchedule_PublishResult]
(
    @ExamId INT,
    @ClassId INT,
    @SectionId INT = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    --BEGIN TRY
    --    BEGIN TRANSACTION;

        ;WITH ActiveSchedules AS (
            SELECT ScheduleId, SubjectId, SectionId
            FROM [Nishwik].[spe].[ExamSchedule]
            WHERE ExamId = @ExamId
              AND ClassId = @ClassId
              AND IsActive = 1
              AND IsDeleted = 0
              AND (@SectionId IS NULL OR SectionId = @SectionId)
        ),
        StudentCount AS (
            SELECT COUNT(DISTINCT SCM.UserId) AS TotalStudents
            FROM [Nishwik].[spe].[StudentClassMapping] SCM
            WHERE SCM.ClassId = @ClassId
              AND SCM.IsActive = 1
              AND SCM.IsDeleted = 0
              AND (@SectionId IS NULL OR SCM.SectionId = @SectionId)
        ),
        MarksSummary AS (
            SELECT 
                SEM.ScheduleId,
                COUNT(DISTINCT SEM.StudentId) AS TotalMarksEntries,
                SUM(CASE WHEN SEM.IsConfirm = 1 THEN 1 ELSE 0 END) AS ConfirmedStudents
            FROM [Nishwik].[spe].[StudentExamMarks] SEM
            WHERE SEM.IsActive = 1
              AND SEM.IsDeleted = 0
            GROUP BY SEM.ScheduleId
        ),
        Validation AS (
            SELECT 
                S.ScheduleId,
                S.SubjectId,
                SC.TotalStudents,
                ISNULL(M.TotalMarksEntries, 0) AS TotalMarksEntries,
                ISNULL(M.ConfirmedStudents, 0) AS ConfirmedStudents
            FROM ActiveSchedules S
            CROSS JOIN StudentCount SC
            LEFT JOIN MarksSummary M ON S.ScheduleId = M.ScheduleId
        ),
        Pending AS (
            SELECT 
                V.ScheduleId,
                V.SubjectId,
                CASE 
                    WHEN V.TotalMarksEntries < V.TotalStudents THEN 
                        'Not all students have mark entries.'
                    WHEN V.ConfirmedStudents < V.TotalStudents THEN 
                        'Some students have unconfirmed marks.'
                    ELSE 
                        'Unknown pending issue.'
                END AS PendingReason
            FROM Validation V
            WHERE 
                V.TotalMarksEntries < V.TotalStudents
                OR V.ConfirmedStudents < V.TotalStudents
        )
        SELECT * INTO #PendingSchedules FROM Pending;

        -- ========================================================
        -- STEP 67: Update Logic (Publish Logic)
        -- ========================================================

		IF NOT EXISTS (SELECT 1 FROM  #PendingSchedules)
		BEGIN
			 UPDATE ES
			SET ES.IsPublished = CASE WHEN P.ScheduleId IS NULL THEN 1 ELSE 0 END
			FROM [Nishwik].[spe].[ExamSchedule] ES
			LEFT JOIN #PendingSchedules P ON ES.ScheduleId = P.ScheduleId
			WHERE ES.ExamId = @ExamId
			  AND ES.ClassId = @ClassId
			  AND ES.IsActive = 1
			  AND ES.IsDeleted = 0
			  AND (@SectionId IS NULL OR ES.SectionId = @SectionId);

		END
		ELSE
		BEGIN

			DECLARE @ErrMsg VARCHAR(500);
			SELECT @ErrMsg = STRING_AGG(PendingReason, CHAR(13) + CHAR(10)) FROM #PendingSchedules GROUP BY PendingReason;
			RAISERROR(@ErrMsg, 16, 1)
		END


        -- ========================================================
        -- STEP 8: Return Results & Message
        -- ========================================================
        --SELECT ScheduleId, SubjectId, PendingReason 
        --FROM #PendingSchedules;

        --SELECT ScheduleId, SubjectId, IsPublished
        --FROM [Nishwik].[spe].[ExamSchedule]
        --WHERE ExamId = @ExamId 
        --  AND ClassId = @ClassId
        --  AND (@SectionId IS NULL OR SectionId = @SectionId);

        --IF NOT EXISTS (SELECT 1 FROM #PendingSchedules)
        --    PRINT ' All schedules published successfully.';
        --ELSE
        --    PRINT ' Some schedules are pending due to missing or unconfirmed marks.';

        --DROP TABLE #PendingSchedules;

        --COMMIT TRANSACTION;
    --END TRY
    --BEGIN CATCH
    --    ROLLBACK TRANSACTION;

    --    DECLARE 
    --        @ErrorMessage NVARCHAR(4000),
    --        @ErrorSeverity INT,
    --        @ErrorState INT;

    --    SELECT 
    --        @ErrorMessage = ERROR_MESSAGE(),
    --        @ErrorSeverity = ERROR_SEVERITY(),
    --        @ErrorState = ERROR_STATE();

    --    RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);
    --END CATCH
END
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamSchedule_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ScheduleId]
      ,[ExamId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[ExamDate]
      ,[TotalMarks]
      ,[Duration]
      ,[Weightage]
	  ,[Description]
	  ,[IsPublished]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[ExamSchedule]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[ExamSchedule_ReadAllPaginated]
(
    @ClassId INT,
    @SectionId INT = NULL,
	@ExamId INT = NULL,
    @SubjectId INT = NULL,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Offset INT = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);
	DECLARE @Params NVARCHAR(MAX);

    SET @SQL = '
    SELECT 
        ROW_NUMBER() OVER (ORDER BY ' + 
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + ') AS RowNum,
        A.[ScheduleId],
        A.[ExamId],
        A.[ClassId],
        A.[SectionId],
        A.[SubjectId],
        A.[ExamDate],
        A.[TotalMarks],
        A.[Duration],
        A.[Weightage],
        A.[Description],
		A.[IsPublished],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn],
        B.[ExamName],
        B.[ExamType],
        C.[SectionName],
        D.[ClassName],
        E.[SubjectName],
        COUNT(*) OVER() AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [spe].[ExamSchedule] A
    LEFT JOIN [spe].[ExamMaster] B ON A.ExamId = B.ExamId
    LEFT JOIN [spe].[SectionMaster] C ON A.SectionId = C.SectionId
    LEFT JOIN [spe].[ClassMaster] D ON A.ClassId = D.ClassId
    LEFT JOIN [spe].[SubjectMaster] E ON A.SubjectId = E.SubjectId
    WHERE A.[ClassId] = ' + CAST(@ClassId AS NVARCHAR) + '
      AND A.[IsActive] = 1';

    -- Section filter if provided
    IF @SectionId IS NOT NULL
        SET @SQL = @SQL + ' AND A.[SectionId] = ' + CAST(@SectionId AS NVARCHAR);
	
	IF @ExamId IS NOT NULL
        SET @SQL = @SQL + ' AND A.[ExamId] = @ExamId';

    IF @SubjectId IS NOT NULL
        SET @SQL = @SQL + ' AND A.[SubjectId] = @SubjectId';

    -- Extra filters
    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    -- Order by
    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    -- Pagination
    SET @SQL = @SQL + '
        OFFSET ' + CAST(@Offset AS NVARCHAR) + ' ROWS
        FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	SET @Params = N'@ClassId INT, @SectionId INT, @ExamId INT, @SubjectId INT, @PageSize INT, @PageNo INT, @Offset INT'; 

    PRINT @SQL;
    EXEC sp_executesql
		@SQL,
        @Params,
        @ClassId=@ClassId,
        @SectionId=@SectionId,
        @ExamId=@ExamId,
        @SubjectId=@SubjectId,
        @PageSize=@PageSize,
        @PageNo=@PageNo,
        @Offset=@Offset;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[ExamSchedule_ReadByClassId]
(
    @ClassId INT,
    @SectionId INT = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
         A.[ScheduleId]
        ,A.[ExamId]
        ,A.[ClassId]
        ,A.[SectionId]
        ,A.[SubjectId]
        ,A.[ExamDate]
        ,A.[TotalMarks]
        ,A.[Duration]
        ,A.[Weightage]
        ,A.[Description]
		,A.[IsPublished]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
        ,B.[ExamName]
        ,B.[ExamType]
        ,C.[SectionName]
        ,D.[ClassName]
        ,E.[SubjectName]
    FROM [spe].[ExamSchedule]A
    LEFT JOIN [spe].[ExamMaster]B ON A.ExamId = B.ExamId
    LEFT JOIN [spe].[SectionMaster]C ON A.SectionId = C.SectionId
    LEFT JOIN [spe].[ClassMaster]D ON A.ClassId = D.ClassId
    LEFT JOIN [spe].[SubjectMaster]E ON A.SubjectId = E.SubjectId
    WHERE A.[ClassId] = @ClassId
      AND A.[IsActive] = 1
      AND (@SectionId IS NULL OR A.[SectionId] = @SectionId);
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_ReadByExamId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamSchedule_ReadByExamId]
(
      @ExamId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ScheduleId]
      ,[ExamId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[ExamDate]
      ,[TotalMarks]
      ,[Duration]
      ,[Weightage]
	  ,[Description]
	  ,[IsPublished] 
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[ExamSchedule]
	WHERE  [ExamId]  = @ExamId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamSchedule_ReadById]
(
      @ScheduleId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   A.[ScheduleId]
        ,A.[ExamId]
        ,A.[ClassId]
        ,A.[SectionId]
        ,A.[SubjectId]
        ,A.[ExamDate]
        ,A.[TotalMarks]
        ,A.[Duration]
        ,A.[Weightage]
        ,A.[Description]
		,A.[IsPublished]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
        ,B.[ExamName]
        ,B.[ExamType]
        ,C.[SectionName]
        ,D.[ClassName]
        ,E.[SubjectName]
    FROM [spe].[ExamSchedule]A
    LEFT JOIN [spe].[ExamMaster]B ON A.ExamId = B.ExamId
    LEFT JOIN [spe].[SectionMaster]C ON A.SectionId = C.SectionId
    LEFT JOIN [spe].[ClassMaster]D ON A.ClassId = D.ClassId
    LEFT JOIN [spe].[SubjectMaster]E ON A.SubjectId = E.SubjectId
	WHERE  A.[ScheduleId]  = @ScheduleId
	AND A.[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_ReadBySubjectId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamSchedule_ReadBySubjectId]
(
      @SubjectId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [ScheduleId]
      ,[ExamId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[ExamDate]
      ,[TotalMarks]
      ,[Duration]
      ,[Weightage]
	  ,[Description]
	  ,[IsPublished]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[ExamSchedule]
	WHERE  [SubjectId]  = @SubjectId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ExamSchedule_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ExamSchedule_Update]
(
    @ScheduleId INT,
	@ExamId INT,
	@ClassId INT,
	@SectionId INT,
	@SubjectId INT,
	@ExamDate DATE,
	@TotalMarks DECIMAL(5,2),
	@Duration INT,
	@Weightage DECIMAL(5,2),
	@Description VARCHAR(500),
	@IsPublished   int,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[ExamSchedule]
    SET
        [ExamId] = @ExamId,
        [ClassId] = @ClassId,
        [SectionId] = @SectionId,
        [SubjectId] =@SubjectId,
        [ExamDate] = @ExamDate,
        [TotalMarks] = @TotalMarks,
        [Duration] = @Duration,
        [Weightage] = @Weightage,
		[Description] = @Description,
		[IsPublished] = @IsPublished ,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [ScheduleId] = @ScheduleId;

    SELECT
        [ScheduleId],
        [ExamId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [ExamDate],
        [TotalMarks],
        [Duration],
        [Weightage],
		[Description],
		[IsPublished],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ExamSchedule]
    WHERE [ScheduleId] = @ScheduleId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponent_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeComponent_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [FeeComponentId]
      ,[InstallmentId]
      ,[ComponentName]
      ,[Amount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[FeeComponent]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponent_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeComponent_ReadById]
(
      @FeeComponentId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [FeeComponentId]
      ,[FeeStructureId]
      ,[ComponentName]
      ,[Amount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[FeeComponent]
	  WHERE [FeeComponentId] = @FeeComponentId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponent_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[FeeComponent_Update]
(
    @FeeComponentId   INT,
    @FeeStructureId   INT,
    @ComponentName    NVARCHAR(50),
    @Amount           DECIMAL(18, 2),
    @Remarks          NVARCHAR(255),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[FeeComponent]
    SET
        [FeeStructureId] = @FeeStructureId,
        [ComponentName]  = @ComponentName,
        [Amount]         = @Amount,
        [Remarks]        = @Remarks,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE
        [FeeComponentId] = @FeeComponentId;

    SELECT
        [FeeComponentId],
        [FeeStructureId],
        [ComponentName],
        [Amount],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[FeeComponent]
    WHERE [FeeComponentId] = @FeeComponentId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponentMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [spe].[FeeComponentMaster_Create]
(
    @InstallmentId  INT,
    @ComponentName   NVARCHAR(50),
    @Amount          DECIMAL(18, 2),
    @Remarks         NVARCHAR(255),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FeeComponentId INT;

    INSERT INTO [spe].[FeeComponentMaster]
    (
        [InstallmentId],
        [ComponentName],
        [Amount],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @InstallmentId,
        @ComponentName,
        @Amount,
        @Remarks,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,               
        0,               
        @ActionUser,
        GETDATE()
    );

    SET @FeeComponentId = SCOPE_IDENTITY();

    SELECT
        [FeeComponentId],
        [InstallmentId],
        [ComponentName],
        [Amount],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[FeeComponentMaster]
    WHERE [FeeComponentId] = @FeeComponentId;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponentMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeComponentMaster_Delete]
(
   @FeeComponentId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
  SET NOCOUNT ON;

    UPDATE[spe].[FeeComponentMaster]
	SET 
			[IsActive] = 0,
			[IsDeleted] = 1,
			[ModifiedBy] = @ActionUser,
			[ModifiedOn] = GETDATE()
	WHERE [FeeComponentId] = @FeeComponentId;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponentMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[FeeComponentMaster_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [FeeComponentId]
      ,[InstallmentId]
      ,[ComponentName]
      ,[Amount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[FeeComponentMaster]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponentMaster_ReadByComponentName]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[FeeComponentMaster_ReadByComponentName]
(
      @ComponentName NVARCHAR(50)
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [FeeComponentId]
      ,[InstallmentId]
      ,[ComponentName]
      ,[Amount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[FeeComponentMaster]
	  WHERE [ComponentName] = @ComponentName
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponentMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[FeeComponentMaster_ReadById]
(
      @FeeComponentId INT
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [FeeComponentId]
      ,[InstallmentId]
      ,[ComponentName]
      ,[Amount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[FeeComponentMaster]
	  WHERE [FeeComponentId] = @FeeComponentId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponentMaster_ReadByInstallmentId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[FeeComponentMaster_ReadByInstallmentId]
(
      @InstallmentId int
)
AS
 BEGIN 
   SET NOCOUNT ON;
   SELECT
       [FeeComponentId]
      ,[InstallmentId]
      ,[ComponentName]
      ,[Amount]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[FeeComponentMaster]
	  WHERE [InstallmentId] = @InstallmentId
	  AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeComponentMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [spe].[FeeComponentMaster_Update]
(
    @FeeComponentId   INT,
    @InstallmentId   INT,
    @ComponentName    NVARCHAR(50),
    @Amount           DECIMAL(18, 2),
    @Remarks          NVARCHAR(255),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[FeeComponentMaster]
    SET
        [InstallmentId] = @InstallmentId,
        [ComponentName]  = @ComponentName,
        [Amount]         = @Amount,
        [Remarks]        = @Remarks,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE
        [FeeComponentId] = @FeeComponentId;

    SELECT
        [FeeComponentId],
        [InstallmentId],
        [ComponentName],
        [Amount],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[FeeComponentMaster]
    WHERE [FeeComponentId] = @FeeComponentId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[Feedback_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Feedback_Create]
(
	@MasterId INT,
	@MasterType VARCHAR(20),
	@TeacherId INT,
	@SchoolId INT,
	@Rating INT,
	@Feedback NVARCHAR(max),
	@FeedbackType NVARCHAR(50),
	@Status NVARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FeedbackId INT;

    INSERT INTO [spe].[Feedback]
    (
        [MasterId],
        [MasterType],
        [TeacherId],
        [SchoolId],
        [Rating],
        [Feedback],
        [FeedbackType],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterId,
        @MasterType,
        @TeacherId,
        @SchoolId,
        @Rating,
        @Feedback,
        @FeedbackType,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @FeedbackId = SCOPE_IDENTITY();

    SELECT
        [FeedbackId],
        [MasterId],
        [MasterType],
        [TeacherId],
        [SchoolId],
        [Rating],
        [Feedback],
        [FeedbackType],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[Feedback]
    WHERE [FeedbackId] = @FeedbackId;
END;
GO
/****** Object:  StoredProcedure [spe].[Feedback_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Feedback_Delete]
(
  @FeedbackId INT,
  @ActionUser VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[Feedback]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [FeedbackId] = @FeedbackId
END;
GO
/****** Object:  StoredProcedure [spe].[Feedback_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Feedback_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [FeedbackId]
      ,[MasterId]
      ,[MasterType]
      ,[TeacherId]
      ,[SchoolId]
      ,[Rating]
      ,[Feedback]
      ,[FeedbackType]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[Feedback]
	WHERE [IsActive] = 1
	AND [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Feedback_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Feedback_ReadById]
(
  @FeedbackId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [FeedbackId]
      ,[MasterId]
      ,[MasterType]
      ,[TeacherId]
      ,[SchoolId]
      ,[Rating]
      ,[Feedback]
      ,[FeedbackType]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[Feedback]
	WHERE [FeedbackId] = @FeedbackId
    AND[IsActive] = 1
    AND [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Feedback_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Feedback_ReadByMasterId]
(
  @MasterId INT,
  @MasterType VARCHAR(20)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [FeedbackId]
      ,[MasterId]
      ,[MasterType]
      ,[TeacherId]
      ,[SchoolId]
      ,[Rating]
      ,[Feedback]
      ,[FeedbackType]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[Feedback]
	WHERE [MasterId] = @MasterId
	AND [MasterType] = @MasterType
    AND  [IsActive] = 1
    AND  [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Feedback_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Feedback_ReadBySchoolId]
(
    @SchoolId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        A.[FeedbackId],
        A.[MasterId],
        B.[FirstName]+ ' '+ B.[LastName]  AS MasterName,         -- Master name from UserMaster
        A.[MasterType],
        A.[TeacherId],
        C.[FirstName]+ ' '+ C.[LastName]  AS TeacherName,        -- Teacher name from UserMaster
        A.[SchoolId],
        D.[SchoolName],                      -- School name from SchoolMaster
        A.[Rating],
        A.[Feedback],
        A.[FeedbackType],
        A.[Status],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn]
    FROM [spe].[Feedback] A
    LEFT JOIN [dbo].[UserMaster] B
        ON A.MasterId = B.UserId
        AND B.IsActive = 1
    LEFT JOIN [dbo].[UserMaster] C
        ON A.TeacherId = C.UserId
        AND C.IsActive = 1
    LEFT JOIN [Nishwik].[spe].[SchoolMaster] D
        ON A.SchoolId = D.SchoolId
    WHERE A.[SchoolId] = @SchoolId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[Feedback_ReadByTeacherId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Feedback_ReadByTeacherId]
(
  @TeacherId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [FeedbackId]
      ,[MasterId]
      ,[MasterType]
      ,[TeacherId]
      ,[SchoolId]
      ,[Rating]
      ,[Feedback]
      ,[FeedbackType]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[Feedback]
	WHERE [TeacherId] = @TeacherId
    AND  [IsActive] = 1
    AND  [IsDeleted]  = 0 
END;
GO
/****** Object:  StoredProcedure [spe].[Feedback_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Feedback_Update]
(
    @FeedbackId INT,
	@MasterId INT,
	@MasterType VARCHAR(20),
	@TeacherId INT,
	@SchoolId INT,
	@Rating INT,
	@Feedback NVARCHAR(max),
	@FeedbackType NVARCHAR(50),
	@Status NVARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[Feedback]
    SET
        [MasterId] = @MasterId,
        [MasterType] = @MasterType,
        [TeacherId] = @TeacherId,
        [SchoolId] = @SchoolId,
        [Rating] = @Rating,
        [Feedback] = @Feedback,
        [FeedbackType] =@FeedbackType,
        [Status] = @Status,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [FeedbackId] = @FeedbackId;

    SELECT
        [FeedbackId],
        [MasterId],
        [MasterType],
        [TeacherId],
        [SchoolId],
        [Rating],
        [Feedback],
        [FeedbackType],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[Feedback]
    WHERE [FeedbackId] = @FeedbackId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeInstallmentMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [spe].[FeeInstallmentMaster_Create]
(
    @FeeStructureId   INT,
    @InstallmentName  VARCHAR(100),
    @Amount           DECIMAL(18, 2),
    @Remarks          VARCHAR(500),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @InstallmentId INT;

    INSERT INTO [spe].[FeeInstallmentMaster]
    (
        [FeeStructureId],
        [InstallmentName],
        [Amount],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @FeeStructureId,
        @InstallmentName,
        @Amount,
        @Remarks,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,    
        GETDATE()       
    );

    SET @InstallmentId = SCOPE_IDENTITY();

    SELECT
        [InstallmentId],
        [FeeStructureId],
        [InstallmentName],
        [Amount],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[FeeInstallmentMaster]
    WHERE [InstallmentId] = @InstallmentId;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeInstallmentMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeInstallmentMaster_Delete]
(
     @InstallmentId INT,
	 @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE[spe].[FeeInstallmentMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE[InstallmentId] = @InstallmentId
END;
GO
/****** Object:  StoredProcedure [spe].[FeeInstallmentMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeInstallmentMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [InstallmentId]
		,[FeeStructureId]
		,[InstallmentName]
		,[Amount]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM[spe].[FeeInstallmentMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeInstallmentMaster_ReadByFeeStructureId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeInstallmentMaster_ReadByFeeStructureId]
(
     @FeeStructureId  INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [InstallmentId]
		,[FeeStructureId]
		,[InstallmentName]
		,[Amount]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[FeeInstallmentMaster]
	WHERE[FeeStructureId] = @FeeStructureId
	AND  [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeInstallmentMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeInstallmentMaster_ReadById]
(
     @InstallmentId  INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [InstallmentId]
		,[FeeStructureId]
		,[InstallmentName]
		,[Amount]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[FeeInstallmentMaster]
	WHERE[InstallmentId] = @InstallmentId
	AND  [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeInstallmentMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [spe].[FeeInstallmentMaster_Update]
(
    @InstallmentId     INT,
    @FeeStructureId    INT,
    @InstallmentName   VARCHAR(100),
    @Amount            DECIMAL(18, 2),
    @Remarks           VARCHAR(500),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[FeeInstallmentMaster]
    SET
        [FeeStructureId] = @FeeStructureId,
        [InstallmentName] = @InstallmentName,
        [Amount] = @Amount,
        [Remarks] = @Remarks,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [InstallmentId] = @InstallmentId;

    SELECT
        [InstallmentId],
        [FeeStructureId],
        [InstallmentName],
        [Amount],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[FeeInstallmentMaster]
    WHERE [InstallmentId] = @InstallmentId
	 AND  [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeStructureMaster_ClonerByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[FeeStructureMaster_ClonerByClassId]
      @SourceClassId = 20,        -- class you want to copy FROM
      @TargetClassId = 3403,        -- class you want to copy TO
      @ActionUser    = '';  -- user performing the action

*/
CREATE PROCEDURE [spe].[FeeStructureMaster_ClonerByClassId]
(
      @SourceClassId INT
    , @TargetClassId INT
    , @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    ---------------------------------------------------------
    -- CHECK: Source class must have fee structure
    ---------------------------------------------------------
    IF NOT EXISTS 
    (
        SELECT 1
        FROM [spe].[FeeStructureMaster]
        WHERE ClassId = @SourceClassId
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('No fee structure found for this class.', 16, 1);
        RETURN;
    END;


	  IF EXISTS
    (
        SELECT 1
        FROM [spe].[FeeStructureMaster]
        WHERE ClassId = @TargetClassId
          AND IsDeleted = 0
          AND IsActive = 1
    )
    BEGIN
        RAISERROR('Fee structure already exists for the target class. Duplicate cloning prevented.', 16, 1);
        RETURN;
    END;

    ---------------------------------------------------------
    -- STEP 1: CLONE FEE STRUCTURE
    ---------------------------------------------------------
    INSERT INTO [spe].[FeeStructureMaster]
    (
          ClassId
        , FeeType
        , Frequency
        , Amount
        , ApplicableFrom
        , ApplicableTo
        , Remarks
        , OtherDetail1
        , OtherDetail2
        , OtherDetail3
        , OtherDetail4
        , OtherDetail5
        , OtherDetail6
        , IsActive
        , IsDeleted
        , CreatedBy
        , CreatedOn
        , FName
        , IsMandatory
    )
    SELECT
          @TargetClassId
        , FeeType
        , Frequency
        , Amount
        , ApplicableFrom
        , ApplicableTo
        , Remarks
        , OtherDetail1
        , OtherDetail2
        , OtherDetail3
        , OtherDetail4
        , OtherDetail5
        , OtherDetail6
        , IsActive
        , 0                 -- IsDeleted
        , @ActionUser
        , GETDATE()
        , FName
        , IsMandatory
    FROM [spe].[FeeStructureMaster]
    WHERE ClassId = @SourceClassId
      AND IsDeleted = 0
	  AND IsActive = 1;

    ---------------------------------------------------------
    -- STEP 2: CLONE INSTALLMENTS
    ---------------------------------------------------------
    INSERT INTO [spe].[FeeInstallmentMaster]
    (
          FeeStructureId
        , InstallmentName
        , Amount
        , Remarks
        , OtherDetail1
        , OtherDetail2
        , OtherDetail3
        , OtherDetail4
        , OtherDetail5
        , OtherDetail6
        , IsActive
        , IsDeleted
        , CreatedBy
        , CreatedOn
    )
    SELECT
          fsNew.FeeStructureId
        , inst.InstallmentName
        , inst.Amount
        , inst.Remarks
        , inst.OtherDetail1
        , inst.OtherDetail2
        , inst.OtherDetail3
        , inst.OtherDetail4
        , inst.OtherDetail5
        , inst.OtherDetail6
        , inst.IsActive
        , 0
        , @ActionUser
        , GETDATE()
    FROM [spe].[FeeInstallmentMaster] inst
    INNER JOIN [spe].[FeeStructureMaster] fsOld 
        ON inst.FeeStructureId = fsOld.FeeStructureId
       AND fsOld.ClassId = @SourceClassId
       AND fsOld.IsDeleted = 0
    INNER JOIN [spe].[FeeStructureMaster] fsNew
        ON fsNew.FeeType = fsOld.FeeType
       AND fsNew.ClassId = @TargetClassId
       AND fsNew.IsDeleted = 0
    WHERE inst.IsDeleted = 0
	AND  inst.IsActive = 1;

    ---------------------------------------------------------
    -- STEP 3: CLONE COMPONENTS
    ---------------------------------------------------------
       INSERT INTO [spe].[FeeComponentMaster]
    (
          InstallmentId
        , ComponentName
        , Amount
        , Remarks
        , OtherDetail1
        , OtherDetail2
        , OtherDetail3
        , OtherDetail4
        , OtherDetail5
        , OtherDetail6
        , IsActive
        , IsDeleted
        , CreatedBy
        , CreatedOn
    )
    SELECT
          instNew.InstallmentId
        , comp.ComponentName
        , comp.Amount
        , comp.Remarks
        , comp.OtherDetail1
        , comp.OtherDetail2
        , comp.OtherDetail3
        , comp.OtherDetail4
        , comp.OtherDetail5
        , comp.OtherDetail6
        , comp.IsActive
        , 0
        , @ActionUser
        , GETDATE()
    FROM [spe].[FeeComponentMaster] comp
    INNER JOIN [spe].[FeeInstallmentMaster] instOld
        ON comp.InstallmentId = instOld.InstallmentId
    INNER JOIN [spe].[FeeInstallmentMaster] instNew
        ON instNew.InstallmentName = instOld.InstallmentName
       AND instNew.FeeStructureId =
           (SELECT FeeStructureId 
            FROM [spe].[FeeStructureMaster]
            WHERE ClassId = @TargetClassId
              AND FeeType =
                  (SELECT FeeType 
                   FROM [spe].[FeeStructureMaster]
                   WHERE FeeStructureId = instOld.FeeStructureId)
              AND IsDeleted = 0)
    WHERE comp.IsDeleted = 0
      AND comp.IsActive = 1;
END 
GO
/****** Object:  StoredProcedure [spe].[FeeStructureMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[FeeStructureMaster_Create]
(
    @ClassId         INT,
    @FeeType         VARCHAR(50),
    @Frequency       VARCHAR(50),
    @Amount          DECIMAL(18, 2),
    @ApplicableFrom  DATETIME,
    @ApplicableTo    DATETIME,
    @Remarks         VARCHAR(500),
	@FName           VARCHAR(100),
	@IsMandatory     INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FeeStructureId INT;

    INSERT INTO [spe].[FeeStructureMaster]
    (
        [ClassId],
        [FeeType],
        [Frequency],
        [Amount],
        [ApplicableFrom],
        [ApplicableTo],
        [Remarks],
		[FName],
	    [IsMandatory],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ClassId,
        @FeeType,
        @Frequency,
        @Amount,
        @ApplicableFrom,
        @ApplicableTo,
        @Remarks,
		@FName,
		@IsMandatory,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,
        GETDATE()
    );

    SET @FeeStructureId = SCOPE_IDENTITY();

    SELECT
        [FeeStructureId],
        [ClassId],
        [FeeType],
        [Frequency],
        [Amount],
        [ApplicableFrom],
        [ApplicableTo],
        [Remarks],
		[FName],
		[IsMandatory],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[FeeStructureMaster]
    WHERE [FeeStructureId] = @FeeStructureId;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeStructureMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeStructureMaster_Delete]
(
   @FeeStructureId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE[spe].[FeeStructureMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE  [FeeStructureId] = @FeeStructureId
END;
GO
/****** Object:  StoredProcedure [spe].[FeeStructureMaster_FeeClassListing]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[spe].[FeeStructureMaster_FeeClassListing]5
*/
CREATE PROCEDURE [spe].[FeeStructureMaster_FeeClassListing]
(
    @SchoolId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT DISTINCT
	    A.ClassId ,
        A.ClassName  AS [ClassName]
    FROM [spe].[ClassMaster] AS A
    INNER JOIN [spe].[FeeStructureMaster] AS B
        ON A.ClassId = B.ClassId
        AND B.IsActive = 1
        AND B.IsDeleted = 0
    WHERE 
        A.SchoolId = @SchoolId
        AND A.IsActive = 1
        AND A.IsDeleted = 0
    ORDER BY [ClassName];
END;
GO
/****** Object:  StoredProcedure [spe].[FeeStructureMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeStructureMaster_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
	SELECT
		 [FeeStructureId]
		,[ClassId]
		,[FeeType]
		,[Frequency]
		,[Amount]
		,[ApplicableFrom]
		,[ApplicableTo]
		,[Remarks]
		,[IsMandatory]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[FName]
	FROM [spe].[FeeStructureMaster]
	WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeStructureMaster_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeStructureMaster_ReadByClassId]
(
   @ClassId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
	SELECT
		 [FeeStructureId]
		,[ClassId]
		,[FeeType]
		,[Frequency]
		,[Amount]
		,[ApplicableFrom]
		,[ApplicableTo]
		,[Remarks]
	    ,[IsMandatory]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[FName]
	FROM [spe].[FeeStructureMaster]
	WHERE  [ClassId] = @ClassId
	AND  [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeStructureMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[FeeStructureMaster_ReadById]
(
   @FeeStructureId INT
)
AS
 BEGIN
  SET NOCOUNT ON;
	SELECT
		 [FeeStructureId]
		,[ClassId]
		,[FeeType]
		,[Frequency]
		,[Amount]
		,[ApplicableFrom]
		,[ApplicableTo]
		,[Remarks]
		,[IsMandatory]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		,[FName]
	FROM [spe].[FeeStructureMaster]
	WHERE  [FeeStructureId] = @FeeStructureId
	AND  [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[FeeStructureMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [spe].[FeeStructureMaster_Update]
(
    @FeeStructureId  INT,
    @ClassId         INT,
    @FeeType         VARCHAR(50),
    @Frequency       VARCHAR(50),
    @Amount          DECIMAL(18, 2),
    @ApplicableFrom  DATETIME,
    @ApplicableTo    DATETIME,
    @Remarks         VARCHAR(500),
	@FName            VARCHAR(100),
	@IsMandatory     INT,
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @IsActive        INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[FeeStructureMaster]
    SET
        [ClassId]        = @ClassId,
        [FeeType]        = @FeeType,
        [Frequency]      = @Frequency,
        [Amount]         = @Amount,
        [ApplicableFrom] = @ApplicableFrom,
        [ApplicableTo]   = @ApplicableTo,
        [Remarks]        = @Remarks,
		[FName]          = @FName,
		[IsMandatory]    = @IsMandatory,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE [FeeStructureId] = @FeeStructureId ;

    SELECT
        [FeeStructureId],
        [ClassId],
        [FeeType],
        [Frequency],
        [Amount],
        [ApplicableFrom],
        [ApplicableTo],
        [Remarks],
		[FName],
	    [IsMandatory],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[FeeStructureMaster]
    WHERE [FeeStructureId] = @FeeStructureId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*


*/
CREATE   PROCEDURE [spe].[LoanRequest_Create]
(
    @ServiceProviderRRN   VARCHAR(100),
    @UserId               BIGINT,
    @SubUserId             BIGINT,
    @BusinessId           BIGINT,
    @LoanAmount           DECIMAL(18,2),
    @ProductType          VARCHAR(50),
    @Purpose              VARCHAR(255),
    @CurrencyCode         VARCHAR(50),
    @DeviceType           VARCHAR(50),
    @DeviceName           VARCHAR(100),
    @IPAddress            VARCHAR(50),
    @GeoLatitude          DECIMAL(18,6),
    @GeoLongitude         DECIMAL(18,6),
    @Status               VARCHAR(50),
    @LoanProviderRRN      VARCHAR(100),
    @LoanProviderTxnId    VARCHAR(100),
    @RequestDate          DATETIME,
    @ResponseDate         DATETIME,
    @OtherDetail1         VARCHAR(50),
    @OtherDetail2         VARCHAR(50),
    @OtherDetail3         VARCHAR(100),
    @OtherDetail4         VARCHAR(100),
    @OtherDetail5         VARCHAR(500),
    @OtherDetail6         VARCHAR(500),
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @LoanRequestId BIGINT,
			@InServiceProviderRRN   VARCHAR(100);

	SELECT @InServiceProviderRRN = [dbo].[GetMaxSchoolLoanPRRN]();

    INSERT INTO [spe].[LoanRequest]
    (
         [ServiceProviderRRN]
        ,[UserId]
		,[SubUserId]
        ,[BusinessId]
        ,[LoanAmount]
        ,[ProductType]
        ,[Purpose]
        ,[CurrencyCode]
        ,[DeviceType]
        ,[DeviceName]
        ,[IPAddress]
        ,[GeoLatitude]
        ,[GeoLongitude]
        ,[Status]
        ,[LoanProviderRRN]
        ,[LoanProviderTxnId]
        ,[RequestDate]
        ,[ResponseDate]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @InServiceProviderRRN
        ,@UserId
		,@SubUserId
        ,@BusinessId
        ,@LoanAmount
        ,@ProductType
        ,@Purpose
        ,@CurrencyCode
        ,@DeviceType
        ,@DeviceName
        ,@IPAddress
        ,@GeoLatitude
        ,@GeoLongitude
        ,@Status
        ,@LoanProviderRRN
        ,@LoanProviderTxnId
        ,@RequestDate
        ,@ResponseDate
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1              
        ,0              
        ,@ActionUser
        ,GETDATE()
    );

    SET @LoanRequestId = SCOPE_IDENTITY();

    SELECT 
         [LoanRequestId]
        ,[ServiceProviderRRN]
        ,[UserId]
		,[SubUserId]
        ,[BusinessId]
        ,[LoanAmount]
        ,[ProductType]
        ,[Purpose]
        ,[CurrencyCode]
        ,[DeviceType]
        ,[DeviceName]
        ,[IPAddress]
        ,[GeoLatitude]
        ,[GeoLongitude]
        ,[Status]
        ,[LoanProviderRRN]
        ,[LoanProviderTxnId]
        ,[RequestDate]
        ,[ResponseDate]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[LoanRequest]
    WHERE [LoanRequestId] = @LoanRequestId;
END;
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[LoanRequest_Delete]
(
   @LoanRequestId BIGINT,
   @ActionUser varchar(50)
)
AS
BEGIN 
	SET NOCOUNT ON;
  
	UPDATE[spe].[LoanRequest]
	SET
		[IsActive] =  0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [LoanRequestId] = @LoanRequestId
END
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[LoanRequest_ReadAll]
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT 
       [LoanRequestId]
      ,[ServiceProviderRRN]
      ,[UserId]
	  ,[SubUserId]
      ,[BusinessId]
      ,[LoanAmount]
      ,[ProductType]
      ,[Purpose]
      ,[CurrencyCode]
      ,[DeviceType]
      ,[DeviceName]
      ,[IPAddress]
      ,[GeoLatitude]
      ,[GeoLongitude]
      ,[Status]
      ,[LoanProviderRRN]
      ,[LoanProviderTxnId]
      ,[RequestDate]
      ,[ResponseDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[LoanRequest]
	  WHERE [IsActive] = 1 AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_ReadByBusinessId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[LoanRequest_ReadByBusinessId]
(
   @BusinessId BIGINT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT 
       A.[LoanRequestId]
      ,A.[ServiceProviderRRN]
      ,A.[UserId]
      ,ISNULL(B.FirstName + ' ', '') + ISNULL(B.LastName, '') AS UserName
	  ,A.[SubUserId]
	  ,D.[StudentName]
      ,A.[BusinessId] 
	  ,C.[SchoolName] AS BusinessName
      ,A.[LoanAmount]
      ,A.[ProductType]
      ,A.[Purpose]
      ,A.[CurrencyCode]
      ,A.[DeviceType]
      ,A.[DeviceName]
      ,A.[IPAddress]
      ,A.[GeoLatitude]
      ,A.[GeoLongitude]
      ,A.[Status]
      ,A.[LoanProviderRRN]
      ,A.[LoanProviderTxnId]
      ,A.[RequestDate]
      ,A.[ResponseDate]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[LoanRequest]A
    LEFT JOIN [Nishwik].[dbo].[UserMaster] B
        ON A.[UserId] = B.[UserId]
  LEFT OUTER JOIN  [Nishwik].[spe].[SchoolMaster] C
    ON A.[BusinessId] = C.[SchoolId] 
  LEFT OUTER JOIN [Nishwik].[spe].[StudentMaster]D
  ON A.[SubUserId]= D.[StudentId]
    WHERE A.[BusinessId] = @BusinessId
      AND A.[IsActive] = 1 
      AND A.[IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[LoanRequest_ReadById]
(
   @LoanRequestId BIGINT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT 
       A.[LoanRequestId]
      ,A.[ServiceProviderRRN]
      ,A.[UserId]
      ,ISNULL(B.FirstName + ' ', '') + ISNULL(B.LastName, '') AS UserName
	  ,A.[SubUserId]
	  ,D.[StudentName]
      ,A.[BusinessId]
	  ,C.[SchoolName] AS BusinessName
      ,A.[LoanAmount]
      ,A.[ProductType]
      ,A.[Purpose]
      ,A.[CurrencyCode]
      ,A.[DeviceType]
      ,A.[DeviceName]
      ,A.[IPAddress]
      ,A.[GeoLatitude]
      ,A.[GeoLongitude]
      ,A.[Status]
      ,A.[LoanProviderRRN]
      ,A.[LoanProviderTxnId]
      ,A.[RequestDate]
      ,A.[ResponseDate]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[LoanRequest]A
	 LEFT JOIN [Nishwik].[dbo].[UserMaster] B
        ON A.[UserId] = B.[UserId]
  LEFT OUTER JOIN  [Nishwik].[spe].[SchoolMaster] C
    ON A.[BusinessId] = C.[SchoolId] 
  LEFT OUTER JOIN [Nishwik].[spe].[StudentMaster]D
  ON A.[SubUserId]= D.[StudentId]
    WHERE A.[LoanRequestId] = @LoanRequestId
      AND A.[IsActive] = 1 
      AND A.[IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_ReadByServiceProviderRRN]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[LoanRequest_ReadByServiceProviderRRN]
(
   @ServiceProviderRRN VARCHAR(100)
)
AS
BEGIN 
  SET NOCOUNT ON;

  SELECT 
       A.[LoanRequestId]
      ,A.[ServiceProviderRRN]
      ,A.[UserId]
      ,ISNULL(B.FirstName + ' ', '') + ISNULL(B.LastName, '') AS UserName
      ,A.[SubUserId]
      ,D.[StudentName]
      ,A.[BusinessId] 
      ,C.[SchoolName] AS BusinessName
      ,A.[LoanAmount]
      ,A.[ProductType]
      ,A.[Purpose]
      ,A.[CurrencyCode]
      ,A.[DeviceType]
      ,A.[DeviceName]
      ,A.[IPAddress]
      ,A.[GeoLatitude]
      ,A.[GeoLongitude]
      ,A.[Status]
      ,A.[LoanProviderRRN]
      ,A.[LoanProviderTxnId]
      ,A.[RequestDate]
      ,A.[ResponseDate]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
  FROM [spe].[LoanRequest] A
  LEFT JOIN [dbo].[UserMaster] B 
  ON A.[UserId] = B.[UserId]
  LEFT JOIN [spe].[SchoolMaster] C
  ON A.[BusinessId] = C.[SchoolId]
  LEFT JOIN [spe].[StudentMaster] D
  ON A.[SubUserId] = D.[StudentId]
  WHERE A.[ServiceProviderRRN] = @ServiceProviderRRN
    AND A.[IsActive] = 1 
    AND A.[IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_ReadBySubUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[LoanRequest_ReadBySubUserId]
(
   @SubUserId BIGINT
)
AS
 BEGIN 
  SET NOCOUNT ON;
  SELECT 
       [LoanRequestId]
      ,[ServiceProviderRRN]
      ,[UserId]
	  ,[SubUserId]
      ,[BusinessId]
      ,[LoanAmount]
      ,[ProductType]
      ,[Purpose]
      ,[CurrencyCode]
      ,[DeviceType]
      ,[DeviceName]
      ,[IPAddress]
      ,[GeoLatitude]
      ,[GeoLongitude]
      ,[Status]
      ,[LoanProviderRRN]
      ,[LoanProviderTxnId]
      ,[RequestDate]
      ,[ResponseDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[LoanRequest]
	  WHERE [SubUserId] = @SubUserId
	  AND[IsActive] = 1 AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[LoanRequest_ReadByUserId]
(
   @UserId BIGINT
)
AS
BEGIN 
    SET NOCOUNT ON;

    SELECT 
       A.[LoanRequestId]
      ,A.[ServiceProviderRRN]
      ,A.[UserId]
      ,ISNULL(B.FirstName + ' ', '') + ISNULL(B.LastName, '') AS UserName
	  ,A.[SubUserId]
	  ,D.[StudentName]
      ,A.[BusinessId] 
	  ,C.[SchoolName] AS BusinessName
      ,A.[LoanAmount]
      ,A.[ProductType]
      ,A.[Purpose]
      ,A.[CurrencyCode]
      ,A.[DeviceType]
      ,A.[DeviceName]
      ,A.[IPAddress]
      ,A.[GeoLatitude]
      ,A.[GeoLongitude]
      ,A.[Status]
      ,A.[LoanProviderRRN]
      ,A.[LoanProviderTxnId]
      ,A.[RequestDate]
      ,A.[ResponseDate]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
    FROM [spe].[LoanRequest] A
    LEFT JOIN [Nishwik].[dbo].[UserMaster] B
        ON A.[UserId] = B.[UserId]
  LEFT OUTER JOIN  [Nishwik].[spe].[SchoolMaster] C
    ON A.[BusinessId] = C.[SchoolId] 
  LEFT OUTER JOIN [Nishwik].[spe].[StudentMaster]D
  ON A.[SubUserId]= D.[StudentId]
    WHERE A.[UserId] = @UserId
      AND A.[IsActive] = 1 
      AND A.[IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[LoanRequest_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[LoanRequest_Update]
(
    @LoanRequestId       BIGINT,
    @ServiceProviderRRN  VARCHAR(100),
    @UserId              BIGINT,
	@SubUserId           BIGINT,
    @BusinessId          BIGINT,
    @LoanAmount          DECIMAL(18,2),
    @ProductType         VARCHAR(50),
    @Purpose             VARCHAR(255),
    @CurrencyCode        VARCHAR(50),
    @DeviceType          VARCHAR(50),
    @DeviceName          VARCHAR(100),
    @IPAddress           VARCHAR(50),
    @GeoLatitude         DECIMAL(18,6),
    @GeoLongitude        DECIMAL(18,6),
    @Status              VARCHAR(50),
    @LoanProviderRRN     VARCHAR(100),
    @LoanProviderTxnId   VARCHAR(100),
    @RequestDate         DATETIME,
    @ResponseDate        DATETIME,
    @OtherDetail1        VARCHAR(50),
    @OtherDetail2        VARCHAR(50),
    @OtherDetail3        VARCHAR(100),
    @OtherDetail4        VARCHAR(100),
    @OtherDetail5        VARCHAR(500),
    @OtherDetail6        VARCHAR(500),
    @IsActive            INT,
    @ActionUser           VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[LoanRequest]
    SET 
         [ServiceProviderRRN] = @ServiceProviderRRN
        ,[UserId]              = @UserId
		,[SubUserId]           = @SubUserId
        ,[BusinessId]          = @BusinessId
        ,[LoanAmount]          = @LoanAmount
        ,[ProductType]         = @ProductType
        ,[Purpose]             = @Purpose
        ,[CurrencyCode]        = @CurrencyCode
        ,[DeviceType]          = @DeviceType
        ,[DeviceName]          = @DeviceName
        ,[IPAddress]           = @IPAddress
        ,[GeoLatitude]         = @GeoLatitude
        ,[GeoLongitude]        = @GeoLongitude
        ,[Status]              = @Status
        ,[LoanProviderRRN]     = @LoanProviderRRN
        ,[LoanProviderTxnId]   = @LoanProviderTxnId
        ,[RequestDate]         = @RequestDate
        ,[ResponseDate]        = @ResponseDate
        ,[OtherDetail1]        = @OtherDetail1
        ,[OtherDetail2]        = @OtherDetail2
        ,[OtherDetail3]        = @OtherDetail3
        ,[OtherDetail4]        = @OtherDetail4
        ,[OtherDetail5]        = @OtherDetail5
        ,[OtherDetail6]        = @OtherDetail6
        ,[IsActive]            = @IsActive
        ,[ModifiedBy]          = @ActionUser
        ,[ModifiedOn]          = GETDATE()
    WHERE [LoanRequestId] = @LoanRequestId;

    SELECT 
         [LoanRequestId]
        ,[ServiceProviderRRN]
        ,[UserId]
		,[SubUserId]
        ,[BusinessId]
        ,[LoanAmount]
        ,[ProductType]
        ,[Purpose]
        ,[CurrencyCode]
        ,[DeviceType]
        ,[DeviceName]
        ,[IPAddress]
        ,[GeoLatitude]
        ,[GeoLongitude]
        ,[Status]
        ,[LoanProviderRRN]
        ,[LoanProviderTxnId]
        ,[RequestDate]
        ,[ResponseDate]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[LoanRequest]
    WHERE [LoanRequestId] = @LoanRequestId;
END;
GO
/****** Object:  StoredProcedure [spe].[OnboardingPreCheck_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROCEDURE [spe].[OnboardingPreCheck_Create]
(
    @SchoolId     INT             = NULL,
    @PName          VARCHAR(100)    = NULL,
    @PDesc          VARCHAR(500)    = NULL,
    @IsVerified     INT             = NULL,
    @VerifiedBy     VARCHAR(100)    = NULL,
    @VerifiedDate   DATETIME        = NULL,
    @OtherDetail1   VARCHAR(50)     = NULL,
    @OtherDetail2   VARCHAR(50)     = NULL,
    @OtherDetail3   VARCHAR(100)    = NULL,
    @OtherDetail4   VARCHAR(100)    = NULL,
    @OtherDetail5   VARCHAR(500)    = NULL,
    @OtherDetail6   VARCHAR(500)    = NULL,
    @ActionUser     VARCHAR(50)     = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PreCheckId BIGINT;

    INSERT INTO [spe].[OnboardingPreCheck]
    (
        [SchoolId],
        [PName],
        [PDesc],
        [IsVerified],
        [VerifiedBy],
        [VerifiedDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        TRIM(@PName),
        TRIM(@PDesc),
        @IsVerified,
        TRIM(@VerifiedBy),
        @VerifiedDate,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1, 
        0, 
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @PreCheckId = SCOPE_IDENTITY();
	  SELECT 
         A.[PreCheckId]
        ,A.[SchoolId]
        ,A.[PName]
        ,A.[PDesc]
        ,A.[IsVerified]
        ,A.[VerifiedBy]
        ,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
        ,A.[VerifiedDate]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
    FROM [spe].[OnboardingPreCheck] A   
    LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
        ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
        AND B.[IsActive] = 1
        AND B.[IsDeleted] = 0
    WHERE A.[PreCheckId] = @PreCheckId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[OnboardingPreCheck_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[OnboardingPreCheck_Delete]
(
   @PreCheckId BIGINT,
   @ActionUser VARCHAR(50)
)
AS 
BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[OnboardingPreCheck]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE  [PreCheckId] = @PreCheckId
END;
GO
/****** Object:  StoredProcedure [spe].[OnboardingPreCheck_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[OnboardingPreCheck_ReadAll]
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PreCheckId]
		,[SchoolId]
		,[PName]
		,[PDesc]
		,[IsVerified]
		,[VerifiedBy]
		,[VerifiedDate]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[OnboardingPreCheck]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[OnboardingPreCheck_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[OnboardingPreCheck_ReadById]
(
   @PreCheckId BIGINT
)
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [PreCheckId]
		,[SchoolId]
		,[PName]
		,[PDesc]
		,[IsVerified]
		,[VerifiedBy]
		,[VerifiedDate]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[OnboardingPreCheck]
	WHERE  [PreCheckId] = @PreCheckId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[OnboardingPreCheck_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[OnboardingPreCheck_ReadBySchoolId]
(
   @SchoolId INT
)
AS 
BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 A.[PreCheckId]
		,A.[SchoolId]
		,A.[PName]
		,A.[PDesc]
		,A.[IsVerified]
		,A.[VerifiedBy]
		,B.[FirstName] + ' ' + B.[LastName] AS [VerifiedByName]
		,A.[VerifiedDate]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [spe].[OnboardingPreCheck]A
        LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster] B 
			ON B.[UserId] = TRY_CAST(A.[VerifiedBy] AS BIGINT)
			AND B.[IsActive] = 1
			AND B.[IsDeleted] = 0
    WHERE A.[SchoolId] = @SchoolId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[OnboardingPreCheck_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [spe].[OnboardingPreCheck_Update]
(
    @PreCheckId     BIGINT,
    @SchoolId     INT             = NULL,
    @PName          VARCHAR(100)    = NULL,
    @PDesc          VARCHAR(500)    = NULL,
    @IsVerified     INT             = NULL,
    @VerifiedBy     VARCHAR(100)    = NULL,
    @VerifiedDate   DATETIME        = NULL,
    @OtherDetail1   VARCHAR(50)     = NULL,
    @OtherDetail2   VARCHAR(50)     = NULL,
    @OtherDetail3   VARCHAR(100)    = NULL,
    @OtherDetail4   VARCHAR(100)    = NULL,
    @OtherDetail5   VARCHAR(500)    = NULL,
    @OtherDetail6   VARCHAR(500)    = NULL,
    @IsActive       INT             = NULL,
    @ActionUser     VARCHAR(50)     = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[OnboardingPreCheck]
    SET
        [SchoolId]    = @SchoolId,
        [PName]         = TRIM(@PName),
        [PDesc]         = TRIM(@PDesc),
        [IsVerified]    = @IsVerified,
        [VerifiedBy]    = TRIM(@VerifiedBy),
        [VerifiedDate]  = @VerifiedDate,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [PreCheckId] = @PreCheckId;

    SELECT 
        [PreCheckId],
        [SchoolId],
        [PName],
        [PDesc],
        [IsVerified],
        [VerifiedBy],
        [VerifiedDate],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[OnboardingPreCheck]
    WHERE [PreCheckId] = @PreCheckId
	AND [IsActive] = 1
	AND [IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [spe].[ParentStudentMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[ParentStudentMapping_Create]
(
    @ParentId       INT,
    @StudentId      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1
        FROM [spe].[ParentStudentMapping]
        WHERE ParentId = @ParentId
          AND StudentId = @StudentId
          AND IsActive = 1
          AND IsDeleted = 0
    )
    BEGIN
        SELECT 'Mapping already exists for this ParentStudent combination' AS Message;
        RETURN;
    END


    DECLARE @MapId INT;

    INSERT INTO [spe].[ParentStudentMapping]
    (
        [ParentId],
        [StudentId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ParentId,
        @StudentId,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,
        GETDATE()
    );

    SET @MapId = SCOPE_IDENTITY();

    SELECT
        [MapId],
        [ParentId],
        [StudentId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ParentStudentMapping]
    WHERE [MapId] = @MapId;
END;
GO
/****** Object:  StoredProcedure [spe].[ParentStudentMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[spe].[ParentStudentMapping_Delete] 
(
    @MapId int,
	@ActionUser varchar(50)
)
AS
 BEGIN 
  SET NOCOUNT ON;
  UPDATE [spe].[ParentStudentMapping]
  SET     
        [IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn]  = GETDATE()
	  WHERE [MapId] = @MapId
END;
GO
/****** Object:  StoredProcedure [spe].[ParentStudentMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[spe].[ParentStudentMapping_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [MapId]
		,[ParentId]
		,[StudentId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[ParentStudentMapping]
	WHERE[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ParentStudentMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE[spe].[ParentStudentMapping_ReadById]
(
   @MapId INT
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT
		 [MapId]
		,[ParentId]
		,[StudentId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[ParentStudentMapping]
	WHERE [MapId] = @MapId
	AND[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[ParentStudentMapping_ReadByParentId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[ParentStudentMapping_ReadByParentId]
(
   @ParentId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
         A.[MapId]
        ,A.[ParentId]
        ,A.[StudentId]
        ,B.[FirstName]
        ,B.[MiddleName]
        ,B.[LastName]
        ,B.[DOB]
        ,B.[MobileNo]
        ,B.[EmailId]
        ,ISNULL(B.[ProfileImage],'') AS ProfileImage
        ,B.[Address]
        ,B.[Country]
        ,B.[State]
        ,B.[City]
        ,B.[BloodGroup]
        ,B.[Gender]
        ,B.[AadharNumber]
        ,B.[PanNumber]
        ,A.[OtherDetail1]
        ,A.[OtherDetail2]
        ,A.[OtherDetail3]
        ,A.[OtherDetail4]
        ,A.[OtherDetail5]
        ,A.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
        ,C.[AdmissionNo]
        ,D.[ClassId]
        ,E.[ClassName]
        ,F.[SchoolId]
    FROM [spe].[ParentStudentMapping] A
    LEFT JOIN [dbo].[UserMaster] B
        ON A.StudentId = B.UserId

    --  Deduplicated UserAffiliationMapping (one record per Student)
    LEFT JOIN (
        SELECT UserId, MAX(SchoolId) AS SchoolId
        FROM [spe].[UserAffiliationMapping]
        WHERE AffiliationType = 'Student'
          AND IsActive = 1 AND IsDeleted = 0
        GROUP BY UserId
    ) F ON A.StudentId = F.UserId

    LEFT JOIN [spe].[StudentRegistration] C
        ON A.StudentId = C.UserId
       AND C.[IsActive] = 1
       AND C.[IsDeleted] = 0

    --  Deduplicated StudentClassMapping (one record per Student)
    LEFT JOIN (
        SELECT UserId, MAX(ClassId) AS ClassId
        FROM [spe].[StudentClassMapping]
        WHERE IsActive = 1 AND IsDeleted = 0
        GROUP BY UserId
    ) D ON A.StudentId = D.UserId

    LEFT JOIN [spe].[ClassMaster] E
        ON D.ClassId = E.ClassId
       AND (C.SchoolId IS NULL OR C.SchoolId = E.SchoolId)

    WHERE A.ParentId = @ParentId
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[ParentStudentMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[ParentStudentMapping_Update]
(
    @MapId          INT,
    @ParentId       INT,
    @StudentId      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	   --  Duplicate check (ignore same MapId)
    IF EXISTS (
        SELECT 1
        FROM [spe].[ParentStudentMapping]
        WHERE ParentId = @ParentId
          AND StudentId = @StudentId
          AND IsActive = 1
          AND IsDeleted = 0
          AND MapId <> @MapId
    )
    BEGIN
        SELECT 'Mapping already exists for this ParentStudent combination' AS Message;
        RETURN;
    END

    UPDATE [spe].[ParentStudentMapping]
    SET
        [ParentId]     = @ParentId,
        [StudentId]    = @StudentId,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive]     = @IsActive,
        [ModifiedBy]   = @ActionUser,
        [ModifiedOn]   = GETDATE()
    WHERE
        [MapId] = @MapId ;

    SELECT
        [MapId],
        [ParentId],
        [StudentId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ParentStudentMapping]
    WHERE [MapId] = @MapId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[PrintMaster_Create]
(
    @TemplateId     INT = NULL,
    @SchoolId     INT = NULL,
    @MasterId       INT = NULL,
    @MasterType     NVARCHAR(100) = NULL,
    @PName          NVARCHAR(255) = NULL,
    @PDesc          NVARCHAR(MAX) = NULL,
    @PContent       NVARCHAR(MAX) = NULL,
    @PSeq           INT = NULL,
    @OtherDetail1   NVARCHAR(255) = NULL,
    @OtherDetail2   NVARCHAR(255) = NULL,
    @OtherDetail3   NVARCHAR(255) = NULL,
    @OtherDetail4   NVARCHAR(255) = NULL,
    @OtherDetail5   NVARCHAR(255) = NULL,
    @OtherDetail6   NVARCHAR(255) = NULL,
    @ActionUser     NVARCHAR(100)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @PrintId INT;

    INSERT INTO [spe].[PrintMaster]
    (
        [TemplateId],
        [SchoolId],
        [MasterId],
        [MasterType],
        [PName],
        [PDesc],
        [PContent],
        [PSeq],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @TemplateId,
        @SchoolId,
        @MasterId,
        TRIM(@MasterType),
        TRIM(@PName),
        TRIM(@PDesc),
        TRIM(@PContent),
        @PSeq,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @PrintId = SCOPE_IDENTITY();

    SELECT 
        [PrintId],
        [TemplateId],
        [SchoolId],
        [MasterId],
        [MasterType],
        [PName],
        [PDesc],
        [PContent],
        [PSeq],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[PrintMaster]
    WHERE [PrintId] = @PrintId;
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[PrintMaster_Delete]
(
   @PrintId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE  [spe].[PrintMaster]
	SET
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [PrintId] = @PrintId
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[PrintMaster_ReadAll]
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PrintId]
	  ,[SchoolId]
      ,[TemplateId]
      ,[MasterId]
      ,[MasterType]
      ,[PName]
      ,[PDesc]
      ,[PContent]
      ,[PSeq]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[PrintMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[PrintMaster_ReadById]
(
    @PrintId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        [PrintId],
        [SchoolId],
		[TemplateId],
		[MasterId],
		[MasterType],
        [PName],
		[PDesc],
		[PContent],
		[PSeq],
        [OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
        [OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
        [IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn],
		[ModifiedBy],
		[ModifiedOn]
    FROM [spe].[PrintMaster]
    WHERE [PrintId] = @PrintId AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[PrintMaster_ReadByMasterId]
(
    @MasterId INT,
	@MasterType VARCHAR(200)
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        [PrintId],
        [SchoolId],
		[TemplateId],
		[MasterId],
		[MasterType],
        [PName],
		[PDesc],
		[PContent],
		[PSeq],
        [OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
        [OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
        [IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn],
		[ModifiedBy],
		[ModifiedOn]
    FROM [spe].[PrintMaster]
    WHERE [MasterId] = @MasterId 
	AND [IsDeleted] = 0
	AND [MasterType] = @MasterType 
	AND [IsDeleted] =0;
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_ReadByMasterType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[PrintMaster_ReadByMasterType]
(
    @MasterType VARCHAR(200),
	@SchoolId INT
)
AS
BEGIN
    SET NOCOUNT ON;


	IF EXISTS (SELECT 1 FROM spe.PrintMaster WHERE MasterType = @MasterType AND SchoolId = @SchoolId AND IsActive = 1 AND IsDeleted = 0)
	BEGIN
		SELECT 
			[PrintId],
			[SchoolId],
			[TemplateId],
			[MasterId],
			[MasterType],
			[PName],
			[PDesc],
			[PContent],
			[PSeq],
			[OtherDetail1],
			[OtherDetail2],
			[OtherDetail3],
			[OtherDetail4],
			[OtherDetail5],
			[OtherDetail6],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[ModifiedBy],
			[ModifiedOn]
		FROM [spe].[PrintMaster]
		WHERE MasterType = @MasterType AND SchoolId = @SchoolId AND IsActive = 1 AND IsDeleted = 0
	END
	ELSE
	BEGIN
		SELECT 
			[PrintId],
			[SchoolId],
			[TemplateId],
			[MasterId],
			[MasterType],
			[PName],
			[PDesc],
			[PContent],
			[PSeq],
			[OtherDetail1],
			[OtherDetail2],
			[OtherDetail3],
			[OtherDetail4],
			[OtherDetail5],
			[OtherDetail6],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[ModifiedBy],
			[ModifiedOn]
		FROM [spe].[PrintMaster]
		WHERE MasterType = @MasterType AND SchoolId = 0 AND IsActive = 1 AND IsDeleted = 0
	END

    
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [spe].[PrintMaster_ReadBySchoolId]
(
   @SchoolId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PrintId]
	  ,[SchoolId]
      ,[TemplateId]
      ,[MasterId]
      ,[MasterType]
      ,[PName]
      ,[PDesc]
      ,[PContent]
      ,[PSeq]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[PrintMaster]
	  WHERE [SchoolId] = @SchoolId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_ReadByTemplateId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[PrintMaster_ReadByTemplateId]
(
   @TemplateId INT
)
AS
BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [PrintId]
	  ,[SchoolId]
      ,[TemplateId]
      ,[MasterId]
      ,[MasterType]
      ,[PName]
      ,[PDesc]
      ,[PContent]
      ,[PSeq]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[PrintMaster]
	  WHERE [TemplateId] = @TemplateId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[PrintMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[PrintMaster_Update]
(
    @PrintId        INT,
    @TemplateId     INT = NULL,
    @SchoolId       INT = NULL,
    @MasterId       INT = NULL,
    @MasterType     NVARCHAR(100) = NULL,
    @PName          NVARCHAR(255) = NULL,
    @PDesc          NVARCHAR(MAX) = NULL,
    @PContent       NVARCHAR(MAX) = NULL,
    @PSeq           INT = NULL,
    @OtherDetail1   NVARCHAR(255) = NULL,
    @OtherDetail2   NVARCHAR(255) = NULL,
    @OtherDetail3   NVARCHAR(255) = NULL,
    @OtherDetail4   NVARCHAR(255) = NULL,
    @OtherDetail5   NVARCHAR(255) = NULL,
    @OtherDetail6   NVARCHAR(255) = NULL,
    @IsActive       INT = 1,
    @ActionUser     NVARCHAR(100)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[PrintMaster]
    SET
        [TemplateId]    = @TemplateId,
        [SchoolId]      = @SchoolId,
        [MasterId]      = @MasterId,
        [MasterType]    = TRIM(@MasterType),
        [PName]         = TRIM(@PName),
        [PDesc]         = TRIM(@PDesc),
        [PContent]      = TRIM(@PContent),
        [PSeq]          = @PSeq,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [PrintId] = @PrintId;

    SELECT 
        [PrintId],
        [TemplateId],
        [SchoolId],
        [MasterId],
        [MasterType],
        [PName],
        [PDesc],
        [PContent],
        [PSeq],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[PrintMaster]
    WHERE [PrintId] = @PrintId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[ReadFeesMasterDetailsByCLassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[ReadFeesMasterDetailsByCLassId]
(
	@ClassId INT 
)
AS
BEGIN
	SELECT * FROM spe.FeeStructureMaster 
	WHERE ClassId = @ClassId
	AND IsActive= 1;

	SELECT * FROM spe.FeeInstallmentMaster 
	WHERE  FeeStructureId IN (SELECT DISTINCT FeeStructureID 
								FROM spe.FeeStructureMaster WHERE ClassId = @ClassId)
								AND IsActive= 1;

	SELECT * 
	FROM spe.FeeComponentMaster 
	WHERE  InstallmentId IN (
								SELECT InstallmentId FROM spe.FeeInstallmentMaster 
								WHERE  FeeStructureId IN (SELECT DISTINCT FeeStructureID 
														FROM spe.FeeStructureMaster WHERE ClassId = @ClassId)
													AND	 IsActive= 1
							)
							AND IsActive= 1;	

END
GO
/****** Object:  StoredProcedure [spe].[Receipt_AutoGenerate]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[Receipt_AutoGenerate]
    @PaymentId INT
AS
BEGIN
    INSERT INTO [spe].[ReceiptMaster](ReceiptId, ReceiptDate, CreatedOn)
    SELECT @PaymentId, GETDATE(), GETDATE();
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[ReceiptDetail_Create]
    @ReceiptId = 1001,
    @MasterType = 'Fee',
    @MasterId = 25,
    @MasterAmt = 5500.00,
    @Remarks = 'First installment',
    @OtherDetail1 = 'OD1',
    @OtherDetail2 = 'OD2',
    @OtherDetail3 = 'OD3',
    @OtherDetail4 = 'OD4',
    @OtherDetail5 = 'OD5',
    @OtherDetail6 = 'OD6',
    @ActionUser = 'admin';
*/

CREATE PROCEDURE [spe].[ReceiptDetail_Create]
(
    @ReceiptId     INT,
    @MasterType    VARCHAR(50) = NULL,
    @MasterId      INT = NULL,
    @MasterAmt     DECIMAL(18,2) = NULL,
    @Remarks       VARCHAR(500) = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [spe].[ReceiptDetail]
    (
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ReceiptId,
        TRIM(@MasterType),
        @MasterId,
        @MasterAmt,
        TRIM(@Remarks),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,              
        0,              
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
        [DetailId],
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ReceiptDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptDetail_Delete]
(
   @DetailId INT,
   @ActionUser VARCHAR(50)
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  UPDATE [spe].[ReceiptDetail]
	  SET
		  [IsActive] = 0,
		  [IsDeleted] = 1,
		  [CreatedBy] = @ActionUser,
		  [CreatedOn] = GETDATE ()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptDetail_ReadAll]
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [spe].[ReceiptDetail] 
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptDetail_ReadById]
(
   @DetailId BIGINT
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [spe].[ReceiptDetail] 
	WHERE  [DetailId] = @DetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptDetail_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptDetail_ReadByMasterId]
(
   @MasterId INT,
   @MasterType VARCHAR(50)
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [spe].[ReceiptDetail] 
	WHERE [MasterId] = @MasterId
	AND [MasterType] = @MasterType
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptDetail_ReadByReceiptId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptDetail_ReadByReceiptId]
(
   @ReceiptId INT
) 
AS
BEGIN  
      SET NOCOUNT ON;
	  SELECT 
	   [DetailId]
      ,[ReceiptId]
      ,[MasterType]
      ,[MasterId]
      ,[MasterAmt]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [spe].[ReceiptDetail] 
	WHERE  [ReceiptId] = @ReceiptId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[ReceiptDetail_Update]
    @DetailId = 1,
    @ReceiptId = 1001,
    @MasterType = 'Fee',
    @MasterId = 25,
    @MasterAmt = 5500.00,
    @Remarks = 'Updated installment',
    @OtherDetail1 = 'OD1',
    @OtherDetail2 = 'OD2',
    @OtherDetail3 = 'OD3',
    @OtherDetail4 = 'OD4',
    @OtherDetail5 = 'OD5',
    @OtherDetail6 = 'OD6',
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE PROCEDURE [spe].[ReceiptDetail_Update]
(
    @DetailId      INT,
    @ReceiptId     INT,
    @MasterType    VARCHAR(50) = NULL,
    @MasterId      INT = NULL,
    @MasterAmt     DECIMAL(18,2) = NULL,
    @Remarks       VARCHAR(500) = NULL,
    @OtherDetail1  VARCHAR(50) = NULL,
    @OtherDetail2  VARCHAR(50) = NULL,
    @OtherDetail3  VARCHAR(100) = NULL,
    @OtherDetail4  VARCHAR(100) = NULL,
    @OtherDetail5  VARCHAR(500) = NULL,
    @OtherDetail6  VARCHAR(500) = NULL,
    @IsActive      INT = 1,
    @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[ReceiptDetail]
    SET
        [ReceiptId]    = @ReceiptId,
        [MasterType]   = TRIM(@MasterType),
        [MasterId]     = @MasterId,
        [MasterAmt]    = @MasterAmt,
        [Remarks]      = TRIM(@Remarks),
        [OtherDetail1] = TRIM(@OtherDetail1),
        [OtherDetail2] = TRIM(@OtherDetail2),
        [OtherDetail3] = TRIM(@OtherDetail3),
        [OtherDetail4] = TRIM(@OtherDetail4),
        [OtherDetail5] = TRIM(@OtherDetail5),
        [OtherDetail6] = TRIM(@OtherDetail6),
        [IsActive]     = @IsActive,
        [ModifiedBy]   = TRIM(@ActionUser),
        [ModifiedOn]   = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT
        [DetailId],
        [ReceiptId],
        [MasterType],
        [MasterId],
        [MasterAmt],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ReceiptDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive]= 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
USE [Nishwik];
GO

EXEC [spe].[ReceiptMaster_Create]
    @ReceiptDate   = '2025-10-10',
    @ReceiptAmount = 15000,
    @RStatus       = 'Pending',
    @MasterType    = 'Student',
    @MasterId      = 101,
    @Remarks       = 'First installment',
    @OtherDetail1  = 'OD1',
    @OtherDetail2  = 'OD2',
    @OtherDetail3  = 'OD3',
    @OtherDetail4  = 'OD4',
    @OtherDetail5  = 'OD5',
    @OtherDetail6  = 'OD6',
    @ActionUser    = 'admin';

GO

*/

CREATE PROCEDURE [spe].[ReceiptMaster_Create]
(
    @ReceiptDate DATETIME,
    @ReceiptAmount DECIMAL(18,2) = NULL,
    @RStatus VARCHAR(20) = NULL,
    @MasterType VARCHAR(50) = NULL,
    @MasterId INT = NULL,
    @Remarks VARCHAR(500) = NULL,
    @OtherDetail1 VARCHAR(50) = NULL,
    @OtherDetail2 VARCHAR(50) = NULL,
    @OtherDetail3 VARCHAR(100) = NULL,
    @OtherDetail4 VARCHAR(100) = NULL,
    @OtherDetail5 VARCHAR(500) = NULL,
    @OtherDetail6 VARCHAR(500) = NULL,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ReceiptId INT;
    DECLARE @PRRN VARCHAR(20);
    DECLARE @ReceiptNumber VARCHAR(20);

    -- ALWAYS generate new numbers
    SET @PRRN = [dbo].[GetMaxReceiptPRRN]();
    SET @ReceiptNumber = dbo.GetMaxReceiptNumber();

    INSERT INTO [spe].[ReceiptMaster]
    (
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @ReceiptDate,
        @ReceiptNumber,
        @PRRN,
        @ReceiptAmount,
        TRIM(@RStatus),
        TRIM(@MasterType),
        @MasterId,
        TRIM(@Remarks),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,
        0,
        TRIM(@ActionUser),
        GETDATE()
    );
    SET @ReceiptId = SCOPE_IDENTITY();

    SELECT
        [ReceiptId],
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ReceiptMaster]
    WHERE [ReceiptId] = @ReceiptId;
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptMaster_Delete]
(
    @ReceiptId INT ,
	@ActionUser  VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE [spe].[ReceiptMaster]
	SET 
		[IsActive] = 0,
		[IsDeleted] = 1,
		[CreatedBy] = @ActionUser,
		[CreatedOn] = GETDATE()
	WHERE [ReceiptId] =  @ReceiptId
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptMaster_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	       [ReceiptId]
		  ,[ReceiptDate]
		  ,[ReceiptNumber]
		  ,[PRRN]
		  ,[ReceiptAmount]
		  ,[RStatus]
		  ,[MasterType]
		  ,[MasterId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [spe].[ReceiptMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptMaster_ReadById]
(
    @ReceiptId INT 
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	       [ReceiptId]
		  ,[ReceiptDate]
		  ,[ReceiptNumber]
		  ,[PRRN]
		  ,[ReceiptAmount]
		  ,[RStatus]
		  ,[MasterType]
		  ,[MasterId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
	  FROM [spe].[ReceiptMaster]
	  WHERE [ReceiptId] = @ReceiptId
	  AND   [IsActive] = 1
	  AND   [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[ReceiptMaster_ReadByMasterId]
(
    @MasterId INT ,
	@MasterType VARCHAR(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	       A.[ReceiptId]
		  ,A.[ReceiptDate]
		  ,A.[ReceiptNumber]
		  ,A.[PRRN]
		  ,A.[ReceiptAmount]
		  ,A.[RStatus]
		  ,A.[MasterType]
		  ,A.[MasterId]
		  ,B.[FirstName] + ' '+ B.[LastName] AS StudentName
		  ,C.[FirstName] +'  '+ C.[LastName] AS ParentName                      
		  ,A.[Remarks]
		  ,A.[OtherDetail1]
		  ,A.[OtherDetail2]
		  ,A.[OtherDetail3]
		  ,A.[OtherDetail4]
		  ,A.[OtherDetail5]
		  ,A.[OtherDetail6]
		  ,A.[IsActive]
		  ,A.[IsDeleted]
		  ,A.[CreatedBy]
		  ,A.[CreatedOn]
		  ,A.[ModifiedBy]
		  ,A.[ModifiedOn]
	  FROM [spe].[ReceiptMaster] A
	  LEFT OUTER JOIN dbo.UserMaster B
	  ON A.MasterId = B.UserId
	  LEFT OUTER JOIN   dbo.UserMaster C
	  ON A.OtherDetail1 = C.UserId
	  WHERE A.[MasterId]=  @MasterId
	  AND  A. [MasterType] = @MasterType
	  AND  A. [IsActive] =   1
	  AND  A. [IsDeleted] =  0
END;
GO
/****** Object:  StoredProcedure [spe].[ReceiptMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[ReceiptMaster_Update]
(
    @ReceiptId        INT,
    @ReceiptDate      DATETIME = NULL,
    @ReceiptNumber    VARCHAR(20) = NULL,
    @PRRN             VARCHAR(20) = NULL,
    @ReceiptAmount    DECIMAL(18,2) = NULL,
    @RStatus          VARCHAR(20) = NULL,
    @MasterType       VARCHAR(50) = NULL,
    @MasterId         INT = NULL,
    @Remarks          VARCHAR(500) = NULL,
    @OtherDetail1     VARCHAR(50) = NULL,
    @OtherDetail2     VARCHAR(50) = NULL,
    @OtherDetail3     VARCHAR(100) = NULL,
    @OtherDetail4     VARCHAR(100) = NULL,
    @OtherDetail5     VARCHAR(500) = NULL,
    @OtherDetail6     VARCHAR(500) = NULL,
	@IsActive      INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[ReceiptMaster]
    SET
        [ReceiptDate]     = @ReceiptDate,
        [ReceiptNumber]   = TRIM(@ReceiptNumber),
        [PRRN]            = TRIM(@PRRN),
        [ReceiptAmount]   = @ReceiptAmount,
        [RStatus]         = TRIM(@RStatus),
        [MasterType]      = TRIM(@MasterType),
        [MasterId]        = @MasterId,
        [Remarks]         = TRIM(@Remarks),
        [OtherDetail1]    = TRIM(@OtherDetail1),
        [OtherDetail2]    = TRIM(@OtherDetail2),
        [OtherDetail3]    = TRIM(@OtherDetail3),
        [OtherDetail4]    = TRIM(@OtherDetail4),
        [OtherDetail5]    = TRIM(@OtherDetail5),
        [OtherDetail6]    = TRIM(@OtherDetail6),
		[IsActive]        = @IsActive,
        [ModifiedBy]      = TRIM(@ActionUser),
        [ModifiedOn]      = GETDATE()
    WHERE [ReceiptId] = @ReceiptId;

    SELECT
        [ReceiptId],
        [ReceiptDate],
        [ReceiptNumber],
        [PRRN],
        [ReceiptAmount],
        [RStatus],
        [MasterType],
        [MasterId],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[ReceiptMaster]
    WHERE [ReceiptId] = @ReceiptId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[Result_PublishByTerm]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[Result_PublishByTerm]
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE [spe].[ExamResult]
    SET IsPublished = 1, PublishedOn = GETDATE()
    WHERE TermEndDate <= GETDATE() AND IsPublished = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolBankMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[SchoolBankMaster_Create]
    @MasterType = 'School',           
    @MasterId = 5,                  
    @AccountNo = '1234567890',
    @AccountHolderName = 'St. Mary High School',
    @BankName = 'HDFC Bank',
    @BranchName = 'MG Road',
    @IFSCCode = 'HDFC0001234',
    @Address = 'MG Road, Pune, Maharashtra',
    @Contact = '9876543210',
    @OtherDetail1 = NULL,
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @IsDefault = 1,                     
    @ActionUser = '4';


*/
CREATE   PROCEDURE [spe].[SchoolBankMaster_Create]
(
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @AccountNo      VARCHAR(50),
	@AccountHolderName  VARCHAR(100),
	@AccountType      VARCHAR(50),
	@IsVerified      INT,
    @BankName       VARCHAR(100),
    @BranchName     VARCHAR(100),
    @IFSCCode       VARCHAR(50),
    @Address        VARCHAR(500),
    @Contact        VARCHAR(200),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
	@IsDefault      INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @BankId INT;
	IF @IsDefault = 1
	BEGIN
	UPDATE [spe].[SchoolBankMaster]
		SET IsDefault = 0,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND IsActive = 1;
	END
    
    INSERT INTO [spe].[SchoolBankMaster]
    (
        [MasterType],
        [MasterId],
        [AccountNo],
		[AccountHolderName],
		[AccountType],
        [IsVerified],
        [BankName],
        [BranchName],
        [IFSCCode],
        [Address],
        [Contact],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
		[IsDefault],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterType,
        @MasterId,
        @AccountNo,
		@AccountHolderName,
		@AccountType,
		@IsVerified,
        @BankName,
        @BranchName,
        @IFSCCode,
        @Address,
        @Contact,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
		@IsDefault,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @BankId = SCOPE_IDENTITY();

    SELECT 
	   [BankId]
      ,[MasterType]
      ,[MasterId]
      ,[AccountNo]
	  ,[AccountHolderName]
	  ,[AccountType]
      ,[IsVerified]
      ,[BankName]
      ,[BranchName]
      ,[IFSCCode]
      ,[Address]
      ,[Contact]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
	  ,ISNULL([IsDefault],0)IsDefault
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[SchoolBankMaster]
    WHERE [BankId] = @BankId;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolBankMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[SchoolBankMaster_Delete]
(
    @BankId       INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[SchoolBankMaster]
    SET 
        [IsDeleted]  = 1,
        [IsActive]   = 0,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE 
        [BankId] = @BankId
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolBankMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolBankMaster_ReadAll]
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT 
			 [BankId]
			,[MasterType]
			,[MasterId]
			,[AccountNo]
		    ,[AccountHolderName]
			,[BankName]
			,[BranchName]
			,[IFSCCode]
			,[Address]
			,[Contact]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,ISNULL([IsDefault],0)IsDefault
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	        ,[AccountType]
            ,[IsVerified]
	   	FROM [spe].[SchoolBankMaster]
		WHERE [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolBankMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolBankMaster_ReadById]
( 
    @BankId INT
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT 
			 [BankId]
			,[MasterType]
			,[MasterId]
			,[AccountNo]
		    ,[AccountHolderName]
			,[BankName]
			,[BranchName]
			,[IFSCCode]
			,[Address]
			,[Contact]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,ISNULL([IsDefault],0)IsDefault
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
			,[AccountType]
            ,[IsVerified]
		FROM [spe].[SchoolBankMaster]
		WHERE [BankId] =@BankId
		AND [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolBankMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolBankMaster_ReadByMasterId]
( 
    @MasterId INT,
	@MasterType VARCHAR(50)
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT 
			 [BankId]
			,[MasterType]
			,[MasterId]
			,[AccountNo]
			,[AccountHolderName]
			,[BankName]
			,[BranchName]
			,[IFSCCode]
			,[Address]
			,[Contact]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,ISNULL([IsDefault],0)IsDefault
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		    ,[AccountType]
            ,[IsVerified]
		FROM [spe].[SchoolBankMaster]
		WHERE [MasterId] =@MasterId
		AND [MasterType]= @MasterType
		AND [IsActive]= 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolBankMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
USE [Nishwik];
GO

EXEC [spe].[SchoolBankMaster_Update]
    @BankId = 2,  -- ID of the bank record to update
    @MasterType = 'School',
    @MasterId = 1,
    @AccountNo = '5555555555',
    @AccountHolderName = 'St. Mary School',
    @BankName = 'SBI',
    @BranchName = 'Shivaji Nagar',
    @IFSCCode = 'SBIN0000123',
    @Address = 'Pune',
    @Contact = '8888888888',
    @OtherDetail1 = NULL,
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @IsDefault = 1,   --  set this bank as default
    @IsActive = 1,
    @ActionUser = '4';

*/
CREATE   PROCEDURE [spe].[SchoolBankMaster_Update]
(
    @BankId             INT,
    @MasterType         VARCHAR(50),
    @MasterId           INT,
    @AccountNo          VARCHAR(50),	
	@AccountHolderName  VARCHAR(100),
	@AccountType      VARCHAR(50),
	@IsVerified        INT,
    @BankName           VARCHAR(100),
    @BranchName         VARCHAR(100),
    @IFSCCode           VARCHAR(50),
    @Address            VARCHAR(500),
    @Contact            VARCHAR(200),
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
	@IsDefault          INT,
	@IsActive           INT,
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
		IF @IsDefault = 1
		BEGIN
			UPDATE [spe].[SchoolBankMaster]
			SET IsDefault = 0,
				ModifiedBy = @ActionUser,
				ModifiedOn = GETDATE()
			WHERE MasterType = @MasterType
			  AND MasterId = @MasterId
			  AND BankId <> @BankId
			  AND IsActive = 1;
		END
    UPDATE [spe].[SchoolBankMaster]
    SET
        [MasterType]         = @MasterType,
        [MasterId]           = @MasterId,
        [AccountNo]          = @AccountNo,
		[AccountHolderName]  = @AccountHolderName,
		[AccountType]        = @AccountType,
		[IsVerified]         = @IsVerified,
        [BankName]           = @BankName,
        [BranchName]         = @BranchName,
        [IFSCCode]           = @IFSCCode,
        [Address]            = @Address,
        [Contact]            = @Contact,
        [OtherDetail1]       = @OtherDetail1,
        [OtherDetail2]       = @OtherDetail2,
        [OtherDetail3]       = @OtherDetail3,
        [OtherDetail4]       = @OtherDetail4,
        [OtherDetail5]       = @OtherDetail5,
        [OtherDetail6]       = @OtherDetail6,
		[IsDefault]          = @IsDefault,
		[IsActive]           = @IsActive,
        [ModifiedBy]         = @ActionUser,
        [ModifiedOn]         = GETDATE()
    WHERE [BankId] = @BankId;

    SELECT 
	   [BankId],
       [MasterType],
       [MasterId],
       [AccountNo],
	   [AccountHolderName],
	   [AccountType],
       [IsVerified],
       [BankName],
       [BranchName],
       [IFSCCode],
       [Address],
       [Contact],
       [OtherDetail1],
       [OtherDetail2],
       [OtherDetail3],
       [OtherDetail4],
       [OtherDetail5],
       [OtherDetail6],
	   ISNULL([IsDefault], 0) AS IsDefault,
       [IsActive],
       [IsDeleted],
       [CreatedBy],
       [CreatedOn],
       [ModifiedBy],
       [ModifiedOn]
	FROM [spe].[SchoolBankMaster]
    WHERE [BankId] = @BankId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolDocMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[SchoolDocMaster_Create]
(
    @MasterType      VARCHAR(50),
    @MasterId        INT,
    @DocType         VARCHAR(50),
    @DocNo           VARCHAR(50),
    @DocDescription  VARCHAR(200),
    @DocPath         VARCHAR(500),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @DocId INT;

	INSERT INTO [spe].[SchoolDocMaster]
	(
		[MasterType],
		[MasterId],
		[DocType],
		[DocNo],
		[DocDescription],
		[DocPath],
		[OtherDetail1],
		[OtherDetail2],
		[OtherDetail3],
		[OtherDetail4],
		[OtherDetail5],
		[OtherDetail6],
		[IsActive],
		[IsDeleted],
		[CreatedBy],
		[CreatedOn]
	)
	VALUES
	(
		@MasterType,
		@MasterId,
		@DocType,
		@DocNo,
		@DocDescription,
		@DocPath,
		@OtherDetail1,
		@OtherDetail2,
		@OtherDetail3,
		@OtherDetail4,
		@OtherDetail5,
		@OtherDetail6,
		1,        
		0,        
		@ActionUser,
		GETDATE()
		);

	SET @DocId = SCOPE_IDENTITY();

	SELECT 
		 [DocId]
		,[MasterType]
		,[MasterId]
		,[DocType]
		,[DocNo]
		,[DocDescription]
		,[DocPath]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[SchoolDocMaster]
	WHERE [DocId] = @DocId;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolDocMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolDocMaster_Delete]
(
      @DocId  INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[SchoolDocMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 0,
		[ModifiedBy] =  @ActionUser,
		[ModifiedOn] = getdate()
	WHERE  [DocId] = @DocId
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolDocMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolDocMaster_ReadAll]
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [spe].[SchoolDocMaster]
		WHERE [IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolDocMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolDocMaster_ReadById]
(
      @DocId  int
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [spe].[SchoolDocMaster]
		WHERE  [DocId] = @DocId
		AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolDocMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolDocMaster_ReadByMasterId]
(
      @MasterId  INT,
	  @MasterType VARCHAR(50)
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [spe].[SchoolDocMaster]
		WHERE [MasterId] =@MasterId
		AND [MasterType]= @MasterType
		AND [IsActive]= 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolDocMaster_ReadByMasterType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolDocMaster_ReadByMasterType]
(
      @MasterType  VARCHAR(50)
)
AS
 BEGIN 
		SET NOCOUNT ON;
		SELECT
			 [DocId]
			,[MasterType]
			,[MasterId]
			,[DocType]
			,[DocNo]
			,[DocDescription]
			,[DocPath]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [spe].[SchoolDocMaster]
		WHERE  [MasterType] = @MasterType
		AND[IsActive]= 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolDocMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[SchoolDocMaster_Update]
(
    @DocId           INT,
    @MasterType      VARCHAR(50),
    @MasterId        INT,
    @DocType         VARCHAR(50),
    @DocNo           VARCHAR(50),
    @DocDescription  VARCHAR(200),
    @DocPath         VARCHAR(500),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
	@IsActive       int,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[SchoolDocMaster]
    SET 
        [MasterType]     = @MasterType,
        [MasterId]       = @MasterId,
        [DocType]        = @DocType,
        [DocNo]          = @DocNo,
        [DocDescription] = @DocDescription,
        [DocPath]        = @DocPath,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
		[IsActive]		 = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE 
        [DocId] = @DocId;

    SELECT 
         [DocId]
        ,[MasterType]
        ,[MasterId]
        ,[DocType]
        ,[DocNo]
        ,[DocDescription]
        ,[DocPath]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[SchoolDocMaster]
    WHERE [DocId] = @DocId;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolImgMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[SchoolImgMaster_Create]
(
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ImgId INT;
		IF @IsDefault = 1
	BEGIN
	UPDATE[spe].[SchoolImgMaster]
		SET IsDefault = 0,
		ModifiedBy = @ActionUser,
		ModifiedOn = GETDATE()
	WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND IsActive = 1;
	END
    INSERT INTO [spe].[SchoolImgMaster]
    (
        [MasterType],
        [MasterId],
        [ImgPath],
        [ImgTitle],
        [IsDefault],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @MasterType,
        @MasterId,
        @ImgPath,
        @ImgTitle,
        @IsDefault,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,       
        0,       
        @ActionUser,
        GETDATE()
    );

    SET @ImgId = SCOPE_IDENTITY();

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[SchoolImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolImgMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolImgMaster_Delete]
(
   @ImgId INT,
   @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[SchoolImgMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] =1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = getdate()
	WHERE [ImgId] = @ImgId
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolImgMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolImgMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[SchoolImgMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolImgMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolImgMaster_ReadById]
(
   @ImgId int
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[SchoolImgMaster]
	WHERE [ImgId] = @ImgId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolImgMaster_ReadByMasterId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolImgMaster_ReadByMasterId]
(
   @MasterId INT,
   @MasterType varchar(50)

)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[SchoolImgMaster]
	WHERE [MasterId] = @MasterId
	  And[MasterType]=@MasterType
	AND [IsActive] = 1
	And [IsDeleted]=0;

END;
GO
/****** Object:  StoredProcedure [spe].[SchoolImgMaster_ReadByMasterType]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolImgMaster_ReadByMasterType]
(
   @MasterType VARCHAR(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
		 [ImgId]
		,[MasterType]
		,[MasterId]
		,[ImgPath]
		,[ImgTitle]
		,[IsDefault]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy] 
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[SchoolImgMaster]
	WHERE [MasterType] = @MasterType
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolImgMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[SchoolImgMaster_Update]
(
    @ImgId          INT,
    @MasterType     VARCHAR(50),
    @MasterId       INT,
    @ImgPath        VARCHAR(500),
    @ImgTitle       VARCHAR(100),
    @IsDefault      INT,
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
		IF @IsDefault = 1
		BEGIN
		UPDATE [spe].[SchoolImgMaster]
		SET 
			IsDefault = 0,
			ModifiedBy = @ActionUser,
			ModifiedOn = GETDATE()
		WHERE MasterType = @MasterType
		AND MasterId = @MasterId
		AND ImgId <> @ImgId
		AND IsActive = 1;
		END
    UPDATE [spe].[SchoolImgMaster]
    SET
         [MasterType]    = @MasterType
        ,[MasterId]      = @MasterId
        ,[ImgPath]       = @ImgPath
        ,[ImgTitle]      = @ImgTitle
        ,[IsDefault]     = @IsDefault
        ,[OtherDetail1]  = @OtherDetail1
        ,[OtherDetail2]  = @OtherDetail2
        ,[OtherDetail3]  = @OtherDetail3
        ,[OtherDetail4]  = @OtherDetail4
        ,[OtherDetail5]  = @OtherDetail5
        ,[OtherDetail6]  = @OtherDetail6
        ,[IsActive]      = @IsActive
        ,[ModifiedBy]    = @ActionUser
        ,[ModifiedOn]    = GETDATE()
    WHERE [ImgId] = @ImgId;

    SELECT 
         [ImgId]
        ,[MasterType]
        ,[MasterId]
        ,[ImgPath]
        ,[ImgTitle]
        ,[IsDefault]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[SchoolImgMaster]
    WHERE [ImgId] = @ImgId;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_AdminDashboard]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[SchoolMaster_AdminDashboard] 
    @StartDate = '2025-02-01', 
    @EndDate = '2025-06-28';
*/

CREATE   PROCEDURE [spe].[SchoolMaster_AdminDashboard]
(
    @StartDate DATETIME = NULL,
    @EndDate DATETIME = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    -- Set default dates
    IF (@StartDate IS NULL)
        SET @StartDate = DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0);

    IF (@EndDate IS NULL)
        SET @EndDate = GETDATE();

    -- Normalize time range to full days
    SET @StartDate = CAST(CONVERT(VARCHAR(10), @StartDate, 120) + ' 00:00:00.000' AS DATETIME);
    SET @EndDate = CAST(CONVERT(VARCHAR(10), @EndDate, 120) + ' 23:59:59.997' AS DATETIME);

    -- School Info
    SELECT 'TotalSchools' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[SchoolMaster] WITH (NOLOCK)
    WHERE [IsActive] = 1 AND CreatedOn BETWEEN @StartDate AND @EndDate;

    SELECT 'SchoolDocCount' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[SchoolDocMaster];

    SELECT 'SchoolsWithBankLinked' AS [Key], COUNT(DISTINCT BankId) AS [Value]
    FROM [spe].[SchoolBankMaster];

    -- Class Info
    SELECT 'TotalClasses' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[ClassMaster];

    -- Student & Parent Info
    SELECT 'TotalStudents' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[StudentMaster];

    SELECT 'TotalParents' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[ParentMaster];

    SELECT 'ParentStudentLinks' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[ParentStudentMapping];

    --  Parent Loan Info (New Section)
    SELECT 'ParentsWithLoanApplications' AS [Key], COUNT(DISTINCT LA.ParentId) AS [Value]
    FROM [spe].[LoanApplications] LA
    INNER JOIN [spe].[ParentMaster] PM ON PM.ParentId = LA.ParentId
    WHERE LA.CreatedOn BETWEEN @StartDate AND @EndDate;

    SELECT 'ParentsWithApprovedLoans' AS [Key], COUNT(DISTINCT LA.ParentId) AS [Value]
    FROM [spe].[LoanApplications] LA
    INNER JOIN [spe].[ParentMaster] PM ON PM.ParentId = LA.ParentId
    WHERE LA.Status = 'Approved' AND LA.CreatedOn BETWEEN @StartDate AND @EndDate;

    SELECT 'TotalLoanAmountToParents' AS [Key], ISNULL(SUM(LD.AmountDisbursed), 0) AS [Value]
    FROM [spe].[LoanDisbursements] LD
    INNER JOIN [spe].[LoanApplications] LA ON LA.LoanAppId = LD.LoanAppId
    WHERE LA.ParentId IS NOT NULL AND LA.CreatedOn BETWEEN @StartDate AND @EndDate;

    -- Fee Related
    SELECT 'TotalFeeStructures' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[FeeStructure];

    SELECT 'TotalFeeComponents' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[FeeComponentMaster];

    SELECT 'TotalInstallments' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[FeeInstallmentMaster];

    -- Payments
    SELECT 'TotalPayments' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[Payments]
    WHERE PaymentDate BETWEEN @StartDate AND @EndDate;

    SELECT 'TotalAmountPaid' AS [Key], ISNULL(SUM(AmountPaid), 0) AS [Value]
    FROM [spe].[Payments]
    WHERE PaymentDate BETWEEN @StartDate AND @EndDate;

    -- Loans
    SELECT 'TotalLoanApplications' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[LoanApplications]
    WHERE CreatedOn BETWEEN @StartDate AND @EndDate;

    SELECT 'ApprovedLoans' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[LoanApplications]
    WHERE Status = 'Approved' AND CreatedOn BETWEEN @StartDate AND @EndDate;

    SELECT 'RejectedLoans' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[LoanApplications]
    WHERE Status = 'Rejected' AND CreatedOn BETWEEN @StartDate AND @EndDate;

    SELECT 'TotalLoanDisbursed' AS [Key], ISNULL(SUM(AmountDisbursed), 0) AS [Value]
    FROM [spe].[LoanDisbursements]
    WHERE CreatedOn BETWEEN @StartDate AND @EndDate;

    -- Loan Tracking
    SELECT 'LoansInTracking' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[LoanTracking]
    WHERE Status = 'Pending' AND CreatedOn BETWEEN @StartDate AND @EndDate;

    SELECT 'LoansCompleted' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[LoanTracking]
    WHERE Status = 'Completed' AND CreatedOn BETWEEN @StartDate AND @EndDate;

    -- eKYC
    SELECT 'VerifiedKYC' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[eKYC]
    WHERE VerificationDate = 1 AND CreatedOn BETWEEN @StartDate AND @EndDate;

    SELECT 'PendingKYC' AS [Key], COUNT(*) AS [Value]
    FROM [spe].[eKYC]
    WHERE VerificationDate = 0 AND CreatedOn BETWEEN @StartDate AND @EndDate;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolMaster_Create]
(
    @SchoolName         VARCHAR(200),
    @Address            VARCHAR(50),
    @City               VARCHAR(100),
    @State              VARCHAR(100),
    @Pincode            VARCHAR(10),
    @AffiliationNumber  VARCHAR(100),
	@OnBoardingStatus   VARCHAR(50),
	@Longitude          DECIMAL(9,6),
    @Latitude           DECIMAL(9,6),
	@ImgPath			NVARCHAR(500) NULL,
    @PhoneNo			VARCHAR(20) NULL,
    @Email				VARCHAR(255) NULL,
    @Description		VARCHAR(500) NULL,
	@SchoolType			VARCHAR(100) NULL,         
    @Website			VARCHAR(255) NULL,            
    @BoardName			VARCHAR(100) NULL,          
    @MediumOfInstruction VARCHAR(100) NULL,
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SchoolId INT;

    INSERT INTO [spe].[SchoolMaster]
    (
       [SchoolName]
      ,[Address]
      ,[City]
      ,[State]
      ,[Pincode]
      ,[AffiliationNumber]
	  ,[OnBoardingStatus]
	  ,[Longitude]
      ,[Latitude]
	  ,[ImgPath]
      ,[PhoneNo]
      ,[Email]
      ,[Description]
	  ,[SchoolType]
      ,[Website]
      ,[BoardName]
      ,[MediumOfInstruction]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
    )
    VALUES
    (
        @SchoolName,
        @Address,
        @City,
        @State,
        @Pincode,
        @AffiliationNumber,
		@OnBoardingStatus,
		@Longitude,
        @Latitude,
	    @ImgPath,
        @PhoneNo,
        @Email,
        @Description,
		@SchoolType,		
		@Website,		
		@BoardName,		
		@MediumOfInstruction,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,            
        0,            
        @ActionUser,  
        GETDATE()      
    );

    SET @SchoolId = SCOPE_IDENTITY();

    SELECT 
       [SchoolId]
      ,[SchoolName]
      ,[Address]
      ,[City]
      ,[State]
      ,[Pincode]
      ,[AffiliationNumber]
	  ,[OnBoardingStatus]
	  ,[Longitude]
      ,[Latitude]
	  ,[ImgPath]
      ,[PhoneNo]
      ,[Email]
      ,[Description]
	  ,[SchoolType]
      ,[Website]
      ,[BoardName]
      ,[MediumOfInstruction]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [spe].[SchoolMaster]
    WHERE SchoolId = @SchoolId;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolMaster_Delete]
(
    @SchoolId INT,
	@ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON; 
	UPDATE [spe].[SchoolMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] =1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE SchoolId = @SchoolId
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_GetSummary]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[SchoolMaster_GetSummary]
AS
 BEGIN
  
    SET NOCOUNT ON ;
       DECLARE 
        @SchoolCount INT = 0,
        @ClassCount INT = 0,
        @StudentCount INT = 0,
        @ParentCount INT = 0,
        @TeacherCount INT = 0;

		SELECT @SchoolCount =COUNT(*)
		from spe.SchoolMaster
		WHERE ISNULL(IsDeleted,0) = 0
	    AND ISNULL(onBoardingStatus, '') = 'Completed'
		AND IsActive= 1;

		SELECT @ClassCount = COUNT(*)
		FROM spe.ClassMaster
		where ISNULL(IsDeleted,0) = 0;

    SELECT 
        @StudentCount = SUM(CASE WHEN UAM.AffiliationType = 'Student' THEN 1 ELSE 0 END),
        @ParentCount = SUM(CASE WHEN UAM.AffiliationType = 'Parent' THEN 1 ELSE 0 END),
        @TeacherCount = SUM(CASE WHEN UAM.AffiliationType = 'Teaching Staff' THEN 1 ELSE 0 END)
    FROM [spe].[UserAffiliationMapping] UAM
    WHERE ISNULL(UAM.IsDeleted, 0) = 0;


    -- 4 Final Response
    SELECT 
        @SchoolCount AS SchoolCount,
        @ClassCount AS ClassCount,
        @StudentCount AS StudentCount,
        @ParentCount AS ParentCount,
        @TeacherCount AS TeacherCount;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_OnboardingComplete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolMaster_OnboardingComplete]
(
    @SchoolId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[SchoolMaster]
    SET 
	OnBoardingStatus = 'Completed'
    WHERE SchoolId = @SchoolId;
END
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_OnboardingReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[SchoolMaster_OnboardingReadAllPaginated] 
    @PageSize = 10,
    @PageNo = 1,
    @OrderByClause = '',
    @WhereClause = '';
*/
CREATE   PROCEDURE [spe].[SchoolMaster_OnboardingReadAllPaginated]
(
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL

)
AS
 BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL =
		'SELECT
		ROW_NUMBER() OVER (ORDER BY ' + 
		ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
		') AS RowNum
			,[SchoolId]
			,[SchoolName]
			,[Address]
			,[City]
			,[State]
			,[Pincode]
			,[AffiliationNumber]
			,[OnBoardingStatus]
		    ,[Longitude]
			,[Latitude]
			,[ImgPath]
            ,[PhoneNo]
            ,[Email]
            ,[Description]
			,[SchoolType]
			,[Website]
			,[BoardName]
			,[MediumOfInstruction]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
	     ,COUNT(*) OVER () AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
		FROM [spe].[SchoolMaster]
		WHERE [IsActive] = 1 AND [OnBoardingStatus] = ''Pending''';


	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	PRINT @SQL

	EXEC sp_executesql @SQL;
	END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolMaster_ReadAll]
AS
 BEGIN 
   SET NOCOUNT ON; 
    SELECT 
	   [SchoolId]
      ,[SchoolName]
      ,[Address]
      ,[City]
      ,[State]
      ,[Pincode]
      ,[AffiliationNumber]
	  ,[OnBoardingStatus]
	  ,[Longitude]
	  ,[Latitude]
	  ,[ImgPath]
      ,[PhoneNo]
      ,[Email]
      ,[Description]
	  ,[SchoolType]
      ,[Website]
      ,[BoardName]
      ,[MediumOfInstruction]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[SchoolMaster]
	  WHERE[IsActive] = 1
	  AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[SchoolMaster_ReadAllPaginated]
(
   	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL
)
AS
 BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;
	SET NOCOUNT ON;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL ='
		SELECT 
		        ROW_NUMBER() OVER (ORDER BY ' + 
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
        ') AS RowNum,
		 [SchoolId]
		,[SchoolName]
		,[Address]
		,[City]
		,[State]
		,[Pincode]
		,[AffiliationNumber]
		,[OnBoardingStatus]
		,[Longitude]
		,[Latitude]
		,[ImgPath]
        ,[PhoneNo]
        ,[Email]
        ,[Description]
		,[SchoolType]
		,[Website]
		,[BoardName]
		,[MediumOfInstruction]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	,COUNT(*) OVER () AS TotalCount
	,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
	,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [spe].[SchoolMaster]
	WHERE[IsActive] = 1 AND [OnBoardingStatus] = ''Completed''';

	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
	SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
	SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
	SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';


	EXEC sp_executesql @SQL;
		
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolMaster_ReadById]
(
    @SchoolId INT
)
AS
 BEGIN 
   SET NOCOUNT ON; 
    SELECT 
	   [SchoolId]
      ,[SchoolName]
      ,[Address]
      ,[City]
      ,[State]
      ,[Pincode]
      ,[AffiliationNumber]
	  ,[OnBoardingStatus]
	  ,[Longitude]
	  ,[Latitude]
	  ,[ImgPath]
      ,[PhoneNo]
      ,[Email]
      ,[Description]
	  ,[SchoolType]
      ,[Website]
      ,[BoardName]
      ,[MediumOfInstruction]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[SchoolMaster]
	  WHERE[SchoolId] =@SchoolId
	 AND  [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_ReadByParentId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
	EXEC [spe].[SchoolMaster_ReadByParentId]1065,1024
*/
CREATE   PROCEDURE [spe].[SchoolMaster_ReadByParentId]
(
    @ParentId INT,
    @SchoolId INT
)
AS
BEGIN
    SET NOCOUNT ON;
    -- 1. Get School details
    SELECT SchoolId,SchoolName,Address,City,State,Pincode,AffiliationNumber,Longitude,Latitude
    FROM [spe].[SchoolMaster]
    WHERE 
        SchoolId = @SchoolId
        AND IsDeleted = 0 
        AND IsActive = 1;

    -- 2. Get Parent details
    SELECT UserId,FirstName,LastName,DOB,MobileNo,EmailId,Designation,ISNULL(ProfileImage,'') ProfileImage
    FROM [dbo].[UserMaster] 
    WHERE 
        UserId = @ParentId
		AND IsDeleted = 0 
        AND IsActive = 1;

    -- 3. Get Students linked to the Parent
    SELECT SM.UserId StudentId,(SM.FirstName + ISNULL(' ' +SM.MiddleName+ ' ',' ') + SM.LastName) AS StudentName,SR.AdmissionNo,SM.DOB,SR.SchoolId,SCM.ClassId,CM.ClassName,SM.Gender,SM.MobileNo Mobile,SM.EmailId Email,SM.Address 
    FROM [dbo].[UserMaster] SM
	LEFT JOIN [spe].[StudentClassMapping] SCM WITH (NOLOCK)
	ON  SM.UserId = SCM.UserId 
	LEFT JOIN [spe].[ClassMaster] CM WITH (NOLOCK)
	ON  SCM.ClassId = CM.ClassId 
	LEFT JOIN [spe].[StudentRegistration]  SR WITH (NOLOCK)
	ON  SM.UserId = SR.UserId 
    WHERE SM.IsDeleted = 0 AND CM.IsDeleted = 0
    AND EXISTS (
        SELECT 1 
        FROM [spe].[ParentStudentMapping] PSM
        WHERE PSM.StudentId = SM.UserId 
          AND PSM.ParentId = @ParentId 
          AND PSM.IsDeleted = 0 
          AND PSM.IsActive = 1
    );
END;

GO
/****** Object:  StoredProcedure [spe].[SchoolMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SchoolMaster_Update]
(
    @SchoolId           INT,
    @SchoolName         VARCHAR(200),
    @Address            VARCHAR(50),
    @City               VARCHAR(100),
    @State              VARCHAR(100),
    @Pincode            VARCHAR(10),
    @AffiliationNumber  VARCHAR(100),
	@OnBoardingStatus   VARCHAR(50),
	@Longitude          DECIMAL(9,6),
    @Latitude           DECIMAL(9,6),
	@ImgPath			NVARCHAR(500) NULL,
    @PhoneNo			VARCHAR(20) NULL,
    @Email				VARCHAR(255) NULL,
    @Description		VARCHAR(500) NULL,
	@SchoolType			VARCHAR(100) NULL,         
    @Website			VARCHAR(255) NULL,            
    @BoardName			VARCHAR(100) NULL,          
    @MediumOfInstruction VARCHAR(100) NULL,
    @OtherDetail1       VARCHAR(50),
    @OtherDetail2       VARCHAR(50),
    @OtherDetail3       VARCHAR(100),
    @OtherDetail4       VARCHAR(100),
    @OtherDetail5       VARCHAR(500),
    @OtherDetail6       VARCHAR(500),
	@IsActive           INT,
    @ActionUser         VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[SchoolMaster]
    SET
        SchoolName         = @SchoolName,
        Address            = @Address,
        City               = @City,
        State              = @State,
        Pincode            = @Pincode,
        AffiliationNumber  = @AffiliationNumber,
		OnBoardingStatus   = @OnBoardingStatus,
		Longitude          = @Longitude,
		Latitude           = @Latitude,
        ImgPath            = @ImgPath,      
        PhoneNo            = @PhoneNo,      
        Email              = @Email,        
        Description        = @Description,  
		SchoolType         = @SchoolType,
		Website			   = @Website,
		BoardName		   = @BoardName,
		MediumOfInstruction= @MediumOfInstruction,
        OtherDetail1       = @OtherDetail1,
        OtherDetail2       = @OtherDetail2,
        OtherDetail3       = @OtherDetail3,
        OtherDetail4       = @OtherDetail4,
        OtherDetail5       = @OtherDetail5,
        OtherDetail6       = @OtherDetail6,
		IsActive           =  @IsActive,
        ModifiedBy         = @ActionUser,
        ModifiedOn         = GETDATE()
    WHERE
        SchoolId = @SchoolId;  
    SELECT 
       [SchoolId]
      ,[SchoolName]
      ,[Address]
      ,[City]
      ,[State]
      ,[Pincode]
      ,[AffiliationNumber]
	  ,[OnBoardingStatus]
	  ,[Longitude]
      ,[Latitude]
	  ,[ImgPath]
      ,[PhoneNo]
      ,[Email]
      ,[Description]
	  ,[SchoolType]
      ,[Website]
      ,[BoardName]
      ,[MediumOfInstruction]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [spe].[SchoolMaster]
    WHERE SchoolId = @SchoolId
	AND IsActive = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SectionMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



/*
EXEC [spe].[SectionMaster_Create]
    @ClassId = 1,
    @SectionName = 'A',
    @Capacity = 40,
    @Description = 'Primary Section A',
    @OtherDetail1 = 'Morning',
    @OtherDetail2 = 'English Medium',
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[SectionMaster_Create]
(
    @ClassId         INT = NULL,
    @SectionName     VARCHAR(50),
    @Capacity        INT = NULL,
    @Description     VARCHAR(500) = NULL,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
    IF EXISTS (
        SELECT 1
        FROM [spe].[SectionMaster]
        WHERE ClassId = @ClassId
          AND SectionName = @SectionName
          AND IsActive = 1
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('Duplicate Section Name for this Class.', 16, 1);
        RETURN;
    END


    DECLARE @SectionId INT;

    INSERT INTO [spe].[SectionMaster]
    (
         [ClassId]
        ,[SectionName]
        ,[Capacity]
        ,[Description]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @ClassId
        ,@SectionName
        ,@Capacity
        ,@Description
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1               
        ,0               
        ,@ActionUser     
        ,GETDATE()       
    );

    SET @SectionId = SCOPE_IDENTITY();
    SELECT
         [SectionId]
        ,[ClassId]
        ,[SectionName]
        ,[Capacity]
        ,[Description]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[SectionMaster]
    WHERE [SectionId] = @SectionId;
END
GO
/****** Object:  StoredProcedure [spe].[SectionMaster_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [spe].[SectionMaster_CreateBulk]
(
   @SectionIdList [spe].[udt_SectionMaster] READONLY,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN 
		SET NOCOUNT ON;
		INSERT INTO [spe].[SectionMaster]
		(
			 [ClassId]
			,[SectionName]
			,[Capacity]
			,[Description]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
		)
		SELECT
			 [ClassId]
			,[SectionName]
			,[Capacity]
			,[Description]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,1
			,0
			,@ActionUser
			,GETDATE()
		FROM @SectionIdList;
		SELECT 
			 [SectionId]
			,[ClassId]
			,[SectionName]
			,[Capacity]
			,[Description]
			,[OtherDetail1]
			,[OtherDetail2]
			,[OtherDetail3]
			,[OtherDetail4]
			,[OtherDetail5]
			,[OtherDetail6]
			,[IsActive]
			,[IsDeleted]
			,[CreatedBy]
			,[CreatedOn]
			,[ModifiedBy]
			,[ModifiedOn]
		FROM [spe].[SectionMaster]
		WHERE [IsActive] =1
		AND [IsDeleted] = 0
		AND CreatedBy = @ActionUser
        AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE()); 
END;
GO
/****** Object:  StoredProcedure [spe].[SectionMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SectionMaster_Delete]
(
    @SectionId INT,
	@ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [spe].[SectionMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [SectionId] = @SectionId
END;
GO
/****** Object:  StoredProcedure [spe].[SectionMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SectionMaster_ReadAll]
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [SectionId]
		,[ClassId]
		,[SectionName]
		,[Capacity]
		,[Description]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[SectionMaster]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[SectionMaster_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SectionMaster_ReadByClassId]
(
    @ClassId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [SectionId]
		,[ClassId]
		,[SectionName]
		,[Capacity]
		,[Description]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		FROM [spe].[SectionMaster]
	WHERE [ClassId] = @ClassId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[SectionMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SectionMaster_ReadById]
(
    @SectionId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [SectionId]
		,[ClassId]
		,[SectionName]
		,[Capacity]
		,[Description]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
		FROM [spe].[SectionMaster]
	WHERE [SectionId] = @SectionId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[SectionMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[SectionMaster_Update]
    @SectionId = 1,
    @ClassId = 1,
    @SectionName = 'A',
    @Capacity = 50,
    @Description = 'Updated description',
    @OtherDetail1 = 'Updated 1',
    @OtherDetail2 = 'Updated 2',
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[SectionMaster_Update]
(
    @SectionId      INT,
    @ClassId        INT,
    @SectionName    VARCHAR(50),
    @Capacity       INT = NULL,
    @Description    VARCHAR(500) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
     SET NOCOUNT ON;
    ---- Validation: Check if the section exists and not deleted
    --IF NOT EXISTS (
    --    SELECT 1 FROM [spe].[SectionMaster]
    --    WHERE [SectionId] = @SectionId AND [IsDeleted] = 0
    --)
    --BEGIN
    --    RAISERROR('SectionId not found or already deleted.', 16, 1);
    --    RETURN;
    --END
    UPDATE [spe].[SectionMaster]
    SET
         [ClassId]      = @ClassId
        ,[SectionName]  = @SectionName
        ,[Capacity]     = @Capacity
        ,[Description]  = @Description
        ,[OtherDetail1] = @OtherDetail1
        ,[OtherDetail2] = @OtherDetail2
        ,[OtherDetail3] = @OtherDetail3
        ,[OtherDetail4] = @OtherDetail4
        ,[OtherDetail5] = @OtherDetail5
        ,[OtherDetail6] = @OtherDetail6
        ,[IsActive]     = @IsActive
        ,[ModifiedBy]   = @ActionUser
        ,[ModifiedOn]   = GETDATE()
    WHERE
        [SectionId] = @SectionId;
    SELECT
         [SectionId]
        ,[ClassId]
        ,[SectionName]
        ,[Capacity]
        ,[Description]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[SectionMaster]
    WHERE [SectionId] = @SectionId;
END
GO
/****** Object:  StoredProcedure [spe].[Settlement_ProcessDaily]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[Settlement_ProcessDaily]
AS
BEGIN
    SET NOCOUNT ON;
    INSERT INTO [spe].[SchoolSettlementLedger](SchoolId, Amount, ProcessedOn)
    SELECT SchoolId, SUM(Amount), GETDATE()
    FROM [spe].[Receipts]
    WHERE CAST(PaymentDate AS DATE) = CAST(GETDATE() AS DATE)
    GROUP BY SchoolId;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_AdmissionList]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[StudentAdmission_AdmissionList] @SchoolId = 5, @StartDate = NULL, @EndDate = NULL;

*/


CREATE PROCEDURE [spe].[StudentAdmission_AdmissionList]
(
    @SchoolId INT,
    @StartDate DATE = NULL,
    @EndDate DATE = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    -- Total Admissions Count
    SELECT 
        COUNT(*) AS TotalAdmissions
    FROM [spe].[StudentAdmission]
    WHERE 
        SchoolId = @SchoolId
        AND IsActive = 1
        AND IsDeleted = 0
        AND (@StartDate IS NULL OR ApplicationDate >= @StartDate)
        AND (@EndDate IS NULL OR ApplicationDate <= @EndDate);

    -- Admission List
    SELECT 
        ROW_NUMBER() OVER (ORDER BY ApplicationDate DESC) AS [SrNo],
        CONCAT(FirstName, ' ', ISNULL(MiddleName, ''), ' ', ISNULL(LastName, '')) AS [ApplicantName],
        CONVERT(VARCHAR(33), ApplicationDate, 127)  AS [Date],   --  Correct Format
        ISNULL(AdmissionStatus, 'Pending') AS [Status]
    FROM [spe].[StudentAdmission]
    WHERE 
        SchoolId = @SchoolId
        AND IsActive = 1
        AND IsDeleted = 0
        AND (@StartDate IS NULL OR ApplicationDate >= @StartDate)
        AND (@EndDate IS NULL OR ApplicationDate <= @EndDate)
    ORDER BY 
        ApplicationDate DESC;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*

*/

CREATE   PROCEDURE [spe].[StudentAdmission_Create]
(
    @AdmissionNo                 NVARCHAR(50)     = NULL,
    @SUserId                     INT              = NULL,
    @FirstName                   NVARCHAR(100)    = NULL,
    @MiddleName                  NVARCHAR(100)    = NULL,
    @LastName                    NVARCHAR(100)    = NULL,
    @ProfileImg                  NVARCHAR(500)    = NULL,
    @DOB                         DATE             = NULL,
    @Gender                      NVARCHAR(10)     = NULL,
    @BloodGroup                  NVARCHAR(5)      = NULL,
    @MobileNo                    NVARCHAR(15)     = NULL,
    @EmailId                     NVARCHAR(200)    = NULL,
    @AadharNumber                NVARCHAR(20)     = NULL,
    @PanNumber                   NVARCHAR(20)     = NULL,
    @Nationality                 NVARCHAR(50)     = NULL,
    @Religion                    NVARCHAR(50)     = NULL,
    @Caste                       NVARCHAR(50)     = NULL,
    @MotherTongue                NVARCHAR(50)     = NULL,
    @Address                     NVARCHAR(250)    = NULL,
    @Country                     NVARCHAR(50)     = NULL,
    @State                       NVARCHAR(50)     = NULL,
    @City                        NVARCHAR(50)     = NULL,
    @PinCode                     NVARCHAR(10)     = NULL,
    @SpecialNeeds                NVARCHAR(250)    = NULL,
    @DisabilityStatus            NVARCHAR(50)     = NULL,
    @SchoolId                    INT              = NULL,
    @AcademicYear                VARCHAR(20)      = NULL,
    @ClassId                     INT              = NULL,
    @AdmissionCategory           NVARCHAR(50)     = NULL,
    @AdmissionStatus             NVARCHAR(50)     = NULL,
    @ApplicationDate             DATE             = NULL,
    @ApprovedBy                  INT              = NULL,
    @ApprovedDate                DATE             = NULL,
    @Remarks                     NVARCHAR(250)    = NULL,
    @AdmissionDate               DATE             = NULL,
    @AdmissionMedium             NVARCHAR(200)    = NULL,
    @AdmissionType               NVARCHAR(50)     = NULL,
    @AdmissionBoard              NVARCHAR(50)     = NULL,
    @PreviousSchoolName          NVARCHAR(200)    = NULL,
    @PreviousSchoolAddress       NVARCHAR(250)    = NULL,
    @PreviousMedium              NVARCHAR(200)    = NULL,
    @PreviousLastClass           NVARCHAR(50)     = NULL,
    @PreviousMarksObtained       DECIMAL(5, 2)    = NULL,
    @PreviousBoard               NVARCHAR(50)     = NULL,
    @ReasonForTransfer           NVARCHAR(250)    = NULL,
    @TransferCertificateNo       NVARCHAR(50)     = NULL,
    @TCDate                      DATE             = NULL,
    @PGRelation                  NVARCHAR(50)     = NULL,
    @PGUserId                    INT              = NULL,
    @PGName                      NVARCHAR(200)    = NULL,
    @PGDOB                       DATE             = NULL,
    @PGProfileImg                NVARCHAR(500)    = NULL,
    @PGEducation                 NVARCHAR(200)    = NULL,
    @PGMobileNo                  NVARCHAR(15)     = NULL,
    @PGOccupation                NVARCHAR(100)    = NULL,
    @PGDesignation               NVARCHAR(100)    = NULL,
    @PGAnnualIncome              NVARCHAR(100)    = NULL,
    @PGEmailId                   NVARCHAR(100)    = NULL,
    @PGAadharNumber              NVARCHAR(20)     = NULL,
    @PGPanNumber                 NVARCHAR(20)     = NULL,
    @SGRelation                  NVARCHAR(50)     = NULL,
    @SGUserId                    INT              = NULL,
    @SGName                      NVARCHAR(200)    = NULL,
    @SGDOB                       DATE             = NULL,
    @SGProfileImg                NVARCHAR(500)    = NULL,
    @SGEducation                 NVARCHAR(200)    = NULL,
    @SGMobileNo                  NVARCHAR(15)     = NULL,
    @SGOccupation                NVARCHAR(100)    = NULL,
    @SGDesignation               NVARCHAR(100)    = NULL,
    @SGAnnualIncome              NVARCHAR(100)    = NULL,
    @SGEmailId                   NVARCHAR(100)    = NULL,
    @SGAadharNumber              NVARCHAR(20)     = NULL,
    @SGPanNumber                 NVARCHAR(20)     = NULL,
    @OtherDetail1                VARCHAR(50)      = NULL,
    @OtherDetail2                VARCHAR(50)      = NULL,
    @OtherDetail3                VARCHAR(100)     = NULL,
    @OtherDetail4                VARCHAR(100)     = NULL,
    @OtherDetail5                VARCHAR(500)     = NULL,
    @OtherDetail6                VARCHAR(500)     = NULL,
    @ActionUser                  VARCHAR(50)      = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AdmissionId INT;
	DECLARE  @InAdmissionNo VARCHAR(20);
	SELECT @InAdmissionNo = [dbo].[GetAdmissionNo]();

    INSERT INTO [spe].[StudentAdmission]
    (
        [AdmissionNo],
        [SUserId],
        [FirstName],
        [MiddleName],
        [LastName],
        [ProfileImg],
        [DOB],
        [Gender],
        [BloodGroup],
        [MobileNo],
        [EmailId],
        [AadharNumber],
        [PanNumber],
        [Nationality],
        [Religion],
        [Caste],
        [MotherTongue],
        [Address],
        [Country],
        [State],
        [City],
        [PinCode],
        [SpecialNeeds],
        [DisabilityStatus],
        [SchoolId],
        [AcademicYear],
        [ClassId],
        [AdmissionCategory],
        [AdmissionStatus],
        [ApplicationDate],
        [ApprovedBy],
        [ApprovedDate],
        [Remarks],
        [AdmissionDate],
        [AdmissionMedium],
        [AdmissionType],
        [AdmissionBoard],
        [PreviousSchoolName],
        [PreviousSchoolAddress],
        [PreviousMedium],
        [PreviousLastClass],
        [PreviousMarksObtained],
        [PreviousBoard],
        [ReasonForTransfer],
        [TransferCertificateNo],
        [TCDate],
        [PGRelation],
        [PGUserId],
        [PGName],
        [PGDOB],
        [PGProfileImg],
        [PGEducation],
        [PGMobileNo],
        [PGOccupation],
        [PGDesignation],
        [PGAnnualIncome],
        [PGEmailId],
        [PGAadharNumber],
        [PGPanNumber],
        [SGRelation],
        [SGUserId],
        [SGName],
        [SGDOB],
        [SGProfileImg],
        [SGEducation],
        [SGMobileNo],
        [SGOccupation],
        [SGDesignation],
        [SGAnnualIncome],
        [SGEmailId],
        [SGAadharNumber],
        [SGPanNumber],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @InAdmissionNo,   -- <-- Function-generated Admission No
        @SUserId,
        TRIM(@FirstName),
        TRIM(@MiddleName),
        TRIM(@LastName),
        TRIM(@ProfileImg),
        @DOB,
        TRIM(@Gender),
        TRIM(@BloodGroup),
        TRIM(@MobileNo),
        TRIM(@EmailId),
        TRIM(@AadharNumber),
        TRIM(@PanNumber),
        TRIM(@Nationality),
        TRIM(@Religion),
        TRIM(@Caste),
        TRIM(@MotherTongue),
        TRIM(@Address),
        TRIM(@Country),
        TRIM(@State),
        TRIM(@City),
        TRIM(@PinCode),
        TRIM(@SpecialNeeds),
        TRIM(@DisabilityStatus),
        @SchoolId,
        TRIM(@AcademicYear),
        @ClassId,
        TRIM(@AdmissionCategory),
        TRIM(@AdmissionStatus),
        @ApplicationDate,
        @ApprovedBy,
        @ApprovedDate,
        TRIM(@Remarks),
        @AdmissionDate,
        TRIM(@AdmissionMedium),
        TRIM(@AdmissionType),
        TRIM(@AdmissionBoard),
        TRIM(@PreviousSchoolName),
        TRIM(@PreviousSchoolAddress),
        TRIM(@PreviousMedium),
        TRIM(@PreviousLastClass),
        @PreviousMarksObtained,
        TRIM(@PreviousBoard),
        TRIM(@ReasonForTransfer),
        TRIM(@TransferCertificateNo),
        @TCDate,
        TRIM(@PGRelation),
        @PGUserId,
        TRIM(@PGName),
        @PGDOB,
        TRIM(@PGProfileImg),
        TRIM(@PGEducation),
        TRIM(@PGMobileNo),
        TRIM(@PGOccupation),
        TRIM(@PGDesignation),
        TRIM(@PGAnnualIncome),
        TRIM(@PGEmailId),
        TRIM(@PGAadharNumber),
        TRIM(@PGPanNumber),
        TRIM(@SGRelation),
        @SGUserId,
        TRIM(@SGName),
        @SGDOB,
        TRIM(@SGProfileImg),
        TRIM(@SGEducation),
        TRIM(@SGMobileNo),
        TRIM(@SGOccupation),
        TRIM(@SGDesignation),
        TRIM(@SGAnnualIncome),
        TRIM(@SGEmailId),
        TRIM(@SGAadharNumber),
        TRIM(@SGPanNumber),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1, -- IsActive
        0, -- IsDeleted
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @AdmissionId = SCOPE_IDENTITY();

    SELECT 
        [AdmissionId],
        [AdmissionNo],
        [SUserId],
        [FirstName],
        [MiddleName],
        [LastName],
        [ProfileImg],
        [DOB],
        [Gender],
        [BloodGroup],
        [MobileNo],
        [EmailId],
        [AadharNumber],
        [PanNumber],
        [Nationality],
        [Religion],
        [Caste],
        [MotherTongue],
        [Address],
        [Country],
        [State],
        [City],
        [PinCode],
        [SpecialNeeds],
        [DisabilityStatus],
        [SchoolId],
        [AcademicYear],
        [ClassId],
        [AdmissionCategory],
        [AdmissionStatus],
        [ApplicationDate],
        [ApprovedBy],
        [ApprovedDate],
        [Remarks],
        [AdmissionDate],
        [AdmissionMedium],
        [AdmissionType],
        [AdmissionBoard],
        [PreviousSchoolName],
        [PreviousSchoolAddress],
        [PreviousMedium],
        [PreviousLastClass],
        [PreviousMarksObtained],
        [PreviousBoard],
        [ReasonForTransfer],
        [TransferCertificateNo],
        [TCDate],
        [PGRelation],
        [PGUserId],
        [PGName],
        [PGDOB],
        [PGProfileImg],
        [PGEducation],
        [PGMobileNo],
        [PGOccupation],
        [PGDesignation],
        [PGAnnualIncome],
        [PGEmailId],
        [PGAadharNumber],
        [PGPanNumber],
        [SGRelation],
        [SGUserId],
        [SGName],
        [SGDOB],
        [SGProfileImg],
        [SGEducation],
        [SGMobileNo],
        [SGOccupation],
        [SGDesignation],
        [SGAnnualIncome],
        [SGEmailId],
        [SGAadharNumber],
        [SGPanNumber],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[StudentAdmission]
    WHERE [AdmissionId] = @AdmissionId;
END
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentAdmission_Delete]
(
   @AdmissionId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	  UPDATE [spe].[StudentAdmission]
	  SET
        [IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
	  WHERE [AdmissionId] = @AdmissionId
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentAdmission_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AdmissionId]
      ,[AdmissionNo]
      ,[SUserId]
      ,[FirstName]
      ,[MiddleName]
      ,[LastName]
      ,[ProfileImg]
      ,[DOB]
      ,[Gender]
      ,[BloodGroup]
      ,[MobileNo]
      ,[EmailId]
      ,[AadharNumber]
      ,[PanNumber]
      ,[Nationality]
      ,[Religion]
      ,[Caste]
      ,[MotherTongue]
      ,[Address]
      ,[Country]
      ,[State]
      ,[City]
      ,[PinCode]
      ,[SpecialNeeds]
      ,[DisabilityStatus]
      ,[SchoolId]
      ,[AcademicYear]
      ,[ClassId]
      ,[AdmissionCategory]
      ,[AdmissionStatus]
      ,[ApplicationDate]
      ,[ApprovedBy]
      ,[ApprovedDate]
      ,[Remarks]
      ,[AdmissionDate]
      ,[AdmissionMedium]
      ,[AdmissionType]
      ,[AdmissionBoard]
      ,[PreviousSchoolName]
      ,[PreviousSchoolAddress]
      ,[PreviousMedium]
      ,[PreviousLastClass]
      ,[PreviousMarksObtained]
      ,[PreviousBoard]
      ,[ReasonForTransfer]
      ,[TransferCertificateNo]
      ,[TCDate]
      ,[PGRelation]
      ,[PGUserId]
      ,[PGName]
      ,[PGDOB]
      ,[PGProfileImg]
      ,[PGEducation]
      ,[PGMobileNo]
      ,[PGOccupation]
      ,[PGDesignation]
      ,[PGAnnualIncome]
      ,[PGEmailId]
      ,[PGAadharNumber]
      ,[PGPanNumber]
      ,[SGRelation]
      ,[SGUserId]
      ,[SGName]
      ,[SGDOB]
      ,[SGProfileImg]
      ,[SGEducation]
      ,[SGMobileNo]
      ,[SGOccupation]
      ,[SGDesignation]
      ,[SGAnnualIncome]
      ,[SGEmailId]
      ,[SGAadharNumber]
      ,[SGPanNumber]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[StudentAdmission]
	  WHERE [IsActive]= 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentAdmission_ReadByClassId]
(
   @ClassId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AdmissionId]
      ,[AdmissionNo]
      ,[SUserId]
      ,[FirstName]
      ,[MiddleName]
      ,[LastName]
      ,[ProfileImg]
      ,[DOB]
      ,[Gender]
      ,[BloodGroup]
      ,[MobileNo]
      ,[EmailId]
      ,[AadharNumber]
      ,[PanNumber]
      ,[Nationality]
      ,[Religion]
      ,[Caste]
      ,[MotherTongue]
      ,[Address]
      ,[Country]
      ,[State]
      ,[City]
      ,[PinCode]
      ,[SpecialNeeds]
      ,[DisabilityStatus]
      ,[SchoolId]
      ,[AcademicYear]
      ,[ClassId]
      ,[AdmissionCategory]
      ,[AdmissionStatus]
      ,[ApplicationDate]
      ,[ApprovedBy]
      ,[ApprovedDate]
      ,[Remarks]
      ,[AdmissionDate]
      ,[AdmissionMedium]
      ,[AdmissionType]
      ,[AdmissionBoard]
      ,[PreviousSchoolName]
      ,[PreviousSchoolAddress]
      ,[PreviousMedium]
      ,[PreviousLastClass]
      ,[PreviousMarksObtained]
      ,[PreviousBoard]
      ,[ReasonForTransfer]
      ,[TransferCertificateNo]
      ,[TCDate]
      ,[PGRelation]
      ,[PGUserId]
      ,[PGName]
      ,[PGDOB]
      ,[PGProfileImg]
      ,[PGEducation]
      ,[PGMobileNo]
      ,[PGOccupation]
      ,[PGDesignation]
      ,[PGAnnualIncome]
      ,[PGEmailId]
      ,[PGAadharNumber]
      ,[PGPanNumber]
      ,[SGRelation]
      ,[SGUserId]
      ,[SGName]
      ,[SGDOB]
      ,[SGProfileImg]
      ,[SGEducation]
      ,[SGMobileNo]
      ,[SGOccupation]
      ,[SGDesignation]
      ,[SGAnnualIncome]
      ,[SGEmailId]
      ,[SGAadharNumber]
      ,[SGPanNumber]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[StudentAdmission]
	  WHERE [ClassId] = @ClassId
	  AND [IsActive]= 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentAdmission_ReadById]
(
   @AdmissionId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AdmissionId]
      ,[AdmissionNo]
      ,[SUserId]
      ,[FirstName]
      ,[MiddleName]
      ,[LastName]
      ,[ProfileImg]
      ,[DOB]
      ,[Gender]
      ,[BloodGroup]
      ,[MobileNo]
      ,[EmailId]
      ,[AadharNumber]
      ,[PanNumber]
      ,[Nationality]
      ,[Religion]
      ,[Caste]
      ,[MotherTongue]
      ,[Address]
      ,[Country]
      ,[State]
      ,[City]
      ,[PinCode]
      ,[SpecialNeeds]
      ,[DisabilityStatus]
      ,[SchoolId]
      ,[AcademicYear]
      ,[ClassId]
      ,[AdmissionCategory]
      ,[AdmissionStatus]
      ,[ApplicationDate]
      ,[ApprovedBy]
      ,[ApprovedDate]
      ,[Remarks]
      ,[AdmissionDate]
      ,[AdmissionMedium]
      ,[AdmissionType]
      ,[AdmissionBoard]
      ,[PreviousSchoolName]
      ,[PreviousSchoolAddress]
      ,[PreviousMedium]
      ,[PreviousLastClass]
      ,[PreviousMarksObtained]
      ,[PreviousBoard]
      ,[ReasonForTransfer]
      ,[TransferCertificateNo]
      ,[TCDate]
      ,[PGRelation]
      ,[PGUserId]
      ,[PGName]
      ,[PGDOB]
      ,[PGProfileImg]
      ,[PGEducation]
      ,[PGMobileNo]
      ,[PGOccupation]
      ,[PGDesignation]
      ,[PGAnnualIncome]
      ,[PGEmailId]
      ,[PGAadharNumber]
      ,[PGPanNumber]
      ,[SGRelation]
      ,[SGUserId]
      ,[SGName]
      ,[SGDOB]
      ,[SGProfileImg]
      ,[SGEducation]
      ,[SGMobileNo]
      ,[SGOccupation]
      ,[SGDesignation]
      ,[SGAnnualIncome]
      ,[SGEmailId]
      ,[SGAadharNumber]
      ,[SGPanNumber]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[StudentAdmission]
	  WHERE [AdmissionId] = @AdmissionId
	  AND [IsActive]= 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[StudentAdmission_ReadBySchoolId] 
    @SchoolId = 5, 
    @ClassId = 22, 
	@AdmissionStatus = 'Approved',
    @PageSize = 10, 
    @PageNo = 1;

*/
CREATE   PROCEDURE [spe].[StudentAdmission_ReadBySchoolId]
(
    @SchoolId INT,
    @ClassId INT = NULL,  
	@AdmissionStatus VARCHAR(50) = NULL,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
        SELECT 
            ROW_NUMBER() OVER (ORDER BY ' + 
            ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
            ') AS RowNum,
              A.[AdmissionId]
             ,A.[AdmissionNo]
             ,A.[SUserId]
             ,A.[FirstName]
             ,A.[MiddleName]
             ,A.[LastName]
             ,A.[ProfileImg]
             ,A.[DOB]
             ,A.[Gender]
             ,A.[BloodGroup]
             ,A.[MobileNo]
             ,A.[EmailId]
             ,A.[AadharNumber]
             ,A.[PanNumber]
             ,A.[Nationality]
             ,A.[Religion]
             ,A.[Caste]
             ,A.[MotherTongue]
             ,A.[Address]
             ,A.[Country]
             ,A.[State]
             ,A.[City]
             ,A.[PinCode]
             ,A.[SpecialNeeds]
             ,A.[DisabilityStatus]
             ,A.[SchoolId]
             ,A.[AcademicYear]
             ,A.[ClassId]
             ,B.[ClassName]
             ,A.[AdmissionCategory]
             ,A.[AdmissionStatus]
             ,A.[ApplicationDate]
             ,A.[ApprovedBy]
             ,C.[FirstName] + '' '' + C.[LastName] AS ApproverName
             ,A.[ApprovedDate]
             ,A.[Remarks]
             ,A.[AdmissionDate]
             ,A.[AdmissionMedium]
             ,A.[AdmissionType]
             ,A.[AdmissionBoard]
             ,A.[PreviousSchoolName]
             ,A.[PreviousSchoolAddress]
             ,A.[PreviousMedium]
             ,A.[PreviousLastClass]
             ,A.[PreviousMarksObtained]
             ,A.[PreviousBoard]
             ,A.[ReasonForTransfer]
             ,A.[TransferCertificateNo]
             ,A.[TCDate]
             ,A.[PGRelation]
             ,A.[PGUserId]
             ,A.[PGName]
             ,A.[PGDOB]
             ,A.[PGProfileImg]
             ,A.[PGEducation]
             ,A.[PGMobileNo]
             ,A.[PGOccupation]
             ,A.[PGDesignation]
             ,A.[PGAnnualIncome]
             ,A.[PGEmailId]
             ,A.[PGAadharNumber]
             ,A.[PGPanNumber]
             ,A.[SGRelation]
             ,A.[SGUserId]
             ,A.[SGName]
             ,A.[SGDOB]
             ,A.[SGProfileImg]
             ,A.[SGEducation]
             ,A.[SGMobileNo]
             ,A.[SGOccupation]
             ,A.[SGDesignation]
             ,A.[SGAnnualIncome]
             ,A.[SGEmailId]
             ,A.[SGAadharNumber]
             ,A.[SGPanNumber]
             ,A.[OtherDetail1]
             ,A.[OtherDetail2]
             ,A.[OtherDetail3]
             ,A.[OtherDetail4]
             ,A.[OtherDetail5]
             ,A.[OtherDetail6]
             ,A.[IsActive]
             ,A.[IsDeleted]
             ,A.[CreatedBy]
             ,A.[CreatedOn]
             ,A.[ModifiedBy]
             ,A.[ModifiedOn]
             ,COUNT(*) OVER () AS TotalCount
             ,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
             ,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
        FROM [spe].[StudentAdmission] A
        LEFT OUTER JOIN [spe].[ClassMaster] B
            ON A.[ClassId] = B.[ClassId]
        LEFT OUTER JOIN [dbo].[UserMaster] C
            ON A.[ApprovedBy] = C.[UserId]
        WHERE A.[SchoolId] = ' + CAST(@SchoolId AS NVARCHAR) + '
          AND A.[IsActive] = 1
          AND A.[IsDeleted] = 0';

    IF @ClassId IS NOT NULL
        SET @SQL = @SQL + ' AND A.[ClassId] = ' + CAST(@ClassId AS NVARCHAR);
	
	IF @AdmissionStatus IS NOT NULL AND LTRIM(RTRIM(@AdmissionStatus)) <> ''
    SET @SQL = @SQL + ' AND A.[AdmissionStatus] = ''' + REPLACE(@AdmissionStatus, '''', '''''') + '''';

    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    SET @SQL = @SQL + '
        OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
        FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL;
    EXEC (@SQL);
END
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_ReadBySUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentAdmission_ReadBySUserId]
(
   @SUserId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AdmissionId]
      ,[AdmissionNo]
      ,[SUserId]
      ,[FirstName]
      ,[MiddleName]
      ,[LastName]
      ,[ProfileImg]
      ,[DOB]
      ,[Gender]
      ,[BloodGroup]
      ,[MobileNo]
      ,[EmailId]
      ,[AadharNumber]
      ,[PanNumber]
      ,[Nationality]
      ,[Religion]
      ,[Caste]
      ,[MotherTongue]
      ,[Address]
      ,[Country]
      ,[State]
      ,[City]
      ,[PinCode]
      ,[SpecialNeeds]
      ,[DisabilityStatus]
      ,[SchoolId]
      ,[AcademicYear]
      ,[ClassId]
      ,[AdmissionCategory]
      ,[AdmissionStatus]
      ,[ApplicationDate]
      ,[ApprovedBy]
      ,[ApprovedDate]
      ,[Remarks]
      ,[AdmissionDate]
      ,[AdmissionMedium]
      ,[AdmissionType]
      ,[AdmissionBoard]
      ,[PreviousSchoolName]
      ,[PreviousSchoolAddress]
      ,[PreviousMedium]
      ,[PreviousLastClass]
      ,[PreviousMarksObtained]
      ,[PreviousBoard]
      ,[ReasonForTransfer]
      ,[TransferCertificateNo]
      ,[TCDate]
      ,[PGRelation]
      ,[PGUserId]
      ,[PGName]
      ,[PGDOB]
      ,[PGProfileImg]
      ,[PGEducation]
      ,[PGMobileNo]
      ,[PGOccupation]
      ,[PGDesignation]
      ,[PGAnnualIncome]
      ,[PGEmailId]
      ,[PGAadharNumber]
      ,[PGPanNumber]
      ,[SGRelation]
      ,[SGUserId]
      ,[SGName]
      ,[SGDOB]
      ,[SGProfileImg]
      ,[SGEducation]
      ,[SGMobileNo]
      ,[SGOccupation]
      ,[SGDesignation]
      ,[SGAnnualIncome]
      ,[SGEmailId]
      ,[SGAadharNumber]
      ,[SGPanNumber]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[StudentAdmission]
	  WHERE [SUserId] = @SUserId
	  AND [IsActive]= 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAdmission_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[StudentAdmission_Update]
(
    @AdmissionId                 INT              = NULL,
    @AdmissionNo                 NVARCHAR(50)     = NULL,
    @SUserId                     INT              = NULL,
    @FirstName                   NVARCHAR(100)    = NULL,
    @MiddleName                  NVARCHAR(100)    = NULL,
    @LastName                    NVARCHAR(100)    = NULL,
    @ProfileImg                  NVARCHAR(500)    = NULL,
    @DOB                         DATE             = NULL,
    @Gender                      NVARCHAR(10)     = NULL,
    @BloodGroup                  NVARCHAR(5)      = NULL,
    @MobileNo                    NVARCHAR(15)     = NULL,
    @EmailId                     NVARCHAR(200)    = NULL,
    @AadharNumber                NVARCHAR(20)     = NULL,
    @PanNumber                   NVARCHAR(20)     = NULL,
    @Nationality                 NVARCHAR(50)     = NULL,
    @Religion                    NVARCHAR(50)     = NULL,
    @Caste                       NVARCHAR(50)     = NULL,
    @MotherTongue                NVARCHAR(50)     = NULL,
    @Address                     NVARCHAR(250)    = NULL,
    @Country                     NVARCHAR(50)     = NULL,
    @State                       NVARCHAR(50)     = NULL,
    @City                        NVARCHAR(50)     = NULL,
    @PinCode                     NVARCHAR(10)     = NULL,
    @SpecialNeeds                NVARCHAR(250)    = NULL,
    @DisabilityStatus            NVARCHAR(50)     = NULL,
    @SchoolId                    INT              = NULL,
    @AcademicYear                VARCHAR(20)      = NULL,
    @ClassId                     INT              = NULL,
    @AdmissionCategory           NVARCHAR(50)     = NULL,
    @AdmissionStatus             NVARCHAR(50)     = NULL,
    @ApplicationDate             DATE             = NULL,
    @ApprovedBy                  INT              = NULL,
    @ApprovedDate                DATE             = NULL,
    @Remarks                     NVARCHAR(250)    = NULL,
    @AdmissionDate               DATE             = NULL,
    @AdmissionMedium             NVARCHAR(200)    = NULL,
    @AdmissionType               NVARCHAR(50)     = NULL,
    @AdmissionBoard              NVARCHAR(50)     = NULL,
    @PreviousSchoolName          NVARCHAR(200)    = NULL,
    @PreviousSchoolAddress       NVARCHAR(250)    = NULL,
    @PreviousMedium              NVARCHAR(200)    = NULL,
    @PreviousLastClass           NVARCHAR(50)     = NULL,
    @PreviousMarksObtained       DECIMAL(5, 2)    = NULL,
    @PreviousBoard               NVARCHAR(50)     = NULL,
    @ReasonForTransfer           NVARCHAR(250)    = NULL,
    @TransferCertificateNo       NVARCHAR(50)     = NULL,
    @TCDate                      DATE             = NULL,
    @PGRelation                  NVARCHAR(50)     = NULL,
    @PGUserId                    INT              = NULL,
    @PGName                      NVARCHAR(200)    = NULL,
    @PGDOB                       DATE             = NULL,
    @PGProfileImg                NVARCHAR(500)    = NULL,
    @PGEducation                 NVARCHAR(200)    = NULL,
    @PGMobileNo                  NVARCHAR(15)     = NULL,
    @PGOccupation                NVARCHAR(100)    = NULL,
    @PGDesignation               NVARCHAR(100)    = NULL,
    @PGAnnualIncome              NVARCHAR(100)    = NULL,
    @PGEmailId                   NVARCHAR(100)    = NULL,
    @PGAadharNumber              NVARCHAR(20)     = NULL,
    @PGPanNumber                 NVARCHAR(20)     = NULL,
    @SGRelation                  NVARCHAR(50)     = NULL,
    @SGUserId                    INT              = NULL,
    @SGName                      NVARCHAR(200)    = NULL,
    @SGDOB                       DATE             = NULL,
    @SGProfileImg                NVARCHAR(500)    = NULL,
    @SGEducation                 NVARCHAR(200)    = NULL,
    @SGMobileNo                  NVARCHAR(15)     = NULL,
    @SGOccupation                NVARCHAR(100)    = NULL,
    @SGDesignation               NVARCHAR(100)    = NULL,
    @SGAnnualIncome              NVARCHAR(100)    = NULL,
    @SGEmailId                   NVARCHAR(100)    = NULL,
    @SGAadharNumber              NVARCHAR(20)     = NULL,
    @SGPanNumber                 NVARCHAR(20)     = NULL,
    @OtherDetail1                VARCHAR(50)      = NULL,
    @OtherDetail2                VARCHAR(50)      = NULL,
    @OtherDetail3                VARCHAR(100)     = NULL,
    @OtherDetail4                VARCHAR(100)     = NULL,
    @OtherDetail5                VARCHAR(500)     = NULL,
    @OtherDetail6                VARCHAR(500)     = NULL,
	@IsActive					INT,
    @ActionUser                  VARCHAR(50)      = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[StudentAdmission]
    SET
        [AdmissionNo]              = TRIM(@AdmissionNo),
        [SUserId]                   = @SUserId,
        [FirstName]                 = TRIM(@FirstName),
        [MiddleName]                = TRIM(@MiddleName),
        [LastName]                  = TRIM(@LastName),
        [ProfileImg]                 = TRIM(@ProfileImg),
        [DOB]                        = @DOB,
        [Gender]                     = TRIM(@Gender),
        [BloodGroup]                 = TRIM(@BloodGroup),
        [MobileNo]                   = TRIM(@MobileNo),
        [EmailId]                    = TRIM(@EmailId),
        [AadharNumber]               = TRIM(@AadharNumber),
        [PanNumber]                  = TRIM(@PanNumber),
        [Nationality]                = TRIM(@Nationality),
        [Religion]                   = TRIM(@Religion),
        [Caste]                      = TRIM(@Caste),
        [MotherTongue]               = TRIM(@MotherTongue),
        [Address]                    = TRIM(@Address),
        [Country]                    = TRIM(@Country),
        [State]                      = TRIM(@State),
        [City]                       = TRIM(@City),
        [PinCode]                    = TRIM(@PinCode),
        [SpecialNeeds]               = TRIM(@SpecialNeeds),
        [DisabilityStatus]           = TRIM(@DisabilityStatus),
        [SchoolId]                   = @SchoolId,
        [AcademicYear]               = TRIM(@AcademicYear),
        [ClassId]                    = @ClassId,
        [AdmissionCategory]          = TRIM(@AdmissionCategory),
        [AdmissionStatus]            = TRIM(@AdmissionStatus),
        [ApplicationDate]            = @ApplicationDate,
        [ApprovedBy]                  = @ApprovedBy,
        [ApprovedDate]                = @ApprovedDate,
        [Remarks]                     = TRIM(@Remarks),
        [AdmissionDate]               = @AdmissionDate,
        [AdmissionMedium]             = TRIM(@AdmissionMedium),
        [AdmissionType]               = TRIM(@AdmissionType),
        [AdmissionBoard]              = TRIM(@AdmissionBoard),
        [PreviousSchoolName]          = TRIM(@PreviousSchoolName),
        [PreviousSchoolAddress]       = TRIM(@PreviousSchoolAddress),
        [PreviousMedium]              = TRIM(@PreviousMedium),
        [PreviousLastClass]           = TRIM(@PreviousLastClass),
        [PreviousMarksObtained]       = @PreviousMarksObtained,
        [PreviousBoard]               = TRIM(@PreviousBoard),
        [ReasonForTransfer]           = TRIM(@ReasonForTransfer),
        [TransferCertificateNo]       = TRIM(@TransferCertificateNo),
        [TCDate]                      = @TCDate,
        [PGRelation]                  = TRIM(@PGRelation),
        [PGUserId]                    = @PGUserId,
        [PGName]                      = TRIM(@PGName),
        [PGDOB]                       = @PGDOB,
        [PGProfileImg]                = TRIM(@PGProfileImg),
        [PGEducation]                 = TRIM(@PGEducation),
        [PGMobileNo]                  = TRIM(@PGMobileNo),
        [PGOccupation]                = TRIM(@PGOccupation),
        [PGDesignation]               = TRIM(@PGDesignation),
        [PGAnnualIncome]              = TRIM(@PGAnnualIncome),
        [PGEmailId]                   = TRIM(@PGEmailId),
        [PGAadharNumber]              = TRIM(@PGAadharNumber),
        [PGPanNumber]                 = TRIM(@PGPanNumber),
        [SGRelation]                  = TRIM(@SGRelation),
        [SGUserId]                    = @SGUserId,
        [SGName]                      = TRIM(@SGName),
        [SGDOB]                       = @SGDOB,
        [SGProfileImg]                = TRIM(@SGProfileImg),
        [SGEducation]                 = TRIM(@SGEducation),
        [SGMobileNo]                  = TRIM(@SGMobileNo),
        [SGOccupation]                = TRIM(@SGOccupation),
        [SGDesignation]               = TRIM(@SGDesignation),
        [SGAnnualIncome]              = TRIM(@SGAnnualIncome),
        [SGEmailId]                   = TRIM(@SGEmailId),
        [SGAadharNumber]              = TRIM(@SGAadharNumber),
        [SGPanNumber]                 = TRIM(@SGPanNumber),
        [OtherDetail1]                 = TRIM(@OtherDetail1),
        [OtherDetail2]                 = TRIM(@OtherDetail2),
        [OtherDetail3]                 = TRIM(@OtherDetail3),
        [OtherDetail4]                 = TRIM(@OtherDetail4),
        [OtherDetail5]                 = TRIM(@OtherDetail5),
        [OtherDetail6]                 = TRIM(@OtherDetail6),
		[IsActive]						=@IsActive,
        [ModifiedBy]                   = TRIM(@ActionUser),
        [ModifiedOn]                   = GETDATE()
    WHERE 
        [AdmissionId] = @AdmissionId;

    SELECT 
        [AdmissionId],
        [AdmissionNo],
        [SUserId],
        [FirstName],
        [MiddleName],
        [LastName],
        [ProfileImg],
        [DOB],
        [Gender],
        [BloodGroup],
        [MobileNo],
        [EmailId],
        [AadharNumber],
        [PanNumber],
        [Nationality],
        [Religion],
        [Caste],
        [MotherTongue],
        [Address],
        [Country],
        [State],
        [City],
        [PinCode],
        [SpecialNeeds],
        [DisabilityStatus],
        [SchoolId],
        [AcademicYear],
        [ClassId],
        [AdmissionCategory],
        [AdmissionStatus],
        [ApplicationDate],
        [ApprovedBy],
        [ApprovedDate],
        [Remarks],
        [AdmissionDate],
        [AdmissionMedium],
        [AdmissionType],
        [AdmissionBoard],
        [PreviousSchoolName],
        [PreviousSchoolAddress],
        [PreviousMedium],
        [PreviousLastClass],
        [PreviousMarksObtained],
        [PreviousBoard],
        [ReasonForTransfer],
        [TransferCertificateNo],
        [TCDate],
        [PGRelation],
        [PGUserId],
        [PGName],
        [PGDOB],
        [PGProfileImg],
        [PGEducation],
        [PGMobileNo],
        [PGOccupation],
        [PGDesignation],
        [PGAnnualIncome],
        [PGEmailId],
        [PGAadharNumber],
        [PGPanNumber],
        [SGRelation],
        [SGUserId],
        [SGName],
        [SGDOB],
        [SGProfileImg],
        [SGEducation],
        [SGMobileNo],
        [SGOccupation],
        [SGDesignation],
        [SGAnnualIncome],
        [SGEmailId],
        [SGAadharNumber],
        [SGPanNumber],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[StudentAdmission]
    WHERE [AdmissionId] = @AdmissionId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[StudentAssignmentSubmission_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentAssignmentSubmission_Create]
(
    @AssignmentId INT,
	@StudentId INT,
	@SubmissionDate DATETIME,
	@FileUrl NVARCHAR (500),
	@Status VARCHAR(20),
	@MarksObtained INT,
	@TotalMarks DECIMAL(5,2),
	@Remarks NVARCHAR(MAX),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SubmissionId INT;

    INSERT INTO [spe].[StudentAssignmentSubmission]
    (
        [AssignmentId],
        [StudentId],
        [SubmissionDate],
        [FileUrl],
        [Status],
        [MarksObtained],
        [TotalMarks],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @AssignmentId,
        @StudentId,
        @SubmissionDate,
        @FileUrl,
        @Status,
        @MarksObtained,
        @TotalMarks,
        @Remarks,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @SubmissionId = SCOPE_IDENTITY();

    SELECT
        [SubmissionId],
        [AssignmentId],
        [StudentId],
        [SubmissionDate],
        [FileUrl],
        [Status],
        [MarksObtained],
        [TotalMarks],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[StudentAssignmentSubmission]
    WHERE [SubmissionId] = @SubmissionId;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAssignmentSubmission_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentAssignmentSubmission_Delete]
(
      @SubmissionId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[StudentAssignmentSubmission]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [SubmissionId]  = @SubmissionId
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAssignmentSubmission_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentAssignmentSubmission_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [SubmissionId]
      ,[AssignmentId]
      ,[StudentId]
      ,[SubmissionDate]
      ,[FileUrl]
      ,[Status]
      ,[MarksObtained]
      ,[TotalMarks]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[StudentAssignmentSubmission]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAssignmentSubmission_ReadByAssignmentAndStudent]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[StudentAssignmentSubmission_ReadByAssignmentAndStudent]
(
    @AssignmentId INT,
    @StudentId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        [SubmissionId],
        [AssignmentId],
        [StudentId],
        [SubmissionDate],
        [FileUrl],
        [Status],
        [MarksObtained],
        [TotalMarks],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[StudentAssignmentSubmission]
    WHERE [AssignmentId] = @AssignmentId
      AND [StudentId] = @StudentId
      AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAssignmentSubmission_ReadByAssignmentId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentAssignmentSubmission_ReadByAssignmentId]
(
      @AssignmentId INT,
	  @PageSize INT,
      @PageNo INT,
      @OrderByClause NVARCHAR(MAX) = NULL,
      @WhereClause NVARCHAR(MAX) = NULL
)
AS
 BEGIN 
	SET NOCOUNT ON;
	DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' +
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') +
        ') AS RowNum,
           A.[SubmissionId]
          ,A.[AssignmentId]
          ,A.[StudentId]
          ,B.[FirstName] + '' '' + ISNULL(B.[LastName], '''') AS [StudentName]
          ,A.[SubmissionDate]
          ,A.[FileUrl]
          ,A.[Status]
          ,A.[MarksObtained]
          ,A.[TotalMarks]
          ,A.[Remarks]
          ,A.[OtherDetail1]
          ,A.[OtherDetail2]
          ,A.[OtherDetail3]
          ,A.[OtherDetail4]
          ,A.[OtherDetail5]
          ,A.[OtherDetail6]
          ,A.[IsActive]
          ,A.[IsDeleted]
          ,A.[CreatedBy]
          ,A.[CreatedOn]
          ,A.[ModifiedBy]
          ,A.[ModifiedOn]
          ,COUNT(*) OVER () AS TotalCount,
          ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
          ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [spe].[StudentAssignmentSubmission] A
    LEFT JOIN [dbo].[UserMaster] B ON A.[StudentId] = B.[UserId]
    WHERE A.[AssignmentId] = ' + CAST(@AssignmentId AS NVARCHAR) + '
    AND A.[IsActive] = 1
    AND A.[IsDeleted] = 0';

    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;


    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    SET @SQL = @SQL + '
     OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
     FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL; -- Debug
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAssignmentSubmission_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentAssignmentSubmission_ReadById]
(
      @SubmissionId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [SubmissionId]
      ,[AssignmentId]
      ,[StudentId]
      ,[SubmissionDate]
      ,[FileUrl]
      ,[Status]
      ,[MarksObtained]
      ,[TotalMarks]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[StudentAssignmentSubmission]
	WHERE  [SubmissionId]  = @SubmissionId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAssignmentSubmission_ReadByStudentId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
Example Execution:
EXEC [spe].[StudentAssignmentSubmission_ReadByStudentId] 
     @StudentId = 1304,
     @PageSize = 10,
     @PageNo = 1,
     @OrderByClause = NULL,
     @WhereClause = NULL;
*/
CREATE PROCEDURE [spe].[StudentAssignmentSubmission_ReadByStudentId]
(
      @StudentId INT,
      @PageSize INT,
      @PageNo INT,
      @OrderByClause NVARCHAR(MAX) = NULL,
      @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Result INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' +
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') +
        ') AS RowNum,
           A.[SubmissionId]
          ,A.[AssignmentId]
		  ,C.[Title] AS [AssignmentTitle]
          ,A.[StudentId]
          ,B.[FirstName] + '' '' + ISNULL(B.[LastName], '''') AS [StudentName]
          ,A.[SubmissionDate]
          ,A.[FileUrl]
          ,A.[Status]
          ,A.[MarksObtained]
          ,A.[TotalMarks]
          ,A.[Remarks]
          ,A.[OtherDetail1]
          ,A.[OtherDetail2]
          ,A.[OtherDetail3]
          ,A.[OtherDetail4]
          ,A.[OtherDetail5]
          ,A.[OtherDetail6]
          ,A.[IsActive]
          ,A.[IsDeleted]
          ,A.[CreatedBy]
          ,A.[CreatedOn]
          ,A.[ModifiedBy]
          ,A.[ModifiedOn]
          ,COUNT(*) OVER () AS TotalCount,
          ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
          ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [spe].[StudentAssignmentSubmission] A
    LEFT JOIN [dbo].[UserMaster] B ON A.[StudentId] = B.[UserId]
	LEFT JOIN [spe].[AssignmentMaster] C ON A.[AssignmentId] = C.[AssignmentId]
    WHERE A.[StudentId] = ' + CAST(@StudentId AS NVARCHAR) + '
    AND A.[IsActive] = 1
    AND A.[IsDeleted] = 0';

    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

    SET @SQL = @SQL + '
     OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
     FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL; -- Debug
    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentAssignmentSubmission_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentAssignmentSubmission_Update]
(
    @SubmissionId INT,
	@AssignmentId INT,
	@StudentId INT,
	@SubmissionDate DATETIME,
	@FileUrl NVARCHAR (500),
	@Status VARCHAR(20),
	@MarksObtained INT,
	@TotalMarks DECIMAL(5,2),
	@Remarks NVARCHAR(MAX),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[StudentAssignmentSubmission]
    SET
        [AssignmentId] = @AssignmentId,
        [StudentId] = @StudentId,
        [SubmissionDate] = @SubmissionDate,
        [FileUrl] = @FileUrl,
        [Status] = @Status,
        [MarksObtained] = @MarksObtained,
        [TotalMarks] = @TotalMarks,
        [Remarks] = @Remarks,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [SubmissionId] = @SubmissionId;

    SELECT
        [SubmissionId],
        [AssignmentId],
        [StudentId],
        [SubmissionDate],
        [FileUrl],
        [Status],
        [MarksObtained],
        [TotalMarks],
        [Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[StudentAssignmentSubmission]
    WHERE [SubmissionId] = @SubmissionId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentClassLoader_EOD]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[StudentClassLoader_EOD]
AS
BEGIN
    SET NOCOUNT ON;

    -- 1) Load active students
    SELECT *
    FROM [dbo].[UserMaster]
    WHERE IsActive = 1 AND IsDeleted = 0;

    -- 2) Load active classes
    SELECT *
    FROM [spe].[ClassMaster]
    WHERE IsActive = 1 AND IsDeleted = 0;

    -- 3) Load active student-class mappings

    SELECT *
    FROM [spe].[StudentClassMapping]
    WHERE IsActive = 1 AND IsDeleted = 0;

    -- 4) Optional: Join data to show which student belongs to which class & section

    SELECT 
	s.UserId, 
	s.FirstName, 
	s.LastName, 
	c.ClassName, 
	m.SectionId
    FROM [dbo].[UserMaster] s
    LEFT OUTER JOIN   [spe].[StudentClassMapping] m 
	ON s.UserId = m.UserId
    LEFT OUTER JOIN [spe].[ClassMaster] c ON 
	m.ClassId = c.ClassId
    WHERE s.IsActive = 1 AND s.IsDeleted = 0
      AND c.IsActive = 1 AND c.IsDeleted = 0
      AND m.IsActive = 1 AND m.IsDeleted = 0;

END;
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_AutoAssignSection]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentClassMapping_AutoAssignSection]
(
    @SchoolId INT,
    @ClassId  INT
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SectionId INT, @Capacity INT, @CurrentCount INT;
    DECLARE @UserId INT, @MappingId INT;

    -- Cursor for sections of the given class
    DECLARE section_cursor CURSOR LOCAL FAST_FORWARD FOR
        SELECT SectionId, Capacity
        FROM [Nishwik].[spe].[SectionMaster]
        WHERE ClassId = @ClassId AND IsActive = 1 AND IsDeleted = 0
        ORDER BY SectionId;

    OPEN section_cursor;
    FETCH NEXT FROM section_cursor INTO @SectionId, @Capacity;

    -- Cursor for students without a section in this class
    DECLARE student_cursor CURSOR LOCAL FOR
        SELECT MappingId, UserId
        FROM [Nishwik].[spe].[StudentClassMapping]
        WHERE ClassId = @ClassId
          AND (SectionId IS NULL OR SectionId = 0)
          AND IsActive = 1 AND IsDeleted = 0
        ORDER BY MappingId;

    OPEN student_cursor;
    FETCH NEXT FROM student_cursor INTO @MappingId, @UserId;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- If no sections found, stop
        IF @SectionId IS NULL
            BREAK;

        -- Current count in this section
        SELECT @CurrentCount = COUNT(*)
        FROM [Nishwik].[spe].[StudentClassMapping]
        WHERE ClassId = @ClassId
          AND SectionId = @SectionId
          AND IsActive = 1 AND IsDeleted = 0;

        IF @CurrentCount < @Capacity
        BEGIN
            -- Assign this student to the section
            UPDATE [Nishwik].[spe].[StudentClassMapping]
            SET SectionId  = @SectionId,
                ModifiedOn = GETDATE()
            WHERE MappingId = @MappingId;

            -- Move to next student
            FETCH NEXT FROM student_cursor INTO @MappingId, @UserId;
        END
        ELSE
        BEGIN
            -- Move to next section if full
            FETCH NEXT FROM section_cursor INTO @SectionId, @Capacity;

            IF @@FETCH_STATUS <> 0 BREAK; -- no more sections available
        END
    END

    CLOSE student_cursor; DEALLOCATE student_cursor;
    CLOSE section_cursor;  DEALLOCATE section_cursor;
END
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
EXEC [spe].[StudentClassMapping_Create]
    @UserId = 101,
    @ClassId = 5,
    @SectionId = 2,
    @AcademicYear = '2025-26',
    @OtherDetail1 = 'NA',
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[StudentClassMapping_Create]
(
    @UserId         INT,
    @ClassId        INT,
    @SectionId      INT = NULL,
    @AcademicYear   VARCHAR(10) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	    --  Dupicate check
    IF EXISTS (
        SELECT 1
        FROM [spe].[StudentClassMapping]
        WHERE UserId = @UserId
          AND ClassId = @ClassId
          AND IsActive = 1
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('Duplicate mapping exists for this student, class, section, and academic year.', 16, 1);
        RETURN;
    END


    DECLARE @MappingId INT;

    INSERT INTO [spe].[StudentClassMapping]
    (
        [UserId],
        [ClassId],
        [SectionId],
        [AcademicYear],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @ClassId,
        @SectionId,
        @AcademicYear,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT
         [MappingId]
        ,[UserId]
        ,[ClassId]
        ,[SectionId]
        ,[AcademicYear]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[StudentClassMapping]
    WHERE [MappingId] = @MappingId;
END
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentClassMapping_Delete]
(
   @MappingId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE [spe].[StudentClassMapping]
	SET
		[IsActive] = 0 ,
		[IsDeleted] = 1 ,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE  [MappingId] = @MappingId
END;
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentClassMapping_ReadAll]
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [MappingId]
		,[UserId]
		,[ClassId]
		,[SectionId]
		,[AcademicYear]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[StudentClassMapping]
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[StudentClassMapping_ReadByClassId] 
     @ClassId = 20, 
     @SectionId = NULL,      -- or provide a SectionId like 5
     @PageSize = 10, 
     @PageNo = 1, 
     @OrderByClause = NULL,   -- or any column
     @WhereClause = NULL;      -- optional filter

*/

CREATE   PROCEDURE [spe].[StudentClassMapping_ReadByClassId]
(
    @ClassId INT,
	@SectionId INT = NULL,
	@PageSize INT,
	@PageNo INT,
	@OrderByClause NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;
	SET NOCOUNT ON;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL ='
	SELECT
	ROW_NUMBER() OVER (ORDER BY ' + 
	ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
	') AS RowNum,
		 A.[MappingId]
        ,A.[UserId]
        ,A.[ClassId]
        ,D.[ClassName]
        ,A.[SectionId]
        ,E.[SectionName]
        ,A.[AcademicYear]
        ,B.[SchoolId]
		,B.[MappingId] AS UserMappingId
        ,B.[AffiliationType]
        ,B.[Designation]
        ,B.[Occupation]
        ,B.[Income]
        ,B.[IsPrimary]
        ,B.[JoinedOn]
		,C.[FirstName]
		,C.[MiddleName]
		,C.[LastName]
		,C.[DOB]
		,C.[MobileNo]
		,C.[EmailId]
		,ISNULL(C.[ProfileImage],'''') ProfileImage
        ,C.[Address]
        ,C.[Country]
        ,C.[State]
        ,C.[City]
        ,C.[BloodGroup]
        ,C.[Gender]
        ,C.[AadharNumber]
        ,C.[PanNumber]
        ,C.[Nationality]
        ,C.[Religion]
        ,C.[Caste]
        ,B.[OtherDetail1]
        ,B.[OtherDetail2]
        ,B.[OtherDetail3]
        ,B.[OtherDetail4]
        ,B.[OtherDetail5]
        ,B.[OtherDetail6]
        ,A.[IsActive]
        ,A.[IsDeleted]
        ,A.[CreatedBy]
        ,A.[CreatedOn]
        ,A.[ModifiedBy]
        ,A.[ModifiedOn]
        ,F.[LoginId]
        ,F.[UserName]
		,G.[UserRoleId]
        ,G.[RoleId]
		,H.[AdmissionNo]
		,H.[RegistrationId]
		,COUNT(*) OVER() AS TotalCount
		,' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize
		,' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [spe].[StudentClassMapping] A
    LEFT JOIN [spe].[UserAffiliationMapping] B 
        ON A.[UserId] = B.[UserId] 
		AND B.IsActive = 1
        AND B.IsDeleted = 0
    LEFT JOIN [dbo].[UserMaster] C
        ON A.[UserId] = C.[UserId]
		AND C.IsActive = 1
		AND C.IsDeleted = 0
    LEFT JOIN [spe].[ClassMaster] D
        ON A.[ClassId] = D.[ClassId]
    LEFT JOIN [spe].[SectionMaster] E
        ON A.[SectionId] = E.[SectionId]
    LEFT JOIN [dbo].[UserLogin] F
        ON A.[UserId] = F.[UserId]
    LEFT JOIN [dbo].[UserRoles] G
        ON A.[UserId] = G.[UserId]
		AND G.RoleId = B.AssignedRoleId
		AND G.IsActive = 1
		AND G.IsDeleted = 0
	LEFT JOIN [spe].[StudentRegistration] H
        ON A.[UserId] = H.[UserId] 
		AND H.SchoolId = D.SchoolId
		AND H.IsActive = 1
		AND H.IsDeleted = 0
	WHERE A.[ClassId] = ' + CAST(@ClassId AS NVARCHAR) + '
	' + CASE WHEN @SectionId IS NOT NULL THEN ' AND A.[SectionId] = ' + CAST(@SectionId AS NVARCHAR) ELSE '' END + '
	AND A.[IsActive] = 1
	AND A.[IsDeleted] = 0
	AND B.AffiliationType = ''Student'' 
	AND B.SchoolId = D.SchoolId';


	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
		SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
		SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentClassMapping_ReadById]
(
   @MappingId INT
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [MappingId]
		,[UserId]
		,[ClassId]
		,[SectionId]
		,[AcademicYear]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[StudentClassMapping]
	WHERE  [MappingId] = @MappingId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_ReadBySectionId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentClassMapping_ReadBySectionId]
(
   @SectionId INT
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [MappingId]
		,[UserId]
		,[ClassId]
		,[SectionId]
		,[AcademicYear]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[StudentClassMapping]
	WHERE  [SectionId] = @SectionId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[StudentClassMapping_ReadByUserId]
(
   @UserId INT
)
AS
 BEGIN
	SET NOCOUNT ON;
	SELECT 
		 A.[MappingId]
		,A.[UserId]
		,A.[ClassId]
		,B.[ClassName]
		,A.[SectionId]
		,C.[SectionName]
		,A.[AcademicYear]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [spe].[StudentClassMapping]A
	LEFT OUTER JOIN [spe].[ClassMaster]B
	ON A.[ClassId] = B.[ClassId]
	LEFT OUTER JOIN [spe].[SectionMaster]C
	ON A.[SectionId] = C.[SectionId]
	WHERE  [UserId] = @UserId
	AND A.[IsActive] = 1
	AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentClassMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[StudentClassMapping_Update]
    @MappingId = 1,
    @UserId = 101,
    @ClassId = 7,
    @SectionId = 4,
    @AcademicYear = '2025-26',
    @OtherDetail1 = 'Updated entry',
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @IsActive = 1,
    @ActionUser = 'admin';
*/
CREATE   PROCEDURE [spe].[StudentClassMapping_Update]
(
    @MappingId      INT,
    @UserId         INT,
    @ClassId        INT,
    @SectionId      INT = NULL,
    @AcademicYear   VARCHAR(10) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @IsActive       INT ,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

     -- Check if MappingId exists
    IF NOT EXISTS (
        SELECT 1 
        FROM [spe].[StudentClassMapping]
        WHERE [MappingId] = @MappingId AND [IsDeleted] = 0
    )
    BEGIN
        RAISERROR('Invalid MappingId or record has been deleted.', 16, 1);
        RETURN;
    END

    -- Prevent duplicate mapping for same student and class (excluding current MappingId)
    IF EXISTS (
        SELECT 1
        FROM [spe].[StudentClassMapping]
        WHERE [UserId] = @UserId
          AND [ClassId] = @ClassId
          AND [IsActive] = 1
          AND [IsDeleted] = 0
          AND [MappingId] <> @MappingId
    )
    BEGIN
        RAISERROR('Mapping for this student and class already exists.', 16, 1);
        RETURN;
    END

    UPDATE [spe].[StudentClassMapping]
    SET
         [UserId]         = @UserId
        ,[ClassId]        = @ClassId
        ,[SectionId]      = @SectionId
        ,[AcademicYear]   = @AcademicYear
        ,[OtherDetail1]   = @OtherDetail1
        ,[OtherDetail2]   = @OtherDetail2
        ,[OtherDetail3]   = @OtherDetail3
        ,[OtherDetail4]   = @OtherDetail4
        ,[OtherDetail5]   = @OtherDetail5
        ,[OtherDetail6]   = @OtherDetail6
        ,[IsActive]       = @IsActive
        ,[ModifiedBy]     = @ActionUser
        ,[ModifiedOn]     = GETDATE()
    WHERE [MappingId] = @MappingId;
    SELECT
		 [MappingId]
		,[UserId]
		,[ClassId]
		,[SectionId]
		,[AcademicYear]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[StudentClassMapping]
	WHERE [MappingId] = @MappingId 
	AND [IsActive] = 1
	AND [IsDeleted] = 0 ;
END
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_BulkCreate]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[StudentExamMarks_BulkCreate]
(
    @ScheduleId INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ClassId INT, @SectionId INT, @ExamId INT, @SubjectId INT;
    DECLARE @TotalMarks DECIMAL(5,2), @GraceMarks INT;

    -- 1. Get schedule details
    SELECT 
        @ClassId = C.ClassId,
        @SectionId = C.SectionId,
        @ExamId = C.ExamId,
        @SubjectId = C.SubjectId,
        @TotalMarks = C.TotalMarks
    FROM [spe].[ExamSchedule] C
    WHERE C.ScheduleId = @ScheduleId;

    IF @ClassId IS NULL
    BEGIN
        RAISERROR('Invalid ScheduleId. No schedule found.',16,1);
        RETURN;
    END

    -- 2. Get grace marks from ExamMaster
    SELECT @GraceMarks = B.GraceMarks
    FROM [spe].[ExamMaster] B
    WHERE B.ExamId = @ExamId;

    IF @GraceMarks IS NULL
        SET @GraceMarks = 0; -- fallback

    -- 3. Reactivate deleted entries if any
    UPDATE SEM
    SET 
        IsActive = 1,
        IsDeleted = 0,
        CreatedBy = @ActionUser,
        CreatedOn = GETDATE()
    FROM [spe].[StudentExamMarks] SEM
    INNER JOIN [spe].[StudentClassMapping] A
        ON SEM.StudentId = A.UserId
    WHERE SEM.ScheduleId = @ScheduleId
      AND A.ClassId = @ClassId
      AND (@SectionId IS NULL OR A.SectionId = @SectionId)
      AND SEM.IsDeleted = 1;

    -- 4. Insert new rows for students without an entry
    INSERT INTO [spe].[StudentExamMarks]
    (
        ScheduleId,
        StudentId,
        ObtainedMarks,
        TotalMarks,
        Percentage,
        Grade,
        Result,
        Remarks,
        GraceMarks,
        GraceMarksGiven,
        IsAbsent,
		IsConfirm,
        OtherDetail1,
        OtherDetail2,
        OtherDetail3,
        OtherDetail4,
        OtherDetail5,
        OtherDetail6,
        IsActive,
        IsDeleted,
        CreatedBy,
        CreatedOn
    )
    SELECT
        @ScheduleId,
        A.UserId AS StudentId,
        0,              -- ObtainedMarks
        @TotalMarks,    -- TotalMarks from schedule
        0,              -- Percentage
        NULL,           -- Grade
        NULL,           -- Result
        NULL,           -- Remarks
        @GraceMarks,   -- GraceMarks from ExamMaster
        0,              -- GraceMarksGiven
        0,              -- IsAbsent
		0,
        NULL, NULL, NULL, NULL, NULL, NULL,
        1,              -- IsActive
        0,              -- IsDeleted
        @ActionUser,
        GETDATE()
    FROM [spe].[StudentClassMapping] A
    INNER JOIN [dbo].[UserMaster] B
        ON A.UserId = B.UserId
        AND B.IsDeleted = 0
        AND B.IsActive = 1
    INNER JOIN [spe].[UserAffiliationMapping] C
        ON A.UserId = C.UserId
        AND C.AffiliationType = 'Student'
        AND C.IsDeleted = 0
        AND C.IsActive = 1
    WHERE A.ClassId = @ClassId
      AND (@SectionId IS NULL OR A.SectionId = @SectionId)
      AND A.IsActive = 1
      AND A.IsDeleted = 0
      AND NOT EXISTS (
          SELECT 1
          FROM [spe].[StudentExamMarks] D
          WHERE D.ScheduleId = @ScheduleId
            AND D.StudentId = A.UserId
      );

    PRINT 'Bulk entry created or reactivated successfully.';
END
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[StudentExamMarks_Create]
(
    @ScheduleId INT,
	@StudentId INT,
	@ObtainedMarks DECIMAL(5,2),
	@TotalMarks DECIMAL(5,2),
	@Percentage DECIMAL(5,2),
	@Grade VARCHAR(10),
	@Result VARCHAR(20),
	@Remarks VARCHAR(250),
	@GraceMarks INT,
	@GraceMarksGiven INT,
	@IsAbsent INT,
	@IsConfirm INT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MarkId INT;

    -- STEP 1: CHECK IF STUDENT ALREADY HAS ENTRY FOR SCHEDULE
    
    IF EXISTS (
        SELECT 1
        FROM [spe].[StudentExamMarks]
        WHERE ScheduleId = @ScheduleId
          AND StudentId = @StudentId
          AND IsActive = 1
          AND IsDeleted = 0
    )
    BEGIN
        SELECT 'Mark Entry Already Exists' AS Message;
        RETURN;
    END

    -- STEP 2: IF RECORD EXISTS BUT IS SOFT-DELETED, REACTIVATE & UPDATE
    ELSE IF EXISTS (
        SELECT 1
        FROM [spe].[StudentExamMarks]
        WHERE ScheduleId = @ScheduleId
          AND StudentId = @StudentId
          AND IsActive = 0
          AND IsDeleted = 1
    )
    BEGIN
        UPDATE [spe].[StudentExamMarks]
        SET [ObtainedMarks]   = @ObtainedMarks,
            [TotalMarks]      = @TotalMarks,
            [Percentage]      = @Percentage,
            [Grade]           = @Grade,
            [Result]          = @Result,
            [Remarks]         = @Remarks,
            [GraceMarks]      = @GraceMarks,
            [GraceMarksGiven] = @GraceMarksGiven,
            [IsAbsent]        = @IsAbsent,
            [IsConfirm]       = @IsConfirm,
            [OtherDetail1]    = @OtherDetail1,
            [OtherDetail2]    = @OtherDetail2,
            [OtherDetail3]    = @OtherDetail3,
            [OtherDetail4]    = @OtherDetail4,
            [OtherDetail5]    = @OtherDetail5,
            [OtherDetail6]    = @OtherDetail6,
            [IsActive]        = 1,
            [IsDeleted]       = 0,
            [ModifiedBy]      = @ActionUser,
            [ModifiedOn]      = GETDATE()
        WHERE ScheduleId = @ScheduleId AND StudentId = @StudentId;

        SELECT 'Existing Record Reactivated & Updated Successfully' AS Message;
        RETURN;
    END

  --STEP 3: IF NO EXISTING RECORD, INSERT NEW ENTRY
    ELSE
    BEGIN
        INSERT INTO [spe].[StudentExamMarks]
        (
            [ScheduleId],
            [StudentId],
            [ObtainedMarks],
            [TotalMarks],
            [Percentage],
            [Grade],
            [Result],
            [Remarks],
            [GraceMarks],
            [GraceMarksGiven],
            [IsAbsent],
		    [IsConfirm],
            [OtherDetail1],
            [OtherDetail2],
            [OtherDetail3],
            [OtherDetail4],
            [OtherDetail5],
            [OtherDetail6],
            [IsActive],
            [IsDeleted],
            [CreatedBy],
            [CreatedOn]
        )
        VALUES
        (
            @ScheduleId,
            @StudentId,
            @ObtainedMarks,
            @TotalMarks,
            @Percentage,
            @Grade,
            @Result,
            @Remarks,
            @GraceMarks,
            @GraceMarksGiven,
            @IsAbsent,
		    @IsConfirm,
            @OtherDetail1,
            @OtherDetail2,
            @OtherDetail3,
            @OtherDetail4,
            @OtherDetail5,
            @OtherDetail6,
            1,
            0,
            @ActionUser,
            GETDATE()
        );

        SET @MarkId = SCOPE_IDENTITY();

        SELECT
            [MarkId],
            [ScheduleId],
            [StudentId],
            [ObtainedMarks],
            [TotalMarks],
            [Percentage],
            [Grade],
            [Result],
            [Remarks],
            [GraceMarks],
            [GraceMarksGiven],
            [IsAbsent],
		    [IsConfirm],
            [OtherDetail1],
            [OtherDetail2],
            [OtherDetail3],
            [OtherDetail4],
            [OtherDetail5],
            [OtherDetail6],
            [IsActive],
            [IsDeleted],
            [CreatedBy],
            [CreatedOn],
            [ModifiedBy],
            [ModifiedOn],
            'New Record Inserted Successfully' AS Message
        FROM [spe].[StudentExamMarks]
        WHERE [MarkId] = @MarkId;
    END
END;
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentExamMarks_Delete]
(
      @MarkId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[StudentExamMarks]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [MarkId]  = @MarkId
END;
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentExamMarks_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [MarkId]
      ,[ScheduleId]
      ,[StudentId]
      ,[ObtainedMarks]
      ,[TotalMarks]
      ,[Percentage]
      ,[Grade]
      ,[Result]
      ,[Remarks]
      ,[GraceMarks]
      ,[GraceMarksGiven]
      ,[IsAbsent]
	  ,[IsConfirm]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[StudentExamMarks]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[StudentExamMarks_ReadAllPaginated]
(
    @ExamId INT,
    @ClassId INT,
    @SectionId INT = NULL,
    @SubjectId INT = NULL,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Offset INT = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);

    -- Default ORDER BY
    IF (@OrderByClause IS NULL OR LTRIM(RTRIM(@OrderByClause)) = '')
        SET @OrderByClause = 'A.CreatedOn DESC';

    SET @SQL = '
    SELECT A.MarkId,
           A.ScheduleId,
           A.StudentId,
           A.ObtainedMarks,
           A.TotalMarks,
           A.Percentage,
           A.Grade,
           A.Result,
           A.Remarks,
           A.GraceMarks,
           A.GraceMarksGiven,
           A.IsAbsent,
		   A.IsConfirm,
           A.CreatedOn,
           B.ExamId,
           B.ClassId,
           B.SectionId,
           B.SubjectId,
           C.ExamName,
           C.ExamType
    FROM [Nishwik].[spe].[StudentExamMarks] A
    INNER JOIN [Nishwik].[spe].[ExamSchedule] B
        ON A.ScheduleId = B.ScheduleId
    INNER JOIN [Nishwik].[spe].[ExamMaster] C
        ON B.ExamId = C.ExamId
    WHERE B.ExamId = ' + CAST(@ExamId AS NVARCHAR) + '
      AND B.ClassId = ' + CAST(@ClassId AS NVARCHAR);

    -- Optional filters
    IF @SectionId IS NOT NULL
        SET @SQL += ' AND B.SectionId = ' + CAST(@SectionId AS NVARCHAR);

    IF @SubjectId IS NOT NULL
        SET @SQL += ' AND B.SubjectId = ' + CAST(@SubjectId AS NVARCHAR);

    -- Extra Where clause (if provided)
    IF (@WhereClause IS NOT NULL AND LTRIM(RTRIM(@WhereClause)) <> '')
        SET @SQL += ' AND ' + @WhereClause;

    -- Add ORDER BY + Pagination
    SET @SQL += '
    ORDER BY ' + @OrderByClause + '
    OFFSET ' + CAST(@Offset AS NVARCHAR) + ' ROWS
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    -- Debugging (optional)
    -- PRINT @SQL;

    EXEC sp_executesql @SQL;
END
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentExamMarks_ReadById]
(
      @MarkId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [MarkId]
      ,[ScheduleId]
      ,[StudentId]
      ,[ObtainedMarks]
      ,[TotalMarks]
      ,[Percentage]
      ,[Grade]
      ,[Result]
      ,[Remarks]
      ,[GraceMarks]
      ,[GraceMarksGiven]
      ,[IsAbsent]
	  ,[IsConfirm]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[StudentExamMarks]
	WHERE  [MarkId]  = @MarkId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_ReadByScheduleId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[StudentExamMarks_ReadByScheduleId]
(
    @ScheduleId INT 
)
AS
BEGIN 
    SET NOCOUNT ON;

    SELECT 
        A.[MarkId],
        A.[ScheduleId],
        A.[StudentId],
        ISNULL(B.[FirstName], '') + ' ' + ISNULL(B.[LastName], '') AS StudentName,
		D.SectionName,
        A.[ObtainedMarks],
        A.[TotalMarks],
        A.[Percentage],
        A.[Grade],
        A.[Result],
        A.[Remarks],
        A.[GraceMarks],
        A.[GraceMarksGiven],
        A.[IsAbsent],
		A.[IsConfirm],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn]
    FROM [spe].[StudentExamMarks] A
    LEFT JOIN [dbo].[UserMaster] B 
        ON A.[StudentId] = B.[UserId]
	LEFT JOIN [spe].[StudentClassMapping] C 
        ON A.[StudentId] = C.[UserId] 
        AND C.[IsActive] = 1 AND C.[IsDeleted] = 0
    LEFT JOIN [spe].[SectionMaster] D          
        ON D.[SectionId] = C.[SectionId]
    WHERE A.[ScheduleId] = @ScheduleId
      AND A.[IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_ReadByStudent]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentExamMarks_ReadByStudent]
(
    @ExamId INT,
    @StudentId INT,
    @ClassId INT = NULL,
    @SectionId INT = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        A.[MarkId],
        B.[ClassId],
        A.[ScheduleId],
        A.[StudentId],
        F.[SubjectName],
        A.[ObtainedMarks],
        A.[TotalMarks],
        A.[Percentage],
        A.[Grade],
        A.[Result],
        A.[Remarks],
        A.[GraceMarks],
        A.[GraceMarksGiven],
        A.[IsAbsent],
		A.[IsConfirm],
        B.[ExamDate],
        C.[ExamName],
        C.[ExamType],
        D.[SectionId],
        D.[SectionName],
        G.[FirstName] + ' ' + ISNULL(G.[LastName], '') AS StudentName,
        A.[IsConfirm],
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn]
    FROM [spe].[StudentExamMarks] A
    INNER JOIN [spe].[ExamSchedule] B ON A.ScheduleId = B.ScheduleId
    INNER JOIN [spe].[ExamMaster] C ON B.ExamId = C.ExamId
    INNER JOIN dbo.UserMaster G ON A.StudentId = G.UserId
    INNER JOIN [spe].[SectionMaster] D ON D.[SectionId] = B.[SectionId]
    INNER JOIN [spe].[SubjectMaster] F ON B.SubjectId = F.SubjectId
    WHERE C.[ExamId] = @ExamId
      AND A.[StudentId] = @StudentId
      AND A.[IsActive] = 1 AND A.[IsDeleted] = 0
      AND B.[IsActive] = 1 AND B.[IsDeleted] = 0
      AND C.[IsActive] = 1 AND C.[IsDeleted] = 0
      AND D.[IsActive] = 1 AND D.[IsDeleted] = 0
      AND F.[IsActive] = 1 AND F.[IsDeleted] = 0
      AND G.[IsActive] = 1 AND G.[IsDeleted] = 0
      AND (@ClassId IS NULL OR B.ClassId = @ClassId)
      AND (@SectionId IS NULL OR B.SectionId = @SectionId);
END;
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_ReadByStudentId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentExamMarks_ReadByStudentId]
(
      @StudentId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [MarkId]
      ,[ScheduleId]
      ,[StudentId]
      ,[ObtainedMarks]
      ,[TotalMarks]
      ,[Percentage]
      ,[Grade]
      ,[Result]
      ,[Remarks]
      ,[GraceMarks]
      ,[GraceMarksGiven]
      ,[IsAbsent]
	  ,[IsConfirm]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[StudentExamMarks]
	WHERE  [StudentId]  = @StudentId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_ReadBySubject]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[StudentExamMarks_ReadBySubject]
(
    @ExamId INT,
    @SubjectId INT,
    @ClassId INT = NULL,
    @SectionId INT = NULL,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause VARCHAR(250) = NULL, 
    @WhereClause VARCHAR(250) = NULL   
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Offset INT = (@PageNo - 1) * @PageSize;
    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + ') AS RowNum,
        A.[MarkId],
        B.[ClassId],
        A.[ScheduleId],
        A.[StudentId],
        F.[SubjectName],
        A.[ObtainedMarks],
        A.[TotalMarks],
        A.[Percentage],
        A.[Grade],
        A.[Result],
        A.[Remarks],
        A.[GraceMarks],
        A.[GraceMarksGiven],
        A.[IsAbsent],
		A.[IsConfirm],
        B.[ExamDate],
        C.[ExamName],
        C.[ExamType],
        D.[SectionId],
        D.[SectionName],                 
        G.[FirstName] + '' '' + ISNULL(G.[LastName],'''') AS StudentName,  
		A.IsConfirm,
        A.[OtherDetail1],
        A.[OtherDetail2],
        A.[OtherDetail3],
        A.[OtherDetail4],
        A.[OtherDetail5],
        A.[OtherDetail6],
        A.[IsActive],
        A.[IsDeleted],
        A.[CreatedBy],
        A.[CreatedOn],
        A.[ModifiedBy],
        A.[ModifiedOn],
        COUNT(*) OVER () AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [spe].[StudentExamMarks] A
    LEFT JOIN [spe].[ExamSchedule] B
        ON A.ScheduleId = B.ScheduleId
    LEFT JOIN [spe].[ExamMaster] C 
        ON B.ExamId = C.ExamId
    LEFT JOIN dbo.UserMaster G 
        ON A.StudentId = G.UserId
    LEFT JOIN [spe].[SectionMaster] D 
        ON D.[SectionId] = B.[SectionId]
    LEFT JOIN [spe].[SubjectMaster] F
        ON B.[SubjectId] = F.[SubjectId]
    WHERE C.[ExamId] = ' + CAST(@ExamId AS NVARCHAR) + '
      AND B.[SubjectId] = ' + CAST(@SubjectId AS NVARCHAR) + '
      AND A.[IsActive] = 1
      AND A.[IsDeleted] = 0';

    -- Optional filters
    IF @ClassId IS NOT NULL
        SET @SQL = @SQL + ' AND B.[ClassId] = ' + CAST(@ClassId AS NVARCHAR);

    IF @SectionId IS NOT NULL
        SET @SQL = @SQL + ' AND B.[SectionId] = ' + CAST(@SectionId AS NVARCHAR);

    IF @WhereClause IS NOT NULL AND LTRIM(RTRIM(@WhereClause)) <> ''
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    -- Pagination
    SET @SQL = @SQL + '
    ORDER BY ' + ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + '
    OFFSET ' + CAST(@Offset AS NVARCHAR) + ' ROWS
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    -- Execute dynamic SQL
    EXEC sp_executesql @SQL;
END
GO
/****** Object:  StoredProcedure [spe].[StudentExamMarks_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentExamMarks_Update]
(
    @MarkId INT,
	@ScheduleId INT,
	@StudentId INT,
	@ObtainedMarks DECIMAL(5,2),
	@TotalMarks DECIMAL(5,2),
	@Percentage DECIMAL(5,2),
	@Grade VARCHAR(10),
	@Result VARCHAR(20),
	@Remarks VARCHAR(250),
	@GraceMarks INT,
	@GraceMarksGiven INT,
	@IsAbsent INT,
	@IsConfirm INT,
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[StudentExamMarks]
    SET
        [ScheduleId] = @ScheduleId,
        [StudentId] = @StudentId,
        [ObtainedMarks] = @ObtainedMarks,
        [TotalMarks] = @TotalMarks,
        [Percentage] = @Percentage,
        [Grade] = @Grade,
        [Result] = @Result,
        [Remarks] = @Remarks,
        [GraceMarks] = @GraceMarks,
        [GraceMarksGiven] = @GraceMarksGiven,
        [IsAbsent] = @IsAbsent,
		[IsConfirm] = @IsConfirm,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [MarkId] = @MarkId;

    SELECT
        [MarkId],
        [ScheduleId],
        [StudentId],
        [ObtainedMarks],
        [TotalMarks],
        [Percentage],
        [Grade],
        [Result],
        [Remarks],
        [GraceMarks],
        [GraceMarksGiven],
        [IsAbsent],
		[IsConfirm],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[StudentExamMarks]
    WHERE [MarkId] = @MarkId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentFeeStructureMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentFeeStructureMapping_Create]
(
	@StudentId INT,
	@ClassId INT,
	@FeeStructureId INT,
	@FeeType NVARCHAR(100),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
	  --  Prevent duplicate StudentId + ClassId + FeeStructureId
    IF EXISTS (
        SELECT 1
        FROM [spe].[StudentFeeStructureMapping]
        WHERE StudentId = @StudentId
          AND ClassId = @ClassId
          AND FeeStructureId = @FeeStructureId
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('This student is already mapped to the same Class and Fee Structure.', 16, 1);
        RETURN;
    END


    DECLARE @MappingId INT;

    INSERT INTO [spe].[StudentFeeStructureMapping]
    (
        [StudentId],
        [ClassId],
        [FeeStructureId],
        [FeeType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @StudentId,
        @ClassId,
        @FeeStructureId,
        @FeeType,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT
        [StudentId],
        [ClassId],
        [FeeStructureId],
        [FeeType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[StudentFeeStructureMapping]
    WHERE [MappingId] = @MappingId;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentFeeStructureMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentFeeStructureMapping_Delete]
(
      @MappingId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[StudentFeeStructureMapping]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [MappingId]  = @MappingId
END;
GO
/****** Object:  StoredProcedure [spe].[StudentFeeStructureMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentFeeStructureMapping_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
     [MappingId]
    ,[StudentId]
    ,[ClassId]
    ,[FeeStructureId]
    ,[FeeType]
	,[OtherDetail1]
	,[OtherDetail2]
	,[OtherDetail3]
	,[OtherDetail4]
	,[OtherDetail5]
	,[OtherDetail6]
	,[IsActive]
	,[IsDeleted]
	,[CreatedBy]
	,[CreatedOn]
	,[ModifiedBy]
	,[ModifiedOn]
	FROM [spe].[StudentFeeStructureMapping]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentFeeStructureMapping_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentFeeStructureMapping_ReadByClassId]
(
      @ClassId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
     [MappingId]
    ,[StudentId]
    ,[ClassId]
    ,[FeeStructureId]
    ,[FeeType]
	,[OtherDetail1]
	,[OtherDetail2]
	,[OtherDetail3]
	,[OtherDetail4]
	,[OtherDetail5]
	,[OtherDetail6]
	,[IsActive]
	,[IsDeleted]
	,[CreatedBy]
	,[CreatedOn]
	,[ModifiedBy]
	,[ModifiedOn]
	FROM [spe].[StudentFeeStructureMapping]
	WHERE  [ClassId]  = @ClassId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentFeeStructureMapping_ReadByFeeStructureId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentFeeStructureMapping_ReadByFeeStructureId]
(
      @FeeStructureId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
     [MappingId]
    ,[StudentId]
    ,[ClassId]
    ,[FeeStructureId]
    ,[FeeType]
	,[OtherDetail1]
	,[OtherDetail2]
	,[OtherDetail3]
	,[OtherDetail4]
	,[OtherDetail5]
	,[OtherDetail6]
	,[IsActive]
	,[IsDeleted]
	,[CreatedBy]
	,[CreatedOn]
	,[ModifiedBy]
	,[ModifiedOn]
	FROM [spe].[StudentFeeStructureMapping]
	WHERE  [FeeStructureId]  = @FeeStructureId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentFeeStructureMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentFeeStructureMapping_ReadById]
(
      @MappingId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
     [MappingId]
    ,[StudentId]
    ,[ClassId]
    ,[FeeStructureId]
    ,[FeeType]
	,[OtherDetail1]
	,[OtherDetail2]
	,[OtherDetail3]
	,[OtherDetail4]
	,[OtherDetail5]
	,[OtherDetail6]
	,[IsActive]
	,[IsDeleted]
	,[CreatedBy]
	,[CreatedOn]
	,[ModifiedBy]
	,[ModifiedOn]
	FROM [spe].[StudentFeeStructureMapping]
	WHERE  [MappingId]  = @MappingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentFeeStructureMapping_ReadByStudentId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[StudentFeeStructureMapping_ReadByStudentId]
(
      @StudentId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
     A.[MappingId]
    ,A.[StudentId]
    ,A.[ClassId]
	,B.[ClassName]
    ,A.[FeeStructureId]
	,C.[FName]
    ,A.[FeeType]
	,A.[OtherDetail1]
	,A.[OtherDetail2]
	,A.[OtherDetail3]
	,A.[OtherDetail4]
	,A.[OtherDetail5]
	,A.[OtherDetail6]
	,A.[IsActive]
	,A.[IsDeleted]
	,A.[CreatedBy]
	,A.[CreatedOn]
	,A.[ModifiedBy]
	,A.[ModifiedOn]
	FROM [spe].[StudentFeeStructureMapping]A
	LEFT OUTER JOIN spe.ClassMaster B
	ON A.[ClassId] = B.[ClassId]
	LEFT OUTER JOIN spe.FeeStructureMaster C
	ON A.[FeeStructureId] = C.[FeeStructureId]
	WHERE A. [StudentId]  = @StudentId
	AND A. [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentFeeStructureMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentFeeStructureMapping_Update]
(
    @MappingId INT,
	@StudentId INT,
	@ClassId INT,
	@FeeStructureId INT,
	@FeeType NVARCHAR(100),
    @OtherDetail1   VARCHAR(50),
    @OtherDetail2   VARCHAR(50),
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[StudentFeeStructureMapping]
    SET
        [StudentId] = @StudentId,
        [ClassId] = @ClassId,
        [FeeStructureId] = @FeeStructureId,
        [FeeType]= @FeeType,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [MappingId] = @MappingId;

    SELECT
        [MappingId],
        [StudentId],
        [ClassId],
        [FeeStructureId],
        [FeeType],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[StudentFeeStructureMapping]
    WHERE [MappingId] = @MappingId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentIDCard_Generate]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[StudentIDCard_Generate]
(
    @UserId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE 
        @StudentName NVARCHAR(200),
        @StudentID NVARCHAR(50),
        @Class NVARCHAR(100),
        @Gender NVARCHAR(20),
        @DOB NVARCHAR(50),
        @PhotoUrl NVARCHAR(MAX),
        @HTML NVARCHAR(MAX);

    -- Fetch Student + Class Data
    SELECT 
        @StudentName = CONCAT(ISNULL(UM.FirstName,''),' ',ISNULL(UM.LastName,'')),
        @StudentID = CAST(UM.UserId AS NVARCHAR(20)),
        @Gender = UM.Gender,
        @DOB = FORMAT(UM.DOB,'dd MMM yyyy'),
        @PhotoUrl = ISNULL(UM.ProfileImage,'https://randomuser.me/api/portraits/men/32.jpg'),
        @Class = CONCAT('Class ', ISNULL(CM.ClassName,''), ' - ', ISNULL(SM.SectionName,''))
    FROM dbo.UserMaster UM
    LEFT JOIN spe.StudentClassMapping SCM ON UM.UserId = SCM.UserId AND SCM.IsActive = 1 AND SCM.IsDeleted = 0
    LEFT JOIN spe.ClassMaster CM ON SCM.ClassId = CM.ClassId
    LEFT JOIN spe.SectionMaster SM ON SCM.SectionId = SM.SectionId
    WHERE UM.UserId = @UserId;

    -- Build HTML Output
    SET @HTML = N'
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Student ID Card</title>
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body style="margin-top:30px; font-family:Urbanist, Arial, sans-serif;">

<table align="center" cellspacing="0" cellpadding="0" 
style="width:450px; background:#fff; border:1px solid #ccc; border-radius:12px; box-shadow:0 0 6px rgba(0,0,0,0.15); overflow:hidden;">

<tr>
<td colspan="2" style="background:#263D73; color:#fff; padding:8px 14px; border-bottom:4px solid #D5A050;">
<span style="font-size:16px; font-weight:bold;">SUNRISE PUBLIC SCHOOL</span><br>
<span style="font-size:11px;">Plot No. 45, Sector 8, Palm Beach Road, Navi Mumbai - 410210</span>
</td>
</tr>

<tr>
<td style="width:35%; text-align:center; padding:10px;">
<div style="width:100px; height:100px; border:2px solid #011044; border-radius:8px; overflow:hidden; margin:auto;">
<img src="' + @PhotoUrl + '" style="width:100%; height:100%; object-fit:cover;">
</div>
<div style="font-size:11px; margin-top:30px; color:#011044; font-weight:bold;">Authorized Signatory</div>
</td>

<td style="width:65%; padding:10px 14px; font-weight:bold;">
<table width="100%" cellpadding="3" style="font-size:13px; color:#011044;">
<tr><td style="width:40%">Student Name</td><td>: ' + @StudentName + '</td></tr>
<tr><td>Student ID</td><td>: ' + @StudentID + '</td></tr>
<tr><td>Class</td><td>: ' + @Class + '</td></tr>
<tr><td>Gender</td><td>: ' + @Gender + '</td></tr>
<tr><td>DOB</td><td>: ' + @DOB + '</td></tr>
</table>

<div style="text-align:right; margin-top:6px;">
<img src="https://barcode.tec-it.com/barcode.ashx?data=' + @StudentID + '&code=Code128&dpi=96" style="width:100px; height:24px;">
</div>
</td>
</tr>

<tr>
<td colspan="2" style="background:#263D73; color:#fff; text-align:center; font-size:14px; padding:5px 0; border-top:4px solid #D5A050;">
<b>www.sunriseschool.edu.in | contact@sunriseschool.edu.in<br>+91 98765 43210</b>
</td>
</tr>

</table>
</body>
</html>';

    SELECT @HTML AS IDCardHTML;
END
GO
/****** Object:  StoredProcedure [spe].[StudentRegistration_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
EXEC [spe].[StudentRegistration_Create]
    @SchoolId = 1,
    @UserId = 1001,
    @AdmissionNo = 'AD12345',
    @AdmissionType = 'Regular',
    @AdmissionStatus = 'Pending',
    @MotherTongue = 'Hindi',
    @IncomeProof = 'IncomeProof.pdf',
    @PreviousSchoolName = 'ABC School',
    @PLastClass = '5th',
    @PMarksObtained = '89%',
    @TransferCertificateNo = 'TC56789',
    @TCDate = '2024-06-01',
    @OtherDetail1 = 'N/A',
    @OtherDetail2 = 'N/A',
    @OtherDetail3 = 'N/A',
    @OtherDetail4 = 'N/A',
    @OtherDetail5 = 'N/A',
    @OtherDetail6 = 'N/A',
    @ActionUser = 'admin';
*/
CREATE   PROCEDURE [spe].[StudentRegistration_Create]
(
    @SchoolId               INT,
    @UserId                 INT,
    @MappingId              INT,
    @AdmissionNo            VARCHAR(20),
    @AdmissionType          VARCHAR(20),
    @AdmissionStatus        VARCHAR(20),
    @AdmissionDate          DATETIME,
    @AcademicYear           VARCHAR(20),
    @ClassId                INT,
    @SectionId              INT,
    @AdmissionCategory      VARCHAR(100),
    @MotherTongue           VARCHAR(50),
    @IncomeProof            VARCHAR(500),
    @PreviousSchoolName     VARCHAR(255),
    @PreviousSchoolAddress  VARCHAR(500),
    @PBoard                 VARCHAR(100),
    @PLastClass             VARCHAR(50),
    @PMarksObtained         VARCHAR(20),
    @TransferCertificateNo  VARCHAR(50),
    @TCDate                 DATETIME = NULL,
    @ReasonForTransfer      VARCHAR(500),
    @GuardianType           VARCHAR(50),
    @GuardianName           VARCHAR(100),
    @GuardianContactNo      VARCHAR(20),
    @AlternateContactNo     VARCHAR(20),
    @SpecialNeeds           VARCHAR(500),
    @DisabilityStatus       VARCHAR(100),
    @OtherDetail1           VARCHAR(50) = NULL,
    @OtherDetail2           VARCHAR(50) = NULL,
    @OtherDetail3           VARCHAR(100) = NULL,
    @OtherDetail4           VARCHAR(100) = NULL,
    @OtherDetail5           VARCHAR(500) = NULL,
    @OtherDetail6           VARCHAR(500) = NULL,
    @ActionUser             VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1 
        FROM [spe].[StudentRegistration]
        WHERE [UserId] = @UserId AND [SchoolId] = @SchoolId AND [IsDeleted] = 0
    )
    BEGIN
        RAISERROR('This UserId and SchoolId combination already exists.', 16, 1);
        RETURN;
    END

    DECLARE @RegistrationId INT;

    INSERT INTO [spe].[StudentRegistration]
    (
        [SchoolId],
        [UserId],
        [MappingId],
        [AdmissionNo],
        [AdmissionType],
        [AdmissionStatus],
        [AdmissionDate],
        [AcademicYear],
        [ClassId],
        [SectionId],
        [AdmissionCategory],
        [MotherTongue],
        [IncomeProof],
        [PreviousSchoolName],
        [PreviousSchoolAddress],
        [PBoard],
        [PLastClass],
        [PMarksObtained],
        [TransferCertificateNo],
        [TCDate],
        [ReasonForTransfer],
        [GuardianType],
        [GuardianName],
        [GuardianContactNo],
        [AlternateContactNo],
        [SpecialNeeds],
        [DisabilityStatus],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @UserId,
        @MappingId,
        @AdmissionNo,
        @AdmissionType,
        @AdmissionStatus,
        @AdmissionDate,
        @AcademicYear,
        @ClassId,
        @SectionId,
        @AdmissionCategory,
        @MotherTongue,
        @IncomeProof,
        @PreviousSchoolName,
        @PreviousSchoolAddress,
        @PBoard,
        @PLastClass,
        @PMarksObtained,
        @TransferCertificateNo,
        @TCDate,
        @ReasonForTransfer,
        @GuardianType,
        @GuardianName,
        @GuardianContactNo,
        @AlternateContactNo,
        @SpecialNeeds,
        @DisabilityStatus,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,         
        0,         
        @ActionUser,
        GETDATE()
    );
    SET @RegistrationId = SCOPE_IDENTITY();

    SELECT
	   [RegistrationId]
      ,[SchoolId]
      ,[UserId]
      ,[AdmissionNo]
      ,[AdmissionType]
      ,[AdmissionStatus]
      ,[MotherTongue]
      ,[IncomeProof]
      ,[PreviousSchoolName]
      ,[PLastClass]
      ,[PMarksObtained]
      ,[TransferCertificateNo]
      ,[TCDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[MappingId]
      ,[AdmissionDate]
      ,[AcademicYear]
      ,[ClassId]
      ,[SectionId]
      ,[AdmissionCategory]
      ,[PreviousSchoolAddress]
      ,[PBoard]
      ,[ReasonForTransfer]
      ,[GuardianType]
      ,[GuardianName]
      ,[GuardianContactNo]
      ,[AlternateContactNo]
      ,[SpecialNeeds]
      ,[DisabilityStatus]
    FROM [spe].[StudentRegistration]
    WHERE RegistrationId = @RegistrationId;
END
GO
/****** Object:  StoredProcedure [spe].[StudentRegistration_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentRegistration_Delete]
(
   @RegistrationId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[StudentRegistration]
    SET 
        [IsActive] = 0,
        [IsDeleted] = 1,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [RegistrationId] = @RegistrationId;
END
GO
/****** Object:  StoredProcedure [spe].[StudentRegistration_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentRegistration_ReadAll]
AS
 BEGIN
  SET NOCOUNT ON;
   SELECT 
	   [RegistrationId]
      ,[SchoolId]
      ,[UserId]
      ,[AdmissionNo]
      ,[AdmissionType]
      ,[AdmissionStatus]
      ,[MotherTongue]
      ,[IncomeProof]
      ,[PreviousSchoolName]
      ,[PLastClass]
      ,[PMarksObtained]
      ,[TransferCertificateNo]
      ,[TCDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[MappingId]
      ,[AdmissionDate]
      ,[AcademicYear]
      ,[ClassId]
      ,[SectionId]
      ,[AdmissionCategory]
      ,[PreviousSchoolAddress]
      ,[PBoard]
      ,[ReasonForTransfer]
      ,[GuardianType]
      ,[GuardianName]
      ,[GuardianContactNo]
      ,[AlternateContactNo]
      ,[SpecialNeeds]
      ,[DisabilityStatus]
		FROM [spe].[StudentRegistration]
		WHERE [IsActive] = 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRegistration_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentRegistration_ReadById]
(
   @RegistrationId INT
)
AS
 BEGIN
    SET NOCOUNT ON;
    SELECT 
		   [RegistrationId]
		  ,[SchoolId]
		  ,[UserId]
		  ,[AdmissionNo]
		  ,[AdmissionType]
		  ,[AdmissionStatus]
		  ,[MotherTongue]
		  ,[IncomeProof]
		  ,[PreviousSchoolName]
		  ,[PLastClass]
		  ,[PMarksObtained]
		  ,[TransferCertificateNo]
		  ,[TCDate]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		  ,[MappingId]
		  ,[AdmissionDate]
		  ,[AcademicYear]
		  ,[ClassId]
		  ,[SectionId]
		  ,[AdmissionCategory]
		  ,[PreviousSchoolAddress]
		  ,[PBoard]
		  ,[ReasonForTransfer]
		  ,[GuardianType]
		  ,[GuardianName]
		  ,[GuardianContactNo]
		  ,[AlternateContactNo]
		  ,[SpecialNeeds]
		  ,[DisabilityStatus]
		FROM [spe].[StudentRegistration]
		WHERE [RegistrationId] = @RegistrationId
		AND [IsActive] = 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRegistration_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[StudentRegistration_ReadBySchoolId]
(
   @SchoolId INT
)
AS
 BEGIN
    SET NOCOUNT ON;
    SELECT 
		   [RegistrationId]
		  ,[SchoolId]
		  ,[UserId]
		  ,[AdmissionNo]
		  ,[AdmissionType]
		  ,[AdmissionStatus]
		  ,[MotherTongue]
		  ,[IncomeProof]
		  ,[PreviousSchoolName]
		  ,[PLastClass]
		  ,[PMarksObtained]
		  ,[TransferCertificateNo]
		  ,[TCDate]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		  ,[MappingId]
		  ,[AdmissionDate]
		  ,[AcademicYear]
		  ,[ClassId]
		  ,[SectionId]
		  ,[AdmissionCategory]
		  ,[PreviousSchoolAddress]
		  ,[PBoard]
		  ,[ReasonForTransfer]
		  ,[GuardianType]
		  ,[GuardianName]
		  ,[GuardianContactNo]
		  ,[AlternateContactNo]
		  ,[SpecialNeeds]
		  ,[DisabilityStatus]
		FROM [spe].[StudentRegistration]
		WHERE [SchoolId] = @SchoolId
		AND [IsActive] = 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRegistration_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
exec [spe].[StudentRegistration_ReadByUserId]1106,5
*/
CREATE   PROCEDURE [spe].[StudentRegistration_ReadByUserId]
(
   @UserId INT,
   @SchoolId INT 
)
AS
 BEGIN
    SET NOCOUNT ON;

    SELECT 
		   [RegistrationId]
		  ,[SchoolId]
		  ,[UserId]
		  ,[AdmissionNo]
		  ,[AdmissionType]
		  ,[AdmissionStatus]
		  ,[MotherTongue]
		  ,[IncomeProof]
		  ,[PreviousSchoolName]
		  ,[PLastClass]
		  ,[PMarksObtained]
		  ,[TransferCertificateNo]
		  ,[TCDate]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		  ,[MappingId]
		  ,[AdmissionDate]
		  ,[AcademicYear]
		  ,[ClassId]
		  ,[SectionId]
		  ,[AdmissionCategory]
		  ,[PreviousSchoolAddress]
		  ,[PBoard]
		  ,[ReasonForTransfer]
		  ,[GuardianType]
		  ,[GuardianName]
		  ,[GuardianContactNo]
		  ,[AlternateContactNo]
		  ,[SpecialNeeds]
		  ,[DisabilityStatus]
		FROM [spe].[StudentRegistration]
		WHERE [UserId] = @UserId
		AND [SchoolId] = @SchoolId
		AND [IsActive] = 1
		AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRegistration_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[StudentRegistration_Update]
    @RegistrationId = 1,
    @SchoolId = 1,
    @UserId = 1001,
    @AdmissionNo = 'AD12345',
    @AdmissionType = 'Regular',
    @AdmissionStatus = 'Confirmed',
    @MotherTongue = 'Hindi',
    @IncomeProof = 'UpdatedIncomeProof.pdf',
    @PreviousSchoolName = 'XYZ School',
    @PLastClass = '6th',
    @PMarksObtained = '91%',
    @TransferCertificateNo = 'TC98765',
    @TCDate = '2024-06-15',
    @OtherDetail1 = 'Updated1',
    @OtherDetail2 = 'Updated2',
    @OtherDetail3 = 'Updated3',
    @OtherDetail4 = 'Updated4',
    @OtherDetail5 = 'Updated5',
    @OtherDetail6 = 'Updated6',
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[StudentRegistration_Update]
(
    @RegistrationId         INT,
    @SchoolId               INT,
    @UserId                 INT,
    @MappingId              INT,
    @AdmissionNo            VARCHAR(20),
    @AdmissionType          VARCHAR(20),
    @AdmissionStatus        VARCHAR(20),
    @AdmissionDate          DATETIME,
    @AcademicYear           VARCHAR(20),
    @ClassId                INT,
    @SectionId              INT,
    @AdmissionCategory      VARCHAR(100),
    @MotherTongue           VARCHAR(50),
    @IncomeProof            VARCHAR(500),
    @PreviousSchoolName     VARCHAR(255),
    @PreviousSchoolAddress  VARCHAR(500),
    @PBoard                 VARCHAR(100),
    @PLastClass             VARCHAR(50),
    @PMarksObtained         VARCHAR(20),
    @TransferCertificateNo  VARCHAR(50),
    @TCDate                 DATETIME = NULL,
    @ReasonForTransfer      VARCHAR(500),
    @GuardianType           VARCHAR(50),
    @GuardianName           VARCHAR(100),
    @GuardianContactNo      VARCHAR(20),
    @AlternateContactNo     VARCHAR(20),
    @SpecialNeeds           VARCHAR(500),
    @DisabilityStatus       VARCHAR(100),
    @OtherDetail1           VARCHAR(50) = NULL,
    @OtherDetail2           VARCHAR(50) = NULL,
    @OtherDetail3           VARCHAR(100) = NULL,
    @OtherDetail4           VARCHAR(100) = NULL,
    @OtherDetail5           VARCHAR(500) = NULL,
    @OtherDetail6           VARCHAR(500) = NULL,
    @IsActive               INT,
    @ActionUser             VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[StudentRegistration]
    SET
        [SchoolId]              = @SchoolId,
        [UserId]                = @UserId,
        [MappingId]             = @MappingId,
        [AdmissionNo]           = @AdmissionNo,
        [AdmissionType]         = @AdmissionType,
        [AdmissionStatus]       = @AdmissionStatus,
        [AdmissionDate]         = @AdmissionDate,
        [AcademicYear]          = @AcademicYear,
        [ClassId]               = @ClassId,
        [SectionId]             = @SectionId,
        [AdmissionCategory]     = @AdmissionCategory,
        [MotherTongue]          = @MotherTongue,
        [IncomeProof]           = @IncomeProof,
        [PreviousSchoolName]    = @PreviousSchoolName,
        [PreviousSchoolAddress] = @PreviousSchoolAddress,
        [PBoard]                = @PBoard,
        [PLastClass]            = @PLastClass,
        [PMarksObtained]        = @PMarksObtained,
        [TransferCertificateNo] = @TransferCertificateNo,
        [TCDate]                = @TCDate,
        [ReasonForTransfer]     = @ReasonForTransfer,
        [GuardianType]          = @GuardianType,
        [GuardianName]          = @GuardianName,
        [GuardianContactNo]     = @GuardianContactNo,
        [AlternateContactNo]    = @AlternateContactNo,
        [SpecialNeeds]          = @SpecialNeeds,
        [DisabilityStatus]      = @DisabilityStatus,
        [OtherDetail1]          = @OtherDetail1,
        [OtherDetail2]          = @OtherDetail2,
        [OtherDetail3]          = @OtherDetail3,
        [OtherDetail4]          = @OtherDetail4,
        [OtherDetail5]          = @OtherDetail5,
        [OtherDetail6]          = @OtherDetail6,
        [IsActive]              = @IsActive,
        [ModifiedBy]            = @ActionUser,
        [ModifiedOn]            = GETDATE()
    WHERE [RegistrationId] = @RegistrationId;

    SELECT
       [RegistrationId]
      ,[SchoolId]
      ,[UserId]
      ,[AdmissionNo]
      ,[AdmissionType]
      ,[AdmissionStatus]
      ,[MotherTongue]
      ,[IncomeProof]
      ,[PreviousSchoolName]
      ,[PLastClass]
      ,[PMarksObtained]
      ,[TransferCertificateNo]
      ,[TCDate]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
      ,[MappingId]
      ,[AdmissionDate]
      ,[AcademicYear]
      ,[ClassId]
      ,[SectionId]
      ,[AdmissionCategory]
      ,[PreviousSchoolAddress]
      ,[PBoard]
      ,[ReasonForTransfer]
      ,[GuardianType]
      ,[GuardianName]
      ,[GuardianContactNo]
      ,[AlternateContactNo]
      ,[SpecialNeeds]
      ,[DisabilityStatus]
    FROM [spe].[StudentRegistration]
    WHERE [RegistrationId] = @RegistrationId
	AND [IsDeleted] = 0
	AND [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [spe].[StudentRouteMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[StudentRouteMapping_Create]
    @StudentId = 101,
    @RouteId = 2,
    @PickupStopId = 10,
    @DropStopId = 15,
    @VehicleId = 5,
    @StartDate = '2025-06-01',
    @EndDate = '2026-03-31',
    @OtherDetail1 = 'Morning',
    @OtherDetail2 = 'Session A',
    @OtherDetail3 = '',
    @OtherDetail4 = '',
    @OtherDetail5 = '',
    @OtherDetail6 = '',
    @ActionUser = '4';
*/

CREATE   PROCEDURE [spe].[StudentRouteMapping_Create]
(
    @UserId          INT,
    @RouteId         INT,
    @PickupDetailId  INT,
    @DropDetailId    INT,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MappingId INT;

	
    --  Prevent duplicate route mapping for same student & route
    IF EXISTS (
        SELECT 1
        FROM [spe].[StudentRouteMapping]
        WHERE UserId = @UserId
          AND RouteId = @RouteId
          AND IsActive = 1
          AND IsDeleted = 0
    )
    BEGIN
        SELECT 'Route mapping already exists for this student' AS Message;
        RETURN;
    END

    INSERT INTO [spe].[StudentRouteMapping]
    (
        [UserId],
        [RouteId],
        [PickupDetailId],
        [DropDetailId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @RouteId,
        @PickupDetailId,
        @DropDetailId,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,    
        GETDATE()       
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT
        [MappingId],
        [UserId],
        [RouteId],
        [PickupDetailId],
        [DropDetailId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].StudentRouteMapping
    WHERE [MappingId] = @MappingId
	AND [IsActive]  = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRouteMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentRouteMapping_Delete]
(
   @MappingId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [spe].StudentRouteMapping
	SET	
		[IsActive] = 0, 
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MappingId] = @MappingId
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRouteMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentRouteMapping_ReadAll]
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [MappingId]
		,[UserId]
		,[RouteId]
		,[PickupDetailId]
		,[DropDetailId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].StudentRouteMapping
	WHERE [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRouteMapping_ReadByDropDetailId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentRouteMapping_ReadByDropDetailId]
(
   @DropDetailId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [MappingId]
		,[UserId]
		,[RouteId]
		,[PickupDetailId]
		,[DropDetailId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].StudentRouteMapping
	WHERE [DropDetailId] = @DropDetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRouteMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentRouteMapping_ReadById]
(
   @MappingId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [MappingId]
		,[UserId]
		,[RouteId]
		,[PickupDetailId]
		,[DropDetailId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].StudentRouteMapping
	WHERE [MappingId] = @MappingId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRouteMapping_ReadByPickupDetailId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[StudentRouteMapping_ReadByPickupDetailId]
(
   @PickupDetailId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 [MappingId]
		,[UserId]
		,[RouteId]
		,[PickupDetailId]
		,[DropDetailId]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].StudentRouteMapping
	WHERE [PickupDetailId] = @PickupDetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRouteMapping_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/****** Object:  [spe].[StudentRouteMapping_ReadByUserId]3201    ******/


CREATE   PROCEDURE [spe].[StudentRouteMapping_ReadByUserId]
(
   @UserId INT
)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT 
		 A.[MappingId]
		,A.[UserId]
		,A.[RouteId]
		,B.[RouteName]
		,A.[PickupDetailId]
		,C.[StopName] AS  [PickupStopName]
		,A.[DropDetailId]
		,D.[StopName] AS [DropStopName]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn]
	FROM [spe].StudentRouteMapping A
	LEFT OUTER JOIN [Nishwik].[spe].[VehicleRouteMaster]B
	ON A.[RouteId] = B.[RouteId]
	LEFT OUTER JOIN [Nishwik].[spe].[VehicleRouteDetail]C
	ON A.[PickupDetailId]  = C.[DetailId]
	LEFT OUTER JOIN [Nishwik].[spe].[VehicleRouteDetail]D
	ON A.[DropDetailId] = D.[DetailId]
	WHERE [UserId] = @UserId
	AND A.[IsActive] = 1
	AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[StudentRouteMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[StudentBusMapping_Update]
    @MappingId = 1,
    @StudentId = 101,
    @RouteId = 2,
    @PickupStopId = 10,
    @DropStopId = 15,
    @VehicleId = 5,
    @StartDate = '2025-06-01',
    @EndDate = '2026-03-31',
    @OtherDetail1 = 'Morning',
    @OtherDetail2 = 'Session A',
    @OtherDetail3 = '',
    @OtherDetail4 = '',
    @OtherDetail5 = '',
    @OtherDetail6 = '',
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[StudentRouteMapping_Update]
(
    @MappingId       INT,
    @UserId       INT,
    @RouteId         INT,
    @PickupDetailId   INT,
    @DropDetailId      INT,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @IsActive        INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;

		IF EXISTS (
		SELECT 1
		FROM [spe].[StudentRouteMapping]
		WHERE [UserId] = @UserId
		AND [RouteId] = @RouteId
		AND [MappingId] <> @MappingId
		AND [IsActive] = 1
		AND [IsDeleted] = 0
	)
  BEGIN
		RAISERROR('This student is already mapped to the same route.', 16, 1);
		RETURN;
	END

	UPDATE [spe].StudentRouteMapping
	SET
		[UserId] = @UserId,
		[RouteId] = @RouteId,
		[PickupDetailId] = @PickupDetailId,
		[DropDetailId] = @DropDetailId,
		[OtherDetail1] = @OtherDetail1,
		[OtherDetail2] = @OtherDetail2,
		[OtherDetail3] = @OtherDetail3,
		[OtherDetail4] = @OtherDetail4,
		[OtherDetail5] = @OtherDetail5,
		[OtherDetail6] = @OtherDetail6,
		[IsActive] =   @IsActive,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MappingId] = @MappingId
	SELECT
			[MappingId],
			[UserId],
			[RouteId],
			[PickupDetailId],
			[DropDetailId],
			[OtherDetail1],
			[OtherDetail2],
			[OtherDetail3],
			[OtherDetail4],
			[OtherDetail5],
			[OtherDetail6],
			[IsActive],
			[IsDeleted],
			[CreatedBy],
			[CreatedOn],
			[ModifiedBy],
			[ModifiedOn]
	FROM [spe].StudentRouteMapping
	WHERE [MappingId] = @MappingId
	AND [IsDeleted] = 0
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SubjectMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SubjectMaster_Create]
(
    @SchoolId INT,
	@ClassId INT,
	@SubjectCode VARCHAR(20),
	@SubjectName VARCHAR(50),
	@Description VARCHAR(500),
	@AcademicLevel VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
    IF EXISTS (
        SELECT 1
        FROM [spe].[SubjectMaster]
        WHERE SchoolId = @SchoolId
          AND ClassId = @ClassId
          AND SubjectName = @SubjectName
          AND IsActive = 1
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('Duplicate Subject Name for this Class.', 16, 1);
        RETURN;
    END



    DECLARE @SubjectId INT;

    INSERT INTO [spe].[SubjectMaster]
    (
        [SchoolId],
        [ClassId],
        [SubjectCode],
        [SubjectName],
        [Description],
        [AcademicLevel],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @ClassId,
        @SubjectCode,
        @SubjectName,
        @Description,
        @AcademicLevel,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,             
        0,             
        @ActionUser,
        GETDATE()
    );

    SET @SubjectId = SCOPE_IDENTITY();

    SELECT
        [SubjectId],
        [SchoolId],
        [ClassId],
        [SubjectCode],
        [SubjectName],
        [Description],
        [AcademicLevel],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[SubjectMaster]
    WHERE [SubjectId] = @SubjectId;
END;
GO
/****** Object:  StoredProcedure [spe].[SubjectMaster_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[SubjectMaster_CreateBulk]
(
	@SubjectIdList  [spe].[udt_SubjectMaster] READONLY,
	@ActionUser VARCHAR(50)
)
AS
BEGIN 
	SET NOCOUNT ON;

	INSERT INTO [spe].[SubjectMaster]
	(
		 [SchoolId]
		,[ClassId]
		,[SubjectCode]
		,[SubjectName]
		,[Description]
		,[AcademicLevel]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
	)
	SELECT 
		 [SchoolId]
		,[ClassId]
		,[SubjectCode]
		,[SubjectName]
		,[Description]
		,[AcademicLevel]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,1
		,0
		,@ActionUser
		,GETDATE()
	FROM @SubjectIdList;

	SELECT
		 [SubjectId]
		,[SchoolId]
		,[ClassId]
		,[SubjectCode]
		,[SubjectName]
		,[Description]
		,[AcademicLevel]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[SubjectMaster]
	WHERE IsActive = 1
	  AND IsDeleted = 0
	  AND CreatedBy = @ActionUser
	  AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [spe].[SubjectMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SubjectMaster_Delete]
(
      @SubjectId INT,
	  @ActionUser varchar(50)
)
AS
 BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[SubjectMaster]
	SET
	     [IsActive] = 0,
	     [IsDeleted] =1 ,
	     [ModifiedBy] = @ActionUser,
	     [ModifiedOn] = GETDATE()
	WHERE  [SubjectId]  = @SubjectId
END;
GO
/****** Object:  StoredProcedure [spe].[SubjectMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SubjectMaster_ReadAll]
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [SubjectId]
      ,[SchoolId]
      ,[ClassId]
      ,[SubjectCode]
      ,[SubjectName]
      ,[Description]
      ,[AcademicLevel]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[SubjectMaster]
	WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SubjectMaster_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SubjectMaster_ReadByClassId]
(
      @ClassId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [SubjectId]
      ,[SchoolId]
      ,[ClassId]
      ,[SubjectCode]
      ,[SubjectName]
      ,[Description]
      ,[AcademicLevel]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[SubjectMaster]
	WHERE  [ClassId]  = @ClassId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SubjectMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SubjectMaster_ReadById]
(
      @SubjectId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [SubjectId]
      ,[SchoolId]
      ,[ClassId]
      ,[SubjectCode]
      ,[SubjectName]
      ,[Description]
      ,[AcademicLevel]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[SubjectMaster]
	WHERE  [SubjectId]  = @SubjectId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SubjectMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SubjectMaster_ReadBySchoolId]
(
      @SchoolId INT 
)
AS
 BEGIN 
	SET NOCOUNT ON;
	SELECT 
	   [SubjectId]
      ,[SchoolId]
      ,[ClassId]
      ,[SubjectCode]
      ,[SubjectName]
      ,[Description]
      ,[AcademicLevel]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	FROM [spe].[SubjectMaster]
	WHERE  [SchoolId]  = @SchoolId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[SubjectMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[SubjectMaster_Update]
(
    @SubjectId INT,
	@SchoolId INT,
	@ClassId INT,
	@SubjectCode VARCHAR(20),
	@SubjectName VARCHAR(50),
	@Description VARCHAR(500),
	@AcademicLevel VARCHAR(50),
    @OtherDetail1 VARCHAR(50),
    @OtherDetail2 VARCHAR(50),
    @OtherDetail3 VARCHAR(100),
    @OtherDetail4 VARCHAR(100),
    @OtherDetail5 VARCHAR(500),
    @OtherDetail6 VARCHAR(500),
    @IsActive     INT,
    @ActionUser   VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[SubjectMaster]
    SET
        [SchoolId] = @SchoolId,
        [ClassId] = @ClassId,
        [SubjectCode] = @SubjectCode,
        [SubjectName] = @SubjectName,
        [Description] = @Description,
        [AcademicLevel] = @AcademicLevel,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE
        [SubjectId] = @SubjectId;

    SELECT
        [SubjectId],
        [SchoolId],
        [ClassId],
        [SubjectCode],
        [SubjectName],
        [Description],
        [AcademicLevel],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[SubjectMaster]
    WHERE [SubjectId] = @SubjectId
	 AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_Create]
(
    @TeacherId INT,
	@SchoolId INT,
	@ClassId INT,
	@SectionId INT,
	@SubjectId INT,
	@AcademicYear NVARCHAR(20),
    @OtherDetail1 VARCHAR(50)   = NULL,
    @OtherDetail2 VARCHAR(50)   = NULL,
    @OtherDetail3 VARCHAR(100)  = NULL,
    @OtherDetail4 VARCHAR(100)  = NULL,
    @OtherDetail5 VARCHAR(500)  = NULL,
    @OtherDetail6 VARCHAR(500)  = NULL,
    @ActionUser   VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @MappingId INT;


    IF EXISTS (
        SELECT 1 
        FROM [spe].[TeacherClassSubjectMapping]
        WHERE 
            TeacherId = @TeacherId
            AND SchoolId = @SchoolId
            AND ClassId = @ClassId
            AND SectionId = @SectionId
            AND SubjectId = @SubjectId
			AND IsActive= 1
            AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('This teacher is already assigned to the same Class, Section, and Subject.', 16, 1);
        RETURN;
    END



    INSERT INTO [spe].[TeacherClassSubjectMapping]
    (
        [TeacherId],
        [SchoolId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [AcademicYear],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
      @TeacherId,
      @SchoolId,
      @ClassId,
      @SectionId,
      @SubjectId,
      @AcademicYear,
      @OtherDetail1,
      @OtherDetail2,
      @OtherDetail3,
      @OtherDetail4,
      @OtherDetail5,
      @OtherDetail6,
        1, 
        0, 
       @ActionUser,
        GETDATE()
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT 
       [MappingId]
      ,[TeacherId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [spe].[TeacherClassSubjectMapping]
    WHERE [MappingId] = @MappingId;
END
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_Delete]
(
   @MappingId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	  UPDATE [spe].[TeacherClassSubjectMapping]
	   SET
            [IsActive] = 0,
			[IsDeleted]=1,
            [ModifiedBy] = @ActionUser,
            [ModifiedOn] = GETDATE()
	  WHERE [MappingId] = @MappingId
END;

GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [MappingId]
      ,[TeacherId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[TeacherClassSubjectMapping]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_ReadByClassId]
(
   @ClassId INT,
   @SectionId INT = NULL
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [MappingId]
      ,[TeacherId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[TeacherClassSubjectMapping]
	  WHERE [ClassId] = @ClassId
	  AND [SectionId] = @SectionId
	  AND  [IsActive] = 1
	  AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_ReadById]
(
    @MappingId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[TeacherId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[TeacherClassSubjectMapping]
	  WHERE [MappingId]  =@MappingId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_ReadBySchoolId]
(
   @SchoolId INT
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [MappingId]
      ,[TeacherId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[TeacherClassSubjectMapping]
	  WHERE [SchoolId] = @SchoolId
	  AND  [IsActive] = 1
	  AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_ReadBySectionId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_ReadBySectionId]
(
   @SectionId INT
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [MappingId]
      ,[TeacherId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[TeacherClassSubjectMapping]
	  WHERE [SectionId] = @SectionId
	  AND  [IsActive] = 1
	  AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_ReadBySubjectId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_ReadBySubjectId]
(
   @SubjectId INT
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [MappingId]
      ,[TeacherId]
      ,[SchoolId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[AcademicYear]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[TeacherClassSubjectMapping]
	  WHERE [SubjectId] = @SubjectId
	  AND  [IsActive] = 1
	  AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_ReadByTeacherId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_ReadByTeacherId]
(
   @TeacherId INT
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[MappingId]
      ,A.[TeacherId]
      ,A.[SchoolId]
      ,A.[ClassId]
	  ,B.[ClassName]
      ,A.[SectionId]
	  ,C.[SectionName]
      ,A.[SubjectId]
	  ,D.[SubjectName]
      ,A.[AcademicYear]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[TeacherClassSubjectMapping]A
	  LEFT OUTER JOIN [spe].[ClassMaster]B
	  ON A.[ClassId] = B.[ClassId]
	  LEFT OUTER JOIN  [spe].[SectionMaster]C
	  ON A.[SectionId] = C.[SectionId]
	  LEFT OUTER JOIN  [spe].[SubjectMaster]D
	  ON A.[SubjectId] = D.[SubjectId]
	  WHERE [TeacherId] = @TeacherId
	  AND  A.[IsActive] = 1
	  AND A.[IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[TeacherClassSubjectMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherClassSubjectMapping_Update]
(
    @MappingId INT,
    @TeacherId INT,
	@SchoolId INT,
	@ClassId INT,
	@SectionId INT,
	@SubjectId INT,
	@AcademicYear NVARCHAR(20),
    @OtherDetail1   VARCHAR(50)   = NULL,
    @OtherDetail2   VARCHAR(50)   = NULL,
    @OtherDetail3   VARCHAR(100)  = NULL,
    @OtherDetail4   VARCHAR(100)  = NULL,
    @OtherDetail5   VARCHAR(500)  = NULL,
    @OtherDetail6   VARCHAR(500)  = NULL,
    @IsActive       INT           = 1,
    @ActionUser     VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[TeacherClassSubjectMapping]
    SET
        [TeacherId] = @TeacherId,
        [SchoolId] = @SchoolId,
        [ClassId] = @ClassId,
        [SectionId] = @SectionId,
        [SubjectId] = @SubjectId,
        [AcademicYear] = @AcademicYear,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [MappingId] = @MappingId

    SELECT 
        [MappingId],
        [TeacherId],
        [SchoolId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [AcademicYear],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[TeacherClassSubjectMapping]
    WHERE [MappingId] = @MappingId
	      AND [IsDeleted] = 0
		  AND [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[TeacherScheduleMaster_Create]
    @SchoolId = 5,
    @ScheduleDate = null,
    @TeacherId = 1284,
    @ClassId = 1107,
    @SectionId = 1025,
    @SubjectId = 7,
    @ScheduleType = 'Tutorial',
    @StartTime = '10:00:00',
    @Duration = 1,
    @EndTime = '11:00:00',
    @Mode = 'Online',
    @MeetingLink = '',
    @Status = '',
    @Description = '',
    @DayOfWeek = 1,
    @OtherDetail1 = '',
    @OtherDetail2 = '',
    @OtherDetail3 = '',
    @OtherDetail4 = '',
    @OtherDetail5 = '',
    @OtherDetail6 = '',
    @ActionUser = '1283';

*/

CREATE   PROCEDURE [spe].[TeacherScheduleMaster_Create]
(
    @SchoolId       INT,
    @ScheduleDate   DATETIME = NULL,
    @TeacherId      INT,
    @ClassId        INT,
    @SectionId      INT = null,
    @SubjectId      INT,
    @ScheduleType   VARCHAR(50)   = NULL,
    @StartTime      TIME,
    @Duration       INT,
    @EndTime        TIME,
    @Mode           VARCHAR(50),
    @MeetingLink    VARCHAR(250)  = NULL,
    @Status         VARCHAR(50)   = NULL,
    @Description    VARCHAR(500)  = NULL,
	@DayOfWeek      INT,
    @OtherDetail1   VARCHAR(50)   = NULL,
    @OtherDetail2   VARCHAR(50)   = NULL,
    @OtherDetail3   VARCHAR(100)  = NULL,
    @OtherDetail4   VARCHAR(100)  = NULL,
    @OtherDetail5   VARCHAR(500)  = NULL,
    @OtherDetail6   VARCHAR(500)  = NULL,
    @ActionUser     VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ScheduleId INT;

		-- Rule 1: Same teacher + same class + overlapping time
		IF EXISTS (
			SELECT 1
			FROM [spe].[TeacherScheduleMaster]
			WHERE SchoolId = @SchoolId
				AND TeacherId = @TeacherId
				AND ClassId = @ClassId
		        AND DayOfWeek = @DayOfWeek
				AND IsActive = 1
				AND IsDeleted = 0
				AND NOT (EndTime <= @StartTime OR StartTime >= @EndTime)
		)
		BEGIN
			RAISERROR('Teacher already has a lecture for this class during the same time slot.', 16, 1);
			RETURN;
		END

		-- Rule 2: Teacher cannot take two different classes at same time
		IF EXISTS (
			SELECT 1
			FROM [spe].[TeacherScheduleMaster]
			WHERE SchoolId = @SchoolId
				AND TeacherId = @TeacherId
			    AND DayOfWeek = @DayOfWeek
				AND IsActive = 1
				AND IsDeleted = 0
				AND NOT (EndTime <= @StartTime OR StartTime >= @EndTime)
		)
		BEGIN
			RAISERROR('Teacher already has another class in this time slot.', 16, 1);
			RETURN;
		END

		-- Rule 3: Prevent assigning multiple teachers to same class/time
		IF EXISTS (
			SELECT 1
			FROM [spe].[TeacherScheduleMaster]
			WHERE SchoolId = @SchoolId
				AND ClassId = @ClassId
			    AND DayOfWeek = @DayOfWeek
				AND IsActive = 1
				AND IsDeleted = 0
				AND NOT (EndTime <= @StartTime OR StartTime >= @EndTime)
		)
		BEGIN
			RAISERROR('This class already has a teacher assigned for this time slot.', 16, 1);
			RETURN;
		END

    INSERT INTO [spe].[TeacherScheduleMaster]
    (
        [SchoolId],
        [ScheduleDate],
        [TeacherId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [ScheduleType],
        [StartTime],
        [Duration],
        [EndTime],
        [Mode],
        [MeetingLink],
        [Status],
        [Description],
		[DayOfWeek],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @ScheduleDate,
        @TeacherId,
        @ClassId,
        @SectionId,
        @SubjectId,
        TRIM(@ScheduleType),
        @StartTime,
        @Duration,
        @EndTime,
        TRIM(@Mode),
        TRIM(@MeetingLink),
        TRIM(@Status),
        TRIM(@Description),
		@DayOfWeek,
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1, -- IsActive default
        0, -- IsDeleted default
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @ScheduleId = SCOPE_IDENTITY();

    SELECT 
        [ScheduleId],
        [SchoolId],
        [ScheduleDate],
        [TeacherId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [ScheduleType],
        [StartTime],
        [Duration],
        [EndTime],
        [Mode],
        [MeetingLink],
        [Status],
        [Description],
		[DayOfWeek],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[TeacherScheduleMaster]
    WHERE [ScheduleId] = @ScheduleId;
END
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[TeacherScheduleMaster_Delete]
(
   @ScheduleId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
      SET NOCOUNT ON;
	  UPDATE [spe].[TeacherScheduleMaster]
	   SET
            [IsActive] = 0,
            [CreatedOn] = 1,
            [ModifiedBy] = @ActionUser,
            [ModifiedOn] = GETDATE()
	  WHERE [ScheduleId] = @ScheduleId
END;

GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[TeacherScheduleMaster_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [ScheduleId]
      ,[SchoolId]
      ,[ScheduleDate]
      ,[TeacherId]
      ,[ClassId]
      ,[SectionId]
      ,[SubjectId]
      ,[ScheduleType]
      ,[StartTime]
      ,[Duration]
      ,[EndTime]
      ,[Mode]
      ,[MeetingLink]
      ,[Status]
      ,[Description]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  ,[DayOfWeek]
	  FROM [spe].[TeacherScheduleMaster]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_ReadByClassId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[TeacherScheduleMaster_ReadByClassId]
(
   @ClassId INT,
   @SectionId INT = NULL
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		T.DayOfWeek,
		CASE 
			WHEN T.DayOfWeek = 1 THEN 'Monday'
			WHEN T.DayOfWeek = 2 THEN 'Tuesday'
			WHEN T.DayOfWeek = 3 THEN 'Wednesday'
			WHEN T.DayOfWeek = 4 THEN 'Thursday'
			WHEN T.DayOfWeek = 5 THEN 'Friday'
			WHEN T.DayOfWeek = 6 THEN 'Saturday'
			WHEN T.DayOfWeek = 7 THEN 'Sunday'
		END AS DayName,
		T.StartTime,
		T.EndTime,
		T.TeacherId,
		T.SubjectId,
		T.ScheduleType,
		T.Mode,
		T.MeetingLink,
		(UM.FirstName + ' ' + UM.LastName) AS TeacherName,
		SM.SubjectName
	FROM spe.TeacherScheduleMaster T
	LEFT OUTER JOIN dbo.UserMaster UM
	ON T.TeacherId = UM.UserId
	LEFT OUTER JOIN spe.SubjectMaster SM
	ON T.SubjectId = SM.SubjectId
	WHERE 
		T.ClassId = @ClassId
		AND (@SectionId IS NULL OR T.SectionId = @SectionId)
		AND T.ScheduleDate IS NULL
		AND T.IsActive = 1
		AND T.IsDeleted = 0
	ORDER BY 
		T.DayOfWeek, 
		T.StartTime;
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[TeacherScheduleMaster_ReadById]
(
   @ScheduleId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[ScheduleId]
      ,A.[SchoolId]
	  ,B.[SchoolName]
      ,A.[ScheduleDate]
      ,A.[TeacherId]
	  ,C.[FirstName]
	  ,C.[LastName]
      ,A.[ClassId]
	  ,D.[ClassName]
      ,A.[SectionId]
	  ,E.[SectionName]
      ,A.[SubjectId]
	  ,F.[SubjectName]
      ,A.[ScheduleType]
      ,A.[StartTime]
      ,A.[Duration]
      ,A.[EndTime]
      ,A.[Mode]
      ,A.[MeetingLink]
      ,A.[Status]
      ,A.[Description]
	  ,A.[DayOfWeek]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[TeacherScheduleMaster]A
	  LEFT OUTER JOIN [Nishwik].[spe].[SchoolMaster]B
	  ON  A.[SchoolId] = B.[SchoolId]
	  LEFT  OUTER JOIN [Nishwik].[dbo].[UserMaster]C
	  ON A.[TeacherId] = C.UserId
	  LEFT OUTER JOIN [Nishwik].[spe].[ClassMaster]D
	  ON A.ClassId = D.ClassId
	  LEFT OUTER JOIN [Nishwik].[spe].[SectionMaster]E
	  ON A.SectionId= E.SectionId
	  LEFT OUTER JOIN  [Nishwik].[spe].[SubjectMaster]F
	   ON A.[SubjectId]  = F.[SubjectId]
	  WHERE [ScheduleId] = @ScheduleId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[spe].[TeacherScheduleMaster_ReadBySchoolId] 5
*/
CREATE   PROCEDURE [spe].[TeacherScheduleMaster_ReadBySchoolId]
(
   @SchoolId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		T.ScheduleId,
	    T.SchoolId,
	    T.Status,
        T.TeacherId,
		TRIM(UM.FirstName) + ' ' + TRIM(UM.LastName) AS TeacherName,
		T.DayOfWeek,
		CASE 
			WHEN T.DayOfWeek = 1 THEN 'Monday'
			WHEN T.DayOfWeek = 2 THEN 'Tuesday'
			WHEN T.DayOfWeek = 3 THEN 'Wednesday'
			WHEN T.DayOfWeek = 4 THEN 'Thursday'
			WHEN T.DayOfWeek = 5 THEN 'Friday'
			WHEN T.DayOfWeek = 6 THEN 'Saturday'
			WHEN T.DayOfWeek = 7 THEN 'Sunday'
		END AS DayName,

		T.StartTime,
		T.EndTime,
		T.Duration,
		T.ClassId,
		T.SectionId,
		T.SubjectId,
		T.ScheduleType,
		T.Mode,
		T.MeetingLink,
		SM.SubjectName,
		CM.ClassName,
		SCM.SectionName,
		T.Description
	FROM spe.TeacherScheduleMaster T
	LEFT OUTER JOIN spe.SubjectMaster SM
	ON T.SubjectId = SM.SubjectId
	LEFT OUTER JOIN spe.ClassMaster CM
	ON T.ClassId = CM.ClassId
	LEFT OUTER JOIN spe.SectionMaster SCM
	ON T.SectionId = SCM.SectionId
	LEFT OUTER JOIN dbo.UserMaster UM
	ON T.TeacherId = UM.UserId
	WHERE 
    
		T.IsActive = 1
		AND T.IsDeleted = 0
		AND T.ScheduleDate IS NULL     
		AND T.SchoolId = @SchoolId
	ORDER BY 
		T.DayOfWeek,
		T.StartTime;
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_ReadBySectionId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[TeacherScheduleMaster_ReadBySectionId]
(
   @SectionId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[ScheduleId]
      ,A.[SchoolId]
	  ,B.[SchoolName]
      ,A.[ScheduleDate]
      ,A.[TeacherId]
	  ,C.[FirstName]
	  ,C.[LastName]
      ,A.[ClassId]
	  ,D.[ClassName]
      ,A.[SectionId]
	  ,E.[SectionName]
      ,A.[SubjectId]
	  ,F.[SubjectName]
      ,A.[ScheduleType]
      ,A.[StartTime]
      ,A.[Duration]
      ,A.[EndTime]
      ,A.[Mode]
      ,A.[MeetingLink]
      ,A.[Status]
      ,A.[Description]
	  ,A.[DayOfWeek]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[TeacherScheduleMaster]A
	  LEFT OUTER JOIN [Nishwik].[spe].[SchoolMaster]B
	  ON  A.[SchoolId] = B.[SchoolId]
	  LEFT  OUTER JOIN [Nishwik].[dbo].[UserMaster]C
	  ON A.[TeacherId] = C.UserId
	  LEFT OUTER JOIN [Nishwik].[spe].[ClassMaster]D
	  ON A.ClassId = D.ClassId
	  LEFT OUTER JOIN [Nishwik].[spe].[SectionMaster]E
	  ON A.SchoolId= E.SectionId
	  LEFT OUTER JOIN  [Nishwik].[spe].[SubjectMaster]F
	   ON A.[SubjectId]  = F.[SubjectId]
	  WHERE A.[SectionId] = @SectionId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_ReadBySubjectId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[TeacherScheduleMaster_ReadBySubjectId]
(
   @SubjectId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[ScheduleId]
      ,A.[SchoolId]
	  ,B.[SchoolName]
      ,A.[ScheduleDate]
      ,A.[TeacherId]
	  ,C.[FirstName]
	  ,C.[LastName]
      ,A.[ClassId]
	  ,D.[ClassName]
      ,A.[SectionId]
	  ,E.[SectionName]
      ,A.[SubjectId]
	  ,F.[SubjectName]
      ,A.[ScheduleType]
      ,A.[StartTime]
      ,A.[Duration]
      ,A.[EndTime]
      ,A.[Mode]
      ,A.[MeetingLink]
      ,A.[Status]
      ,A.[Description]
	  ,A.[DayOfWeek]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[TeacherScheduleMaster]A
	  LEFT OUTER JOIN [Nishwik].[spe].[SchoolMaster]B
	  ON  A.[SchoolId] = B.[SchoolId]
	  LEFT  OUTER JOIN [Nishwik].[dbo].[UserMaster]C
	  ON A.[TeacherId] = C.UserId
	  LEFT OUTER JOIN [Nishwik].[spe].[ClassMaster]D
	  ON A.ClassId = D.ClassId
	  LEFT OUTER JOIN [Nishwik].[spe].[SectionMaster]E
	  ON A.SectionId= E.SectionId
	  LEFT OUTER JOIN  [Nishwik].[spe].[SubjectMaster]F
	   ON A.[SubjectId]  = F.[SubjectId]
	  WHERE A.[SubjectId] = @SubjectId
	  AND A.[IsActive] = 1
	  AND A. [IsDeleted] = 0
END;

GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_ReadByTeacherId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[spe].[TeacherScheduleMaster_ReadByTeacherId] 1284
*/
CREATE   PROCEDURE [spe].[TeacherScheduleMaster_ReadByTeacherId]
(
   @TeacherId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
			T.ScheduleId,
			T.SchoolId,
			T.Status,
			T.TeacherId,
		   TRIM(UM.FirstName) + ' ' + TRIM(UM.LastName) AS TeacherName,
			T.DayOfWeek,
			CASE 
				WHEN T.DayOfWeek = 1 THEN 'Monday'
				WHEN T.DayOfWeek = 2 THEN 'Tuesday'
				WHEN T.DayOfWeek = 3 THEN 'Wednesday'
				WHEN T.DayOfWeek = 4 THEN 'Thursday'
				WHEN T.DayOfWeek = 5 THEN 'Friday'
				WHEN T.DayOfWeek = 6 THEN 'Saturday'
				WHEN T.DayOfWeek = 7 THEN 'Sunday'
			END AS DayName,

			T.StartTime,
			T.EndTime,
			T.Duration,
			T.ClassId,
			T.SectionId,
			T.SubjectId,
			T.ScheduleType,
			T.Mode,
			T.MeetingLink,
			SM.SubjectName,
			CM.ClassName,
			SCM.SectionName,
			T.Description

		FROM spe.TeacherScheduleMaster T
		LEFT OUTER JOIN spe.SubjectMaster SM
		ON T.SubjectId = SM.SubjectId
		LEFT OUTER JOIN spe.ClassMaster CM
		ON T.ClassId = CM.ClassId
		LEFT OUTER JOIN spe.SectionMaster SCM
		ON T.SectionId = SCM.SectionId
		LEFT OUTER JOIN dbo.UserMaster UM
	  ON T.TeacherId = UM.UserId
		WHERE 
			T.TeacherId = @TeacherId
			AND T.IsActive = 1
			AND T.IsDeleted = 0
			AND T.ScheduleDate IS NULL       
		ORDER BY 
			T.DayOfWeek,
			T.StartTime;
END;
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_ScheduleCloner]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[TeacherScheduleMaster_ScheduleCloner]
(
      @TeacherId     INT
    , @SourceDate    DATE
    , @TargetDate    DATE       -- single date for cloning
    , @ActionUser    VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    -----------------------------------------
    -- CHECK: Source date must have schedule
    -----------------------------------------
    IF NOT EXISTS 
    (
        SELECT 1
        FROM [spe].[TeacherScheduleMaster]
        WHERE TeacherId = @TeacherId
          AND ScheduleDate = @SourceDate
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('No schedule found for this teacher on the source date.', 16, 1);
        RETURN;
    END;

    -----------------------------------------
    -- INSERT: Clone schedule to target date
    -----------------------------------------
    INSERT INTO [spe].[TeacherScheduleMaster]
    (
          SchoolId
        , ScheduleDate
        , TeacherId
        , ClassId
        , SectionId
        , SubjectId
        , ScheduleType
        , StartTime
        , Duration
        , EndTime
        , Mode
        , MeetingLink
        , Status
        , Description
        , DayOfWeek
        , OtherDetail1
        , OtherDetail2
        , OtherDetail3
        , OtherDetail4
        , OtherDetail5
        , OtherDetail6
        , IsActive
        , IsDeleted
        , CreatedBy
        , CreatedOn
    )
    SELECT
          SchoolId
        , @TargetDate
        , TeacherId
        , ClassId
        , SectionId
        , SubjectId
        , ScheduleType
        , StartTime
        , Duration
        , EndTime
        , Mode
        , MeetingLink
        , Status
        , Description
        , DayOfWeek
        , OtherDetail1
        , OtherDetail2
        , OtherDetail3
        , OtherDetail4
        , OtherDetail5
        , OtherDetail6
        , IsActive
        , 0                   -- IsDeleted
        , @ActionUser
        , GETDATE()
    FROM [spe].[TeacherScheduleMaster]
    WHERE TeacherId = @TeacherId
      AND ScheduleDate = @SourceDate
      AND IsDeleted = 0;

END;
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_Timetable]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[TeacherScheduleMaster_Timetable]
    @SchoolId   = 5,
    @TeacherId  = 1284,        -- or set value like 101
    @ClassId    = 20,        -- or set value like 8
    @SectionId  = 1,        -- or set value like 2
    @StartDate  = '2025-11-01',
    @EndDate    = '2025-11-30';


*/
CREATE PROCEDURE [spe].[TeacherScheduleMaster_Timetable]
(
    @SchoolId   INT,
    @TeacherId  INT = NULL,       
    @ClassId    INT = NULL,       
    @SectionId  INT = NULL,       
    @StartDate  DATE,
    @EndDate    DATE
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        A.ScheduleId,
        A.SchoolId,
        A.ScheduleDate,
        DATENAME(WEEKDAY, A.ScheduleDate) AS DayName,

        A.TeacherId,
        A.ClassId,
        A.SectionId,
        A.SubjectId,

        C.SubjectCode,
        C.SubjectName,

        A.ScheduleType,
        A.StartTime,
        A.EndTime,
        A.Duration,
        A.Mode,
        A.MeetingLink,
        A.Status,
        A.Description,
		A.DayOfWeek
    FROM spe.TeacherScheduleMaster A
    LEFT OUTER JOIN spe.TeacherClassSubjectMapping B
        ON  A.SchoolId  = B.SchoolId
        AND A.ClassId   = B.ClassId
        AND A.SectionId = B.SectionId
        AND A.SubjectId = B.SubjectId
        AND A.TeacherId = B.TeacherId
        AND B.IsActive = 1 AND B.IsDeleted = 0
    LEFT OUTER JOIN spe.SubjectMaster C
        ON  C.SubjectId = A.SubjectId
        AND C.SchoolId  = A.SchoolId
        AND C.ClassId   = A.ClassId
        AND C.IsActive = 1 AND C.IsDeleted = 0
    WHERE 
        A.SchoolId = @SchoolId
        AND A.IsActive = 1 
        AND A.IsDeleted = 0
        AND (@TeacherId IS NULL OR A.TeacherId = @TeacherId)
        AND (@ClassId   IS NULL OR A.ClassId = @ClassId)
        AND (@SectionId IS NULL OR A.SectionId = @SectionId)
        AND A.ScheduleDate BETWEEN @StartDate AND @EndDate
    ORDER BY 
        A.ScheduleDate, A.StartTime;

END;
GO
/****** Object:  StoredProcedure [spe].[TeacherScheduleMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[TeacherScheduleMaster_Update]
(
    @ScheduleId     INT,
    @SchoolId       INT,
    @ScheduleDate   DATETIME = NULL,
    @TeacherId      INT,
    @ClassId        INT,
    @SectionId      INT = NULL,
    @SubjectId      INT,
    @ScheduleType   VARCHAR(50)   = NULL,
    @StartTime      TIME(7),
    @Duration       INT,
    @EndTime        TIME(7),
    @Mode           VARCHAR(50),
    @MeetingLink    VARCHAR(250)  = NULL,
    @Status         VARCHAR(50)   = NULL,
    @Description    VARCHAR(500)  = NULL,
	@DayOfWeek      INT = NULL,
    @OtherDetail1   VARCHAR(50)   = NULL,
    @OtherDetail2   VARCHAR(50)   = NULL,
    @OtherDetail3   VARCHAR(100)  = NULL,
    @OtherDetail4   VARCHAR(100)  = NULL,
    @OtherDetail5   VARCHAR(500)  = NULL,
    @OtherDetail6   VARCHAR(500)  = NULL,
    @IsActive       INT           = 1,
    @ActionUser     VARCHAR(50)   = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[TeacherScheduleMaster]
    SET
        [SchoolId]      = @SchoolId,
        [ScheduleDate]  = @ScheduleDate,
        [TeacherId]     = @TeacherId,
        [ClassId]       = @ClassId,
        [SectionId]     = @SectionId,
        [SubjectId]     = @SubjectId,
        [ScheduleType]  = TRIM(@ScheduleType),
        [StartTime]     = @StartTime,
        [Duration]      = @Duration,
        [EndTime]       = @EndTime,
        [Mode]          = TRIM(@Mode),
        [MeetingLink]   = TRIM(@MeetingLink),
        [Status]        = TRIM(@Status),
        [Description]   = TRIM(@Description),
		[DayOfWeek]      = @DayOfWeek,
        [OtherDetail1]  = TRIM(@OtherDetail1),
        [OtherDetail2]  = TRIM(@OtherDetail2),
        [OtherDetail3]  = TRIM(@OtherDetail3),
        [OtherDetail4]  = TRIM(@OtherDetail4),
        [OtherDetail5]  = TRIM(@OtherDetail5),
        [OtherDetail6]  = TRIM(@OtherDetail6),
        [IsActive]      = @IsActive,
        [ModifiedBy]    = TRIM(@ActionUser),
        [ModifiedOn]    = GETDATE()
    WHERE [ScheduleId] = @ScheduleId

    SELECT 
        [ScheduleId],
        [SchoolId],
        [ScheduleDate],
        [TeacherId],
        [ClassId],
        [SectionId],
        [SubjectId],
        [ScheduleType],
        [StartTime],
        [Duration],
        [EndTime],
        [Mode],
        [MeetingLink],
        [Status],
        [Description],
		[DayOfWeek],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[TeacherScheduleMaster]
    WHERE [ScheduleId] = @ScheduleId
	      AND [IsDeleted] = 0
		  AND [IsActive] = 1;
END
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[UserAffiliationMapping_Create]
(
    @UserId           INT,
    @SchoolId         INT,
    @AffiliationType  VARCHAR(50),
    @Designation      VARCHAR(50),
    @Occupation       VARCHAR(100),
    @Income           DECIMAL(18,2),
    @IsPrimary        INT,
    @JoinedOn         DATETIME,
    @AssignedRoleId   INT,
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    -- Block Student creation if user is Parent / Teacher
  IF @AffiliationType = 'Student'
    AND EXISTS (
        SELECT 1
        FROM [spe].[UserAffiliationMapping]
        WHERE UserId = @UserId
          AND SchoolId = @SchoolId
          AND AffiliationType IN (
                'Parent',
                'School Admin',
                'Teaching Staff',
                'NonTeaching Staff',
                'School Staff',
                'Driver'
          )
          AND IsDeleted = 0
    )
BEGIN
    RAISERROR('This user already has a staff/admin/parent role. Student cannot be assigned.', 16, 1);
    RETURN;
END;


    -- Prevent duplicate affiliation for same user, same school

    IF EXISTS (
        SELECT 1
        FROM [spe].[UserAffiliationMapping]
        WHERE UserId = @UserId
          AND SchoolId = @SchoolId
          AND AffiliationType = @AffiliationType
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('This affiliation type is already assigned to this user for this school.', 16, 1);
        RETURN;
    END;


    DECLARE @MappingId INT;

    INSERT INTO [spe].[UserAffiliationMapping]
    (
        [UserId],
        [SchoolId],
        [AffiliationType],
        [Designation],
        [Occupation],
        [Income],
        [IsPrimary],
        [JoinedOn],
        [AssignedRoleId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @UserId,
        @SchoolId,
        @AffiliationType,
        @Designation,
        @Occupation,
        @Income,
        @IsPrimary,
        @JoinedOn,
        @AssignedRoleId,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,
        0,
        @ActionUser,
        GETDATE()
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT 
        [MappingId],
        [UserId],
        [SchoolId],
        [AffiliationType],
        [Designation],
        [Occupation],
        [Income],
        [IsPrimary],
        [JoinedOn],
        [AssignedRoleId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[UserAffiliationMapping]
    WHERE [MappingId] = @MappingId;
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[UserAffiliationMapping_CreateBulk]
(
    @MappingList [spe].[udt_UserAffiliationMapping] READONLY,
    @RoleId INT,
    @SchoolId INT,
    @AffiliationType VARCHAR(50),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    IF OBJECT_ID('tempdb..#TempUserDetail') IS NOT NULL 
        DROP TABLE #TempUserDetail;

    CREATE TABLE #TempUserDetail(
		TtId INT PRIMARY KEY IDENTITY(1,1) NOT NULL,
        FirstName VARCHAR(50) NULL,
        MiddleName VARCHAR(50) NULL,
        LastName VARCHAR(50) NULL,
        DOB DATETIME NULL,
        MobileNo VARCHAR(50) NULL,
        EmailId VARCHAR(50) NULL,
		Address VARCHAR(500) NULL,
        AadharNumber VARCHAR(20) NULL,
        PanNumber VARCHAR(20) NULL,
        Designation VARCHAR(50) NULL,
        Occupation VARCHAR(100) NULL,
        Income DECIMAL(18,2) NULL,
        JoinedOn DATETIME NULL,
        UserExists INT DEFAULT 0,
		UserId INT NOT NULL DEFAULT 0,
        ErrMsg VARCHAR(500),
        AffiliationExists INT  DEFAULT 0,
		AffiliationId INT,
		IsValid INT
    );


    INSERT INTO #TempUserDetail
    SELECT 
        FirstName, MiddleName, LastName, DOB, MobileNo, EmailId, Address,
        AadharNumber, PanNumber, Designation, Occupation, Income, JoinedOn,
        UserExists, UserId,ErrMsg, AffiliationExists,AffiliationId,IsValid
    FROM @MappingList;



	DECLARE @StartLoop INT = 0, @EndLoop INT = 0;

		SELECT @EndLoop = MAX(TTId) FROM #TempUserDetail;

		WHILE (@StartLoop < @EndLoop)
		BEGIN
			DECLARE @UserId int = 0

			SET @StartLoop = @StartLoop + 1;

			SELECT @UserId = ISNULL(UserId,0) FROM #TempUserDetail WHERE TtId = @StartLoop
			IF(ISNULL(@UserId,0) < 1)
		
			BEGIN
				DECLARE @NewUserId INT = 0;
			
				INSERT INTO dbo.UserMaster
				(
					FirstName,
					MiddleName,
					LastName,
					DOB,
					MobileNo,
					EmailId,
					Address,
					AadharNumber,
					PanNumber,
					CreatedBy,
					CreatedOn,
					IsActive,
					IsDeleted
				)
				SELECT 
					FirstName,
					MiddleName,
					LastName,
					DOB,
					MobileNo,
					EmailId,
					Address,
					AadharNumber,
					PanNumber,
					@ActionUser,
					GETDATE(),
					1,
					0
				FROM #TempUserDetail WHERE TtId = @StartLoop

				SET @NewUserId = SCOPE_IDENTITY();

				UPDATE #TempUserDetail 
				SET UserId = @NewUserId, UserExists = 1
				WHERE TtId = @StartLoop

				
				/*  ROLE ASSIGNMENT ADDED HERE (ONLY CHANGE) */

			INSERT INTO dbo.UserRoles
			(
				RoleId,
				UserId,
				IsActive,
				IsDeleted,
				CreatedBy,
				CreatedOn
			)
			VALUES
			(
				@RoleId,
				@NewUserId,
				1,
				0,
				@ActionUser,
				GETDATE()
			);
			/* ----------------------------------------- */


			END
		END

		

		SELECT @StartLoop = 0;
		SELECT @EndLoop = MAX(TTId) FROM #TempUserDetail;
		WHILE (@StartLoop < @EndLoop)
		BEGIN
			SET @StartLoop = @StartLoop + 1;

			DECLARE @UserExists INT = 0, @AffiliationExists INT = 0
			SELECT 
				@AffiliationExists = AffiliationExists,
				@UserExists = UserExists
			FROM #TempUserDetail WHERE TtId = @StartLoop

			IF(@AffiliationExists = 0 AND @UserExists = 1 )
			BEGIN
				DECLARE @NewAffiliationId INT = 0
				INSERT INTO [spe].[UserAffiliationMapping]
				(
					[UserId],
					[SchoolId],
					[AffiliationType],
					[Designation],
					[Occupation],
					[Income],
					[IsPrimary],
					[JoinedOn],
					[AssignedRoleId],
					[OtherDetail1],
					[OtherDetail2],
					[OtherDetail3],
					[OtherDetail4],
					[OtherDetail5],
					[OtherDetail6],
					[IsActive],
					[IsDeleted],
					[CreatedBy],
					[CreatedOn]
				)
				SELECT 
					UserId,
					@SchoolId,
					@AffiliationType,
					TRIM(Designation),
					TRIM(Occupation),
					Income,
					1,
					JoinedOn,
					@RoleId,
					NULL, NULL, NULL, NULL, NULL, NULL,
					1,
					0,
					@ActionUser,
					GETDATE()
				FROM #TempUserDetail WHERE TtId = @StartLoop


				SET @NewAffiliationId  = SCOPE_IDENTITY()

				UPDATE #TempUserDetail 
				SET 
					AffiliationId = @NewAffiliationId, AffiliationExists = 1
				WHERE TtId = @StartLoop

			END
		END
    

		-- Step 3: Return newly inserted affiliation records
		SELECT * FROM #TempUserDetail
			
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_CreateStudentBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [spe].[UserAffiliationMapping_CreateStudentBulk]
(
    @MappingList [spe].[udt_UserAffiliationStudentMapping] READONLY,
    @RoleId INT,
    @SchoolId INT,
	@ClassId INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	DECLARE @AffiliationType VARCHAR(200) = 'Student'


    IF OBJECT_ID('tempdb..#TempStudentDetail') IS NOT NULL 
        DROP TABLE #TempStudentDetail;

    CREATE TABLE #TempStudentDetail(
		TtId INT PRIMARY KEY IDENTITY(1,1) NOT NULL,
        [FirstName] [varchar](50) NULL,
		[MiddleName] [varchar](50) NULL,
		[LastName] [varchar](50) NULL,
		[DOB] [datetime] NULL,
		[EmailId] [varchar](50) NULL,
	    [Address] [VARCHAR](500) NULL,
		[AdmissionNo] [varchar](50) NULL,
		[AdmissionType] [varchar](50) NULL,
		[PreviousSchoolName] [varchar](200) NULL,
		[AdmissionDate] [datetime] NULL,
		[AcademicYear] [varchar](50) NULL,
		[GuardianContactNo] [varchar](20) NULL,
		[GuardianName] [VARCHAR] (100) NULL,
		[UserExists] [int] NULL,
		[UserId] [int] NULL,
		[ErrMsg] [varchar](500) NULL,
		[AffiliationExists] [int] NULL,
		[AffiliationId] [int] NULL,
		[RegistrationExists] [int] NULL,
		[RegistrationId] [int] NULL,
		[ClassMappingExists] [int] NULL,
		[ClassMappingId] [int] NULL,
		[IsValid] [int] NULL
    );


    INSERT INTO #TempStudentDetail
    SELECT 
        FirstName, MiddleName, LastName, DOB, EmailId,Address, AdmissionNo, AdmissionType, PreviousSchoolName, AdmissionDate, AcademicYear, GuardianContactNo, GuardianName,
		UserExists,UserId,ErrMsg,AffiliationExists,AffiliationId,RegistrationExists,RegistrationId,ClassMappingExists,ClassMappingId,IsValid    
	FROM @MappingList;



	DECLARE @StartLoop INT = 0, @EndLoop INT = 0;

		SELECT @EndLoop = MAX(TTId) FROM #TempStudentDetail;

		WHILE (@StartLoop < @EndLoop)
		BEGIN
			DECLARE @UserId int = 0

			SET @StartLoop = @StartLoop + 1;

			SELECT 
			@UserId = ISNULL(UserId,0) 
			FROM #TempStudentDetail WHERE TtId = @StartLoop

			IF(ISNULL(@UserId,0) < 1)
		
			BEGIN
				DECLARE @NewUserId INT = 0;
			
				INSERT INTO dbo.UserMaster
				(
					FirstName,
					MiddleName,
					LastName,
					DOB,
					Address,
					EmailId,
					CreatedBy,
					CreatedOn,
					IsActive,
					IsDeleted
				)
				SELECT 
					FirstName,
					MiddleName,
					LastName,
					DOB,
					Address,
					EmailId,
					@ActionUser,
					GETDATE(),
					1,
					0
				FROM #TempStudentDetail WHERE TtId = @StartLoop

				SET @NewUserId = SCOPE_IDENTITY();

				UPDATE #TempStudentDetail 
				SET UserId = @NewUserId, UserExists = 1
				WHERE TtId = @StartLoop
				
				/* ---- ROLE ASSIGNMENT (ONLY NEW CODE) ---- */
				INSERT INTO dbo.UserRoles
				(
					RoleId,
					UserId,
					IsActive,
					IsDeleted,
					CreatedBy,
					CreatedOn
				)
				VALUES
				(
					@RoleId,
					@NewUserId,
					1,
					0,
					@ActionUser,
					GETDATE()
				);

			END
			
		END

		SELECT @StartLoop = 0;
		SELECT @EndLoop = MAX(TTId) FROM #TempStudentDetail;
		WHILE (@StartLoop < @EndLoop)
		BEGIN
			SET @StartLoop = @StartLoop + 1;

			DECLARE @UserExists INT = 0, @AffiliationExists INT = 0, @RegistrationExists INT = 0, @ClassMappingExists INT = 0
			SELECT 
				@AffiliationExists = AffiliationExists,
				@UserExists = UserExists,
				@RegistrationExists = RegistrationExists,
				@ClassMappingExists = ClassMappingExists
			FROM #TempStudentDetail WHERE TtId = @StartLoop


			IF(@AffiliationExists = 0 AND @UserExists = 1 )
			BEGIN
				DECLARE @NewAffiliationId INT = 0
				INSERT INTO [spe].[UserAffiliationMapping]
				(
					[UserId],
					[SchoolId],
					[AffiliationType],
					[IsPrimary],
					[AssignedRoleId],
					[IsActive],
					[IsDeleted],
					[CreatedBy],
					[CreatedOn]
				)
				SELECT 
					UserId,
					@SchoolId,
					@AffiliationType,
					1,
					@RoleId,
					1,
					0,
					@ActionUser,
					GETDATE()
				FROM #TempStudentDetail WHERE TtId = @StartLoop


				SET @NewAffiliationId  = SCOPE_IDENTITY()

				UPDATE #TempStudentDetail 
				SET 
					AffiliationId = @NewAffiliationId, AffiliationExists = 1
				WHERE TtId = @StartLoop

			END

			IF(@RegistrationExists = 0 AND @UserExists = 1 )
			BEGIN
				DECLARE @NewRegistrationId INT = 0


				INSERT INTO spe.StudentRegistration 
				( SchoolId, UserId, AdmissionNo, AdmissionType, PreviousSchoolName, AdmissionDate, AcademicYear , GuardianName, GuardianContactNo )
				SELECT 
				@SchoolId, UserId,AdmissionNo,AdmissionType, PreviousSchoolName, AdmissionDate, AcademicYear, GuardianName, GuardianContactNo
				FROM #TempStudentDetail WHERE TtId = @StartLoop

				SET @NewRegistrationId  = SCOPE_IDENTITY()

				UPDATE #TempStudentDetail 
				SET 
					AffiliationId = @NewRegistrationId, AffiliationExists = 1
				WHERE TtId = @StartLoop
			END
			
			IF(@ClassMappingExists = 0 AND @UserExists = 1 )
			BEGIN
				DECLARE @NewClassMappingId INT = 0

				INSERT INTO SPE.StudentClassMapping
				(UserId, ClassId, SectionId, AcademicYear)
				SELECT
				UserId, @ClassId,0,AcademicYear
				FROM #TempStudentDetail WHERE TtId = @StartLoop


				SET @NewClassMappingId  = SCOPE_IDENTITY()

				UPDATE #TempStudentDetail 
				SET 
					ClassMappingId = @NewClassMappingId, AffiliationExists = 1
				WHERE TtId = @StartLoop
			END
		END
    

		-- Step 3: Return newly inserted affiliation records
		SELECT * FROM #TempStudentDetail
			
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[UserAffiliationMapping_Delete]
(
    @MappingId int,
	@ActionUser varchar(50)
)
AS 
BEGIN 
	SET NOCOUNT ON;
	UPDATE [spe].[UserAffiliationMapping]
	SET 
		[IsActive] = 0 ,
		[IsDeleted] = 1,
		[ModifiedBy] =@ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [MappingId]  =@MappingId
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[UserAffiliationMapping_ReadAll]
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[SchoolId]
      ,[AffiliationType]
      ,[Designation]
	  ,[Occupation]
	  ,[Income]
      ,[IsPrimary]
      ,[joinedOn]
	  ,[AssignedRoleId]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[UserAffiliationMapping]
	  WHERE [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[UserAffiliationMapping_ReadById]
(
    @MappingId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       [MappingId]
      ,[UserId]
      ,[SchoolId]
      ,[AffiliationType]
      ,[Designation]
	  ,[Occupation]
	  ,[Income]
      ,[IsPrimary]
      ,[joinedOn]
	  ,[AssignedRoleId]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[UserAffiliationMapping]
	  WHERE [MappingId]  =@MappingId
	  AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [spe].[UserAffiliationMapping_ReadBySchoolId]
(
    @SchoolId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       A.[MappingId]
      ,A.[UserId]
      ,A.[SchoolId]
      ,A.[AffiliationType]
      ,A.[Designation]
	  ,A.[Occupation]
	  ,A.[Income]
      ,A.[IsPrimary]
      ,A.[JoinedOn]
	  ,A.[AssignedRoleId]
	  ,B.[Address]
      ,B.[Country]
      ,B.[State]
      ,B.[City]
      ,B.[BloodGroup]
      ,B.[Gender]
      ,B.[AadharNumber]
      ,B.[PanNumber]
      ,B.[Nationality]
      ,B.[Religion]
      ,B.[Caste]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[UserAffiliationMapping]A
	  LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]B
	  ON A.[UserId] = B.[UserId]
	  WHERE [SchoolId]  = @SchoolId
	  AND A.[IsActive] = 1
	  AND A.[IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_ReadByUserId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[UserAffiliationMapping_ReadByUserId]
(
    @UserId int
)
AS 
BEGIN 
   SET NOCOUNT ON;
 SELECT 
       A.[MappingId]
      ,A.[UserId]
	  ,B. [FirstName]
	  ,B.[MiddleName]
	  ,B.[LastName]
	  ,B.[DOB]
	  ,B.[MobileNo]
	  ,B.[EmailId]
	  ,B.[Designation]
	  ,B.[ProfileImage]
      ,B.[Gender]
      ,B.[AadharNumber]
      ,B.[PanNumber]
      ,B.[PinCode]
      ,A.[SchoolId]
      ,A.[AffiliationType]
      ,A.[Designation]
	  ,A.[Occupation]
	  ,A.[Income]
      ,A.[IsPrimary]
      ,A.[JoinedOn]
	  ,A.[AssignedRoleId]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[UserAffiliationMapping] A
	  LEFT OUTER JOIN dbo.UserMaster B
	  ON A.UserId = B.UserId
	  WHERE A. [UserId]  =@UserId
	  AND  A.[IsActive] = 1;

END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_ReadUserBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[UserAffiliationMapping_ReadUserBySchoolId] 
    @SchoolId = 5, 
    @AffiliationType = '', 
    @PageSize = 10, 
    @PageNo = 1, 
    @OrderByClause = NULL, 
    @WhereClause = NULL;
*/
CREATE   PROCEDURE [spe].[UserAffiliationMapping_ReadUserBySchoolId]
(
  @SchoolId INT,
  @AffiliationType VARCHAR(50)= NULL,
  @PageSize INT,
  @PageNo INT,
  @OrderByClause NVARCHAR(MAX) = NULL,
  @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
	SET NOCOUNT ON; 
	DECLARE @Result INT = 0, @TotalCount INT = 0;
	SET @Result = (@PageNo - 1) * @PageSize;
	SET NOCOUNT ON;

	DECLARE @SQL NVARCHAR(MAX);
	SET @SQL ='
	SELECT
	ROW_NUMBER() OVER (ORDER BY ' + 
	ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'A.CreatedOn DESC') + 
	') AS RowNum,
		 B.[FirstName]
		,B.[MiddleName]
		,B.[LastName]
		,B.[DOB]
		,B.[MobileNo]
		,B.[EmailId]
		,ISNULL(B.[ProfileImage],'''') ProfileImage
		,A.[MappingId]
		,A.[UserId]
		,A.[SchoolId]
		,A.[AffiliationType]
		,A.[Designation]
		,A.[Occupation]
		,A.[Income]
		,A.[IsPrimary]
		,A.[JoinedOn]
	    ,B.[Address]
        ,B.[Country]
        ,B.[State]
        ,B.[City]
        ,B.[BloodGroup]
        ,B.[Gender]
        ,B.[AadharNumber]
        ,B.[PanNumber]
        ,B.[Nationality]
        ,B.[Religion]
        ,B.[Caste]
		,A.[OtherDetail1]
		,A.[OtherDetail2]
		,A.[OtherDetail3]
		,A.[OtherDetail4]
		,A.[OtherDetail5]
		,A.[OtherDetail6]
		,A.[IsActive]
		,A.[IsDeleted]
		,A.[CreatedBy]
		,A.[CreatedOn]
		,A.[ModifiedBy]
		,A.[ModifiedOn],
		C.[LoginId],
		C.[UserName],
		C.[UserPassword],
		D.[UserRoleId],
		D.[RoleId],
		COUNT(*) OVER () AS TotalCount,
		' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
		' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
	FROM [spe].[UserAffiliationMapping]A
	LEFT OUTER JOIN [Nishwik].[dbo].[UserMaster]B
	ON A.[UserId] = B.[UserId]
		AND B.IsActive = 1
		AND B.IsDeleted = 0
	LEFT OUTER JOIN [Nishwik].[dbo].[UserLogin]C
	ON A.[UserId] = C.[UserId]
	LEFT OUTER JOIN [Nishwik].[dbo].[UserRoles]D
	ON A.[UserId] = D.[UserId]
	    AND D.RoleId = A.AssignedRoleId
		AND D.IsActive = 1
		AND D.IsDeleted = 0
	WHERE A.[SchoolId] = ' + CAST(@SchoolId AS NVARCHAR) + '
    AND A.[AffiliationType] = ''' + @AffiliationType + ''' 
	AND A.[IsActive] = 1
	AND A.[IsDeleted] = 0
	AND B.[IsActive] = 1
	AND B.[IsDeleted] = 0';

	IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
		SET @SQL = @SQL + ' AND ' + @WhereClause;

	IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
		SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
	ELSE
		SET @SQL = @SQL + ' ORDER BY A.CreatedOn DESC';

	SET @SQL = @SQL + '
	OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
	FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

	EXEC sp_executesql @SQL;	
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [spe].[UserAffiliationMapping_Update]
(
    @MappingId        INT,
    @UserId           INT,
    @SchoolId       INT,
    @AffiliationType  VARCHAR(50),
    @Designation      VARCHAR(50),
	@Occupation       VARCHAR(100),
	@Income           DECIMAL(18,2),
    @IsPrimary        INT,
    @JoinedOn         DATETIME,
	@AssignedRoleId  INT,
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[UserAffiliationMapping]
    SET
        [UserId]         = @UserId,
        [SchoolId]     = @SchoolId,
        [AffiliationType]= @AffiliationType,
        [Designation]    = @Designation,
		[Occupation]     = @Occupation,
		[Income]          =@Income,
        [IsPrimary]      = @IsPrimary,
        [JoinedOn]       = @JoinedOn,
		[AssignedRoleId]  = @AssignedRoleId,
        [OtherDetail1]   = @OtherDetail1,
        [OtherDetail2]   = @OtherDetail2,
        [OtherDetail3]   = @OtherDetail3,
        [OtherDetail4]   = @OtherDetail4,
        [OtherDetail5]   = @OtherDetail5,
        [OtherDetail6]   = @OtherDetail6,
        [IsActive]       = @IsActive,
        [ModifiedBy]     = @ActionUser,
        [ModifiedOn]     = GETDATE()
    WHERE [MappingId] = @MappingId ;

    SELECT 
        [MappingId],
        [UserId],
        [SchoolId],
        [AffiliationType],
        [Designation],
		[Designation],
	    [Occupation],
        [IsPrimary],
        [JoinedOn],
		[AssignedRoleId],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[UserAffiliationMapping]
    WHERE [MappingId] = @MappingId
	AND [IsActive] = 1;
END;
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_ValidateCreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [spe].[UserAffiliationMapping_ValidateCreateBulk]
(
    @MappingList [spe].[udt_UserAffiliationMapping] READONLY,
    @RoleId INT,
    @SchoolId INT,
    @AffiliationType VARCHAR(50),
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    IF OBJECT_ID('tempdb..#TempUserDetail') IS NOT NULL 
        DROP TABLE #TempUserDetail;

    CREATE TABLE #TempUserDetail(
		TtId INT PRIMARY KEY IDENTITY(1,1) NOT NULL,
        FirstName VARCHAR(50) NULL,
        MiddleName VARCHAR(50) NULL,
        LastName VARCHAR(50) NULL,
        DOB DATETIME NULL,
        MobileNo VARCHAR(50) NULL,
        EmailId VARCHAR(50) NULL,
		Address VARCHAR(500) NULL,
        AadharNumber VARCHAR(20) NULL,
        PanNumber VARCHAR(20) NULL,
        Designation VARCHAR(50) NULL,
        Occupation VARCHAR(100) NULL,
        Income DECIMAL(18,2) NULL,
        JoinedOn DATETIME NULL,
        UserExists INT DEFAULT 0,
		UserId INT NOT NULL DEFAULT 0,
        ErrMsg VARCHAR(500),
        AffiliationExists INT  DEFAULT 0,
		AffiliationId INT,
		IsValid INT
    );

    INSERT INTO #TempUserDetail
    SELECT 
        FirstName, MiddleName, LastName, DOB, MobileNo, EmailId, Address,
        AadharNumber, PanNumber, Designation, Occupation, Income, JoinedOn, 
        0, 0,'', 0,0,0
    FROM @MappingList;

    UPDATE t
    SET
        UserExists = CASE WHEN um.UserId IS NOT NULL THEN 1 ELSE 0 END,
		UserId = ISNULL(um.UserId,0), 
        AffiliationExists = CASE WHEN ua.MappingId IS NOT NULL THEN 1 ELSE 0 END,
		AffiliationId = ISNULL(ua.MappingId,0),
        ErrMsg = CASE 
                    WHEN um.UserId IS NULL THEN 'User not found in system'
                    WHEN ua.MappingId IS NOT NULL THEN 'User already affiliated with this school'
                    ELSE ''
                 END
    FROM #TempUserDetail t
    LEFT JOIN (
        SELECT UserId, AadharNumber, PanNumber
        FROM [dbo].[UserMaster]
        WHERE ISNULL(AadharNumber, '') <> '' OR ISNULL(PanNumber, '') <> ''
    ) um
        ON (t.AadharNumber IS NOT NULL AND t.AadharNumber = um.AadharNumber)
        OR (t.AadharNumber IS NULL AND t.PanNumber IS NOT NULL AND t.PanNumber = um.PanNumber)
    LEFT JOIN (
        SELECT UserId, SchoolId, MappingId, AffiliationType
        FROM [spe].[UserAffiliationMapping]
        WHERE SchoolId = @SchoolId AND AffiliationType = @AffiliationType
    ) ua
        ON um.UserId = ua.UserId;



	--SELECT 
	--	A.TtId,A.FirstName, A.MiddleName, A.LastName, A.DOB, A.MobileNo, A.EmailId, A.UserExists, A.AffiliationExists,
	--	A.AadharNumber, B.AadharNumber, A.PAN, B.PanNumber, 
	--	CASE 
	--					WHEN A.AadharNumber = B.AadharNumber OR A.PAN = B.PanNumber THEN 0
	--					WHEN (A.UserExists = 0 AND A.AffiliationExists = 0) OR (A.UserExists = 1 AND A.AffiliationExists = 0) THEN 1
	--					ELSE 0
	--				END AS IsValid,
	--	LTRIM(
	--		RTRIM(
	--			CONCAT(
	--				CASE WHEN A.AadharNumber = B.AadharNumber THEN 'Duplicate Aadhar' ELSE '' END,
	--				CASE WHEN A.PAN = B.PanNumber 
	--						THEN CASE WHEN A.AadharNumber = B.AadharNumber THEN ', Duplicate PAN Number' ELSE 'Duplicate PAN Number' END
	--						ELSE ''
	--				END
	--			)
	--		)
	--	) AS ErrMsg
	--FROM #TempUserDetail A
	--LEFT OUTER JOIN [dbo].[UserMaster] B
	--ON ((A.AadharNumber IS NOT NULL AND A.AadharNumber = B.AadharNumber) OR (A.PAN IS NOT NULL AND A.PAN = B.PanNumber))

	
	UPDATE TD
	SET TD.IsValid = TD2.IsValid, TD.ErrMsg = TD2.ErrMsg
	FROM #TempUserDetail TD
	LEFT JOIN
	(
		SELECT 
			A.TtId,A.FirstName, A.MiddleName, A.LastName, A.DOB, A.MobileNo, A.EmailId,A.Address, A.UserExists, A.AffiliationExists,
			A.AadharNumber, A.PanNumber AS UserPanNumber, B.PanNumber AS MasterPanNumber, 
			CASE 
							WHEN A.AadharNumber = B.AadharNumber OR A.PanNumber = B.PanNumber THEN 0
							WHEN (A.UserExists = 0 AND A.AffiliationExists = 0) OR (A.UserExists = 1 AND A.AffiliationExists = 0) THEN 1
							ELSE 0
						END AS IsValid,
			LTRIM(
				RTRIM(
					CONCAT(
						CASE WHEN A.AadharNumber = B.AadharNumber THEN 'Duplicate Aadhar' ELSE '' END,
						CASE WHEN A.PanNumber = B.PanNumber 
							 THEN CASE WHEN A.AadharNumber = B.AadharNumber THEN ', Duplicate PAN Number' ELSE 'Duplicate PAN Number' END
							 ELSE ''
						END
					)
				)
			) AS ErrMsg
		FROM #TempUserDetail A
		LEFT OUTER JOIN [dbo].[UserMaster] B
		ON ((A.AadharNumber IS NOT NULL AND A.AadharNumber = B.AadharNumber) OR (A.PanNumber IS NOT NULL AND A.PanNumber = B.PanNumber))
	) TD2
	ON TD.TtId = TD2.TtId

	---------------------------------------------------------------------------------------------------
-- Conditional Duplicate Check Logic Based on Affiliation Type
---------------------------------------------------------------------------------------------------
IF (@AffiliationType = 'Student')
BEGIN
    --  For Students  check only duplicate EmailId
    UPDATE TD
    SET 
        IsValid = CASE 
                    WHEN B.EmailId = TD.EmailId THEN 0
                    WHEN (TD.UserExists = 0 AND TD.AffiliationExists = 0) 
                         OR (TD.UserExists = 1 AND TD.AffiliationExists = 0) THEN 1
                    ELSE 0
                  END,
        ErrMsg = CASE 
                    WHEN B.EmailId = TD.EmailId THEN 'Duplicate Email ID found'
                    ELSE TD.ErrMsg
                 END
    FROM #TempUserDetail TD
    LEFT JOIN [dbo].[UserMaster] B 
        ON TD.EmailId = B.EmailId;
END

ELSE IF (@AffiliationType IN ('Parent', 'Teaching Staff'))
BEGIN
    --  For Parent / Teaching Staff  check duplicate Email, Aadhar, PAN
    UPDATE TD
    SET 
        IsValid = CASE 
                    WHEN (TD.AadharNumber = U.AadharNumber 
                          OR TD.PanNumber = U.PanNumber 
                          OR TD.EmailId = U.EmailId) THEN 0
                    WHEN (TD.UserExists = 0 AND TD.AffiliationExists = 0) 
                         OR (TD.UserExists = 1 AND TD.AffiliationExists = 0) THEN 1
                    ELSE 0
                  END,
        ErrMsg = LTRIM(RTRIM(CONCAT(
                    CASE WHEN TD.AadharNumber = U.AadharNumber THEN 'Duplicate Aadhar' ELSE '' END,
                    CASE WHEN TD.PanNumber = U.PanNumber 
                         THEN CASE WHEN TD.AadharNumber = U.AadharNumber THEN ', Duplicate PAN' ELSE 'Duplicate PAN' END 
                         ELSE '' END,
                    CASE WHEN TD.EmailId = U.EmailId 
                         THEN CASE WHEN (TD.AadharNumber = U.AadharNumber OR TD.PanNumber = U.PanNumber) 
                                   THEN ', Duplicate Email ID' ELSE 'Duplicate Email ID' END 
                         ELSE '' END
                 )))

    FROM #TempUserDetail TD
    LEFT JOIN [dbo].[UserMaster] U
        ON (TD.AadharNumber = U.AadharNumber 
            OR TD.PanNumber = U.PanNumber
            OR TD.EmailId = U.EmailId);
END

ELSE
BEGIN
    --  For Other Affiliation Types  mark all valid
    UPDATE #TempUserDetail
    SET IsValid = 1
    WHERE IsValid = 0;
END

	


	

    SELECT 
		FirstName,
		MiddleName,
		LastName,
		DOB,
		MobileNo,
		EmailId,
		Address,
		AadharNumber,
		PanNumber,
		Designation,
		Occupation,
		Income,
		JoinedOn,
		UserExists,
		UserId,
		ErrMsg,
		AffiliationExists,
		AffiliationId,
		IsValid
	FROM #TempUserDetail;
END
GO
/****** Object:  StoredProcedure [spe].[UserAffiliationMapping_ValidateStudentBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[UserAffiliationMapping_ValidateStudentBulk]
(
    @MappingList [spe].[udt_UserAffiliationStudentMapping] READONLY,
    @RoleId INT,
    @SchoolId INT,
	@ClassId INT,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	DECLARE @AffiliationType VARCHAR(200) = 'Student'

    IF OBJECT_ID('tempdb..#TempStudentDetail') IS NOT NULL 
        DROP TABLE #TempStudentDetail;

    CREATE TABLE #TempStudentDetail(
		TtId INT PRIMARY KEY IDENTITY(1,1) NOT NULL,
        [FirstName] [varchar](50) NULL,
		[MiddleName] [varchar](50) NULL,
		[LastName] [varchar](50) NULL,
		[DOB] [datetime] NULL,
		[EmailId] [varchar](50) NULL,
		[Address] [VARCHAR](500) NULL,
		[AdmissionNo] [varchar](50) NULL,
		[AdmissionType] [varchar](50) NULL,
		[PreviousSchoolName] [varchar](200) NULL,
		[AdmissionDate] [datetime] NULL,
		[AcademicYear] [varchar](50) NULL,
		[GuardianContactNo] [varchar](20) NULL,
		[GuardianName] [VARCHAR] (100) NULL,
		[UserExists] [int] NULL,
		[UserId] [int] NULL,
		[ErrMsg] [varchar](500) NULL,
		[AffiliationExists] [int] NULL,
		[AffiliationId] [int] NULL,
		[RegistrationExists] [int] NULL,
		[RegistrationId] [int] NULL,
		[ClassMappingExists] [int] NULL,
		[ClassMappingId] [int] NULL,
		[IsValid] [int] NULL
    );

    INSERT INTO #TempStudentDetail
    SELECT 
        FirstName, MiddleName, LastName, DOB, EmailId,Address, AdmissionNo, AdmissionType, PreviousSchoolName, AdmissionDate, AcademicYear, GuardianContactNo, GuardianName,
        0, 0,'', 0,0,0,0,0,0,0
    FROM @MappingList;




	UPDATE t
	SET
		t.UserExists = CASE 
							WHEN um.UserId IS NOT NULL THEN 1 
							ELSE 0 
						END,
		t.UserId =		CASE 
							WHEN um.UserId IS NOT NULL AND t.FirstName = um.FirstName AND t.LastName = um.LastName  THEN um.UserId 
							ELSE 0 
						END,

		t.ErrMsg = CASE	
						WHEN um.UserId IS NULL AND t.EmailId = um.EmailId THEN 'User Already Exists Mappings Will Be Created'
						WHEN um.UserId IS NOT NULL AND t.EmailId = um.EmailId  THEN 'Email Id Is In Use, Please User Different Email.'
					END,
		t.IsValid = CASE	
						WHEN um.UserId IS NOT NULL AND t.FirstName = um.FirstName AND t.LastName = um.LastName AND CONVERT(DATE, t.DOB, 103) = CONVERT(DATE, um.DOB, 103) THEN 1
						WHEN um.UserId IS NOT NULL AND (t.FirstName <> um.FirstName AND t.LastName <> um.LastName AND CONVERT(DATE, t.DOB, 103) <> CONVERT(DATE, um.DOB, 103)) THEN 0
						ELSE 1
					END
	FROM #TempStudentDetail t
	LEFT JOIN (
		SELECT 
			UserId, FirstName, LastName, DOB, EmailId
		FROM [dbo].[UserMaster] WHERE IsActive = 1 AND IsDeleted = 0
	) um
		ON (t.EmailId IS NOT NULL AND t.EmailId = um.EmailId )

	


    UPDATE t
	SET
		t.AffiliationExists =	CASE 
									WHEN ISNULL(t.UserId, 0) = 0 THEN 0                                       -- user not found, cannot have affiliation
									WHEN ua.MappingId IS NOT NULL THEN 1                                      -- user is already affiliated
									ELSE 0                                                                    -- user found but not affiliated yet
								END,
		t.AffiliationId = CASE 
								WHEN ISNULL(t.UserId, 0) = 0 THEN 0                                       -- user not found, cannot have affiliation
								ELSE t.AffiliationId                                                                    -- user found but not affiliated yet
							END,

		t.RegistrationExists =  CASE 
									WHEN ISNULL(t.UserId, 0) = 0 THEN 0                                       -- user not found, cannot have affiliation
									WHEN ur.RegistrationId IS NOT NULL THEN 1                                      -- user is already affiliated
									ELSE 0                                                                    -- user found but not affiliated yet
								END,
		
		t.RegistrationId =  CASE 
								WHEN ISNULL(t.UserId, 0) = 0 THEN 0                                       -- user not found, cannot have affiliation
								ELSE ISNULL(ur.RegistrationId, 0)                                                                  -- user found but not affiliated yet
							END,

		t.ClassMappingExists = CASE 
									WHEN ISNULL(t.UserId, 0) = 0 THEN 0                                       -- user not found, cannot have affiliation
									WHEN scm.MappingId IS NOT NULL THEN 1                                      -- user is already affiliated
									ELSE 0                                                                    -- user found but not affiliated yet
								END,
		t.ClassMappingId =  CASE 
									WHEN ISNULL(t.UserId, 0) = 0 THEN 0                                       -- user not found, cannot have affiliation
									WHEN ur.RegistrationId IS NOT NULL THEN 1                                      -- user is already affiliated
									ELSE ISNULL(scm.MappingId,0)                                                                    -- user found but not affiliated yet
								END
	FROM #TempStudentDetail t
	LEFT JOIN (
		SELECT UserId, SchoolId, MappingId, AffiliationType
		FROM [spe].[UserAffiliationMapping]
		WHERE SchoolId = @SchoolId AND AffiliationType = 'Student' AND IsActive = 1 AND IsDeleted = 0
	) ua
		ON t.UserId = ua.UserId
	LEFT JOIN (
		SELECT UserId, SchoolId, RegistrationId
		FROM [spe].[StudentRegistration] 
		WHERE SchoolId = @SchoolId AND IsActive = 1 AND IsDeleted = 0
	) ur 
		ON t.UserId = ur.UserId
	LEFT JOIN (
		SELECT UserId, ClassId, MappingId
		FROM [spe].[StudentClassMapping] 
		WHERE ClassId = @ClassId AND IsActive = 1 AND IsDeleted = 0
	) scm 
		ON t.UserId = scm.UserId;

    SELECT * FROM #TempStudentDetail;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleDriverAssignment_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleDriverAssignment_Create]
(
    @VehicleId       INT,
    @DriverId        INT,
    @RouteId         INT,
    @StartDate       DATETIME,
    @EndDate         DATETIME,
    @IsPrimaryDriver INT,
    @Shift           VARCHAR(50),
    @OtherDetail1    VARCHAR(50),
    @OtherDetail2    VARCHAR(50),
    @OtherDetail3    VARCHAR(100),
    @OtherDetail4    VARCHAR(100),
    @OtherDetail5    VARCHAR(500),
    @OtherDetail6    VARCHAR(500),
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1
        FROM [spe].[VehicleDriverAssignment]
        WHERE  DriverId  = @DriverId
          AND RouteId   = @RouteId
          AND IsActive  = 1
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('This vehicle is already assigned to the same driver and route.', 16, 1);
        RETURN;
    END

    DECLARE @AssignmentId INT;

    INSERT INTO [spe].[VehicleDriverAssignment]
    (
        [VehicleId],
        [DriverId],
        [RouteId],
        [StartDate],
        [EndDate],
        [IsPrimaryDriver],
        [Shift],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @VehicleId,
        @DriverId,
        @RouteId,
        @StartDate,
        @EndDate,
        @IsPrimaryDriver,
        TRIM(@Shift),
        TRIM(@OtherDetail1),
        TRIM(@OtherDetail2),
        TRIM(@OtherDetail3),
        TRIM(@OtherDetail4),
        TRIM(@OtherDetail5),
        TRIM(@OtherDetail6),
        1,                         
        0,                         
        TRIM(@ActionUser),
        GETDATE()
    );

    SET @AssignmentId = SCOPE_IDENTITY();

    SELECT 
        [AssignmentId],
        [VehicleId],
        [DriverId],
        [RouteId],
        [StartDate],
        [EndDate],
        [IsPrimaryDriver],
        [Shift],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[VehicleDriverAssignment]
    WHERE [AssignmentId] = @AssignmentId;
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleDriverAssignment_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleDriverAssignment_Delete]
(
   @AssignmentId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
		SET NOCOUNT ON;
		UPDATE [spe].[VehicleDriverAssignment]
		SET
			[IsActive] = 0,
			[IsDeleted] = 1,
			[ModifiedBy] = @ActionUser,
			[ModifiedOn] = GETDATE()
		WHERE [AssignmentId] = @AssignmentId
END
GO
/****** Object:  StoredProcedure [spe].[VehicleDriverAssignment_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleDriverAssignment_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AssignmentId]
      ,[VehicleId]
      ,[DriverId]
      ,[RouteId]
      ,[StartDate]
      ,[EndDate]
      ,[IsPrimaryDriver]
      ,[Shift]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[VehicleDriverAssignment]
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleDriverAssignment_ReadByDriverId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleDriverAssignment_ReadByDriverId]
(
   @DriverId INT
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AssignmentId]
      ,[VehicleId]
      ,[DriverId]
      ,[RouteId]
      ,[StartDate]
      ,[EndDate]
      ,[IsPrimaryDriver]
      ,[Shift]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[VehicleDriverAssignment]
	  WHERE [DriverId] = @DriverId
	  AND  [IsActive] = 1
	  AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleDriverAssignment_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleDriverAssignment_ReadById]
(
   @AssignmentId INT
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AssignmentId]
      ,[VehicleId]
      ,[DriverId]
      ,[RouteId]
      ,[StartDate]
      ,[EndDate]
      ,[IsPrimaryDriver]
      ,[Shift]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[VehicleDriverAssignment]
	  WHERE [AssignmentId] = @AssignmentId
	  AND  [IsActive] = 1
	  AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleDriverAssignment_ReadByRouteId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleDriverAssignment_ReadByRouteId]
(
   @RouteId INT
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   [AssignmentId]
      ,[VehicleId]
      ,[DriverId]
      ,[RouteId]
      ,[StartDate]
      ,[EndDate]
      ,[IsPrimaryDriver]
      ,[Shift]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[VehicleDriverAssignment]
	  WHERE [RouteId] = @RouteId
	  AND  [IsActive] = 1
	  AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleDriverAssignment_ReadByVehicleId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleDriverAssignment_ReadByVehicleId]
(
   @VehicleId INT
)

AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
	   A.[AssignmentId]
      ,A.[VehicleId]
      ,A.[DriverId]
	  ,B.[FirstName]
	  ,B.[MiddleName]
	  ,B.[LastName]
	  ,B.[MobileNo]
      ,A.[RouteId]
	  ,C.[RouteName]
      ,A.[StartDate]
      ,A.[EndDate]
      ,A.[IsPrimaryDriver]
      ,A.[Shift]
      ,A.[OtherDetail1]
      ,A.[OtherDetail2]
      ,A.[OtherDetail3]
      ,A.[OtherDetail4]
      ,A.[OtherDetail5]
      ,A.[OtherDetail6]
      ,A.[IsActive]
      ,A.[IsDeleted]
      ,A.[CreatedBy]
      ,A.[CreatedOn]
      ,A.[ModifiedBy]
      ,A.[ModifiedOn]
	  FROM [spe].[VehicleDriverAssignment]A
    LEFT OUTER JOIN Nishwik.dbo.UserMaster B
	  ON A.[DriverId] = B.[UserId]
	LEFT OUTER JOIN  [spe].[VehicleRouteMaster]C
	ON A.[RouteId] = C.[RouteId]
	  WHERE [VehicleId] = @VehicleId
	  AND  A.[IsActive] = 1
	  AND B.[IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleDriverAssignment_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleDriverAssignment_Update]
(
    @AssignmentId     INT,
    @VehicleId        INT,
    @DriverId         INT,
    @RouteId          INT,
    @StartDate        DATETIME,
    @EndDate          DATETIME,
    @IsPrimaryDriver  INT,
    @Shift            VARCHAR(50),
    @OtherDetail1     VARCHAR(50),
    @OtherDetail2     VARCHAR(50),
    @OtherDetail3     VARCHAR(100),
    @OtherDetail4     VARCHAR(100),
    @OtherDetail5     VARCHAR(500),
    @OtherDetail6     VARCHAR(500),
    @IsActive         INT,
    @ActionUser       VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;



    UPDATE [spe].[VehicleDriverAssignment]
    SET
        [VehicleId]         = @VehicleId,
        [DriverId]          = @DriverId,
        [RouteId]           = @RouteId,
        [StartDate]         = @StartDate,
        [EndDate]           = @EndDate,
        [IsPrimaryDriver]   = @IsPrimaryDriver,
        [Shift]             = TRIM(@Shift),
        [OtherDetail1]      = TRIM(@OtherDetail1),
        [OtherDetail2]      = TRIM(@OtherDetail2),
        [OtherDetail3]      = TRIM(@OtherDetail3),
        [OtherDetail4]      = TRIM(@OtherDetail4),
        [OtherDetail5]      = TRIM(@OtherDetail5),
        [OtherDetail6]      = TRIM(@OtherDetail6),
        [IsActive]          = @IsActive,
        [ModifiedBy]        = TRIM(@ActionUser),
        [ModifiedOn]        = GETDATE()
    WHERE 
        [AssignmentId] = @AssignmentId;

    SELECT 
        [AssignmentId],
        [VehicleId],
        [DriverId],
        [RouteId],
        [StartDate],
        [EndDate],
        [IsPrimaryDriver],
        [Shift],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[VehicleDriverAssignment]
    WHERE [AssignmentId] = @AssignmentId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



/*
EXEC [spe].[VehicleMaster_Create]
    @SchoolId = 1,
    @VehicleNo = 'MH12AB1234',
    @ImgPath = '/images/vehicles/bus1.jpg',
    @Capacity = 50,
    @Type = 'Bus',
    @OwnershipType = 'Owned',
    @ChassisNo = 'CH12345678',
    @InsuranceExpiryDate = '2026-12-31',
    @PermitNo = 'PERM1234',
    @PermitExpiryDate = '2026-06-30',
    @Status = 'Active',
    @OtherDetail1 = 'Air Conditioned',
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[VehicleMaster_Create]
(
    @SchoolId              INT = NULL,
    @VehicleNo             VARCHAR(20) = NULL,
    @ImgPath               VARCHAR(255) = NULL,
    @Capacity              INT = NULL,
    @Type                  VARCHAR(20) = NULL,
    @OwnershipType         VARCHAR(20) = NULL,
    @ChassisNo             VARCHAR(50) = NULL,
    @InsuranceExpiryDate   DATETIME = NULL,
    @PermitNo              VARCHAR(50) = NULL,
    @PermitExpiryDate      DATETIME = NULL,
    @Status                VARCHAR(10) = NULL,
    @OtherDetail1          VARCHAR(50) = NULL,
    @OtherDetail2          VARCHAR(50) = NULL,
    @OtherDetail3          VARCHAR(100) = NULL,
    @OtherDetail4          VARCHAR(100) = NULL,
    @OtherDetail5          VARCHAR(500) = NULL,
    @OtherDetail6          VARCHAR(500) = NULL,
    @ActionUser            VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	  --  Prevent duplicate Vehicle entries based on VehicleNo / ChassisNo / PermitNo
    IF EXISTS (
        SELECT 1 
        FROM [spe].[VehicleMaster]
        WHERE IsDeleted = 0
          AND (
                (VehicleNo IS NOT NULL AND VehicleNo = @VehicleNo)
             OR (ChassisNo IS NOT NULL AND ChassisNo = @ChassisNo)
             OR (PermitNo IS NOT NULL AND PermitNo = @PermitNo)
              )
    )
    BEGIN
        RAISERROR('Duplicate entry detected! Vehicle No, Chassis No, or Permit No already exists.', 16, 1);
        RETURN;
    END;


    DECLARE @VehicleId INT;

    INSERT INTO [spe].[VehicleMaster]
    (
        [SchoolId],
        [VehicleNo],
        [ImgPath],
        [Capacity],
        [Type],
        [OwnershipType],
        [ChassisNo],
        [InsuranceExpiryDate],
        [PermitNo],
        [PermitExpiryDate],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @SchoolId,
        @VehicleNo,
        @ImgPath,
        @Capacity,
        @Type,
        @OwnershipType,
        @ChassisNo,
        @InsuranceExpiryDate,
        @PermitNo,
        @PermitExpiryDate,
        @Status,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,              
        0,              
        @ActionUser,
        GETDATE()
    );

    SET @VehicleId = SCOPE_IDENTITY();

    SELECT
         [VehicleId]
        ,[SchoolId]
        ,[VehicleNo]
        ,[ImgPath]
        ,[Capacity]
        ,[Type]
        ,[OwnershipType]
        ,[ChassisNo]
        ,[InsuranceExpiryDate]
        ,[PermitNo]
        ,[PermitExpiryDate]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleMaster]
    WHERE [VehicleId] = @VehicleId;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_CreateBulk]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleMaster_CreateBulk]
(
    @VehicleIdList [spe].[udt_VehicleMaster] READONLY,
    @ActionUser VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO [spe].[VehicleMaster]
    (
       [SchoolId]
      ,[VehicleNo]
      ,[ImgPath]
      ,[Capacity]
      ,[Type]
      ,[OwnershipType]
      ,[ChassisNo]
      ,[InsuranceExpiryDate]
      ,[PermitNo]
      ,[PermitExpiryDate]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
    )
    SELECT
       [SchoolId]
      ,[VehicleNo]
      ,[ImgPath]
      ,[Capacity]
      ,[Type]
      ,[OwnershipType]
      ,[ChassisNo]
      ,[InsuranceExpiryDate]
      ,[PermitNo]
      ,[PermitExpiryDate]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,1
      ,0               -- default IsDeleted
      ,@ActionUser,    -- CreatedBy
       GETDATE()        -- CreatedOn
    FROM @VehicleIdList;

    -- Return inserted rows
    SELECT 
       [VehicleId]
      ,[SchoolId]
      ,[VehicleNo]
      ,[ImgPath]
      ,[Capacity]
      ,[Type]
      ,[OwnershipType]
      ,[ChassisNo]
      ,[InsuranceExpiryDate]
      ,[PermitNo]
      ,[PermitExpiryDate]
      ,[Status]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
    FROM [Nishwik].[spe].[VehicleMaster]
    WHERE IsActive = 1
      AND IsDeleted = 0
      AND CreatedBy = @ActionUser
      AND CreatedOn >= DATEADD(MINUTE, -5, GETDATE());
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleMaster_Delete]
(
  @VehicleId INT,
  @ActionUser VARCHAR(50)
)
AS
 BEGIN
		SET NOCOUNT ON;
		UPDATE  [spe].[VehicleMaster]
		SET
			[IsActive] = 0,
			[IsDeleted] =1,
			[ModifiedBy] = @ActionUser,
			[ModifiedOn]= GETDATE()
		WHERE [VehicleId] = @VehicleId
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleMaster_ReadAll]
AS
BEGIN
    SELECT
         [VehicleId]
        ,[SchoolId]
        ,[VehicleNo]
        ,[ImgPath]
        ,[Capacity]
        ,[Type]
        ,[OwnershipType]
        ,[ChassisNo]
        ,[InsuranceExpiryDate]
        ,[PermitNo]
        ,[PermitExpiryDate]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleMaster]
    WHERE [IsActive] = 1
	AND   [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_ReadAllPaginated]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
[spe].[VehicleMaster_ReadAllPaginated]5,10,1,'',''
*/
CREATE   PROCEDURE [spe].[VehicleMaster_ReadAllPaginated]
(
    @SchoolId INT,
    @PageSize INT,
    @PageNo INT,
    @OrderByClause NVARCHAR(MAX) = NULL,
    @WhereClause NVARCHAR(MAX) = NULL
)
AS
BEGIN 
    SET NOCOUNT ON; 

    DECLARE @Result INT = 0, @TotalCount INT = 0;
    SET @Result = (@PageNo - 1) * @PageSize;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    SELECT
        ROW_NUMBER() OVER (ORDER BY ' + 
        ISNULL(NULLIF(LTRIM(RTRIM(@OrderByClause)), ''), 'CreatedOn DESC') + 
        ') AS RowNum,
        [VehicleId],
        [SchoolId],
        [VehicleNo],
        [ImgPath],
        [Capacity],
        [Type],
        [OwnershipType],
        [ChassisNo],
        [InsuranceExpiryDate],
        [PermitNo],
        [PermitExpiryDate],
        [Status],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn],
        COUNT(*) OVER () AS TotalCount,
        ' + CAST(@PageSize AS NVARCHAR) + ' AS PageSize,
        ' + CAST(@PageNo AS NVARCHAR) + ' AS PageNo
    FROM [Nishwik].[spe].[VehicleMaster]
    WHERE [SchoolId] = ' + CAST(@SchoolId AS NVARCHAR) + ' AND [IsActive] = 1';

    IF @WhereClause IS NOT NULL AND LEN(@WhereClause) > 0
        SET @SQL = @SQL + ' AND ' + @WhereClause;

    IF @OrderByClause IS NOT NULL AND LTRIM(RTRIM(@OrderByClause)) <> ''
        SET @SQL = @SQL + ' ORDER BY ' + @OrderByClause;
    ELSE
        SET @SQL = @SQL + ' ORDER BY CreatedOn DESC';

    SET @SQL = @SQL + '
    OFFSET ' + CAST(@Result AS NVARCHAR) + ' ROWS
    FETCH NEXT ' + CAST(@PageSize AS NVARCHAR) + ' ROWS ONLY;';

    PRINT @SQL;

    EXEC sp_executesql @SQL;
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleMaster_ReadById]
(
   @VehicleId INT
)
AS
BEGIN
    SELECT
         [VehicleId]
        ,[SchoolId]
        ,[VehicleNo]
        ,[ImgPath]
        ,[Capacity]
        ,[Type]
        ,[OwnershipType]
        ,[ChassisNo]
        ,[InsuranceExpiryDate]
        ,[PermitNo]
        ,[PermitExpiryDate]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleMaster]
    WHERE [VehicleId] = @VehicleId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleMaster_ReadBySchoolId]
(
   @SchoolId INT
)
AS
BEGIN
    SELECT
         [VehicleId]
        ,[SchoolId]
        ,[VehicleNo]
        ,[ImgPath]
        ,[Capacity]
        ,[Type]
        ,[OwnershipType]
        ,[ChassisNo]
        ,[InsuranceExpiryDate]
        ,[PermitNo]
        ,[PermitExpiryDate]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleMaster]
    WHERE [SchoolId] = @SchoolId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_ReadByVehicleNo]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleMaster_ReadByVehicleNo]
(
   @VehicleNo INT
)
AS
BEGIN
    SELECT
         [VehicleId]
        ,[SchoolId]
        ,[VehicleNo]
        ,[ImgPath]
        ,[Capacity]
        ,[Type]
        ,[OwnershipType]
        ,[ChassisNo]
        ,[InsuranceExpiryDate]
        ,[PermitNo]
        ,[PermitExpiryDate]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleMaster]
    WHERE [VehicleNo] = @VehicleNo
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[VehicleMaster_Update]
    @VehicleId = 1,
    @SchoolId = 1,
    @VehicleNo = 'MH12AB5678',
    @ImgPath = '/images/vehicles/bus2.jpg',
    @Capacity = 55,
    @Type = 'Mini Bus',
    @OwnershipType = 'Rented',
    @ChassisNo = 'CH98765432',
    @InsuranceExpiryDate = '2026-11-30',
    @PermitNo = 'PERM5678',
    @PermitExpiryDate = '2026-05-31',
    @Status = 'Inactive',
    @OtherDetail1 = 'AC & GPS',
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[VehicleMaster_Update]
(
    @VehicleId             INT,
    @SchoolId              INT = NULL,
    @VehicleNo             VARCHAR(20) = NULL,
    @ImgPath               VARCHAR(255) = NULL,
    @Capacity              INT = NULL,
    @Type                  VARCHAR(20) = NULL,
    @OwnershipType         VARCHAR(20) = NULL,
    @ChassisNo             VARCHAR(50) = NULL,
    @InsuranceExpiryDate   DATETIME = NULL,
    @PermitNo              VARCHAR(50) = NULL,
    @PermitExpiryDate      DATETIME = NULL,
    @Status                VARCHAR(10) = NULL,
    @OtherDetail1          VARCHAR(50) = NULL,
    @OtherDetail2          VARCHAR(50) = NULL,
    @OtherDetail3          VARCHAR(100) = NULL,
    @OtherDetail4          VARCHAR(100) = NULL,
    @OtherDetail5          VARCHAR(500) = NULL,
    @OtherDetail6          VARCHAR(500) = NULL,
    @IsActive              INT,
    @ActionUser            VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    --IF NOT EXISTS (
    --    SELECT 1 FROM [spe].[VehicleMaster]
    --    WHERE [VehicleId] = @VehicleId AND [IsDeleted] = 0
    --)
    --BEGIN
    --    RAISERROR('VehicleId not found or is deleted.', 16, 1);
    --    RETURN;
    --END

    UPDATE [spe].[VehicleMaster]
    SET
        [SchoolId] = @SchoolId,
        [VehicleNo] = @VehicleNo,
        [ImgPath] = @ImgPath,
        [Capacity] = @Capacity,
        [Type] = @Type,
        [OwnershipType] = @OwnershipType,
        [ChassisNo] = @ChassisNo,
        [InsuranceExpiryDate] = @InsuranceExpiryDate,
        [PermitNo] = @PermitNo,
        [PermitExpiryDate] = @PermitExpiryDate,
        [Status] = @Status,
        [OtherDetail1] = @OtherDetail1,
        [OtherDetail2] = @OtherDetail2,
        [OtherDetail3] = @OtherDetail3,
        [OtherDetail4] = @OtherDetail4,
        [OtherDetail5] = @OtherDetail5,
        [OtherDetail6] = @OtherDetail6,
        [IsActive] = @IsActive,
        [ModifiedBy] = @ActionUser,
        [ModifiedOn] = GETDATE()
    WHERE [VehicleId] = @VehicleId;

    SELECT
         [VehicleId]
        ,[SchoolId]
        ,[VehicleNo]
        ,[ImgPath]
        ,[Capacity]
        ,[Type]
        ,[OwnershipType]
        ,[ChassisNo]
        ,[InsuranceExpiryDate]
        ,[PermitNo]
        ,[PermitExpiryDate]
        ,[Status]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleMaster]
    WHERE [VehicleId] = @VehicleId;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleMaster_VehicleAssignmentProgress]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [spe].[VehicleMaster_VehicleAssignmentProgress] 
(
    @SchoolId INT
)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        A.VehicleNo AS [BusNo],
        RM. [RouteName],

        ISNULL(B.DriverName, 'Not Assigned') AS [DriverName],

        ISNULL(C.StudentCount, 0) AS [NoOfStudents]

    FROM [spe].[VehicleMaster] AS A

    -- ROUTE MAPPING
    LEFT JOIN [spe].[VehicleRouteMapping] VRM 
        ON A.VehicleId = VRM.VehicleId
        AND VRM.IsActive = 1 AND VRM.IsDeleted = 0

    -- ROUTE NAME
    LEFT JOIN [spe].[VehicleRouteMaster] RM
        ON VRM.RouteId = RM.RouteId

    -- DRIVER
    LEFT JOIN (
        SELECT 
            VDA.VehicleId,
            U.FirstName + ' ' + ISNULL(U.MiddleName,'') + ' ' + ISNULL(U.LastName,'') AS DriverName
        FROM [spe].[VehicleDriverAssignment] VDA
        INNER JOIN [dbo].[UserMaster] U
            ON VDA.DriverId = U.UserId
        WHERE VDA.IsActive = 1 AND VDA.IsDeleted = 0
    ) B ON A.VehicleId = B.VehicleId

    -- STUDENTS COUNT
    LEFT JOIN (
        SELECT 
            SRM.RouteId,
            COUNT(*) AS StudentCount
        FROM [spe].[StudentRouteMapping] SRM
        WHERE SRM.IsActive = 1 AND SRM.IsDeleted = 0
        GROUP BY SRM.RouteId
    ) C ON VRM.RouteId = C.RouteId

    WHERE 
        A.SchoolId = @SchoolId
        AND A.IsActive = 1
        AND A.IsDeleted = 0

    ORDER BY A.VehicleNo;
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteDetail_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleRouteDetail_Create]
(
    @RouteId        INT,
    @StopName       VARCHAR(100),
    @Latitude       DECIMAL(18, 6),
    @Longitude      DECIMAL(18, 6),
    @SequenceNo     INT,
	@Remarks       VARCHAR(500),
    @OtherDetail1   VARCHAR(50) ,
    @OtherDetail2   VARCHAR(50) ,
    @OtherDetail3   VARCHAR(100),
    @OtherDetail4   VARCHAR(100),
    @OtherDetail5   VARCHAR(500),
    @OtherDetail6   VARCHAR(500),
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DetailId INT;

    INSERT INTO [spe].VehicleRouteDetail
    (
        [RouteId],
        [StopName],
        [Latitude],
        [Longitude],
        [SequenceNo],
		[Remarks],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @RouteId,
        @StopName,
        @Latitude,
        @Longitude,
        @SequenceNo,
		@Remarks,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1,                 
        0,                 
        @ActionUser,
        GETDATE()
    );

    SET @DetailId = SCOPE_IDENTITY();

    SELECT
        [DetailId],
        [RouteId],
        [StopName],
        [Latitude],
        [Longitude],
        [SequenceNo],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn],
        [ModifiedBy],
        [ModifiedOn]
    FROM [spe].[VehicleRouteDetail]
    WHERE [DetailId] = @DetailId;
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteDetail_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleRouteDetail_Delete]
(
  @DetailId INT,
  @ActionUser VARCHAR(50)
)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [spe].VehicleRouteDetail
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [DetailId] = @DetailId
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteDetail_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteDetail_ReadAll]
AS
BEGIN
     SET NOCOUNT ON;
	 SELECT 
	   [DetailId]
      ,[RouteId]
      ,[StopName]
      ,[Latitude]
      ,[Longitude]
      ,[SequenceNo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].VehicleRouteDetail
	  WHERE [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteDetail_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleRouteDetail_ReadById]
(
   @DetailId INT
)
AS
BEGIN
     SET NOCOUNT ON;
	 SELECT 
	   [DetailId]
      ,[RouteId]
      ,[StopName]
      ,[Latitude]
      ,[Longitude]
      ,[SequenceNo]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].VehicleRouteDetail
	  WHERE [DetailId] = @DetailId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteDetail_ReadByRouteId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleRouteDetail_ReadByRouteId]
(
   @RouteId INT
)
AS
BEGIN
     SET NOCOUNT ON;
	 SELECT 
       [DetailId]
      ,[RouteId]
      ,[StopName]
      ,[Latitude]
      ,[Longitude]
      ,[SequenceNo]
      ,[Remarks]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].VehicleRouteDetail
	  WHERE [RouteId] = @RouteId
	  AND [IsActive] = 1
	  AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteDetail_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[VehicleRouteDetail_Update]
    @DetailId = 1,
    @RouteId = 5,
    @StopName = 'Sector 10 Bus Stop',
    @Latitude = 18.567890,
    @Longitude = 73.912345,
    @SequenceNo = 3,
    @Remarks = 'Stop adjusted due to traffic',
    @OtherDetail1 = 'Morning',
    @OtherDetail2 = 'Urban',
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[VehicleRouteDetail_Update]
(
    @DetailId        INT,
    @RouteId         INT = NULL,
    @StopName        VARCHAR(100) = NULL,
    @Latitude        DECIMAL(18, 6) = NULL,
    @Longitude       DECIMAL(18, 6) = NULL,
    @SequenceNo      INT = NULL,
    @Remarks         VARCHAR(500) = NULL,
    @OtherDetail1    VARCHAR(50) = NULL,
    @OtherDetail2    VARCHAR(50) = NULL,
    @OtherDetail3    VARCHAR(100) = NULL,
    @OtherDetail4    VARCHAR(100) = NULL,
    @OtherDetail5    VARCHAR(500) = NULL,
    @OtherDetail6    VARCHAR(500) = NULL,
    @IsActive        INT,
    @ActionUser      VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
    ---- Check existence
    --IF NOT EXISTS (
    --    SELECT 1
    --    FROM [spe].[VehicleRouteDetail]
    --    WHERE [DetailId] = @DetailId AND [IsDeleted] = 0
    --)
    --BEGIN
    --    RAISERROR('DetailId not found or record is deleted.', 16, 1);
    --    RETURN;
    --END
    UPDATE [spe].[VehicleRouteDetail]
    SET
        [RouteId]       = @RouteId,
        [StopName]      = @StopName,
        [Latitude]      = @Latitude,
        [Longitude]     = @Longitude,
        [SequenceNo]    = @SequenceNo,
        [Remarks]       = @Remarks,
        [OtherDetail1]  = @OtherDetail1,
        [OtherDetail2]  = @OtherDetail2,
        [OtherDetail3]  = @OtherDetail3,
        [OtherDetail4]  = @OtherDetail4,
        [OtherDetail5]  = @OtherDetail5,
        [OtherDetail6]  = @OtherDetail6,
        [IsActive]      = @IsActive,
        [ModifiedBy]    = @ActionUser,
        [ModifiedOn]    = GETDATE()
    WHERE [DetailId] = @DetailId;

    SELECT
         [DetailId]
        ,[RouteId]
        ,[StopName]
        ,[Latitude]
        ,[Longitude]
        ,[SequenceNo]
        ,[Remarks]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleRouteDetail]
    WHERE [DetailId] = @DetailId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMapping_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
EXEC [spe].[VehicleRouteMapping_Create]
    @VehicleId = 1,
    @RouteId = 2,
    @Remarks = 'Assigned for morning route',
    @OtherDetail1 = 'GPS Enabled',
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[VehicleRouteMapping_Create]
(
    @VehicleId      INT,
    @RouteId        INT,
    @Remarks        VARCHAR(500) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

	  IF EXISTS (
        SELECT 1
        FROM [spe].[VehicleRouteMapping]
        WHERE VehicleId = @VehicleId
          AND IsActive  = 1
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('This vehicle is already assigned to an active route. A vehicle can have only one active route at a time.', 16, 1);
        RETURN;
    END


	    IF EXISTS (
        SELECT 1
        FROM [spe].[VehicleRouteMapping]
        WHERE VehicleId = @VehicleId
          AND RouteId   = @RouteId
          AND IsActive  = 1
          AND IsDeleted = 0
    )
    BEGIN
        RAISERROR('This vehicle is already mapped to the same route.', 16, 1);
        RETURN;
    END

    DECLARE @MappingId INT;

    INSERT INTO [spe].[VehicleRouteMapping]
    (
         [VehicleId]
        ,[RouteId]
        ,[Remarks]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
    )
    VALUES
    (
         @VehicleId
        ,@RouteId
        ,@Remarks
        ,@OtherDetail1
        ,@OtherDetail2
        ,@OtherDetail3
        ,@OtherDetail4
        ,@OtherDetail5
        ,@OtherDetail6
        ,1             
        ,0             
        ,@ActionUser
        ,GETDATE()
    );

    SET @MappingId = SCOPE_IDENTITY();

    SELECT
         [MappingId]
        ,[VehicleId]
        ,[RouteId]
        ,[Remarks]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleRouteMapping]
    WHERE [MappingId] = @MappingId;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMapping_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteMapping_Delete]
(
   @MappingId INT,
   @ActionUser VARCHAR(50)
)
AS
 BEGIN
	SET NOCOUNT ON;
	UPDATE [spe].[VehicleRouteMapping]
	SET   
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn]= GETDATE()
	WHERE [MappingId] = @MappingId
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMapping_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteMapping_ReadAll]
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		   [MappingId]
		  ,[VehicleId]
		  ,[RouteId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		  FROM [spe].[VehicleRouteMapping]
		  WHERE[IsActive] = 1
		  AND [IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMapping_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteMapping_ReadById]
(
   @MappingId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		   [MappingId]
		  ,[VehicleId]
		  ,[RouteId]
		  ,[Remarks]
		  ,[OtherDetail1]
		  ,[OtherDetail2]
		  ,[OtherDetail3]
		  ,[OtherDetail4]
		  ,[OtherDetail5]
		  ,[OtherDetail6]
		  ,[IsActive]
		  ,[IsDeleted]
		  ,[CreatedBy]
		  ,[CreatedOn]
		  ,[ModifiedBy]
		  ,[ModifiedOn]
		  FROM [spe].[VehicleRouteMapping]
		  WHERE [MappingId] = @MappingId
		  AND[IsActive] = 1
		  AND [IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMapping_ReadByRouteId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteMapping_ReadByRouteId]
(
   @RouteId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		   A.[MappingId]
		  ,A.[VehicleId]
		  ,C.[VehicleNo]
		  ,C.[ChassisNo]
		  ,A.[RouteId]
		  ,B.[RouteName]
		  ,A.[Remarks]
		  ,A.[OtherDetail1]
		  ,A.[OtherDetail2]
		  ,A.[OtherDetail3]
		  ,A.[OtherDetail4]
		  ,A.[OtherDetail5]
		  ,A.[OtherDetail6]
		  ,A.[IsActive]
		  ,A.[IsDeleted]
		  ,A.[CreatedBy]
		  ,A.[CreatedOn]
		  ,A.[ModifiedBy]
		  ,A.[ModifiedOn]
		  FROM [spe].[VehicleRouteMapping]A
		  LEFT OUTER JOIN  [spe].[VehicleRouteMaster]B
		  ON A.[RouteId] = B.[RouteId]
		  LEFT OUTER JOIN [spe].[VehicleMaster]C
		  ON A.[VehicleId] = C.[VehicleId]
		  WHERE A .[RouteId] = @RouteId
		  AND A.[IsActive] = 1
		  AND A. [IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMapping_ReadByVehicleId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [spe].[VehicleRouteMapping_ReadByVehicleId]
(
   @VehicleId INT
)
AS
 BEGIN
      SET NOCOUNT ON;
	  SELECT 
		   A.[MappingId]
		  ,A.[VehicleId]
		  ,C.[VehicleNo]
		  ,A.[RouteId]
		  ,B.[RouteName]
		  ,A.[Remarks]
		  ,A.[OtherDetail1]
		  ,A.[OtherDetail2]
		  ,A.[OtherDetail3]
		  ,A.[OtherDetail4]
		  ,A.[OtherDetail5]
		  ,A.[OtherDetail6]
		  ,A.[IsActive]
		  ,A.[IsDeleted]
		  ,A.[CreatedBy]
		  ,A.[CreatedOn]
		  ,A.[ModifiedBy]
		  ,A.[ModifiedOn]
		  FROM [spe].[VehicleRouteMapping]A
		  LEFT OUTER JOIN  [spe].[VehicleRouteMaster]B
		  ON A.[RouteId] = B.[RouteId]
		  LEFT OUTER JOIN [spe].[VehicleMaster]C
		  ON A.[VehicleId] = C.[VehicleId]
		  WHERE A .[VehicleId] = @VehicleId
		  AND A.[IsActive] = 1
		  AND A. [IsDeleted]= 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMapping_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[VehicleRouteMapping_Update]
    @MappingId = 1,
    @VehicleId = 1,
    @RouteId = 2,
    @Remarks = 'Updated remarks',
    @OtherDetail1 = 'Updated GPS Enabled',
    @OtherDetail2 = NULL,
    @OtherDetail3 = NULL,
    @OtherDetail4 = NULL,
    @OtherDetail5 = NULL,
    @OtherDetail6 = NULL,
    @IsActive = 1,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[VehicleRouteMapping_Update]
(
    @MappingId      INT,
    @VehicleId      INT,
    @RouteId        INT,
    @Remarks        VARCHAR(500) = NULL,
    @OtherDetail1   VARCHAR(50) = NULL,
    @OtherDetail2   VARCHAR(50) = NULL,
    @OtherDetail3   VARCHAR(100) = NULL,
    @OtherDetail4   VARCHAR(100) = NULL,
    @OtherDetail5   VARCHAR(500) = NULL,
    @OtherDetail6   VARCHAR(500) = NULL,
    @IsActive       INT,
    @ActionUser     VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;
	  IF EXISTS
    (
        SELECT 1 
        FROM [spe].[VehicleRouteMapping]
        WHERE VehicleId = @VehicleId
          AND MappingId <> @MappingId   -- some other record
          AND IsActive = 1
          AND IsDeleted = 0
    )
    BEGIN
        SELECT  
              0 AS Success
            , 'This vehicle is already assigned to another route.' AS Message;
        RETURN;
    END

    UPDATE [spe].[VehicleRouteMapping]
    SET
         [VehicleId]     = @VehicleId
        ,[RouteId]       = @RouteId
        ,[Remarks]       = @Remarks
        ,[OtherDetail1]  = @OtherDetail1
        ,[OtherDetail2]  = @OtherDetail2
        ,[OtherDetail3]  = @OtherDetail3
        ,[OtherDetail4]  = @OtherDetail4
        ,[OtherDetail5]  = @OtherDetail5
        ,[OtherDetail6]  = @OtherDetail6
        ,[IsActive]      = @IsActive
        ,[ModifiedBy]    = @ActionUser
        ,[ModifiedOn]    = GETDATE()
    WHERE [MappingId] = @MappingId;

    SELECT
		 [MappingId]
		,[VehicleId]
		,[RouteId]
		,[Remarks]
		,[OtherDetail1]
		,[OtherDetail2]
		,[OtherDetail3]
		,[OtherDetail4]
		,[OtherDetail5]
		,[OtherDetail6]
		,[IsActive]
		,[IsDeleted]
		,[CreatedBy]
		,[CreatedOn]
		,[ModifiedBy]
		,[ModifiedOn]
	FROM [spe].[VehicleRouteMapping]
	WHERE [MappingId] = @MappingId
	AND [IsActive] = 1
	AND [IsDeleted] = 0;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMaster_Create]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[VehicleRouteMaster_Create]
    @RouteName = 'Route A',
    @SchoolId = 1,
    @VehicleId = 5,
    @StartLocation = 'Main Gate',
    @EndLocation = 'Sector 10',
    @Distance = 12.5,
    @EstimatedTime = '2025-08-05 08:30:00',
    @Status = 'Active',
    @OtherDetail1 = 'Morning Route',
    @OtherDetail2 = '',
    @OtherDetail3 = '',
    @OtherDetail4 = '',
    @OtherDetail5 = '',
    @OtherDetail6 = '',
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[VehicleRouteMaster_Create]
(
    @RouteName         VARCHAR(50),
    @SchoolId          INT,
    @StartLocation     VARCHAR(250),
    @EndLocation       VARCHAR(50),
    @Distance          DECIMAL(18,2),
    @EstimatedTime     DECIMAL(5,2),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @RouteId INT;

    INSERT INTO [spe].[VehicleRouteMaster]
    (
        [RouteName],
        [SchoolId],
        [StartLocation],
        [EndLocation],
        [Distance],
        [EstimatedTime],
        [OtherDetail1],
        [OtherDetail2],
        [OtherDetail3],
        [OtherDetail4],
        [OtherDetail5],
        [OtherDetail6],
        [IsActive],
        [IsDeleted],
        [CreatedBy],
        [CreatedOn]
    )
    VALUES
    (
        @RouteName,
        @SchoolId,
        @StartLocation,
        @EndLocation,
        @Distance,
        @EstimatedTime,
        @OtherDetail1,
        @OtherDetail2,
        @OtherDetail3,
        @OtherDetail4,
        @OtherDetail5,
        @OtherDetail6,
        1, 
        0, 
        @ActionUser,
        GETDATE()
    );

    SET @RouteId = SCOPE_IDENTITY();
    SELECT
         [RouteId]
        ,[RouteName]
        ,[SchoolId]
        ,[StartLocation]
        ,[EndLocation]
        ,[Distance]
        ,[EstimatedTime]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleRouteMaster]
    WHERE [RouteId] = @RouteId;
END
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMaster_Delete]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteMaster_Delete]
(
   @RouteId INT,
   @ActionUser VARCHAR(50)
)
AS
BEGIN
	UPDATE[spe].[VehicleRouteMaster]
	SET
		[IsActive] = 0,
		[IsDeleted] = 1,
		[ModifiedBy] = @ActionUser,
		[ModifiedOn] = GETDATE()
	WHERE [RouteId] = @RouteId
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMaster_ReadAll]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteMaster_ReadAll]
AS
BEGIN
     SELECT
	   [RouteId]
      ,[RouteName]
      ,[SchoolId]
      ,[StartLocation]
      ,[EndLocation]
      ,[Distance]
      ,[EstimatedTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[VehicleRouteMaster]
	  WHERE [IsActive] = 1
      AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMaster_ReadById]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteMaster_ReadById]
(
   @RouteId INT
)
AS
BEGIN
     SELECT
	   [RouteId]
      ,[RouteName]
      ,[SchoolId]
      ,[StartLocation]
      ,[EndLocation]
      ,[Distance]
      ,[EstimatedTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[VehicleRouteMaster]
	  WHERE [RouteId] = @RouteId
	  AND [IsActive] = 1
      AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMaster_ReadBySchoolId]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [spe].[VehicleRouteMaster_ReadBySchoolId]
(
   @SchoolId INT
)
AS
BEGIN
     SELECT
	   [RouteId]
      ,[RouteName]
      ,[SchoolId]
      ,[StartLocation]
      ,[EndLocation]
      ,[Distance]
      ,[EstimatedTime]
      ,[OtherDetail1]
      ,[OtherDetail2]
      ,[OtherDetail3]
      ,[OtherDetail4]
      ,[OtherDetail5]
      ,[OtherDetail6]
      ,[IsActive]
      ,[IsDeleted]
      ,[CreatedBy]
      ,[CreatedOn]
      ,[ModifiedBy]
      ,[ModifiedOn]
	  FROM [spe].[VehicleRouteMaster]
	  WHERE [SchoolId] = @SchoolId
	  AND [IsActive] = 1
      AND [IsDeleted] = 0
END;
GO
/****** Object:  StoredProcedure [spe].[VehicleRouteMaster_Update]    Script Date: 11/24/2025 5:47:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
EXEC [spe].[RouteMaster_Update]
    @RouteId = 1,
    @RouteName = 'Route A Updated',
    @SchoolId = 2,
    @VehicleId = 6,
    @StartLocation = 'Main Gate Updated',
    @EndLocation = 'Sector 15',
    @Distance = 15.75,
    @EstimatedTime = '2025-08-05 09:00:00',
    @Status = 'Active',
    @OtherDetail1 = 'Updated Morning Route',
    @OtherDetail2 = '',
    @OtherDetail3 = '',
    @OtherDetail4 = '',
    @OtherDetail5 = '',
    @OtherDetail6 = '',
    @IsActive = 1,
    @IsDeleted = 0,
    @ActionUser = 'admin';
*/

CREATE   PROCEDURE [spe].[VehicleRouteMaster_Update]
(
    @RouteId           INT,
    @RouteName         VARCHAR(50),
    @SchoolId          INT,
    @StartLocation     VARCHAR(250),
    @EndLocation       VARCHAR(50),
    @Distance          DECIMAL(18,2),
    @EstimatedTime     DECIMAL(5,2),
    @OtherDetail1      VARCHAR(50),
    @OtherDetail2      VARCHAR(50),
    @OtherDetail3      VARCHAR(100),
    @OtherDetail4      VARCHAR(100),
    @OtherDetail5      VARCHAR(500),
    @OtherDetail6      VARCHAR(500),
    @IsActive          INT,
    @ActionUser        VARCHAR(50)
)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE [spe].[VehicleRouteMaster]
    SET
         [RouteName]      = @RouteName
        ,[SchoolId]       = @SchoolId
        ,[StartLocation]  = @StartLocation
        ,[EndLocation]    = @EndLocation
        ,[Distance]       = @Distance
        ,[EstimatedTime]  = @EstimatedTime
        ,[OtherDetail1]   = @OtherDetail1
        ,[OtherDetail2]   = @OtherDetail2
        ,[OtherDetail3]   = @OtherDetail3
        ,[OtherDetail4]   = @OtherDetail4
        ,[OtherDetail5]   = @OtherDetail5
        ,[OtherDetail6]   = @OtherDetail6
        ,[IsActive]       = @IsActive
        ,[ModifiedBy]     = @ActionUser
        ,[ModifiedOn]     = GETDATE()
    WHERE
        [RouteId] = @RouteId;
    SELECT
         [RouteId]
        ,[RouteName]
        ,[SchoolId]
        ,[StartLocation]
        ,[EndLocation]
        ,[Distance]
        ,[EstimatedTime]
        ,[OtherDetail1]
        ,[OtherDetail2]
        ,[OtherDetail3]
        ,[OtherDetail4]
        ,[OtherDetail5]
        ,[OtherDetail6]
        ,[IsActive]
        ,[IsDeleted]
        ,[CreatedBy]
        ,[CreatedOn]
        ,[ModifiedBy]
        ,[ModifiedOn]
    FROM [spe].[VehicleRouteMaster]
    WHERE [RouteId] = @RouteId
	AND [IsActive] = 1
	AND  [IsDeleted]= 0;
END
GO

